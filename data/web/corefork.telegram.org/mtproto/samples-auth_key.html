<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 4C 39 0E 00 3C CA BA 68
0010 | 14 00 00 00 F1 8E 7E BE 33 A8 8F 22 DC F4 CD A2
0020 | DA BD AE 51 B0 2F B6 B8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>4C390E003CCABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 20 16 B8 3C CA BA 68
0010 | 50 00 00 00 63 24 16 05 33 A8 8F 22 DC F4 CD A2
0020 | DA BD AE 51 B0 2F B6 B8 72 FE 11 A1 12 5C C1 41
0030 | DA 32 5C 6C 9E 79 31 CE 08 1B CC 4B C6 07 BD A3
0040 | 35 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>012016B83CCABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081BCC4BC607BDA335000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2003059248178504501</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2003059248178504501</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2003059248178504501 = 1170401611 * 1711428991</code></p>
<pre><code>p = 1170401611
q = 1711428991</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1B CC 4B C6 07 BD A3 35 00 00 00
0010 | 04 45 C2 E9 4B 00 00 00 04 66 02 55 7F 00 00 00
0020 | 33 A8 8F 22 DC F4 CD A2 DA BD AE 51 B0 2F B6 B8
0030 | 72 FE 11 A1 12 5C C1 41 DA 32 5C 6C 9E 79 31 CE
0040 | 58 14 EC 56 C4 BA 37 18 72 17 CF E7 08 43 95 47
0050 | 23 A3 ED 71 99 7E 08 95 19 11 A0 F1 9C AF 41 B0
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081BCC4BC607BDA335000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2003059248178504501</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0445C2E94B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1170401611</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046602557F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1711428991</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>5814EC56C4BA37187217CFE708439547</code> <code>23A3ED71997E08951911A0F19CAF41B0</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081BCC4BC607BDA3350000000445C2E94B000000046602557F00000033A88F22DCF4CDA2DABDAE51B02FB6B872FE11A1125CC141DA325C6C9E7931CE5814EC56C4BA37187217CFE70843954723A3ED71997E08951911A0F19CAF41B002000000
random_padding_bytes = 7AA1AA099E6ADDE31460C7C3DE211A38D3007EE52254A973200A7B0127105E9EE703648716A2D77B325AA230E7AB7B293C3AFAF7E8C6C2A5D52E507694DB796C1AFBB003A96145DC4A17E902988AB754311E1FF9BD4E7480A1EA94AF</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 61FCA123DE8A4811A633368070F29356E374F3168D1F7667DD17EA3696402F35817B2E31AD6572E70152084C728636FBF524D9F636CC3348AB8CAFD3E3345F209E941EA890A82F6B9D50A7DDA5702A5C6A5E7A2631BBB9C7A8F8780133F7C2BCA487C3DC0E54F5CABD230F336943C40A414FAC7A7767376B328AC344A278C8CCDC334E32FFB52BB5E65BF2E83CF2792B8CCB4BA64DB5706E282A0626E8D79B17FF8F357DA0F98D44226DBB00D43801D3010818C3CEB12C5C8F992DFF2B7B3641F0DF72FFAAAC072BBEE57EAAAB771A9CF4C8AA70E0361E4A47776F86B40EF9DA0682E95B0EE629F9D6D29966962439669FB3FE33B99BCDEC6FE01C08971942B1</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 50 39 0E 00 3C CA BA 68
0010 | 40 01 00 00 BE E4 12 D7 33 A8 8F 22 DC F4 CD A2
0020 | DA BD AE 51 B0 2F B6 B8 72 FE 11 A1 12 5C C1 41
0030 | DA 32 5C 6C 9E 79 31 CE 04 45 C2 E9 4B 00 00 00
0040 | 04 66 02 55 7F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 61 FC A1 23 DE 8A 48 11 A6 33 36 80
0060 | 70 F2 93 56 E3 74 F3 16 8D 1F 76 67 DD 17 EA 36
0070 | 96 40 2F 35 81 7B 2E 31 AD 65 72 E7 01 52 08 4C
0080 | 72 86 36 FB F5 24 D9 F6 36 CC 33 48 AB 8C AF D3
0090 | E3 34 5F 20 9E 94 1E A8 90 A8 2F 6B 9D 50 A7 DD
00A0 | A5 70 2A 5C 6A 5E 7A 26 31 BB B9 C7 A8 F8 78 01
00B0 | 33 F7 C2 BC A4 87 C3 DC 0E 54 F5 CA BD 23 0F 33
00C0 | 69 43 C4 0A 41 4F AC 7A 77 67 37 6B 32 8A C3 44
00D0 | A2 78 C8 CC DC 33 4E 32 FF B5 2B B5 E6 5B F2 E8
00E0 | 3C F2 79 2B 8C CB 4B A6 4D B5 70 6E 28 2A 06 26
00F0 | E8 D7 9B 17 FF 8F 35 7D A0 F9 8D 44 22 6D BB 00
0100 | D4 38 01 D3 01 08 18 C3 CE B1 2C 5C 8F 99 2D FF
0110 | 2B 7B 36 41 F0 DF 72 FF AA AC 07 2B BE E5 7E AA
0120 | AB 77 1A 9C F4 C8 AA 70 E0 36 1E 4A 47 77 6F 86
0130 | B4 0E F9 DA 06 82 E9 5B 0E E6 29 F9 D6 D2 99 66
0140 | 96 24 39 66 9F B3 FE 33 B9 9B CD EC 6F E0 1C 08
0150 | 97 19 42 B1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>50390E003CCABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0445C2E94B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1170401611</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046602557F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1711428991</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010061FCA123DE8A4811A6333680</code> <code>70F29356E374F3168D1F7667DD17EA36</code> <code>96402F35817B2E31AD6572E70152084C</code> <code>728636FBF524D9F636CC3348AB8CAFD3</code> <code>E3345F209E941EA890A82F6B9D50A7DD</code> <code>A5702A5C6A5E7A2631BBB9C7A8F87801</code> <code>33F7C2BCA487C3DC0E54F5CABD230F33</code> <code>6943C40A414FAC7A7767376B328AC344</code> <code>A278C8CCDC334E32FFB52BB5E65BF2E8</code> <code>3CF2792B8CCB4BA64DB5706E282A0626</code> <code>E8D79B17FF8F357DA0F98D44226DBB00</code> <code>D43801D3010818C3CEB12C5C8F992DFF</code> <code>2B7B3641F0DF72FFAAAC072BBEE57EAA</code> <code>AB771A9CF4C8AA70E0361E4A47776F86</code> <code>B40EF9DA0682E95B0EE629F9D6D29966</code> <code>962439669FB3FE33B99BCDEC6FE01C08</code><br> <code>971942B1</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C 9A E5 3C CA BA 68
0010 | 78 02 00 00 5C 07 E8 D0 33 A8 8F 22 DC F4 CD A2
0020 | DA BD AE 51 B0 2F B6 B8 72 FE 11 A1 12 5C C1 41
0030 | DA 32 5C 6C 9E 79 31 CE FE 50 02 00 81 DB 48 D6
0040 | 66 1B 31 B2 7A 29 39 C6 98 E6 1A 83 9F FC 14 E2
0050 | 63 35 10 0C 78 4E BF 0E 82 2D EC B0 2A D8 D5 4C
0060 | 9B 69 BD 7D 1A C0 5B 23 D9 68 12 DD 83 4A 6E 66
0070 | 2C 6F B4 95 AF 26 E3 A8 E2 96 FC CC CC 86 AF B8
0080 | E1 5D 36 2B 23 2D 51 89 64 C8 D7 12 25 89 41 1C
0090 | A4 C0 B2 2C E5 B0 1C 1D D7 77 77 A1 AC EB 88 DD
00A0 | 68 DF 09 5A 83 4B 31 38 C0 8B 7F 0D C9 B7 C0 34
00B0 | 5D D6 09 1D 00 89 88 A9 BA D6 53 16 5B 98 07 04
00C0 | 1F BE 4B A9 3E 11 42 60 FA 0D 0B F9 A9 6C 27 39
00D0 | 6B EC 42 CD BC 6B 83 B4 CB 99 52 5D A2 A1 0F E8
00E0 | 96 B6 C1 89 5E 02 EF B0 77 26 83 63 D3 F3 A7 C9
00F0 | 5E EC A1 23 69 25 D7 68 C0 42 FF 6C 7E 43 13 8F
0100 | D9 8C 3C 2F E6 B8 4C 07 5D 51 F4 18 81 4D 19 93
0110 | B8 82 FC 99 78 1B E7 DA C6 C8 D9 B4 53 60 80 7E
0120 | AC 74 DC 0A C2 7A 2C B6 47 F2 74 C0 22 5C 69 24
0130 | DE 7F 65 1C D1 C9 9C 8E 62 9D 59 36 9D A3 B5 C9
0140 | 9D A8 39 1C 1A A5 BE D7 11 FA D3 FA 9F 3A 35 B4
0150 | 6D B5 F3 59 9D A3 DD DE 7F D8 A4 E9 FA 2F 59 30
0160 | 27 BB 69 6B EE C3 C3 5B A8 2B 91 CD 51 BC A4 1F
0170 | 90 B2 97 F7 F3 25 4F 46 65 C4 30 31 8A 43 66 77
0180 | 86 F1 7C 3B 26 EF EA 56 B3 A0 EF D7 C9 12 9E FD
0190 | 32 C2 5D BF 1E 36 45 1C 70 F5 37 83 FF 3F B1 82
01A0 | DE C6 48 1E 01 DE 80 72 B1 CE 41 FC 0A BE 37 C5
01B0 | 4A 1E 7F F7 BC 38 84 79 C0 D3 11 AF 68 F0 73 D1
01C0 | 94 1F 86 3C C0 E7 73 FB 40 3E 7A 71 B5 38 A4 DA
01D0 | 0B DC A8 F8 AE FC B2 44 F4 C5 11 AE 29 49 CD 68
01E0 | 0A D4 B1 D8 2F 35 A5 35 31 C4 81 A4 6E 81 D3 F1
01F0 | 24 42 B6 41 63 E4 C9 90 BE CE 3E 37 5E 2D 71 E2
0200 | A4 BD 13 95 85 3F 0D 9D A6 FE 28 E4 52 02 D5 A0
0210 | 85 6C FD 23 C9 02 05 FB 44 A1 3B 81 F5 96 B6 FB
0220 | C1 A4 3A A4 79 DB 4D 7B 4B AB 5B 29 4E 6E AA 7D
0230 | AD 85 2A 54 52 37 FB E5 60 CA 59 2E A7 A4 A9 FC
0240 | 1D 3B 6E 8F 2A BC 61 1C 0B 34 22 8F 0D 23 11 7B
0250 | 46 1B 0A 58 D6 2F 2C 69 AD 49 1B 40 FB 57 73 9D
0260 | E4 DA 7B 36 92 EF 13 84 5D 91 4D 8A 54 90 C2 76
0270 | CF DA 4D 52 7E B6 66 FC BE 7B 4B 5B BC F2 25 40
0280 | D9 12 91 0A 53 F2 65 3D 36 8C 01 D4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019C9AE53CCABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020081DB48D6661B31B27A2939C6</code> <code>98E61A839FFC14E26335100C784EBF0E</code> <code>822DECB02AD8D54C9B69BD7D1AC05B23</code> <code>D96812DD834A6E662C6FB495AF26E3A8</code> <code>E296FCCCCC86AFB8E15D362B232D5189</code> <code>64C8D7122589411CA4C0B22CE5B01C1D</code> <code>D77777A1ACEB88DD68DF095A834B3138</code> <code>C08B7F0DC9B7C0345DD6091D008988A9</code> <code>BAD653165B9807041FBE4BA93E114260</code> <code>FA0D0BF9A96C27396BEC42CDBC6B83B4</code> <code>CB99525DA2A10FE896B6C1895E02EFB0</code> <code>77268363D3F3A7C95EECA1236925D768</code> <code>C042FF6C7E43138FD98C3C2FE6B84C07</code> <code>5D51F418814D1993B882FC99781BE7DA</code> <code>C6C8D9B45360807EAC74DC0AC27A2CB6</code> <code>47F274C0225C6924DE7F651CD1C99C8E</code> <code>629D59369DA3B5C99DA8391C1AA5BED7</code> <code>11FAD3FA9F3A35B46DB5F3599DA3DDDE</code> <code>7FD8A4E9FA2F593027BB696BEEC3C35B</code> <code>A82B91CD51BCA41F90B297F7F3254F46</code> <code>65C430318A43667786F17C3B26EFEA56</code> <code>B3A0EFD7C9129EFD32C25DBF1E36451C</code> <code>70F53783FF3FB182DEC6481E01DE8072</code> <code>B1CE41FC0ABE37C54A1E7FF7BC388479</code> <code>C0D311AF68F073D1941F863CC0E773FB</code> <code>403E7A71B538A4DA0BDCA8F8AEFCB244</code> <code>F4C511AE2949CD680AD4B1D82F35A535</code> <code>31C481A46E81D3F12442B64163E4C990</code> <code>BECE3E375E2D71E2A4BD1395853F0D9D</code> <code>A6FE28E45202D5A0856CFD23C90205FB</code> <code>44A13B81F596B6FBC1A43AA479DB4D7B</code> <code>4BAB5B294E6EAA7DAD852A545237FBE5</code> <code>60CA592EA7A4A9FC1D3B6E8F2ABC611C</code> <code>0B34228F0D23117B461B0A58D62F2C69</code> <code>AD491B40FB57739DE4DA7B3692EF1384</code> <code>5D914D8A5490C276CFDA4D527EB666FC</code> <code>BE7B4B5BBCF22540D912910A53F2653D</code><br> <code>368C01D4</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 81DB48D6661B31B27A2939C698E61A839FFC14E26335100C784EBF0E822DECB02AD8D54C9B69BD7D1AC05B23D96812DD834A6E662C6FB495AF26E3A8E296FCCCCC86AFB8E15D362B232D518964C8D7122589411CA4C0B22CE5B01C1DD77777A1ACEB88DD68DF095A834B3138C08B7F0DC9B7C0345DD6091D008988A9BAD653165B9807041FBE4BA93E114260FA0D0BF9A96C27396BEC42CDBC6B83B4CB99525DA2A10FE896B6C1895E02EFB077268363D3F3A7C95EECA1236925D768C042FF6C7E43138FD98C3C2FE6B84C075D51F418814D1993B882FC99781BE7DAC6C8D9B45360807EAC74DC0AC27A2CB647F274C0225C6924DE7F651CD1C99C8E629D59369DA3B5C99DA8391C1AA5BED711FAD3FA9F3A35B46DB5F3599DA3DDDE7FD8A4E9FA2F593027BB696BEEC3C35BA82B91CD51BCA41F90B297F7F3254F4665C430318A43667786F17C3B26EFEA56B3A0EFD7C9129EFD32C25DBF1E36451C70F53783FF3FB182DEC6481E01DE8072B1CE41FC0ABE37C54A1E7FF7BC388479C0D311AF68F073D1941F863CC0E773FB403E7A71B538A4DA0BDCA8F8AEFCB244F4C511AE2949CD680AD4B1D82F35A53531C481A46E81D3F12442B64163E4C990BECE3E375E2D71E2A4BD1395853F0D9DA6FE28E45202D5A0856CFD23C90205FB44A13B81F596B6FBC1A43AA479DB4D7B4BAB5B294E6EAA7DAD852A545237FBE560CA592EA7A4A9FC1D3B6E8F2ABC611C0B34228F0D23117B461B0A58D62F2C69AD491B40FB57739DE4DA7B3692EF13845D914D8A5490C276CFDA4D527EB666FCBE7B4B5BBCF22540D912910A53F2653D368C01D4
tmp_aes_key = 5F631F55BA2EE63AECD7C48AA5A8E802A2E765F141C10FC9D60C3F5CD0E5EBAF
tmp_aes_iv = BBBABA19B300A3719FB3F60104BF24639654D61C933514741DF017E05814EC56</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 4CFDAFD0203763C30F9562D828066E6D6D8512A2BA0D89B533A88F22DCF4CDA2DABDAE51B02FB6B872FE11A1125CC141DA325C6C9E7931CE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007841D03A72FA2E5F53645D6AC9A602ECB57847929D8BE7EDAC2AF837C28F7002B2FEEA57E679072125C8C8B46A29119602E4FAFE283B5349BBED3C9170ED8E6933ADA53903A3C9B3A0F0CF7E9909C2FB5E0B0F23E3009BC9C491079B65D446D1708C26DCFD41AD564C0A82FD70F90082BC81A0737D469578112A074AACD938EEA54BBCF0F335B1B468167E7FDED2B921E2BD0C4DD956DF6FA4C4BBE282ADE8AD67E22B6208183AC046F071CF5419D61D83D87F0C868CC4E7C249F0E3DBCF440BDFCF25BFFCCFE4903302C8CD828904657EDC4C3F21F7DA510567DDE34E2CF579E1C38DDB57872240EBDF2B0E10685EBE6FC433F7ABD3BFF24F8B04259C64791E3CCABA68ED480D2A054ADB7F
answer = BA0D89B533A88F22DCF4CDA2DABDAE51B02FB6B872FE11A1125CC141DA325C6C9E7931CE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007841D03A72FA2E5F53645D6AC9A602ECB57847929D8BE7EDAC2AF837C28F7002B2FEEA57E679072125C8C8B46A29119602E4FAFE283B5349BBED3C9170ED8E6933ADA53903A3C9B3A0F0CF7E9909C2FB5E0B0F23E3009BC9C491079B65D446D1708C26DCFD41AD564C0A82FD70F90082BC81A0737D469578112A074AACD938EEA54BBCF0F335B1B468167E7FDED2B921E2BD0C4DD956DF6FA4C4BBE282ADE8AD67E22B6208183AC046F071CF5419D61D83D87F0C868CC4E7C249F0E3DBCF440BDFCF25BFFCCFE4903302C8CD828904657EDC4C3F21F7DA510567DDE34E2CF579E1C38DDB57872240EBDF2B0E10685EBE6FC433F7ABD3BFF24F8B04259C64791E3CCABA68ED480D2A054ADB7F</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 33 A8 8F 22 DC F4 CD A2 DA BD AE 51
0010 | B0 2F B6 B8 72 FE 11 A1 12 5C C1 41 DA 32 5C 6C
0020 | 9E 79 31 CE 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 78 41 D0 3A 72 FA 2E 5F 53 64 5D 6A C9 A6 02 EC
0140 | B5 78 47 92 9D 8B E7 ED AC 2A F8 37 C2 8F 70 02
0150 | B2 FE EA 57 E6 79 07 21 25 C8 C8 B4 6A 29 11 96
0160 | 02 E4 FA FE 28 3B 53 49 BB ED 3C 91 70 ED 8E 69
0170 | 33 AD A5 39 03 A3 C9 B3 A0 F0 CF 7E 99 09 C2 FB
0180 | 5E 0B 0F 23 E3 00 9B C9 C4 91 07 9B 65 D4 46 D1
0190 | 70 8C 26 DC FD 41 AD 56 4C 0A 82 FD 70 F9 00 82
01A0 | BC 81 A0 73 7D 46 95 78 11 2A 07 4A AC D9 38 EE
01B0 | A5 4B BC F0 F3 35 B1 B4 68 16 7E 7F DE D2 B9 21
01C0 | E2 BD 0C 4D D9 56 DF 6F A4 C4 BB E2 82 AD E8 AD
01D0 | 67 E2 2B 62 08 18 3A C0 46 F0 71 CF 54 19 D6 1D
01E0 | 83 D8 7F 0C 86 8C C4 E7 C2 49 F0 E3 DB CF 44 0B
01F0 | DF CF 25 BF FC CF E4 90 33 02 C8 CD 82 89 04 65
0200 | 7E DC 4C 3F 21 F7 DA 51 05 67 DD E3 4E 2C F5 79
0210 | E1 C3 8D DB 57 87 22 40 EB DF 2B 0E 10 68 5E BE
0220 | 6F C4 33 F7 AB D3 BF F2 4F 8B 04 25 9C 64 79 1E
0230 | 3C CA BA 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007841D03A72FA2E5F53645D6A</code> <code>C9A602ECB57847929D8BE7EDAC2AF837</code> <code>C28F7002B2FEEA57E679072125C8C8B4</code> <code>6A29119602E4FAFE283B5349BBED3C91</code> <code>70ED8E6933ADA53903A3C9B3A0F0CF7E</code> <code>9909C2FB5E0B0F23E3009BC9C491079B</code> <code>65D446D1708C26DCFD41AD564C0A82FD</code> <code>70F90082BC81A0737D469578112A074A</code> <code>ACD938EEA54BBCF0F335B1B468167E7F</code> <code>DED2B921E2BD0C4DD956DF6FA4C4BBE2</code> <code>82ADE8AD67E22B6208183AC046F071CF</code> <code>5419D61D83D87F0C868CC4E7C249F0E3</code> <code>DBCF440BDFCF25BFFCCFE4903302C8CD</code> <code>828904657EDC4C3F21F7DA510567DDE3</code> <code>4E2CF579E1C38DDB57872240EBDF2B0E</code> <code>10685EBE6FC433F7ABD3BFF24F8B0425</code><br> <code>9C64791E</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>3CCABA68</code> (1757071932 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = C22142CD9E0380754C59189B64823A69411C5B98C1677AD4F0D2AE4897B76973BF2603BF48A0DA651CE9D1F01AB976194FC7C0C72A5F5CAE4D7EBDB62999795BA680E84C263C487FA9ACCCC7F96AA20B5883B6999AA1202D365E711E8137036FA895BEE5931E35574CE0E36067508AF48A1FDEDA827F5B7A85E1E997AD731BBB0A4A01DA72D42580910B5AAEB32C96A0EA48E812B7171F33C77F5A3F2CDE316A9F30D237B32E04C771ED88B947E5EE1331D64DB2C8AD293E8D04C5EEEEDE3BA34CCA75A37C3AB0208D5DAB1B94DD73CCAB354850EEBE73AC51B244FB7CF9E62AC97DE9B4B6F3AA3C7C418FB0304ABE725D5FEAE6FB1E34EE8D9848F1F0B6509E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 12F5AADFCD162974C1EEDE33DC3787CDC9AECB03EAE77B7DF48AB425D1CFC9857EC8C35EB269E4DAC89C1A4CDFC58E48279C427B4C10143ED2BA8EF59C23AE8E319ABB6FE9266A74ADFD4C55153D4873896D6EA74CEEDD5A3DD8CA45FDE94FD0F691B0377A5EA4891EB6669ED23BE26C6B1325CE28C2AA9CE231E605D4ADC6392D2E201569B73FB11D1B559B48216C324C60057E8C46838034376B568307035ADC529075F17D76B658046D1CA18B366C240BDAC78BC3932B3BB1569554BDE3C53E51CB64253405DD5C72955CBDEDAE541AB0AC7521F6FADD43B4BB06F9850D1716DF2A39EB61A79127D8B9360095811A7B6128416A3EB74656E02B522F3B2EAA</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 33 A8 8F 22 DC F4 CD A2 DA BD AE 51
0010 | B0 2F B6 B8 72 FE 11 A1 12 5C C1 41 DA 32 5C 6C
0020 | 9E 79 31 CE 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 12 F5 AA DF CD 16 29 74 C1 EE DE 33 DC 37 87 CD
0040 | C9 AE CB 03 EA E7 7B 7D F4 8A B4 25 D1 CF C9 85
0050 | 7E C8 C3 5E B2 69 E4 DA C8 9C 1A 4C DF C5 8E 48
0060 | 27 9C 42 7B 4C 10 14 3E D2 BA 8E F5 9C 23 AE 8E
0070 | 31 9A BB 6F E9 26 6A 74 AD FD 4C 55 15 3D 48 73
0080 | 89 6D 6E A7 4C EE DD 5A 3D D8 CA 45 FD E9 4F D0
0090 | F6 91 B0 37 7A 5E A4 89 1E B6 66 9E D2 3B E2 6C
00A0 | 6B 13 25 CE 28 C2 AA 9C E2 31 E6 05 D4 AD C6 39
00B0 | 2D 2E 20 15 69 B7 3F B1 1D 1B 55 9B 48 21 6C 32
00C0 | 4C 60 05 7E 8C 46 83 80 34 37 6B 56 83 07 03 5A
00D0 | DC 52 90 75 F1 7D 76 B6 58 04 6D 1C A1 8B 36 6C
00E0 | 24 0B DA C7 8B C3 93 2B 3B B1 56 95 54 BD E3 C5
00F0 | 3E 51 CB 64 25 34 05 DD 5C 72 95 5C BD ED AE 54
0100 | 1A B0 AC 75 21 F6 FA DD 43 B4 BB 06 F9 85 0D 17
0110 | 16 DF 2A 39 EB 61 A7 91 27 D8 B9 36 00 95 81 1A
0120 | 7B 61 28 41 6A 3E B7 46 56 E0 2B 52 2F 3B 2E AA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010012F5AADFCD162974C1EEDE33</code> <code>DC3787CDC9AECB03EAE77B7DF48AB425</code> <code>D1CFC9857EC8C35EB269E4DAC89C1A4C</code> <code>DFC58E48279C427B4C10143ED2BA8EF5</code> <code>9C23AE8E319ABB6FE9266A74ADFD4C55</code> <code>153D4873896D6EA74CEEDD5A3DD8CA45</code> <code>FDE94FD0F691B0377A5EA4891EB6669E</code> <code>D23BE26C6B1325CE28C2AA9CE231E605</code> <code>D4ADC6392D2E201569B73FB11D1B559B</code> <code>48216C324C60057E8C46838034376B56</code> <code>8307035ADC529075F17D76B658046D1C</code> <code>A18B366C240BDAC78BC3932B3BB15695</code> <code>54BDE3C53E51CB64253405DD5C72955C</code> <code>BDEDAE541AB0AC7521F6FADD43B4BB06</code> <code>F9850D1716DF2A39EB61A79127D8B936</code> <code>0095811A7B6128416A3EB74656E02B52</code><br> <code>2F3B2EAA</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436633A88F22DCF4CDA2DABDAE51B02FB6B872FE11A1125CC141DA325C6C9E7931CE0000000000000000FE00010012F5AADFCD162974C1EEDE33DC3787CDC9AECB03EAE77B7DF48AB425D1CFC9857EC8C35EB269E4DAC89C1A4CDFC58E48279C427B4C10143ED2BA8EF59C23AE8E319ABB6FE9266A74ADFD4C55153D4873896D6EA74CEEDD5A3DD8CA45FDE94FD0F691B0377A5EA4891EB6669ED23BE26C6B1325CE28C2AA9CE231E605D4ADC6392D2E201569B73FB11D1B559B48216C324C60057E8C46838034376B568307035ADC529075F17D76B658046D1CA18B366C240BDAC78BC3932B3BB1569554BDE3C53E51CB64253405DD5C72955CBDEDAE541AB0AC7521F6FADD43B4BB06F9850D1716DF2A39EB61A79127D8B9360095811A7B6128416A3EB74656E02B522F3B2EAA
padding = 70A02904D0508489AF29B0F4
tmp_aes_key = 5F631F55BA2EE63AECD7C48AA5A8E802A2E765F141C10FC9D60C3F5CD0E5EBAF
tmp_aes_iv = BBBABA19B300A3719FB3F60104BF24639654D61C933514741DF017E05814EC56</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 906198936B45D31C7A09189FE17B44D860C1CD5063E88127157C101DCC3C01CA16C540D17A94838B5D7E7FC9AD807E52B8971DC0E08AA7D6F8BDF767C7C01BEF83B899224A04F206B92DF73A0400769DCBB5A93313D538672D27BB8703A5B5C49E1D98ADF12F0EFB811AD121BE84BBE7E7D682C3C14D3E289C7CFA41780CDBF469CF98532ABEA7DDC8DDDFEA4E2E1B76187A2EEAF354CA1701D346145EF8037F0D5BC77EAD63261ACD3D658A66416EE38C640CD65EBA3ED62701831E5E79DB213ABF603CAD3E5C4359D9C6E6283A76976C76D007C223F3EBD2FA4401307F4B1F9C8A03325E792F758F4B05F83DE77AE3550CBD3D14D4AC0D5C6F857CBCF3131B6493F2FDC4F1EE881DBB0952266FCAA711CD46D3E93A5620813CC8339BD4D78CFF7753062CB69981CB02B5B2D55DFE9FFD895E5AA4305001BA5D682EC298596CB508989F72EA0EDBF3131078B5B62413</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 54 39 0E 00 3C CA BA 68
0010 | 78 01 00 00 1F 5F 04 F5 33 A8 8F 22 DC F4 CD A2
0020 | DA BD AE 51 B0 2F B6 B8 72 FE 11 A1 12 5C C1 41
0030 | DA 32 5C 6C 9E 79 31 CE FE 50 01 00 90 61 98 93
0040 | 6B 45 D3 1C 7A 09 18 9F E1 7B 44 D8 60 C1 CD 50
0050 | 63 E8 81 27 15 7C 10 1D CC 3C 01 CA 16 C5 40 D1
0060 | 7A 94 83 8B 5D 7E 7F C9 AD 80 7E 52 B8 97 1D C0
0070 | E0 8A A7 D6 F8 BD F7 67 C7 C0 1B EF 83 B8 99 22
0080 | 4A 04 F2 06 B9 2D F7 3A 04 00 76 9D CB B5 A9 33
0090 | 13 D5 38 67 2D 27 BB 87 03 A5 B5 C4 9E 1D 98 AD
00A0 | F1 2F 0E FB 81 1A D1 21 BE 84 BB E7 E7 D6 82 C3
00B0 | C1 4D 3E 28 9C 7C FA 41 78 0C DB F4 69 CF 98 53
00C0 | 2A BE A7 DD C8 DD DF EA 4E 2E 1B 76 18 7A 2E EA
00D0 | F3 54 CA 17 01 D3 46 14 5E F8 03 7F 0D 5B C7 7E
00E0 | AD 63 26 1A CD 3D 65 8A 66 41 6E E3 8C 64 0C D6
00F0 | 5E BA 3E D6 27 01 83 1E 5E 79 DB 21 3A BF 60 3C
0100 | AD 3E 5C 43 59 D9 C6 E6 28 3A 76 97 6C 76 D0 07
0110 | C2 23 F3 EB D2 FA 44 01 30 7F 4B 1F 9C 8A 03 32
0120 | 5E 79 2F 75 8F 4B 05 F8 3D E7 7A E3 55 0C BD 3D
0130 | 14 D4 AC 0D 5C 6F 85 7C BC F3 13 1B 64 93 F2 FD
0140 | C4 F1 EE 88 1D BB 09 52 26 6F CA A7 11 CD 46 D3
0150 | E9 3A 56 20 81 3C C8 33 9B D4 D7 8C FF 77 53 06
0160 | 2C B6 99 81 CB 02 B5 B2 D5 5D FE 9F FD 89 5E 5A
0170 | A4 30 50 01 BA 5D 68 2E C2 98 59 6C B5 08 98 9F
0180 | 72 EA 0E DB F3 13 10 78 B5 B6 24 13</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>54390E003CCABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100906198936B45D31C7A09189F</code> <code>E17B44D860C1CD5063E88127157C101D</code> <code>CC3C01CA16C540D17A94838B5D7E7FC9</code> <code>AD807E52B8971DC0E08AA7D6F8BDF767</code> <code>C7C01BEF83B899224A04F206B92DF73A</code> <code>0400769DCBB5A93313D538672D27BB87</code> <code>03A5B5C49E1D98ADF12F0EFB811AD121</code> <code>BE84BBE7E7D682C3C14D3E289C7CFA41</code> <code>780CDBF469CF98532ABEA7DDC8DDDFEA</code> <code>4E2E1B76187A2EEAF354CA1701D34614</code> <code>5EF8037F0D5BC77EAD63261ACD3D658A</code> <code>66416EE38C640CD65EBA3ED62701831E</code> <code>5E79DB213ABF603CAD3E5C4359D9C6E6</code> <code>283A76976C76D007C223F3EBD2FA4401</code> <code>307F4B1F9C8A03325E792F758F4B05F8</code> <code>3DE77AE3550CBD3D14D4AC0D5C6F857C</code> <code>BCF3131B6493F2FDC4F1EE881DBB0952</code> <code>266FCAA711CD46D3E93A5620813CC833</code> <code>9BD4D78CFF7753062CB69981CB02B5B2</code> <code>D55DFE9FFD895E5AA4305001BA5D682E</code> <code>C298596CB508989F72EA0EDBF3131078</code><br> <code>B5B62413</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 68543ED14985B253C7F6184BCEB90742ED9E85C44D41AD8018EC1F74CEC8E58C495BF112500B247AC06BC6E2F92C953119D14B69D108C416B15BBAA93EEBFA2BA19DCDB6AFD9253FCB7642795A384A52E452363471D78671F7CC28FC24AD36E63C109AC81A328A0649FAE129E25838B9D13A8D8B0229DD6FB93F6196DB183073CA3F44FA556C39036D604BEB4F8022E507E4F6D5C4C2BA448BBC844E22D6F7C62D5A7D73F28849351974E4881E93CA3DBF3B24E70F617A07E9DE511AE45A0D3CC6E1485FB2A40FC5217FF78C6DF66392700D0A89CC4A8FC0AC45562E9F8E3EE8FD8AC090327AA12412B8499E8F8DFB328D60A7FEDE6E6AA69ACFCD87BB4E215D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B0 96 B1 3D CA BA 68
0010 | 34 00 00 00 34 F7 CB 3B 33 A8 8F 22 DC F4 CD A2
0020 | DA BD AE 51 B0 2F B6 B8 72 FE 11 A1 12 5C C1 41
0030 | DA 32 5C 6C 9E 79 31 CE BB 96 BD 5B C9 77 96 78
0040 | 35 32 30 9C 90 B0 7B 9F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B096B13DCABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>33A88F22DCF4CDA2DABDAE51B02FB6B8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>72FE11A1125CC141DA325C6C9E7931CE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>BB96BD5BC97796783532309C90B07B9F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

