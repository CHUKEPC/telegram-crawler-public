<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC 94 02 00 E4 CC 40 67
0010 | 14 00 00 00 F1 8E 7E BE 31 0C 79 4E 7B 23 61 8E
0020 | B0 73 8C 8D AF C2 E0 6B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>EC940200E4CC4067</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 64 03 C9 E4 CC 40 67
0010 | 50 00 00 00 63 24 16 05 31 0C 79 4E 7B 23 61 8E
0020 | B0 73 8C 8D AF C2 E0 6B 44 81 C6 C3 09 1C 81 63
0030 | F5 E7 3C 46 5D 6D 4E 2D 08 20 3B 6F 6C D2 2E A9
0040 | 25 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>016403C9E4CC4067</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08203B6F6CD22EA925000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2322572546013047077</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2322572546013047077</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2322572546013047077 = 1293655483 * 1795356319</code></p>
<pre><code>p = 1293655483
q = 1795356319</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 3B 6F 6C D2 2E A9 25 00 00 00
0010 | 04 4D 1B 9D BB 00 00 00 04 6B 02 F6 9F 00 00 00
0020 | 31 0C 79 4E 7B 23 61 8E B0 73 8C 8D AF C2 E0 6B
0030 | 44 81 C6 C3 09 1C 81 63 F5 E7 3C 46 5D 6D 4E 2D
0040 | E2 52 34 AD 41 E4 77 A1 11 C2 65 8F 5C D6 12 79
0050 | 04 D5 29 82 FE CF 4D 5B 96 E3 23 29 FF EF 1F A1
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08203B6F6CD22EA925000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2322572546013047077</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044D1B9DBB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1293655483</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046B02F69F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1795356319</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>E25234AD41E477A111C2658F5CD61279</code> <code>04D52982FECF4D5B96E32329FFEF1FA1</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908203B6F6CD22EA925000000044D1B9DBB000000046B02F69F000000310C794E7B23618EB0738C8DAFC2E06B4481C6C3091C8163F5E73C465D6D4E2DE25234AD41E477A111C2658F5CD6127904D52982FECF4D5B96E32329FFEF1FA102000000
random_padding_bytes = 55522C50EF3EDC85B2B5C516A82223DD566998E0CBEE795F06925C8DC2D2F11D8A1056F91AF22FCECBA728AE26C050948777289A6CE1E48671735EAD153612D6E9D1B0CAB651315F0D50D398068C02DDEFBAF2FAC290583B028020C4</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D3127940CDA64BA0B7A0DFE1F91F6491ADCEAC3E9BCEBFD655F382AE35F0293F72CAC273BC362313C930144FEE113613029F0474376CF9AAA32E1FBD1B3718660E73842FC00BF29EAFF09C9CEFE53211F2E3C0B4F54BDFB4B2F01BA0FFD717991D136C75ED3572C17D2518A2D6EB34C34841E90E5629FEB36CE40B963FB69FB6F43BB4F99AA01270CA22CCD4C1FF0D3809C3F78E35A451C024D50EBC2DEE7A27E5402AAB4170EE4EE3641077E2A2E8CCC70E8C8FFADFA392A86CAF6CF20312FB5638B7E497C4D2BA06E2B68B71080CEEDDF99C8FBA836F863688272BD574F0DAF2D98FE049B58072F585DF4A33B16776815819E0556FE168080FDEEADCA8538C</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C 99 0E 00 E4 CC 40 67
0010 | 40 01 00 00 BE E4 12 D7 31 0C 79 4E 7B 23 61 8E
0020 | B0 73 8C 8D AF C2 E0 6B 44 81 C6 C3 09 1C 81 63
0030 | F5 E7 3C 46 5D 6D 4E 2D 04 4D 1B 9D BB 00 00 00
0040 | 04 6B 02 F6 9F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D3 12 79 40 CD A6 4B A0 B7 A0 DF E1
0060 | F9 1F 64 91 AD CE AC 3E 9B CE BF D6 55 F3 82 AE
0070 | 35 F0 29 3F 72 CA C2 73 BC 36 23 13 C9 30 14 4F
0080 | EE 11 36 13 02 9F 04 74 37 6C F9 AA A3 2E 1F BD
0090 | 1B 37 18 66 0E 73 84 2F C0 0B F2 9E AF F0 9C 9C
00A0 | EF E5 32 11 F2 E3 C0 B4 F5 4B DF B4 B2 F0 1B A0
00B0 | FF D7 17 99 1D 13 6C 75 ED 35 72 C1 7D 25 18 A2
00C0 | D6 EB 34 C3 48 41 E9 0E 56 29 FE B3 6C E4 0B 96
00D0 | 3F B6 9F B6 F4 3B B4 F9 9A A0 12 70 CA 22 CC D4
00E0 | C1 FF 0D 38 09 C3 F7 8E 35 A4 51 C0 24 D5 0E BC
00F0 | 2D EE 7A 27 E5 40 2A AB 41 70 EE 4E E3 64 10 77
0100 | E2 A2 E8 CC C7 0E 8C 8F FA DF A3 92 A8 6C AF 6C
0110 | F2 03 12 FB 56 38 B7 E4 97 C4 D2 BA 06 E2 B6 8B
0120 | 71 08 0C EE DD F9 9C 8F BA 83 6F 86 36 88 27 2B
0130 | D5 74 F0 DA F2 D9 8F E0 49 B5 80 72 F5 85 DF 4A
0140 | 33 B1 67 76 81 58 19 E0 55 6F E1 68 08 0F DE EA
0150 | DC A8 53 8C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6C990E00E4CC4067</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044D1B9DBB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1293655483</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046B02F69F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1795356319</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D3127940CDA64BA0B7A0DFE1</code> <code>F91F6491ADCEAC3E9BCEBFD655F382AE</code> <code>35F0293F72CAC273BC362313C930144F</code> <code>EE113613029F0474376CF9AAA32E1FBD</code> <code>1B3718660E73842FC00BF29EAFF09C9C</code> <code>EFE53211F2E3C0B4F54BDFB4B2F01BA0</code> <code>FFD717991D136C75ED3572C17D2518A2</code> <code>D6EB34C34841E90E5629FEB36CE40B96</code> <code>3FB69FB6F43BB4F99AA01270CA22CCD4</code> <code>C1FF0D3809C3F78E35A451C024D50EBC</code> <code>2DEE7A27E5402AAB4170EE4EE3641077</code> <code>E2A2E8CCC70E8C8FFADFA392A86CAF6C</code> <code>F20312FB5638B7E497C4D2BA06E2B68B</code> <code>71080CEEDDF99C8FBA836F863688272B</code> <code>D574F0DAF2D98FE049B58072F585DF4A</code> <code>33B16776815819E0556FE168080FDEEA</code><br> <code>DCA8538C</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 6C 72 DC E4 CC 40 67
0010 | 78 02 00 00 5C 07 E8 D0 31 0C 79 4E 7B 23 61 8E
0020 | B0 73 8C 8D AF C2 E0 6B 44 81 C6 C3 09 1C 81 63
0030 | F5 E7 3C 46 5D 6D 4E 2D FE 50 02 00 F4 6A 1B AB
0040 | 49 DB 27 8C 55 2C 65 E1 4D E1 2E 23 66 14 E2 6A
0050 | 3E B8 3F 1F F5 2C 50 21 FC 66 F7 EA B5 95 97 10
0060 | B5 03 F7 6C 5E 73 85 08 B3 A3 0B 5C D4 24 F8 EC
0070 | 49 34 9B D0 07 58 04 74 5B E4 64 01 31 CD 9A A3
0080 | 4F D6 38 24 1D E5 A6 0C BF 3F 2C 50 00 AF 00 8B
0090 | FF E5 2E 74 1D 99 2A 2F B1 A6 8B 3B 89 AD 5C 65
00A0 | 31 19 F6 AA 74 5C 68 60 49 D0 54 A6 DA 02 A6 F9
00B0 | 50 9A 03 D8 AD 01 3E DD 1A 3F FD 47 D7 F0 FD C4
00C0 | 8F 02 62 BF FA EB 58 5A F2 23 A8 6B 7F 76 66 48
00D0 | BC 02 B2 7D 19 8A 9E D5 AA C3 57 99 33 A2 CF 22
00E0 | 36 29 52 CE BA 44 16 60 2A 77 F8 22 C4 E0 C9 AB
00F0 | 56 E6 C1 C4 D8 C7 59 B9 AF D9 DE F4 FC 88 72 B5
0100 | B6 EA A8 E2 3B 4E 5B 66 36 D4 F6 42 F0 A9 6D E3
0110 | 40 25 E8 F7 76 93 F7 B0 A2 13 44 69 A9 4D 35 1A
0120 | B3 24 4D 50 6A 78 39 20 D4 D8 18 C9 39 4D 41 D3
0130 | 16 9D 3E C1 0B DD 68 1D 98 8B 56 7E 49 AA B4 27
0140 | F0 95 C3 03 65 BD 1F DC E1 EA 89 BD BF 4C F1 D6
0150 | 97 93 EE 05 71 77 0D 3F D1 DC CD 60 F9 5F 1C 26
0160 | BE 95 8D 9C F5 36 61 6F 7B D6 B6 29 BA 58 DD 04
0170 | 39 C9 D5 B1 F6 5D 2C 11 EF CE A0 14 CC E8 83 26
0180 | A3 B2 BF C8 BB 31 5A 84 3F 14 7A B4 1C 71 71 A1
0190 | 89 4E 24 D7 4F 32 AA ED A3 8C 6C 5E 5D FE 57 28
01A0 | B7 15 D8 3A B3 E1 FB 42 77 6A F9 C8 CB 33 95 94
01B0 | D3 D8 D2 6E F6 5B 73 D0 D9 11 93 1B 29 C5 D6 81
01C0 | C1 8C 4D 7A F9 A7 F8 4B F0 3A E4 0C 4F 35 76 3D
01D0 | 25 87 40 9E 36 AB 84 9A 58 05 29 2A 4B 83 2D E6
01E0 | 52 14 BC 11 65 1D 1B 92 DD 8E F6 FE E4 FE 16 C9
01F0 | 95 4F 98 4C 7A 2A 9E 08 E3 E9 8A C8 1B 89 74 38
0200 | 63 4C 9C 35 AD 46 C7 3C 75 26 F9 B8 02 01 B5 5F
0210 | 2E A3 72 C0 0F 13 05 86 19 F0 6D E3 48 0A 68 CF
0220 | 58 34 CB E0 92 47 98 7C 77 55 AE 10 BD 4D BB A9
0230 | EA E5 9C C6 84 13 A5 88 66 09 82 97 F5 6D 68 DB
0240 | C2 89 8C 16 D1 11 B2 CC CC 8F 03 BE AC 8D D3 BE
0250 | 0F 9D A9 74 E9 09 B2 16 F9 FE 39 62 50 2D 3F D8
0260 | B0 8C B5 E4 93 6B BF 04 D3 30 E7 FB 4F 06 E2 61
0270 | 2F D4 C5 58 30 CA 7B 61 D3 BD 47 64 96 9A 1A E3
0280 | 8E 1B 72 F8 76 15 EC 81 06 33 73 EA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>016C72DCE4CC4067</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200F46A1BAB49DB278C552C65E1</code> <code>4DE12E236614E26A3EB83F1FF52C5021</code> <code>FC66F7EAB5959710B503F76C5E738508</code> <code>B3A30B5CD424F8EC49349BD007580474</code> <code>5BE4640131CD9AA34FD638241DE5A60C</code> <code>BF3F2C5000AF008BFFE52E741D992A2F</code> <code>B1A68B3B89AD5C653119F6AA745C6860</code> <code>49D054A6DA02A6F9509A03D8AD013EDD</code> <code>1A3FFD47D7F0FDC48F0262BFFAEB585A</code> <code>F223A86B7F766648BC02B27D198A9ED5</code> <code>AAC3579933A2CF22362952CEBA441660</code> <code>2A77F822C4E0C9AB56E6C1C4D8C759B9</code> <code>AFD9DEF4FC8872B5B6EAA8E23B4E5B66</code> <code>36D4F642F0A96DE34025E8F77693F7B0</code> <code>A2134469A94D351AB3244D506A783920</code> <code>D4D818C9394D41D3169D3EC10BDD681D</code> <code>988B567E49AAB427F095C30365BD1FDC</code> <code>E1EA89BDBF4CF1D69793EE0571770D3F</code> <code>D1DCCD60F95F1C26BE958D9CF536616F</code> <code>7BD6B629BA58DD0439C9D5B1F65D2C11</code> <code>EFCEA014CCE88326A3B2BFC8BB315A84</code> <code>3F147AB41C7171A1894E24D74F32AAED</code> <code>A38C6C5E5DFE5728B715D83AB3E1FB42</code> <code>776AF9C8CB339594D3D8D26EF65B73D0</code> <code>D911931B29C5D681C18C4D7AF9A7F84B</code> <code>F03AE40C4F35763D2587409E36AB849A</code> <code>5805292A4B832DE65214BC11651D1B92</code> <code>DD8EF6FEE4FE16C9954F984C7A2A9E08</code> <code>E3E98AC81B897438634C9C35AD46C73C</code> <code>7526F9B80201B55F2EA372C00F130586</code> <code>19F06DE3480A68CF5834CBE09247987C</code> <code>7755AE10BD4DBBA9EAE59CC68413A588</code> <code>66098297F56D68DBC2898C16D111B2CC</code> <code>CC8F03BEAC8DD3BE0F9DA974E909B216</code> <code>F9FE3962502D3FD8B08CB5E4936BBF04</code> <code>D330E7FB4F06E2612FD4C55830CA7B61</code> <code>D3BD4764969A1AE38E1B72F87615EC81</code><br> <code>063373EA</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = F46A1BAB49DB278C552C65E14DE12E236614E26A3EB83F1FF52C5021FC66F7EAB5959710B503F76C5E738508B3A30B5CD424F8EC49349BD0075804745BE4640131CD9AA34FD638241DE5A60CBF3F2C5000AF008BFFE52E741D992A2FB1A68B3B89AD5C653119F6AA745C686049D054A6DA02A6F9509A03D8AD013EDD1A3FFD47D7F0FDC48F0262BFFAEB585AF223A86B7F766648BC02B27D198A9ED5AAC3579933A2CF22362952CEBA4416602A77F822C4E0C9AB56E6C1C4D8C759B9AFD9DEF4FC8872B5B6EAA8E23B4E5B6636D4F642F0A96DE34025E8F77693F7B0A2134469A94D351AB3244D506A783920D4D818C9394D41D3169D3EC10BDD681D988B567E49AAB427F095C30365BD1FDCE1EA89BDBF4CF1D69793EE0571770D3FD1DCCD60F95F1C26BE958D9CF536616F7BD6B629BA58DD0439C9D5B1F65D2C11EFCEA014CCE88326A3B2BFC8BB315A843F147AB41C7171A1894E24D74F32AAEDA38C6C5E5DFE5728B715D83AB3E1FB42776AF9C8CB339594D3D8D26EF65B73D0D911931B29C5D681C18C4D7AF9A7F84BF03AE40C4F35763D2587409E36AB849A5805292A4B832DE65214BC11651D1B92DD8EF6FEE4FE16C9954F984C7A2A9E08E3E98AC81B897438634C9C35AD46C73C7526F9B80201B55F2EA372C00F13058619F06DE3480A68CF5834CBE09247987C7755AE10BD4DBBA9EAE59CC68413A58866098297F56D68DBC2898C16D111B2CCCC8F03BEAC8DD3BE0F9DA974E909B216F9FE3962502D3FD8B08CB5E4936BBF04D330E7FB4F06E2612FD4C55830CA7B61D3BD4764969A1AE38E1B72F87615EC81063373EA
tmp_aes_key = A98192C2BF6434FA4B834E502850EA20754863EF0F18E003B9534DA507031C7D
tmp_aes_iv = C1911F8149AC1EACD37993F560F78F00C5F5866504AF62F5082CA734E25234AD</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 6161438B4BECD1727F8E5CA8FAD7FD981FF276A0BA0D89B5310C794E7B23618EB0738C8DAFC2E06B4481C6C3091C8163F5E73C465D6D4E2D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001008E0BA62E1893924565008BBB7E95B2BD9472A9F8066F00FA379FFD2A1B8CCA554E70BCB00186E3E9E37D631622C5712CA4D74C5B775022A88CB6A1B8F3918EFAE97AC3419487CB7FB3D9B68839A24C365F8B19F5CBADAE76663866117E91AB067E5F6CD70D2B87329BE53CB723EBC4941F9466F97781EE06E61FBF960EA44731C981AF484203319A969CB7E926E38A08B7C87DA4851ECCCD662C345E205BD688632AD2F9946D8F0B5F0EB24D945E2B44E0CED67CEC54727BF56AFA5818D85F366722305C34659884FE2BB32677FE23A62183AFE42DA5546EA6FFEF0FE2FF3C3DE2100187BF2A08D13E944C4A9BF4A370715ADBE727825BCB5766427AD144F9CEE4CC406706C5D9BFA049BBD3
answer = BA0D89B5310C794E7B23618EB0738C8DAFC2E06B4481C6C3091C8163F5E73C465D6D4E2D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001008E0BA62E1893924565008BBB7E95B2BD9472A9F8066F00FA379FFD2A1B8CCA554E70BCB00186E3E9E37D631622C5712CA4D74C5B775022A88CB6A1B8F3918EFAE97AC3419487CB7FB3D9B68839A24C365F8B19F5CBADAE76663866117E91AB067E5F6CD70D2B87329BE53CB723EBC4941F9466F97781EE06E61FBF960EA44731C981AF484203319A969CB7E926E38A08B7C87DA4851ECCCD662C345E205BD688632AD2F9946D8F0B5F0EB24D945E2B44E0CED67CEC54727BF56AFA5818D85F366722305C34659884FE2BB32677FE23A62183AFE42DA5546EA6FFEF0FE2FF3C3DE2100187BF2A08D13E944C4A9BF4A370715ADBE727825BCB5766427AD144F9CEE4CC406706C5D9BFA049BBD3</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 31 0C 79 4E 7B 23 61 8E B0 73 8C 8D
0010 | AF C2 E0 6B 44 81 C6 C3 09 1C 81 63 F5 E7 3C 46
0020 | 5D 6D 4E 2D 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 8E 0B A6 2E 18 93 92 45 65 00 8B BB 7E 95 B2 BD
0140 | 94 72 A9 F8 06 6F 00 FA 37 9F FD 2A 1B 8C CA 55
0150 | 4E 70 BC B0 01 86 E3 E9 E3 7D 63 16 22 C5 71 2C
0160 | A4 D7 4C 5B 77 50 22 A8 8C B6 A1 B8 F3 91 8E FA
0170 | E9 7A C3 41 94 87 CB 7F B3 D9 B6 88 39 A2 4C 36
0180 | 5F 8B 19 F5 CB AD AE 76 66 38 66 11 7E 91 AB 06
0190 | 7E 5F 6C D7 0D 2B 87 32 9B E5 3C B7 23 EB C4 94
01A0 | 1F 94 66 F9 77 81 EE 06 E6 1F BF 96 0E A4 47 31
01B0 | C9 81 AF 48 42 03 31 9A 96 9C B7 E9 26 E3 8A 08
01C0 | B7 C8 7D A4 85 1E CC CD 66 2C 34 5E 20 5B D6 88
01D0 | 63 2A D2 F9 94 6D 8F 0B 5F 0E B2 4D 94 5E 2B 44
01E0 | E0 CE D6 7C EC 54 72 7B F5 6A FA 58 18 D8 5F 36
01F0 | 67 22 30 5C 34 65 98 84 FE 2B B3 26 77 FE 23 A6
0200 | 21 83 AF E4 2D A5 54 6E A6 FF EF 0F E2 FF 3C 3D
0210 | E2 10 01 87 BF 2A 08 D1 3E 94 4C 4A 9B F4 A3 70
0220 | 71 5A DB E7 27 82 5B CB 57 66 42 7A D1 44 F9 CE
0230 | E4 CC 40 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001008E0BA62E1893924565008BBB</code> <code>7E95B2BD9472A9F8066F00FA379FFD2A</code> <code>1B8CCA554E70BCB00186E3E9E37D6316</code> <code>22C5712CA4D74C5B775022A88CB6A1B8</code> <code>F3918EFAE97AC3419487CB7FB3D9B688</code> <code>39A24C365F8B19F5CBADAE7666386611</code> <code>7E91AB067E5F6CD70D2B87329BE53CB7</code> <code>23EBC4941F9466F97781EE06E61FBF96</code> <code>0EA44731C981AF484203319A969CB7E9</code> <code>26E38A08B7C87DA4851ECCCD662C345E</code> <code>205BD688632AD2F9946D8F0B5F0EB24D</code> <code>945E2B44E0CED67CEC54727BF56AFA58</code> <code>18D85F366722305C34659884FE2BB326</code> <code>77FE23A62183AFE42DA5546EA6FFEF0F</code> <code>E2FF3C3DE2100187BF2A08D13E944C4A</code> <code>9BF4A370715ADBE727825BCB5766427A</code><br> <code>D144F9CE</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E4CC4067</code> (1732300004 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A59FD1B60075A3FDE574DC0149AF5ED705D9D05040AD7432D7B8590E349A61FA78A92A105320312E754E5B3BA4DD3706576B99ECF6C878960441352F7D211B0415260AF2FD901B00287E1AEB0C74D351256EA8C4929AED391236054720D4DE5B77EFD48C2EEB1E5377AE12CEEBC9FCD89ABBE2F0F89CA08FC9B1A875D6F79A810893D696AD475EF1D2F7B38D05969817A19FA6CBBADFBCF904344748C7C7B3217351DE67BFC5D4D1A3A6DCF92984B16D7A19297423F7DAC3B73AB76458A38E4C0E1C8FFFEB83F1FAD645174C902B74F1326F6131E2481D52943573779C539292D7E3E9AB700EF127181EA2440D4BCB140B44B7C815948877DB02AB0251FBC29C</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 558F7F7A4E55CDA2B5AB1CF18EFB8A95D5D3E6EB6336BAB12BE5CA08E2FAA43F60ECD95E01684F0224271941BDD50961C29016FF420EED10A0EA566F25C90FCD05671879500F7D8D5EDA0E11F53D62601D7FF2304C3204A6A3CFB7754BF0F501ED1D1471C06624E8B78AA9B0F9613EA9845D1C0EFCEF8F7C07837B1D7A2B305E49796C64854B7243197541003DD1B69B24E821D404341F36698EB8C69DF76213A23FD48A5AF3696D2A8DDE1D830A38183900AE2222C3A9B7F37378A1153EDC369DD643F1A747BEBD53F8B4A07FC55CB44E46373E20C47D91B5B31D4A86D790B112810F7BE859DCA7EF6BC48B39ED324212F7A5DE67A75A818E92AC182E3B36EC</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 31 0C 79 4E 7B 23 61 8E B0 73 8C 8D
0010 | AF C2 E0 6B 44 81 C6 C3 09 1C 81 63 F5 E7 3C 46
0020 | 5D 6D 4E 2D 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 55 8F 7F 7A 4E 55 CD A2 B5 AB 1C F1 8E FB 8A 95
0040 | D5 D3 E6 EB 63 36 BA B1 2B E5 CA 08 E2 FA A4 3F
0050 | 60 EC D9 5E 01 68 4F 02 24 27 19 41 BD D5 09 61
0060 | C2 90 16 FF 42 0E ED 10 A0 EA 56 6F 25 C9 0F CD
0070 | 05 67 18 79 50 0F 7D 8D 5E DA 0E 11 F5 3D 62 60
0080 | 1D 7F F2 30 4C 32 04 A6 A3 CF B7 75 4B F0 F5 01
0090 | ED 1D 14 71 C0 66 24 E8 B7 8A A9 B0 F9 61 3E A9
00A0 | 84 5D 1C 0E FC EF 8F 7C 07 83 7B 1D 7A 2B 30 5E
00B0 | 49 79 6C 64 85 4B 72 43 19 75 41 00 3D D1 B6 9B
00C0 | 24 E8 21 D4 04 34 1F 36 69 8E B8 C6 9D F7 62 13
00D0 | A2 3F D4 8A 5A F3 69 6D 2A 8D DE 1D 83 0A 38 18
00E0 | 39 00 AE 22 22 C3 A9 B7 F3 73 78 A1 15 3E DC 36
00F0 | 9D D6 43 F1 A7 47 BE BD 53 F8 B4 A0 7F C5 5C B4
0100 | 4E 46 37 3E 20 C4 7D 91 B5 B3 1D 4A 86 D7 90 B1
0110 | 12 81 0F 7B E8 59 DC A7 EF 6B C4 8B 39 ED 32 42
0120 | 12 F7 A5 DE 67 A7 5A 81 8E 92 AC 18 2E 3B 36 EC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100558F7F7A4E55CDA2B5AB1CF1</code> <code>8EFB8A95D5D3E6EB6336BAB12BE5CA08</code> <code>E2FAA43F60ECD95E01684F0224271941</code> <code>BDD50961C29016FF420EED10A0EA566F</code> <code>25C90FCD05671879500F7D8D5EDA0E11</code> <code>F53D62601D7FF2304C3204A6A3CFB775</code> <code>4BF0F501ED1D1471C06624E8B78AA9B0</code> <code>F9613EA9845D1C0EFCEF8F7C07837B1D</code> <code>7A2B305E49796C64854B724319754100</code> <code>3DD1B69B24E821D404341F36698EB8C6</code> <code>9DF76213A23FD48A5AF3696D2A8DDE1D</code> <code>830A38183900AE2222C3A9B7F37378A1</code> <code>153EDC369DD643F1A747BEBD53F8B4A0</code> <code>7FC55CB44E46373E20C47D91B5B31D4A</code> <code>86D790B112810F7BE859DCA7EF6BC48B</code> <code>39ED324212F7A5DE67A75A818E92AC18</code><br> <code>2E3B36EC</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366310C794E7B23618EB0738C8DAFC2E06B4481C6C3091C8163F5E73C465D6D4E2D0000000000000000FE000100558F7F7A4E55CDA2B5AB1CF18EFB8A95D5D3E6EB6336BAB12BE5CA08E2FAA43F60ECD95E01684F0224271941BDD50961C29016FF420EED10A0EA566F25C90FCD05671879500F7D8D5EDA0E11F53D62601D7FF2304C3204A6A3CFB7754BF0F501ED1D1471C06624E8B78AA9B0F9613EA9845D1C0EFCEF8F7C07837B1D7A2B305E49796C64854B7243197541003DD1B69B24E821D404341F36698EB8C69DF76213A23FD48A5AF3696D2A8DDE1D830A38183900AE2222C3A9B7F37378A1153EDC369DD643F1A747BEBD53F8B4A07FC55CB44E46373E20C47D91B5B31D4A86D790B112810F7BE859DCA7EF6BC48B39ED324212F7A5DE67A75A818E92AC182E3B36EC
padding = 81C0B9170A1B105CC8BAB510
tmp_aes_key = A98192C2BF6434FA4B834E502850EA20754863EF0F18E003B9534DA507031C7D
tmp_aes_iv = C1911F8149AC1EACD37993F560F78F00C5F5866504AF62F5082CA734E25234AD</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 25AB5D72ECCAE712F961A555C5437AA42A0489D9F723E5A8BDCD1B87649FF51495561E077E480A89EAE0D8A9EFC1CEA013435F0671C148CCF0F920362AE0FFD98EF794596675CA0DBF90581CC560DF89928C48DC33061A7EA1C30F85059DB47D5128C2358269A639EAE5087DFF68EA523F156CFF7B0398BDF7351ED253CA1CDA79139B56C90E7EC9D0FAD3C8864F3982C4F1597983D93A2D0F351464356197DC6597EE710B699039B5F9D7B4324CFEB3D81AB2993ACED9A210F850F38269D3411C29B8EC1A0FAC81A25247361B3B012A63EF2965E22B6A9C30E5010DA05E67A1E2BFC9F111CA91254C7BAB6862A6A70085F0C500F65002154F8C6DD120019CFC0F0D7D9A1A25D8A711F45AB48CD25A98D5FA0ABA64CBDC06B6F22E96CA3FCC8F771D5DD00F58D78247F47F5181287FE50C8F6B63314C7599B1418B068D429509D249938BA116B87F51F5218D6D36461A</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 70 99 0E 00 E4 CC 40 67
0010 | 78 01 00 00 1F 5F 04 F5 31 0C 79 4E 7B 23 61 8E
0020 | B0 73 8C 8D AF C2 E0 6B 44 81 C6 C3 09 1C 81 63
0030 | F5 E7 3C 46 5D 6D 4E 2D FE 50 01 00 25 AB 5D 72
0040 | EC CA E7 12 F9 61 A5 55 C5 43 7A A4 2A 04 89 D9
0050 | F7 23 E5 A8 BD CD 1B 87 64 9F F5 14 95 56 1E 07
0060 | 7E 48 0A 89 EA E0 D8 A9 EF C1 CE A0 13 43 5F 06
0070 | 71 C1 48 CC F0 F9 20 36 2A E0 FF D9 8E F7 94 59
0080 | 66 75 CA 0D BF 90 58 1C C5 60 DF 89 92 8C 48 DC
0090 | 33 06 1A 7E A1 C3 0F 85 05 9D B4 7D 51 28 C2 35
00A0 | 82 69 A6 39 EA E5 08 7D FF 68 EA 52 3F 15 6C FF
00B0 | 7B 03 98 BD F7 35 1E D2 53 CA 1C DA 79 13 9B 56
00C0 | C9 0E 7E C9 D0 FA D3 C8 86 4F 39 82 C4 F1 59 79
00D0 | 83 D9 3A 2D 0F 35 14 64 35 61 97 DC 65 97 EE 71
00E0 | 0B 69 90 39 B5 F9 D7 B4 32 4C FE B3 D8 1A B2 99
00F0 | 3A CE D9 A2 10 F8 50 F3 82 69 D3 41 1C 29 B8 EC
0100 | 1A 0F AC 81 A2 52 47 36 1B 3B 01 2A 63 EF 29 65
0110 | E2 2B 6A 9C 30 E5 01 0D A0 5E 67 A1 E2 BF C9 F1
0120 | 11 CA 91 25 4C 7B AB 68 62 A6 A7 00 85 F0 C5 00
0130 | F6 50 02 15 4F 8C 6D D1 20 01 9C FC 0F 0D 7D 9A
0140 | 1A 25 D8 A7 11 F4 5A B4 8C D2 5A 98 D5 FA 0A BA
0150 | 64 CB DC 06 B6 F2 2E 96 CA 3F CC 8F 77 1D 5D D0
0160 | 0F 58 D7 82 47 F4 7F 51 81 28 7F E5 0C 8F 6B 63
0170 | 31 4C 75 99 B1 41 8B 06 8D 42 95 09 D2 49 93 8B
0180 | A1 16 B8 7F 51 F5 21 8D 6D 36 46 1A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>70990E00E4CC4067</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010025AB5D72ECCAE712F961A555</code> <code>C5437AA42A0489D9F723E5A8BDCD1B87</code> <code>649FF51495561E077E480A89EAE0D8A9</code> <code>EFC1CEA013435F0671C148CCF0F92036</code> <code>2AE0FFD98EF794596675CA0DBF90581C</code> <code>C560DF89928C48DC33061A7EA1C30F85</code> <code>059DB47D5128C2358269A639EAE5087D</code> <code>FF68EA523F156CFF7B0398BDF7351ED2</code> <code>53CA1CDA79139B56C90E7EC9D0FAD3C8</code> <code>864F3982C4F1597983D93A2D0F351464</code> <code>356197DC6597EE710B699039B5F9D7B4</code> <code>324CFEB3D81AB2993ACED9A210F850F3</code> <code>8269D3411C29B8EC1A0FAC81A2524736</code> <code>1B3B012A63EF2965E22B6A9C30E5010D</code> <code>A05E67A1E2BFC9F111CA91254C7BAB68</code> <code>62A6A70085F0C500F65002154F8C6DD1</code> <code>20019CFC0F0D7D9A1A25D8A711F45AB4</code> <code>8CD25A98D5FA0ABA64CBDC06B6F22E96</code> <code>CA3FCC8F771D5DD00F58D78247F47F51</code> <code>81287FE50C8F6B63314C7599B1418B06</code> <code>8D429509D249938BA116B87F51F5218D</code><br> <code>6D36461A</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 893277475C065FF1AD9CE1224DD84876C3B79725E3FF988F15740FCD13B8834894F3D7E0CF548AD4BB5DFFCF97125B2A15ED2D67BCD2BE11F6D68B6EF1D8DDEDF7F220F1FD76573CB4A68F81799F5D1E1B82AB04F12DCBF28C0F6428C141F020B322C8117A8FB0BEEEFE357AF9D363CCC1193A2EAC9BAB701C15A51B4F8F2995DD86196A14F09AD9C5D65A8C91FE4DDA131F0704F4A356E875AA1A0F3A554FBFEB49B000913A669FE98555FF9E5CA9417935E471AD693E054D92097A1AF5243CEE5F7E9C7AD16E87F92AD12CAA081A0C31FA5DB43D051EB96383D76174B2BF3369F6DF79A1885A1E31722EB4AAE5C87386A5EE630D1EF7F7D84C88E85FF17F1F</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 5D BF E6 CC 40 67
0010 | 34 00 00 00 34 F7 CB 3B 31 0C 79 4E 7B 23 61 8E
0020 | B0 73 8C 8D AF C2 E0 6B 44 81 C6 C3 09 1C 81 63
0030 | F5 E7 3C 46 5D 6D 4E 2D DF 9D 6D 4D AD 52 17 9A
0040 | 8B 69 74 FB 7E 7F 32 49</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01945DBFE6CC4067</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>310C794E7B23618EB0738C8DAFC2E06B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4481C6C3091C8163F5E73C465D6D4E2D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>DF9D6D4DAD52179A8B6974FB7E7F3249</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

