<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 94 1C 07 00 6F 1D A9 66
0010 | 14 00 00 00 F1 8E 7E BE 1B 09 A0 0A D2 F0 2D 7E
0020 | 1C 09 6E E6 37 8E 25 53</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>941C07006F1DA966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 AE 01 70 1D A9 66
0010 | 74 00 00 00 63 24 16 05 1B 09 A0 0A D2 F0 2D 7E
0020 | 1C 09 6E E6 37 8E 25 53 2B 28 6E 1E 25 E4 74 61
0030 | D3 0B C4 2E C9 8D 1F C7 08 23 4D 85 4D FC 28 0C
0040 | 41 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B4AE01701DA966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>74000000</code> (116 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08234D854DFC280C41000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2543835934523657281</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2543835934523657281</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2543835934523657281 = 1346951269 * 1888587949</code></p>
<pre><code>p = 1346951269
q = 1888587949</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 23 4D 85 4D FC 28 0C 41 00 00 00
0010 | 04 50 48 D8 65 00 00 00 04 70 91 90 AD 00 00 00
0020 | 1B 09 A0 0A D2 F0 2D 7E 1C 09 6E E6 37 8E 25 53
0030 | 2B 28 6E 1E 25 E4 74 61 D3 0B C4 2E C9 8D 1F C7
0040 | 2D 36 E3 CA F0 41 D7 7A 54 F5 DD C1 10 EE 6B 0F
0050 | 9F 57 93 52 B3 0B 84 CD 97 59 03 2F D5 24 1D 9F
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08234D854DFC280C41000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2543835934523657281</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045048D865000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1346951269</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04709190AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1888587949</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>2D36E3CAF041D77A54F5DDC110EE6B0F</code> <code>9F579352B30B84CD9759032FD5241D9F</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908234D854DFC280C41000000045048D86500000004709190AD0000001B09A00AD2F02D7E1C096EE6378E25532B286E1E25E47461D30BC42EC98D1FC72D36E3CAF041D77A54F5DDC110EE6B0F9F579352B30B84CD9759032FD5241D9F02000000
random_padding_bytes = 10F0A617F030366CC2EF71A81ED42B90190CA7832B8BEAFC416DFF5ACB4AC456E29E57798ED22A0D5740538DD13D7FB66D23FA451876C6B31621404AE1E2F2C6BACAFF48934B9152478E70E4FF3D2BD007D2F6FC3745FF2185A9961C</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 92B3AB879CD052FAF2C6C9A1E39B43258C187AD82F04408BE1B78FA906D9328AC69E06F6A7BCBAF24729630F303929841FDBBDB90DF2FDA55E6F33BB89D0F007436676A5328D97F6C7E1BC16447E54F9CC56B345F818B24216FD60829E5263EFF6E9E9F85A18E3CD26126ED3C1CBB82CFFBFDC002F17BF40E9D45FDA4252088A456FDE816CBD33DD76436BA014323F345FAFCA016A8925498727E63DDBA6ADC63DB5E5B0B1127C30C86870A70F4D4658EE30AECBB7DF1F62CABD42222E3B81BC8A729A29E0FA817B7D0DA40FBA702456BEF51198CFC60E0085B3BE7EBC62140484A37E859C601B484F06C54A9A65342A21A8F18FBB5345F56D3DAAB0D791D1F2</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 C0 07 00 70 1D A9 66
0010 | 40 01 00 00 BE E4 12 D7 1B 09 A0 0A D2 F0 2D 7E
0020 | 1C 09 6E E6 37 8E 25 53 2B 28 6E 1E 25 E4 74 61
0030 | D3 0B C4 2E C9 8D 1F C7 04 50 48 D8 65 00 00 00
0040 | 04 70 91 90 AD 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 92 B3 AB 87 9C D0 52 FA F2 C6 C9 A1
0060 | E3 9B 43 25 8C 18 7A D8 2F 04 40 8B E1 B7 8F A9
0070 | 06 D9 32 8A C6 9E 06 F6 A7 BC BA F2 47 29 63 0F
0080 | 30 39 29 84 1F DB BD B9 0D F2 FD A5 5E 6F 33 BB
0090 | 89 D0 F0 07 43 66 76 A5 32 8D 97 F6 C7 E1 BC 16
00A0 | 44 7E 54 F9 CC 56 B3 45 F8 18 B2 42 16 FD 60 82
00B0 | 9E 52 63 EF F6 E9 E9 F8 5A 18 E3 CD 26 12 6E D3
00C0 | C1 CB B8 2C FF BF DC 00 2F 17 BF 40 E9 D4 5F DA
00D0 | 42 52 08 8A 45 6F DE 81 6C BD 33 DD 76 43 6B A0
00E0 | 14 32 3F 34 5F AF CA 01 6A 89 25 49 87 27 E6 3D
00F0 | DB A6 AD C6 3D B5 E5 B0 B1 12 7C 30 C8 68 70 A7
0100 | 0F 4D 46 58 EE 30 AE CB B7 DF 1F 62 CA BD 42 22
0110 | 2E 3B 81 BC 8A 72 9A 29 E0 FA 81 7B 7D 0D A4 0F
0120 | BA 70 24 56 BE F5 11 98 CF C6 0E 00 85 B3 BE 7E
0130 | BC 62 14 04 84 A3 7E 85 9C 60 1B 48 4F 06 C5 4A
0140 | 9A 65 34 2A 21 A8 F1 8F BB 53 45 F5 6D 3D AA B0
0150 | D7 91 D1 F2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>78C00700701DA966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045048D865000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1346951269</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04709190AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1888587949</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010092B3AB879CD052FAF2C6C9A1</code> <code>E39B43258C187AD82F04408BE1B78FA9</code> <code>06D9328AC69E06F6A7BCBAF24729630F</code> <code>303929841FDBBDB90DF2FDA55E6F33BB</code> <code>89D0F007436676A5328D97F6C7E1BC16</code> <code>447E54F9CC56B345F818B24216FD6082</code> <code>9E5263EFF6E9E9F85A18E3CD26126ED3</code> <code>C1CBB82CFFBFDC002F17BF40E9D45FDA</code> <code>4252088A456FDE816CBD33DD76436BA0</code> <code>14323F345FAFCA016A8925498727E63D</code> <code>DBA6ADC63DB5E5B0B1127C30C86870A7</code> <code>0F4D4658EE30AECBB7DF1F62CABD4222</code> <code>2E3B81BC8A729A29E0FA817B7D0DA40F</code> <code>BA702456BEF51198CFC60E0085B3BE7E</code> <code>BC62140484A37E859C601B484F06C54A</code> <code>9A65342A21A8F18FBB5345F56D3DAAB0</code><br> <code>D791D1F2</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 84 B7 9C 70 1D A9 66
0010 | F4 02 00 00 5C 07 E8 D0 1B 09 A0 0A D2 F0 2D 7E
0020 | 1C 09 6E E6 37 8E 25 53 2B 28 6E 1E 25 E4 74 61
0030 | D3 0B C4 2E C9 8D 1F C7 FE 50 02 00 DF F2 AB 83
0040 | F3 18 F2 D9 9F 8D BC B3 CB 16 C6 51 43 08 C8 D9
0050 | B2 F5 BE BD B0 3B 9D 3D 0B 6C D0 C6 B6 5A 01 DD
0060 | B4 C4 27 D2 01 CE 8A FC 4F AE 07 37 EB B1 46 26
0070 | 2F 12 09 AA 86 6E BB FF A7 C3 80 22 76 A4 1C D5
0080 | 66 54 2D 5D 61 CE 19 AE 3D C2 76 C6 3F 9D 48 24
0090 | 71 20 0B A0 F8 4D DA F9 D5 85 61 7F 22 81 5F 36
00A0 | 09 CE CA 39 7F 09 3D 73 D2 29 10 19 D9 9A 8E DD
00B0 | BE 68 E3 27 B9 8F A9 2C E9 42 F3 B7 5F 4D 03 4E
00C0 | D3 29 0B 56 B2 D6 E8 BA 8F 1D BD 40 11 92 BE 0E
00D0 | 3A 41 03 F5 37 CB CB F9 30 F6 9E 6A C2 9D 84 96
00E0 | FD 5C F5 A7 61 9D 6E 02 49 8F 42 9B A2 D2 64 1F
00F0 | 31 A8 4B 8F CF 31 F9 FA B3 F4 28 84 29 66 58 A0
0100 | 52 0C CB 42 46 DD A8 D2 D1 0D 55 DC CA 6D A7 B3
0110 | 81 17 09 FE 42 60 47 88 7D A3 0A F9 0C B3 E4 79
0120 | FC F2 CB 3F 38 E5 58 6E E3 33 A8 3D D4 D5 E2 5F
0130 | 57 D9 A0 62 B5 9B 8A DB 77 06 CF 3C AB E6 2C F5
0140 | EA 10 28 57 D4 3A 28 87 79 64 6B 5E CA C9 21 59
0150 | 23 FD 2B 09 34 04 94 31 6D F0 E0 D9 7B A3 66 D8
0160 | 3D 22 70 79 E4 8B 7C 02 19 AC 63 FD 50 6F 18 96
0170 | 79 00 DE C5 F1 5A 14 D7 D4 A0 3E 98 02 A6 4A 3B
0180 | EF E4 FD 95 7C 69 B6 D0 23 73 FD AD AB AF 63 0D
0190 | A5 47 84 E1 AC 50 C1 AA C3 88 E2 D5 13 B9 BD 10
01A0 | 64 7A F4 D9 32 33 5B 57 F2 D8 C4 E6 C3 55 FA 02
01B0 | 6C 8C 8F CE E2 08 77 C9 60 A4 2A 29 01 B8 BE AD
01C0 | 9A 3A CB 9B A5 D3 88 F2 82 D9 29 2F D3 7B A4 89
01D0 | 2D A6 9D 35 92 D2 C2 45 01 51 95 52 45 EB 89 6A
01E0 | 29 8D 85 2B 37 82 EC EF 9D 7D A5 FB 2A 08 15 F8
01F0 | 1D 72 FD 53 29 05 42 AE 57 77 50 5F B0 53 2C 0A
0200 | 8E 0A 1D D5 DB E3 B7 90 82 5A 1A 8B 31 90 0A 6A
0210 | 00 4A 79 05 75 7B 66 4B 69 AF 22 FD 73 88 C6 39
0220 | 87 5D BE 35 17 E0 3A 05 9F A6 64 C4 B3 B6 A6 51
0230 | D6 DD DC F8 EC 17 0B C1 D1 7B 78 78 4A 07 0B ED
0240 | 40 DE 5C F9 A9 4E 75 2A 93 00 EF CD 49 EF 68 F7
0250 | B0 CD E0 FE 80 43 16 5D E5 9E D4 6D 2A EA 0A 37
0260 | FA 78 9C 98 13 B0 71 4A 96 51 7F 63 60 06 97 AE
0270 | 85 A7 A0 A0 15 F9 7F 8B 33 57 62 06 E7 52 70 E6
0280 | AF 35 94 10 33 ED F1 3F 8B E1 F0 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0184B79C701DA966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>F4020000</code> (756 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200DFF2AB83F318F2D99F8DBCB3</code> <code>CB16C6514308C8D9B2F5BEBDB03B9D3D</code> <code>0B6CD0C6B65A01DDB4C427D201CE8AFC</code> <code>4FAE0737EBB146262F1209AA866EBBFF</code> <code>A7C3802276A41CD566542D5D61CE19AE</code> <code>3DC276C63F9D482471200BA0F84DDAF9</code> <code>D585617F22815F3609CECA397F093D73</code> <code>D2291019D99A8EDDBE68E327B98FA92C</code> <code>E942F3B75F4D034ED3290B56B2D6E8BA</code> <code>8F1DBD401192BE0E3A4103F537CBCBF9</code> <code>30F69E6AC29D8496FD5CF5A7619D6E02</code> <code>498F429BA2D2641F31A84B8FCF31F9FA</code> <code>B3F42884296658A0520CCB4246DDA8D2</code> <code>D10D55DCCA6DA7B3811709FE42604788</code> <code>7DA30AF90CB3E479FCF2CB3F38E5586E</code> <code>E333A83DD4D5E25F57D9A062B59B8ADB</code> <code>7706CF3CABE62CF5EA102857D43A2887</code> <code>79646B5ECAC9215923FD2B0934049431</code> <code>6DF0E0D97BA366D83D227079E48B7C02</code> <code>19AC63FD506F18967900DEC5F15A14D7</code> <code>D4A03E9802A64A3BEFE4FD957C69B6D0</code> <code>2373FDADABAF630DA54784E1AC50C1AA</code> <code>C388E2D513B9BD10647AF4D932335B57</code> <code>F2D8C4E6C355FA026C8C8FCEE20877C9</code> <code>60A42A2901B8BEAD9A3ACB9BA5D388F2</code> <code>82D9292FD37BA4892DA69D3592D2C245</code> <code>0151955245EB896A298D852B3782ECEF</code> <code>9D7DA5FB2A0815F81D72FD53290542AE</code> <code>5777505FB0532C0A8E0A1DD5DBE3B790</code> <code>825A1A8B31900A6A004A7905757B664B</code> <code>69AF22FD7388C639875DBE3517E03A05</code> <code>9FA664C4B3B6A651D6DDDCF8EC170BC1</code> <code>D17B78784A070BED40DE5CF9A94E752A</code> <code>9300EFCD49EF68F7B0CDE0FE8043165D</code> <code>E59ED46D2AEA0A37FA789C9813B0714A</code> <code>96517F63600697AE85A7A0A015F97F8B</code> <code>33576206E75270E6AF35941033EDF13F</code><br> <code>8BE1F068</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = DFF2AB83F318F2D99F8DBCB3CB16C6514308C8D9B2F5BEBDB03B9D3D0B6CD0C6B65A01DDB4C427D201CE8AFC4FAE0737EBB146262F1209AA866EBBFFA7C3802276A41CD566542D5D61CE19AE3DC276C63F9D482471200BA0F84DDAF9D585617F22815F3609CECA397F093D73D2291019D99A8EDDBE68E327B98FA92CE942F3B75F4D034ED3290B56B2D6E8BA8F1DBD401192BE0E3A4103F537CBCBF930F69E6AC29D8496FD5CF5A7619D6E02498F429BA2D2641F31A84B8FCF31F9FAB3F42884296658A0520CCB4246DDA8D2D10D55DCCA6DA7B3811709FE426047887DA30AF90CB3E479FCF2CB3F38E5586EE333A83DD4D5E25F57D9A062B59B8ADB7706CF3CABE62CF5EA102857D43A288779646B5ECAC9215923FD2B09340494316DF0E0D97BA366D83D227079E48B7C0219AC63FD506F18967900DEC5F15A14D7D4A03E9802A64A3BEFE4FD957C69B6D02373FDADABAF630DA54784E1AC50C1AAC388E2D513B9BD10647AF4D932335B57F2D8C4E6C355FA026C8C8FCEE20877C960A42A2901B8BEAD9A3ACB9BA5D388F282D9292FD37BA4892DA69D3592D2C2450151955245EB896A298D852B3782ECEF9D7DA5FB2A0815F81D72FD53290542AE5777505FB0532C0A8E0A1DD5DBE3B790825A1A8B31900A6A004A7905757B664B69AF22FD7388C639875DBE3517E03A059FA664C4B3B6A651D6DDDCF8EC170BC1D17B78784A070BED40DE5CF9A94E752A9300EFCD49EF68F7B0CDE0FE8043165DE59ED46D2AEA0A37FA789C9813B0714A96517F63600697AE85A7A0A015F97F8B33576206E75270E6AF35941033EDF13F8BE1F068
tmp_aes_key = BF8FF67F42007055B61FAE3671FBA3AF607DF251913CF366DE0BA460421C070B
tmp_aes_iv = 2D68123E7ACC27D87F65F78C0E79A4322ADE8167C038837EE3CF90242D36E3CA</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 238E6CEA29AFA41F508619EC043179DB59372EEEBA0D89B51B09A00AD2F02D7E1C096EE6378E25532B286E1E25E47461D30BC42EC98D1FC703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100353086B5320D6D2ADFBBCF3E38188758836182EFF9E322C4ECCDA84589EB39E6AF37FCA53C050EACA31778DA6753B12507D57597073C5150895F0A181D25071D1B0B7D1C7DCDE99DF8069B1E795FA281082E4E16C0D3078C2867D58D8DE4E57122A960366DA5C4CA552FA22F413E8F958F91A7D4AE75D1957D9F5526E592C79EC052ADD1D6FBC2301EB7D3AB7A47C5643B0ACAAB09755AC14878EB0244F01F41A35302AC03619D62FB65E434E8390891C0517B7D3C77FF8016836B9D291BD10F269016F284FDED3A295B5753EFC3A6A79326314425973FD6FBDC464CC310A210AB138E69A987F90425A92C5D5C7BED21DA71ECEF6760656C244815F5455FC95B701DA9660A5EE20EAF966551
answer = BA0D89B51B09A00AD2F02D7E1C096EE6378E25532B286E1E25E47461D30BC42EC98D1FC703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100353086B5320D6D2ADFBBCF3E38188758836182EFF9E322C4ECCDA84589EB39E6AF37FCA53C050EACA31778DA6753B12507D57597073C5150895F0A181D25071D1B0B7D1C7DCDE99DF8069B1E795FA281082E4E16C0D3078C2867D58D8DE4E57122A960366DA5C4CA552FA22F413E8F958F91A7D4AE75D1957D9F5526E592C79EC052ADD1D6FBC2301EB7D3AB7A47C5643B0ACAAB09755AC14878EB0244F01F41A35302AC03619D62FB65E434E8390891C0517B7D3C77FF8016836B9D291BD10F269016F284FDED3A295B5753EFC3A6A79326314425973FD6FBDC464CC310A210AB138E69A987F90425A92C5D5C7BED21DA71ECEF6760656C244815F5455FC95B701DA9660A5EE20EAF966551</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 1B 09 A0 0A D2 F0 2D 7E 1C 09 6E E6
0010 | 37 8E 25 53 2B 28 6E 1E 25 E4 74 61 D3 0B C4 2E
0020 | C9 8D 1F C7 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 35 30 86 B5 32 0D 6D 2A DF BB CF 3E 38 18 87 58
0140 | 83 61 82 EF F9 E3 22 C4 EC CD A8 45 89 EB 39 E6
0150 | AF 37 FC A5 3C 05 0E AC A3 17 78 DA 67 53 B1 25
0160 | 07 D5 75 97 07 3C 51 50 89 5F 0A 18 1D 25 07 1D
0170 | 1B 0B 7D 1C 7D CD E9 9D F8 06 9B 1E 79 5F A2 81
0180 | 08 2E 4E 16 C0 D3 07 8C 28 67 D5 8D 8D E4 E5 71
0190 | 22 A9 60 36 6D A5 C4 CA 55 2F A2 2F 41 3E 8F 95
01A0 | 8F 91 A7 D4 AE 75 D1 95 7D 9F 55 26 E5 92 C7 9E
01B0 | C0 52 AD D1 D6 FB C2 30 1E B7 D3 AB 7A 47 C5 64
01C0 | 3B 0A CA AB 09 75 5A C1 48 78 EB 02 44 F0 1F 41
01D0 | A3 53 02 AC 03 61 9D 62 FB 65 E4 34 E8 39 08 91
01E0 | C0 51 7B 7D 3C 77 FF 80 16 83 6B 9D 29 1B D1 0F
01F0 | 26 90 16 F2 84 FD ED 3A 29 5B 57 53 EF C3 A6 A7
0200 | 93 26 31 44 25 97 3F D6 FB DC 46 4C C3 10 A2 10
0210 | AB 13 8E 69 A9 87 F9 04 25 A9 2C 5D 5C 7B ED 21
0220 | DA 71 EC EF 67 60 65 6C 24 48 15 F5 45 5F C9 5B
0230 | 70 1D A9 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100353086B5320D6D2ADFBBCF3E</code> <code>38188758836182EFF9E322C4ECCDA845</code> <code>89EB39E6AF37FCA53C050EACA31778DA</code> <code>6753B12507D57597073C5150895F0A18</code> <code>1D25071D1B0B7D1C7DCDE99DF8069B1E</code> <code>795FA281082E4E16C0D3078C2867D58D</code> <code>8DE4E57122A960366DA5C4CA552FA22F</code> <code>413E8F958F91A7D4AE75D1957D9F5526</code> <code>E592C79EC052ADD1D6FBC2301EB7D3AB</code> <code>7A47C5643B0ACAAB09755AC14878EB02</code> <code>44F01F41A35302AC03619D62FB65E434</code> <code>E8390891C0517B7D3C77FF8016836B9D</code> <code>291BD10F269016F284FDED3A295B5753</code> <code>EFC3A6A79326314425973FD6FBDC464C</code> <code>C310A210AB138E69A987F90425A92C5D</code> <code>5C7BED21DA71ECEF6760656C244815F5</code><br> <code>455FC95B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>701DA966</code> (1722359152 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = C50B014B940357684175E3F98827022D9D690611C4B50ACEB30167B0BD71C1D0D93B1FB077B0033298D55D269D26BDDA90D21FDAAD2C71387FB9E8E10883147BBDB4BCF1F7218DFFA0FC619578460A108343A174D73DF72294DBCFAB78B657B29B13F503A51D48BBCEEC273B13DA839C8556471D883DC9991931A5CBA9E77A1D2BD493DC097BE3E98E8D634E26E684EFF957D4093E01F8EA80A37FDF9657ECE73C41C9F0D9F47935D22F21C5F3B869A38A4322C2B57CAA4E8564A8DE38A41DAFEAC81DC8B47115EF1CBAA3E32DD36A93FF5D1994B9A060E0A1E2A84766EC1FA266AF4E7F4AE27B8C6D2556D57346CB7D5AB960975EF6EA6BE0DB2BF3095150E9</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 5BB8E71133D532E21ECEC093F121C606EA2703CF4544B34DBFA5ED57D94186BCCBFA1E1E1A0F4681518D21568CBA2A4D5B0650525D662B8D0631D10B697C0BFE71E35E798B925904EDD66EEF684927DDB490CC98CC6ADCC76A75ACCC698EFBDA1BD415D4E9E14B4A570E56DB3964B1C1D86601A3EBBF6F55FC92D7313FD8F9F17EC84386D9D7E2BFA47A318ACC094B4E75D38AAB017423EC8EA025B23FE03B3F4793AFAECB810A35077996BA424368DE5F24CCE33BA8958E86BB56A5F49E0412C02E46F7A39E2C50442CC2A0E46A0F736D04F56175CF52570C8CC661FEEDA2F4EAC223D71B10C7E78C2C7D86B28252F72B29649A488A29E9B0D3ABA238AA2EF7</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 1B 09 A0 0A D2 F0 2D 7E 1C 09 6E E6
0010 | 37 8E 25 53 2B 28 6E 1E 25 E4 74 61 D3 0B C4 2E
0020 | C9 8D 1F C7 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 5B B8 E7 11 33 D5 32 E2 1E CE C0 93 F1 21 C6 06
0040 | EA 27 03 CF 45 44 B3 4D BF A5 ED 57 D9 41 86 BC
0050 | CB FA 1E 1E 1A 0F 46 81 51 8D 21 56 8C BA 2A 4D
0060 | 5B 06 50 52 5D 66 2B 8D 06 31 D1 0B 69 7C 0B FE
0070 | 71 E3 5E 79 8B 92 59 04 ED D6 6E EF 68 49 27 DD
0080 | B4 90 CC 98 CC 6A DC C7 6A 75 AC CC 69 8E FB DA
0090 | 1B D4 15 D4 E9 E1 4B 4A 57 0E 56 DB 39 64 B1 C1
00A0 | D8 66 01 A3 EB BF 6F 55 FC 92 D7 31 3F D8 F9 F1
00B0 | 7E C8 43 86 D9 D7 E2 BF A4 7A 31 8A CC 09 4B 4E
00C0 | 75 D3 8A AB 01 74 23 EC 8E A0 25 B2 3F E0 3B 3F
00D0 | 47 93 AF AE CB 81 0A 35 07 79 96 BA 42 43 68 DE
00E0 | 5F 24 CC E3 3B A8 95 8E 86 BB 56 A5 F4 9E 04 12
00F0 | C0 2E 46 F7 A3 9E 2C 50 44 2C C2 A0 E4 6A 0F 73
0100 | 6D 04 F5 61 75 CF 52 57 0C 8C C6 61 FE ED A2 F4
0110 | EA C2 23 D7 1B 10 C7 E7 8C 2C 7D 86 B2 82 52 F7
0120 | 2B 29 64 9A 48 8A 29 E9 B0 D3 AB A2 38 AA 2E F7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001005BB8E71133D532E21ECEC093</code> <code>F121C606EA2703CF4544B34DBFA5ED57</code> <code>D94186BCCBFA1E1E1A0F4681518D2156</code> <code>8CBA2A4D5B0650525D662B8D0631D10B</code> <code>697C0BFE71E35E798B925904EDD66EEF</code> <code>684927DDB490CC98CC6ADCC76A75ACCC</code> <code>698EFBDA1BD415D4E9E14B4A570E56DB</code> <code>3964B1C1D86601A3EBBF6F55FC92D731</code> <code>3FD8F9F17EC84386D9D7E2BFA47A318A</code> <code>CC094B4E75D38AAB017423EC8EA025B2</code> <code>3FE03B3F4793AFAECB810A35077996BA</code> <code>424368DE5F24CCE33BA8958E86BB56A5</code> <code>F49E0412C02E46F7A39E2C50442CC2A0</code> <code>E46A0F736D04F56175CF52570C8CC661</code> <code>FEEDA2F4EAC223D71B10C7E78C2C7D86</code> <code>B28252F72B29649A488A29E9B0D3ABA2</code><br> <code>38AA2EF7</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643661B09A00AD2F02D7E1C096EE6378E25532B286E1E25E47461D30BC42EC98D1FC70000000000000000FE0001005BB8E71133D532E21ECEC093F121C606EA2703CF4544B34DBFA5ED57D94186BCCBFA1E1E1A0F4681518D21568CBA2A4D5B0650525D662B8D0631D10B697C0BFE71E35E798B925904EDD66EEF684927DDB490CC98CC6ADCC76A75ACCC698EFBDA1BD415D4E9E14B4A570E56DB3964B1C1D86601A3EBBF6F55FC92D7313FD8F9F17EC84386D9D7E2BFA47A318ACC094B4E75D38AAB017423EC8EA025B23FE03B3F4793AFAECB810A35077996BA424368DE5F24CCE33BA8958E86BB56A5F49E0412C02E46F7A39E2C50442CC2A0E46A0F736D04F56175CF52570C8CC661FEEDA2F4EAC223D71B10C7E78C2C7D86B28252F72B29649A488A29E9B0D3ABA238AA2EF7
padding = C114FC8E454401EBFCD3AADA
tmp_aes_key = BF8FF67F42007055B61FAE3671FBA3AF607DF251913CF366DE0BA460421C070B
tmp_aes_iv = 2D68123E7ACC27D87F65F78C0E79A4322ADE8167C038837EE3CF90242D36E3CA</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = A2F0334D96B6EB07B0D1A07AEFD51165EC2EBE8FDA475F17046A2105C68645E86371887BEA1C18BFE96A55866876A70591E66279724CF9CE6FDE5CC7CD01699067D9876055A147517D0CC9B06CC44540D888A978D9264074BC0A5BE53B04516A997851EBFEB6B5ECD5B0E2D1CCB0335E676D55BD41BA7F9FE32C4CE61379132AB8F947815B5C55DEF0EECB24C9A1B0A6D18F0D908FF785EDB3E3FF45C29EA0D5F5CFD4EE13A0B313B7EA578384CD61E09B188B90E126713753693D350E6CA457C346B245B2A255002D8B2C15F910E9BCB914404CB465751E04D24D13B37BA881949F91EC0FE5CB4CC4E5FF47F7ECE36CB31C02414A9392BA4CBC80BEC449CC279DE6F0FBC72E1B3B2F79D607C08F33808401EFC300B75EBAFB004343B15ABA06D3A95740E217C6707EE6F17749970A86803C310A2A6BB2F793FDDC972783351E94FC061F9FBD357C5D55BEAEDFCD236F</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 88 C6 0D 00 70 1D A9 66
0010 | 78 01 00 00 1F 5F 04 F5 1B 09 A0 0A D2 F0 2D 7E
0020 | 1C 09 6E E6 37 8E 25 53 2B 28 6E 1E 25 E4 74 61
0030 | D3 0B C4 2E C9 8D 1F C7 FE 50 01 00 A2 F0 33 4D
0040 | 96 B6 EB 07 B0 D1 A0 7A EF D5 11 65 EC 2E BE 8F
0050 | DA 47 5F 17 04 6A 21 05 C6 86 45 E8 63 71 88 7B
0060 | EA 1C 18 BF E9 6A 55 86 68 76 A7 05 91 E6 62 79
0070 | 72 4C F9 CE 6F DE 5C C7 CD 01 69 90 67 D9 87 60
0080 | 55 A1 47 51 7D 0C C9 B0 6C C4 45 40 D8 88 A9 78
0090 | D9 26 40 74 BC 0A 5B E5 3B 04 51 6A 99 78 51 EB
00A0 | FE B6 B5 EC D5 B0 E2 D1 CC B0 33 5E 67 6D 55 BD
00B0 | 41 BA 7F 9F E3 2C 4C E6 13 79 13 2A B8 F9 47 81
00C0 | 5B 5C 55 DE F0 EE CB 24 C9 A1 B0 A6 D1 8F 0D 90
00D0 | 8F F7 85 ED B3 E3 FF 45 C2 9E A0 D5 F5 CF D4 EE
00E0 | 13 A0 B3 13 B7 EA 57 83 84 CD 61 E0 9B 18 8B 90
00F0 | E1 26 71 37 53 69 3D 35 0E 6C A4 57 C3 46 B2 45
0100 | B2 A2 55 00 2D 8B 2C 15 F9 10 E9 BC B9 14 40 4C
0110 | B4 65 75 1E 04 D2 4D 13 B3 7B A8 81 94 9F 91 EC
0120 | 0F E5 CB 4C C4 E5 FF 47 F7 EC E3 6C B3 1C 02 41
0130 | 4A 93 92 BA 4C BC 80 BE C4 49 CC 27 9D E6 F0 FB
0140 | C7 2E 1B 3B 2F 79 D6 07 C0 8F 33 80 84 01 EF C3
0150 | 00 B7 5E BA FB 00 43 43 B1 5A BA 06 D3 A9 57 40
0160 | E2 17 C6 70 7E E6 F1 77 49 97 0A 86 80 3C 31 0A
0170 | 2A 6B B2 F7 93 FD DC 97 27 83 35 1E 94 FC 06 1F
0180 | 9F BD 35 7C 5D 55 BE AE DF CD 23 6F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>88C60D00701DA966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100A2F0334D96B6EB07B0D1A07A</code> <code>EFD51165EC2EBE8FDA475F17046A2105</code> <code>C68645E86371887BEA1C18BFE96A5586</code> <code>6876A70591E66279724CF9CE6FDE5CC7</code> <code>CD01699067D9876055A147517D0CC9B0</code> <code>6CC44540D888A978D9264074BC0A5BE5</code> <code>3B04516A997851EBFEB6B5ECD5B0E2D1</code> <code>CCB0335E676D55BD41BA7F9FE32C4CE6</code> <code>1379132AB8F947815B5C55DEF0EECB24</code> <code>C9A1B0A6D18F0D908FF785EDB3E3FF45</code> <code>C29EA0D5F5CFD4EE13A0B313B7EA5783</code> <code>84CD61E09B188B90E126713753693D35</code> <code>0E6CA457C346B245B2A255002D8B2C15</code> <code>F910E9BCB914404CB465751E04D24D13</code> <code>B37BA881949F91EC0FE5CB4CC4E5FF47</code> <code>F7ECE36CB31C02414A9392BA4CBC80BE</code> <code>C449CC279DE6F0FBC72E1B3B2F79D607</code> <code>C08F33808401EFC300B75EBAFB004343</code> <code>B15ABA06D3A95740E217C6707EE6F177</code> <code>49970A86803C310A2A6BB2F793FDDC97</code> <code>2783351E94FC061F9FBD357C5D55BEAE</code><br> <code>DFCD236F</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 16E17B2AA4A9AAB6B77E454D361E99A2DC0AC6DFFBD620DA1997D8D651F7C18297701846F1FD26601E99F62E5A4ED9996FA00BDBDB5D6EB39DDBBEA44F234B9A00D019775DEDB3782CF5D1A89E5543DAC0F7777AD1D5BD63ADA28D664BF4CECA35A671A9856FEC06D1641A3F9A0BA8B0D40B6644A5E9C9168D91DE902AE52D035EA3732BF25154B7E5BB08F658C96A0593A52CCEBB80C10CD2981E2303F1B29A9600688BB7D12E0BCAE3E1641CD6760DB5D3285FF5B4324A9E52854409A68E7841156A2410E951431D24C52F4D38F51ABF9BAF58A739AAB1657846AB859584C528A5349B103D35B99AC21550DC4A78AAAE071EEFEF77559A0867053905DF040D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 3C DB 7D 71 1D A9 66
0010 | 58 00 00 00 34 F7 CB 3B 1B 09 A0 0A D2 F0 2D 7E
0020 | 1C 09 6E E6 37 8E 25 53 2B 28 6E 1E 25 E4 74 61
0030 | D3 0B C4 2E C9 8D 1F C7 C2 D0 77 13 D0 60 18 08
0040 | 8E DA 4B 41 66 B7 1C 8C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013CDB7D711DA966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1B09A00AD2F02D7E1C096EE6378E2553</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2B286E1E25E47461D30BC42EC98D1FC7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>C2D07713D06018088EDA4B4166B71C8C</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

