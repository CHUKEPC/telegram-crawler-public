<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 84 1C 00 00 26 88 A2 66
0010 | 14 00 00 00 F1 8E 7E BE D5 49 52 34 D2 F9 4E 3F
0020 | 02 4B DF 6D EF 52 10 8B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>841C00002688A266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 99 F1 26 88 A2 66
0010 | 74 00 00 00 63 24 16 05 D5 49 52 34 D2 F9 4E 3F
0020 | 02 4B DF 6D EF 52 10 8B 91 CE 65 C0 BC 19 5D 9A
0030 | 0A 3F 41 56 AA 51 1B AA 08 1B 71 02 1F 03 9C 33
0040 | F3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E099F12688A266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>74000000</code> (116 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081B71021F039C33F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1977364043620168691</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1977364043620168691</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1977364043620168691 = 1338204457 * 1477624763</code></p>
<pre><code>p = 1338204457
q = 1477624763</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1B 71 02 1F 03 9C 33 F3 00 00 00
0010 | 04 4F C3 61 29 00 00 00 04 58 12 C3 BB 00 00 00
0020 | D5 49 52 34 D2 F9 4E 3F 02 4B DF 6D EF 52 10 8B
0030 | 91 CE 65 C0 BC 19 5D 9A 0A 3F 41 56 AA 51 1B AA
0040 | 86 09 1F 3A 8D 38 47 DB DB 88 DF 4E 68 8A 57 06
0050 | 9C 1B 45 4B C6 A3 D7 BC 43 7E F7 8C 9C A1 B2 5B
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081B71021F039C33F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1977364043620168691</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044FC36129000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1338204457</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045812C3BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1477624763</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>86091F3A8D3847DBDB88DF4E688A5706</code> <code>9C1B454BC6A3D7BC437EF78C9CA1B25B</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081B71021F039C33F3000000044FC36129000000045812C3BB000000D5495234D2F94E3F024BDF6DEF52108B91CE65C0BC195D9A0A3F4156AA511BAA86091F3A8D3847DBDB88DF4E688A57069C1B454BC6A3D7BC437EF78C9CA1B25B02000000
random_padding_bytes = 75C88EFAEDE3F11885EF451A697D383137C41695B2B77E8D03109FC3607BF3AC49009C087970240A4B436675CCEB8941EEFA4C187A269A96F088718A0AB909D9B63103C513CB51894B67E5A1E36B0FDEAB53F1187833FF2E5B73126A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 81D68F713065B63EACA49E0BBC3E7283B247D50BC53A08D8B020CAE60C5141EB9A103F354288EA611E758F20614D3588CA43F2376711C34A339C7597002E13AA81CDEE14A65761258EE967096CB77249915C4B45DEC98C607EDB65659E22A672DDBE4BB7F03CCEDA6DC5E56A28C93AD4380B24ECDD0D117982D447DE54F48B28F4F1A7B3A792060A4CE543B8A526653BBD140BB533F50462D912749BC7638CB27ED4652CDD03CC63D40D2DBC451B1E3389431BE046D5D765E694D8A36B5D6D56318EAF229A24567AD08CE7B77B333C6563012580E4E95AC0A574BA9D10D3A4EE94177BD0DFFA842823692B8E9ED43C4977D32EEB1653516EB28C2F2A195F1614</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C A4 01 00 27 88 A2 66
0010 | 40 01 00 00 BE E4 12 D7 D5 49 52 34 D2 F9 4E 3F
0020 | 02 4B DF 6D EF 52 10 8B 91 CE 65 C0 BC 19 5D 9A
0030 | 0A 3F 41 56 AA 51 1B AA 04 4F C3 61 29 00 00 00
0040 | 04 58 12 C3 BB 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 81 D6 8F 71 30 65 B6 3E AC A4 9E 0B
0060 | BC 3E 72 83 B2 47 D5 0B C5 3A 08 D8 B0 20 CA E6
0070 | 0C 51 41 EB 9A 10 3F 35 42 88 EA 61 1E 75 8F 20
0080 | 61 4D 35 88 CA 43 F2 37 67 11 C3 4A 33 9C 75 97
0090 | 00 2E 13 AA 81 CD EE 14 A6 57 61 25 8E E9 67 09
00A0 | 6C B7 72 49 91 5C 4B 45 DE C9 8C 60 7E DB 65 65
00B0 | 9E 22 A6 72 DD BE 4B B7 F0 3C CE DA 6D C5 E5 6A
00C0 | 28 C9 3A D4 38 0B 24 EC DD 0D 11 79 82 D4 47 DE
00D0 | 54 F4 8B 28 F4 F1 A7 B3 A7 92 06 0A 4C E5 43 B8
00E0 | A5 26 65 3B BD 14 0B B5 33 F5 04 62 D9 12 74 9B
00F0 | C7 63 8C B2 7E D4 65 2C DD 03 CC 63 D4 0D 2D BC
0100 | 45 1B 1E 33 89 43 1B E0 46 D5 D7 65 E6 94 D8 A3
0110 | 6B 5D 6D 56 31 8E AF 22 9A 24 56 7A D0 8C E7 B7
0120 | 7B 33 3C 65 63 01 25 80 E4 E9 5A C0 A5 74 BA 9D
0130 | 10 D3 A4 EE 94 17 7B D0 DF FA 84 28 23 69 2B 8E
0140 | 9E D4 3C 49 77 D3 2E EB 16 53 51 6E B2 8C 2F 2A
0150 | 19 5F 16 14</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7CA401002788A266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044FC36129000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1338204457</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045812C3BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1477624763</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010081D68F713065B63EACA49E0B</code> <code>BC3E7283B247D50BC53A08D8B020CAE6</code> <code>0C5141EB9A103F354288EA611E758F20</code> <code>614D3588CA43F2376711C34A339C7597</code> <code>002E13AA81CDEE14A65761258EE96709</code> <code>6CB77249915C4B45DEC98C607EDB6565</code> <code>9E22A672DDBE4BB7F03CCEDA6DC5E56A</code> <code>28C93AD4380B24ECDD0D117982D447DE</code> <code>54F48B28F4F1A7B3A792060A4CE543B8</code> <code>A526653BBD140BB533F50462D912749B</code> <code>C7638CB27ED4652CDD03CC63D40D2DBC</code> <code>451B1E3389431BE046D5D765E694D8A3</code> <code>6B5D6D56318EAF229A24567AD08CE7B7</code> <code>7B333C6563012580E4E95AC0A574BA9D</code> <code>10D3A4EE94177BD0DFFA842823692B8E</code> <code>9ED43C4977D32EEB1653516EB28C2F2A</code><br> <code>195F1614</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 4D C9 27 88 A2 66
0010 | 78 02 00 00 5C 07 E8 D0 D5 49 52 34 D2 F9 4E 3F
0020 | 02 4B DF 6D EF 52 10 8B 91 CE 65 C0 BC 19 5D 9A
0030 | 0A 3F 41 56 AA 51 1B AA FE 50 02 00 26 43 49 06
0040 | CC A6 F9 0D 1A 09 DE 80 57 5A 51 EE F2 5D B1 D9
0050 | 04 C5 77 B7 5E CA 4A B1 23 EE 99 BD 87 3D 1B C5
0060 | 09 39 02 2C 69 BD D9 21 4E 78 D0 DE 5B B5 9F DB
0070 | 62 1F 47 ED B1 F2 7E 66 08 CA 7D EB 59 17 27 97
0080 | AE 7A 6C 3F 9B 18 D2 CA 10 96 29 51 86 09 E5 74
0090 | E1 2A 8A 7A 9E BB 22 E0 71 61 01 D7 E7 CB 61 C1
00A0 | 4E C5 65 81 C8 96 13 C2 F8 68 CE BC 36 45 11 BB
00B0 | 86 AB AB 29 12 D5 61 F9 D9 39 4C EA D7 28 EE 33
00C0 | 13 85 89 5C EF 5D B4 93 A2 72 E8 20 67 53 AF 7F
00D0 | 8E EF CB 04 C5 B8 DA 52 98 E5 21 02 D8 8F 94 08
00E0 | 9F 9A F2 8E 0A A1 36 83 8F 95 00 DD FC 28 3A FB
00F0 | 34 45 E3 60 40 53 33 08 F7 63 A1 71 1C 0B E9 C0
0100 | DE 87 A1 E3 32 99 7E D9 FC 8D 4F DC 11 41 CB C4
0110 | 28 CC 91 9A 6A B9 CE FD 53 8A AA 0C 62 99 EC 3D
0120 | F7 67 C9 7E 6E 5F 06 30 18 08 DE C8 60 BA F0 53
0130 | 24 D8 2D D8 8F 00 A9 3C BC 65 67 FD B8 67 23 99
0140 | ED F5 EE B2 6E 5B CF 24 A5 1C DE 67 F6 3D 43 4F
0150 | 68 52 65 FA 4D BB D7 BB 93 9D DF 66 31 10 B3 A9
0160 | CB 29 BA CD 39 33 04 C7 BE 6D A0 53 7F 9E ED 7F
0170 | F8 54 82 0C 8B A2 48 6E 32 97 30 F5 F1 F5 03 F0
0180 | EB 5F FD 8E AC 39 86 8D 08 F8 9A 74 A6 44 21 7F
0190 | C5 B3 98 54 3D 35 14 B2 F3 01 FA B1 BC 7C B6 0A
01A0 | 60 A3 EA F7 99 2D D1 69 AA CC BE 34 B1 0A 62 AB
01B0 | A0 9C 67 17 DA A9 AF 8D 91 21 10 31 12 09 F4 8F
01C0 | A6 1B 74 BC D5 23 F0 9C C7 85 1A 02 4C 8E A8 41
01D0 | E3 EB 37 DB 14 3D 5E C8 2C 82 67 26 CA 1B AD 0A
01E0 | 8A B4 C8 E9 C4 CB 63 4B 24 9D E8 B6 C1 E9 90 9C
01F0 | B4 8B C6 1A 65 6D 5A 5A 08 52 4D 3C 95 BB FE 86
0200 | 31 2C 50 3A 53 FA 7D 75 5D 67 52 1C 45 FB 81 69
0210 | B6 B5 F2 AE 57 F2 04 26 F5 75 B2 7C E1 82 00 3E
0220 | FA 8F EE AF 88 D2 8B 3D 80 2D 17 F4 9A C5 85 16
0230 | 5F 89 99 7D 04 86 F9 68 85 DA AE FE A1 3A CF 9F
0240 | 25 5F 15 1D 9F FA C3 6A 0D D2 85 4A 36 3F 43 20
0250 | 35 4F 12 E3 CE 11 66 51 F0 41 3E 85 14 27 87 FA
0260 | C5 32 3F 9C 83 5A CF 98 94 0D 9E E0 A0 2B F4 2F
0270 | 88 26 77 26 A9 33 52 42 15 23 C6 F4 A8 0F BA 96
0280 | BE 84 7F 84 11 FE 44 62 7C A4 62 49</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B44DC92788A266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020026434906CCA6F90D1A09DE80</code> <code>575A51EEF25DB1D904C577B75ECA4AB1</code> <code>23EE99BD873D1BC50939022C69BDD921</code> <code>4E78D0DE5BB59FDB621F47EDB1F27E66</code> <code>08CA7DEB59172797AE7A6C3F9B18D2CA</code> <code>109629518609E574E12A8A7A9EBB22E0</code> <code>716101D7E7CB61C14EC56581C89613C2</code> <code>F868CEBC364511BB86ABAB2912D561F9</code> <code>D9394CEAD728EE331385895CEF5DB493</code> <code>A272E8206753AF7F8EEFCB04C5B8DA52</code> <code>98E52102D88F94089F9AF28E0AA13683</code> <code>8F9500DDFC283AFB3445E36040533308</code> <code>F763A1711C0BE9C0DE87A1E332997ED9</code> <code>FC8D4FDC1141CBC428CC919A6AB9CEFD</code> <code>538AAA0C6299EC3DF767C97E6E5F0630</code> <code>1808DEC860BAF05324D82DD88F00A93C</code> <code>BC6567FDB8672399EDF5EEB26E5BCF24</code> <code>A51CDE67F63D434F685265FA4DBBD7BB</code> <code>939DDF663110B3A9CB29BACD393304C7</code> <code>BE6DA0537F9EED7FF854820C8BA2486E</code> <code>329730F5F1F503F0EB5FFD8EAC39868D</code> <code>08F89A74A644217FC5B398543D3514B2</code> <code>F301FAB1BC7CB60A60A3EAF7992DD169</code> <code>AACCBE34B10A62ABA09C6717DAA9AF8D</code> <code>912110311209F48FA61B74BCD523F09C</code> <code>C7851A024C8EA841E3EB37DB143D5EC8</code> <code>2C826726CA1BAD0A8AB4C8E9C4CB634B</code> <code>249DE8B6C1E9909CB48BC61A656D5A5A</code> <code>08524D3C95BBFE86312C503A53FA7D75</code> <code>5D67521C45FB8169B6B5F2AE57F20426</code> <code>F575B27CE182003EFA8FEEAF88D28B3D</code> <code>802D17F49AC585165F89997D0486F968</code> <code>85DAAEFEA13ACF9F255F151D9FFAC36A</code> <code>0DD2854A363F4320354F12E3CE116651</code> <code>F0413E85142787FAC5323F9C835ACF98</code> <code>940D9EE0A02BF42F88267726A9335242</code> <code>1523C6F4A80FBA96BE847F8411FE4462</code><br> <code>7CA46249</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 26434906CCA6F90D1A09DE80575A51EEF25DB1D904C577B75ECA4AB123EE99BD873D1BC50939022C69BDD9214E78D0DE5BB59FDB621F47EDB1F27E6608CA7DEB59172797AE7A6C3F9B18D2CA109629518609E574E12A8A7A9EBB22E0716101D7E7CB61C14EC56581C89613C2F868CEBC364511BB86ABAB2912D561F9D9394CEAD728EE331385895CEF5DB493A272E8206753AF7F8EEFCB04C5B8DA5298E52102D88F94089F9AF28E0AA136838F9500DDFC283AFB3445E36040533308F763A1711C0BE9C0DE87A1E332997ED9FC8D4FDC1141CBC428CC919A6AB9CEFD538AAA0C6299EC3DF767C97E6E5F06301808DEC860BAF05324D82DD88F00A93CBC6567FDB8672399EDF5EEB26E5BCF24A51CDE67F63D434F685265FA4DBBD7BB939DDF663110B3A9CB29BACD393304C7BE6DA0537F9EED7FF854820C8BA2486E329730F5F1F503F0EB5FFD8EAC39868D08F89A74A644217FC5B398543D3514B2F301FAB1BC7CB60A60A3EAF7992DD169AACCBE34B10A62ABA09C6717DAA9AF8D912110311209F48FA61B74BCD523F09CC7851A024C8EA841E3EB37DB143D5EC82C826726CA1BAD0A8AB4C8E9C4CB634B249DE8B6C1E9909CB48BC61A656D5A5A08524D3C95BBFE86312C503A53FA7D755D67521C45FB8169B6B5F2AE57F20426F575B27CE182003EFA8FEEAF88D28B3D802D17F49AC585165F89997D0486F96885DAAEFEA13ACF9F255F151D9FFAC36A0DD2854A363F4320354F12E3CE116651F0413E85142787FAC5323F9C835ACF98940D9EE0A02BF42F88267726A93352421523C6F4A80FBA96BE847F8411FE44627CA46249
tmp_aes_key = D3922C50D6EF99ADFD87C8BDDFFD4CDA1C3D6316A316CF3C8DBD1F46DF79D162
tmp_aes_iv = F80B1F841E55718E97B0730CBC1A88C5686A4CA91926680348AD74FB86091F3A</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 748D7299A8A39DD2AEE663D6151A94EC7C49892BBA0D89B5D5495234D2F94E3F024BDF6DEF52108B91CE65C0BC195D9A0A3F4156AA511BAA03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010067409202B2D24664CA1A3CFF2EA1C56C8B428EA8AFE9552870366AE99142CEA27F6E013DA6CE86221FFA5B56716A8DD955058F30CC63A3C225987203EF629DF95B69DD7E363E9B8E7431930CAAFC15BE11880E8DFA81CD4074532E0E634D7D2D127ECDABF432DE36640767A6AFD010B092632EA434A4A05ABAA388E7BA52BC5BFC85A8500216671EE3CA7398A3EC208176CDA3D8A17C2F4A8E7352CFDD4DC6C5025EC6A9453DEF5715322AA589E506154074994C724E922ECE1B7907BF3DD95FE5DC069BFE72E791A1E8E4D4F5CB38F79C5E619ACA32F49D49B26FDF656085037803BED1DAF2EC623AEF9867BB78DEB94ACC676D402EA0141915AE293E50ED3B2788A266314D36040518DBAC
answer = BA0D89B5D5495234D2F94E3F024BDF6DEF52108B91CE65C0BC195D9A0A3F4156AA511BAA03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010067409202B2D24664CA1A3CFF2EA1C56C8B428EA8AFE9552870366AE99142CEA27F6E013DA6CE86221FFA5B56716A8DD955058F30CC63A3C225987203EF629DF95B69DD7E363E9B8E7431930CAAFC15BE11880E8DFA81CD4074532E0E634D7D2D127ECDABF432DE36640767A6AFD010B092632EA434A4A05ABAA388E7BA52BC5BFC85A8500216671EE3CA7398A3EC208176CDA3D8A17C2F4A8E7352CFDD4DC6C5025EC6A9453DEF5715322AA589E506154074994C724E922ECE1B7907BF3DD95FE5DC069BFE72E791A1E8E4D4F5CB38F79C5E619ACA32F49D49B26FDF656085037803BED1DAF2EC623AEF9867BB78DEB94ACC676D402EA0141915AE293E50ED3B2788A266314D36040518DBAC</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 D5 49 52 34 D2 F9 4E 3F 02 4B DF 6D
0010 | EF 52 10 8B 91 CE 65 C0 BC 19 5D 9A 0A 3F 41 56
0020 | AA 51 1B AA 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 67 40 92 02 B2 D2 46 64 CA 1A 3C FF 2E A1 C5 6C
0140 | 8B 42 8E A8 AF E9 55 28 70 36 6A E9 91 42 CE A2
0150 | 7F 6E 01 3D A6 CE 86 22 1F FA 5B 56 71 6A 8D D9
0160 | 55 05 8F 30 CC 63 A3 C2 25 98 72 03 EF 62 9D F9
0170 | 5B 69 DD 7E 36 3E 9B 8E 74 31 93 0C AA FC 15 BE
0180 | 11 88 0E 8D FA 81 CD 40 74 53 2E 0E 63 4D 7D 2D
0190 | 12 7E CD AB F4 32 DE 36 64 07 67 A6 AF D0 10 B0
01A0 | 92 63 2E A4 34 A4 A0 5A BA A3 88 E7 BA 52 BC 5B
01B0 | FC 85 A8 50 02 16 67 1E E3 CA 73 98 A3 EC 20 81
01C0 | 76 CD A3 D8 A1 7C 2F 4A 8E 73 52 CF DD 4D C6 C5
01D0 | 02 5E C6 A9 45 3D EF 57 15 32 2A A5 89 E5 06 15
01E0 | 40 74 99 4C 72 4E 92 2E CE 1B 79 07 BF 3D D9 5F
01F0 | E5 DC 06 9B FE 72 E7 91 A1 E8 E4 D4 F5 CB 38 F7
0200 | 9C 5E 61 9A CA 32 F4 9D 49 B2 6F DF 65 60 85 03
0210 | 78 03 BE D1 DA F2 EC 62 3A EF 98 67 BB 78 DE B9
0220 | 4A CC 67 6D 40 2E A0 14 19 15 AE 29 3E 50 ED 3B
0230 | 27 88 A2 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010067409202B2D24664CA1A3CFF</code> <code>2EA1C56C8B428EA8AFE9552870366AE9</code> <code>9142CEA27F6E013DA6CE86221FFA5B56</code> <code>716A8DD955058F30CC63A3C225987203</code> <code>EF629DF95B69DD7E363E9B8E7431930C</code> <code>AAFC15BE11880E8DFA81CD4074532E0E</code> <code>634D7D2D127ECDABF432DE36640767A6</code> <code>AFD010B092632EA434A4A05ABAA388E7</code> <code>BA52BC5BFC85A8500216671EE3CA7398</code> <code>A3EC208176CDA3D8A17C2F4A8E7352CF</code> <code>DD4DC6C5025EC6A9453DEF5715322AA5</code> <code>89E506154074994C724E922ECE1B7907</code> <code>BF3DD95FE5DC069BFE72E791A1E8E4D4</code> <code>F5CB38F79C5E619ACA32F49D49B26FDF</code> <code>656085037803BED1DAF2EC623AEF9867</code> <code>BB78DEB94ACC676D402EA0141915AE29</code><br> <code>3E50ED3B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>2788A266</code> (1721927719 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 4FC6E364722AF1B09F0E67F99417FB9D01696C9964E96D5E005AFCA193FEE6AF3244493557F7398FF0603F8A9F0B5085038D0CB19137C1A818E37B6F24D581B35D28A7E87111849E65A304603596E01D0146C675CB6F27C2A593DF773DCACF13EB0CAB93BE44EBBB539B2F761057E36747D452AB9AFF3ECCEB848B9F6733A9E6FDCB8058208FC0FCB60375705B92659E49D3ECBE42B0E6CD4A2F94740B0186DEE9AF5D3A66F51FB606D423D7F75C7596657006EB0A6670F64EA7AA38310F0F59B49C88064356DF9D9D9D4A914BEABCB7CDDCA9BAE4919F8C5AED04AC552C8B5D6D56F66B80BD9F0E5ECE70F2AEF7C72007BBD0812908D2760E1DDEEA11742B3F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 35FE84F9813D7991C97A1C570369C1F36D02218D03A985DED79734FCB3FD8C28642D964DDA0BAB0933F0862F4E26B5608DF1534866A5D0D7B8846E4EAC4187E4147DD750FE6837DE38F8C20F5BC68BDD6F33D992C738BF10A07799F8E56133633B23B2623632872D3880587AD5F56237F4A9A6BF6F572A766DDF64082B3A154B4FA3E28EB5BE5551B43481C200FE2C7C0E725659637613D29059B279DFB2BCA34B51598FA8D5D1AD8A7B19F466A187D237D18AE476300D8AF5274BDFAC17EDC89A62C0E76D7D96E3B7AE6311221371E701E8D1F775985BD58D8F93B06112DE2F77136FC35C299594F1E0226E1464CC4C9F2E598E6E617C6A69BBD14B9DC1F9C6</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 D5 49 52 34 D2 F9 4E 3F 02 4B DF 6D
0010 | EF 52 10 8B 91 CE 65 C0 BC 19 5D 9A 0A 3F 41 56
0020 | AA 51 1B AA 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 35 FE 84 F9 81 3D 79 91 C9 7A 1C 57 03 69 C1 F3
0040 | 6D 02 21 8D 03 A9 85 DE D7 97 34 FC B3 FD 8C 28
0050 | 64 2D 96 4D DA 0B AB 09 33 F0 86 2F 4E 26 B5 60
0060 | 8D F1 53 48 66 A5 D0 D7 B8 84 6E 4E AC 41 87 E4
0070 | 14 7D D7 50 FE 68 37 DE 38 F8 C2 0F 5B C6 8B DD
0080 | 6F 33 D9 92 C7 38 BF 10 A0 77 99 F8 E5 61 33 63
0090 | 3B 23 B2 62 36 32 87 2D 38 80 58 7A D5 F5 62 37
00A0 | F4 A9 A6 BF 6F 57 2A 76 6D DF 64 08 2B 3A 15 4B
00B0 | 4F A3 E2 8E B5 BE 55 51 B4 34 81 C2 00 FE 2C 7C
00C0 | 0E 72 56 59 63 76 13 D2 90 59 B2 79 DF B2 BC A3
00D0 | 4B 51 59 8F A8 D5 D1 AD 8A 7B 19 F4 66 A1 87 D2
00E0 | 37 D1 8A E4 76 30 0D 8A F5 27 4B DF AC 17 ED C8
00F0 | 9A 62 C0 E7 6D 7D 96 E3 B7 AE 63 11 22 13 71 E7
0100 | 01 E8 D1 F7 75 98 5B D5 8D 8F 93 B0 61 12 DE 2F
0110 | 77 13 6F C3 5C 29 95 94 F1 E0 22 6E 14 64 CC 4C
0120 | 9F 2E 59 8E 6E 61 7C 6A 69 BB D1 4B 9D C1 F9 C6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010035FE84F9813D7991C97A1C57</code> <code>0369C1F36D02218D03A985DED79734FC</code> <code>B3FD8C28642D964DDA0BAB0933F0862F</code> <code>4E26B5608DF1534866A5D0D7B8846E4E</code> <code>AC4187E4147DD750FE6837DE38F8C20F</code> <code>5BC68BDD6F33D992C738BF10A07799F8</code> <code>E56133633B23B2623632872D3880587A</code> <code>D5F56237F4A9A6BF6F572A766DDF6408</code> <code>2B3A154B4FA3E28EB5BE5551B43481C2</code> <code>00FE2C7C0E725659637613D29059B279</code> <code>DFB2BCA34B51598FA8D5D1AD8A7B19F4</code> <code>66A187D237D18AE476300D8AF5274BDF</code> <code>AC17EDC89A62C0E76D7D96E3B7AE6311</code> <code>221371E701E8D1F775985BD58D8F93B0</code> <code>6112DE2F77136FC35C299594F1E0226E</code> <code>1464CC4C9F2E598E6E617C6A69BBD14B</code><br> <code>9DC1F9C6</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366D5495234D2F94E3F024BDF6DEF52108B91CE65C0BC195D9A0A3F4156AA511BAA0000000000000000FE00010035FE84F9813D7991C97A1C570369C1F36D02218D03A985DED79734FCB3FD8C28642D964DDA0BAB0933F0862F4E26B5608DF1534866A5D0D7B8846E4EAC4187E4147DD750FE6837DE38F8C20F5BC68BDD6F33D992C738BF10A07799F8E56133633B23B2623632872D3880587AD5F56237F4A9A6BF6F572A766DDF64082B3A154B4FA3E28EB5BE5551B43481C200FE2C7C0E725659637613D29059B279DFB2BCA34B51598FA8D5D1AD8A7B19F466A187D237D18AE476300D8AF5274BDFAC17EDC89A62C0E76D7D96E3B7AE6311221371E701E8D1F775985BD58D8F93B06112DE2F77136FC35C299594F1E0226E1464CC4C9F2E598E6E617C6A69BBD14B9DC1F9C6
padding = E0DE2B81437D0447A05DFE05
tmp_aes_key = D3922C50D6EF99ADFD87C8BDDFFD4CDA1C3D6316A316CF3C8DBD1F46DF79D162
tmp_aes_iv = F80B1F841E55718E97B0730CBC1A88C5686A4CA91926680348AD74FB86091F3A</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = EE128F62F0C4E93570510E0F0D896213D3CC0FA48AC4E4250C145F2B5F4E79EE574E3105DAFA646DEA4E7DCEAA2CB4CB29CD09A606E3E61E1C07D13EF6415331F0681A10307B2022A751BD2A0EAF278B7E65707F7B6525A0ED7F7C9982763CB580D3EC10967017ABC2FEEE438E85E1F39AD4EC26E7CCD5D0BC3A8F541C8F58D399507E810C6605EAD3F19F6BD7F4D058EC85796EC4F3EC4B1A859983A3CD3ABC8D8BFFE78439F4176B6F6BF611696ED41378235A6BCF5BDED89A145A3AB54C6D6BCA7CC20DBF11D12D0AA36992E36C281B5D45B70C36E0CB672DB63631B948AA58DFC0CDDF27BBFF33836319044266B10A73678B1BC5660BD2D913A60B4FF50EFADD220F934EA70E7A64BF115D7F955D4DE8FE668291E57751FE5EA9942D7611A9800D55D0743000337D32EBD658F20F1141DA206FD8018003F1A344F5B7EA8C6B108A993D9613BADC4B97B9B49FE4FD</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 79 09 00 27 88 A2 66
0010 | 78 01 00 00 1F 5F 04 F5 D5 49 52 34 D2 F9 4E 3F
0020 | 02 4B DF 6D EF 52 10 8B 91 CE 65 C0 BC 19 5D 9A
0030 | 0A 3F 41 56 AA 51 1B AA FE 50 01 00 EE 12 8F 62
0040 | F0 C4 E9 35 70 51 0E 0F 0D 89 62 13 D3 CC 0F A4
0050 | 8A C4 E4 25 0C 14 5F 2B 5F 4E 79 EE 57 4E 31 05
0060 | DA FA 64 6D EA 4E 7D CE AA 2C B4 CB 29 CD 09 A6
0070 | 06 E3 E6 1E 1C 07 D1 3E F6 41 53 31 F0 68 1A 10
0080 | 30 7B 20 22 A7 51 BD 2A 0E AF 27 8B 7E 65 70 7F
0090 | 7B 65 25 A0 ED 7F 7C 99 82 76 3C B5 80 D3 EC 10
00A0 | 96 70 17 AB C2 FE EE 43 8E 85 E1 F3 9A D4 EC 26
00B0 | E7 CC D5 D0 BC 3A 8F 54 1C 8F 58 D3 99 50 7E 81
00C0 | 0C 66 05 EA D3 F1 9F 6B D7 F4 D0 58 EC 85 79 6E
00D0 | C4 F3 EC 4B 1A 85 99 83 A3 CD 3A BC 8D 8B FF E7
00E0 | 84 39 F4 17 6B 6F 6B F6 11 69 6E D4 13 78 23 5A
00F0 | 6B CF 5B DE D8 9A 14 5A 3A B5 4C 6D 6B CA 7C C2
0100 | 0D BF 11 D1 2D 0A A3 69 92 E3 6C 28 1B 5D 45 B7
0110 | 0C 36 E0 CB 67 2D B6 36 31 B9 48 AA 58 DF C0 CD
0120 | DF 27 BB FF 33 83 63 19 04 42 66 B1 0A 73 67 8B
0130 | 1B C5 66 0B D2 D9 13 A6 0B 4F F5 0E FA DD 22 0F
0140 | 93 4E A7 0E 7A 64 BF 11 5D 7F 95 5D 4D E8 FE 66
0150 | 82 91 E5 77 51 FE 5E A9 94 2D 76 11 A9 80 0D 55
0160 | D0 74 30 00 33 7D 32 EB D6 58 F2 0F 11 41 DA 20
0170 | 6F D8 01 80 03 F1 A3 44 F5 B7 EA 8C 6B 10 8A 99
0180 | 3D 96 13 BA DC 4B 97 B9 B4 9F E4 FD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>447909002788A266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100EE128F62F0C4E93570510E0F</code> <code>0D896213D3CC0FA48AC4E4250C145F2B</code> <code>5F4E79EE574E3105DAFA646DEA4E7DCE</code> <code>AA2CB4CB29CD09A606E3E61E1C07D13E</code> <code>F6415331F0681A10307B2022A751BD2A</code> <code>0EAF278B7E65707F7B6525A0ED7F7C99</code> <code>82763CB580D3EC10967017ABC2FEEE43</code> <code>8E85E1F39AD4EC26E7CCD5D0BC3A8F54</code> <code>1C8F58D399507E810C6605EAD3F19F6B</code> <code>D7F4D058EC85796EC4F3EC4B1A859983</code> <code>A3CD3ABC8D8BFFE78439F4176B6F6BF6</code> <code>11696ED41378235A6BCF5BDED89A145A</code> <code>3AB54C6D6BCA7CC20DBF11D12D0AA369</code> <code>92E36C281B5D45B70C36E0CB672DB636</code> <code>31B948AA58DFC0CDDF27BBFF33836319</code> <code>044266B10A73678B1BC5660BD2D913A6</code> <code>0B4FF50EFADD220F934EA70E7A64BF11</code> <code>5D7F955D4DE8FE668291E57751FE5EA9</code> <code>942D7611A9800D55D0743000337D32EB</code> <code>D658F20F1141DA206FD8018003F1A344</code> <code>F5B7EA8C6B108A993D9613BADC4B97B9</code><br> <code>B49FE4FD</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 4E9D7310E7DD44DC1811D9843D91C8D73B77CC8E3670787FFFFC330929B0F94033B71364C7DAC87250FCF63429DBA44334639B457CA99F84CBEB3F3E8D9E0EFA458009B0510540C9AA18BC71CEAF7726912F7C334C246BFD5CF63EFCC282F286E532A866CA08CBBCBF484B260769627187A5524B3843F9B2E14009565AFC8282F507822121349062019E3804C3DE38AA6507CA4E6AA3CC2B7739B76215B9805C7F70DB4F9C8B558B15AEB1168280F17B03823DDB0B9357D172C3D896EE46080CF38DC75636B5033A479315DA2F9DB1F968EB82CE646A6A39BF8AA880595E879C0BD447B3BB368241033C7FD443F57C7046ABDD68683D7CDDC0667DFE06D247E8</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 40 4B A0 28 88 A2 66
0010 | 64 00 00 00 34 F7 CB 3B D5 49 52 34 D2 F9 4E 3F
0020 | 02 4B DF 6D EF 52 10 8B 91 CE 65 C0 BC 19 5D 9A
0030 | 0A 3F 41 56 AA 51 1B AA 9B 13 77 69 10 28 36 EE
0040 | D5 85 94 3C 56 A3 F3 AB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01404BA02888A266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>64000000</code> (100 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D5495234D2F94E3F024BDF6DEF52108B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>91CE65C0BC195D9A0A3F4156AA511BAA</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>9B137769102836EED585943C56A3F3AB</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

