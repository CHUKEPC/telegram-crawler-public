<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 26 02 00 02 8A D6 68
0010 | 14 00 00 00 F1 8E 7E BE B7 C5 DA 40 58 01 86 DA
0020 | 83 E1 5F 04 EF FD FA 59</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0260200028AD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A0 E9 78 02 8A D6 68
0010 | 50 00 00 00 63 24 16 05 B7 C5 DA 40 58 01 86 DA
0020 | 83 E1 5F 04 EF FD FA 59 32 98 11 FB 38 CE 1B 16
0030 | 4C 0F 33 97 C2 CB 41 38 08 21 B5 FB AA 43 64 DA
0040 | 7F 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A0E978028AD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0821B5FBAA4364DA7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2429124282729945727</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2429124282729945727</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2429124282729945727 = 1557813979 * 1559316013</code></p>
<pre><code>p = 1557813979
q = 1559316013</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 21 B5 FB AA 43 64 DA 7F 00 00 00
0010 | 04 5C DA 5A DB 00 00 00 04 5C F1 46 2D 00 00 00
0020 | B7 C5 DA 40 58 01 86 DA 83 E1 5F 04 EF FD FA 59
0030 | 32 98 11 FB 38 CE 1B 16 4C 0F 33 97 C2 CB 41 38
0040 | 11 79 8A 6D 24 C6 9B EC D4 82 49 72 B7 18 6E E8
0050 | A1 4E F8 A2 5F 00 2B 2B 91 5B 5C 28 4E B4 21 2C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0821B5FBAA4364DA7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2429124282729945727</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045CDA5ADB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1557813979</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045CF1462D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1559316013</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>11798A6D24C69BECD4824972B7186EE8</code> <code>A14EF8A25F002B2B915B5C284EB4212C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90821B5FBAA4364DA7F000000045CDA5ADB000000045CF1462D000000B7C5DA40580186DA83E15F04EFFDFA59329811FB38CE1B164C0F3397C2CB413811798A6D24C69BECD4824972B7186EE8A14EF8A25F002B2B915B5C284EB4212C02000000
random_padding_bytes = 9D737DF24F6442D1E53D5E3A82249172BC3DC069AE860708BC5D00C35ED5E974B64BD0CEC7D07277C035F006AEBD00C378DD59AA44C4D538D334854AA03DD73A03703EFD784C4BE56BBC19432E9C86219B1CEF421909791366EC5240</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 86B5420B3D67BDEB4B549EF13D2D23C85ECC0BC8D9A8FA6286E678A7B4BC6CDFB2B3F4D461E24A9E7306C16EC13E5AB944E0DE61A0640FC7142F44CD71B17AB15628A277D27D2FF79CB1305A7A4E775CE706AE7174D72C0EFB766EA3D6DE4C587E97C5860B07F3B7F087E8CE62CA0DFBC40A71400843F8D54FE6416E0362D667B587551D895464DAC2123D137C4204EB75E2C6C9655B19E1594B02006F61AF43B037DC41A33FFB0E7DC002072A151565985D7882A4A7F002E1F701444B2684C274D1FE9B300D4A178323DBAC36FB7511734E4608C29AB83959C7C0B71F6C724DE4C4E02C2F883015D29FAD48E98F7138A099575C469ABF0CFBC9216B3D7DD977</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC CA 05 00 02 8A D6 68
0010 | 40 01 00 00 BE E4 12 D7 B7 C5 DA 40 58 01 86 DA
0020 | 83 E1 5F 04 EF FD FA 59 32 98 11 FB 38 CE 1B 16
0030 | 4C 0F 33 97 C2 CB 41 38 04 5C DA 5A DB 00 00 00
0040 | 04 5C F1 46 2D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 86 B5 42 0B 3D 67 BD EB 4B 54 9E F1
0060 | 3D 2D 23 C8 5E CC 0B C8 D9 A8 FA 62 86 E6 78 A7
0070 | B4 BC 6C DF B2 B3 F4 D4 61 E2 4A 9E 73 06 C1 6E
0080 | C1 3E 5A B9 44 E0 DE 61 A0 64 0F C7 14 2F 44 CD
0090 | 71 B1 7A B1 56 28 A2 77 D2 7D 2F F7 9C B1 30 5A
00A0 | 7A 4E 77 5C E7 06 AE 71 74 D7 2C 0E FB 76 6E A3
00B0 | D6 DE 4C 58 7E 97 C5 86 0B 07 F3 B7 F0 87 E8 CE
00C0 | 62 CA 0D FB C4 0A 71 40 08 43 F8 D5 4F E6 41 6E
00D0 | 03 62 D6 67 B5 87 55 1D 89 54 64 DA C2 12 3D 13
00E0 | 7C 42 04 EB 75 E2 C6 C9 65 5B 19 E1 59 4B 02 00
00F0 | 6F 61 AF 43 B0 37 DC 41 A3 3F FB 0E 7D C0 02 07
0100 | 2A 15 15 65 98 5D 78 82 A4 A7 F0 02 E1 F7 01 44
0110 | 4B 26 84 C2 74 D1 FE 9B 30 0D 4A 17 83 23 DB AC
0120 | 36 FB 75 11 73 4E 46 08 C2 9A B8 39 59 C7 C0 B7
0130 | 1F 6C 72 4D E4 C4 E0 2C 2F 88 30 15 D2 9F AD 48
0140 | E9 8F 71 38 A0 99 57 5C 46 9A BF 0C FB C9 21 6B
0150 | 3D 7D D9 77</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>ECCA0500028AD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045CDA5ADB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1557813979</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045CF1462D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1559316013</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010086B5420B3D67BDEB4B549EF1</code> <code>3D2D23C85ECC0BC8D9A8FA6286E678A7</code> <code>B4BC6CDFB2B3F4D461E24A9E7306C16E</code> <code>C13E5AB944E0DE61A0640FC7142F44CD</code> <code>71B17AB15628A277D27D2FF79CB1305A</code> <code>7A4E775CE706AE7174D72C0EFB766EA3</code> <code>D6DE4C587E97C5860B07F3B7F087E8CE</code> <code>62CA0DFBC40A71400843F8D54FE6416E</code> <code>0362D667B587551D895464DAC2123D13</code> <code>7C4204EB75E2C6C9655B19E1594B0200</code> <code>6F61AF43B037DC41A33FFB0E7DC00207</code> <code>2A151565985D7882A4A7F002E1F70144</code> <code>4B2684C274D1FE9B300D4A178323DBAC</code> <code>36FB7511734E4608C29AB83959C7C0B7</code> <code>1F6C724DE4C4E02C2F883015D29FAD48</code> <code>E98F7138A099575C469ABF0CFBC9216B</code><br> <code>3D7DD977</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C D1 B1 02 8A D6 68
0010 | 78 02 00 00 5C 07 E8 D0 B7 C5 DA 40 58 01 86 DA
0020 | 83 E1 5F 04 EF FD FA 59 32 98 11 FB 38 CE 1B 16
0030 | 4C 0F 33 97 C2 CB 41 38 FE 50 02 00 E2 3C 3D C7
0040 | BC 02 7A 1D 22 80 F2 FE 41 CC 49 B5 52 CF D7 A6
0050 | 24 2E 29 49 BA 3D 48 ED CF B2 2B 13 4D B3 6B 89
0060 | BB 6C A8 B0 47 9B C2 65 8C C7 EF 4D F1 25 2A DA
0070 | 28 08 6F 31 CF 31 D1 18 91 DC 93 A4 8A 82 10 F9
0080 | 57 AF 41 2B FB 64 88 3E 26 8D ED BF 0D 0C BC 95
0090 | DE 2C D0 BE E1 AA 8C 7D B7 AE D6 11 88 31 45 47
00A0 | B7 F3 4D 4F FF 0D CB A8 08 5A 9E 68 D4 8C 82 70
00B0 | 0F 91 08 16 00 F1 84 52 58 8D AF 26 35 5F AD 99
00C0 | A5 A7 7C D7 A9 18 B0 A7 A5 27 7E 46 62 ED 33 83
00D0 | 3B 3D FC D3 B8 B0 9C 42 DA 50 91 A3 AE CF 80 A2
00E0 | 09 BF 05 83 DD F1 07 C4 19 CC 79 F3 F9 D0 E0 9F
00F0 | 7A 7D 60 82 A8 9C CC 22 1E 04 09 DC 25 DB 48 BB
0100 | F4 B9 FC 29 9A A0 34 6D 33 80 4F A8 A1 EB 68 E3
0110 | 67 C4 05 B2 63 72 C3 39 43 49 7A D1 C3 6E 77 3A
0120 | 8C 1B 41 1D 63 1F 97 5B E6 09 99 98 D1 93 0F 5D
0130 | 2A 6B 9D EE 3A 6C C7 60 01 16 64 04 29 A9 9A C6
0140 | A1 EE AA 50 A2 99 5C 0F 7D A1 C7 27 4A 48 38 59
0150 | E0 01 32 BC 61 8F A0 E5 49 17 D3 E1 F5 F7 D3 B6
0160 | EF FE 38 B7 8A DE B9 D6 95 2C E3 A9 25 7C B6 3E
0170 | CA 36 4E 49 D6 BE E9 19 BE 95 F4 C4 59 85 49 F0
0180 | CB 43 9E 5B 1C 24 E3 4D D1 FF 8E D7 FD 7C 1A 4A
0190 | E4 8C 1A 50 66 A7 18 54 E7 5C E2 C8 1F 79 3A 96
01A0 | 28 85 BA 50 84 55 C5 FE 90 CA 60 33 F4 56 BF 5E
01B0 | CF 1E A7 9E 66 12 76 69 FD 35 9A EE 51 8D 4F 81
01C0 | 23 EA 66 91 B2 95 2D E3 1D EB 13 CA F1 F7 7C D0
01D0 | 53 50 C0 A1 9E F0 45 6F F1 0E A1 80 E2 D1 40 97
01E0 | 64 92 72 2F CB 88 E7 E1 ED 52 D1 49 A6 03 E9 96
01F0 | 17 83 C8 2E BF B8 21 A1 DC 24 4C 58 A1 0A 1F 15
0200 | 7E 83 97 AC 0B C1 F2 73 3D 08 9C 5F E6 A3 46 8F
0210 | EE C2 4F A7 D4 5E 43 6A 87 94 9D 1B 0B 07 DE 0E
0220 | 8B 34 D5 4F E4 C8 FC 1E F8 5F 37 72 AA 05 F3 94
0230 | 79 B1 61 9D 0B 69 5E 97 E0 E9 41 7B 4D F7 44 CA
0240 | B8 CC 7A FE FB BA 7A 20 34 3A AB 50 56 FB 81 43
0250 | 56 F1 80 A7 64 F7 A6 92 A2 33 EB F6 60 BF 43 A1
0260 | 7D 36 6B 96 8A 55 98 C2 C5 BF E8 2E BF 8F 41 9D
0270 | 5D 7C 93 ED 39 DC 22 AA 00 05 D6 ED 58 B5 64 0B
0280 | 49 F1 60 34 9C 8B 3F E5 27 90 42 CC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019CD1B1028AD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200E23C3DC7BC027A1D2280F2FE</code> <code>41CC49B552CFD7A6242E2949BA3D48ED</code> <code>CFB22B134DB36B89BB6CA8B0479BC265</code> <code>8CC7EF4DF1252ADA28086F31CF31D118</code> <code>91DC93A48A8210F957AF412BFB64883E</code> <code>268DEDBF0D0CBC95DE2CD0BEE1AA8C7D</code> <code>B7AED61188314547B7F34D4FFF0DCBA8</code> <code>085A9E68D48C82700F91081600F18452</code> <code>588DAF26355FAD99A5A77CD7A918B0A7</code> <code>A5277E4662ED33833B3DFCD3B8B09C42</code> <code>DA5091A3AECF80A209BF0583DDF107C4</code> <code>19CC79F3F9D0E09F7A7D6082A89CCC22</code> <code>1E0409DC25DB48BBF4B9FC299AA0346D</code> <code>33804FA8A1EB68E367C405B26372C339</code> <code>43497AD1C36E773A8C1B411D631F975B</code> <code>E6099998D1930F5D2A6B9DEE3A6CC760</code> <code>0116640429A99AC6A1EEAA50A2995C0F</code> <code>7DA1C7274A483859E00132BC618FA0E5</code> <code>4917D3E1F5F7D3B6EFFE38B78ADEB9D6</code> <code>952CE3A9257CB63ECA364E49D6BEE919</code> <code>BE95F4C4598549F0CB439E5B1C24E34D</code> <code>D1FF8ED7FD7C1A4AE48C1A5066A71854</code> <code>E75CE2C81F793A962885BA508455C5FE</code> <code>90CA6033F456BF5ECF1EA79E66127669</code> <code>FD359AEE518D4F8123EA6691B2952DE3</code> <code>1DEB13CAF1F77CD05350C0A19EF0456F</code> <code>F10EA180E2D140976492722FCB88E7E1</code> <code>ED52D149A603E9961783C82EBFB821A1</code> <code>DC244C58A10A1F157E8397AC0BC1F273</code> <code>3D089C5FE6A3468FEEC24FA7D45E436A</code> <code>87949D1B0B07DE0E8B34D54FE4C8FC1E</code> <code>F85F3772AA05F39479B1619D0B695E97</code> <code>E0E9417B4DF744CAB8CC7AFEFBBA7A20</code> <code>343AAB5056FB814356F180A764F7A692</code> <code>A233EBF660BF43A17D366B968A5598C2</code> <code>C5BFE82EBF8F419D5D7C93ED39DC22AA</code> <code>0005D6ED58B5640B49F160349C8B3FE5</code><br> <code>279042CC</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = E23C3DC7BC027A1D2280F2FE41CC49B552CFD7A6242E2949BA3D48EDCFB22B134DB36B89BB6CA8B0479BC2658CC7EF4DF1252ADA28086F31CF31D11891DC93A48A8210F957AF412BFB64883E268DEDBF0D0CBC95DE2CD0BEE1AA8C7DB7AED61188314547B7F34D4FFF0DCBA8085A9E68D48C82700F91081600F18452588DAF26355FAD99A5A77CD7A918B0A7A5277E4662ED33833B3DFCD3B8B09C42DA5091A3AECF80A209BF0583DDF107C419CC79F3F9D0E09F7A7D6082A89CCC221E0409DC25DB48BBF4B9FC299AA0346D33804FA8A1EB68E367C405B26372C33943497AD1C36E773A8C1B411D631F975BE6099998D1930F5D2A6B9DEE3A6CC7600116640429A99AC6A1EEAA50A2995C0F7DA1C7274A483859E00132BC618FA0E54917D3E1F5F7D3B6EFFE38B78ADEB9D6952CE3A9257CB63ECA364E49D6BEE919BE95F4C4598549F0CB439E5B1C24E34DD1FF8ED7FD7C1A4AE48C1A5066A71854E75CE2C81F793A962885BA508455C5FE90CA6033F456BF5ECF1EA79E66127669FD359AEE518D4F8123EA6691B2952DE31DEB13CAF1F77CD05350C0A19EF0456FF10EA180E2D140976492722FCB88E7E1ED52D149A603E9961783C82EBFB821A1DC244C58A10A1F157E8397AC0BC1F2733D089C5FE6A3468FEEC24FA7D45E436A87949D1B0B07DE0E8B34D54FE4C8FC1EF85F3772AA05F39479B1619D0B695E97E0E9417B4DF744CAB8CC7AFEFBBA7A20343AAB5056FB814356F180A764F7A692A233EBF660BF43A17D366B968A5598C2C5BFE82EBF8F419D5D7C93ED39DC22AA0005D6ED58B5640B49F160349C8B3FE5279042CC
tmp_aes_key = A185D963F7479C30C5DBA50DE490337ACD2BCDD96D35877BBF48D08CE60BB0B8
tmp_aes_iv = CEB17D3AE026A830B3AC18D5CD298982BD86FA94ECB7AB6D74722D7811798A6D</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 279570D9E2B74EDBBB533B19981F5D1CFDEF2D92BA0D89B5B7C5DA40580186DA83E15F04EFFDFA59329811FB38CE1B164C0F3397C2CB413803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001006015DB7562D8893B47B55E0C70E90C5C221E95B42AFF51EAC558D9AF8731003D6085DD3D2B2C3EDD54722E00F950BDF15E211C3C510B5BD38794292C7B708381E23765F4C9A3519351233F4B1FC8E82FF21A2057803BD10C1D3B2060E4BBDC5BC4BA98F534B1DE4A5F551412CBB147011EF770FF2B1048A83BD299A0935A034382DD190C763879350CF0FEB2FF5FDFDCFB54041706A3B635C72DC647D0709EDF1C62066C3FFE38DE8C6CD400D7B3D7DA9EE0C94A6F57A841E698AF500571F03D5BC4165CE546B25402DD542628F02B692BF8AB8CEE8AC8CD19756646397EEDC260145BFCC822FD48C14E5B4338ACE40C01F730518CE2DE2B00959D851FF83CEC028AD668D7592A70F88007C5
answer = BA0D89B5B7C5DA40580186DA83E15F04EFFDFA59329811FB38CE1B164C0F3397C2CB413803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001006015DB7562D8893B47B55E0C70E90C5C221E95B42AFF51EAC558D9AF8731003D6085DD3D2B2C3EDD54722E00F950BDF15E211C3C510B5BD38794292C7B708381E23765F4C9A3519351233F4B1FC8E82FF21A2057803BD10C1D3B2060E4BBDC5BC4BA98F534B1DE4A5F551412CBB147011EF770FF2B1048A83BD299A0935A034382DD190C763879350CF0FEB2FF5FDFDCFB54041706A3B635C72DC647D0709EDF1C62066C3FFE38DE8C6CD400D7B3D7DA9EE0C94A6F57A841E698AF500571F03D5BC4165CE546B25402DD542628F02B692BF8AB8CEE8AC8CD19756646397EEDC260145BFCC822FD48C14E5B4338ACE40C01F730518CE2DE2B00959D851FF83CEC028AD668D7592A70F88007C5</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 B7 C5 DA 40 58 01 86 DA 83 E1 5F 04
0010 | EF FD FA 59 32 98 11 FB 38 CE 1B 16 4C 0F 33 97
0020 | C2 CB 41 38 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 60 15 DB 75 62 D8 89 3B 47 B5 5E 0C 70 E9 0C 5C
0140 | 22 1E 95 B4 2A FF 51 EA C5 58 D9 AF 87 31 00 3D
0150 | 60 85 DD 3D 2B 2C 3E DD 54 72 2E 00 F9 50 BD F1
0160 | 5E 21 1C 3C 51 0B 5B D3 87 94 29 2C 7B 70 83 81
0170 | E2 37 65 F4 C9 A3 51 93 51 23 3F 4B 1F C8 E8 2F
0180 | F2 1A 20 57 80 3B D1 0C 1D 3B 20 60 E4 BB DC 5B
0190 | C4 BA 98 F5 34 B1 DE 4A 5F 55 14 12 CB B1 47 01
01A0 | 1E F7 70 FF 2B 10 48 A8 3B D2 99 A0 93 5A 03 43
01B0 | 82 DD 19 0C 76 38 79 35 0C F0 FE B2 FF 5F DF DC
01C0 | FB 54 04 17 06 A3 B6 35 C7 2D C6 47 D0 70 9E DF
01D0 | 1C 62 06 6C 3F FE 38 DE 8C 6C D4 00 D7 B3 D7 DA
01E0 | 9E E0 C9 4A 6F 57 A8 41 E6 98 AF 50 05 71 F0 3D
01F0 | 5B C4 16 5C E5 46 B2 54 02 DD 54 26 28 F0 2B 69
0200 | 2B F8 AB 8C EE 8A C8 CD 19 75 66 46 39 7E ED C2
0210 | 60 14 5B FC C8 22 FD 48 C1 4E 5B 43 38 AC E4 0C
0220 | 01 F7 30 51 8C E2 DE 2B 00 95 9D 85 1F F8 3C EC
0230 | 02 8A D6 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001006015DB7562D8893B47B55E0C</code> <code>70E90C5C221E95B42AFF51EAC558D9AF</code> <code>8731003D6085DD3D2B2C3EDD54722E00</code> <code>F950BDF15E211C3C510B5BD38794292C</code> <code>7B708381E23765F4C9A3519351233F4B</code> <code>1FC8E82FF21A2057803BD10C1D3B2060</code> <code>E4BBDC5BC4BA98F534B1DE4A5F551412</code> <code>CBB147011EF770FF2B1048A83BD299A0</code> <code>935A034382DD190C763879350CF0FEB2</code> <code>FF5FDFDCFB54041706A3B635C72DC647</code> <code>D0709EDF1C62066C3FFE38DE8C6CD400</code> <code>D7B3D7DA9EE0C94A6F57A841E698AF50</code> <code>0571F03D5BC4165CE546B25402DD5426</code> <code>28F02B692BF8AB8CEE8AC8CD19756646</code> <code>397EEDC260145BFCC822FD48C14E5B43</code> <code>38ACE40C01F730518CE2DE2B00959D85</code><br> <code>1FF83CEC</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>028AD668</code> (1758890498 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 6E387BC2B8201FD9BB75C063EEA0434B25245520DB539112FB28B7CECBA700B89E64330541B02880D9F4A06A28D20CDC6E66FF3817F312F3407909E6EE2BFA844F06FB593A8904B78E7C6B0F92FD1EFF0E06D92825BA9BA1D62F4B75212A52372AF7C37396A35D052A1C639AD23BD75F0A898C2E83B39F705A86B75DDBF67E21067B61670266FE32C87671A0A5EF5BF0BB5F2705D49C14B1C611E571B3F150028B772A78662F8D6AACCDC64351D7AE9F4C00557F52BFBF80886694FD3DAF42C987E6868E55B2380C757A148522210120A3B9BC712EAE483BF2FB0B8EF2F4F3E3062F87D305144C951AA8D2AC6C1D880E624D3A6CF1BE095371D7C86500B3680E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 423BC1ED29C7BC4F90A19BFD63D6443BCCA66C5131BA21641AD250B0AF55767641BC5F4E6974A9D48F3F0B5919B477AF838B910A32B7D0580F34B51185DBCC880434B408D248ECD50C69144D71AA8AC26AA994C6CA757CB2442ED75AB83795A31FAEDADD7913753694FC2BFDC6FB93D1645E1CB4D4F458A65F4AD92A30A3FC7E9903C9882B8B8387F5E6916BA102C043163CCB2AB97E49A2D3472942D353033489F4BDC20D4354AC381A20AC62FE29C101CF58E51FAB53AFB8540B6138E05BAB90EA16162FDC4771CB2E9ABE11954F6D0BF971DF4DF3D2B2505DD0066131F93355293378B7DD4E3E726A2749CA86CB9298036DC8B71FDAA388BA9ADE4FF8A522</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 B7 C5 DA 40 58 01 86 DA 83 E1 5F 04
0010 | EF FD FA 59 32 98 11 FB 38 CE 1B 16 4C 0F 33 97
0020 | C2 CB 41 38 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 42 3B C1 ED 29 C7 BC 4F 90 A1 9B FD 63 D6 44 3B
0040 | CC A6 6C 51 31 BA 21 64 1A D2 50 B0 AF 55 76 76
0050 | 41 BC 5F 4E 69 74 A9 D4 8F 3F 0B 59 19 B4 77 AF
0060 | 83 8B 91 0A 32 B7 D0 58 0F 34 B5 11 85 DB CC 88
0070 | 04 34 B4 08 D2 48 EC D5 0C 69 14 4D 71 AA 8A C2
0080 | 6A A9 94 C6 CA 75 7C B2 44 2E D7 5A B8 37 95 A3
0090 | 1F AE DA DD 79 13 75 36 94 FC 2B FD C6 FB 93 D1
00A0 | 64 5E 1C B4 D4 F4 58 A6 5F 4A D9 2A 30 A3 FC 7E
00B0 | 99 03 C9 88 2B 8B 83 87 F5 E6 91 6B A1 02 C0 43
00C0 | 16 3C CB 2A B9 7E 49 A2 D3 47 29 42 D3 53 03 34
00D0 | 89 F4 BD C2 0D 43 54 AC 38 1A 20 AC 62 FE 29 C1
00E0 | 01 CF 58 E5 1F AB 53 AF B8 54 0B 61 38 E0 5B AB
00F0 | 90 EA 16 16 2F DC 47 71 CB 2E 9A BE 11 95 4F 6D
0100 | 0B F9 71 DF 4D F3 D2 B2 50 5D D0 06 61 31 F9 33
0110 | 55 29 33 78 B7 DD 4E 3E 72 6A 27 49 CA 86 CB 92
0120 | 98 03 6D C8 B7 1F DA A3 88 BA 9A DE 4F F8 A5 22</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100423BC1ED29C7BC4F90A19BFD</code> <code>63D6443BCCA66C5131BA21641AD250B0</code> <code>AF55767641BC5F4E6974A9D48F3F0B59</code> <code>19B477AF838B910A32B7D0580F34B511</code> <code>85DBCC880434B408D248ECD50C69144D</code> <code>71AA8AC26AA994C6CA757CB2442ED75A</code> <code>B83795A31FAEDADD7913753694FC2BFD</code> <code>C6FB93D1645E1CB4D4F458A65F4AD92A</code> <code>30A3FC7E9903C9882B8B8387F5E6916B</code> <code>A102C043163CCB2AB97E49A2D3472942</code> <code>D353033489F4BDC20D4354AC381A20AC</code> <code>62FE29C101CF58E51FAB53AFB8540B61</code> <code>38E05BAB90EA16162FDC4771CB2E9ABE</code> <code>11954F6D0BF971DF4DF3D2B2505DD006</code> <code>6131F93355293378B7DD4E3E726A2749</code> <code>CA86CB9298036DC8B71FDAA388BA9ADE</code><br> <code>4FF8A522</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366B7C5DA40580186DA83E15F04EFFDFA59329811FB38CE1B164C0F3397C2CB41380000000000000000FE000100423BC1ED29C7BC4F90A19BFD63D6443BCCA66C5131BA21641AD250B0AF55767641BC5F4E6974A9D48F3F0B5919B477AF838B910A32B7D0580F34B51185DBCC880434B408D248ECD50C69144D71AA8AC26AA994C6CA757CB2442ED75AB83795A31FAEDADD7913753694FC2BFDC6FB93D1645E1CB4D4F458A65F4AD92A30A3FC7E9903C9882B8B8387F5E6916BA102C043163CCB2AB97E49A2D3472942D353033489F4BDC20D4354AC381A20AC62FE29C101CF58E51FAB53AFB8540B6138E05BAB90EA16162FDC4771CB2E9ABE11954F6D0BF971DF4DF3D2B2505DD0066131F93355293378B7DD4E3E726A2749CA86CB9298036DC8B71FDAA388BA9ADE4FF8A522
padding = F1E9BC262CF11351DA796A8F
tmp_aes_key = A185D963F7479C30C5DBA50DE490337ACD2BCDD96D35877BBF48D08CE60BB0B8
tmp_aes_iv = CEB17D3AE026A830B3AC18D5CD298982BD86FA94ECB7AB6D74722D7811798A6D</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = E18E3E96CD84B2CCE0D235B427DC6C46A90513050A69E3F6A81F3C90DAD7F2539D03B7685CD463A5598701FB68F7E3665FE689C8753A26CAB79336E6F598F99553912C61D9888E2D9E9D496A6E1A3C53AE3680D6173D6207DEB99D25147AF0252C6AACC2D7BAB731DE6615DB576032866C0B39D705C63070F9F2471A182EA99FF89EB75C28B5B10E08449979BDED21A98C42636A738E2484ECD704F791DBB7B202FFFD5228DCFF86123AD8CBB9F0F59668B425C3E631070EE69772BAA7D0880DF60198DE5CD42D5241574DFA450D50F758666030D116BC40F84A1EF45F56E7C7834C76A312E4F0B58D39E54411D001FF93CD2D0BD34DC268EF4D085D6EDFAEED454D654A34CFDFCFDF2AE6D635AC146CA18E320435A391DD27B2B1770C34545F9D0BD54ABB3D3EAD39525089DA541B88D82D015B8B73D76EE706C30C9E6E4949C0AB67218EBB7004339F611529671A6B</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 70 28 0C 00 02 8A D6 68
0010 | 78 01 00 00 1F 5F 04 F5 B7 C5 DA 40 58 01 86 DA
0020 | 83 E1 5F 04 EF FD FA 59 32 98 11 FB 38 CE 1B 16
0030 | 4C 0F 33 97 C2 CB 41 38 FE 50 01 00 E1 8E 3E 96
0040 | CD 84 B2 CC E0 D2 35 B4 27 DC 6C 46 A9 05 13 05
0050 | 0A 69 E3 F6 A8 1F 3C 90 DA D7 F2 53 9D 03 B7 68
0060 | 5C D4 63 A5 59 87 01 FB 68 F7 E3 66 5F E6 89 C8
0070 | 75 3A 26 CA B7 93 36 E6 F5 98 F9 95 53 91 2C 61
0080 | D9 88 8E 2D 9E 9D 49 6A 6E 1A 3C 53 AE 36 80 D6
0090 | 17 3D 62 07 DE B9 9D 25 14 7A F0 25 2C 6A AC C2
00A0 | D7 BA B7 31 DE 66 15 DB 57 60 32 86 6C 0B 39 D7
00B0 | 05 C6 30 70 F9 F2 47 1A 18 2E A9 9F F8 9E B7 5C
00C0 | 28 B5 B1 0E 08 44 99 79 BD ED 21 A9 8C 42 63 6A
00D0 | 73 8E 24 84 EC D7 04 F7 91 DB B7 B2 02 FF FD 52
00E0 | 28 DC FF 86 12 3A D8 CB B9 F0 F5 96 68 B4 25 C3
00F0 | E6 31 07 0E E6 97 72 BA A7 D0 88 0D F6 01 98 DE
0100 | 5C D4 2D 52 41 57 4D FA 45 0D 50 F7 58 66 60 30
0110 | D1 16 BC 40 F8 4A 1E F4 5F 56 E7 C7 83 4C 76 A3
0120 | 12 E4 F0 B5 8D 39 E5 44 11 D0 01 FF 93 CD 2D 0B
0130 | D3 4D C2 68 EF 4D 08 5D 6E DF AE ED 45 4D 65 4A
0140 | 34 CF DF CF DF 2A E6 D6 35 AC 14 6C A1 8E 32 04
0150 | 35 A3 91 DD 27 B2 B1 77 0C 34 54 5F 9D 0B D5 4A
0160 | BB 3D 3E AD 39 52 50 89 DA 54 1B 88 D8 2D 01 5B
0170 | 8B 73 D7 6E E7 06 C3 0C 9E 6E 49 49 C0 AB 67 21
0180 | 8E BB 70 04 33 9F 61 15 29 67 1A 6B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>70280C00028AD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100E18E3E96CD84B2CCE0D235B4</code> <code>27DC6C46A90513050A69E3F6A81F3C90</code> <code>DAD7F2539D03B7685CD463A5598701FB</code> <code>68F7E3665FE689C8753A26CAB79336E6</code> <code>F598F99553912C61D9888E2D9E9D496A</code> <code>6E1A3C53AE3680D6173D6207DEB99D25</code> <code>147AF0252C6AACC2D7BAB731DE6615DB</code> <code>576032866C0B39D705C63070F9F2471A</code> <code>182EA99FF89EB75C28B5B10E08449979</code> <code>BDED21A98C42636A738E2484ECD704F7</code> <code>91DBB7B202FFFD5228DCFF86123AD8CB</code> <code>B9F0F59668B425C3E631070EE69772BA</code> <code>A7D0880DF60198DE5CD42D5241574DFA</code> <code>450D50F758666030D116BC40F84A1EF4</code> <code>5F56E7C7834C76A312E4F0B58D39E544</code> <code>11D001FF93CD2D0BD34DC268EF4D085D</code> <code>6EDFAEED454D654A34CFDFCFDF2AE6D6</code> <code>35AC146CA18E320435A391DD27B2B177</code> <code>0C34545F9D0BD54ABB3D3EAD39525089</code> <code>DA541B88D82D015B8B73D76EE706C30C</code> <code>9E6E4949C0AB67218EBB7004339F6115</code><br> <code>29671A6B</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2DCA099EF6DAFC3A668B98EA3596E9AAE1E584BFECBF4B05F5270F89E60BF12DD73BE351DC365FB79F0EA15EE912CFE29BDD04724C2615A1DA47C1F622316BFEC68E012FDE144C1C327D39469DC4913C541B97A0244F7025B552C3C7BC06769FDA54E3A6402A6443A300F3368BCC57C2325ED48278EC8872D3CA9AB3EA5998A55BB216D181315E0714DB0FEA2C47B3D86FABD001AB834E4EC9E4C967B1ADEEC8F219247C411A9ECEFE475CAC6A133AAD05EBA965B2EE214A1E5B62BE858674598DE8CC89C6F405D446B4677A357D79F3CDFD1C5E5A2BA42A85ABD2EE978B9B78186387B34E43A1B30CFFDAFE77F8A7765A142F1AA1E2CC2611836F5C4FB196E8</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C E9 0C 04 8A D6 68
0010 | 34 00 00 00 34 F7 CB 3B B7 C5 DA 40 58 01 86 DA
0020 | 83 E1 5F 04 EF FD FA 59 32 98 11 FB 38 CE 1B 16
0030 | 4C 0F 33 97 C2 CB 41 38 66 ED 81 64 97 E0 D6 86
0040 | AA 36 C4 62 6E 49 6A 38</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017CE90C048AD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B7C5DA40580186DA83E15F04EFFDFA59</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>329811FB38CE1B164C0F3397C2CB4138</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>66ED816497E0D686AA36C4626E496A38</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

