<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 54 C1 0C 00 56 DB 72 67
0010 | 14 00 00 00 F1 8E 7E BE 1D AA D1 D7 83 10 5C FC
0020 | 50 1D 7D 4A 77 23 66 2F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>54C10C0056DB7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 0C 34 7E 56 DB 72 67
0010 | 50 00 00 00 63 24 16 05 1D AA D1 D7 83 10 5C FC
0020 | 50 1D 7D 4A 77 23 66 2F 83 82 C2 DE E5 72 15 9D
0030 | 15 25 A2 9B EC C4 0A 22 08 23 84 8D D0 12 1F 37
0040 | 81 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>010C347E56DB7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0823848DD0121F3781000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2559326413050034049</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2559326413050034049</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2559326413050034049 = 1309428817 * 1954536497</code></p>
<pre><code>p = 1309428817
q = 1954536497</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 23 84 8D D0 12 1F 37 81 00 00 00
0010 | 04 4E 0C 4C 51 00 00 00 04 74 7F DC 31 00 00 00
0020 | 1D AA D1 D7 83 10 5C FC 50 1D 7D 4A 77 23 66 2F
0030 | 83 82 C2 DE E5 72 15 9D 15 25 A2 9B EC C4 0A 22
0040 | 8C 9F C3 54 C4 35 86 44 90 84 C7 A2 5D 4E FE B7
0050 | B0 DE 29 9B C7 28 FE 44 81 3D 68 F3 CF 3C AE 6C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0823848DD0121F3781000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2559326413050034049</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044E0C4C51000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1309428817</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04747FDC31000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1954536497</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>8C9FC354C43586449084C7A25D4EFEB7</code> <code>B0DE299BC728FE44813D68F3CF3CAE6C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90823848DD0121F3781000000044E0C4C5100000004747FDC310000001DAAD1D783105CFC501D7D4A7723662F8382C2DEE572159D1525A29BECC40A228C9FC354C43586449084C7A25D4EFEB7B0DE299BC728FE44813D68F3CF3CAE6C02000000
random_padding_bytes = 349A494ADF2122781739F7C563EAF1DCD68F3DD64AD464980BB7FB72BDA8A02498AAA02E351BB47AD728BF39DF2F35B48C58747F6BF3E40FB8BC48C40E8F553EF49751F0B331F33B152F87F1FE9889B8DB012BD0F89AB4EB20748609</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D41ADAE931349361027DBB28D216FA47705A8E5702CEE1ECE0832E98CF080008DE777D710262595B2CCCC46C6995FCEC37681220CAFDCEB57B21A8E3445492E975CC6E2061E4CC5440F9C8D75D5A9B4A7C733068E7C9F0B7DEFDA1333FF2EFB621AEA08CE1AF10062131E4628E5B47F458BF0A460A02C7844BBF30B7F17A229C96928F28C56DA7B2EE387A2336D09DB38D8A63495A25A9C9D1F3055CDE823A5B4274EF409ADDDE2F9535B444D8EFE6B21C1FCCFDF86364031904FEE6C448ECA6F60F0485EA98FD76DC6AA02398E3F01E8F2263D9AF8D07B42230814133B43CD23108755F0A39DA4C8ACB7A6F46DBEEACBB5E837F77D89DEDCB91CDC0F3B41F37</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 58 C1 0C 00 56 DB 72 67
0010 | 40 01 00 00 BE E4 12 D7 1D AA D1 D7 83 10 5C FC
0020 | 50 1D 7D 4A 77 23 66 2F 83 82 C2 DE E5 72 15 9D
0030 | 15 25 A2 9B EC C4 0A 22 04 4E 0C 4C 51 00 00 00
0040 | 04 74 7F DC 31 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D4 1A DA E9 31 34 93 61 02 7D BB 28
0060 | D2 16 FA 47 70 5A 8E 57 02 CE E1 EC E0 83 2E 98
0070 | CF 08 00 08 DE 77 7D 71 02 62 59 5B 2C CC C4 6C
0080 | 69 95 FC EC 37 68 12 20 CA FD CE B5 7B 21 A8 E3
0090 | 44 54 92 E9 75 CC 6E 20 61 E4 CC 54 40 F9 C8 D7
00A0 | 5D 5A 9B 4A 7C 73 30 68 E7 C9 F0 B7 DE FD A1 33
00B0 | 3F F2 EF B6 21 AE A0 8C E1 AF 10 06 21 31 E4 62
00C0 | 8E 5B 47 F4 58 BF 0A 46 0A 02 C7 84 4B BF 30 B7
00D0 | F1 7A 22 9C 96 92 8F 28 C5 6D A7 B2 EE 38 7A 23
00E0 | 36 D0 9D B3 8D 8A 63 49 5A 25 A9 C9 D1 F3 05 5C
00F0 | DE 82 3A 5B 42 74 EF 40 9A DD DE 2F 95 35 B4 44
0100 | D8 EF E6 B2 1C 1F CC FD F8 63 64 03 19 04 FE E6
0110 | C4 48 EC A6 F6 0F 04 85 EA 98 FD 76 DC 6A A0 23
0120 | 98 E3 F0 1E 8F 22 63 D9 AF 8D 07 B4 22 30 81 41
0130 | 33 B4 3C D2 31 08 75 5F 0A 39 DA 4C 8A CB 7A 6F
0140 | 46 DB EE AC BB 5E 83 7F 77 D8 9D ED CB 91 CD C0
0150 | F3 B4 1F 37</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>58C10C0056DB7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044E0C4C51000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1309428817</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04747FDC31000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1954536497</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D41ADAE931349361027DBB28</code> <code>D216FA47705A8E5702CEE1ECE0832E98</code> <code>CF080008DE777D710262595B2CCCC46C</code> <code>6995FCEC37681220CAFDCEB57B21A8E3</code> <code>445492E975CC6E2061E4CC5440F9C8D7</code> <code>5D5A9B4A7C733068E7C9F0B7DEFDA133</code> <code>3FF2EFB621AEA08CE1AF10062131E462</code> <code>8E5B47F458BF0A460A02C7844BBF30B7</code> <code>F17A229C96928F28C56DA7B2EE387A23</code> <code>36D09DB38D8A63495A25A9C9D1F3055C</code> <code>DE823A5B4274EF409ADDDE2F9535B444</code> <code>D8EFE6B21C1FCCFDF86364031904FEE6</code> <code>C448ECA6F60F0485EA98FD76DC6AA023</code> <code>98E3F01E8F2263D9AF8D07B422308141</code> <code>33B43CD23108755F0A39DA4C8ACB7A6F</code> <code>46DBEEACBB5E837F77D89DEDCB91CDC0</code><br> <code>F3B41F37</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C8 8E 99 56 DB 72 67
0010 | 78 02 00 00 5C 07 E8 D0 1D AA D1 D7 83 10 5C FC
0020 | 50 1D 7D 4A 77 23 66 2F 83 82 C2 DE E5 72 15 9D
0030 | 15 25 A2 9B EC C4 0A 22 FE 50 02 00 41 0E 65 5E
0040 | F5 FA B7 45 65 30 83 D7 17 82 91 A7 87 BE 56 8F
0050 | A1 7C 21 A9 BD D7 DF FA 07 15 F0 9A F6 00 8D EF
0060 | CF 8C 78 6E 07 EE DA F3 00 F8 4C FC 6F 4A F2 F6
0070 | 4D D8 10 03 FE 6E BC EA 0B 6F 29 8B 97 7A 5A 0A
0080 | 77 A7 F8 DB B3 5A 27 2A 78 96 68 71 C9 B8 E9 CF
0090 | C8 1F C7 CA 27 DA 65 33 2B 0E 8E C5 C6 38 78 82
00A0 | 0C 74 3F 22 5B 7D AF CE 96 6D BC 8B C1 36 4A BF
00B0 | FC B1 18 8E B4 B2 2A 3F E9 C6 38 86 E0 72 BE 5E
00C0 | A5 75 65 39 A9 F2 CE 5B 30 3C 8B ED 19 17 60 E0
00D0 | 45 17 18 D8 D0 C9 0C 8F 5C 9A C4 03 7D 8A A2 3E
00E0 | B5 49 7C 6E EA EA 6C 65 6D B3 F6 4C 78 37 3D DA
00F0 | F6 FA CF 55 2B D3 27 FE CC AC 77 0C F5 F8 8A 27
0100 | C9 33 8E 38 F7 8A AB D1 DE 02 6A C8 E6 C1 E6 A4
0110 | C7 14 A1 F4 A7 8A 54 9C 1C 95 13 62 A9 61 27 DD
0120 | EB 8F EE F3 CD 63 29 B1 10 16 55 02 40 C1 23 EF
0130 | 28 98 BB D6 40 62 37 1D 8A AB BC 50 E6 5D FD 38
0140 | 69 A4 38 7B DF BC 36 52 CA 48 69 49 68 E9 45 0C
0150 | 74 9B 5E 62 FA A0 E7 8F F5 D1 74 0F B0 2C AF 49
0160 | E8 F2 9A CA 6F 61 AB 9A 01 EF A1 4D 81 A3 67 39
0170 | 98 7B 43 51 96 54 17 02 EA 59 CD 50 0C F4 D2 DA
0180 | 36 E4 40 31 79 6D 66 56 E6 72 5E 28 B2 EE 41 0C
0190 | 16 FD A0 D9 56 30 61 1B 37 68 EC 32 2C 69 D8 E2
01A0 | 89 69 59 69 A6 25 99 EB 55 F2 2F F6 CA 6B DC 23
01B0 | 75 14 02 6E 29 98 56 EA 65 0C 49 74 73 A9 1D E5
01C0 | FE 74 81 B9 67 E5 67 74 DB 66 F4 E2 82 7A B9 0C
01D0 | 07 35 CA B2 5E FC 30 47 73 11 07 58 89 FF 30 19
01E0 | F6 0F 44 97 50 98 D9 0C 79 6D 58 4A F3 8C 02 6F
01F0 | 92 B8 C4 AB 1B E9 F2 68 CC 65 FB E0 CF 3A 66 3C
0200 | F1 90 27 17 BF 78 52 0E AC A7 58 C0 0A D6 C2 57
0210 | 41 51 ED F5 D0 11 7A 0A A5 06 47 2D EB 94 43 A7
0220 | 06 05 A0 B8 6B 93 83 FC 1B FB C0 89 A9 EB 18 83
0230 | 8A 93 01 74 A7 38 02 16 C6 80 2A 36 D8 EF 22 41
0240 | E9 F2 01 B7 F3 63 DB 29 0B E3 71 14 D3 BA 09 02
0250 | 2A 49 44 65 61 F8 E5 E7 C0 80 21 30 D7 50 10 8C
0260 | E7 52 58 0C 3D CE 7F CE 97 35 5A 79 3E 3A D5 57
0270 | DC 84 52 53 29 8A 40 71 E7 77 9C 9D 9C 49 A2 1A
0280 | 32 B1 93 C6 E2 2C 22 B0 99 2A 36 E7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C88E9956DB7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200410E655EF5FAB745653083D7</code> <code>178291A787BE568FA17C21A9BDD7DFFA</code> <code>0715F09AF6008DEFCF8C786E07EEDAF3</code> <code>00F84CFC6F4AF2F64DD81003FE6EBCEA</code> <code>0B6F298B977A5A0A77A7F8DBB35A272A</code> <code>78966871C9B8E9CFC81FC7CA27DA6533</code> <code>2B0E8EC5C63878820C743F225B7DAFCE</code> <code>966DBC8BC1364ABFFCB1188EB4B22A3F</code> <code>E9C63886E072BE5EA5756539A9F2CE5B</code> <code>303C8BED191760E0451718D8D0C90C8F</code> <code>5C9AC4037D8AA23EB5497C6EEAEA6C65</code> <code>6DB3F64C78373DDAF6FACF552BD327FE</code> <code>CCAC770CF5F88A27C9338E38F78AABD1</code> <code>DE026AC8E6C1E6A4C714A1F4A78A549C</code> <code>1C951362A96127DDEB8FEEF3CD6329B1</code> <code>1016550240C123EF2898BBD64062371D</code> <code>8AABBC50E65DFD3869A4387BDFBC3652</code> <code>CA48694968E9450C749B5E62FAA0E78F</code> <code>F5D1740FB02CAF49E8F29ACA6F61AB9A</code> <code>01EFA14D81A36739987B435196541702</code> <code>EA59CD500CF4D2DA36E44031796D6656</code> <code>E6725E28B2EE410C16FDA0D95630611B</code> <code>3768EC322C69D8E289695969A62599EB</code> <code>55F22FF6CA6BDC237514026E299856EA</code> <code>650C497473A91DE5FE7481B967E56774</code> <code>DB66F4E2827AB90C0735CAB25EFC3047</code> <code>7311075889FF3019F60F44975098D90C</code> <code>796D584AF38C026F92B8C4AB1BE9F268</code> <code>CC65FBE0CF3A663CF1902717BF78520E</code> <code>ACA758C00AD6C2574151EDF5D0117A0A</code> <code>A506472DEB9443A70605A0B86B9383FC</code> <code>1BFBC089A9EB18838A930174A7380216</code> <code>C6802A36D8EF2241E9F201B7F363DB29</code> <code>0BE37114D3BA09022A49446561F8E5E7</code> <code>C0802130D750108CE752580C3DCE7FCE</code> <code>97355A793E3AD557DC845253298A4071</code> <code>E7779C9D9C49A21A32B193C6E22C22B0</code><br> <code>992A36E7</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 410E655EF5FAB745653083D7178291A787BE568FA17C21A9BDD7DFFA0715F09AF6008DEFCF8C786E07EEDAF300F84CFC6F4AF2F64DD81003FE6EBCEA0B6F298B977A5A0A77A7F8DBB35A272A78966871C9B8E9CFC81FC7CA27DA65332B0E8EC5C63878820C743F225B7DAFCE966DBC8BC1364ABFFCB1188EB4B22A3FE9C63886E072BE5EA5756539A9F2CE5B303C8BED191760E0451718D8D0C90C8F5C9AC4037D8AA23EB5497C6EEAEA6C656DB3F64C78373DDAF6FACF552BD327FECCAC770CF5F88A27C9338E38F78AABD1DE026AC8E6C1E6A4C714A1F4A78A549C1C951362A96127DDEB8FEEF3CD6329B11016550240C123EF2898BBD64062371D8AABBC50E65DFD3869A4387BDFBC3652CA48694968E9450C749B5E62FAA0E78FF5D1740FB02CAF49E8F29ACA6F61AB9A01EFA14D81A36739987B435196541702EA59CD500CF4D2DA36E44031796D6656E6725E28B2EE410C16FDA0D95630611B3768EC322C69D8E289695969A62599EB55F22FF6CA6BDC237514026E299856EA650C497473A91DE5FE7481B967E56774DB66F4E2827AB90C0735CAB25EFC30477311075889FF3019F60F44975098D90C796D584AF38C026F92B8C4AB1BE9F268CC65FBE0CF3A663CF1902717BF78520EACA758C00AD6C2574151EDF5D0117A0AA506472DEB9443A70605A0B86B9383FC1BFBC089A9EB18838A930174A7380216C6802A36D8EF2241E9F201B7F363DB290BE37114D3BA09022A49446561F8E5E7C0802130D750108CE752580C3DCE7FCE97355A793E3AD557DC845253298A4071E7779C9D9C49A21A32B193C6E22C22B0992A36E7
tmp_aes_key = A098475EB5FA76212B28799C81A67E551E5041119450BD4D13425D8D93A67DA6
tmp_aes_iv = 5482B3418285D824D0290E6831FFDF14002401A480E0117E45F313D98C9FC354</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 6632DC1A010051D3B25F8F9FBAEA02B630C360AABA0D89B51DAAD1D783105CFC501D7D4A7723662F8382C2DEE572159D1525A29BECC40A2203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003590EB3014F2A0D6BC458D8730C3DF1341250ACDC9ADC385F3023B0C19CD38A9C3F25A171912AA013A26708635F8FDDED3E89CEC79B5BCC831198FDA59A936DAB6F1F5C254058F0DB2C45845E7EC3CC47DD764D0283988F46EEDA028EACBF034FAC11EA5E4F4B9691F0B4FB57FE2777C83D4036BE81B7D47076D3DB47652382D89E9420E0064148448DA6203E3E72A1A5A23201FFD5B86E269E13B3D45A76A8A6F975947FECF8544AC4178FD6F90B97099416594F44367D150AD7D3519209F7023A2828E18392500412A0D59D30F08397904DBFC5FB4C9DA1FE4A86FB374D34E9CC907B910251A48173E07180FA661BC83E4F1DAFE621B9DA83A610CA41D299856DB726775390B723CAC2D53
answer = BA0D89B51DAAD1D783105CFC501D7D4A7723662F8382C2DEE572159D1525A29BECC40A2203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003590EB3014F2A0D6BC458D8730C3DF1341250ACDC9ADC385F3023B0C19CD38A9C3F25A171912AA013A26708635F8FDDED3E89CEC79B5BCC831198FDA59A936DAB6F1F5C254058F0DB2C45845E7EC3CC47DD764D0283988F46EEDA028EACBF034FAC11EA5E4F4B9691F0B4FB57FE2777C83D4036BE81B7D47076D3DB47652382D89E9420E0064148448DA6203E3E72A1A5A23201FFD5B86E269E13B3D45A76A8A6F975947FECF8544AC4178FD6F90B97099416594F44367D150AD7D3519209F7023A2828E18392500412A0D59D30F08397904DBFC5FB4C9DA1FE4A86FB374D34E9CC907B910251A48173E07180FA661BC83E4F1DAFE621B9DA83A610CA41D299856DB726775390B723CAC2D53</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 1D AA D1 D7 83 10 5C FC 50 1D 7D 4A
0010 | 77 23 66 2F 83 82 C2 DE E5 72 15 9D 15 25 A2 9B
0020 | EC C4 0A 22 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 35 90 EB 30 14 F2 A0 D6 BC 45 8D 87 30 C3 DF 13
0140 | 41 25 0A CD C9 AD C3 85 F3 02 3B 0C 19 CD 38 A9
0150 | C3 F2 5A 17 19 12 AA 01 3A 26 70 86 35 F8 FD DE
0160 | D3 E8 9C EC 79 B5 BC C8 31 19 8F DA 59 A9 36 DA
0170 | B6 F1 F5 C2 54 05 8F 0D B2 C4 58 45 E7 EC 3C C4
0180 | 7D D7 64 D0 28 39 88 F4 6E ED A0 28 EA CB F0 34
0190 | FA C1 1E A5 E4 F4 B9 69 1F 0B 4F B5 7F E2 77 7C
01A0 | 83 D4 03 6B E8 1B 7D 47 07 6D 3D B4 76 52 38 2D
01B0 | 89 E9 42 0E 00 64 14 84 48 DA 62 03 E3 E7 2A 1A
01C0 | 5A 23 20 1F FD 5B 86 E2 69 E1 3B 3D 45 A7 6A 8A
01D0 | 6F 97 59 47 FE CF 85 44 AC 41 78 FD 6F 90 B9 70
01E0 | 99 41 65 94 F4 43 67 D1 50 AD 7D 35 19 20 9F 70
01F0 | 23 A2 82 8E 18 39 25 00 41 2A 0D 59 D3 0F 08 39
0200 | 79 04 DB FC 5F B4 C9 DA 1F E4 A8 6F B3 74 D3 4E
0210 | 9C C9 07 B9 10 25 1A 48 17 3E 07 18 0F A6 61 BC
0220 | 83 E4 F1 DA FE 62 1B 9D A8 3A 61 0C A4 1D 29 98
0230 | 56 DB 72 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001003590EB3014F2A0D6BC458D87</code> <code>30C3DF1341250ACDC9ADC385F3023B0C</code> <code>19CD38A9C3F25A171912AA013A267086</code> <code>35F8FDDED3E89CEC79B5BCC831198FDA</code> <code>59A936DAB6F1F5C254058F0DB2C45845</code> <code>E7EC3CC47DD764D0283988F46EEDA028</code> <code>EACBF034FAC11EA5E4F4B9691F0B4FB5</code> <code>7FE2777C83D4036BE81B7D47076D3DB4</code> <code>7652382D89E9420E0064148448DA6203</code> <code>E3E72A1A5A23201FFD5B86E269E13B3D</code> <code>45A76A8A6F975947FECF8544AC4178FD</code> <code>6F90B97099416594F44367D150AD7D35</code> <code>19209F7023A2828E18392500412A0D59</code> <code>D30F08397904DBFC5FB4C9DA1FE4A86F</code> <code>B374D34E9CC907B910251A48173E0718</code> <code>0FA661BC83E4F1DAFE621B9DA83A610C</code><br> <code>A41D2998</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>56DB7267</code> (1735580502 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 74CBBF5EECBCF4919BD2A64B1C532B2E56AFBE32C77283B60F063B2DA507A42EBADB99FF1FD3487727EDD67980465E886D16F58F0BF503BCC89CD890E11396B6DA411949F76166EFBEE8ACB7D0377F5431C3918D0C5A5FD041627A93EDA98FC6265EBB8C7A9387E3E722E5D09EE22845EE073DCC2453CDE70E2DA65A75F3299A63C380E70C037579EF9C758BD47A3C7B793CF25931766FADB316575291E42019A2FE5993613D56916FB073D2EDD2F639FED2298ADBE9EA70F8BCA3E8C649A3BB397D5FBC47C6077B4D7FD56556241E3B153811815148965F36D4F2D4100C425A465A45886683972BE4B21D77CE7F50A782E9F61FF1429EB5A592A1EE25B2F46A</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 93D139E85F5976A8DE78E69476E43504D28DF15A8BCD8B06A1FFD1D8300F05CFE8FD1508DF6A53FB84A01B5C274FFB7AD7680A3ADB4D4BC51D8F6A65488AE279E8FA51B568A4993E3CA1F08211742193B4C34D1D61F73131A046A3F178875D5C7710F038AA9AC60188D238469E766AD353ACC297723285B5E0CCDA9476444568A2D925015AA90CE0B8788FEE94586D2B86AA3D354B7B82CE8191BAF8F31D8B69E1E99C58A0024A0FD94223D20ED6FF9D46C02773506849A13E0F7244C8D5AD147935356E0B71AAACFDB5475D20CB29FEBC33150E48DA888119FF60C83B835566B81334074ED6F302DC8E43E373B38EBE313D6E36C884476B8F926921E4F8B5C2</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 1D AA D1 D7 83 10 5C FC 50 1D 7D 4A
0010 | 77 23 66 2F 83 82 C2 DE E5 72 15 9D 15 25 A2 9B
0020 | EC C4 0A 22 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 93 D1 39 E8 5F 59 76 A8 DE 78 E6 94 76 E4 35 04
0040 | D2 8D F1 5A 8B CD 8B 06 A1 FF D1 D8 30 0F 05 CF
0050 | E8 FD 15 08 DF 6A 53 FB 84 A0 1B 5C 27 4F FB 7A
0060 | D7 68 0A 3A DB 4D 4B C5 1D 8F 6A 65 48 8A E2 79
0070 | E8 FA 51 B5 68 A4 99 3E 3C A1 F0 82 11 74 21 93
0080 | B4 C3 4D 1D 61 F7 31 31 A0 46 A3 F1 78 87 5D 5C
0090 | 77 10 F0 38 AA 9A C6 01 88 D2 38 46 9E 76 6A D3
00A0 | 53 AC C2 97 72 32 85 B5 E0 CC DA 94 76 44 45 68
00B0 | A2 D9 25 01 5A A9 0C E0 B8 78 8F EE 94 58 6D 2B
00C0 | 86 AA 3D 35 4B 7B 82 CE 81 91 BA F8 F3 1D 8B 69
00D0 | E1 E9 9C 58 A0 02 4A 0F D9 42 23 D2 0E D6 FF 9D
00E0 | 46 C0 27 73 50 68 49 A1 3E 0F 72 44 C8 D5 AD 14
00F0 | 79 35 35 6E 0B 71 AA AC FD B5 47 5D 20 CB 29 FE
0100 | BC 33 15 0E 48 DA 88 81 19 FF 60 C8 3B 83 55 66
0110 | B8 13 34 07 4E D6 F3 02 DC 8E 43 E3 73 B3 8E BE
0120 | 31 3D 6E 36 C8 84 47 6B 8F 92 69 21 E4 F8 B5 C2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010093D139E85F5976A8DE78E694</code> <code>76E43504D28DF15A8BCD8B06A1FFD1D8</code> <code>300F05CFE8FD1508DF6A53FB84A01B5C</code> <code>274FFB7AD7680A3ADB4D4BC51D8F6A65</code> <code>488AE279E8FA51B568A4993E3CA1F082</code> <code>11742193B4C34D1D61F73131A046A3F1</code> <code>78875D5C7710F038AA9AC60188D23846</code> <code>9E766AD353ACC297723285B5E0CCDA94</code> <code>76444568A2D925015AA90CE0B8788FEE</code> <code>94586D2B86AA3D354B7B82CE8191BAF8</code> <code>F31D8B69E1E99C58A0024A0FD94223D2</code> <code>0ED6FF9D46C02773506849A13E0F7244</code> <code>C8D5AD147935356E0B71AAACFDB5475D</code> <code>20CB29FEBC33150E48DA888119FF60C8</code> <code>3B835566B81334074ED6F302DC8E43E3</code> <code>73B38EBE313D6E36C884476B8F926921</code><br> <code>E4F8B5C2</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643661DAAD1D783105CFC501D7D4A7723662F8382C2DEE572159D1525A29BECC40A220000000000000000FE00010093D139E85F5976A8DE78E69476E43504D28DF15A8BCD8B06A1FFD1D8300F05CFE8FD1508DF6A53FB84A01B5C274FFB7AD7680A3ADB4D4BC51D8F6A65488AE279E8FA51B568A4993E3CA1F08211742193B4C34D1D61F73131A046A3F178875D5C7710F038AA9AC60188D238469E766AD353ACC297723285B5E0CCDA9476444568A2D925015AA90CE0B8788FEE94586D2B86AA3D354B7B82CE8191BAF8F31D8B69E1E99C58A0024A0FD94223D20ED6FF9D46C02773506849A13E0F7244C8D5AD147935356E0B71AAACFDB5475D20CB29FEBC33150E48DA888119FF60C83B835566B81334074ED6F302DC8E43E373B38EBE313D6E36C884476B8F926921E4F8B5C2
padding = 3AF1CAA7DAF81E33D318BCDF
tmp_aes_key = A098475EB5FA76212B28799C81A67E551E5041119450BD4D13425D8D93A67DA6
tmp_aes_iv = 5482B3418285D824D0290E6831FFDF14002401A480E0117E45F313D98C9FC354</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = DE43A0052EED4D89F25DD670153F18BBB8B1B1F6545C6041210D1439780EDD846E8B7B21FC2AAA324F151AB28734998C132F81588777C110055818C0A7467B58D48F1538D0F694A004CEC4A76306A082443A566399133D1669933E093654F3766300E5A2DB687D2924ACBD70CD00B3237ADFCD23D5B798D972300004CDD23B54FE0CAA4C834BF35A3E9CF9FD538E437AFA5303F6F7AE9839EDA7D43CE94B015AD58F483FB2C2F4A3ABC19584A3A4DF9E0F2A7614D3D5CF920B541B30F0C25340051A031848A2EF1ECD791926A9C0580DB45619D2857FD2C049F4DF34D2E8C748BEFEDE1DF8BF6C550F8C29F92A56FED8E72562465918AB04A3056B2745DF03FAACE1B1AD098859F1952F16BAC69A82EFB020677383AEBFF1CA70F29A0916C4CC51C8895522576C2B650C818DC7F0EBCBD25BA0CFCBCF618E62680A08A5F9B326B32049365D4590BD7575D8BC47A91BDD</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 5C C1 0C 00 56 DB 72 67
0010 | 78 01 00 00 1F 5F 04 F5 1D AA D1 D7 83 10 5C FC
0020 | 50 1D 7D 4A 77 23 66 2F 83 82 C2 DE E5 72 15 9D
0030 | 15 25 A2 9B EC C4 0A 22 FE 50 01 00 DE 43 A0 05
0040 | 2E ED 4D 89 F2 5D D6 70 15 3F 18 BB B8 B1 B1 F6
0050 | 54 5C 60 41 21 0D 14 39 78 0E DD 84 6E 8B 7B 21
0060 | FC 2A AA 32 4F 15 1A B2 87 34 99 8C 13 2F 81 58
0070 | 87 77 C1 10 05 58 18 C0 A7 46 7B 58 D4 8F 15 38
0080 | D0 F6 94 A0 04 CE C4 A7 63 06 A0 82 44 3A 56 63
0090 | 99 13 3D 16 69 93 3E 09 36 54 F3 76 63 00 E5 A2
00A0 | DB 68 7D 29 24 AC BD 70 CD 00 B3 23 7A DF CD 23
00B0 | D5 B7 98 D9 72 30 00 04 CD D2 3B 54 FE 0C AA 4C
00C0 | 83 4B F3 5A 3E 9C F9 FD 53 8E 43 7A FA 53 03 F6
00D0 | F7 AE 98 39 ED A7 D4 3C E9 4B 01 5A D5 8F 48 3F
00E0 | B2 C2 F4 A3 AB C1 95 84 A3 A4 DF 9E 0F 2A 76 14
00F0 | D3 D5 CF 92 0B 54 1B 30 F0 C2 53 40 05 1A 03 18
0100 | 48 A2 EF 1E CD 79 19 26 A9 C0 58 0D B4 56 19 D2
0110 | 85 7F D2 C0 49 F4 DF 34 D2 E8 C7 48 BE FE DE 1D
0120 | F8 BF 6C 55 0F 8C 29 F9 2A 56 FE D8 E7 25 62 46
0130 | 59 18 AB 04 A3 05 6B 27 45 DF 03 FA AC E1 B1 AD
0140 | 09 88 59 F1 95 2F 16 BA C6 9A 82 EF B0 20 67 73
0150 | 83 AE BF F1 CA 70 F2 9A 09 16 C4 CC 51 C8 89 55
0160 | 22 57 6C 2B 65 0C 81 8D C7 F0 EB CB D2 5B A0 CF
0170 | CB CF 61 8E 62 68 0A 08 A5 F9 B3 26 B3 20 49 36
0180 | 5D 45 90 BD 75 75 D8 BC 47 A9 1B DD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>5CC10C0056DB7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100DE43A0052EED4D89F25DD670</code> <code>153F18BBB8B1B1F6545C6041210D1439</code> <code>780EDD846E8B7B21FC2AAA324F151AB2</code> <code>8734998C132F81588777C110055818C0</code> <code>A7467B58D48F1538D0F694A004CEC4A7</code> <code>6306A082443A566399133D1669933E09</code> <code>3654F3766300E5A2DB687D2924ACBD70</code> <code>CD00B3237ADFCD23D5B798D972300004</code> <code>CDD23B54FE0CAA4C834BF35A3E9CF9FD</code> <code>538E437AFA5303F6F7AE9839EDA7D43C</code> <code>E94B015AD58F483FB2C2F4A3ABC19584</code> <code>A3A4DF9E0F2A7614D3D5CF920B541B30</code> <code>F0C25340051A031848A2EF1ECD791926</code> <code>A9C0580DB45619D2857FD2C049F4DF34</code> <code>D2E8C748BEFEDE1DF8BF6C550F8C29F9</code> <code>2A56FED8E72562465918AB04A3056B27</code> <code>45DF03FAACE1B1AD098859F1952F16BA</code> <code>C69A82EFB020677383AEBFF1CA70F29A</code> <code>0916C4CC51C8895522576C2B650C818D</code> <code>C7F0EBCBD25BA0CFCBCF618E62680A08</code> <code>A5F9B326B32049365D4590BD7575D8BC</code><br> <code>47A91BDD</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 55CCADAB295B306E588E2D1DE24A9C37F728A07F6CE174B6CECDC485BF58022F7174F19D74AC3EDA2451F4CC221330B47BD347D6F594DE6E625576148760CEA2B2168FD3113592BDF897DAA204BD5C96AB19FBD0C1EB44945A59AB60E06355E4B09010B6E80FEA2F86FDB673077A519AA9E0910801871BE5B179BC7CE661C7FC0CD93A14C3A2FE2182739A4152D5F6433395007D0F6DE202E366044D5A66FD970148EAC8A82F68C1960CDB9F91DFC916B2DB1A771406D5EB216D9047A36851E7562A09597465E65FC09AABD6B6AC1F0B3523004E16436A2D3CACBEBB21EC9B7EC7CCEF575EB9A6B2802B3B90D8D8463450278F0D9CF012C8E86BC96C7AF22C83</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 EC D8 BA 57 DB 72 67
0010 | 34 00 00 00 34 F7 CB 3B 1D AA D1 D7 83 10 5C FC
0020 | 50 1D 7D 4A 77 23 66 2F 83 82 C2 DE E5 72 15 9D
0030 | 15 25 A2 9B EC C4 0A 22 EE 87 91 E2 CF B7 77 A1
0040 | CB A1 0C BF 83 FE 6B F1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01ECD8BA57DB7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1DAAD1D783105CFC501D7D4A7723662F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8382C2DEE572159D1525A29BECC40A22</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>EE8791E2CFB777A1CBA10CBF83FE6BF1</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

