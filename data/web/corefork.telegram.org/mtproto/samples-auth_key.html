<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 1B 0B 00 BA FB 97 66
0010 | 14 00 00 00 F1 8E 7E BE 9B DE 3C 06 C0 EF 93 D9
0020 | 72 AF 72 00 A0 EA F5 AB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>781B0B00BAFB9766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 10 15 25 BA FB 97 66
0010 | 5C 00 00 00 63 24 16 05 9B DE 3C 06 C0 EF 93 D9
0020 | 72 AF 72 00 A0 EA F5 AB BD 90 9B 93 BE F0 96 1A
0030 | 95 C6 37 5A D6 CF 6E B5 08 29 80 17 E1 62 0E 71
0040 | 83 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01101525BAFB9766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>5C000000</code> (92 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08298017E1620E7183000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2990416409354203523</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2990416409354203523</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2990416409354203523 = 1614906899 * 1851757777</code></p>
<pre><code>p = 1614906899
q = 1851757777</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 29 80 17 E1 62 0E 71 83 00 00 00
0010 | 04 60 41 86 13 00 00 00 04 6E 5F 94 D1 00 00 00
0020 | 9B DE 3C 06 C0 EF 93 D9 72 AF 72 00 A0 EA F5 AB
0030 | BD 90 9B 93 BE F0 96 1A 95 C6 37 5A D6 CF 6E B5
0040 | 4D 3E 1A 6F 33 4E 05 CB BD 96 87 28 CB 0A 0D 78
0050 | 2D F2 3F 59 F9 2F 34 3F 05 BC 15 A2 EC F1 3F 86
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08298017E1620E7183000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2990416409354203523</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0460418613000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1614906899</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046E5F94D1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1851757777</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>4D3E1A6F334E05CBBD968728CB0A0D78</code> <code>2DF23F59F92F343F05BC15A2ECF13F86</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908298017E1620E71830000000460418613000000046E5F94D10000009BDE3C06C0EF93D972AF7200A0EAF5ABBD909B93BEF0961A95C6375AD6CF6EB54D3E1A6F334E05CBBD968728CB0A0D782DF23F59F92F343F05BC15A2ECF13F8602000000
random_padding_bytes = 27B8093BC146B3FE1222F8910D5FAA0866D2831ACD45B8C999F2A99548B1E99F041DCBD5DE28FCF848638ACF52A5CA9B2AF049FDBD923F7768AB3B0473CF774B8D9230A3EDA3A93944AC7ED34B3CD15F908120D455D9FE2CB7B103F6</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 7179356E012AA6DEEB3C68B44AB1212A369EBAA91FCFD005C39F7D132A211B80658041625047A44296E9E4103C286B9E29377870DEB364F9C741835B6002FF284163782C380F7D8D5424B12030626CA59AE9D59F8B8B6A9FDC6E4F56B25CDFB3E6DD942D9467A252A288D9427A14D176498F8E275050E3D94571BB91805154491A938EC2251CC9DC264216BAD171583C94DE1D666AFE7CBACEC319F60E1307B73311EB870D821CC20613BEDC745145F8EBCF4DC430284A05B9FA1EA8A0700C336C85A74BF87484538F3D5ADF6D534E06893577DB1E8C4F0BB4D2EB4A4404EA5EE27FB86457945F2BF42016BDAEF803411C43C0F06339B90D7D2841B3C5C37412</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C 1B 0B 00 BA FB 97 66
0010 | 40 01 00 00 BE E4 12 D7 9B DE 3C 06 C0 EF 93 D9
0020 | 72 AF 72 00 A0 EA F5 AB BD 90 9B 93 BE F0 96 1A
0030 | 95 C6 37 5A D6 CF 6E B5 04 60 41 86 13 00 00 00
0040 | 04 6E 5F 94 D1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 71 79 35 6E 01 2A A6 DE EB 3C 68 B4
0060 | 4A B1 21 2A 36 9E BA A9 1F CF D0 05 C3 9F 7D 13
0070 | 2A 21 1B 80 65 80 41 62 50 47 A4 42 96 E9 E4 10
0080 | 3C 28 6B 9E 29 37 78 70 DE B3 64 F9 C7 41 83 5B
0090 | 60 02 FF 28 41 63 78 2C 38 0F 7D 8D 54 24 B1 20
00A0 | 30 62 6C A5 9A E9 D5 9F 8B 8B 6A 9F DC 6E 4F 56
00B0 | B2 5C DF B3 E6 DD 94 2D 94 67 A2 52 A2 88 D9 42
00C0 | 7A 14 D1 76 49 8F 8E 27 50 50 E3 D9 45 71 BB 91
00D0 | 80 51 54 49 1A 93 8E C2 25 1C C9 DC 26 42 16 BA
00E0 | D1 71 58 3C 94 DE 1D 66 6A FE 7C BA CE C3 19 F6
00F0 | 0E 13 07 B7 33 11 EB 87 0D 82 1C C2 06 13 BE DC
0100 | 74 51 45 F8 EB CF 4D C4 30 28 4A 05 B9 FA 1E A8
0110 | A0 70 0C 33 6C 85 A7 4B F8 74 84 53 8F 3D 5A DF
0120 | 6D 53 4E 06 89 35 77 DB 1E 8C 4F 0B B4 D2 EB 4A
0130 | 44 04 EA 5E E2 7F B8 64 57 94 5F 2B F4 20 16 BD
0140 | AE F8 03 41 1C 43 C0 F0 63 39 B9 0D 7D 28 41 B3
0150 | C5 C3 74 12</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7C1B0B00BAFB9766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0460418613000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1614906899</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046E5F94D1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1851757777</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001007179356E012AA6DEEB3C68B4</code> <code>4AB1212A369EBAA91FCFD005C39F7D13</code> <code>2A211B80658041625047A44296E9E410</code> <code>3C286B9E29377870DEB364F9C741835B</code> <code>6002FF284163782C380F7D8D5424B120</code> <code>30626CA59AE9D59F8B8B6A9FDC6E4F56</code> <code>B25CDFB3E6DD942D9467A252A288D942</code> <code>7A14D176498F8E275050E3D94571BB91</code> <code>805154491A938EC2251CC9DC264216BA</code> <code>D171583C94DE1D666AFE7CBACEC319F6</code> <code>0E1307B73311EB870D821CC20613BEDC</code> <code>745145F8EBCF4DC430284A05B9FA1EA8</code> <code>A0700C336C85A74BF87484538F3D5ADF</code> <code>6D534E06893577DB1E8C4F0BB4D2EB4A</code> <code>4404EA5EE27FB86457945F2BF42016BD</code> <code>AEF803411C43C0F06339B90D7D2841B3</code><br> <code>C5C37412</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 74 0A 03 BB FB 97 66
0010 | 78 02 00 00 5C 07 E8 D0 9B DE 3C 06 C0 EF 93 D9
0020 | 72 AF 72 00 A0 EA F5 AB BD 90 9B 93 BE F0 96 1A
0030 | 95 C6 37 5A D6 CF 6E B5 FE 50 02 00 49 39 5C 7C
0040 | 04 76 90 5C 52 1F 55 EE A8 F1 42 52 EB 0F EF 60
0050 | 81 03 27 62 A6 AE 3C 78 59 7C C7 65 76 37 18 89
0060 | E6 F1 01 6D 6F 3B 84 F8 DA 15 30 A0 55 9A E7 02
0070 | 6D 49 B0 2A 03 20 31 96 D7 75 5D 47 B0 C5 7F 10
0080 | A5 B3 C9 64 E6 3E E6 1E 4B A6 BD 39 B8 82 57 59
0090 | DC 9A 29 F9 B2 A7 06 EC E7 F7 E2 4F 97 B6 C7 1B
00A0 | 0F 0A 1E 02 04 2E 96 34 7E AE 13 2A 20 36 F4 98
00B0 | D0 5D 9E 75 2A 50 B0 5E 35 94 BF 57 B8 8D 9F 48
00C0 | 8F 3B 64 93 B6 7E 95 90 20 1A 78 7E 37 3E C4 4D
00D0 | 10 B1 E9 23 69 D0 16 C9 22 E1 26 3C 43 FF F3 15
00E0 | 3C 47 E7 96 26 A1 4C 29 24 6A D9 78 B6 51 F2 9C
00F0 | 5E B5 5F 63 97 7A 65 95 E4 5F 85 69 E1 5C D9 28
0100 | A9 99 B2 A5 D2 3C 75 EC 5A 16 72 64 9C 5E CE 38
0110 | 8F C3 9F EF B4 E9 C2 BD 0F FA CC 9A C6 D8 4D B4
0120 | 29 AA 8B 8C 8E 18 AD F6 9E 25 12 BF 10 91 1A 9A
0130 | A0 57 7F DA 9B 3B E2 06 3C B6 DF CB 58 43 53 6B
0140 | 34 B3 CC C7 CB 61 47 4A 26 AE 0D 25 E4 F5 32 48
0150 | D8 78 A9 CF 48 7E 66 3D C3 B2 27 30 9E 44 82 15
0160 | F4 39 BC AC D3 96 A0 1B D6 E6 94 24 A2 DA 9B 33
0170 | C4 B6 9C 70 7C 5B 0A BA 87 9E 76 D7 A7 7F 9A CC
0180 | 5A 0B 9E 54 EE 6D E0 5B F2 B9 C2 14 4D AF E1 87
0190 | B7 7D AE C4 9E 0E 32 A9 17 C5 C4 CF A8 59 12 63
01A0 | 97 D7 2E 35 3E 1E CD 42 C4 3C BB F4 2C E0 31 8A
01B0 | 89 63 37 1F 01 DB 00 B6 23 7A 4D FB D8 07 CE BD
01C0 | F0 5A A5 D1 CD 01 85 78 FE EE 49 C9 E1 45 E6 A2
01D0 | 77 04 99 88 A1 AD 29 C4 85 52 2B 83 E9 A2 0F BA
01E0 | D7 8F 92 97 51 62 6C 76 20 5B CA 0E 95 18 78 0D
01F0 | E8 76 9D 29 F9 68 9A D9 8D 6C B0 EA 0D 58 E2 D1
0200 | CB E6 D5 DD 23 1E 16 51 9A EA EF 1B B9 10 C0 1A
0210 | FA 56 CE 8E 09 00 33 A7 08 50 E8 7D D7 53 3E 1C
0220 | CD 33 F7 B0 08 2A 95 E2 24 0D E2 DC 0E E5 60 22
0230 | 51 EA 44 30 80 0C 7B C8 6C 27 45 53 65 94 B8 24
0240 | 1F FE DB B0 A0 BB 7F 9A 3E 09 33 ED 87 38 B7 77
0250 | 14 72 1C AC CB 47 1A 83 0F 03 54 0E 7D 1C A7 B2
0260 | 9E 36 F0 88 A5 91 F6 81 BD 60 0F 67 4D AD 50 64
0270 | 10 4C 25 05 14 37 4C FB 12 46 29 ED 1D 9B 41 B6
0280 | B6 50 6B C1 32 69 5E FA E3 E8 AA 25</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01740A03BBFB9766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020049395C7C0476905C521F55EE</code> <code>A8F14252EB0FEF6081032762A6AE3C78</code> <code>597CC76576371889E6F1016D6F3B84F8</code> <code>DA1530A0559AE7026D49B02A03203196</code> <code>D7755D47B0C57F10A5B3C964E63EE61E</code> <code>4BA6BD39B8825759DC9A29F9B2A706EC</code> <code>E7F7E24F97B6C71B0F0A1E02042E9634</code> <code>7EAE132A2036F498D05D9E752A50B05E</code> <code>3594BF57B88D9F488F3B6493B67E9590</code> <code>201A787E373EC44D10B1E92369D016C9</code> <code>22E1263C43FFF3153C47E79626A14C29</code> <code>246AD978B651F29C5EB55F63977A6595</code> <code>E45F8569E15CD928A999B2A5D23C75EC</code> <code>5A1672649C5ECE388FC39FEFB4E9C2BD</code> <code>0FFACC9AC6D84DB429AA8B8C8E18ADF6</code> <code>9E2512BF10911A9AA0577FDA9B3BE206</code> <code>3CB6DFCB5843536B34B3CCC7CB61474A</code> <code>26AE0D25E4F53248D878A9CF487E663D</code> <code>C3B227309E448215F439BCACD396A01B</code> <code>D6E69424A2DA9B33C4B69C707C5B0ABA</code> <code>879E76D7A77F9ACC5A0B9E54EE6DE05B</code> <code>F2B9C2144DAFE187B77DAEC49E0E32A9</code> <code>17C5C4CFA859126397D72E353E1ECD42</code> <code>C43CBBF42CE0318A8963371F01DB00B6</code> <code>237A4DFBD807CEBDF05AA5D1CD018578</code> <code>FEEE49C9E145E6A277049988A1AD29C4</code> <code>85522B83E9A20FBAD78F929751626C76</code> <code>205BCA0E9518780DE8769D29F9689AD9</code> <code>8D6CB0EA0D58E2D1CBE6D5DD231E1651</code> <code>9AEAEF1BB910C01AFA56CE8E090033A7</code> <code>0850E87DD7533E1CCD33F7B0082A95E2</code> <code>240DE2DC0EE5602251EA4430800C7BC8</code> <code>6C2745536594B8241FFEDBB0A0BB7F9A</code> <code>3E0933ED8738B77714721CACCB471A83</code> <code>0F03540E7D1CA7B29E36F088A591F681</code> <code>BD600F674DAD5064104C250514374CFB</code> <code>124629ED1D9B41B6B6506BC132695EFA</code><br> <code>E3E8AA25</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 49395C7C0476905C521F55EEA8F14252EB0FEF6081032762A6AE3C78597CC76576371889E6F1016D6F3B84F8DA1530A0559AE7026D49B02A03203196D7755D47B0C57F10A5B3C964E63EE61E4BA6BD39B8825759DC9A29F9B2A706ECE7F7E24F97B6C71B0F0A1E02042E96347EAE132A2036F498D05D9E752A50B05E3594BF57B88D9F488F3B6493B67E9590201A787E373EC44D10B1E92369D016C922E1263C43FFF3153C47E79626A14C29246AD978B651F29C5EB55F63977A6595E45F8569E15CD928A999B2A5D23C75EC5A1672649C5ECE388FC39FEFB4E9C2BD0FFACC9AC6D84DB429AA8B8C8E18ADF69E2512BF10911A9AA0577FDA9B3BE2063CB6DFCB5843536B34B3CCC7CB61474A26AE0D25E4F53248D878A9CF487E663DC3B227309E448215F439BCACD396A01BD6E69424A2DA9B33C4B69C707C5B0ABA879E76D7A77F9ACC5A0B9E54EE6DE05BF2B9C2144DAFE187B77DAEC49E0E32A917C5C4CFA859126397D72E353E1ECD42C43CBBF42CE0318A8963371F01DB00B6237A4DFBD807CEBDF05AA5D1CD018578FEEE49C9E145E6A277049988A1AD29C485522B83E9A20FBAD78F929751626C76205BCA0E9518780DE8769D29F9689AD98D6CB0EA0D58E2D1CBE6D5DD231E16519AEAEF1BB910C01AFA56CE8E090033A70850E87DD7533E1CCD33F7B0082A95E2240DE2DC0EE5602251EA4430800C7BC86C2745536594B8241FFEDBB0A0BB7F9A3E0933ED8738B77714721CACCB471A830F03540E7D1CA7B29E36F088A591F681BD600F674DAD5064104C250514374CFB124629ED1D9B41B6B6506BC132695EFAE3E8AA25
tmp_aes_key = 402A22230C9BB7E1AAF6E978F76FCF6E641F1B62DBCA2BF60FC95A1BAD45F56C
tmp_aes_iv = C4BAAC5594932970391D732F1FF2A0CCDBB82F8CC63F5D5BB844A9234D3E1A6F</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = E421EE86B1B2406E293D4250709A03950668500DBA0D89B59BDE3C06C0EF93D972AF7200A0EAF5ABBD909B93BEF0961A95C6375AD6CF6EB503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007ECBBFA544A985176C847DE6DCF401F2B93FFD3F0224B001CAE4C41894A9C7829B3211AB7DD023D603010F9AD6BE132D508874983BE0CFAEA25746E095A904F2364CE7174C27BDC7D4D4BD177A6AB18620E4F8DAE00C7FFC17B20347872FF59C1066F4D6160AB9C5E3C809948192F61A3828773730D66EBD6EF9DFC09A25F68A1E788904730A93DE2A246D9642717B5482814EC15DFFF639A577B07D5C3C1BAA69B69FC587ABCA463E143440F60B6032B884F4947204B11B33A48BCE2F9E910195D499AF07450CCA3844F8421618AA748E737FD26F775E4438CBDBC6BDFCA972476C8AF1C42418D337B939C2A78BA36D320916114928154140D89513C04D8409BBFB9766550555BFD8381C31
answer = BA0D89B59BDE3C06C0EF93D972AF7200A0EAF5ABBD909B93BEF0961A95C6375AD6CF6EB503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007ECBBFA544A985176C847DE6DCF401F2B93FFD3F0224B001CAE4C41894A9C7829B3211AB7DD023D603010F9AD6BE132D508874983BE0CFAEA25746E095A904F2364CE7174C27BDC7D4D4BD177A6AB18620E4F8DAE00C7FFC17B20347872FF59C1066F4D6160AB9C5E3C809948192F61A3828773730D66EBD6EF9DFC09A25F68A1E788904730A93DE2A246D9642717B5482814EC15DFFF639A577B07D5C3C1BAA69B69FC587ABCA463E143440F60B6032B884F4947204B11B33A48BCE2F9E910195D499AF07450CCA3844F8421618AA748E737FD26F775E4438CBDBC6BDFCA972476C8AF1C42418D337B939C2A78BA36D320916114928154140D89513C04D8409BBFB9766550555BFD8381C31</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 9B DE 3C 06 C0 EF 93 D9 72 AF 72 00
0010 | A0 EA F5 AB BD 90 9B 93 BE F0 96 1A 95 C6 37 5A
0020 | D6 CF 6E B5 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 7E CB BF A5 44 A9 85 17 6C 84 7D E6 DC F4 01 F2
0140 | B9 3F FD 3F 02 24 B0 01 CA E4 C4 18 94 A9 C7 82
0150 | 9B 32 11 AB 7D D0 23 D6 03 01 0F 9A D6 BE 13 2D
0160 | 50 88 74 98 3B E0 CF AE A2 57 46 E0 95 A9 04 F2
0170 | 36 4C E7 17 4C 27 BD C7 D4 D4 BD 17 7A 6A B1 86
0180 | 20 E4 F8 DA E0 0C 7F FC 17 B2 03 47 87 2F F5 9C
0190 | 10 66 F4 D6 16 0A B9 C5 E3 C8 09 94 81 92 F6 1A
01A0 | 38 28 77 37 30 D6 6E BD 6E F9 DF C0 9A 25 F6 8A
01B0 | 1E 78 89 04 73 0A 93 DE 2A 24 6D 96 42 71 7B 54
01C0 | 82 81 4E C1 5D FF F6 39 A5 77 B0 7D 5C 3C 1B AA
01D0 | 69 B6 9F C5 87 AB CA 46 3E 14 34 40 F6 0B 60 32
01E0 | B8 84 F4 94 72 04 B1 1B 33 A4 8B CE 2F 9E 91 01
01F0 | 95 D4 99 AF 07 45 0C CA 38 44 F8 42 16 18 AA 74
0200 | 8E 73 7F D2 6F 77 5E 44 38 CB DB C6 BD FC A9 72
0210 | 47 6C 8A F1 C4 24 18 D3 37 B9 39 C2 A7 8B A3 6D
0220 | 32 09 16 11 49 28 15 41 40 D8 95 13 C0 4D 84 09
0230 | BB FB 97 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007ECBBFA544A985176C847DE6</code> <code>DCF401F2B93FFD3F0224B001CAE4C418</code> <code>94A9C7829B3211AB7DD023D603010F9A</code> <code>D6BE132D508874983BE0CFAEA25746E0</code> <code>95A904F2364CE7174C27BDC7D4D4BD17</code> <code>7A6AB18620E4F8DAE00C7FFC17B20347</code> <code>872FF59C1066F4D6160AB9C5E3C80994</code> <code>8192F61A3828773730D66EBD6EF9DFC0</code> <code>9A25F68A1E788904730A93DE2A246D96</code> <code>42717B5482814EC15DFFF639A577B07D</code> <code>5C3C1BAA69B69FC587ABCA463E143440</code> <code>F60B6032B884F4947204B11B33A48BCE</code> <code>2F9E910195D499AF07450CCA3844F842</code> <code>1618AA748E737FD26F775E4438CBDBC6</code> <code>BDFCA972476C8AF1C42418D337B939C2</code> <code>A78BA36D320916114928154140D89513</code><br> <code>C04D8409</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>BBFB9766</code> (1721236411 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = ECA740BED253508A350F5B87AEFE93FEE28E9C67872CF4F6C005A7DEF3525D41A649A046AD663092159DABA47492882A8F8067449CE0B8D2DBD4E0021DB82F7C51A3F4641862C0D95876D5862F98DD0A4AB9D305A044F63DE3271B3C6ECF036255784EACC35641B56C6BBED8E90984C79D422666E5EC045EAFED87D223FD79CE5CCE5783DDB6EF22F2DCD7FF660D4DBE84A124338C91C6672047630B4A470A2D50FFDB980FFAF8E5658E4D29A4D66D0BBA52891EDAFF77B3EC302740E3CA8FCD1A8AC8876C3124FFFD51978FD65E2C28766D51E8493C81268447F5FA54EE06BD1F5FD43E752C3119A6216388407AA612699770BB1E58DB5084947688C8A69CC9</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 3C3BB4E4EABA39BC1998EC5F9678B04B287EEA079DBD277A727BB453DB1A3CFE6AA62178E3269DD6B3045F65EDC6D5D741A29EF8B098B914D07B2E65B556EAD4BDECA732A609C0C537616DB5E9995031FE5BCFBE3A9C9619995AC094D3A141987DC37FF28D0544D8D4D3FF123CD43A1B337077B1680D0B3CED329447D16B8A48916791567473277F78919CC2EBEA41351E7DFA3BB9F041026996F6C959268CFEA786A5158A9F1D1A59F5BB43852479AC3CFB5CA59DF5FD6627867C81D6E4524A0A2C8228A4E645CD5680CF3B74CD1D484F33FB4C9C2C0AEE5ACF516401041264C047F339D03A60329C20EEFF38F6C2D324DEED3807C8BE0B2C6C013AE14F40B9</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 9B DE 3C 06 C0 EF 93 D9 72 AF 72 00
0010 | A0 EA F5 AB BD 90 9B 93 BE F0 96 1A 95 C6 37 5A
0020 | D6 CF 6E B5 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 3C 3B B4 E4 EA BA 39 BC 19 98 EC 5F 96 78 B0 4B
0040 | 28 7E EA 07 9D BD 27 7A 72 7B B4 53 DB 1A 3C FE
0050 | 6A A6 21 78 E3 26 9D D6 B3 04 5F 65 ED C6 D5 D7
0060 | 41 A2 9E F8 B0 98 B9 14 D0 7B 2E 65 B5 56 EA D4
0070 | BD EC A7 32 A6 09 C0 C5 37 61 6D B5 E9 99 50 31
0080 | FE 5B CF BE 3A 9C 96 19 99 5A C0 94 D3 A1 41 98
0090 | 7D C3 7F F2 8D 05 44 D8 D4 D3 FF 12 3C D4 3A 1B
00A0 | 33 70 77 B1 68 0D 0B 3C ED 32 94 47 D1 6B 8A 48
00B0 | 91 67 91 56 74 73 27 7F 78 91 9C C2 EB EA 41 35
00C0 | 1E 7D FA 3B B9 F0 41 02 69 96 F6 C9 59 26 8C FE
00D0 | A7 86 A5 15 8A 9F 1D 1A 59 F5 BB 43 85 24 79 AC
00E0 | 3C FB 5C A5 9D F5 FD 66 27 86 7C 81 D6 E4 52 4A
00F0 | 0A 2C 82 28 A4 E6 45 CD 56 80 CF 3B 74 CD 1D 48
0100 | 4F 33 FB 4C 9C 2C 0A EE 5A CF 51 64 01 04 12 64
0110 | C0 47 F3 39 D0 3A 60 32 9C 20 EE FF 38 F6 C2 D3
0120 | 24 DE ED 38 07 C8 BE 0B 2C 6C 01 3A E1 4F 40 B9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001003C3BB4E4EABA39BC1998EC5F</code> <code>9678B04B287EEA079DBD277A727BB453</code> <code>DB1A3CFE6AA62178E3269DD6B3045F65</code> <code>EDC6D5D741A29EF8B098B914D07B2E65</code> <code>B556EAD4BDECA732A609C0C537616DB5</code> <code>E9995031FE5BCFBE3A9C9619995AC094</code> <code>D3A141987DC37FF28D0544D8D4D3FF12</code> <code>3CD43A1B337077B1680D0B3CED329447</code> <code>D16B8A48916791567473277F78919CC2</code> <code>EBEA41351E7DFA3BB9F041026996F6C9</code> <code>59268CFEA786A5158A9F1D1A59F5BB43</code> <code>852479AC3CFB5CA59DF5FD6627867C81</code> <code>D6E4524A0A2C8228A4E645CD5680CF3B</code> <code>74CD1D484F33FB4C9C2C0AEE5ACF5164</code> <code>01041264C047F339D03A60329C20EEFF</code> <code>38F6C2D324DEED3807C8BE0B2C6C013A</code><br> <code>E14F40B9</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643669BDE3C06C0EF93D972AF7200A0EAF5ABBD909B93BEF0961A95C6375AD6CF6EB50000000000000000FE0001003C3BB4E4EABA39BC1998EC5F9678B04B287EEA079DBD277A727BB453DB1A3CFE6AA62178E3269DD6B3045F65EDC6D5D741A29EF8B098B914D07B2E65B556EAD4BDECA732A609C0C537616DB5E9995031FE5BCFBE3A9C9619995AC094D3A141987DC37FF28D0544D8D4D3FF123CD43A1B337077B1680D0B3CED329447D16B8A48916791567473277F78919CC2EBEA41351E7DFA3BB9F041026996F6C959268CFEA786A5158A9F1D1A59F5BB43852479AC3CFB5CA59DF5FD6627867C81D6E4524A0A2C8228A4E645CD5680CF3B74CD1D484F33FB4C9C2C0AEE5ACF516401041264C047F339D03A60329C20EEFF38F6C2D324DEED3807C8BE0B2C6C013AE14F40B9
padding = 8F6DE24A7AA3B5EE1B038467
tmp_aes_key = 402A22230C9BB7E1AAF6E978F76FCF6E641F1B62DBCA2BF60FC95A1BAD45F56C
tmp_aes_iv = C4BAAC5594932970391D732F1FF2A0CCDBB82F8CC63F5D5BB844A9234D3E1A6F</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = CE240137B24A93AE76D0C04F93324AEFF69599DA627DAD709B13D94B611018AA67715A576F041DB9E5E84378C2B6DDC8C3CF7B58E2DB9812F71C35137248ED5575B57D14780694B14CEC2B3DAC60612BC07232929E93B1F32F3AB49096BB27282224BD180B07E3D274BB7BCFF7063CF55347B798D45F771AD5A6BF6052918082396CDE82EF3719C80BAC18BEA096AB59A8B707242BB0315FF81AFE0A08F9D47C7B7236A5C67D4F98C4514BD3F7DCF301BB1DA4A7DDE5138BBC2451FD2513A33FD21D4C52D5F0250CFB50173192AF10C8BF347F6CB44B43A504C4010E25242B082FCBCC04AF5BE1BA881AC97BD3F4E9C82C734CD14B731B3324E2FAE62203AC2B28E0956C7EBE30AD0B59A5AB983E32127CB78105AF487A258BA69D9F098AFED871CFAD0AFBDB3D3FF67B69875A716CBE3413ECCC3A1E9ECB0304DABCA8B7699667EEAE1847755EA892579E60F62A04EC</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC FA 0C 00 BB FB 97 66
0010 | 78 01 00 00 1F 5F 04 F5 9B DE 3C 06 C0 EF 93 D9
0020 | 72 AF 72 00 A0 EA F5 AB BD 90 9B 93 BE F0 96 1A
0030 | 95 C6 37 5A D6 CF 6E B5 FE 50 01 00 CE 24 01 37
0040 | B2 4A 93 AE 76 D0 C0 4F 93 32 4A EF F6 95 99 DA
0050 | 62 7D AD 70 9B 13 D9 4B 61 10 18 AA 67 71 5A 57
0060 | 6F 04 1D B9 E5 E8 43 78 C2 B6 DD C8 C3 CF 7B 58
0070 | E2 DB 98 12 F7 1C 35 13 72 48 ED 55 75 B5 7D 14
0080 | 78 06 94 B1 4C EC 2B 3D AC 60 61 2B C0 72 32 92
0090 | 9E 93 B1 F3 2F 3A B4 90 96 BB 27 28 22 24 BD 18
00A0 | 0B 07 E3 D2 74 BB 7B CF F7 06 3C F5 53 47 B7 98
00B0 | D4 5F 77 1A D5 A6 BF 60 52 91 80 82 39 6C DE 82
00C0 | EF 37 19 C8 0B AC 18 BE A0 96 AB 59 A8 B7 07 24
00D0 | 2B B0 31 5F F8 1A FE 0A 08 F9 D4 7C 7B 72 36 A5
00E0 | C6 7D 4F 98 C4 51 4B D3 F7 DC F3 01 BB 1D A4 A7
00F0 | DD E5 13 8B BC 24 51 FD 25 13 A3 3F D2 1D 4C 52
0100 | D5 F0 25 0C FB 50 17 31 92 AF 10 C8 BF 34 7F 6C
0110 | B4 4B 43 A5 04 C4 01 0E 25 24 2B 08 2F CB CC 04
0120 | AF 5B E1 BA 88 1A C9 7B D3 F4 E9 C8 2C 73 4C D1
0130 | 4B 73 1B 33 24 E2 FA E6 22 03 AC 2B 28 E0 95 6C
0140 | 7E BE 30 AD 0B 59 A5 AB 98 3E 32 12 7C B7 81 05
0150 | AF 48 7A 25 8B A6 9D 9F 09 8A FE D8 71 CF AD 0A
0160 | FB DB 3D 3F F6 7B 69 87 5A 71 6C BE 34 13 EC CC
0170 | 3A 1E 9E CB 03 04 DA BC A8 B7 69 96 67 EE AE 18
0180 | 47 75 5E A8 92 57 9E 60 F6 2A 04 EC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CCFA0C00BBFB9766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100CE240137B24A93AE76D0C04F</code> <code>93324AEFF69599DA627DAD709B13D94B</code> <code>611018AA67715A576F041DB9E5E84378</code> <code>C2B6DDC8C3CF7B58E2DB9812F71C3513</code> <code>7248ED5575B57D14780694B14CEC2B3D</code> <code>AC60612BC07232929E93B1F32F3AB490</code> <code>96BB27282224BD180B07E3D274BB7BCF</code> <code>F7063CF55347B798D45F771AD5A6BF60</code> <code>52918082396CDE82EF3719C80BAC18BE</code> <code>A096AB59A8B707242BB0315FF81AFE0A</code> <code>08F9D47C7B7236A5C67D4F98C4514BD3</code> <code>F7DCF301BB1DA4A7DDE5138BBC2451FD</code> <code>2513A33FD21D4C52D5F0250CFB501731</code> <code>92AF10C8BF347F6CB44B43A504C4010E</code> <code>25242B082FCBCC04AF5BE1BA881AC97B</code> <code>D3F4E9C82C734CD14B731B3324E2FAE6</code> <code>2203AC2B28E0956C7EBE30AD0B59A5AB</code> <code>983E32127CB78105AF487A258BA69D9F</code> <code>098AFED871CFAD0AFBDB3D3FF67B6987</code> <code>5A716CBE3413ECCC3A1E9ECB0304DABC</code> <code>A8B7699667EEAE1847755EA892579E60</code><br> <code>F62A04EC</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 4A0C761FAB31351AD267B26423AEBE448D930CF1B5C19EBCC52CCBE6D4ADDEE159F2BB5029327012AF93E4CE200F411C70EBAD273045597698C376FC42E4A166AF2555B50BBAA5CFA06A0FB2480DC63F781E790D310D43A5A72FEFEDBF3B6FF74C98E7D16E79974044D11226231A840F726F76ED7B99BA8EDBEE804855D00A976EE6B61FE445B2DBF3738F6065D7977C53AF1B57543129BCA14B152DB1E134AFCD2F361E40AF6C2A38D73727A02E5EE03E2197BCF6ACAB90066CCABB24A031E9259E033EC57F20D84C550A325493E85CF0EE745D483F0CE6065F1E71CF259ED89EA8F17E93237321BC04B0A1339B6FD57BD73AD54D06326A9599DE93F30F618F</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F4 C0 07 BC FB 97 66
0010 | 6C 00 00 00 34 F7 CB 3B 9B DE 3C 06 C0 EF 93 D9
0020 | 72 AF 72 00 A0 EA F5 AB BD 90 9B 93 BE F0 96 1A
0030 | 95 C6 37 5A D6 CF 6E B5 03 50 4F 6F 45 00 D7 AE
0040 | 17 0C 71 EE 2E 61 36 6C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F4C007BCFB9766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>6C000000</code> (108 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9BDE3C06C0EF93D972AF7200A0EAF5AB</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BD909B93BEF0961A95C6375AD6CF6EB5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>03504F6F4500D7AE170C71EE2E61366C</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

