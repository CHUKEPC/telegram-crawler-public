<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 98 B3 03 00 E0 7A 81 66
0010 | 14 00 00 00 F1 8E 7E BE E5 13 A2 1E BE 09 99 3F
0020 | 92 7E B1 38 D8 5B 28 87</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>98B30300E07A8166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 4B 47 E0 7A 81 66
0010 | 80 00 00 00 63 24 16 05 E5 13 A2 1E BE 09 99 3F
0020 | 92 7E B1 38 D8 5B 28 87 20 8C D9 6C 6E 2E A8 51
0030 | CC 03 32 86 E4 9C 99 E8 08 13 58 38 91 7A 18 0D
0040 | 95 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01604B47E07A8166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>80000000</code> (128 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08135838917A180D95000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1393926282140978581</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1393926282140978581</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1393926282140978581 = 1068871513 * 1304110237</code></p>
<pre><code>p = 1068871513
q = 1304110237</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 13 58 38 91 7A 18 0D 95 00 00 00
0010 | 04 3F B5 AF 59 00 00 00 04 4D BB 24 9D 00 00 00
0020 | E5 13 A2 1E BE 09 99 3F 92 7E B1 38 D8 5B 28 87
0030 | 20 8C D9 6C 6E 2E A8 51 CC 03 32 86 E4 9C 99 E8
0040 | A9 5E 45 9C F0 31 60 8C F1 4A 59 23 05 A3 2D 8D
0050 | B7 9E A2 79 FE 81 78 7A 01 9A 35 8D 4D 35 DD C6
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08135838917A180D95000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1393926282140978581</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043FB5AF59000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1068871513</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044DBB249D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1304110237</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>A95E459CF031608CF14A592305A32D8D</code> <code>B79EA279FE81787A019A358D4D35DDC6</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908135838917A180D95000000043FB5AF59000000044DBB249D000000E513A21EBE09993F927EB138D85B2887208CD96C6E2EA851CC033286E49C99E8A95E459CF031608CF14A592305A32D8DB79EA279FE81787A019A358D4D35DDC602000000
random_padding_bytes = D8C09583EA4ADB0247123F26F250522B8E0B2D6E39417C454EE9E3D0F0AAF926554F8BBA26D35B12FB3AE2FF7F02A5BA049AA04BE4C19308C4C01CDB55785B46C40EAAFD1EFF1E9DB88337C0D24D5A0B6AA9E18AC10B6FD1E32FD52D</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 6C642CD629ABA36B314453C6F3788A4F0BD3590AE3E37352874E4C96E272F85A7E097CB6D8B7F902C4B32273CD88DBA77F936F84B86A402F720CBF4C1137B32439D6474D3A103E1EAE3D3E37C49FC4CBEE3ED4A953790F8EB01921203BE521BC909D3167C1598A45D5FAE98F988CF3581B85F107F29C194754CC4357AE44ED60672CC93821995759AF9F654CA33A36EF117C59A2F3ABC7BB7D5C9A20A37853C59858C77E7CFA1761C2551161D1439BB00AD9C56F783CB1A11D0FEF236800F223846C9A8293C1F21DEFB71BB6BD76405DE10F0182E4A30F4A858FE4681F46289C2CE371311B3CC1351DAA2BCB8D4433BA588182A555ED3B159FDAB53391373954</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 60 DF 03 00 E0 7A 81 66
0010 | 40 01 00 00 BE E4 12 D7 E5 13 A2 1E BE 09 99 3F
0020 | 92 7E B1 38 D8 5B 28 87 20 8C D9 6C 6E 2E A8 51
0030 | CC 03 32 86 E4 9C 99 E8 04 3F B5 AF 59 00 00 00
0040 | 04 4D BB 24 9D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 6C 64 2C D6 29 AB A3 6B 31 44 53 C6
0060 | F3 78 8A 4F 0B D3 59 0A E3 E3 73 52 87 4E 4C 96
0070 | E2 72 F8 5A 7E 09 7C B6 D8 B7 F9 02 C4 B3 22 73
0080 | CD 88 DB A7 7F 93 6F 84 B8 6A 40 2F 72 0C BF 4C
0090 | 11 37 B3 24 39 D6 47 4D 3A 10 3E 1E AE 3D 3E 37
00A0 | C4 9F C4 CB EE 3E D4 A9 53 79 0F 8E B0 19 21 20
00B0 | 3B E5 21 BC 90 9D 31 67 C1 59 8A 45 D5 FA E9 8F
00C0 | 98 8C F3 58 1B 85 F1 07 F2 9C 19 47 54 CC 43 57
00D0 | AE 44 ED 60 67 2C C9 38 21 99 57 59 AF 9F 65 4C
00E0 | A3 3A 36 EF 11 7C 59 A2 F3 AB C7 BB 7D 5C 9A 20
00F0 | A3 78 53 C5 98 58 C7 7E 7C FA 17 61 C2 55 11 61
0100 | D1 43 9B B0 0A D9 C5 6F 78 3C B1 A1 1D 0F EF 23
0110 | 68 00 F2 23 84 6C 9A 82 93 C1 F2 1D EF B7 1B B6
0120 | BD 76 40 5D E1 0F 01 82 E4 A3 0F 4A 85 8F E4 68
0130 | 1F 46 28 9C 2C E3 71 31 1B 3C C1 35 1D AA 2B CB
0140 | 8D 44 33 BA 58 81 82 A5 55 ED 3B 15 9F DA B5 33
0150 | 91 37 39 54</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>60DF0300E07A8166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043FB5AF59000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1068871513</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044DBB249D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1304110237</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001006C642CD629ABA36B314453C6</code> <code>F3788A4F0BD3590AE3E37352874E4C96</code> <code>E272F85A7E097CB6D8B7F902C4B32273</code> <code>CD88DBA77F936F84B86A402F720CBF4C</code> <code>1137B32439D6474D3A103E1EAE3D3E37</code> <code>C49FC4CBEE3ED4A953790F8EB0192120</code> <code>3BE521BC909D3167C1598A45D5FAE98F</code> <code>988CF3581B85F107F29C194754CC4357</code> <code>AE44ED60672CC93821995759AF9F654C</code> <code>A33A36EF117C59A2F3ABC7BB7D5C9A20</code> <code>A37853C59858C77E7CFA1761C2551161</code> <code>D1439BB00AD9C56F783CB1A11D0FEF23</code> <code>6800F223846C9A8293C1F21DEFB71BB6</code> <code>BD76405DE10F0182E4A30F4A858FE468</code> <code>1F46289C2CE371311B3CC1351DAA2BCB</code> <code>8D4433BA588182A555ED3B159FDAB533</code><br> <code>91373954</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C0 8E 01 E1 7A 81 66
0010 | 78 02 00 00 5C 07 E8 D0 E5 13 A2 1E BE 09 99 3F
0020 | 92 7E B1 38 D8 5B 28 87 20 8C D9 6C 6E 2E A8 51
0030 | CC 03 32 86 E4 9C 99 E8 FE 50 02 00 68 FC 5F BB
0040 | 57 8C CB D0 EB 73 57 A6 55 48 20 75 3B F9 EF 11
0050 | 79 55 67 43 9E 7C DE 07 52 3F 9A 51 44 5B 2A BA
0060 | 4E B2 4D FF DA DE CF 4F EE 2F AD 49 72 71 4E 35
0070 | FC 82 C3 87 C1 23 BE 80 72 0B 71 58 C7 DB 5E 9C
0080 | 54 EF D5 3F F5 55 14 45 56 A7 5B 8F 91 61 A1 5A
0090 | 50 23 CE 68 2F 13 08 E3 44 0D B9 E9 AC DC 7F 4E
00A0 | 83 52 C0 1C 23 8C 67 B7 5C F9 63 2C 33 75 70 09
00B0 | 70 AA C2 8A BD E8 DB A9 5E 9F 7C DC CB CB 24 EC
00C0 | FB B3 76 7E 28 51 48 7F 3D CA A2 6A 59 3E F5 4C
00D0 | A8 9E 36 2C 41 06 12 03 DC 26 EB D4 27 37 EB B2
00E0 | AF 76 A7 75 97 23 C1 A1 7D D5 28 76 57 92 F0 C8
00F0 | 2F 00 8C E2 A4 D7 C0 2D E0 B4 71 AE 80 77 FF F8
0100 | AA 4C EE 24 99 53 3E 31 4E 88 6E FE 69 44 CD E7
0110 | 3D C9 29 CF 0A 83 43 D5 10 D6 DA 0A CF E2 E8 EE
0120 | 66 48 3E C1 E6 C7 67 19 1C 1F 0C 05 BF D9 91 76
0130 | C1 36 31 D0 7A 6B DF 1B 7C 6C 94 5F 7B A5 EA 70
0140 | EA 08 89 5A 69 12 64 94 6B 00 1D F4 F7 8A 5B 77
0150 | 87 C3 0B 4D 95 AC 8C D4 68 8E EC 52 93 6E A8 46
0160 | FE 4D E6 27 A0 55 1F AD 23 2F 51 CF B8 2C AB E3
0170 | FE 45 26 6F 7D 2B BE F4 BB C8 BE CA 5B 0B 12 13
0180 | CD 97 38 CE AC BF 05 76 AF 54 80 35 8E A7 A5 75
0190 | 83 CC 71 40 35 7F E6 2F 8C 12 86 56 E2 90 16 7F
01A0 | 64 DD 14 58 4F BB 3E 03 81 AD E2 AA 7A D7 12 E8
01B0 | D6 FC CC 1B 3D 23 17 7D 02 18 0B 5A BA FF FA 9B
01C0 | 3E 23 FE FF B2 50 4B C3 9A 99 74 DA CD 0B 91 D9
01D0 | 8E 73 E9 22 D9 60 DF 90 0D 87 56 A7 2C C4 10 16
01E0 | 09 D7 18 5A BD 3E 51 AB 34 45 2A 94 92 A5 CA BF
01F0 | 00 B8 66 D1 24 40 CD 32 40 F1 5A DB A5 D8 15 31
0200 | 77 1E AC 01 3C BB 1F E8 95 E0 71 4A 4D 39 B3 7F
0210 | 4C DB 30 8F 3D 81 CD 39 1D 78 03 A0 14 15 ED 5E
0220 | A0 9A 3F 9E 64 E7 1F DB 5F 68 C4 53 1F CD 21 16
0230 | 6D BE 45 5A C2 E5 40 48 2A 6B 2F 9C 82 76 D3 8B
0240 | B5 16 50 7E 12 FC 6C FF A3 18 B2 99 12 0C 7F C1
0250 | 76 14 F2 99 34 9F 6E B4 5A 9A C0 DB 0D 7D 5B 80
0260 | EE 42 BA C4 20 DD 66 7E 1A 36 D1 C9 BF 84 C8 D5
0270 | A4 9B E6 A4 4F B1 84 3B 2A D3 5E 2A F2 14 80 30
0280 | 85 E2 0D 18 B9 70 5F BB F1 90 00 4E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C08E01E17A8166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020068FC5FBB578CCBD0EB7357A6</code> <code>554820753BF9EF11795567439E7CDE07</code> <code>523F9A51445B2ABA4EB24DFFDADECF4F</code> <code>EE2FAD4972714E35FC82C387C123BE80</code> <code>720B7158C7DB5E9C54EFD53FF5551445</code> <code>56A75B8F9161A15A5023CE682F1308E3</code> <code>440DB9E9ACDC7F4E8352C01C238C67B7</code> <code>5CF9632C3375700970AAC28ABDE8DBA9</code> <code>5E9F7CDCCBCB24ECFBB3767E2851487F</code> <code>3DCAA26A593EF54CA89E362C41061203</code> <code>DC26EBD42737EBB2AF76A7759723C1A1</code> <code>7DD528765792F0C82F008CE2A4D7C02D</code> <code>E0B471AE8077FFF8AA4CEE2499533E31</code> <code>4E886EFE6944CDE73DC929CF0A8343D5</code> <code>10D6DA0ACFE2E8EE66483EC1E6C76719</code> <code>1C1F0C05BFD99176C13631D07A6BDF1B</code> <code>7C6C945F7BA5EA70EA08895A69126494</code> <code>6B001DF4F78A5B7787C30B4D95AC8CD4</code> <code>688EEC52936EA846FE4DE627A0551FAD</code> <code>232F51CFB82CABE3FE45266F7D2BBEF4</code> <code>BBC8BECA5B0B1213CD9738CEACBF0576</code> <code>AF5480358EA7A57583CC7140357FE62F</code> <code>8C128656E290167F64DD14584FBB3E03</code> <code>81ADE2AA7AD712E8D6FCCC1B3D23177D</code> <code>02180B5ABAFFFA9B3E23FEFFB2504BC3</code> <code>9A9974DACD0B91D98E73E922D960DF90</code> <code>0D8756A72CC4101609D7185ABD3E51AB</code> <code>34452A9492A5CABF00B866D12440CD32</code> <code>40F15ADBA5D81531771EAC013CBB1FE8</code> <code>95E0714A4D39B37F4CDB308F3D81CD39</code> <code>1D7803A01415ED5EA09A3F9E64E71FDB</code> <code>5F68C4531FCD21166DBE455AC2E54048</code> <code>2A6B2F9C8276D38BB516507E12FC6CFF</code> <code>A318B299120C7FC17614F299349F6EB4</code> <code>5A9AC0DB0D7D5B80EE42BAC420DD667E</code> <code>1A36D1C9BF84C8D5A49BE6A44FB1843B</code> <code>2AD35E2AF214803085E20D18B9705FBB</code><br> <code>F190004E</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 68FC5FBB578CCBD0EB7357A6554820753BF9EF11795567439E7CDE07523F9A51445B2ABA4EB24DFFDADECF4FEE2FAD4972714E35FC82C387C123BE80720B7158C7DB5E9C54EFD53FF555144556A75B8F9161A15A5023CE682F1308E3440DB9E9ACDC7F4E8352C01C238C67B75CF9632C3375700970AAC28ABDE8DBA95E9F7CDCCBCB24ECFBB3767E2851487F3DCAA26A593EF54CA89E362C41061203DC26EBD42737EBB2AF76A7759723C1A17DD528765792F0C82F008CE2A4D7C02DE0B471AE8077FFF8AA4CEE2499533E314E886EFE6944CDE73DC929CF0A8343D510D6DA0ACFE2E8EE66483EC1E6C767191C1F0C05BFD99176C13631D07A6BDF1B7C6C945F7BA5EA70EA08895A691264946B001DF4F78A5B7787C30B4D95AC8CD4688EEC52936EA846FE4DE627A0551FAD232F51CFB82CABE3FE45266F7D2BBEF4BBC8BECA5B0B1213CD9738CEACBF0576AF5480358EA7A57583CC7140357FE62F8C128656E290167F64DD14584FBB3E0381ADE2AA7AD712E8D6FCCC1B3D23177D02180B5ABAFFFA9B3E23FEFFB2504BC39A9974DACD0B91D98E73E922D960DF900D8756A72CC4101609D7185ABD3E51AB34452A9492A5CABF00B866D12440CD3240F15ADBA5D81531771EAC013CBB1FE895E0714A4D39B37F4CDB308F3D81CD391D7803A01415ED5EA09A3F9E64E71FDB5F68C4531FCD21166DBE455AC2E540482A6B2F9C8276D38BB516507E12FC6CFFA318B299120C7FC17614F299349F6EB45A9AC0DB0D7D5B80EE42BAC420DD667E1A36D1C9BF84C8D5A49BE6A44FB1843B2AD35E2AF214803085E20D18B9705FBBF190004E
tmp_aes_key = CF23EC44DE45FD3A03AA827E598B3AB47B8EE0B043D64FBD235703D21496F977
tmp_aes_iv = D1ADA3FBAAE77657362A1628CE31D6240C5754B126BA2E3FCB1ED87FA95E459C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1E460FA44597896E051E84B959EF39ADF380E9D2BA0D89B5E513A21EBE09993F927EB138D85B2887208CD96C6E2EA851CC033286E49C99E803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100989EDFACA03A3B00314641D862F03CEC6022E965E518756D07C9C06EF0BFEB09E0220EF22566DB9B3D9DF3AA87B2B12F2DC70A734AE54AF7EC37CBDFD7ECFF99022B71DFABF4A8E99890411099227EE3B6B56ED24479A9867F815228EAA95EC40A8FB66F764D2FAE766FED04752DCD491993A941A9D716D0BDFD65C2FDAAEA1D476E4C81FE01E86B01A6C3F9C03225D4920687122847D8584AA4F21317E66D0C661B51E71DB52DB38CEC046BB9636F66A7FAA0AA96186848F36AA57F86076553A826F707A9802D84C62C1B8D27E6A2FB871B2BBCCB10EC26BEB970F09B85A6384F8A992640ACF2A02F8AA69A52FD0DC220E34E7237AD2815F1A95CF1BF4615C4E17A8166CEAC715B148B50B2
answer = BA0D89B5E513A21EBE09993F927EB138D85B2887208CD96C6E2EA851CC033286E49C99E803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100989EDFACA03A3B00314641D862F03CEC6022E965E518756D07C9C06EF0BFEB09E0220EF22566DB9B3D9DF3AA87B2B12F2DC70A734AE54AF7EC37CBDFD7ECFF99022B71DFABF4A8E99890411099227EE3B6B56ED24479A9867F815228EAA95EC40A8FB66F764D2FAE766FED04752DCD491993A941A9D716D0BDFD65C2FDAAEA1D476E4C81FE01E86B01A6C3F9C03225D4920687122847D8584AA4F21317E66D0C661B51E71DB52DB38CEC046BB9636F66A7FAA0AA96186848F36AA57F86076553A826F707A9802D84C62C1B8D27E6A2FB871B2BBCCB10EC26BEB970F09B85A6384F8A992640ACF2A02F8AA69A52FD0DC220E34E7237AD2815F1A95CF1BF4615C4E17A8166CEAC715B148B50B2</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E5 13 A2 1E BE 09 99 3F 92 7E B1 38
0010 | D8 5B 28 87 20 8C D9 6C 6E 2E A8 51 CC 03 32 86
0020 | E4 9C 99 E8 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 98 9E DF AC A0 3A 3B 00 31 46 41 D8 62 F0 3C EC
0140 | 60 22 E9 65 E5 18 75 6D 07 C9 C0 6E F0 BF EB 09
0150 | E0 22 0E F2 25 66 DB 9B 3D 9D F3 AA 87 B2 B1 2F
0160 | 2D C7 0A 73 4A E5 4A F7 EC 37 CB DF D7 EC FF 99
0170 | 02 2B 71 DF AB F4 A8 E9 98 90 41 10 99 22 7E E3
0180 | B6 B5 6E D2 44 79 A9 86 7F 81 52 28 EA A9 5E C4
0190 | 0A 8F B6 6F 76 4D 2F AE 76 6F ED 04 75 2D CD 49
01A0 | 19 93 A9 41 A9 D7 16 D0 BD FD 65 C2 FD AA EA 1D
01B0 | 47 6E 4C 81 FE 01 E8 6B 01 A6 C3 F9 C0 32 25 D4
01C0 | 92 06 87 12 28 47 D8 58 4A A4 F2 13 17 E6 6D 0C
01D0 | 66 1B 51 E7 1D B5 2D B3 8C EC 04 6B B9 63 6F 66
01E0 | A7 FA A0 AA 96 18 68 48 F3 6A A5 7F 86 07 65 53
01F0 | A8 26 F7 07 A9 80 2D 84 C6 2C 1B 8D 27 E6 A2 FB
0200 | 87 1B 2B BC CB 10 EC 26 BE B9 70 F0 9B 85 A6 38
0210 | 4F 8A 99 26 40 AC F2 A0 2F 8A A6 9A 52 FD 0D C2
0220 | 20 E3 4E 72 37 AD 28 15 F1 A9 5C F1 BF 46 15 C4
0230 | E1 7A 81 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100989EDFACA03A3B00314641D8</code> <code>62F03CEC6022E965E518756D07C9C06E</code> <code>F0BFEB09E0220EF22566DB9B3D9DF3AA</code> <code>87B2B12F2DC70A734AE54AF7EC37CBDF</code> <code>D7ECFF99022B71DFABF4A8E998904110</code> <code>99227EE3B6B56ED24479A9867F815228</code> <code>EAA95EC40A8FB66F764D2FAE766FED04</code> <code>752DCD491993A941A9D716D0BDFD65C2</code> <code>FDAAEA1D476E4C81FE01E86B01A6C3F9</code> <code>C03225D4920687122847D8584AA4F213</code> <code>17E66D0C661B51E71DB52DB38CEC046B</code> <code>B9636F66A7FAA0AA96186848F36AA57F</code> <code>86076553A826F707A9802D84C62C1B8D</code> <code>27E6A2FB871B2BBCCB10EC26BEB970F0</code> <code>9B85A6384F8A992640ACF2A02F8AA69A</code> <code>52FD0DC220E34E7237AD2815F1A95CF1</code><br> <code>BF4615C4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E17A8166</code> (1719761633 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 4A32C267CECCB4D454FF0BB7F67493DEF82A37E3AD8BD4A81A5FE1604D3E353EED0FA42751AEE5C81DFE9A685BEFBD4ABA6974D03A4C176FA4C4E4D62A94C0A076EF8CAA886D8544555116B0CCACDC6D701F795E4C6CA4F4629B7E624C5C2AFF35B831B8B919435EDBA13ABD6EA94A47F828CE7D4D7308E98DC462B8569E4E268D91BA230572CF94CDEA8AB2C925331E3A4A2D602A13DF2FE0091AFF7C315AC2F7CAE7D4D432F362767A9DA8CA149EAF858CF8CEACA3EB76342154D7A83C3EEB14B3F6B46A3E9E58EC8BBB972061E6E48877C70AD86A31E38DD98EC06B272BA2857A65BB3D9373E5B66486997639FD4D10FADDD49D17AEF76B09860911406A0E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 17D902F86FB6A6E20E84902826DE3E6BEA06B3B9369192A1D6B869795C068FD7D4C8DE1109EF4930CBC5E05835E8217F6EE67E85F36D787266BCB0CBCC1F7D1DB37183C5A469E2927E31898C1B81AE181EF645372B440FA39E3E460654F787BFAF4FB21A1CF8C4A511FDAB712D6EEC796FE0AE1102F28C323645DACB302F7C6CC6BB4D8F24FC9F6433235BCCD1A391EDF650F6998332A49402917A2CB285ED6FDE670A37478C8AE902EE54B17FD0F7D393460FF959ADDE60E9F129ECA1F2A62EEE52A5870DF04FAB7006F1A7837514952D503E405C223BE486CF25E56F5CE49AA3DEFE7432244AE07A30B53589E16E5110AE3AB7EB44008F0DDD381C5ED685B1</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E5 13 A2 1E BE 09 99 3F 92 7E B1 38
0010 | D8 5B 28 87 20 8C D9 6C 6E 2E A8 51 CC 03 32 86
0020 | E4 9C 99 E8 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 17 D9 02 F8 6F B6 A6 E2 0E 84 90 28 26 DE 3E 6B
0040 | EA 06 B3 B9 36 91 92 A1 D6 B8 69 79 5C 06 8F D7
0050 | D4 C8 DE 11 09 EF 49 30 CB C5 E0 58 35 E8 21 7F
0060 | 6E E6 7E 85 F3 6D 78 72 66 BC B0 CB CC 1F 7D 1D
0070 | B3 71 83 C5 A4 69 E2 92 7E 31 89 8C 1B 81 AE 18
0080 | 1E F6 45 37 2B 44 0F A3 9E 3E 46 06 54 F7 87 BF
0090 | AF 4F B2 1A 1C F8 C4 A5 11 FD AB 71 2D 6E EC 79
00A0 | 6F E0 AE 11 02 F2 8C 32 36 45 DA CB 30 2F 7C 6C
00B0 | C6 BB 4D 8F 24 FC 9F 64 33 23 5B CC D1 A3 91 ED
00C0 | F6 50 F6 99 83 32 A4 94 02 91 7A 2C B2 85 ED 6F
00D0 | DE 67 0A 37 47 8C 8A E9 02 EE 54 B1 7F D0 F7 D3
00E0 | 93 46 0F F9 59 AD DE 60 E9 F1 29 EC A1 F2 A6 2E
00F0 | EE 52 A5 87 0D F0 4F AB 70 06 F1 A7 83 75 14 95
0100 | 2D 50 3E 40 5C 22 3B E4 86 CF 25 E5 6F 5C E4 9A
0110 | A3 DE FE 74 32 24 4A E0 7A 30 B5 35 89 E1 6E 51
0120 | 10 AE 3A B7 EB 44 00 8F 0D DD 38 1C 5E D6 85 B1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010017D902F86FB6A6E20E849028</code> <code>26DE3E6BEA06B3B9369192A1D6B86979</code> <code>5C068FD7D4C8DE1109EF4930CBC5E058</code> <code>35E8217F6EE67E85F36D787266BCB0CB</code> <code>CC1F7D1DB37183C5A469E2927E31898C</code> <code>1B81AE181EF645372B440FA39E3E4606</code> <code>54F787BFAF4FB21A1CF8C4A511FDAB71</code> <code>2D6EEC796FE0AE1102F28C323645DACB</code> <code>302F7C6CC6BB4D8F24FC9F6433235BCC</code> <code>D1A391EDF650F6998332A49402917A2C</code> <code>B285ED6FDE670A37478C8AE902EE54B1</code> <code>7FD0F7D393460FF959ADDE60E9F129EC</code> <code>A1F2A62EEE52A5870DF04FAB7006F1A7</code> <code>837514952D503E405C223BE486CF25E5</code> <code>6F5CE49AA3DEFE7432244AE07A30B535</code> <code>89E16E5110AE3AB7EB44008F0DDD381C</code><br> <code>5ED685B1</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E513A21EBE09993F927EB138D85B2887208CD96C6E2EA851CC033286E49C99E80000000000000000FE00010017D902F86FB6A6E20E84902826DE3E6BEA06B3B9369192A1D6B869795C068FD7D4C8DE1109EF4930CBC5E05835E8217F6EE67E85F36D787266BCB0CBCC1F7D1DB37183C5A469E2927E31898C1B81AE181EF645372B440FA39E3E460654F787BFAF4FB21A1CF8C4A511FDAB712D6EEC796FE0AE1102F28C323645DACB302F7C6CC6BB4D8F24FC9F6433235BCCD1A391EDF650F6998332A49402917A2CB285ED6FDE670A37478C8AE902EE54B17FD0F7D393460FF959ADDE60E9F129ECA1F2A62EEE52A5870DF04FAB7006F1A7837514952D503E405C223BE486CF25E56F5CE49AA3DEFE7432244AE07A30B53589E16E5110AE3AB7EB44008F0DDD381C5ED685B1
padding = 6D3B66A7CE56384B9810247C
tmp_aes_key = CF23EC44DE45FD3A03AA827E598B3AB47B8EE0B043D64FBD235703D21496F977
tmp_aes_iv = D1ADA3FBAAE77657362A1628CE31D6240C5754B126BA2E3FCB1ED87FA95E459C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 24A98346AED40FE134212501317F5B3CB5CBA1966F76C3E0E2D6F33DA17DBBB550741FE7F5F1B2A470E6C60327017713C8F15672B264B196F2FBD98B034FD1BC88067D95CDB1CE2594913DC85C0911C3B622FE317E43AE91743AD3EFECE5D54338F2F19A6E242C4EFC04BF9B7BB0CE1A4BC2CA6FFAD61750602020642627CB8977066D88F5D183EB9AE6D9CB231DBB0D6C8733C25C1F42C8A53F9C3341B9BFFCB5EBBF269BB2F0150A3C60C78AA4F4D7ECE0E626467879EA78DE4AD14BEF9738F63106322C419A91A8279B5C3AF3F6EFFC719BF2FBE791F63FA7397420C9913D31F2DEDE2A670DDE89FA147BE8F71F6EABBDE3EACC9247AEBA7E5454E04120C5B932AB6D2E4199CFDC8FAB8DC1FB9C198610F4D81D3B0B3FC703A33FC337694963156AFCE7B96241588CF340255A56AAE44786BB1448F59966D39808ACE52F06ED974C7652063429A7F1227BFBB9D8E9</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C 47 0A 00 E1 7A 81 66
0010 | 78 01 00 00 1F 5F 04 F5 E5 13 A2 1E BE 09 99 3F
0020 | 92 7E B1 38 D8 5B 28 87 20 8C D9 6C 6E 2E A8 51
0030 | CC 03 32 86 E4 9C 99 E8 FE 50 01 00 24 A9 83 46
0040 | AE D4 0F E1 34 21 25 01 31 7F 5B 3C B5 CB A1 96
0050 | 6F 76 C3 E0 E2 D6 F3 3D A1 7D BB B5 50 74 1F E7
0060 | F5 F1 B2 A4 70 E6 C6 03 27 01 77 13 C8 F1 56 72
0070 | B2 64 B1 96 F2 FB D9 8B 03 4F D1 BC 88 06 7D 95
0080 | CD B1 CE 25 94 91 3D C8 5C 09 11 C3 B6 22 FE 31
0090 | 7E 43 AE 91 74 3A D3 EF EC E5 D5 43 38 F2 F1 9A
00A0 | 6E 24 2C 4E FC 04 BF 9B 7B B0 CE 1A 4B C2 CA 6F
00B0 | FA D6 17 50 60 20 20 64 26 27 CB 89 77 06 6D 88
00C0 | F5 D1 83 EB 9A E6 D9 CB 23 1D BB 0D 6C 87 33 C2
00D0 | 5C 1F 42 C8 A5 3F 9C 33 41 B9 BF FC B5 EB BF 26
00E0 | 9B B2 F0 15 0A 3C 60 C7 8A A4 F4 D7 EC E0 E6 26
00F0 | 46 78 79 EA 78 DE 4A D1 4B EF 97 38 F6 31 06 32
0100 | 2C 41 9A 91 A8 27 9B 5C 3A F3 F6 EF FC 71 9B F2
0110 | FB E7 91 F6 3F A7 39 74 20 C9 91 3D 31 F2 DE DE
0120 | 2A 67 0D DE 89 FA 14 7B E8 F7 1F 6E AB BD E3 EA
0130 | CC 92 47 AE BA 7E 54 54 E0 41 20 C5 B9 32 AB 6D
0140 | 2E 41 99 CF DC 8F AB 8D C1 FB 9C 19 86 10 F4 D8
0150 | 1D 3B 0B 3F C7 03 A3 3F C3 37 69 49 63 15 6A FC
0160 | E7 B9 62 41 58 8C F3 40 25 5A 56 AA E4 47 86 BB
0170 | 14 48 F5 99 66 D3 98 08 AC E5 2F 06 ED 97 4C 76
0180 | 52 06 34 29 A7 F1 22 7B FB B9 D8 E9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6C470A00E17A8166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010024A98346AED40FE134212501</code> <code>317F5B3CB5CBA1966F76C3E0E2D6F33D</code> <code>A17DBBB550741FE7F5F1B2A470E6C603</code> <code>27017713C8F15672B264B196F2FBD98B</code> <code>034FD1BC88067D95CDB1CE2594913DC8</code> <code>5C0911C3B622FE317E43AE91743AD3EF</code> <code>ECE5D54338F2F19A6E242C4EFC04BF9B</code> <code>7BB0CE1A4BC2CA6FFAD6175060202064</code> <code>2627CB8977066D88F5D183EB9AE6D9CB</code> <code>231DBB0D6C8733C25C1F42C8A53F9C33</code> <code>41B9BFFCB5EBBF269BB2F0150A3C60C7</code> <code>8AA4F4D7ECE0E626467879EA78DE4AD1</code> <code>4BEF9738F63106322C419A91A8279B5C</code> <code>3AF3F6EFFC719BF2FBE791F63FA73974</code> <code>20C9913D31F2DEDE2A670DDE89FA147B</code> <code>E8F71F6EABBDE3EACC9247AEBA7E5454</code> <code>E04120C5B932AB6D2E4199CFDC8FAB8D</code> <code>C1FB9C198610F4D81D3B0B3FC703A33F</code> <code>C337694963156AFCE7B96241588CF340</code> <code>255A56AAE44786BB1448F59966D39808</code> <code>ACE52F06ED974C7652063429A7F1227B</code><br> <code>FBB9D8E9</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 075A5BD962A4DC0178D33FF48730219966E6EBEE0AF4B9994353AB75022CD6116E00632316B31CBCBF4701D608AE260E800030FFC7D56971F78DC518EE18CC5DF5ADDAC1A8D35361D4DC6DB492B515EBF0D287EC6532AA5ADEA1D42697E58D347ECE3B8E0CD4F37AB0CE0BBF499CC6ABDF85DCA873BD891101150B8B56478B959D2A0F8E733A2EE131A7978C85E1CD6E2B7C13A3946C686B9A7308B6719860D72F6A91CC5D78872345F72344D0D3126E67FA0AC7538DB518BD2A13ABD81A56F760684CD25DD12394F96A996E684A0B708B4DDFCB9906B2A3399B5E04D58DC3D3B8E62962EA9735ED677789141C2E8E1843D24E523863F371866AFF0AB8E08CB5</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 2C E5 E1 7A 81 66
0010 | A8 00 00 00 34 F7 CB 3B E5 13 A2 1E BE 09 99 3F
0020 | 92 7E B1 38 D8 5B 28 87 20 8C D9 6C 6E 2E A8 51
0030 | CC 03 32 86 E4 9C 99 E8 D5 58 A2 84 E9 13 85 89
0040 | 04 EA BE 25 64 86 AD 6F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01982CE5E17A8166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8000000</code> (168 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E513A21EBE09993F927EB138D85B2887</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>208CD96C6E2EA851CC033286E49C99E8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>D558A284E913858904EABE256486AD6F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

