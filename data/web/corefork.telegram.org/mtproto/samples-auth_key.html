<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 38 6F 03 00 95 9F D6 68
0010 | 14 00 00 00 F1 8E 7E BE 28 2B E3 9B 2C A7 72 49
0020 | B7 37 40 5E 06 35 9D 2A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>386F0300959FD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 B8 09 96 9F D6 68
0010 | 50 00 00 00 63 24 16 05 28 2B E3 9B 2C A7 72 49
0020 | B7 37 40 5E 06 35 9D 2A 29 B2 E9 50 42 F5 DA B2
0030 | 1A AB 06 85 13 E6 6B FB 08 1B 8D 3B 79 62 8B 27
0040 | F7 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B4B809969FD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081B8D3B79628B27F7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1985308403270625271</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1985308403270625271</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1985308403270625271 = 1033870261 * 1920268411</code></p>
<pre><code>p = 1033870261
q = 1920268411</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1B 8D 3B 79 62 8B 27 F7 00 00 00
0010 | 04 3D 9F 9B B5 00 00 00 04 72 74 F8 7B 00 00 00
0020 | 28 2B E3 9B 2C A7 72 49 B7 37 40 5E 06 35 9D 2A
0030 | 29 B2 E9 50 42 F5 DA B2 1A AB 06 85 13 E6 6B FB
0040 | B3 92 40 56 D3 FC F7 B6 A8 91 CA 53 A1 25 D4 BF
0050 | 57 51 BE A8 A9 F4 F1 64 2F E7 46 18 1D 4B B1 AC
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081B8D3B79628B27F7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1985308403270625271</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043D9F9BB5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1033870261</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047274F87B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1920268411</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>B3924056D3FCF7B6A891CA53A125D4BF</code> <code>5751BEA8A9F4F1642FE746181D4BB1AC</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081B8D3B79628B27F7000000043D9F9BB5000000047274F87B000000282BE39B2CA77249B737405E06359D2A29B2E95042F5DAB21AAB068513E66BFBB3924056D3FCF7B6A891CA53A125D4BF5751BEA8A9F4F1642FE746181D4BB1AC02000000
random_padding_bytes = 2B17AA16B3D535A7E7B314DB42EA6988807E4119BAA60283A1456A59FB4959E83FDFD6B0E415F1E4E0F1CEC9ADF66AA2124FA15634C29DA74DC503861573865E6832A06C2A9E6A4ECA767A59379CC4AAE6462C227591F81422989C3B</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 848A7C059439B3B7599952D8E8D4A9079D1338469B148EC327477ED696FE79155D06B745E365FE5D6D13B95A4FC096FF5F487882ADD21F9795F973EC2091BFEA491FB5C007CC4CE9014B0196923762551BD41BA8E0C62EB3D87F5172F44D99464F6ED880ED22445DF225034974D74D4CC740B38D354CEBE049E3D2066F1482771EFE3EF1F1EEA367EAFEE8594592EC946D413789E86ADF115B65DB00D2DC8C9EACA6DB033860750430AB1DDEF7EC9CDDC12284C592FA11BD93E3C84D27E0BAFF3E0115132EB5B7C8AE7FC9B70CAA372F63685A5F8F0547B21F35761D1CD6083BF2B095E02FF6A80E6297C93E9DDDC9F34CB15D54A38FB5E7BEE55BA6D0617D4D</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 70 FF 05 00 96 9F D6 68
0010 | 40 01 00 00 BE E4 12 D7 28 2B E3 9B 2C A7 72 49
0020 | B7 37 40 5E 06 35 9D 2A 29 B2 E9 50 42 F5 DA B2
0030 | 1A AB 06 85 13 E6 6B FB 04 3D 9F 9B B5 00 00 00
0040 | 04 72 74 F8 7B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 84 8A 7C 05 94 39 B3 B7 59 99 52 D8
0060 | E8 D4 A9 07 9D 13 38 46 9B 14 8E C3 27 47 7E D6
0070 | 96 FE 79 15 5D 06 B7 45 E3 65 FE 5D 6D 13 B9 5A
0080 | 4F C0 96 FF 5F 48 78 82 AD D2 1F 97 95 F9 73 EC
0090 | 20 91 BF EA 49 1F B5 C0 07 CC 4C E9 01 4B 01 96
00A0 | 92 37 62 55 1B D4 1B A8 E0 C6 2E B3 D8 7F 51 72
00B0 | F4 4D 99 46 4F 6E D8 80 ED 22 44 5D F2 25 03 49
00C0 | 74 D7 4D 4C C7 40 B3 8D 35 4C EB E0 49 E3 D2 06
00D0 | 6F 14 82 77 1E FE 3E F1 F1 EE A3 67 EA FE E8 59
00E0 | 45 92 EC 94 6D 41 37 89 E8 6A DF 11 5B 65 DB 00
00F0 | D2 DC 8C 9E AC A6 DB 03 38 60 75 04 30 AB 1D DE
0100 | F7 EC 9C DD C1 22 84 C5 92 FA 11 BD 93 E3 C8 4D
0110 | 27 E0 BA FF 3E 01 15 13 2E B5 B7 C8 AE 7F C9 B7
0120 | 0C AA 37 2F 63 68 5A 5F 8F 05 47 B2 1F 35 76 1D
0130 | 1C D6 08 3B F2 B0 95 E0 2F F6 A8 0E 62 97 C9 3E
0140 | 9D DD C9 F3 4C B1 5D 54 A3 8F B5 E7 BE E5 5B A6
0150 | D0 61 7D 4D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>70FF0500969FD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043D9F9BB5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1033870261</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047274F87B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1920268411</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100848A7C059439B3B7599952D8</code> <code>E8D4A9079D1338469B148EC327477ED6</code> <code>96FE79155D06B745E365FE5D6D13B95A</code> <code>4FC096FF5F487882ADD21F9795F973EC</code> <code>2091BFEA491FB5C007CC4CE9014B0196</code> <code>923762551BD41BA8E0C62EB3D87F5172</code> <code>F44D99464F6ED880ED22445DF2250349</code> <code>74D74D4CC740B38D354CEBE049E3D206</code> <code>6F1482771EFE3EF1F1EEA367EAFEE859</code> <code>4592EC946D413789E86ADF115B65DB00</code> <code>D2DC8C9EACA6DB033860750430AB1DDE</code> <code>F7EC9CDDC12284C592FA11BD93E3C84D</code> <code>27E0BAFF3E0115132EB5B7C8AE7FC9B7</code> <code>0CAA372F63685A5F8F0547B21F35761D</code> <code>1CD6083BF2B095E02FF6A80E6297C93E</code> <code>9DDDC9F34CB15D54A38FB5E7BEE55BA6</code><br> <code>D0617D4D</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 24 AA 3A 96 9F D6 68
0010 | 78 02 00 00 5C 07 E8 D0 28 2B E3 9B 2C A7 72 49
0020 | B7 37 40 5E 06 35 9D 2A 29 B2 E9 50 42 F5 DA B2
0030 | 1A AB 06 85 13 E6 6B FB FE 50 02 00 5D 74 79 6F
0040 | 20 E9 8F 80 FF 11 A6 22 C5 47 0B E2 10 E8 65 C5
0050 | 54 1B 64 78 28 B3 D4 76 1F 3D BC 7F E1 35 59 53
0060 | 87 6A 9E E1 6A E3 A1 3E 5F 5E 1D F8 76 CA CA 02
0070 | 6C 07 25 FF AD D3 9C 32 F1 D6 B2 AD A1 B8 4D 53
0080 | 49 FA 98 51 BB 82 A2 65 E8 99 DA 7E 2F C0 79 CF
0090 | 65 2B 7B 18 87 2E 5F E7 E4 46 A6 0C E2 2C 71 0C
00A0 | AB 34 70 97 8F 2E 13 3E 61 BF E9 FC C9 C8 42 A4
00B0 | F3 73 DD DB 1C E7 7C 49 D2 74 2B 72 39 93 EC D0
00C0 | B6 99 E3 F6 81 65 DE EE 75 C0 6D 32 B4 92 01 C0
00D0 | 40 CC 02 13 78 D7 71 82 80 FC 85 EF B5 17 0A 74
00E0 | 43 AD 73 73 CE 8C F6 91 2F 4D 85 D7 21 87 6A 93
00F0 | B3 95 E6 DB CC C5 2D 5F 0D 8D E8 93 16 15 0C CA
0100 | 01 A1 23 50 9B 5B 3E F8 31 BA 60 5F 70 E7 BF BF
0110 | 34 8D FE 04 E7 E9 3A 45 74 E1 E1 0F C1 50 07 3A
0120 | F4 6C 57 C0 1D 9F 1F 7C 0A 05 E7 F9 D7 32 F5 C7
0130 | B3 03 D6 F5 DE D4 F0 77 4D BA 8E 99 C5 2A D8 D8
0140 | C9 DE 90 1F 44 24 7C C6 26 3B 5B 36 10 79 B9 DE
0150 | 8E 2B 32 82 D6 22 C2 CB 4F 93 1F FF 8D 7E D0 59
0160 | E0 11 CF 5C 99 76 80 83 C0 FE E6 35 AD 41 99 AD
0170 | 19 15 5B DF 3E A0 7A 20 CE A3 F3 78 12 15 E7 7B
0180 | D8 F8 8B 02 3C EF A3 69 5A 07 96 7E 2C 88 5F 6C
0190 | 76 7A 70 43 70 02 34 94 71 1D E7 EA 10 6D 17 6E
01A0 | F5 FC 2B EC 33 10 51 47 F5 85 F6 3A 90 DA 1E 0F
01B0 | 93 B7 4C D9 4B EA A8 B1 96 66 16 62 BB 54 BD 81
01C0 | 23 DF F5 6C 6F EA AA 5B DA 27 48 C4 94 1A 2A CA
01D0 | E5 FA 15 37 E1 7F 19 D8 B3 B1 DF 5D B6 BA E5 36
01E0 | 3B A2 E0 A6 94 9D 0D 11 C5 66 07 65 DC 52 2C 64
01F0 | 8A 37 2D A9 03 64 25 9B 69 5E 00 91 C8 E8 94 BB
0200 | 75 D5 37 1B 2E E6 78 89 43 96 01 23 0E 5B BB E0
0210 | D5 1C D7 CB E3 0D BB F7 1B 87 F4 78 2B BB 4E CE
0220 | ED A5 92 0F 97 F9 7B 02 A3 F4 EE 55 17 C6 93 4E
0230 | A0 5A 73 9A F2 E1 33 9B 6E 63 CD 59 31 33 CE 7C
0240 | 5B 58 0F F2 34 2B 4E A0 B4 E5 2C E0 E6 6C 60 D1
0250 | E2 F0 CF 22 82 50 14 D9 82 C5 C3 B9 22 74 12 EC
0260 | AD FD 13 46 E3 CE 1C 7E 9D 97 1A F4 81 71 8E 90
0270 | 5F 99 4C 27 55 BF 9B D2 00 6A 51 BF DD 78 78 62
0280 | B2 7E 12 48 08 35 81 66 2E 0D 11 CD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0124AA3A969FD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002005D74796F20E98F80FF11A622</code> <code>C5470BE210E865C5541B647828B3D476</code> <code>1F3DBC7FE1355953876A9EE16AE3A13E</code> <code>5F5E1DF876CACA026C0725FFADD39C32</code> <code>F1D6B2ADA1B84D5349FA9851BB82A265</code> <code>E899DA7E2FC079CF652B7B18872E5FE7</code> <code>E446A60CE22C710CAB3470978F2E133E</code> <code>61BFE9FCC9C842A4F373DDDB1CE77C49</code> <code>D2742B723993ECD0B699E3F68165DEEE</code> <code>75C06D32B49201C040CC021378D77182</code> <code>80FC85EFB5170A7443AD7373CE8CF691</code> <code>2F4D85D721876A93B395E6DBCCC52D5F</code> <code>0D8DE89316150CCA01A123509B5B3EF8</code> <code>31BA605F70E7BFBF348DFE04E7E93A45</code> <code>74E1E10FC150073AF46C57C01D9F1F7C</code> <code>0A05E7F9D732F5C7B303D6F5DED4F077</code> <code>4DBA8E99C52AD8D8C9DE901F44247CC6</code> <code>263B5B361079B9DE8E2B3282D622C2CB</code> <code>4F931FFF8D7ED059E011CF5C99768083</code> <code>C0FEE635AD4199AD19155BDF3EA07A20</code> <code>CEA3F3781215E77BD8F88B023CEFA369</code> <code>5A07967E2C885F6C767A704370023494</code> <code>711DE7EA106D176EF5FC2BEC33105147</code> <code>F585F63A90DA1E0F93B74CD94BEAA8B1</code> <code>96661662BB54BD8123DFF56C6FEAAA5B</code> <code>DA2748C4941A2ACAE5FA1537E17F19D8</code> <code>B3B1DF5DB6BAE5363BA2E0A6949D0D11</code> <code>C5660765DC522C648A372DA90364259B</code> <code>695E0091C8E894BB75D5371B2EE67889</code> <code>439601230E5BBBE0D51CD7CBE30DBBF7</code> <code>1B87F4782BBB4ECEEDA5920F97F97B02</code> <code>A3F4EE5517C6934EA05A739AF2E1339B</code> <code>6E63CD593133CE7C5B580FF2342B4EA0</code> <code>B4E52CE0E66C60D1E2F0CF22825014D9</code> <code>82C5C3B9227412ECADFD1346E3CE1C7E</code> <code>9D971AF481718E905F994C2755BF9BD2</code> <code>006A51BFDD787862B27E124808358166</code><br> <code>2E0D11CD</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 5D74796F20E98F80FF11A622C5470BE210E865C5541B647828B3D4761F3DBC7FE1355953876A9EE16AE3A13E5F5E1DF876CACA026C0725FFADD39C32F1D6B2ADA1B84D5349FA9851BB82A265E899DA7E2FC079CF652B7B18872E5FE7E446A60CE22C710CAB3470978F2E133E61BFE9FCC9C842A4F373DDDB1CE77C49D2742B723993ECD0B699E3F68165DEEE75C06D32B49201C040CC021378D7718280FC85EFB5170A7443AD7373CE8CF6912F4D85D721876A93B395E6DBCCC52D5F0D8DE89316150CCA01A123509B5B3EF831BA605F70E7BFBF348DFE04E7E93A4574E1E10FC150073AF46C57C01D9F1F7C0A05E7F9D732F5C7B303D6F5DED4F0774DBA8E99C52AD8D8C9DE901F44247CC6263B5B361079B9DE8E2B3282D622C2CB4F931FFF8D7ED059E011CF5C99768083C0FEE635AD4199AD19155BDF3EA07A20CEA3F3781215E77BD8F88B023CEFA3695A07967E2C885F6C767A704370023494711DE7EA106D176EF5FC2BEC33105147F585F63A90DA1E0F93B74CD94BEAA8B196661662BB54BD8123DFF56C6FEAAA5BDA2748C4941A2ACAE5FA1537E17F19D8B3B1DF5DB6BAE5363BA2E0A6949D0D11C5660765DC522C648A372DA90364259B695E0091C8E894BB75D5371B2EE67889439601230E5BBBE0D51CD7CBE30DBBF71B87F4782BBB4ECEEDA5920F97F97B02A3F4EE5517C6934EA05A739AF2E1339B6E63CD593133CE7C5B580FF2342B4EA0B4E52CE0E66C60D1E2F0CF22825014D982C5C3B9227412ECADFD1346E3CE1C7E9D971AF481718E905F994C2755BF9BD2006A51BFDD787862B27E1248083581662E0D11CD
tmp_aes_key = 2E51E80E376BB77C2CD451BE88D675EA02A64BB29476A0D5DC32A9F30F00AE90
tmp_aes_iv = D5EB0C2B48333229B59FAFE84BB66D1CEBE3A0F17194C46E58D7C042B3924056</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 6B84F16649189EB5D0E35694FC71C75116C02509BA0D89B5282BE39B2CA77249B737405E06359D2A29B2E95042F5DAB21AAB068513E66BFB03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100A12762F21BFEC9182F6940AF3FFE56190C2AE87F203F04BF8879C7D4735566971466FBB42281C424134B3BA69CD275E45C27D8159C7847AE650200A2335C6B45B90DA4D8ECFFF3DF4A1BC443599093A3B9077B2A9635B2BFE9E571CB9DA51F5DAB66CD7AA7E7106327BA31E0DA5CC73E9D7158A63803FAE60490248810C58D8359CC5158FB1BB1501CE09A9B99F8C60969A8CE2E316888C9C4FA1D6022F2628C86B8EEBCE8A6AC4104051763F8EEBC788EB5F1BD7720948BD43518CF1DDFB4FCE2D97F181BE08C7021072CBD1C0FA9422616ACC1BA593093A8E5956EFFCFD13BD55119F91CF9AD0F8E4FB186C504AD2F03662DABF032C44B2ADB31CBCC6E5874969FD668CB7C67856A421171
answer = BA0D89B5282BE39B2CA77249B737405E06359D2A29B2E95042F5DAB21AAB068513E66BFB03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100A12762F21BFEC9182F6940AF3FFE56190C2AE87F203F04BF8879C7D4735566971466FBB42281C424134B3BA69CD275E45C27D8159C7847AE650200A2335C6B45B90DA4D8ECFFF3DF4A1BC443599093A3B9077B2A9635B2BFE9E571CB9DA51F5DAB66CD7AA7E7106327BA31E0DA5CC73E9D7158A63803FAE60490248810C58D8359CC5158FB1BB1501CE09A9B99F8C60969A8CE2E316888C9C4FA1D6022F2628C86B8EEBCE8A6AC4104051763F8EEBC788EB5F1BD7720948BD43518CF1DDFB4FCE2D97F181BE08C7021072CBD1C0FA9422616ACC1BA593093A8E5956EFFCFD13BD55119F91CF9AD0F8E4FB186C504AD2F03662DABF032C44B2ADB31CBCC6E5874969FD668CB7C67856A421171</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 28 2B E3 9B 2C A7 72 49 B7 37 40 5E
0010 | 06 35 9D 2A 29 B2 E9 50 42 F5 DA B2 1A AB 06 85
0020 | 13 E6 6B FB 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | A1 27 62 F2 1B FE C9 18 2F 69 40 AF 3F FE 56 19
0140 | 0C 2A E8 7F 20 3F 04 BF 88 79 C7 D4 73 55 66 97
0150 | 14 66 FB B4 22 81 C4 24 13 4B 3B A6 9C D2 75 E4
0160 | 5C 27 D8 15 9C 78 47 AE 65 02 00 A2 33 5C 6B 45
0170 | B9 0D A4 D8 EC FF F3 DF 4A 1B C4 43 59 90 93 A3
0180 | B9 07 7B 2A 96 35 B2 BF E9 E5 71 CB 9D A5 1F 5D
0190 | AB 66 CD 7A A7 E7 10 63 27 BA 31 E0 DA 5C C7 3E
01A0 | 9D 71 58 A6 38 03 FA E6 04 90 24 88 10 C5 8D 83
01B0 | 59 CC 51 58 FB 1B B1 50 1C E0 9A 9B 99 F8 C6 09
01C0 | 69 A8 CE 2E 31 68 88 C9 C4 FA 1D 60 22 F2 62 8C
01D0 | 86 B8 EE BC E8 A6 AC 41 04 05 17 63 F8 EE BC 78
01E0 | 8E B5 F1 BD 77 20 94 8B D4 35 18 CF 1D DF B4 FC
01F0 | E2 D9 7F 18 1B E0 8C 70 21 07 2C BD 1C 0F A9 42
0200 | 26 16 AC C1 BA 59 30 93 A8 E5 95 6E FF CF D1 3B
0210 | D5 51 19 F9 1C F9 AD 0F 8E 4F B1 86 C5 04 AD 2F
0220 | 03 66 2D AB F0 32 C4 4B 2A DB 31 CB CC 6E 58 74
0230 | 96 9F D6 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100A12762F21BFEC9182F6940AF</code> <code>3FFE56190C2AE87F203F04BF8879C7D4</code> <code>735566971466FBB42281C424134B3BA6</code> <code>9CD275E45C27D8159C7847AE650200A2</code> <code>335C6B45B90DA4D8ECFFF3DF4A1BC443</code> <code>599093A3B9077B2A9635B2BFE9E571CB</code> <code>9DA51F5DAB66CD7AA7E7106327BA31E0</code> <code>DA5CC73E9D7158A63803FAE604902488</code> <code>10C58D8359CC5158FB1BB1501CE09A9B</code> <code>99F8C60969A8CE2E316888C9C4FA1D60</code> <code>22F2628C86B8EEBCE8A6AC4104051763</code> <code>F8EEBC788EB5F1BD7720948BD43518CF</code> <code>1DDFB4FCE2D97F181BE08C7021072CBD</code> <code>1C0FA9422616ACC1BA593093A8E5956E</code> <code>FFCFD13BD55119F91CF9AD0F8E4FB186</code> <code>C504AD2F03662DABF032C44B2ADB31CB</code><br> <code>CC6E5874</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>969FD668</code> (1758896022 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 285D9007ADFEB3233FF46907072ED4A933E78A669F17EAD5C44B55C18ED186DBE4AD23B66A37FDFF5F41900E8D92F8B124ABE89BDDE7454A4AFE38626A5AD319EB0E29B2A5D35AEE64FF4A3DE050B98B5843784798DA059A7654A1B0ABAC8E6CA08C683334CA5A3945CD948F1A6B005E99BAC2B75790D268CDB5DAC7A51E701F2DE8D972239FF90F417BF12F6C54C681BFA8A37DD2BF82507444C5CE154A24932D7EBBC07AB0A2A7B3086BFE98022C5E4B18DA3EB832DDB486FFEC06B705F3D6E9998CB03CCC2E9031DE460A01B74F589B319545F93BFD2C3B2759ECB053F54E6F855D904ED8069A858E61CAE60F21E1ACFB4B9B8DB5B733242D25E4B78FB79F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 1445538DF4726A41D70D03A54B4B46B2CA8CE233CE966D6C78CA14548C932456F145BE25397D33D3ED775D93237E96462FB60DF86215FEF69B8E77C7116D6D6410BA79660BED6F538C5B5FA112C68E09D25CA632B5D29CE8E2799C44514A3A27AC12EE7ADEB397CC70D7FEE5917E9DE0A674621D539024B63139E3294BA7C77671817DE2840E8C504A1E83FB4F8081526D258F9915C6E871DCF6EDC56EBD591200DA78EF04BEC721C50A183CB07A61BFB836408B4CBA11A8397EAA134BD182B9FD3D9689342AFA36637E8126F5A9597C1222094FF7CF2E9F81B820C9E1820CF8840B7C06AE807FFDE8927D71536A56FF5B62EA4FF20C9DEA58A449813BDACBFD</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 28 2B E3 9B 2C A7 72 49 B7 37 40 5E
0010 | 06 35 9D 2A 29 B2 E9 50 42 F5 DA B2 1A AB 06 85
0020 | 13 E6 6B FB 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 14 45 53 8D F4 72 6A 41 D7 0D 03 A5 4B 4B 46 B2
0040 | CA 8C E2 33 CE 96 6D 6C 78 CA 14 54 8C 93 24 56
0050 | F1 45 BE 25 39 7D 33 D3 ED 77 5D 93 23 7E 96 46
0060 | 2F B6 0D F8 62 15 FE F6 9B 8E 77 C7 11 6D 6D 64
0070 | 10 BA 79 66 0B ED 6F 53 8C 5B 5F A1 12 C6 8E 09
0080 | D2 5C A6 32 B5 D2 9C E8 E2 79 9C 44 51 4A 3A 27
0090 | AC 12 EE 7A DE B3 97 CC 70 D7 FE E5 91 7E 9D E0
00A0 | A6 74 62 1D 53 90 24 B6 31 39 E3 29 4B A7 C7 76
00B0 | 71 81 7D E2 84 0E 8C 50 4A 1E 83 FB 4F 80 81 52
00C0 | 6D 25 8F 99 15 C6 E8 71 DC F6 ED C5 6E BD 59 12
00D0 | 00 DA 78 EF 04 BE C7 21 C5 0A 18 3C B0 7A 61 BF
00E0 | B8 36 40 8B 4C BA 11 A8 39 7E AA 13 4B D1 82 B9
00F0 | FD 3D 96 89 34 2A FA 36 63 7E 81 26 F5 A9 59 7C
0100 | 12 22 09 4F F7 CF 2E 9F 81 B8 20 C9 E1 82 0C F8
0110 | 84 0B 7C 06 AE 80 7F FD E8 92 7D 71 53 6A 56 FF
0120 | 5B 62 EA 4F F2 0C 9D EA 58 A4 49 81 3B DA CB FD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001001445538DF4726A41D70D03A5</code> <code>4B4B46B2CA8CE233CE966D6C78CA1454</code> <code>8C932456F145BE25397D33D3ED775D93</code> <code>237E96462FB60DF86215FEF69B8E77C7</code> <code>116D6D6410BA79660BED6F538C5B5FA1</code> <code>12C68E09D25CA632B5D29CE8E2799C44</code> <code>514A3A27AC12EE7ADEB397CC70D7FEE5</code> <code>917E9DE0A674621D539024B63139E329</code> <code>4BA7C77671817DE2840E8C504A1E83FB</code> <code>4F8081526D258F9915C6E871DCF6EDC5</code> <code>6EBD591200DA78EF04BEC721C50A183C</code> <code>B07A61BFB836408B4CBA11A8397EAA13</code> <code>4BD182B9FD3D9689342AFA36637E8126</code> <code>F5A9597C1222094FF7CF2E9F81B820C9</code> <code>E1820CF8840B7C06AE807FFDE8927D71</code> <code>536A56FF5B62EA4FF20C9DEA58A44981</code><br> <code>3BDACBFD</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366282BE39B2CA77249B737405E06359D2A29B2E95042F5DAB21AAB068513E66BFB0000000000000000FE0001001445538DF4726A41D70D03A54B4B46B2CA8CE233CE966D6C78CA14548C932456F145BE25397D33D3ED775D93237E96462FB60DF86215FEF69B8E77C7116D6D6410BA79660BED6F538C5B5FA112C68E09D25CA632B5D29CE8E2799C44514A3A27AC12EE7ADEB397CC70D7FEE5917E9DE0A674621D539024B63139E3294BA7C77671817DE2840E8C504A1E83FB4F8081526D258F9915C6E871DCF6EDC56EBD591200DA78EF04BEC721C50A183CB07A61BFB836408B4CBA11A8397EAA134BD182B9FD3D9689342AFA36637E8126F5A9597C1222094FF7CF2E9F81B820C9E1820CF8840B7C06AE807FFDE8927D71536A56FF5B62EA4FF20C9DEA58A449813BDACBFD
padding = 44AD8BEB6888FA2DB9536E1E
tmp_aes_key = 2E51E80E376BB77C2CD451BE88D675EA02A64BB29476A0D5DC32A9F30F00AE90
tmp_aes_iv = D5EB0C2B48333229B59FAFE84BB66D1CEBE3A0F17194C46E58D7C042B3924056</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = D630656D2DACE9FCD4D341197930FF68C76288797D5816FD11371CB54EE6A6AA3E2091D421A865CDE282C7FA0667D689770993C831B187653E17F70EB89B5DC554DDDE627E8AD6B1F766ECE01275083DEF1E34DFA17F6F59A4E40ECBAD349BF180F52E3F7A1E11C80473D90500D5FBBC4449487C7DE8277A046C83F58FA2B5FA3A2A529D89DD549A6E6450A9E304132AAB72359A9684BD037AF1F80A3403314AE349134596D04CA6A5EEFF946AD241CF025EDB022DCCB622314CA600F9124FACD71C40793E7F6A2A7E7584079FB1E0F294165952681C1422156EC1E0DD27CC7FB20C461B7520E6EFDCBD0867277D5B1ACA1520466B91C7B483FC007D0BD2A117EB28A9278362B013008E8B20FD6C8523C1B03DC5D52A63F2C7E815CFA6F216BAC95F3DF21738B85B8CE4B3B6A3E30DB35E6DF44D3C4152E25CD13C7C7981D94EF63D79F263FA12A887DCC59C562B1B03</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 74 FF 05 00 96 9F D6 68
0010 | 78 01 00 00 1F 5F 04 F5 28 2B E3 9B 2C A7 72 49
0020 | B7 37 40 5E 06 35 9D 2A 29 B2 E9 50 42 F5 DA B2
0030 | 1A AB 06 85 13 E6 6B FB FE 50 01 00 D6 30 65 6D
0040 | 2D AC E9 FC D4 D3 41 19 79 30 FF 68 C7 62 88 79
0050 | 7D 58 16 FD 11 37 1C B5 4E E6 A6 AA 3E 20 91 D4
0060 | 21 A8 65 CD E2 82 C7 FA 06 67 D6 89 77 09 93 C8
0070 | 31 B1 87 65 3E 17 F7 0E B8 9B 5D C5 54 DD DE 62
0080 | 7E 8A D6 B1 F7 66 EC E0 12 75 08 3D EF 1E 34 DF
0090 | A1 7F 6F 59 A4 E4 0E CB AD 34 9B F1 80 F5 2E 3F
00A0 | 7A 1E 11 C8 04 73 D9 05 00 D5 FB BC 44 49 48 7C
00B0 | 7D E8 27 7A 04 6C 83 F5 8F A2 B5 FA 3A 2A 52 9D
00C0 | 89 DD 54 9A 6E 64 50 A9 E3 04 13 2A AB 72 35 9A
00D0 | 96 84 BD 03 7A F1 F8 0A 34 03 31 4A E3 49 13 45
00E0 | 96 D0 4C A6 A5 EE FF 94 6A D2 41 CF 02 5E DB 02
00F0 | 2D CC B6 22 31 4C A6 00 F9 12 4F AC D7 1C 40 79
0100 | 3E 7F 6A 2A 7E 75 84 07 9F B1 E0 F2 94 16 59 52
0110 | 68 1C 14 22 15 6E C1 E0 DD 27 CC 7F B2 0C 46 1B
0120 | 75 20 E6 EF DC BD 08 67 27 7D 5B 1A CA 15 20 46
0130 | 6B 91 C7 B4 83 FC 00 7D 0B D2 A1 17 EB 28 A9 27
0140 | 83 62 B0 13 00 8E 8B 20 FD 6C 85 23 C1 B0 3D C5
0150 | D5 2A 63 F2 C7 E8 15 CF A6 F2 16 BA C9 5F 3D F2
0160 | 17 38 B8 5B 8C E4 B3 B6 A3 E3 0D B3 5E 6D F4 4D
0170 | 3C 41 52 E2 5C D1 3C 7C 79 81 D9 4E F6 3D 79 F2
0180 | 63 FA 12 A8 87 DC C5 9C 56 2B 1B 03</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>74FF0500969FD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100D630656D2DACE9FCD4D34119</code> <code>7930FF68C76288797D5816FD11371CB5</code> <code>4EE6A6AA3E2091D421A865CDE282C7FA</code> <code>0667D689770993C831B187653E17F70E</code> <code>B89B5DC554DDDE627E8AD6B1F766ECE0</code> <code>1275083DEF1E34DFA17F6F59A4E40ECB</code> <code>AD349BF180F52E3F7A1E11C80473D905</code> <code>00D5FBBC4449487C7DE8277A046C83F5</code> <code>8FA2B5FA3A2A529D89DD549A6E6450A9</code> <code>E304132AAB72359A9684BD037AF1F80A</code> <code>3403314AE349134596D04CA6A5EEFF94</code> <code>6AD241CF025EDB022DCCB622314CA600</code> <code>F9124FACD71C40793E7F6A2A7E758407</code> <code>9FB1E0F294165952681C1422156EC1E0</code> <code>DD27CC7FB20C461B7520E6EFDCBD0867</code> <code>277D5B1ACA1520466B91C7B483FC007D</code> <code>0BD2A117EB28A9278362B013008E8B20</code> <code>FD6C8523C1B03DC5D52A63F2C7E815CF</code> <code>A6F216BAC95F3DF21738B85B8CE4B3B6</code> <code>A3E30DB35E6DF44D3C4152E25CD13C7C</code> <code>7981D94EF63D79F263FA12A887DCC59C</code><br> <code>562B1B03</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 465B64EF34D6F53A31EB0C176C7F00C07D8D6D13506778D47C66A3C637CDCD16EEC7FDB4073ABAD9FF5274F6DA1E50B7598B4DF21FA98D8D0503457EC4E65AD867CCA387CA6FD97F2BD5C711B47CB65A8D0E9BA8DBC571BD5A5498B19D5A95774624C7A82CE630F4FCB6D5E9AD6A28A60CEE92D30F4075FD77B053ADEE281CC85D680437876C7B9A1317EA8A0A1A321277AF47083D2F10C2C63363EBD22F13576ECBF39483BF70939775F190B2B48BB06D41193E5DF88D685B04971184BAFEDCF483526F287326425E88BDE07F1C4B846342513F9A52E78B3DA8B5400B21365869BB16B338FB0033531589FF7B6B8435D4D0CBC952216773494FF12CA2EAD949</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 CC 5C 57 97 9F D6 68
0010 | 34 00 00 00 34 F7 CB 3B 28 2B E3 9B 2C A7 72 49
0020 | B7 37 40 5E 06 35 9D 2A 29 B2 E9 50 42 F5 DA B2
0030 | 1A AB 06 85 13 E6 6B FB 01 DC 5E 55 80 CD A2 0B
0040 | 52 01 84 12 DF 01 7F AC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01CC5C57979FD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>282BE39B2CA77249B737405E06359D2A</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>29B2E95042F5DAB21AAB068513E66BFB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>01DC5E5580CDA20B52018412DF017FAC</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

