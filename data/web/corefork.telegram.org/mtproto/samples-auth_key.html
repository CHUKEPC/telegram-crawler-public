<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?237" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 68 82 01 00 9A ED 77 66
0010 | 14 00 00 00 F1 8E 7E BE BD D3 43 62 8E 05 18 35
0020 | 1B EB 12 EF BC AF BB 7C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>688201009AED7766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 5C ED 7B 9A ED 77 66
0010 | 68 00 00 00 63 24 16 05 BD D3 43 62 8E 05 18 35
0020 | 1B EB 12 EF BC AF BB 7C 20 FB B9 18 86 EE 0C 2E
0030 | BF BD 51 E8 A5 03 40 98 08 1E CE 43 71 B8 6C 45
0040 | E3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015CED7B9AED7766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>68000000</code> (104 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081ECE4371B86C45E3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2219785822044702179</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2219785822044702179</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2219785822044702179 = 1275787277 * 1739934127</code></p>
<pre><code>p = 1275787277
q = 1739934127</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1E CE 43 71 B8 6C 45 E3 00 00 00
0010 | 04 4C 0A F8 0D 00 00 00 04 67 B5 49 AF 00 00 00
0020 | BD D3 43 62 8E 05 18 35 1B EB 12 EF BC AF BB 7C
0030 | 20 FB B9 18 86 EE 0C 2E BF BD 51 E8 A5 03 40 98
0040 | 34 5D F4 48 5C 4F 01 3B D2 B2 71 5D 91 98 5D 71
0050 | 9A 75 09 9C 72 DF AD 46 26 AA 13 3F 70 6D 90 1E
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081ECE4371B86C45E3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2219785822044702179</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044C0AF80D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1275787277</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0467B549AF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1739934127</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>345DF4485C4F013BD2B2715D91985D71</code> <code>9A75099C72DFAD4626AA133F706D901E</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081ECE4371B86C45E3000000044C0AF80D0000000467B549AF000000BDD343628E0518351BEB12EFBCAFBB7C20FBB91886EE0C2EBFBD51E8A5034098345DF4485C4F013BD2B2715D91985D719A75099C72DFAD4626AA133F706D901E02000000
random_padding_bytes = 74898DDC498AC0DB200C925B12A533A4E45EEB1F799632FF14A00A3C67BF2D1B1E5B51198EDCF74817A9F393D00774F028C17FA6A26BC0F6BBE175502EB3C22A3B81361EDCFB9EEE72D0298AEE741BFA8592B09CCD3A8A2231D2717B</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A9B1176500689D99C4442CA88FF80035AF58FE2A59399E4CA85D81F7045EAA7EC3DA61007668A9F68041B8BEB69BAD881EA80FFD3E9278BF660065D51ACD0F2A77AAC1AD41F268F0046C63D20E0910CC45D9172B3B6169EB6995AE931ED126BDD155E25D1DEFFF29DB2CC8097383614F20D5E7B83B8F575EE521D562F81A9B45C944FD9AB27D548874A46D957FAB7E0267328FD0058BEA4383FB02F9B7612490417D4033403D58A19CCE6D11CABE864239F39B621F7C51F6BF6A90B3FD8EFA5A869B6D5E25C325D235020A3126D3C4B65EEE0BE9FB5A5C300A7EB03F50968FAAAFF122303D73DD35E86FA3AB8E0F2D50BCABB698C00EBD04D8ABA422291C80CF</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 EB 0C 00 9A ED 77 66
0010 | 40 01 00 00 BE E4 12 D7 BD D3 43 62 8E 05 18 35
0020 | 1B EB 12 EF BC AF BB 7C 20 FB B9 18 86 EE 0C 2E
0030 | BF BD 51 E8 A5 03 40 98 04 4C 0A F8 0D 00 00 00
0040 | 04 67 B5 49 AF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A9 B1 17 65 00 68 9D 99 C4 44 2C A8
0060 | 8F F8 00 35 AF 58 FE 2A 59 39 9E 4C A8 5D 81 F7
0070 | 04 5E AA 7E C3 DA 61 00 76 68 A9 F6 80 41 B8 BE
0080 | B6 9B AD 88 1E A8 0F FD 3E 92 78 BF 66 00 65 D5
0090 | 1A CD 0F 2A 77 AA C1 AD 41 F2 68 F0 04 6C 63 D2
00A0 | 0E 09 10 CC 45 D9 17 2B 3B 61 69 EB 69 95 AE 93
00B0 | 1E D1 26 BD D1 55 E2 5D 1D EF FF 29 DB 2C C8 09
00C0 | 73 83 61 4F 20 D5 E7 B8 3B 8F 57 5E E5 21 D5 62
00D0 | F8 1A 9B 45 C9 44 FD 9A B2 7D 54 88 74 A4 6D 95
00E0 | 7F AB 7E 02 67 32 8F D0 05 8B EA 43 83 FB 02 F9
00F0 | B7 61 24 90 41 7D 40 33 40 3D 58 A1 9C CE 6D 11
0100 | CA BE 86 42 39 F3 9B 62 1F 7C 51 F6 BF 6A 90 B3
0110 | FD 8E FA 5A 86 9B 6D 5E 25 C3 25 D2 35 02 0A 31
0120 | 26 D3 C4 B6 5E EE 0B E9 FB 5A 5C 30 0A 7E B0 3F
0130 | 50 96 8F AA AF F1 22 30 3D 73 DD 35 E8 6F A3 AB
0140 | 8E 0F 2D 50 BC AB B6 98 C0 0E BD 04 D8 AB A4 22
0150 | 29 1C 80 CF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0EB0C009AED7766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044C0AF80D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1275787277</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0467B549AF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1739934127</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A9B1176500689D99C4442CA8</code> <code>8FF80035AF58FE2A59399E4CA85D81F7</code> <code>045EAA7EC3DA61007668A9F68041B8BE</code> <code>B69BAD881EA80FFD3E9278BF660065D5</code> <code>1ACD0F2A77AAC1AD41F268F0046C63D2</code> <code>0E0910CC45D9172B3B6169EB6995AE93</code> <code>1ED126BDD155E25D1DEFFF29DB2CC809</code> <code>7383614F20D5E7B83B8F575EE521D562</code> <code>F81A9B45C944FD9AB27D548874A46D95</code> <code>7FAB7E0267328FD0058BEA4383FB02F9</code> <code>B7612490417D4033403D58A19CCE6D11</code> <code>CABE864239F39B621F7C51F6BF6A90B3</code> <code>FD8EFA5A869B6D5E25C325D235020A31</code> <code>26D3C4B65EEE0BE9FB5A5C300A7EB03F</code> <code>50968FAAAFF122303D73DD35E86FA3AB</code> <code>8E0F2D50BCABB698C00EBD04D8ABA422</code><br> <code>291C80CF</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F8 03 56 9B ED 77 66
0010 | A0 02 00 00 5C 07 E8 D0 BD D3 43 62 8E 05 18 35
0020 | 1B EB 12 EF BC AF BB 7C 20 FB B9 18 86 EE 0C 2E
0030 | BF BD 51 E8 A5 03 40 98 FE 50 02 00 BC 64 C0 EE
0040 | 34 0F B9 33 C2 71 8E 69 BE BC 56 F7 B8 3F 95 56
0050 | D7 EE 47 77 84 65 A4 6E 15 50 2A B2 28 FC 81 04
0060 | D9 D3 4E 62 9C F6 1E 80 F9 E4 DB 7A 9F 5F 98 F0
0070 | ED 7E 90 AE 85 79 6D 51 42 2C 98 65 1C F7 17 13
0080 | 65 A7 15 7A 64 9B AD 47 8A A4 85 35 52 14 E9 FC
0090 | BF CF 97 D4 E9 E2 EC CF 8C 0F BA AD 9F 58 60 E1
00A0 | CE DF 83 08 59 06 C7 98 51 8A 1F D9 0F 98 5A 8C
00B0 | A9 56 19 87 CA 31 C7 92 DB AD 7B 79 23 6C 35 06
00C0 | E6 4A 57 AD 83 95 D9 31 35 49 A6 A0 F6 B2 9A 60
00D0 | D6 62 6A AE 86 4B 21 5F BE 04 A5 F1 EA 06 A6 04
00E0 | 02 D3 C5 9F 3A 2E 39 84 2A DC 5B C9 DF 94 41 04
00F0 | 0B 88 B6 EF EA 01 7E D8 04 0B 28 43 FF 06 68 0A
0100 | E7 E0 A6 B8 A7 E5 93 11 F1 8B C5 09 5D 2B 65 5E
0110 | 19 CF 39 60 00 A8 BB 19 D0 EE DA B9 B5 8D 33 31
0120 | E7 DF 01 2D 80 14 EC 09 43 38 E8 6E 1D 57 F1 91
0130 | 63 A0 86 E5 DC 5D 48 9C C2 BA 30 51 B3 7B AA 2E
0140 | A2 F9 47 EC A1 31 E1 A5 79 A7 5F 10 B0 B0 59 62
0150 | DF 6C CE 97 4E 00 27 D5 EC F0 29 4E B0 4F 8B F9
0160 | 38 30 5A 92 25 DE C0 E0 20 7F DB 16 C1 C4 17 C5
0170 | 61 60 F6 F5 40 39 C1 C6 12 A3 51 12 06 90 66 B3
0180 | 8C 10 40 94 C3 AC E0 0B A5 1A 12 0D FA 2C DA E9
0190 | 7A C3 54 B8 17 2D 0C 5B E0 C2 94 C3 AC 97 31 74
01A0 | E4 FE CA 50 BD B2 EF 1D EC C3 7D E6 54 8F 4D 5A
01B0 | F3 FA 59 7A 6B E2 68 B6 94 33 C6 91 5D 85 E4 4C
01C0 | 92 24 67 61 B4 B9 DE 64 8F CE BF FB B6 8A CA C9
01D0 | 96 8E D4 5A 07 E7 98 E4 3A EF B2 58 3E F3 42 C4
01E0 | 36 BB B0 D4 B2 49 72 94 E3 67 AF 3E B4 AE 89 84
01F0 | 49 3A EE 2C F6 1D 10 00 50 8D CE B1 B2 0D D9 9B
0200 | 71 FC 5D CB 05 46 4D 49 63 D9 17 D4 F4 05 59 F3
0210 | 86 C5 B8 0A 9E BF D9 8C 1E 10 A0 0E CA 34 4A EA
0220 | 47 6B B1 B6 E2 7E 92 20 1B 63 F8 93 C8 EE 10 36
0230 | B1 3E 2B 0E 0A C3 F6 C5 EE C8 CC DE A4 C5 41 CB
0240 | 57 D8 13 2C B5 2E C6 9B 1A 64 8F 3C 16 CD A7 77
0250 | 44 86 08 9A CF 2C C0 97 76 75 09 C1 8C F5 FC 44
0260 | FF 74 41 03 38 A6 C1 AB CD B5 1E D6 26 DC AE 32
0270 | 34 79 B3 43 34 87 4C 2D 05 DD 98 FE 8E 55 F4 46
0280 | 5F 86 5E 2F CF 1C 5B F2 04 93 A2 D6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F803569BED7766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A0020000</code> (672 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200BC64C0EE340FB933C2718E69</code> <code>BEBC56F7B83F9556D7EE47778465A46E</code> <code>15502AB228FC8104D9D34E629CF61E80</code> <code>F9E4DB7A9F5F98F0ED7E90AE85796D51</code> <code>422C98651CF7171365A7157A649BAD47</code> <code>8AA485355214E9FCBFCF97D4E9E2ECCF</code> <code>8C0FBAAD9F5860E1CEDF83085906C798</code> <code>518A1FD90F985A8CA9561987CA31C792</code> <code>DBAD7B79236C3506E64A57AD8395D931</code> <code>3549A6A0F6B29A60D6626AAE864B215F</code> <code>BE04A5F1EA06A60402D3C59F3A2E3984</code> <code>2ADC5BC9DF9441040B88B6EFEA017ED8</code> <code>040B2843FF06680AE7E0A6B8A7E59311</code> <code>F18BC5095D2B655E19CF396000A8BB19</code> <code>D0EEDAB9B58D3331E7DF012D8014EC09</code> <code>4338E86E1D57F19163A086E5DC5D489C</code> <code>C2BA3051B37BAA2EA2F947ECA131E1A5</code> <code>79A75F10B0B05962DF6CCE974E0027D5</code> <code>ECF0294EB04F8BF938305A9225DEC0E0</code> <code>207FDB16C1C417C56160F6F54039C1C6</code> <code>12A35112069066B38C104094C3ACE00B</code> <code>A51A120DFA2CDAE97AC354B8172D0C5B</code> <code>E0C294C3AC973174E4FECA50BDB2EF1D</code> <code>ECC37DE6548F4D5AF3FA597A6BE268B6</code> <code>9433C6915D85E44C92246761B4B9DE64</code> <code>8FCEBFFBB68ACAC9968ED45A07E798E4</code> <code>3AEFB2583EF342C436BBB0D4B2497294</code> <code>E367AF3EB4AE8984493AEE2CF61D1000</code> <code>508DCEB1B20DD99B71FC5DCB05464D49</code> <code>63D917D4F40559F386C5B80A9EBFD98C</code> <code>1E10A00ECA344AEA476BB1B6E27E9220</code> <code>1B63F893C8EE1036B13E2B0E0AC3F6C5</code> <code>EEC8CCDEA4C541CB57D8132CB52EC69B</code> <code>1A648F3C16CDA7774486089ACF2CC097</code> <code>767509C18CF5FC44FF74410338A6C1AB</code> <code>CDB51ED626DCAE323479B34334874C2D</code> <code>05DD98FE8E55F4465F865E2FCF1C5BF2</code><br> <code>0493A2D6</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = BC64C0EE340FB933C2718E69BEBC56F7B83F9556D7EE47778465A46E15502AB228FC8104D9D34E629CF61E80F9E4DB7A9F5F98F0ED7E90AE85796D51422C98651CF7171365A7157A649BAD478AA485355214E9FCBFCF97D4E9E2ECCF8C0FBAAD9F5860E1CEDF83085906C798518A1FD90F985A8CA9561987CA31C792DBAD7B79236C3506E64A57AD8395D9313549A6A0F6B29A60D6626AAE864B215FBE04A5F1EA06A60402D3C59F3A2E39842ADC5BC9DF9441040B88B6EFEA017ED8040B2843FF06680AE7E0A6B8A7E59311F18BC5095D2B655E19CF396000A8BB19D0EEDAB9B58D3331E7DF012D8014EC094338E86E1D57F19163A086E5DC5D489CC2BA3051B37BAA2EA2F947ECA131E1A579A75F10B0B05962DF6CCE974E0027D5ECF0294EB04F8BF938305A9225DEC0E0207FDB16C1C417C56160F6F54039C1C612A35112069066B38C104094C3ACE00BA51A120DFA2CDAE97AC354B8172D0C5BE0C294C3AC973174E4FECA50BDB2EF1DECC37DE6548F4D5AF3FA597A6BE268B69433C6915D85E44C92246761B4B9DE648FCEBFFBB68ACAC9968ED45A07E798E43AEFB2583EF342C436BBB0D4B2497294E367AF3EB4AE8984493AEE2CF61D1000508DCEB1B20DD99B71FC5DCB05464D4963D917D4F40559F386C5B80A9EBFD98C1E10A00ECA344AEA476BB1B6E27E92201B63F893C8EE1036B13E2B0E0AC3F6C5EEC8CCDEA4C541CB57D8132CB52EC69B1A648F3C16CDA7774486089ACF2CC097767509C18CF5FC44FF74410338A6C1ABCDB51ED626DCAE323479B34334874C2D05DD98FE8E55F4465F865E2FCF1C5BF20493A2D6
tmp_aes_key = 63BF1BC5DB02E0ADE18277C00F02786F3059DE28473FBEE7333DAB1495A9BE8C
tmp_aes_iv = D37420FF595A1B55C7F1700B81597A184B050F3DAB81CA004405375F345DF448</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1A81AC6A56C6470C624C8844979252D0C9B9E27EBA0D89B5BDD343628E0518351BEB12EFBCAFBB7C20FBB91886EE0C2EBFBD51E8A503409803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100915F316AF2EBC858375013FB985FD5C05B1A4FA4C2EC94F8F7C2A4BF738A9759F809DE8BB085A1F96372F20B9F1DAFC0009264EC99EDD8F8482F9DFF5744EDF7956B678E6828EA91D0583D99E7B11CE97BA03B75D77CA1F5B4F360807D38C2F04902F2AC7035C5AD1A1A43D4FC3E788FCC97AE32D1E94E75D289ACDC029E3DACAFFF1164318AAE73AC2253EC7C4876C6C1E45E9664F15A44404FE352BFB50965695472CDA99DDA361135FE5C197F5783F3E26EEC18944D58513C355EF6800E8738CD7B987DD9C934441A180206EEC010FF0D1A756769850D5FAFB05DFBA967B2D0BA5D69D6888089195A07249E175A6BE0194511EA6D2FF019A81426EDAE4A229BED776696FCFCE0315A79DD
answer = BA0D89B5BDD343628E0518351BEB12EFBCAFBB7C20FBB91886EE0C2EBFBD51E8A503409803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100915F316AF2EBC858375013FB985FD5C05B1A4FA4C2EC94F8F7C2A4BF738A9759F809DE8BB085A1F96372F20B9F1DAFC0009264EC99EDD8F8482F9DFF5744EDF7956B678E6828EA91D0583D99E7B11CE97BA03B75D77CA1F5B4F360807D38C2F04902F2AC7035C5AD1A1A43D4FC3E788FCC97AE32D1E94E75D289ACDC029E3DACAFFF1164318AAE73AC2253EC7C4876C6C1E45E9664F15A44404FE352BFB50965695472CDA99DDA361135FE5C197F5783F3E26EEC18944D58513C355EF6800E8738CD7B987DD9C934441A180206EEC010FF0D1A756769850D5FAFB05DFBA967B2D0BA5D69D6888089195A07249E175A6BE0194511EA6D2FF019A81426EDAE4A229BED776696FCFCE0315A79DD</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 BD D3 43 62 8E 05 18 35 1B EB 12 EF
0010 | BC AF BB 7C 20 FB B9 18 86 EE 0C 2E BF BD 51 E8
0020 | A5 03 40 98 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 91 5F 31 6A F2 EB C8 58 37 50 13 FB 98 5F D5 C0
0140 | 5B 1A 4F A4 C2 EC 94 F8 F7 C2 A4 BF 73 8A 97 59
0150 | F8 09 DE 8B B0 85 A1 F9 63 72 F2 0B 9F 1D AF C0
0160 | 00 92 64 EC 99 ED D8 F8 48 2F 9D FF 57 44 ED F7
0170 | 95 6B 67 8E 68 28 EA 91 D0 58 3D 99 E7 B1 1C E9
0180 | 7B A0 3B 75 D7 7C A1 F5 B4 F3 60 80 7D 38 C2 F0
0190 | 49 02 F2 AC 70 35 C5 AD 1A 1A 43 D4 FC 3E 78 8F
01A0 | CC 97 AE 32 D1 E9 4E 75 D2 89 AC DC 02 9E 3D AC
01B0 | AF FF 11 64 31 8A AE 73 AC 22 53 EC 7C 48 76 C6
01C0 | C1 E4 5E 96 64 F1 5A 44 40 4F E3 52 BF B5 09 65
01D0 | 69 54 72 CD A9 9D DA 36 11 35 FE 5C 19 7F 57 83
01E0 | F3 E2 6E EC 18 94 4D 58 51 3C 35 5E F6 80 0E 87
01F0 | 38 CD 7B 98 7D D9 C9 34 44 1A 18 02 06 EE C0 10
0200 | FF 0D 1A 75 67 69 85 0D 5F AF B0 5D FB A9 67 B2
0210 | D0 BA 5D 69 D6 88 80 89 19 5A 07 24 9E 17 5A 6B
0220 | E0 19 45 11 EA 6D 2F F0 19 A8 14 26 ED AE 4A 22
0230 | 9B ED 77 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100915F316AF2EBC858375013FB</code> <code>985FD5C05B1A4FA4C2EC94F8F7C2A4BF</code> <code>738A9759F809DE8BB085A1F96372F20B</code> <code>9F1DAFC0009264EC99EDD8F8482F9DFF</code> <code>5744EDF7956B678E6828EA91D0583D99</code> <code>E7B11CE97BA03B75D77CA1F5B4F36080</code> <code>7D38C2F04902F2AC7035C5AD1A1A43D4</code> <code>FC3E788FCC97AE32D1E94E75D289ACDC</code> <code>029E3DACAFFF1164318AAE73AC2253EC</code> <code>7C4876C6C1E45E9664F15A44404FE352</code> <code>BFB50965695472CDA99DDA361135FE5C</code> <code>197F5783F3E26EEC18944D58513C355E</code> <code>F6800E8738CD7B987DD9C934441A1802</code> <code>06EEC010FF0D1A756769850D5FAFB05D</code> <code>FBA967B2D0BA5D69D6888089195A0724</code> <code>9E175A6BE0194511EA6D2FF019A81426</code><br> <code>EDAE4A22</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>9BED7766</code> (1719135643 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 85F40B8BFC6E8574B767C1688EB24E0331A92CD2ECBE358F24CF362D93EE2DEEF61B7ADD62B9A442700CBDA83860048232597F3215540A27619DE5C975A31383BFD50332F9F7FBA8A7DF2FFDAC1A51B24A6E37A67D4363C427E1986F4769329E1C114D0D6285C05C1887BA606F296F49B145E5B0141AD6698CD8237E41494DF3F64E5C3BE577011F0CE1D82594929B3E58F35BF2ECEE5480D37871A9547DB5A5C586F3E980EA3B33BAC49A0BAFA71412004B3D6D55734673C72688DBD4C06BFA3DF9E72FBEF2261D64FCF684ABD7F2AE1627E3D86D2D4E9608644AE02447F4DBCF60C2218D2E7E255E8D3523FBB45A933E4709043E8247661F145496F9AA380A</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4C7F87CD92831F9C137C0E4E514710E8CACBB841CFC642D2C39623D1A675DFD8E99242C4F1E172C727F64DA6B0A265DCD3C35609A6A99CF284AAC1B14632D31AD8415C6BB963559981121E7DCC157FDB59B72AC980175AB7C605A22C759CFD2D36644BAF643984A31F86E2A00804062FBA7E9072CAC2837716E9251000C40D96EB3ECF5538565094CA1D2A499F425B6046177467028062D618B754F2534D89A2974D3BDF896139935F30C305DF67CB2BDD1D701823EDC17F1908E69FF324C33F7F830B38A08A8C11D99A0D8B01D2ED3501CEFD2B3710DC8CF4799C79F2AF844E921DCC5D583C55E6BAA618AFD49BE51D569C25CD970E1030252F808FF618CFAE</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 BD D3 43 62 8E 05 18 35 1B EB 12 EF
0010 | BC AF BB 7C 20 FB B9 18 86 EE 0C 2E BF BD 51 E8
0020 | A5 03 40 98 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 4C 7F 87 CD 92 83 1F 9C 13 7C 0E 4E 51 47 10 E8
0040 | CA CB B8 41 CF C6 42 D2 C3 96 23 D1 A6 75 DF D8
0050 | E9 92 42 C4 F1 E1 72 C7 27 F6 4D A6 B0 A2 65 DC
0060 | D3 C3 56 09 A6 A9 9C F2 84 AA C1 B1 46 32 D3 1A
0070 | D8 41 5C 6B B9 63 55 99 81 12 1E 7D CC 15 7F DB
0080 | 59 B7 2A C9 80 17 5A B7 C6 05 A2 2C 75 9C FD 2D
0090 | 36 64 4B AF 64 39 84 A3 1F 86 E2 A0 08 04 06 2F
00A0 | BA 7E 90 72 CA C2 83 77 16 E9 25 10 00 C4 0D 96
00B0 | EB 3E CF 55 38 56 50 94 CA 1D 2A 49 9F 42 5B 60
00C0 | 46 17 74 67 02 80 62 D6 18 B7 54 F2 53 4D 89 A2
00D0 | 97 4D 3B DF 89 61 39 93 5F 30 C3 05 DF 67 CB 2B
00E0 | DD 1D 70 18 23 ED C1 7F 19 08 E6 9F F3 24 C3 3F
00F0 | 7F 83 0B 38 A0 8A 8C 11 D9 9A 0D 8B 01 D2 ED 35
0100 | 01 CE FD 2B 37 10 DC 8C F4 79 9C 79 F2 AF 84 4E
0110 | 92 1D CC 5D 58 3C 55 E6 BA A6 18 AF D4 9B E5 1D
0120 | 56 9C 25 CD 97 0E 10 30 25 2F 80 8F F6 18 CF AE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004C7F87CD92831F9C137C0E4E</code> <code>514710E8CACBB841CFC642D2C39623D1</code> <code>A675DFD8E99242C4F1E172C727F64DA6</code> <code>B0A265DCD3C35609A6A99CF284AAC1B1</code> <code>4632D31AD8415C6BB963559981121E7D</code> <code>CC157FDB59B72AC980175AB7C605A22C</code> <code>759CFD2D36644BAF643984A31F86E2A0</code> <code>0804062FBA7E9072CAC2837716E92510</code> <code>00C40D96EB3ECF5538565094CA1D2A49</code> <code>9F425B6046177467028062D618B754F2</code> <code>534D89A2974D3BDF896139935F30C305</code> <code>DF67CB2BDD1D701823EDC17F1908E69F</code> <code>F324C33F7F830B38A08A8C11D99A0D8B</code> <code>01D2ED3501CEFD2B3710DC8CF4799C79</code> <code>F2AF844E921DCC5D583C55E6BAA618AF</code> <code>D49BE51D569C25CD970E1030252F808F</code><br> <code>F618CFAE</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366BDD343628E0518351BEB12EFBCAFBB7C20FBB91886EE0C2EBFBD51E8A50340980000000000000000FE0001004C7F87CD92831F9C137C0E4E514710E8CACBB841CFC642D2C39623D1A675DFD8E99242C4F1E172C727F64DA6B0A265DCD3C35609A6A99CF284AAC1B14632D31AD8415C6BB963559981121E7DCC157FDB59B72AC980175AB7C605A22C759CFD2D36644BAF643984A31F86E2A00804062FBA7E9072CAC2837716E9251000C40D96EB3ECF5538565094CA1D2A499F425B6046177467028062D618B754F2534D89A2974D3BDF896139935F30C305DF67CB2BDD1D701823EDC17F1908E69FF324C33F7F830B38A08A8C11D99A0D8B01D2ED3501CEFD2B3710DC8CF4799C79F2AF844E921DCC5D583C55E6BAA618AFD49BE51D569C25CD970E1030252F808FF618CFAE
padding = 2C0117281AD0958C0F04A25F
tmp_aes_key = 63BF1BC5DB02E0ADE18277C00F02786F3059DE28473FBEE7333DAB1495A9BE8C
tmp_aes_iv = D37420FF595A1B55C7F1700B81597A184B050F3DAB81CA004405375F345DF448</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 4D4F434D3F9C6BA064D27B62E563AC86D46F79C7334187270929F137A2F38F241113DA6F2E07B240A10079E4063081F26846395786AC9F47C73634123512C45D9A3D4733CDD63FCB91159F19D458B79193488B84D02B7F8521D7C6AA9F632558E436B0C865B201935AED75F6E4F33FE1633D1C79C9821BB62C838A1DF84DDE32AA6C5C19C872BB6A4835C6EAB93FD1C3680465210DB0E0ADEC3B155D742EBECEA4FB1E63CE68CAB77330543A7FC8ED2D2AD2A0D625BAF67E17312BE2C2D5C2C54C4A9C1C9F63BA207C7B8E301E71B8ADC1E0C8A8B9D1C6FC1618ED64D07A37A7DCF9ED2DB758098F88419644B5422EFD62710E46D0859A224CF4B5652E3FE7E3C4C3BBC675AB96772904B857D2D8E76ADF5032A6D6AFFAE0D4EA3F9183B2BC2461678716F118E0F735E28A558FF6BE33668C9666EA6B68049C635C344783A568C59D061480A4A8EB4936FCCF6117F272</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC 5B 05 00 9B ED 77 66
0010 | 78 01 00 00 1F 5F 04 F5 BD D3 43 62 8E 05 18 35
0020 | 1B EB 12 EF BC AF BB 7C 20 FB B9 18 86 EE 0C 2E
0030 | BF BD 51 E8 A5 03 40 98 FE 50 01 00 4D 4F 43 4D
0040 | 3F 9C 6B A0 64 D2 7B 62 E5 63 AC 86 D4 6F 79 C7
0050 | 33 41 87 27 09 29 F1 37 A2 F3 8F 24 11 13 DA 6F
0060 | 2E 07 B2 40 A1 00 79 E4 06 30 81 F2 68 46 39 57
0070 | 86 AC 9F 47 C7 36 34 12 35 12 C4 5D 9A 3D 47 33
0080 | CD D6 3F CB 91 15 9F 19 D4 58 B7 91 93 48 8B 84
0090 | D0 2B 7F 85 21 D7 C6 AA 9F 63 25 58 E4 36 B0 C8
00A0 | 65 B2 01 93 5A ED 75 F6 E4 F3 3F E1 63 3D 1C 79
00B0 | C9 82 1B B6 2C 83 8A 1D F8 4D DE 32 AA 6C 5C 19
00C0 | C8 72 BB 6A 48 35 C6 EA B9 3F D1 C3 68 04 65 21
00D0 | 0D B0 E0 AD EC 3B 15 5D 74 2E BE CE A4 FB 1E 63
00E0 | CE 68 CA B7 73 30 54 3A 7F C8 ED 2D 2A D2 A0 D6
00F0 | 25 BA F6 7E 17 31 2B E2 C2 D5 C2 C5 4C 4A 9C 1C
0100 | 9F 63 BA 20 7C 7B 8E 30 1E 71 B8 AD C1 E0 C8 A8
0110 | B9 D1 C6 FC 16 18 ED 64 D0 7A 37 A7 DC F9 ED 2D
0120 | B7 58 09 8F 88 41 96 44 B5 42 2E FD 62 71 0E 46
0130 | D0 85 9A 22 4C F4 B5 65 2E 3F E7 E3 C4 C3 BB C6
0140 | 75 AB 96 77 29 04 B8 57 D2 D8 E7 6A DF 50 32 A6
0150 | D6 AF FA E0 D4 EA 3F 91 83 B2 BC 24 61 67 87 16
0160 | F1 18 E0 F7 35 E2 8A 55 8F F6 BE 33 66 8C 96 66
0170 | EA 6B 68 04 9C 63 5C 34 47 83 A5 68 C5 9D 06 14
0180 | 80 A4 A8 EB 49 36 FC CF 61 17 F2 72</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CC5B05009BED7766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001004D4F434D3F9C6BA064D27B62</code> <code>E563AC86D46F79C7334187270929F137</code> <code>A2F38F241113DA6F2E07B240A10079E4</code> <code>063081F26846395786AC9F47C7363412</code> <code>3512C45D9A3D4733CDD63FCB91159F19</code> <code>D458B79193488B84D02B7F8521D7C6AA</code> <code>9F632558E436B0C865B201935AED75F6</code> <code>E4F33FE1633D1C79C9821BB62C838A1D</code> <code>F84DDE32AA6C5C19C872BB6A4835C6EA</code> <code>B93FD1C3680465210DB0E0ADEC3B155D</code> <code>742EBECEA4FB1E63CE68CAB77330543A</code> <code>7FC8ED2D2AD2A0D625BAF67E17312BE2</code> <code>C2D5C2C54C4A9C1C9F63BA207C7B8E30</code> <code>1E71B8ADC1E0C8A8B9D1C6FC1618ED64</code> <code>D07A37A7DCF9ED2DB758098F88419644</code> <code>B5422EFD62710E46D0859A224CF4B565</code> <code>2E3FE7E3C4C3BBC675AB96772904B857</code> <code>D2D8E76ADF5032A6D6AFFAE0D4EA3F91</code> <code>83B2BC2461678716F118E0F735E28A55</code> <code>8FF6BE33668C9666EA6B68049C635C34</code> <code>4783A568C59D061480A4A8EB4936FCCF</code><br> <code>6117F272</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 4CD3C3FF187CD37E9662FB897FBB2AE7A0FC0605E197D9E38679098F6E14733C9467624818FC014391A76FB45183D0AE8BF5F93769A1391F8FC19BAE426367A4B7A756F693342FD96A66F20C6C2637495377F7FF327EF401A28828C6759EA8CFC13AF4CC3A89CA20C1C940CEF532C7885349B5CE96963BEFB2ED64E56997E87B25E2A6DBC7072C48E6859D551252A6DB73F8DA90637A8E260D7B594E75AAFA1630815853B176EBD0B2CDF9F0DD0610942C1A862F9AD477C54ED5C2286A14F043E98711310B2A9CA0C756CA68585193E692C43C61015EBEB95CF9D81A9A714B97882F250D047AE9C3669F0BDA33F8A5729B6528917CA48F4E3A45B156121CC968</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 68 5C E9 9B ED 77 66
0010 | B0 00 00 00 34 F7 CB 3B BD D3 43 62 8E 05 18 35
0020 | 1B EB 12 EF BC AF BB 7C 20 FB B9 18 86 EE 0C 2E
0030 | BF BD 51 E8 A5 03 40 98 BE BA 32 DD A2 AC 6F 94
0040 | 07 61 48 8F 7B 8E C3 03</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01685CE99BED7766</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0000000</code> (176 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BDD343628E0518351BEB12EFBCAFBB7C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>20FBB91886EE0C2EBFBD51E8A5034098</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>BEBA32DDA2AC6F940761488F7B8EC303</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

