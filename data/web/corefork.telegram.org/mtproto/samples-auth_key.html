<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 0E 01 00 D7 A0 DA 68
0010 | 14 00 00 00 F1 8E 7E BE 0C E2 77 86 28 CB AA A1
0020 | 95 B5 B1 96 33 8B 80 F8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E40E0100D7A0DA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 1F F9 D7 A0 DA 68
0010 | 50 00 00 00 63 24 16 05 0C E2 77 86 28 CB AA A1
0020 | 95 B5 B1 96 33 8B 80 F8 B6 2D EF 9D E3 71 D9 D6
0030 | 9E 5B 43 CB 8E 2D 08 91 08 20 D3 9A B6 34 3F 06
0040 | 15 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B41FF9D7A0DA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0820D39AB6343F0615000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2365404336650913301</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2365404336650913301</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2365404336650913301 = 1440999127 * 1641502963</code></p>
<pre><code>p = 1440999127
q = 1641502963</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 D3 9A B6 34 3F 06 15 00 00 00
0010 | 04 55 E3 E6 D7 00 00 00 04 61 D7 58 F3 00 00 00
0020 | 0C E2 77 86 28 CB AA A1 95 B5 B1 96 33 8B 80 F8
0030 | B6 2D EF 9D E3 71 D9 D6 9E 5B 43 CB 8E 2D 08 91
0040 | DA 59 EF C2 CE 25 BB 3C FE 08 38 45 02 FA 56 8A
0050 | 68 ED E0 FC 53 CF D6 68 A4 93 68 9E FD 09 67 AB
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0820D39AB6343F0615000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2365404336650913301</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0455E3E6D7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1440999127</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0461D758F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1641502963</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>DA59EFC2CE25BB3CFE08384502FA568A</code> <code>68EDE0FC53CFD668A493689EFD0967AB</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90820D39AB6343F06150000000455E3E6D70000000461D758F30000000CE2778628CBAAA195B5B196338B80F8B62DEF9DE371D9D69E5B43CB8E2D0891DA59EFC2CE25BB3CFE08384502FA568A68EDE0FC53CFD668A493689EFD0967AB02000000
random_padding_bytes = B49A4C33F5816D487DAE33A29231785DB01CBD5E96FF26EE1A9E284D24A70292099768C919D182C018AD52AE9DA405A3BC5E891012863115A2DEBA701049DBDF0CAAC107409C46ADE8C7F383662E644EC4EDC82505046A2C66825DC7</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 2628A66B2D77AA0D01E77582257FBFE1BA7A6E1BDA1DA4D29BC259EDFD87F63DECC1E9E3202929C126F14DBDBF04B969EEC603101492B62B0469998F1D7DB175FB4D8F5CB3A199DAC1FDD0A12B8B607FC4B801402259A772F83B425051153E5A3880CDCDEDE4A504C50244EA799BCB4EDED28C1A79FB68BD828624FBD0419B5BB5CF06FA7BD62C4B2314C90C26FF1D61F9229FB8D37E7FBF1B441783895A8713A2DCFC2D7172943B7607F666BB9E38B47F9929276FBE21E8817C6F57D7CC4EDB1F9942CBB205AD7A736D52737DF370FB0DE097C5FC3E78FBF2D26CE300AB9D052707D3CA119C764891DF0A371D481113B75F0AE88DCE58D5691C5D93CCCFE8DD</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C 91 08 00 D8 A0 DA 68
0010 | 40 01 00 00 BE E4 12 D7 0C E2 77 86 28 CB AA A1
0020 | 95 B5 B1 96 33 8B 80 F8 B6 2D EF 9D E3 71 D9 D6
0030 | 9E 5B 43 CB 8E 2D 08 91 04 55 E3 E6 D7 00 00 00
0040 | 04 61 D7 58 F3 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 26 28 A6 6B 2D 77 AA 0D 01 E7 75 82
0060 | 25 7F BF E1 BA 7A 6E 1B DA 1D A4 D2 9B C2 59 ED
0070 | FD 87 F6 3D EC C1 E9 E3 20 29 29 C1 26 F1 4D BD
0080 | BF 04 B9 69 EE C6 03 10 14 92 B6 2B 04 69 99 8F
0090 | 1D 7D B1 75 FB 4D 8F 5C B3 A1 99 DA C1 FD D0 A1
00A0 | 2B 8B 60 7F C4 B8 01 40 22 59 A7 72 F8 3B 42 50
00B0 | 51 15 3E 5A 38 80 CD CD ED E4 A5 04 C5 02 44 EA
00C0 | 79 9B CB 4E DE D2 8C 1A 79 FB 68 BD 82 86 24 FB
00D0 | D0 41 9B 5B B5 CF 06 FA 7B D6 2C 4B 23 14 C9 0C
00E0 | 26 FF 1D 61 F9 22 9F B8 D3 7E 7F BF 1B 44 17 83
00F0 | 89 5A 87 13 A2 DC FC 2D 71 72 94 3B 76 07 F6 66
0100 | BB 9E 38 B4 7F 99 29 27 6F BE 21 E8 81 7C 6F 57
0110 | D7 CC 4E DB 1F 99 42 CB B2 05 AD 7A 73 6D 52 73
0120 | 7D F3 70 FB 0D E0 97 C5 FC 3E 78 FB F2 D2 6C E3
0130 | 00 AB 9D 05 27 07 D3 CA 11 9C 76 48 91 DF 0A 37
0140 | 1D 48 11 13 B7 5F 0A E8 8D CE 58 D5 69 1C 5D 93
0150 | CC CF E8 DD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6C910800D8A0DA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0455E3E6D7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1440999127</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0461D758F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1641502963</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001002628A66B2D77AA0D01E77582</code> <code>257FBFE1BA7A6E1BDA1DA4D29BC259ED</code> <code>FD87F63DECC1E9E3202929C126F14DBD</code> <code>BF04B969EEC603101492B62B0469998F</code> <code>1D7DB175FB4D8F5CB3A199DAC1FDD0A1</code> <code>2B8B607FC4B801402259A772F83B4250</code> <code>51153E5A3880CDCDEDE4A504C50244EA</code> <code>799BCB4EDED28C1A79FB68BD828624FB</code> <code>D0419B5BB5CF06FA7BD62C4B2314C90C</code> <code>26FF1D61F9229FB8D37E7FBF1B441783</code> <code>895A8713A2DCFC2D7172943B7607F666</code> <code>BB9E38B47F9929276FBE21E8817C6F57</code> <code>D7CC4EDB1F9942CBB205AD7A736D5273</code> <code>7DF370FB0DE097C5FC3E78FBF2D26CE3</code> <code>00AB9D052707D3CA119C764891DF0A37</code> <code>1D481113B75F0AE88DCE58D5691C5D93</code><br> <code>CCCFE8DD</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 50 DD 16 D8 A0 DA 68
0010 | 78 02 00 00 5C 07 E8 D0 0C E2 77 86 28 CB AA A1
0020 | 95 B5 B1 96 33 8B 80 F8 B6 2D EF 9D E3 71 D9 D6
0030 | 9E 5B 43 CB 8E 2D 08 91 FE 50 02 00 56 72 A5 4A
0040 | BB FB A7 BD DF 02 05 44 7F FA 4A 0A 2A FE F0 89
0050 | 30 C4 00 14 AE 4B 12 F0 F1 B8 AE 0C BB 6B A5 68
0060 | 53 00 84 24 9D D4 F7 5D 29 6C FE 85 A6 20 7D 4C
0070 | 8A 97 B5 14 05 11 C4 85 A0 79 58 66 18 C5 2E D6
0080 | F8 92 A8 55 37 70 86 7A CD 7C 5F 22 27 64 FC 21
0090 | 2B 36 F3 91 63 D6 E9 FD 66 BA 0D 0D 73 EA 46 1F
00A0 | 26 BD EB 61 14 E6 10 18 55 EF 5E CD 24 EE D6 6E
00B0 | F9 72 F1 D3 BD 78 3F A5 DA 8A B3 71 C1 61 2E F4
00C0 | E9 2D AF 37 E0 1D 64 65 7F 73 B5 E9 92 6F 83 BE
00D0 | 15 29 90 71 FE 04 E5 09 1A AE 47 B5 82 AA 3C 4C
00E0 | 16 0B CC 8B A2 C0 02 F8 2A 9C 63 91 8A 5A D4 C6
00F0 | 2B F0 E5 4A 60 87 2B F0 06 57 02 62 73 8A 59 2E
0100 | 0D E1 D5 EF E4 22 F2 8A E8 2D 7C D0 7D 93 1A D6
0110 | 28 3E 2D B2 EB C5 56 8B 4E FE B9 71 09 C4 C4 F7
0120 | AA 0F FF 75 7E 3D 24 90 94 7F 61 4B 1D F6 D8 AA
0130 | 54 CB 64 DC D9 79 2D 46 C9 3E 4A 45 6C 36 7D 56
0140 | 03 DE 7B 20 30 84 B4 5E 9C DD 9F 23 EA 0E 7A CD
0150 | 09 D9 29 DD DB 4E D4 87 39 73 6C E3 E9 DB 50 3F
0160 | 47 87 E3 BE C9 EF 5D F6 49 F1 3D 7D 24 9B 17 12
0170 | C8 60 B5 CA 94 BD E2 D6 D3 A9 C2 21 01 37 CF F7
0180 | A3 F5 FC 32 6C 5E 02 CC 63 21 B2 F6 53 2D D2 93
0190 | 71 66 87 10 8E 24 83 CD 71 42 3B CF FF 59 85 38
01A0 | 0E B6 9E A3 57 C0 70 9C 5F B1 72 BD D2 B0 CE 00
01B0 | 4F 80 A6 51 2E E5 32 1A 1A 33 20 0B 09 07 DF 46
01C0 | 7F F1 C1 DF 29 D7 23 14 DE 28 5B 6F 82 E2 A8 AD
01D0 | 1F EB BF 4C 5A 80 63 1D CE F4 18 16 3B 2D 01 FB
01E0 | C0 CA 7B 4C BB 85 DF 4D 3B 1B C8 D8 E2 CD C5 8E
01F0 | FF 39 C5 19 FD DB 9E 2C 5A EF EE 36 E3 2A 0A 0F
0200 | 60 A5 53 7F 04 37 CE D3 88 D1 E6 BA 49 6B 89 DE
0210 | B8 A3 FC 14 6E A6 06 F5 EC DD 05 DF B6 C8 5F 9E
0220 | 34 46 56 8A BB A2 43 B1 0C 0C 69 CC 9B 95 45 DB
0230 | 93 0A 3A EE C2 F5 7F C6 EA 28 2A D0 C8 57 57 60
0240 | 39 31 4C 4E 28 50 A5 AE C6 09 A9 37 30 01 EE 35
0250 | 37 57 9E B3 B4 A1 65 4C 3E 1C CD CD 60 C7 6A CC
0260 | 8A D3 0C 21 20 F1 D7 C0 17 6D FE 3D B2 20 19 DC
0270 | 97 96 33 DC 9F 10 F7 1F C4 B3 B6 70 89 9B 2A 2F
0280 | 42 DD 98 E2 0F 89 E9 10 73 DC C8 44</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0150DD16D8A0DA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002005672A54ABBFBA7BDDF020544</code> <code>7FFA4A0A2AFEF08930C40014AE4B12F0</code> <code>F1B8AE0CBB6BA568530084249DD4F75D</code> <code>296CFE85A6207D4C8A97B5140511C485</code> <code>A079586618C52ED6F892A8553770867A</code> <code>CD7C5F222764FC212B36F39163D6E9FD</code> <code>66BA0D0D73EA461F26BDEB6114E61018</code> <code>55EF5ECD24EED66EF972F1D3BD783FA5</code> <code>DA8AB371C1612EF4E92DAF37E01D6465</code> <code>7F73B5E9926F83BE15299071FE04E509</code> <code>1AAE47B582AA3C4C160BCC8BA2C002F8</code> <code>2A9C63918A5AD4C62BF0E54A60872BF0</code> <code>06570262738A592E0DE1D5EFE422F28A</code> <code>E82D7CD07D931AD6283E2DB2EBC5568B</code> <code>4EFEB97109C4C4F7AA0FFF757E3D2490</code> <code>947F614B1DF6D8AA54CB64DCD9792D46</code> <code>C93E4A456C367D5603DE7B203084B45E</code> <code>9CDD9F23EA0E7ACD09D929DDDB4ED487</code> <code>39736CE3E9DB503F4787E3BEC9EF5DF6</code> <code>49F13D7D249B1712C860B5CA94BDE2D6</code> <code>D3A9C2210137CFF7A3F5FC326C5E02CC</code> <code>6321B2F6532DD293716687108E2483CD</code> <code>71423BCFFF5985380EB69EA357C0709C</code> <code>5FB172BDD2B0CE004F80A6512EE5321A</code> <code>1A33200B0907DF467FF1C1DF29D72314</code> <code>DE285B6F82E2A8AD1FEBBF4C5A80631D</code> <code>CEF418163B2D01FBC0CA7B4CBB85DF4D</code> <code>3B1BC8D8E2CDC58EFF39C519FDDB9E2C</code> <code>5AEFEE36E32A0A0F60A5537F0437CED3</code> <code>88D1E6BA496B89DEB8A3FC146EA606F5</code> <code>ECDD05DFB6C85F9E3446568ABBA243B1</code> <code>0C0C69CC9B9545DB930A3AEEC2F57FC6</code> <code>EA282AD0C857576039314C4E2850A5AE</code> <code>C609A9373001EE3537579EB3B4A1654C</code> <code>3E1CCDCD60C76ACC8AD30C2120F1D7C0</code> <code>176DFE3DB22019DC979633DC9F10F71F</code> <code>C4B3B670899B2A2F42DD98E20F89E910</code><br> <code>73DCC844</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 5672A54ABBFBA7BDDF0205447FFA4A0A2AFEF08930C40014AE4B12F0F1B8AE0CBB6BA568530084249DD4F75D296CFE85A6207D4C8A97B5140511C485A079586618C52ED6F892A8553770867ACD7C5F222764FC212B36F39163D6E9FD66BA0D0D73EA461F26BDEB6114E6101855EF5ECD24EED66EF972F1D3BD783FA5DA8AB371C1612EF4E92DAF37E01D64657F73B5E9926F83BE15299071FE04E5091AAE47B582AA3C4C160BCC8BA2C002F82A9C63918A5AD4C62BF0E54A60872BF006570262738A592E0DE1D5EFE422F28AE82D7CD07D931AD6283E2DB2EBC5568B4EFEB97109C4C4F7AA0FFF757E3D2490947F614B1DF6D8AA54CB64DCD9792D46C93E4A456C367D5603DE7B203084B45E9CDD9F23EA0E7ACD09D929DDDB4ED48739736CE3E9DB503F4787E3BEC9EF5DF649F13D7D249B1712C860B5CA94BDE2D6D3A9C2210137CFF7A3F5FC326C5E02CC6321B2F6532DD293716687108E2483CD71423BCFFF5985380EB69EA357C0709C5FB172BDD2B0CE004F80A6512EE5321A1A33200B0907DF467FF1C1DF29D72314DE285B6F82E2A8AD1FEBBF4C5A80631DCEF418163B2D01FBC0CA7B4CBB85DF4D3B1BC8D8E2CDC58EFF39C519FDDB9E2C5AEFEE36E32A0A0F60A5537F0437CED388D1E6BA496B89DEB8A3FC146EA606F5ECDD05DFB6C85F9E3446568ABBA243B10C0C69CC9B9545DB930A3AEEC2F57FC6EA282AD0C857576039314C4E2850A5AEC609A9373001EE3537579EB3B4A1654C3E1CCDCD60C76ACC8AD30C2120F1D7C0176DFE3DB22019DC979633DC9F10F71FC4B3B670899B2A2F42DD98E20F89E91073DCC844
tmp_aes_key = CE3E99C80FF0820F93F7EBE57E9A5A390976858742BC398DCCA40B4BF20FCFDF
tmp_aes_iv = 199DEFCCD33D1DBA5889EC4E52FD73DD55A960059244969753CB89E7DA59EFC2</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 98386C361D7A9533FE68D28525F212E9DB5770F6BA0D89B50CE2778628CBAAA195B5B196338B80F8B62DEF9DE371D9D69E5B43CB8E2D089103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000D0F1A77221CB3EE0C80BA529E687CA3D439D57B4B5197828933D89F4D2DE497099EF54D8F820D20F11675FFD558E50681747E166ADA15AAD505668D9558D600B94D55DE288DCF1760531BF6072825E289E40F3F436D056B31E0D671990B6954D6CBEC90F81A8A3A2BD6EE365DA97BD56578CBEF84F21548B3B7C2FF3405DD3ED1B3CC0C4ABA818C58E0AC9F59F28E96A83554F6DB3CCC4B813BE045EADDC4BABBA62B6657A528773D6E27C2B58E79E46C7E48CF078E302D8B2208ED397E3DB4ABFA2A7642EAA017847046B22C26F237FB61CB0C68956B5F067356820E57FB51B548653ADFB9610E92A1AB2DCBFD8C08B966953379047EAE62046D46A183D56BD8A0DA6881A79DF9A9A7DD0F
answer = BA0D89B50CE2778628CBAAA195B5B196338B80F8B62DEF9DE371D9D69E5B43CB8E2D089103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000D0F1A77221CB3EE0C80BA529E687CA3D439D57B4B5197828933D89F4D2DE497099EF54D8F820D20F11675FFD558E50681747E166ADA15AAD505668D9558D600B94D55DE288DCF1760531BF6072825E289E40F3F436D056B31E0D671990B6954D6CBEC90F81A8A3A2BD6EE365DA97BD56578CBEF84F21548B3B7C2FF3405DD3ED1B3CC0C4ABA818C58E0AC9F59F28E96A83554F6DB3CCC4B813BE045EADDC4BABBA62B6657A528773D6E27C2B58E79E46C7E48CF078E302D8B2208ED397E3DB4ABFA2A7642EAA017847046B22C26F237FB61CB0C68956B5F067356820E57FB51B548653ADFB9610E92A1AB2DCBFD8C08B966953379047EAE62046D46A183D56BD8A0DA6881A79DF9A9A7DD0F</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 0C E2 77 86 28 CB AA A1 95 B5 B1 96
0010 | 33 8B 80 F8 B6 2D EF 9D E3 71 D9 D6 9E 5B 43 CB
0020 | 8E 2D 08 91 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 0D 0F 1A 77 22 1C B3 EE 0C 80 BA 52 9E 68 7C A3
0140 | D4 39 D5 7B 4B 51 97 82 89 33 D8 9F 4D 2D E4 97
0150 | 09 9E F5 4D 8F 82 0D 20 F1 16 75 FF D5 58 E5 06
0160 | 81 74 7E 16 6A DA 15 AA D5 05 66 8D 95 58 D6 00
0170 | B9 4D 55 DE 28 8D CF 17 60 53 1B F6 07 28 25 E2
0180 | 89 E4 0F 3F 43 6D 05 6B 31 E0 D6 71 99 0B 69 54
0190 | D6 CB EC 90 F8 1A 8A 3A 2B D6 EE 36 5D A9 7B D5
01A0 | 65 78 CB EF 84 F2 15 48 B3 B7 C2 FF 34 05 DD 3E
01B0 | D1 B3 CC 0C 4A BA 81 8C 58 E0 AC 9F 59 F2 8E 96
01C0 | A8 35 54 F6 DB 3C CC 4B 81 3B E0 45 EA DD C4 BA
01D0 | BB A6 2B 66 57 A5 28 77 3D 6E 27 C2 B5 8E 79 E4
01E0 | 6C 7E 48 CF 07 8E 30 2D 8B 22 08 ED 39 7E 3D B4
01F0 | AB FA 2A 76 42 EA A0 17 84 70 46 B2 2C 26 F2 37
0200 | FB 61 CB 0C 68 95 6B 5F 06 73 56 82 0E 57 FB 51
0210 | B5 48 65 3A DF B9 61 0E 92 A1 AB 2D CB FD 8C 08
0220 | B9 66 95 33 79 04 7E AE 62 04 6D 46 A1 83 D5 6B
0230 | D8 A0 DA 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001000D0F1A77221CB3EE0C80BA52</code> <code>9E687CA3D439D57B4B5197828933D89F</code> <code>4D2DE497099EF54D8F820D20F11675FF</code> <code>D558E50681747E166ADA15AAD505668D</code> <code>9558D600B94D55DE288DCF1760531BF6</code> <code>072825E289E40F3F436D056B31E0D671</code> <code>990B6954D6CBEC90F81A8A3A2BD6EE36</code> <code>5DA97BD56578CBEF84F21548B3B7C2FF</code> <code>3405DD3ED1B3CC0C4ABA818C58E0AC9F</code> <code>59F28E96A83554F6DB3CCC4B813BE045</code> <code>EADDC4BABBA62B6657A528773D6E27C2</code> <code>B58E79E46C7E48CF078E302D8B2208ED</code> <code>397E3DB4ABFA2A7642EAA017847046B2</code> <code>2C26F237FB61CB0C68956B5F06735682</code> <code>0E57FB51B548653ADFB9610E92A1AB2D</code> <code>CBFD8C08B966953379047EAE62046D46</code><br> <code>A183D56B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>D8A0DA68</code> (1759158488 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 582E066E5C75B9B47B4E4135DE2E0EF6624EE3667829E552A9D4B5E116BC477F260FCC60969B903B4B6B6777DC366BEF0DAAD4CE6B82ECA490B05E4AF5D47021BAAFDA76EC441341D17C0E1872AC52A9BFB222E79CF50305AC792DD76369F30148F4939044416732E0D126E4BED782F99775F54A427D07FD7107D1E9FDEA8186908D5A2C96D4560F15019081B57FA351D309D291430AB2B58EB1AD2047A304D8FEC1D3BB72589B345C590D901707C989D9B0E95693DA51EE3BCE12B89111B19F004E4DC58D3674D9E1E6DA83AECEAFB6845EB7111A237680C26E42CB6F5BD37447EF21A0562CCFB4246045D66AB916A6EF40EFF6102CFE65CBC55D532A0F378B</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 499FFA812DBBDEB109FB34A31F8480392498BB48841A809E1870D03455DB71E5494D0F0A2BB9C83C22ED1935FED07E3075645F3C782929EA5282EAC5ADF0093C4FB26D5CDFBE8D4E47F9F084EE965959B6530377EDCD586CA02000847BF9ED291CAE33B876B62A90A81F6FA1C65DBBD2C8784840553CB57634B5566675468FBA836F913148477E2D52CBE77F9D545C9734B1D3718A8BEB5CEE826B8FC977D6610C84001F0BF47A311E743AA1DE79C795DF4BCE026099176B72D3932304218477488E3A10836B24C3EB4C34E41E1645465B3AE5DC8B1373A6695C753B6BA204710DDE99B107F72F4B73B1F73464659119E1E1519C9654B8B3AB244FEABFD0612E</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 0C E2 77 86 28 CB AA A1 95 B5 B1 96
0010 | 33 8B 80 F8 B6 2D EF 9D E3 71 D9 D6 9E 5B 43 CB
0020 | 8E 2D 08 91 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 49 9F FA 81 2D BB DE B1 09 FB 34 A3 1F 84 80 39
0040 | 24 98 BB 48 84 1A 80 9E 18 70 D0 34 55 DB 71 E5
0050 | 49 4D 0F 0A 2B B9 C8 3C 22 ED 19 35 FE D0 7E 30
0060 | 75 64 5F 3C 78 29 29 EA 52 82 EA C5 AD F0 09 3C
0070 | 4F B2 6D 5C DF BE 8D 4E 47 F9 F0 84 EE 96 59 59
0080 | B6 53 03 77 ED CD 58 6C A0 20 00 84 7B F9 ED 29
0090 | 1C AE 33 B8 76 B6 2A 90 A8 1F 6F A1 C6 5D BB D2
00A0 | C8 78 48 40 55 3C B5 76 34 B5 56 66 75 46 8F BA
00B0 | 83 6F 91 31 48 47 7E 2D 52 CB E7 7F 9D 54 5C 97
00C0 | 34 B1 D3 71 8A 8B EB 5C EE 82 6B 8F C9 77 D6 61
00D0 | 0C 84 00 1F 0B F4 7A 31 1E 74 3A A1 DE 79 C7 95
00E0 | DF 4B CE 02 60 99 17 6B 72 D3 93 23 04 21 84 77
00F0 | 48 8E 3A 10 83 6B 24 C3 EB 4C 34 E4 1E 16 45 46
0100 | 5B 3A E5 DC 8B 13 73 A6 69 5C 75 3B 6B A2 04 71
0110 | 0D DE 99 B1 07 F7 2F 4B 73 B1 F7 34 64 65 91 19
0120 | E1 E1 51 9C 96 54 B8 B3 AB 24 4F EA BF D0 61 2E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100499FFA812DBBDEB109FB34A3</code> <code>1F8480392498BB48841A809E1870D034</code> <code>55DB71E5494D0F0A2BB9C83C22ED1935</code> <code>FED07E3075645F3C782929EA5282EAC5</code> <code>ADF0093C4FB26D5CDFBE8D4E47F9F084</code> <code>EE965959B6530377EDCD586CA0200084</code> <code>7BF9ED291CAE33B876B62A90A81F6FA1</code> <code>C65DBBD2C8784840553CB57634B55666</code> <code>75468FBA836F913148477E2D52CBE77F</code> <code>9D545C9734B1D3718A8BEB5CEE826B8F</code> <code>C977D6610C84001F0BF47A311E743AA1</code> <code>DE79C795DF4BCE026099176B72D39323</code> <code>04218477488E3A10836B24C3EB4C34E4</code> <code>1E1645465B3AE5DC8B1373A6695C753B</code> <code>6BA204710DDE99B107F72F4B73B1F734</code> <code>64659119E1E1519C9654B8B3AB244FEA</code><br> <code>BFD0612E</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643660CE2778628CBAAA195B5B196338B80F8B62DEF9DE371D9D69E5B43CB8E2D08910000000000000000FE000100499FFA812DBBDEB109FB34A31F8480392498BB48841A809E1870D03455DB71E5494D0F0A2BB9C83C22ED1935FED07E3075645F3C782929EA5282EAC5ADF0093C4FB26D5CDFBE8D4E47F9F084EE965959B6530377EDCD586CA02000847BF9ED291CAE33B876B62A90A81F6FA1C65DBBD2C8784840553CB57634B5566675468FBA836F913148477E2D52CBE77F9D545C9734B1D3718A8BEB5CEE826B8FC977D6610C84001F0BF47A311E743AA1DE79C795DF4BCE026099176B72D3932304218477488E3A10836B24C3EB4C34E41E1645465B3AE5DC8B1373A6695C753B6BA204710DDE99B107F72F4B73B1F73464659119E1E1519C9654B8B3AB244FEABFD0612E
padding = 812FDB9AA9F837AB771914A5
tmp_aes_key = CE3E99C80FF0820F93F7EBE57E9A5A390976858742BC398DCCA40B4BF20FCFDF
tmp_aes_iv = 199DEFCCD33D1DBA5889EC4E52FD73DD55A960059244969753CB89E7DA59EFC2</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 6862E2A211F211E0F4B79CD6DDA3ADFA845C1D21D919811658907E9235E563F399F00BA660AC02D98EC5A2A2FDDCD748245A33DD6FA6C1E0537B7EC2F9BCB27C2DA339E64907DF4E74FC7A1C4C36EAFEC3838294D12DCDF15A1DFE5906DA30F6BB7BF6E6886338716CA3879B8E878D021CBA10D25A2BE56C18703950007F666B4F0769833CDA347B64402061559F4BC545266D47BC89D15073C9809791E0308BF3712DB839FF243B85AD71D1DAECA782024BCD40855F737244694F77A8B2E94DC96DD5162BD81E93C532CE6377DEE1442921A7409799CEAF3C8AC40C29CB2BFF8C023F20E471C8BE7F045359F4DACDF511A0D03B4944C6C1019EABFD067FA421AD70C293F91F20E182FCB1EB15E031D1A7709F2B35E8CA28DFBDFF97E80C68F94252A7BFF59F311F20D0BA793C7248607C39F21FD2FBFB0E2C71AF8A5D60909B2880A6EDDC1EA40BF682BEACE3B1A38B</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 70 91 08 00 D8 A0 DA 68
0010 | 78 01 00 00 1F 5F 04 F5 0C E2 77 86 28 CB AA A1
0020 | 95 B5 B1 96 33 8B 80 F8 B6 2D EF 9D E3 71 D9 D6
0030 | 9E 5B 43 CB 8E 2D 08 91 FE 50 01 00 68 62 E2 A2
0040 | 11 F2 11 E0 F4 B7 9C D6 DD A3 AD FA 84 5C 1D 21
0050 | D9 19 81 16 58 90 7E 92 35 E5 63 F3 99 F0 0B A6
0060 | 60 AC 02 D9 8E C5 A2 A2 FD DC D7 48 24 5A 33 DD
0070 | 6F A6 C1 E0 53 7B 7E C2 F9 BC B2 7C 2D A3 39 E6
0080 | 49 07 DF 4E 74 FC 7A 1C 4C 36 EA FE C3 83 82 94
0090 | D1 2D CD F1 5A 1D FE 59 06 DA 30 F6 BB 7B F6 E6
00A0 | 88 63 38 71 6C A3 87 9B 8E 87 8D 02 1C BA 10 D2
00B0 | 5A 2B E5 6C 18 70 39 50 00 7F 66 6B 4F 07 69 83
00C0 | 3C DA 34 7B 64 40 20 61 55 9F 4B C5 45 26 6D 47
00D0 | BC 89 D1 50 73 C9 80 97 91 E0 30 8B F3 71 2D B8
00E0 | 39 FF 24 3B 85 AD 71 D1 DA EC A7 82 02 4B CD 40
00F0 | 85 5F 73 72 44 69 4F 77 A8 B2 E9 4D C9 6D D5 16
0100 | 2B D8 1E 93 C5 32 CE 63 77 DE E1 44 29 21 A7 40
0110 | 97 99 CE AF 3C 8A C4 0C 29 CB 2B FF 8C 02 3F 20
0120 | E4 71 C8 BE 7F 04 53 59 F4 DA CD F5 11 A0 D0 3B
0130 | 49 44 C6 C1 01 9E AB FD 06 7F A4 21 AD 70 C2 93
0140 | F9 1F 20 E1 82 FC B1 EB 15 E0 31 D1 A7 70 9F 2B
0150 | 35 E8 CA 28 DF BD FF 97 E8 0C 68 F9 42 52 A7 BF
0160 | F5 9F 31 1F 20 D0 BA 79 3C 72 48 60 7C 39 F2 1F
0170 | D2 FB FB 0E 2C 71 AF 8A 5D 60 90 9B 28 80 A6 ED
0180 | DC 1E A4 0B F6 82 BE AC E3 B1 A3 8B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>70910800D8A0DA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001006862E2A211F211E0F4B79CD6</code> <code>DDA3ADFA845C1D21D919811658907E92</code> <code>35E563F399F00BA660AC02D98EC5A2A2</code> <code>FDDCD748245A33DD6FA6C1E0537B7EC2</code> <code>F9BCB27C2DA339E64907DF4E74FC7A1C</code> <code>4C36EAFEC3838294D12DCDF15A1DFE59</code> <code>06DA30F6BB7BF6E6886338716CA3879B</code> <code>8E878D021CBA10D25A2BE56C18703950</code> <code>007F666B4F0769833CDA347B64402061</code> <code>559F4BC545266D47BC89D15073C98097</code> <code>91E0308BF3712DB839FF243B85AD71D1</code> <code>DAECA782024BCD40855F737244694F77</code> <code>A8B2E94DC96DD5162BD81E93C532CE63</code> <code>77DEE1442921A7409799CEAF3C8AC40C</code> <code>29CB2BFF8C023F20E471C8BE7F045359</code> <code>F4DACDF511A0D03B4944C6C1019EABFD</code> <code>067FA421AD70C293F91F20E182FCB1EB</code> <code>15E031D1A7709F2B35E8CA28DFBDFF97</code> <code>E80C68F94252A7BFF59F311F20D0BA79</code> <code>3C7248607C39F21FD2FBFB0E2C71AF8A</code> <code>5D60909B2880A6EDDC1EA40BF682BEAC</code><br> <code>E3B1A38B</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 6F2158FADA4D9ED93959AC5E954268E4328B9041BEDAFF5192DC9377572DFE870AD8F188C86900D34048CA3C42545BCDBA9A0D97D07D8FC0455F813B69FF397DFF4CF7614F1B682A7D4AD5712237A079C79E6E99FAEDDC7D992B07906EAA330DAD2D57C9B0F5A271C153C575359602883C05CF8467431A2D328BF54E14B7732AF277DA449221D74BAC7E01B189419295635C27B26316208AA0A1D74DEE2D45509CF7B478FDFF85D9B338FC60356248E0C65B3AB22E6D86F860F534BE5C6F7AED48905EC1C4C20996BA47163AC8717645F0BE7E7F0426BDB892FFAB0C403928058B38B071508E672B646FAB02C82E1429E5082A26FD0EA39978AF1BB9953A8A0F</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C F0 06 D9 A0 DA 68
0010 | 34 00 00 00 34 F7 CB 3B 0C E2 77 86 28 CB AA A1
0020 | 95 B5 B1 96 33 8B 80 F8 B6 2D EF 9D E3 71 D9 D6
0030 | 9E 5B 43 CB 8E 2D 08 91 C8 99 36 46 FD 47 41 86
0040 | 68 A3 A3 B7 D7 01 57 C4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017CF006D9A0DA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0CE2778628CBAAA195B5B196338B80F8</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B62DEF9DE371D9D69E5B43CB8E2D0891</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>C8993646FD47418668A3A3B7D70157C4</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

