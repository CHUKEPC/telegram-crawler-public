<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 8C 61 05 00 2E AD BE 68
0010 | 14 00 00 00 F1 8E 7E BE ED 88 08 2C 9E 31 42 AF
0020 | 9F 7D 49 83 81 3F 3C 25</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>8C6105002EADBE68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 14 6B F5 2E AD BE 68
0010 | 50 00 00 00 63 24 16 05 ED 88 08 2C 9E 31 42 AF
0020 | 9F 7D 49 83 81 3F 3C 25 FB FB 10 A0 17 3F B0 34
0030 | E2 DD BB A7 9E 35 3B 93 08 1D FE 07 4C 6C C8 38
0040 | 99 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01146BF52EADBE68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081DFE074C6CC83899000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2161172896008386713</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2161172896008386713</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2161172896008386713 = 1420045283 * 1521904211</code></p>
<pre><code>p = 1420045283
q = 1521904211</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1D FE 07 4C 6C C8 38 99 00 00 00
0010 | 04 54 A4 2B E3 00 00 00 04 5A B6 6A 53 00 00 00
0020 | ED 88 08 2C 9E 31 42 AF 9F 7D 49 83 81 3F 3C 25
0030 | FB FB 10 A0 17 3F B0 34 E2 DD BB A7 9E 35 3B 93
0040 | C8 79 45 4E 8F 91 AA E0 8B FE 5B AA 76 B6 8B BA
0050 | 8A 1A A3 CA 9D AC C9 92 4E A4 62 E4 A5 8B AD 9E
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081DFE074C6CC83899000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2161172896008386713</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0454A42BE3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1420045283</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045AB66A53000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1521904211</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>C879454E8F91AAE08BFE5BAA76B68BBA</code> <code>8A1AA3CA9DACC9924EA462E4A58BAD9E</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081DFE074C6CC838990000000454A42BE3000000045AB66A53000000ED88082C9E3142AF9F7D4983813F3C25FBFB10A0173FB034E2DDBBA79E353B93C879454E8F91AAE08BFE5BAA76B68BBA8A1AA3CA9DACC9924EA462E4A58BAD9E02000000
random_padding_bytes = 2866CA84847DFCE82981CC50289FF04500EEACD3EF5FE40AB60F3D0D93A9B5C9CD9684D804912EF30EFDED2D1DDF7C3C65104D3E1506AFCB742A3DFC5B4BB09122760A181561B82862E94F3FDF33F628D6276E68F46A2A919F53ACD5</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A6694AEF25B8150416DE64A1B2D9EEDD3AE5FBFE6D84004C6CEDB4797594AB2CB55E167F67832447445E4D747A2AD41F7FF956EDF8D18A25CE29D892B7EC8A0AFD6A8EA5EA29FBDEFC17C78F265C873178ABD36CA99CF54626B089C1A3763FF2FE272FEE59431524FA5E42594488EE058D391203DC874682474BE53B276847186A51E09C5E0EABBBFC536D4E101578A38056608FBFB0BEA08714DA4950CB37062E12403B55BACC6CC53E470090B7EBE9969E6A1A45414EB48732B1807289063E3E55011AD1FF57E22C7DCD9D0715D4B4362ECED533CE4DBF0AD652A9A71B7DB2D0865CFE1C02086B88197872AF3C485F1EE28AFD9C5AC47017EB827D56A4D059</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B4 63 05 00 2F AD BE 68
0010 | 40 01 00 00 BE E4 12 D7 ED 88 08 2C 9E 31 42 AF
0020 | 9F 7D 49 83 81 3F 3C 25 FB FB 10 A0 17 3F B0 34
0030 | E2 DD BB A7 9E 35 3B 93 04 54 A4 2B E3 00 00 00
0040 | 04 5A B6 6A 53 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A6 69 4A EF 25 B8 15 04 16 DE 64 A1
0060 | B2 D9 EE DD 3A E5 FB FE 6D 84 00 4C 6C ED B4 79
0070 | 75 94 AB 2C B5 5E 16 7F 67 83 24 47 44 5E 4D 74
0080 | 7A 2A D4 1F 7F F9 56 ED F8 D1 8A 25 CE 29 D8 92
0090 | B7 EC 8A 0A FD 6A 8E A5 EA 29 FB DE FC 17 C7 8F
00A0 | 26 5C 87 31 78 AB D3 6C A9 9C F5 46 26 B0 89 C1
00B0 | A3 76 3F F2 FE 27 2F EE 59 43 15 24 FA 5E 42 59
00C0 | 44 88 EE 05 8D 39 12 03 DC 87 46 82 47 4B E5 3B
00D0 | 27 68 47 18 6A 51 E0 9C 5E 0E AB BB FC 53 6D 4E
00E0 | 10 15 78 A3 80 56 60 8F BF B0 BE A0 87 14 DA 49
00F0 | 50 CB 37 06 2E 12 40 3B 55 BA CC 6C C5 3E 47 00
0100 | 90 B7 EB E9 96 9E 6A 1A 45 41 4E B4 87 32 B1 80
0110 | 72 89 06 3E 3E 55 01 1A D1 FF 57 E2 2C 7D CD 9D
0120 | 07 15 D4 B4 36 2E CE D5 33 CE 4D BF 0A D6 52 A9
0130 | A7 1B 7D B2 D0 86 5C FE 1C 02 08 6B 88 19 78 72
0140 | AF 3C 48 5F 1E E2 8A FD 9C 5A C4 70 17 EB 82 7D
0150 | 56 A4 D0 59</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B46305002FADBE68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0454A42BE3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1420045283</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045AB66A53000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1521904211</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A6694AEF25B8150416DE64A1</code> <code>B2D9EEDD3AE5FBFE6D84004C6CEDB479</code> <code>7594AB2CB55E167F67832447445E4D74</code> <code>7A2AD41F7FF956EDF8D18A25CE29D892</code> <code>B7EC8A0AFD6A8EA5EA29FBDEFC17C78F</code> <code>265C873178ABD36CA99CF54626B089C1</code> <code>A3763FF2FE272FEE59431524FA5E4259</code> <code>4488EE058D391203DC874682474BE53B</code> <code>276847186A51E09C5E0EABBBFC536D4E</code> <code>101578A38056608FBFB0BEA08714DA49</code> <code>50CB37062E12403B55BACC6CC53E4700</code> <code>90B7EBE9969E6A1A45414EB48732B180</code> <code>7289063E3E55011AD1FF57E22C7DCD9D</code> <code>0715D4B4362ECED533CE4DBF0AD652A9</code> <code>A71B7DB2D0865CFE1C02086B88197872</code> <code>AF3C485F1EE28AFD9C5AC47017EB827D</code><br> <code>56A4D059</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 20 81 1F 2F AD BE 68
0010 | 78 02 00 00 5C 07 E8 D0 ED 88 08 2C 9E 31 42 AF
0020 | 9F 7D 49 83 81 3F 3C 25 FB FB 10 A0 17 3F B0 34
0030 | E2 DD BB A7 9E 35 3B 93 FE 50 02 00 13 D3 7F FE
0040 | 81 4D 70 F9 BA 09 F7 8B B0 87 82 F0 A5 4C C5 C2
0050 | 05 61 DF 4A E3 B4 63 58 06 0B C2 A7 59 D9 B6 52
0060 | 4B D1 8B 5C 9C C0 4D DA E3 DA F8 76 C4 B6 94 52
0070 | AE 6A 4B D1 07 17 B2 E2 F3 C8 09 79 8B A5 89 43
0080 | 7A D5 72 03 8F F4 B7 1D D7 A5 2E 8E 9B F2 9C 03
0090 | 8B 23 93 01 6E B5 2C E6 5C 77 E6 C2 FD 16 10 D4
00A0 | EB D5 CD 62 AD E7 22 85 BC C8 A6 2B 3E 8E 38 12
00B0 | F1 E8 CB 1D 17 26 BB E2 E4 1A 16 FA E6 57 54 B1
00C0 | E7 49 9D 4E F7 EE 3D 98 F0 2B 7F 16 F3 A8 5E FB
00D0 | A1 83 F0 07 A4 7D E2 F0 F1 D7 DB F7 40 0F A4 79
00E0 | 40 93 0C 33 D3 1B 88 B0 5F 70 6F B5 D8 15 19 E5
00F0 | 06 5B 57 CD A0 59 FC E3 57 FB 05 F8 EF 5E C2 85
0100 | AB 36 C7 E2 38 4A 54 18 A9 42 BE 6D FE 5B EA BC
0110 | 2F ED 67 80 FD 70 4B AE 02 D6 4E 1C 34 03 2A F8
0120 | 75 53 E8 4C 5D C5 E1 85 14 E3 CC 83 FA E8 28 DE
0130 | 40 24 E7 81 39 08 2D 6F 44 DC 75 3B F4 B9 EC CE
0140 | E8 81 CA E1 B4 CE 11 DA 8A 99 3A CD DF E5 F4 1B
0150 | E1 0A 30 1D 28 C1 0D B0 16 41 75 9E F3 2C 66 01
0160 | 7F E0 A3 A5 CD C7 9B E9 51 1B 54 2E A4 09 41 02
0170 | 38 11 EC 2F 44 56 86 0C 04 85 81 EE A6 5A AD 4D
0180 | 0F 53 FD 50 D1 CF C2 6D 53 8C 51 30 35 82 60 9E
0190 | 5D 19 A0 23 72 3D 8C 6A 47 F7 C5 2E 6F 49 E3 87
01A0 | EA 69 66 13 F9 1C 0F 19 96 76 A5 CA 78 35 E1 79
01B0 | 47 27 B6 B2 D0 14 79 86 E7 AD A7 5E 16 DF B5 1F
01C0 | 6B AA 9A D4 34 76 05 3C F0 8A 3D E4 F7 1D 8F DC
01D0 | E9 83 61 3D 4F 8C A4 FF 2A 34 C1 CD 4E 86 3F 5C
01E0 | 19 13 A7 AE 4F 3A 9F 94 DC 2C 28 BE E9 12 1A 76
01F0 | A9 DB 4E 80 73 0A BB B0 39 26 58 1B D6 F0 5B 4B
0200 | 3F 39 FE 1A 07 90 3A 39 D9 5F 58 42 20 35 DB C2
0210 | 5C 59 24 87 31 3D FD BA F3 A6 CB 83 FB 1A C2 29
0220 | 66 C8 36 5C F8 DE 14 1E FB 25 DB B6 8A 85 0C 7E
0230 | 83 6E 25 56 34 70 B4 B2 50 D0 10 1E EB BE 18 DB
0240 | BB C1 65 14 48 B4 19 27 08 22 C1 59 BD E4 16 4E
0250 | 72 4C ED 60 11 8D D7 9F 7E BF 73 DE E7 E9 7B D5
0260 | 9C EC 23 B6 23 34 85 CE 46 25 6C 9D 8F A4 13 84
0270 | FB F3 BC EA 8D ED 08 80 78 A9 DB BC 58 D2 19 2E
0280 | 18 EC 34 52 56 99 E7 2F EE 43 14 38</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0120811F2FADBE68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020013D37FFE814D70F9BA09F78B</code> <code>B08782F0A54CC5C20561DF4AE3B46358</code> <code>060BC2A759D9B6524BD18B5C9CC04DDA</code> <code>E3DAF876C4B69452AE6A4BD10717B2E2</code> <code>F3C809798BA589437AD572038FF4B71D</code> <code>D7A52E8E9BF29C038B2393016EB52CE6</code> <code>5C77E6C2FD1610D4EBD5CD62ADE72285</code> <code>BCC8A62B3E8E3812F1E8CB1D1726BBE2</code> <code>E41A16FAE65754B1E7499D4EF7EE3D98</code> <code>F02B7F16F3A85EFBA183F007A47DE2F0</code> <code>F1D7DBF7400FA47940930C33D31B88B0</code> <code>5F706FB5D81519E5065B57CDA059FCE3</code> <code>57FB05F8EF5EC285AB36C7E2384A5418</code> <code>A942BE6DFE5BEABC2FED6780FD704BAE</code> <code>02D64E1C34032AF87553E84C5DC5E185</code> <code>14E3CC83FAE828DE4024E78139082D6F</code> <code>44DC753BF4B9ECCEE881CAE1B4CE11DA</code> <code>8A993ACDDFE5F41BE10A301D28C10DB0</code> <code>1641759EF32C66017FE0A3A5CDC79BE9</code> <code>511B542EA40941023811EC2F4456860C</code> <code>048581EEA65AAD4D0F53FD50D1CFC26D</code> <code>538C51303582609E5D19A023723D8C6A</code> <code>47F7C52E6F49E387EA696613F91C0F19</code> <code>9676A5CA7835E1794727B6B2D0147986</code> <code>E7ADA75E16DFB51F6BAA9AD43476053C</code> <code>F08A3DE4F71D8FDCE983613D4F8CA4FF</code> <code>2A34C1CD4E863F5C1913A7AE4F3A9F94</code> <code>DC2C28BEE9121A76A9DB4E80730ABBB0</code> <code>3926581BD6F05B4B3F39FE1A07903A39</code> <code>D95F58422035DBC25C592487313DFDBA</code> <code>F3A6CB83FB1AC22966C8365CF8DE141E</code> <code>FB25DBB68A850C7E836E25563470B4B2</code> <code>50D0101EEBBE18DBBBC1651448B41927</code> <code>0822C159BDE4164E724CED60118DD79F</code> <code>7EBF73DEE7E97BD59CEC23B6233485CE</code> <code>46256C9D8FA41384FBF3BCEA8DED0880</code> <code>78A9DBBC58D2192E18EC34525699E72F</code><br> <code>EE431438</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 13D37FFE814D70F9BA09F78BB08782F0A54CC5C20561DF4AE3B46358060BC2A759D9B6524BD18B5C9CC04DDAE3DAF876C4B69452AE6A4BD10717B2E2F3C809798BA589437AD572038FF4B71DD7A52E8E9BF29C038B2393016EB52CE65C77E6C2FD1610D4EBD5CD62ADE72285BCC8A62B3E8E3812F1E8CB1D1726BBE2E41A16FAE65754B1E7499D4EF7EE3D98F02B7F16F3A85EFBA183F007A47DE2F0F1D7DBF7400FA47940930C33D31B88B05F706FB5D81519E5065B57CDA059FCE357FB05F8EF5EC285AB36C7E2384A5418A942BE6DFE5BEABC2FED6780FD704BAE02D64E1C34032AF87553E84C5DC5E18514E3CC83FAE828DE4024E78139082D6F44DC753BF4B9ECCEE881CAE1B4CE11DA8A993ACDDFE5F41BE10A301D28C10DB01641759EF32C66017FE0A3A5CDC79BE9511B542EA40941023811EC2F4456860C048581EEA65AAD4D0F53FD50D1CFC26D538C51303582609E5D19A023723D8C6A47F7C52E6F49E387EA696613F91C0F199676A5CA7835E1794727B6B2D0147986E7ADA75E16DFB51F6BAA9AD43476053CF08A3DE4F71D8FDCE983613D4F8CA4FF2A34C1CD4E863F5C1913A7AE4F3A9F94DC2C28BEE9121A76A9DB4E80730ABBB03926581BD6F05B4B3F39FE1A07903A39D95F58422035DBC25C592487313DFDBAF3A6CB83FB1AC22966C8365CF8DE141EFB25DBB68A850C7E836E25563470B4B250D0101EEBBE18DBBBC1651448B419270822C159BDE4164E724CED60118DD79F7EBF73DEE7E97BD59CEC23B6233485CE46256C9D8FA41384FBF3BCEA8DED088078A9DBBC58D2192E18EC34525699E72FEE431438
tmp_aes_key = 07A747C94767963B969362ECC08BC2C4770668DF12A4CD70CE6EE2407A64AC0F
tmp_aes_iv = BE075DD016597C6B7B93DC9403A9ACB26F18218E840C490E17C3CC90C879454E</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 2096924F823F7592BCBAD3ED2C79AE3D1DB315EABA0D89B5ED88082C9E3142AF9F7D4983813F3C25FBFB10A0173FB034E2DDBBA79E353B9303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100975EEA5301664DF87B6187A6C4767D32C5FC869B203D00084007A10793CB814D92B77ABA40770C9200D7D17A7D4A5471C3D36D0F6C15338697958B9DE37B9118F4836490D5FC00BEA1764A2A312D35E84A267E3D8B03416982B2701B522A66005712DE21657AE744C88298B6C888BDFAEE9B61177E30288216BF445A1F292C9FF057E32F5A15177AFFAC27EB4BCCDA7B28D8C91BC4423982B71B59FE6704230F0727D01C8C39B44FF8A7235559C5FD6BD1BDECFBF7B3A0417C0E92249C360BD0BAD383FCBC2700D3B4F7C61A633735CD907ECC78C01E13DBB0AC22755D43B44D1D1E135B03DD7350A3774200EAD3C06EB21236AF4FCA14222F2C6EAEA88001762FADBE6848418080E5CF8066
answer = BA0D89B5ED88082C9E3142AF9F7D4983813F3C25FBFB10A0173FB034E2DDBBA79E353B9303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100975EEA5301664DF87B6187A6C4767D32C5FC869B203D00084007A10793CB814D92B77ABA40770C9200D7D17A7D4A5471C3D36D0F6C15338697958B9DE37B9118F4836490D5FC00BEA1764A2A312D35E84A267E3D8B03416982B2701B522A66005712DE21657AE744C88298B6C888BDFAEE9B61177E30288216BF445A1F292C9FF057E32F5A15177AFFAC27EB4BCCDA7B28D8C91BC4423982B71B59FE6704230F0727D01C8C39B44FF8A7235559C5FD6BD1BDECFBF7B3A0417C0E92249C360BD0BAD383FCBC2700D3B4F7C61A633735CD907ECC78C01E13DBB0AC22755D43B44D1D1E135B03DD7350A3774200EAD3C06EB21236AF4FCA14222F2C6EAEA88001762FADBE6848418080E5CF8066</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 ED 88 08 2C 9E 31 42 AF 9F 7D 49 83
0010 | 81 3F 3C 25 FB FB 10 A0 17 3F B0 34 E2 DD BB A7
0020 | 9E 35 3B 93 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 97 5E EA 53 01 66 4D F8 7B 61 87 A6 C4 76 7D 32
0140 | C5 FC 86 9B 20 3D 00 08 40 07 A1 07 93 CB 81 4D
0150 | 92 B7 7A BA 40 77 0C 92 00 D7 D1 7A 7D 4A 54 71
0160 | C3 D3 6D 0F 6C 15 33 86 97 95 8B 9D E3 7B 91 18
0170 | F4 83 64 90 D5 FC 00 BE A1 76 4A 2A 31 2D 35 E8
0180 | 4A 26 7E 3D 8B 03 41 69 82 B2 70 1B 52 2A 66 00
0190 | 57 12 DE 21 65 7A E7 44 C8 82 98 B6 C8 88 BD FA
01A0 | EE 9B 61 17 7E 30 28 82 16 BF 44 5A 1F 29 2C 9F
01B0 | F0 57 E3 2F 5A 15 17 7A FF AC 27 EB 4B CC DA 7B
01C0 | 28 D8 C9 1B C4 42 39 82 B7 1B 59 FE 67 04 23 0F
01D0 | 07 27 D0 1C 8C 39 B4 4F F8 A7 23 55 59 C5 FD 6B
01E0 | D1 BD EC FB F7 B3 A0 41 7C 0E 92 24 9C 36 0B D0
01F0 | BA D3 83 FC BC 27 00 D3 B4 F7 C6 1A 63 37 35 CD
0200 | 90 7E CC 78 C0 1E 13 DB B0 AC 22 75 5D 43 B4 4D
0210 | 1D 1E 13 5B 03 DD 73 50 A3 77 42 00 EA D3 C0 6E
0220 | B2 12 36 AF 4F CA 14 22 2F 2C 6E AE A8 80 01 76
0230 | 2F AD BE 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100975EEA5301664DF87B6187A6</code> <code>C4767D32C5FC869B203D00084007A107</code> <code>93CB814D92B77ABA40770C9200D7D17A</code> <code>7D4A5471C3D36D0F6C15338697958B9D</code> <code>E37B9118F4836490D5FC00BEA1764A2A</code> <code>312D35E84A267E3D8B03416982B2701B</code> <code>522A66005712DE21657AE744C88298B6</code> <code>C888BDFAEE9B61177E30288216BF445A</code> <code>1F292C9FF057E32F5A15177AFFAC27EB</code> <code>4BCCDA7B28D8C91BC4423982B71B59FE</code> <code>6704230F0727D01C8C39B44FF8A72355</code> <code>59C5FD6BD1BDECFBF7B3A0417C0E9224</code> <code>9C360BD0BAD383FCBC2700D3B4F7C61A</code> <code>633735CD907ECC78C01E13DBB0AC2275</code> <code>5D43B44D1D1E135B03DD7350A3774200</code> <code>EAD3C06EB21236AF4FCA14222F2C6EAE</code><br> <code>A8800176</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>2FADBE68</code> (1757326639 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = EE97FE6FC3575166EECCC0DAD0216451690B59725B6B2D8F562A69B677FBAA79B87610599B2330102CA349CA5E8150C696F1FB3FCDD742CD077F16EFF5CCC4833205AA7D3330DD423E643A67E0346109A8F3AE052C7B960B1B5516643CAAB07A6854B66278F7200FFB7112D8AE6940F9CAE71F4090B4F3E27582BEFD6C4CC0FB4936CDF9CD2E3A2156938E9D1479533B898CFBE94326784D834006F53A6982B68169D2F5EB180C55A171AF90D8BB4ABB8B31BAA65E89ED7493B5269803179E16D70153E011849674A2A5C0E564A368B8265D35CEE5FEE457FCF0F05AC634DB5A26E0115C2E1574F45E8C7268F6FB42120D1EB1E8CAF18C6121B08562973FA8BB</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 12EDF3EAACCCB58D530F85394D3D40B52571E34FEB41552778A45ACBBC500416F5170237731CA0DFBC9E6C38D91141CDD350109A17AB649B6202612E494F69F4147F6584EDCF5B634A661539530DE9A3E7F9DD267D1EC2A5872F8D59F973489B59594268457F62B0B5933C6AA86B881663C6497CC3DDF6615E50FBB10ADE8E283077C7C2FF39FDD6A534A6F2C551D0F89A7A32EC90BB1B628C129A9F2C7D82DD93DCFE734A9B53E85DD3AA71A9DD9CDD1F3197570EBEFA4B0DF71B581377681667BDCE59497491C689E8A7A308BEADAC5B7D1A4FE3F7BB20D0EDBFC152E2AC102EB567448B5E1BE8D03F2D4566A22235C15CEB8B94B444D7ADC6D7E0B02851BD</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 ED 88 08 2C 9E 31 42 AF 9F 7D 49 83
0010 | 81 3F 3C 25 FB FB 10 A0 17 3F B0 34 E2 DD BB A7
0020 | 9E 35 3B 93 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 12 ED F3 EA AC CC B5 8D 53 0F 85 39 4D 3D 40 B5
0040 | 25 71 E3 4F EB 41 55 27 78 A4 5A CB BC 50 04 16
0050 | F5 17 02 37 73 1C A0 DF BC 9E 6C 38 D9 11 41 CD
0060 | D3 50 10 9A 17 AB 64 9B 62 02 61 2E 49 4F 69 F4
0070 | 14 7F 65 84 ED CF 5B 63 4A 66 15 39 53 0D E9 A3
0080 | E7 F9 DD 26 7D 1E C2 A5 87 2F 8D 59 F9 73 48 9B
0090 | 59 59 42 68 45 7F 62 B0 B5 93 3C 6A A8 6B 88 16
00A0 | 63 C6 49 7C C3 DD F6 61 5E 50 FB B1 0A DE 8E 28
00B0 | 30 77 C7 C2 FF 39 FD D6 A5 34 A6 F2 C5 51 D0 F8
00C0 | 9A 7A 32 EC 90 BB 1B 62 8C 12 9A 9F 2C 7D 82 DD
00D0 | 93 DC FE 73 4A 9B 53 E8 5D D3 AA 71 A9 DD 9C DD
00E0 | 1F 31 97 57 0E BE FA 4B 0D F7 1B 58 13 77 68 16
00F0 | 67 BD CE 59 49 74 91 C6 89 E8 A7 A3 08 BE AD AC
0100 | 5B 7D 1A 4F E3 F7 BB 20 D0 ED BF C1 52 E2 AC 10
0110 | 2E B5 67 44 8B 5E 1B E8 D0 3F 2D 45 66 A2 22 35
0120 | C1 5C EB 8B 94 B4 44 D7 AD C6 D7 E0 B0 28 51 BD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010012EDF3EAACCCB58D530F8539</code> <code>4D3D40B52571E34FEB41552778A45ACB</code> <code>BC500416F5170237731CA0DFBC9E6C38</code> <code>D91141CDD350109A17AB649B6202612E</code> <code>494F69F4147F6584EDCF5B634A661539</code> <code>530DE9A3E7F9DD267D1EC2A5872F8D59</code> <code>F973489B59594268457F62B0B5933C6A</code> <code>A86B881663C6497CC3DDF6615E50FBB1</code> <code>0ADE8E283077C7C2FF39FDD6A534A6F2</code> <code>C551D0F89A7A32EC90BB1B628C129A9F</code> <code>2C7D82DD93DCFE734A9B53E85DD3AA71</code> <code>A9DD9CDD1F3197570EBEFA4B0DF71B58</code> <code>1377681667BDCE59497491C689E8A7A3</code> <code>08BEADAC5B7D1A4FE3F7BB20D0EDBFC1</code> <code>52E2AC102EB567448B5E1BE8D03F2D45</code> <code>66A22235C15CEB8B94B444D7ADC6D7E0</code><br> <code>B02851BD</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366ED88082C9E3142AF9F7D4983813F3C25FBFB10A0173FB034E2DDBBA79E353B930000000000000000FE00010012EDF3EAACCCB58D530F85394D3D40B52571E34FEB41552778A45ACBBC500416F5170237731CA0DFBC9E6C38D91141CDD350109A17AB649B6202612E494F69F4147F6584EDCF5B634A661539530DE9A3E7F9DD267D1EC2A5872F8D59F973489B59594268457F62B0B5933C6AA86B881663C6497CC3DDF6615E50FBB10ADE8E283077C7C2FF39FDD6A534A6F2C551D0F89A7A32EC90BB1B628C129A9F2C7D82DD93DCFE734A9B53E85DD3AA71A9DD9CDD1F3197570EBEFA4B0DF71B581377681667BDCE59497491C689E8A7A308BEADAC5B7D1A4FE3F7BB20D0EDBFC152E2AC102EB567448B5E1BE8D03F2D4566A22235C15CEB8B94B444D7ADC6D7E0B02851BD
padding = 8EDC9D5B4A2E6F4A2E464A86
tmp_aes_key = 07A747C94767963B969362ECC08BC2C4770668DF12A4CD70CE6EE2407A64AC0F
tmp_aes_iv = BE075DD016597C6B7B93DC9403A9ACB26F18218E840C490E17C3CC90C879454E</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 6F37F336EDD5F52AC4A2EEA491790D0CC5193EEC51432674AE210E0E53347F9C5CC9C9B6854D1F28BFE3E9640B94FDC2AAA2AF8BBFF2567EE92D8FE41174EEB1BAEC8740621989F6CA28F534588E67C97C5AD3E32A859D55F5A286F93702D340A87C31210B5E98077DD2AF4612A00E7588B0FFE93AC9160C7EEA0244C4467B7F76DF1C172F6A07B5771039526CD8D075F51FA6017303BDEF9453A089C728417FF70A545E7C133CA637014F283E9E468DDE04C77F2B4F54048D9BDD05EE2D3AA6CC0F061C759C2C735ECCF365B36AFB248D4F0B1CA6DA67C9E2255CEF9B50AF87C8C48AF4001AC57EC4B76D187D0801D80C198F3EA61EDF198D890BC12B77ABC5B56FE27A8818ACDE4AF4698CB23AE6FF8F6ECADC082E8F20DB0210D963435B4FAC6F512FFB4BB7CB2AA0F92EA06CC69BC4E3AE4DE9D451782725B6F9396F76E1EEEB1E25C6A17B3FACBBFB9021A796BC</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 4A 0C 00 30 AD BE 68
0010 | 78 01 00 00 1F 5F 04 F5 ED 88 08 2C 9E 31 42 AF
0020 | 9F 7D 49 83 81 3F 3C 25 FB FB 10 A0 17 3F B0 34
0030 | E2 DD BB A7 9E 35 3B 93 FE 50 01 00 6F 37 F3 36
0040 | ED D5 F5 2A C4 A2 EE A4 91 79 0D 0C C5 19 3E EC
0050 | 51 43 26 74 AE 21 0E 0E 53 34 7F 9C 5C C9 C9 B6
0060 | 85 4D 1F 28 BF E3 E9 64 0B 94 FD C2 AA A2 AF 8B
0070 | BF F2 56 7E E9 2D 8F E4 11 74 EE B1 BA EC 87 40
0080 | 62 19 89 F6 CA 28 F5 34 58 8E 67 C9 7C 5A D3 E3
0090 | 2A 85 9D 55 F5 A2 86 F9 37 02 D3 40 A8 7C 31 21
00A0 | 0B 5E 98 07 7D D2 AF 46 12 A0 0E 75 88 B0 FF E9
00B0 | 3A C9 16 0C 7E EA 02 44 C4 46 7B 7F 76 DF 1C 17
00C0 | 2F 6A 07 B5 77 10 39 52 6C D8 D0 75 F5 1F A6 01
00D0 | 73 03 BD EF 94 53 A0 89 C7 28 41 7F F7 0A 54 5E
00E0 | 7C 13 3C A6 37 01 4F 28 3E 9E 46 8D DE 04 C7 7F
00F0 | 2B 4F 54 04 8D 9B DD 05 EE 2D 3A A6 CC 0F 06 1C
0100 | 75 9C 2C 73 5E CC F3 65 B3 6A FB 24 8D 4F 0B 1C
0110 | A6 DA 67 C9 E2 25 5C EF 9B 50 AF 87 C8 C4 8A F4
0120 | 00 1A C5 7E C4 B7 6D 18 7D 08 01 D8 0C 19 8F 3E
0130 | A6 1E DF 19 8D 89 0B C1 2B 77 AB C5 B5 6F E2 7A
0140 | 88 18 AC DE 4A F4 69 8C B2 3A E6 FF 8F 6E CA DC
0150 | 08 2E 8F 20 DB 02 10 D9 63 43 5B 4F AC 6F 51 2F
0160 | FB 4B B7 CB 2A A0 F9 2E A0 6C C6 9B C4 E3 AE 4D
0170 | E9 D4 51 78 27 25 B6 F9 39 6F 76 E1 EE EB 1E 25
0180 | C6 A1 7B 3F AC BB FB 90 21 A7 96 BC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>084A0C0030ADBE68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001006F37F336EDD5F52AC4A2EEA4</code> <code>91790D0CC5193EEC51432674AE210E0E</code> <code>53347F9C5CC9C9B6854D1F28BFE3E964</code> <code>0B94FDC2AAA2AF8BBFF2567EE92D8FE4</code> <code>1174EEB1BAEC8740621989F6CA28F534</code> <code>588E67C97C5AD3E32A859D55F5A286F9</code> <code>3702D340A87C31210B5E98077DD2AF46</code> <code>12A00E7588B0FFE93AC9160C7EEA0244</code> <code>C4467B7F76DF1C172F6A07B577103952</code> <code>6CD8D075F51FA6017303BDEF9453A089</code> <code>C728417FF70A545E7C133CA637014F28</code> <code>3E9E468DDE04C77F2B4F54048D9BDD05</code> <code>EE2D3AA6CC0F061C759C2C735ECCF365</code> <code>B36AFB248D4F0B1CA6DA67C9E2255CEF</code> <code>9B50AF87C8C48AF4001AC57EC4B76D18</code> <code>7D0801D80C198F3EA61EDF198D890BC1</code> <code>2B77ABC5B56FE27A8818ACDE4AF4698C</code> <code>B23AE6FF8F6ECADC082E8F20DB0210D9</code> <code>63435B4FAC6F512FFB4BB7CB2AA0F92E</code> <code>A06CC69BC4E3AE4DE9D451782725B6F9</code> <code>396F76E1EEEB1E25C6A17B3FACBBFB90</code><br> <code>21A796BC</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 958B9FE4515582197F4498C359D3A8A041FE98123CDC33C3D064BFD33CD1F934DCAE47A133468772E5B6D5332F919BFC2704BC7F6C75F73AA43B02B59EACA037F744FAA0D993AB0D2DA1CB2AEF8F537128E02146427EDF37B82E7ED2CFB33D781E8604B51384A6E4AF0FD871E05B6454B675CCD1B79FCB4813368587D0DFA2C7C88BD773D87F0C270A43A947722AB8D5FD230D713A6DDBAE4596A27FB725E0C9FF13D362AF54BD177393ADC74D972DC988860826D4D5DEB5C84C77900C10FAFD7A345970BC5B2F18DF290EFA37DA6D71CA25F2347DACC8C42730E1319549757382B984C5D5B98EA008D365CCCF76B34C190A59B844B70D5DD54BE6AD63F6FA1A</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B0 8C 2D 31 AD BE 68
0010 | 34 00 00 00 34 F7 CB 3B ED 88 08 2C 9E 31 42 AF
0020 | 9F 7D 49 83 81 3F 3C 25 FB FB 10 A0 17 3F B0 34
0030 | E2 DD BB A7 9E 35 3B 93 40 4C 85 8C 15 2D B5 54
0040 | AD 9C C0 81 1E CE 4E CB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B08C2D31ADBE68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ED88082C9E3142AF9F7D4983813F3C25</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>FBFB10A0173FB034E2DDBBA79E353B93</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>404C858C152DB554AD9CC0811ECE4ECB</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

