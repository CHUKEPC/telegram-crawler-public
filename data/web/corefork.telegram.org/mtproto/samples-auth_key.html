<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C4 6A 0E 00 34 73 38 67
0010 | 14 00 00 00 F1 8E 7E BE DA 8F 30 4B DA 3E 14 CF
0020 | 4C C1 C3 A4 5A 90 15 6F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C46A0E0034733867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 E5 2E 34 73 38 67
0010 | 50 00 00 00 63 24 16 05 DA 8F 30 4B DA 3E 14 CF
0020 | 4C C1 C3 A4 5A 90 15 6F 18 06 1D 83 76 1E 28 ED
0030 | AC CD 4E 30 98 C2 6D 38 08 20 FF A8 83 F7 7C 42
0040 | 6D 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130E52E34733867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0820FFA883F77C426D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2377804413021209197</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2377804413021209197</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2377804413021209197 = 1445298703 * 1645199299</code></p>
<pre><code>p = 1445298703
q = 1645199299</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 FF A8 83 F7 7C 42 6D 00 00 00
0010 | 04 56 25 82 0F 00 00 00 04 62 0F BF C3 00 00 00
0020 | DA 8F 30 4B DA 3E 14 CF 4C C1 C3 A4 5A 90 15 6F
0030 | 18 06 1D 83 76 1E 28 ED AC CD 4E 30 98 C2 6D 38
0040 | 15 4B B5 D0 14 B0 F2 74 5F 04 74 1B B5 7D 9F 8B
0050 | D7 B1 F9 76 C8 47 DE 78 BB 2A 2D 8B 84 30 FF 4C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0820FFA883F77C426D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2377804413021209197</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045625820F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1445298703</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04620FBFC3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1645199299</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>154BB5D014B0F2745F04741BB57D9F8B</code> <code>D7B1F976C847DE78BB2A2D8B8430FF4C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90820FFA883F77C426D000000045625820F00000004620FBFC3000000DA8F304BDA3E14CF4CC1C3A45A90156F18061D83761E28EDACCD4E3098C26D38154BB5D014B0F2745F04741BB57D9F8BD7B1F976C847DE78BB2A2D8B8430FF4C02000000
random_padding_bytes = 23485C6EE6125CB871296A117C5581AAB1D4427DCF9549BE5E1405D3A72D79F66F029CF1C17532F29741C7FB5836471919A8B0F29539DC40CD4D5C8DE31CC1B2DEDEFEFF07BCCB459DDCF9898914107E72B5597048B61BBED0A18819</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D194799E424FF5B0B22D56A6832B1FBB1766C9DEE939C714EEBD67F80EBB2C3F2DC4FCF45B9385DE07CBA6D83003C1305C7AFFBF22F0F86D94F47E9EE988048B0483409E15B7FB70860D4EDA946CCE5C325E67162BA79902A8F65AD3F497F2B94E5E7358D3ADB901EED594E59976A8CCE988C623A6734FAB2A04CA698C1A940483252F07593798546E0AA9E5D9EC4A9704729E0CDE060276398E7EA42B430ED9D6ACD6E3E2920E641978F88E4401F504D6461D2D98B1913B572657DDCA9BC9CE99273301E9D1FE403254D9669F8D361492CE1BF0B8E36E51467222F2A4D1788CDBDE1BAEBC1442A561A6046C8D7E223786DFA3A6EC05104B18650B4BD72E43AB</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 6A 0E 00 34 73 38 67
0010 | 40 01 00 00 BE E4 12 D7 DA 8F 30 4B DA 3E 14 CF
0020 | 4C C1 C3 A4 5A 90 15 6F 18 06 1D 83 76 1E 28 ED
0030 | AC CD 4E 30 98 C2 6D 38 04 56 25 82 0F 00 00 00
0040 | 04 62 0F BF C3 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D1 94 79 9E 42 4F F5 B0 B2 2D 56 A6
0060 | 83 2B 1F BB 17 66 C9 DE E9 39 C7 14 EE BD 67 F8
0070 | 0E BB 2C 3F 2D C4 FC F4 5B 93 85 DE 07 CB A6 D8
0080 | 30 03 C1 30 5C 7A FF BF 22 F0 F8 6D 94 F4 7E 9E
0090 | E9 88 04 8B 04 83 40 9E 15 B7 FB 70 86 0D 4E DA
00A0 | 94 6C CE 5C 32 5E 67 16 2B A7 99 02 A8 F6 5A D3
00B0 | F4 97 F2 B9 4E 5E 73 58 D3 AD B9 01 EE D5 94 E5
00C0 | 99 76 A8 CC E9 88 C6 23 A6 73 4F AB 2A 04 CA 69
00D0 | 8C 1A 94 04 83 25 2F 07 59 37 98 54 6E 0A A9 E5
00E0 | D9 EC 4A 97 04 72 9E 0C DE 06 02 76 39 8E 7E A4
00F0 | 2B 43 0E D9 D6 AC D6 E3 E2 92 0E 64 19 78 F8 8E
0100 | 44 01 F5 04 D6 46 1D 2D 98 B1 91 3B 57 26 57 DD
0110 | CA 9B C9 CE 99 27 33 01 E9 D1 FE 40 32 54 D9 66
0120 | 9F 8D 36 14 92 CE 1B F0 B8 E3 6E 51 46 72 22 F2
0130 | A4 D1 78 8C DB DE 1B AE BC 14 42 A5 61 A6 04 6C
0140 | 8D 7E 22 37 86 DF A3 A6 EC 05 10 4B 18 65 0B 4B
0150 | D7 2E 43 AB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C86A0E0034733867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045625820F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1445298703</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04620FBFC3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1645199299</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D194799E424FF5B0B22D56A6</code> <code>832B1FBB1766C9DEE939C714EEBD67F8</code> <code>0EBB2C3F2DC4FCF45B9385DE07CBA6D8</code> <code>3003C1305C7AFFBF22F0F86D94F47E9E</code> <code>E988048B0483409E15B7FB70860D4EDA</code> <code>946CCE5C325E67162BA79902A8F65AD3</code> <code>F497F2B94E5E7358D3ADB901EED594E5</code> <code>9976A8CCE988C623A6734FAB2A04CA69</code> <code>8C1A940483252F07593798546E0AA9E5</code> <code>D9EC4A9704729E0CDE060276398E7EA4</code> <code>2B430ED9D6ACD6E3E2920E641978F88E</code> <code>4401F504D6461D2D98B1913B572657DD</code> <code>CA9BC9CE99273301E9D1FE403254D966</code> <code>9F8D361492CE1BF0B8E36E51467222F2</code> <code>A4D1788CDBDE1BAEBC1442A561A6046C</code> <code>8D7E223786DFA3A6EC05104B18650B4B</code><br> <code>D72E43AB</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 3C D2 50 34 73 38 67
0010 | 78 02 00 00 5C 07 E8 D0 DA 8F 30 4B DA 3E 14 CF
0020 | 4C C1 C3 A4 5A 90 15 6F 18 06 1D 83 76 1E 28 ED
0030 | AC CD 4E 30 98 C2 6D 38 FE 50 02 00 17 4A 12 EC
0040 | 3C 20 57 85 01 34 1F 4E CF CA 98 5F 17 E7 41 90
0050 | E5 03 75 2D 68 34 CB E2 F1 28 45 2C E4 1C AB 83
0060 | 9B 6A 27 0E C8 57 1A 19 D9 5D 23 57 9E 16 59 6B
0070 | 20 D7 35 47 1B EF 72 8E 94 67 6F 75 7F E3 6A FE
0080 | D4 25 99 30 93 58 0B 36 74 28 22 EF DA 76 56 C9
0090 | 5A 94 B3 A8 7A 42 44 40 04 81 49 4E 8F A3 6B 5D
00A0 | 52 B6 B5 C8 D6 D3 27 0F 3F 7D 2C AB 08 47 5C FC
00B0 | BF F8 8B 93 49 FC 7D A7 99 EE 5A 8C 53 73 F2 17
00C0 | 8C 26 27 29 D9 3D 69 1A 8E 18 45 91 38 61 01 15
00D0 | 4B 29 8E CC 02 3A C7 DC CC CF 47 0A 6A C6 BF 09
00E0 | 95 02 FE D0 A2 0B D5 71 EE C6 39 B2 77 B6 FA 1F
00F0 | 0B 18 B7 12 A7 C4 9A AE 2B C5 EA 67 DD 4E 11 C3
0100 | 94 A8 6B F3 7E 67 18 E7 C2 32 F4 18 0C A2 30 25
0110 | 34 75 8A 4E 14 B4 35 68 5F 2A 36 75 0D 1C 9A D5
0120 | DD AA 0D A8 47 27 77 86 97 14 68 5D 74 D5 2D 13
0130 | 9D F9 18 67 C4 95 4B 3B 11 F1 DA E6 40 DA 2F B8
0140 | 6E C2 41 90 9C CF BF 16 48 C2 71 56 D9 2B 69 CF
0150 | 19 06 E1 E1 AB 0C 36 A4 DB 73 86 FF 9A A3 40 F6
0160 | B5 D3 54 41 2A 98 5A 54 F9 17 41 D5 EF 91 3D 24
0170 | 58 97 16 76 C8 19 E2 DB 39 18 94 8E 70 44 5E BE
0180 | 19 B4 A5 FD 75 67 CE 04 29 2A 4B F4 65 1D B8 80
0190 | D9 E2 BC 10 C4 97 14 81 2F AA CE 73 E7 28 3C C3
01A0 | DE 9D A6 75 33 C0 78 33 50 95 04 FD 1E 1A 34 9B
01B0 | 22 61 2B 7D 93 8A 78 E2 00 D5 25 F3 BD B6 0E 30
01C0 | A4 15 0C E9 2D 8D 58 89 FB D2 F2 2C CC 90 46 C6
01D0 | 2A 4C A2 7C FE 74 1B 55 9F 68 74 B6 C2 CC 5C 3F
01E0 | F2 74 A8 67 4A 23 E0 F2 B8 A6 70 D8 0F 9C 22 E4
01F0 | 0C 16 DD 99 E3 75 4B 23 C6 D3 5D D4 62 09 98 51
0200 | C4 2B A0 67 C7 5F E1 68 13 BC 9D 93 3A E8 79 E2
0210 | AD E2 32 CC 58 1F 38 50 92 53 59 CE 66 33 A4 62
0220 | B7 25 85 60 E3 B1 35 CA 8E 5A C5 ED 56 F4 F1 96
0230 | E7 BB 02 80 E2 47 CB D7 95 57 E4 43 30 D0 F4 5D
0240 | F2 82 C0 67 A8 2D B9 41 94 26 BC 54 9B F5 B4 68
0250 | F7 0E E9 C8 1E 18 3C 00 4F 7D 1B F1 F3 E2 BB D8
0260 | 85 4F 78 B8 01 92 9C 7E D8 69 BB 8A 42 01 04 CB
0270 | C4 E9 64 69 7E 9A DA 4B 55 BC 9E 8F F9 C2 C0 D7
0280 | 5F 1A 2F 4E FD 54 16 93 3D 6D B7 46</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013CD25034733867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200174A12EC3C20578501341F4E</code> <code>CFCA985F17E74190E503752D6834CBE2</code> <code>F128452CE41CAB839B6A270EC8571A19</code> <code>D95D23579E16596B20D735471BEF728E</code> <code>94676F757FE36AFED425993093580B36</code> <code>742822EFDA7656C95A94B3A87A424440</code> <code>0481494E8FA36B5D52B6B5C8D6D3270F</code> <code>3F7D2CAB08475CFCBFF88B9349FC7DA7</code> <code>99EE5A8C5373F2178C262729D93D691A</code> <code>8E184591386101154B298ECC023AC7DC</code> <code>CCCF470A6AC6BF099502FED0A20BD571</code> <code>EEC639B277B6FA1F0B18B712A7C49AAE</code> <code>2BC5EA67DD4E11C394A86BF37E6718E7</code> <code>C232F4180CA2302534758A4E14B43568</code> <code>5F2A36750D1C9AD5DDAA0DA847277786</code> <code>9714685D74D52D139DF91867C4954B3B</code> <code>11F1DAE640DA2FB86EC241909CCFBF16</code> <code>48C27156D92B69CF1906E1E1AB0C36A4</code> <code>DB7386FF9AA340F6B5D354412A985A54</code> <code>F91741D5EF913D2458971676C819E2DB</code> <code>3918948E70445EBE19B4A5FD7567CE04</code> <code>292A4BF4651DB880D9E2BC10C4971481</code> <code>2FAACE73E7283CC3DE9DA67533C07833</code> <code>509504FD1E1A349B22612B7D938A78E2</code> <code>00D525F3BDB60E30A4150CE92D8D5889</code> <code>FBD2F22CCC9046C62A4CA27CFE741B55</code> <code>9F6874B6C2CC5C3FF274A8674A23E0F2</code> <code>B8A670D80F9C22E40C16DD99E3754B23</code> <code>C6D35DD462099851C42BA067C75FE168</code> <code>13BC9D933AE879E2ADE232CC581F3850</code> <code>925359CE6633A462B7258560E3B135CA</code> <code>8E5AC5ED56F4F196E7BB0280E247CBD7</code> <code>9557E44330D0F45DF282C067A82DB941</code> <code>9426BC549BF5B468F70EE9C81E183C00</code> <code>4F7D1BF1F3E2BBD8854F78B801929C7E</code> <code>D869BB8A420104CBC4E964697E9ADA4B</code> <code>55BC9E8FF9C2C0D75F1A2F4EFD541693</code><br> <code>3D6DB746</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 174A12EC3C20578501341F4ECFCA985F17E74190E503752D6834CBE2F128452CE41CAB839B6A270EC8571A19D95D23579E16596B20D735471BEF728E94676F757FE36AFED425993093580B36742822EFDA7656C95A94B3A87A4244400481494E8FA36B5D52B6B5C8D6D3270F3F7D2CAB08475CFCBFF88B9349FC7DA799EE5A8C5373F2178C262729D93D691A8E184591386101154B298ECC023AC7DCCCCF470A6AC6BF099502FED0A20BD571EEC639B277B6FA1F0B18B712A7C49AAE2BC5EA67DD4E11C394A86BF37E6718E7C232F4180CA2302534758A4E14B435685F2A36750D1C9AD5DDAA0DA8472777869714685D74D52D139DF91867C4954B3B11F1DAE640DA2FB86EC241909CCFBF1648C27156D92B69CF1906E1E1AB0C36A4DB7386FF9AA340F6B5D354412A985A54F91741D5EF913D2458971676C819E2DB3918948E70445EBE19B4A5FD7567CE04292A4BF4651DB880D9E2BC10C49714812FAACE73E7283CC3DE9DA67533C07833509504FD1E1A349B22612B7D938A78E200D525F3BDB60E30A4150CE92D8D5889FBD2F22CCC9046C62A4CA27CFE741B559F6874B6C2CC5C3FF274A8674A23E0F2B8A670D80F9C22E40C16DD99E3754B23C6D35DD462099851C42BA067C75FE16813BC9D933AE879E2ADE232CC581F3850925359CE6633A462B7258560E3B135CA8E5AC5ED56F4F196E7BB0280E247CBD79557E44330D0F45DF282C067A82DB9419426BC549BF5B468F70EE9C81E183C004F7D1BF1F3E2BBD8854F78B801929C7ED869BB8A420104CBC4E964697E9ADA4B55BC9E8FF9C2C0D75F1A2F4EFD5416933D6DB746
tmp_aes_key = C3CC8BD927F95C57F5565994829974576F927A242E37E9166F8E1464A9E290DA
tmp_aes_iv = 4607FCB9E6397C9A9F6C179F561B660532DFF53B6782FE4E563FD12A154BB5D0</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1D76F54DB420019B5241F52A1B1BA1C36E1AE881BA0D89B5DA8F304BDA3E14CF4CC1C3A45A90156F18061D83761E28EDACCD4E3098C26D3803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010002E5CA08F1D3BA7137A49ED7EC7F6CB589385C5A8E90F83235B56848E31E5D4967D11D1C2F6A208086FA30017D3F218938A6640A541485ADE693C1533DE9022B4D5AEC13600BDED49CAD9E425047D50842D6AAE97360EBDB20B1C9C04FB212B48B51D44E248EB458C2EFCE4931F9FD68AE4BC85C9FF85F5F12B463191225D851F454F660436FFC5C002FA4175F585C737AADE8C770BC4CB25E942D447326913D2AA41E8AF7182CB8C21F7FC40D6B08F6BFE3D3BB1C058C1E206FAF305E1496C5762FD24E67416F3775C38F1B86BE811E589BE93C6E27AA1075E2F244BD0D1656CE0AB6EAEE8A138BC8668262644A929F8A170A3E8F9E51437760C026EAAFE9063473386722E0578FB4FFEACA
answer = BA0D89B5DA8F304BDA3E14CF4CC1C3A45A90156F18061D83761E28EDACCD4E3098C26D3803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010002E5CA08F1D3BA7137A49ED7EC7F6CB589385C5A8E90F83235B56848E31E5D4967D11D1C2F6A208086FA30017D3F218938A6640A541485ADE693C1533DE9022B4D5AEC13600BDED49CAD9E425047D50842D6AAE97360EBDB20B1C9C04FB212B48B51D44E248EB458C2EFCE4931F9FD68AE4BC85C9FF85F5F12B463191225D851F454F660436FFC5C002FA4175F585C737AADE8C770BC4CB25E942D447326913D2AA41E8AF7182CB8C21F7FC40D6B08F6BFE3D3BB1C058C1E206FAF305E1496C5762FD24E67416F3775C38F1B86BE811E589BE93C6E27AA1075E2F244BD0D1656CE0AB6EAEE8A138BC8668262644A929F8A170A3E8F9E51437760C026EAAFE9063473386722E0578FB4FFEACA</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 DA 8F 30 4B DA 3E 14 CF 4C C1 C3 A4
0010 | 5A 90 15 6F 18 06 1D 83 76 1E 28 ED AC CD 4E 30
0020 | 98 C2 6D 38 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 02 E5 CA 08 F1 D3 BA 71 37 A4 9E D7 EC 7F 6C B5
0140 | 89 38 5C 5A 8E 90 F8 32 35 B5 68 48 E3 1E 5D 49
0150 | 67 D1 1D 1C 2F 6A 20 80 86 FA 30 01 7D 3F 21 89
0160 | 38 A6 64 0A 54 14 85 AD E6 93 C1 53 3D E9 02 2B
0170 | 4D 5A EC 13 60 0B DE D4 9C AD 9E 42 50 47 D5 08
0180 | 42 D6 AA E9 73 60 EB DB 20 B1 C9 C0 4F B2 12 B4
0190 | 8B 51 D4 4E 24 8E B4 58 C2 EF CE 49 31 F9 FD 68
01A0 | AE 4B C8 5C 9F F8 5F 5F 12 B4 63 19 12 25 D8 51
01B0 | F4 54 F6 60 43 6F FC 5C 00 2F A4 17 5F 58 5C 73
01C0 | 7A AD E8 C7 70 BC 4C B2 5E 94 2D 44 73 26 91 3D
01D0 | 2A A4 1E 8A F7 18 2C B8 C2 1F 7F C4 0D 6B 08 F6
01E0 | BF E3 D3 BB 1C 05 8C 1E 20 6F AF 30 5E 14 96 C5
01F0 | 76 2F D2 4E 67 41 6F 37 75 C3 8F 1B 86 BE 81 1E
0200 | 58 9B E9 3C 6E 27 AA 10 75 E2 F2 44 BD 0D 16 56
0210 | CE 0A B6 EA EE 8A 13 8B C8 66 82 62 64 4A 92 9F
0220 | 8A 17 0A 3E 8F 9E 51 43 77 60 C0 26 EA AF E9 06
0230 | 34 73 38 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010002E5CA08F1D3BA7137A49ED7</code> <code>EC7F6CB589385C5A8E90F83235B56848</code> <code>E31E5D4967D11D1C2F6A208086FA3001</code> <code>7D3F218938A6640A541485ADE693C153</code> <code>3DE9022B4D5AEC13600BDED49CAD9E42</code> <code>5047D50842D6AAE97360EBDB20B1C9C0</code> <code>4FB212B48B51D44E248EB458C2EFCE49</code> <code>31F9FD68AE4BC85C9FF85F5F12B46319</code> <code>1225D851F454F660436FFC5C002FA417</code> <code>5F585C737AADE8C770BC4CB25E942D44</code> <code>7326913D2AA41E8AF7182CB8C21F7FC4</code> <code>0D6B08F6BFE3D3BB1C058C1E206FAF30</code> <code>5E1496C5762FD24E67416F3775C38F1B</code> <code>86BE811E589BE93C6E27AA1075E2F244</code> <code>BD0D1656CE0AB6EAEE8A138BC8668262</code> <code>644A929F8A170A3E8F9E51437760C026</code><br> <code>EAAFE906</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>34733867</code> (1731752756 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 8F1F0600EA228E24D523E70EF1BD9EAE4878EB9F93A7C1D6F4B58ECE228DB51B79DC14D1117C139BE25D994E8584245ED2E137E322EE6450EBD1AF9B6DC5FB44DE964F41FE8163D51C37E2B05FA3E8C35ECFB5E0427F89A5E52BBD7829CC5E20754C0BB70995D4C461F343D66D40CEA859352054BE6017296A61EF89D1AF02D90ECE13D321BF52E5F5371D6C27E79FDD1274836C63D9A7ACD6A2E56949879A0BEB3D13A0A558EB9AC61ECAB15BB31BF499EB1BB55581598653790FE157326B6184D71360861AE92E592EC3CB2AD6F3DB2E6D00F8EE680BDAD0B65A11889F09DEA9221DC602EDBB40A18ABCCCFA45A98366A5B30CA5AEE2A706297ECE8B5D2E32</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 1A5A1D23F7AA2DD9DEC1D446C76D609A55B36BDFF7BC6306258D00755DF586997D56491AA5A5D6B77DE6BF7FF733C8F8CC255ED31A13FDCA5AE71CC555255B9C767BCE8ACC5C9D729B5BC8C4F9EDA78C57C576B2018CD0E69118CC1F436F18A64A2C17DE8D0F4D5D15DF491CA0C9F660A3CE03655693269B20F95C25585744B7EC7BD50702810A6CCFB9E2B57738873DE628B1D212409A24D5C33D2BE9CC07E409A74CDFC772C5B964B18AC37F7F5B0E4CB4846C0A743522AA5ABDCA318F96007A79FA04276EFC807B445F4C62A9C3B913F7837ADBBA8072532984F768F0CE42689E1AFA318A9AB882D44750DE09F310034EE7A6A070C70E6AC09B999951311E</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 DA 8F 30 4B DA 3E 14 CF 4C C1 C3 A4
0010 | 5A 90 15 6F 18 06 1D 83 76 1E 28 ED AC CD 4E 30
0020 | 98 C2 6D 38 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 1A 5A 1D 23 F7 AA 2D D9 DE C1 D4 46 C7 6D 60 9A
0040 | 55 B3 6B DF F7 BC 63 06 25 8D 00 75 5D F5 86 99
0050 | 7D 56 49 1A A5 A5 D6 B7 7D E6 BF 7F F7 33 C8 F8
0060 | CC 25 5E D3 1A 13 FD CA 5A E7 1C C5 55 25 5B 9C
0070 | 76 7B CE 8A CC 5C 9D 72 9B 5B C8 C4 F9 ED A7 8C
0080 | 57 C5 76 B2 01 8C D0 E6 91 18 CC 1F 43 6F 18 A6
0090 | 4A 2C 17 DE 8D 0F 4D 5D 15 DF 49 1C A0 C9 F6 60
00A0 | A3 CE 03 65 56 93 26 9B 20 F9 5C 25 58 57 44 B7
00B0 | EC 7B D5 07 02 81 0A 6C CF B9 E2 B5 77 38 87 3D
00C0 | E6 28 B1 D2 12 40 9A 24 D5 C3 3D 2B E9 CC 07 E4
00D0 | 09 A7 4C DF C7 72 C5 B9 64 B1 8A C3 7F 7F 5B 0E
00E0 | 4C B4 84 6C 0A 74 35 22 AA 5A BD CA 31 8F 96 00
00F0 | 7A 79 FA 04 27 6E FC 80 7B 44 5F 4C 62 A9 C3 B9
0100 | 13 F7 83 7A DB BA 80 72 53 29 84 F7 68 F0 CE 42
0110 | 68 9E 1A FA 31 8A 9A B8 82 D4 47 50 DE 09 F3 10
0120 | 03 4E E7 A6 A0 70 C7 0E 6A C0 9B 99 99 51 31 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001001A5A1D23F7AA2DD9DEC1D446</code> <code>C76D609A55B36BDFF7BC6306258D0075</code> <code>5DF586997D56491AA5A5D6B77DE6BF7F</code> <code>F733C8F8CC255ED31A13FDCA5AE71CC5</code> <code>55255B9C767BCE8ACC5C9D729B5BC8C4</code> <code>F9EDA78C57C576B2018CD0E69118CC1F</code> <code>436F18A64A2C17DE8D0F4D5D15DF491C</code> <code>A0C9F660A3CE03655693269B20F95C25</code> <code>585744B7EC7BD50702810A6CCFB9E2B5</code> <code>7738873DE628B1D212409A24D5C33D2B</code> <code>E9CC07E409A74CDFC772C5B964B18AC3</code> <code>7F7F5B0E4CB4846C0A743522AA5ABDCA</code> <code>318F96007A79FA04276EFC807B445F4C</code> <code>62A9C3B913F7837ADBBA8072532984F7</code> <code>68F0CE42689E1AFA318A9AB882D44750</code> <code>DE09F310034EE7A6A070C70E6AC09B99</code><br> <code>9951311E</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366DA8F304BDA3E14CF4CC1C3A45A90156F18061D83761E28EDACCD4E3098C26D380000000000000000FE0001001A5A1D23F7AA2DD9DEC1D446C76D609A55B36BDFF7BC6306258D00755DF586997D56491AA5A5D6B77DE6BF7FF733C8F8CC255ED31A13FDCA5AE71CC555255B9C767BCE8ACC5C9D729B5BC8C4F9EDA78C57C576B2018CD0E69118CC1F436F18A64A2C17DE8D0F4D5D15DF491CA0C9F660A3CE03655693269B20F95C25585744B7EC7BD50702810A6CCFB9E2B57738873DE628B1D212409A24D5C33D2BE9CC07E409A74CDFC772C5B964B18AC37F7F5B0E4CB4846C0A743522AA5ABDCA318F96007A79FA04276EFC807B445F4C62A9C3B913F7837ADBBA8072532984F768F0CE42689E1AFA318A9AB882D44750DE09F310034EE7A6A070C70E6AC09B999951311E
padding = 6226EC63E93464D393BEE8B0
tmp_aes_key = C3CC8BD927F95C57F5565994829974576F927A242E37E9166F8E1464A9E290DA
tmp_aes_iv = 4607FCB9E6397C9A9F6C179F561B660532DFF53B6782FE4E563FD12A154BB5D0</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C5189C9B7C88624E7CE0C220A165A05F9DA8AC40D50ED71CDCE13C990FBAEEE29DA123D967C4AB5B66FBFBB036D3F88FE8C0EF6EA31055D02F5825017EF519ACD1730350AD3CECA1208BCC3808632B0A3D7E8A83EB633E6C91660B2AB057A5EC0E365C31D10F00D98A4C33191DCB4BDF3338F85FF0EEF1663F8FB7624C50A702EDCFA984F66D3931D1CF22AC7D43DA24BF8CCB2768002221380F837EA99029B240A96747569C5AFB89AB8B5EFC158971C5E02AC124357B3E6F66DF2076512D659D7803B3853532E81EF13ECE6EABDF9517E2070DE10CE996965BADCD6B423F2D74FA56D3A1C36342550361331B761B23AB5AC04BD54278E7C8EB6F3E125FA9C1E20692F8DFC4220786FB20E1370F6B95D175894419FAFA51EE516A59F1A59C1C2BA4067C97EBF2FDD41F00EE58859FDA0AE8AF7DA0515DD87F087A15BA419868E7CF947DC07F3D92F55EFCDC3E317F98</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC 6A 0E 00 34 73 38 67
0010 | 78 01 00 00 1F 5F 04 F5 DA 8F 30 4B DA 3E 14 CF
0020 | 4C C1 C3 A4 5A 90 15 6F 18 06 1D 83 76 1E 28 ED
0030 | AC CD 4E 30 98 C2 6D 38 FE 50 01 00 C5 18 9C 9B
0040 | 7C 88 62 4E 7C E0 C2 20 A1 65 A0 5F 9D A8 AC 40
0050 | D5 0E D7 1C DC E1 3C 99 0F BA EE E2 9D A1 23 D9
0060 | 67 C4 AB 5B 66 FB FB B0 36 D3 F8 8F E8 C0 EF 6E
0070 | A3 10 55 D0 2F 58 25 01 7E F5 19 AC D1 73 03 50
0080 | AD 3C EC A1 20 8B CC 38 08 63 2B 0A 3D 7E 8A 83
0090 | EB 63 3E 6C 91 66 0B 2A B0 57 A5 EC 0E 36 5C 31
00A0 | D1 0F 00 D9 8A 4C 33 19 1D CB 4B DF 33 38 F8 5F
00B0 | F0 EE F1 66 3F 8F B7 62 4C 50 A7 02 ED CF A9 84
00C0 | F6 6D 39 31 D1 CF 22 AC 7D 43 DA 24 BF 8C CB 27
00D0 | 68 00 22 21 38 0F 83 7E A9 90 29 B2 40 A9 67 47
00E0 | 56 9C 5A FB 89 AB 8B 5E FC 15 89 71 C5 E0 2A C1
00F0 | 24 35 7B 3E 6F 66 DF 20 76 51 2D 65 9D 78 03 B3
0100 | 85 35 32 E8 1E F1 3E CE 6E AB DF 95 17 E2 07 0D
0110 | E1 0C E9 96 96 5B AD CD 6B 42 3F 2D 74 FA 56 D3
0120 | A1 C3 63 42 55 03 61 33 1B 76 1B 23 AB 5A C0 4B
0130 | D5 42 78 E7 C8 EB 6F 3E 12 5F A9 C1 E2 06 92 F8
0140 | DF C4 22 07 86 FB 20 E1 37 0F 6B 95 D1 75 89 44
0150 | 19 FA FA 51 EE 51 6A 59 F1 A5 9C 1C 2B A4 06 7C
0160 | 97 EB F2 FD D4 1F 00 EE 58 85 9F DA 0A E8 AF 7D
0170 | A0 51 5D D8 7F 08 7A 15 BA 41 98 68 E7 CF 94 7D
0180 | C0 7F 3D 92 F5 5E FC DC 3E 31 7F 98</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CC6A0E0034733867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C5189C9B7C88624E7CE0C220</code> <code>A165A05F9DA8AC40D50ED71CDCE13C99</code> <code>0FBAEEE29DA123D967C4AB5B66FBFBB0</code> <code>36D3F88FE8C0EF6EA31055D02F582501</code> <code>7EF519ACD1730350AD3CECA1208BCC38</code> <code>08632B0A3D7E8A83EB633E6C91660B2A</code> <code>B057A5EC0E365C31D10F00D98A4C3319</code> <code>1DCB4BDF3338F85FF0EEF1663F8FB762</code> <code>4C50A702EDCFA984F66D3931D1CF22AC</code> <code>7D43DA24BF8CCB2768002221380F837E</code> <code>A99029B240A96747569C5AFB89AB8B5E</code> <code>FC158971C5E02AC124357B3E6F66DF20</code> <code>76512D659D7803B3853532E81EF13ECE</code> <code>6EABDF9517E2070DE10CE996965BADCD</code> <code>6B423F2D74FA56D3A1C3634255036133</code> <code>1B761B23AB5AC04BD54278E7C8EB6F3E</code> <code>125FA9C1E20692F8DFC4220786FB20E1</code> <code>370F6B95D175894419FAFA51EE516A59</code> <code>F1A59C1C2BA4067C97EBF2FDD41F00EE</code> <code>58859FDA0AE8AF7DA0515DD87F087A15</code> <code>BA419868E7CF947DC07F3D92F55EFCDC</code><br> <code>3E317F98</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 72CCEFE497C7AD95D6FAA68228F1D91CB6B7EB9759CF87AB9C55F9177935B3F3943A266C6806AC2553690A4C1C8482D6691254885FBB9EBE200A7AD00FC17378C0D140387830B48BAE1D05B4A0EA2A9A899780E880B83F9D564285633C732D61BDDB41060C8E908643DDCAECC9D2F40025AA8AE78AE84DA39717CC86428906BFFDE1C394654EE80C3FA251858E66E1CBF8D45365AB9933178EB4FFE629F63418A1A6799EB43BBD2851C32124A27FEF6AF07600EEC15EC6B57716F92AA0DD58FF1F03C901BBF94AE73CCF2192A6CCD3D3AC2968D3CD0D7570E31ABE6170B9531BE6F9D40DE277EE0632C6397525456116A076DBF8A078B78D53E5D241F509FD8C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 01 50 35 73 38 67
0010 | 34 00 00 00 34 F7 CB 3B DA 8F 30 4B DA 3E 14 CF
0020 | 4C C1 C3 A4 5A 90 15 6F 18 06 1D 83 76 1E 28 ED
0030 | AC CD 4E 30 98 C2 6D 38 75 5F B4 3E 02 10 FD 88
0040 | 14 F2 BA 24 8D 98 92 BD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C4015035733867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DA8F304BDA3E14CF4CC1C3A45A90156F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>18061D83761E28EDACCD4E3098C26D38</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>755FB43E0210FD8814F2BA248D9892BD</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

