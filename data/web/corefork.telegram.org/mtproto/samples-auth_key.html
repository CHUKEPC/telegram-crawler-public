<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D0 C6 00 00 E3 CD 59 67
0010 | 14 00 00 00 F1 8E 7E BE E6 30 71 5E 43 E5 41 FE
0020 | F2 50 16 1A 6F 94 5F EE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D0C60000E3CD5967</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 20 E1 3D E3 CD 59 67
0010 | 50 00 00 00 63 24 16 05 E6 30 71 5E 43 E5 41 FE
0020 | F2 50 16 1A 6F 94 5F EE 31 83 34 CB 09 F7 31 9A
0030 | DB 64 E7 0C F8 6F 71 EE 08 1C C3 AA DF 24 5E 2A
0040 | FF 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0120E13DE3CD5967</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081CC3AADF245E2AFF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2072688128885140223</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2072688128885140223</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2072688128885140223 = 1286824069 * 1610700467</code></p>
<pre><code>p = 1286824069
q = 1610700467</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1C C3 AA DF 24 5E 2A FF 00 00 00
0010 | 04 4C B3 60 85 00 00 00 04 60 01 56 B3 00 00 00
0020 | E6 30 71 5E 43 E5 41 FE F2 50 16 1A 6F 94 5F EE
0030 | 31 83 34 CB 09 F7 31 9A DB 64 E7 0C F8 6F 71 EE
0040 | 4F F2 54 CF 06 D9 04 CE 07 BD A1 27 34 97 0A C1
0050 | E1 CB 7F 97 F2 4F 80 9C 8C 86 48 C1 D3 4D 72 F2
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081CC3AADF245E2AFF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2072688128885140223</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044CB36085000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1286824069</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04600156B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1610700467</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>4FF254CF06D904CE07BDA12734970AC1</code> <code>E1CB7F97F24F809C8C8648C1D34D72F2</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081CC3AADF245E2AFF000000044CB3608500000004600156B3000000E630715E43E541FEF250161A6F945FEE318334CB09F7319ADB64E70CF86F71EE4FF254CF06D904CE07BDA12734970AC1E1CB7F97F24F809C8C8648C1D34D72F202000000
random_padding_bytes = 8969FC849F0167B3B3B02F3AA5BB93D641DFC07256E9C77D4AEA9BB079BEE221D112672FFFC1B756E373D4C692B20749D2DA7695CD2280BB08DFD8F6B44DB603A3F6E21DF2B95A00F8DF8A4FD6F0C613384B453F1FC7BE1D283CE99E</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 3005FA6D2850A746A206D5BCF0EACEFC2B44E9DD4E11C46085BBC0159D421534B1E9E077E35A45D26AF76E808AE67F0679858743644CC9D90EFDA29056274652CD22624BEB36CC0C278DB9597731BCA38BC6A3BFCB6B16DDEB695C784167007B3A0D1AD060105E4EA7E7573321B0ECFD674966E09136BFEA773551B34AA633B92C7EF31D548562BC2E6C675E8952E970C08957DD255248AB93D6DF53837D87C625757742C99D80769604AC483ED1BA83E8600CB62A62D2AA01508EFA0F153AE660D353152F3EEB09B33662F14AA244733B1051C522C96A6CA44E5C68E01438FAD94645FF98AA2858EA2197BD0D0820239A017C68250A36235A41EB9443FCC000</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 60 D8 0E 00 E3 CD 59 67
0010 | 40 01 00 00 BE E4 12 D7 E6 30 71 5E 43 E5 41 FE
0020 | F2 50 16 1A 6F 94 5F EE 31 83 34 CB 09 F7 31 9A
0030 | DB 64 E7 0C F8 6F 71 EE 04 4C B3 60 85 00 00 00
0040 | 04 60 01 56 B3 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 30 05 FA 6D 28 50 A7 46 A2 06 D5 BC
0060 | F0 EA CE FC 2B 44 E9 DD 4E 11 C4 60 85 BB C0 15
0070 | 9D 42 15 34 B1 E9 E0 77 E3 5A 45 D2 6A F7 6E 80
0080 | 8A E6 7F 06 79 85 87 43 64 4C C9 D9 0E FD A2 90
0090 | 56 27 46 52 CD 22 62 4B EB 36 CC 0C 27 8D B9 59
00A0 | 77 31 BC A3 8B C6 A3 BF CB 6B 16 DD EB 69 5C 78
00B0 | 41 67 00 7B 3A 0D 1A D0 60 10 5E 4E A7 E7 57 33
00C0 | 21 B0 EC FD 67 49 66 E0 91 36 BF EA 77 35 51 B3
00D0 | 4A A6 33 B9 2C 7E F3 1D 54 85 62 BC 2E 6C 67 5E
00E0 | 89 52 E9 70 C0 89 57 DD 25 52 48 AB 93 D6 DF 53
00F0 | 83 7D 87 C6 25 75 77 42 C9 9D 80 76 96 04 AC 48
0100 | 3E D1 BA 83 E8 60 0C B6 2A 62 D2 AA 01 50 8E FA
0110 | 0F 15 3A E6 60 D3 53 15 2F 3E EB 09 B3 36 62 F1
0120 | 4A A2 44 73 3B 10 51 C5 22 C9 6A 6C A4 4E 5C 68
0130 | E0 14 38 FA D9 46 45 FF 98 AA 28 58 EA 21 97 BD
0140 | 0D 08 20 23 9A 01 7C 68 25 0A 36 23 5A 41 EB 94
0150 | 43 FC C0 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>60D80E00E3CD5967</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044CB36085000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1286824069</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04600156B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1610700467</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001003005FA6D2850A746A206D5BC</code> <code>F0EACEFC2B44E9DD4E11C46085BBC015</code> <code>9D421534B1E9E077E35A45D26AF76E80</code> <code>8AE67F0679858743644CC9D90EFDA290</code> <code>56274652CD22624BEB36CC0C278DB959</code> <code>7731BCA38BC6A3BFCB6B16DDEB695C78</code> <code>4167007B3A0D1AD060105E4EA7E75733</code> <code>21B0ECFD674966E09136BFEA773551B3</code> <code>4AA633B92C7EF31D548562BC2E6C675E</code> <code>8952E970C08957DD255248AB93D6DF53</code> <code>837D87C625757742C99D80769604AC48</code> <code>3ED1BA83E8600CB62A62D2AA01508EFA</code> <code>0F153AE660D353152F3EEB09B33662F1</code> <code>4AA244733B1051C522C96A6CA44E5C68</code> <code>E01438FAD94645FF98AA2858EA2197BD</code> <code>0D0820239A017C68250A36235A41EB94</code><br> <code>43FCC000</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 00 91 5A E3 CD 59 67
0010 | 78 02 00 00 5C 07 E8 D0 E6 30 71 5E 43 E5 41 FE
0020 | F2 50 16 1A 6F 94 5F EE 31 83 34 CB 09 F7 31 9A
0030 | DB 64 E7 0C F8 6F 71 EE FE 50 02 00 E6 89 08 31
0040 | 25 EB A1 8A D0 B5 4E 78 5B 86 E4 0E 9F 76 E1 11
0050 | 2A 5B EC B8 80 33 60 D0 BB 2C 98 1F 4A 1D 20 0E
0060 | 23 F8 DC A2 63 2F 94 D5 1F CB 55 D7 68 D9 E5 7E
0070 | 89 3A C7 90 81 96 BC D8 F1 FE D5 F3 57 C4 9F B7
0080 | E4 85 03 C9 0A B4 DB 8B 8D 68 B7 2E E6 FB 6C 5B
0090 | A6 83 46 9B F4 96 5F 31 18 7A DE 34 51 32 22 92
00A0 | 0A 99 DF 66 F8 A9 17 AB A8 83 F8 76 06 35 55 DC
00B0 | 01 C1 8E C3 93 9D 1E 36 2D D6 AD 9A 56 E8 DD 9A
00C0 | D1 6B 60 A4 FD C7 72 FE E1 75 D7 F4 12 34 E3 72
00D0 | 2F 35 1F 57 B8 80 06 14 07 8D 85 46 EC E1 B8 5B
00E0 | B4 2E A0 06 42 0A 0A 24 C6 67 F8 6C A9 54 E3 9E
00F0 | D8 C7 90 D7 51 D4 99 F1 AA 3E 97 3E B6 62 F0 71
0100 | 8C F3 69 F7 D8 B1 BD 49 15 1C 6A 71 6F 37 A4 4E
0110 | 43 1C 8E 55 F5 7E 16 21 1B C0 3A 86 D0 3A 46 BB
0120 | 8F 2A E1 A1 DA 03 AB 68 93 34 36 DF 1F 50 54 3E
0130 | 2F 04 3F 5B D5 DE CB 31 9F 81 D9 15 8E 5E 63 81
0140 | F0 BA 99 4F E1 05 01 C6 E5 F2 CC 28 43 38 F3 4C
0150 | E0 AB 6A 16 21 45 F0 BF AB 62 65 AE 7D D0 2E 42
0160 | A6 2F D0 81 AB A3 3E 55 81 A6 3E 99 7D D5 3F 07
0170 | A9 4E DB 13 E8 38 91 38 EE 13 74 9C F4 58 ED 74
0180 | AF 8C 40 D8 7B C1 6C 10 E9 0A 63 C4 48 86 72 2A
0190 | CA 66 8E 9A EB FE 32 41 6C B6 69 AA 54 18 4B 54
01A0 | 63 41 74 62 05 20 87 66 D7 A6 57 8E 78 EF DB 8D
01B0 | E3 32 55 1D 7E 5E C1 D7 78 23 4C 3A BA 2C D0 B1
01C0 | 97 5C AD D0 3E 7C 70 E2 16 1B 48 0D 32 CD 51 60
01D0 | 86 92 C1 78 13 02 3B FD E0 77 EE 06 A2 01 77 31
01E0 | 8A 6C 21 02 25 9E 77 80 97 6A 5F 1E C3 D4 3B E9
01F0 | B6 E4 0B 80 F1 66 D1 31 25 E5 FC B2 54 E3 48 03
0200 | AD E1 58 84 CB 09 8D 6A DC 88 72 33 37 2C BC 2A
0210 | 73 22 A7 EF D3 36 1C 33 7A FD AD 2E B1 3C 55 3B
0220 | 83 8D 03 23 C9 6A 14 E6 D2 ED 94 C9 7C 88 1B 56
0230 | 36 5C 64 78 3F CD B3 7A 6D 39 2B 0C 56 4E 19 AB
0240 | 91 32 70 24 15 5C DC 80 08 9F 82 82 4F 67 58 E5
0250 | 44 01 4E BB A1 EA 7F 37 59 DE 9D F6 B4 29 D4 A4
0260 | 90 EA 09 E4 A3 D6 8B C9 E9 A1 41 37 07 A6 E7 53
0270 | FC E0 05 4D BE CC DE E2 3A 12 B6 67 7F 8A B1 46
0280 | F8 35 8D 1A 3C 3F 47 56 8F F0 5A 9B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0100915AE3CD5967</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200E689083125EBA18AD0B54E78</code> <code>5B86E40E9F76E1112A5BECB8803360D0</code> <code>BB2C981F4A1D200E23F8DCA2632F94D5</code> <code>1FCB55D768D9E57E893AC7908196BCD8</code> <code>F1FED5F357C49FB7E48503C90AB4DB8B</code> <code>8D68B72EE6FB6C5BA683469BF4965F31</code> <code>187ADE34513222920A99DF66F8A917AB</code> <code>A883F876063555DC01C18EC3939D1E36</code> <code>2DD6AD9A56E8DD9AD16B60A4FDC772FE</code> <code>E175D7F41234E3722F351F57B8800614</code> <code>078D8546ECE1B85BB42EA006420A0A24</code> <code>C667F86CA954E39ED8C790D751D499F1</code> <code>AA3E973EB662F0718CF369F7D8B1BD49</code> <code>151C6A716F37A44E431C8E55F57E1621</code> <code>1BC03A86D03A46BB8F2AE1A1DA03AB68</code> <code>933436DF1F50543E2F043F5BD5DECB31</code> <code>9F81D9158E5E6381F0BA994FE10501C6</code> <code>E5F2CC284338F34CE0AB6A162145F0BF</code> <code>AB6265AE7DD02E42A62FD081ABA33E55</code> <code>81A63E997DD53F07A94EDB13E8389138</code> <code>EE13749CF458ED74AF8C40D87BC16C10</code> <code>E90A63C44886722ACA668E9AEBFE3241</code> <code>6CB669AA54184B546341746205208766</code> <code>D7A6578E78EFDB8DE332551D7E5EC1D7</code> <code>78234C3ABA2CD0B1975CADD03E7C70E2</code> <code>161B480D32CD51608692C17813023BFD</code> <code>E077EE06A20177318A6C2102259E7780</code> <code>976A5F1EC3D43BE9B6E40B80F166D131</code> <code>25E5FCB254E34803ADE15884CB098D6A</code> <code>DC887233372CBC2A7322A7EFD3361C33</code> <code>7AFDAD2EB13C553B838D0323C96A14E6</code> <code>D2ED94C97C881B56365C64783FCDB37A</code> <code>6D392B0C564E19AB91327024155CDC80</code> <code>089F82824F6758E544014EBBA1EA7F37</code> <code>59DE9DF6B429D4A490EA09E4A3D68BC9</code> <code>E9A1413707A6E753FCE0054DBECCDEE2</code> <code>3A12B6677F8AB146F8358D1A3C3F4756</code><br> <code>8FF05A9B</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = E689083125EBA18AD0B54E785B86E40E9F76E1112A5BECB8803360D0BB2C981F4A1D200E23F8DCA2632F94D51FCB55D768D9E57E893AC7908196BCD8F1FED5F357C49FB7E48503C90AB4DB8B8D68B72EE6FB6C5BA683469BF4965F31187ADE34513222920A99DF66F8A917ABA883F876063555DC01C18EC3939D1E362DD6AD9A56E8DD9AD16B60A4FDC772FEE175D7F41234E3722F351F57B8800614078D8546ECE1B85BB42EA006420A0A24C667F86CA954E39ED8C790D751D499F1AA3E973EB662F0718CF369F7D8B1BD49151C6A716F37A44E431C8E55F57E16211BC03A86D03A46BB8F2AE1A1DA03AB68933436DF1F50543E2F043F5BD5DECB319F81D9158E5E6381F0BA994FE10501C6E5F2CC284338F34CE0AB6A162145F0BFAB6265AE7DD02E42A62FD081ABA33E5581A63E997DD53F07A94EDB13E8389138EE13749CF458ED74AF8C40D87BC16C10E90A63C44886722ACA668E9AEBFE32416CB669AA54184B546341746205208766D7A6578E78EFDB8DE332551D7E5EC1D778234C3ABA2CD0B1975CADD03E7C70E2161B480D32CD51608692C17813023BFDE077EE06A20177318A6C2102259E7780976A5F1EC3D43BE9B6E40B80F166D13125E5FCB254E34803ADE15884CB098D6ADC887233372CBC2A7322A7EFD3361C337AFDAD2EB13C553B838D0323C96A14E6D2ED94C97C881B56365C64783FCDB37A6D392B0C564E19AB91327024155CDC80089F82824F6758E544014EBBA1EA7F3759DE9DF6B429D4A490EA09E4A3D68BC9E9A1413707A6E753FCE0054DBECCDEE23A12B6677F8AB146F8358D1A3C3F47568FF05A9B
tmp_aes_key = EA14E9A712F393590E9C8687E5707DB80C1AD41DE73CDF7B2604B9D404C5D861
tmp_aes_iv = CE540854CE41E440BABAB487596ED10533BEA1CA98AACE609A6ED5684FF254CF</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1FCAFDC7EBBE8558C3A17A145A736D0AB45F1A21BA0D89B5E630715E43E541FEF250161A6F945FEE318334CB09F7319ADB64E70CF86F71EE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000F87C571539C15A64AD3F210C4FA7A786DF37E7F2D035507B5B7F86B24AD377C8F4349C8195F63150ADE701E788AE95C827A8A9A226EC0138F3D8CB38FCAC601F37A429CF270EA4EE1299930B899B7D36BEF46BE9E60824D83938FB48EFCC7A32B60E342E9DBD8BA5363C1A78E0839F8D512FAE3071C6163E310C53EE894869DB45D645F46007FD6529CDF1DDD1906428A3B4872BD4EDABFD9E5BD28D8D7C92FB093FDAA9FFD295C6D5E583C8EDBA1A0A59C10CB50D18FE97487E0281919F9EBE05D65EFD90C5BB0C124AE13CDFFA0932F68C1F3234559B35D00C3BA966AD5CD7A812C58694CC9C9397CBF26ADFA4BA857C1B01EADC24A2041D8708B297A4669E3CD5967004416556E39C0F1
answer = BA0D89B5E630715E43E541FEF250161A6F945FEE318334CB09F7319ADB64E70CF86F71EE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000F87C571539C15A64AD3F210C4FA7A786DF37E7F2D035507B5B7F86B24AD377C8F4349C8195F63150ADE701E788AE95C827A8A9A226EC0138F3D8CB38FCAC601F37A429CF270EA4EE1299930B899B7D36BEF46BE9E60824D83938FB48EFCC7A32B60E342E9DBD8BA5363C1A78E0839F8D512FAE3071C6163E310C53EE894869DB45D645F46007FD6529CDF1DDD1906428A3B4872BD4EDABFD9E5BD28D8D7C92FB093FDAA9FFD295C6D5E583C8EDBA1A0A59C10CB50D18FE97487E0281919F9EBE05D65EFD90C5BB0C124AE13CDFFA0932F68C1F3234559B35D00C3BA966AD5CD7A812C58694CC9C9397CBF26ADFA4BA857C1B01EADC24A2041D8708B297A4669E3CD5967004416556E39C0F1</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E6 30 71 5E 43 E5 41 FE F2 50 16 1A
0010 | 6F 94 5F EE 31 83 34 CB 09 F7 31 9A DB 64 E7 0C
0020 | F8 6F 71 EE 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 0F 87 C5 71 53 9C 15 A6 4A D3 F2 10 C4 FA 7A 78
0140 | 6D F3 7E 7F 2D 03 55 07 B5 B7 F8 6B 24 AD 37 7C
0150 | 8F 43 49 C8 19 5F 63 15 0A DE 70 1E 78 8A E9 5C
0160 | 82 7A 8A 9A 22 6E C0 13 8F 3D 8C B3 8F CA C6 01
0170 | F3 7A 42 9C F2 70 EA 4E E1 29 99 30 B8 99 B7 D3
0180 | 6B EF 46 BE 9E 60 82 4D 83 93 8F B4 8E FC C7 A3
0190 | 2B 60 E3 42 E9 DB D8 BA 53 63 C1 A7 8E 08 39 F8
01A0 | D5 12 FA E3 07 1C 61 63 E3 10 C5 3E E8 94 86 9D
01B0 | B4 5D 64 5F 46 00 7F D6 52 9C DF 1D DD 19 06 42
01C0 | 8A 3B 48 72 BD 4E DA BF D9 E5 BD 28 D8 D7 C9 2F
01D0 | B0 93 FD AA 9F FD 29 5C 6D 5E 58 3C 8E DB A1 A0
01E0 | A5 9C 10 CB 50 D1 8F E9 74 87 E0 28 19 19 F9 EB
01F0 | E0 5D 65 EF D9 0C 5B B0 C1 24 AE 13 CD FF A0 93
0200 | 2F 68 C1 F3 23 45 59 B3 5D 00 C3 BA 96 6A D5 CD
0210 | 7A 81 2C 58 69 4C C9 C9 39 7C BF 26 AD FA 4B A8
0220 | 57 C1 B0 1E AD C2 4A 20 41 D8 70 8B 29 7A 46 69
0230 | E3 CD 59 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001000F87C571539C15A64AD3F210</code> <code>C4FA7A786DF37E7F2D035507B5B7F86B</code> <code>24AD377C8F4349C8195F63150ADE701E</code> <code>788AE95C827A8A9A226EC0138F3D8CB3</code> <code>8FCAC601F37A429CF270EA4EE1299930</code> <code>B899B7D36BEF46BE9E60824D83938FB4</code> <code>8EFCC7A32B60E342E9DBD8BA5363C1A7</code> <code>8E0839F8D512FAE3071C6163E310C53E</code> <code>E894869DB45D645F46007FD6529CDF1D</code> <code>DD1906428A3B4872BD4EDABFD9E5BD28</code> <code>D8D7C92FB093FDAA9FFD295C6D5E583C</code> <code>8EDBA1A0A59C10CB50D18FE97487E028</code> <code>1919F9EBE05D65EFD90C5BB0C124AE13</code> <code>CDFFA0932F68C1F3234559B35D00C3BA</code> <code>966AD5CD7A812C58694CC9C9397CBF26</code> <code>ADFA4BA857C1B01EADC24A2041D8708B</code><br> <code>297A4669</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E3CD5967</code> (1733938659 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = E9D45BDC725F79A63A90D8386F3B039D343B2DF6E3D9514409B2291E694F026CE6BDB624223C822765F50BFE2CCCB766871DB8254C6F2FE9E97229061EF945D5BF50BE32C22A20A6691D1A9CE248B67182AF506B4EB8577A41E21D33E2C407780EAD23EE4033512C00C7DBC093F08DF615CB77AD31526B3124AD3B521ACF34DC5B8A3F23C2FDE64F97E2564761A967E95D981F54B82649E6D3837D295B63BA43C00E79CB0CA2EA5D9C83AF1D4C90A85712108CE761A18A8791DC73100109C3FC58A13C03F6A0C6DCF4A85044DC5433C5A046A14B5AD07C4919EB61D0F3CCFC307B5386CB07304FA07D0BBCA9C5C6CFB08BE85755C0763E3D6E59A2E21E559580</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 16E9B03125F2DD2D32F872FB79EA53BBFEAE6EA67FC947EBDE2850B4995B4C478D08515A86D1701B971587EEB89F93E6789D047564BB6636803C26C39D4FAE9C8E947E73DB3F883B8CE95FCA9DFA71EB290336406C39CEE48558D1F3FC03EAC25C85642D05B1C62CC049BF8350ECFCCA60BA0E9638810D8A6526E7C70FAB96EE5D9B37CF00DB1CF470FD7462DDE24AF3B62200244D4C48FC8B279F9AA9DB1EA6ED6E9A825602CF261DA6A71AFE623EC6256F95F30EA6B463A7FEEE2BF229442E60F37F9033612C26EE94DA93D9D312E1EE4E19ED4E49643B5A4567468E924175E6C12BC6F5C831C89006D7F9E8C80285438021A3F07BBE1C25396C29FDEB56FD</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E6 30 71 5E 43 E5 41 FE F2 50 16 1A
0010 | 6F 94 5F EE 31 83 34 CB 09 F7 31 9A DB 64 E7 0C
0020 | F8 6F 71 EE 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 16 E9 B0 31 25 F2 DD 2D 32 F8 72 FB 79 EA 53 BB
0040 | FE AE 6E A6 7F C9 47 EB DE 28 50 B4 99 5B 4C 47
0050 | 8D 08 51 5A 86 D1 70 1B 97 15 87 EE B8 9F 93 E6
0060 | 78 9D 04 75 64 BB 66 36 80 3C 26 C3 9D 4F AE 9C
0070 | 8E 94 7E 73 DB 3F 88 3B 8C E9 5F CA 9D FA 71 EB
0080 | 29 03 36 40 6C 39 CE E4 85 58 D1 F3 FC 03 EA C2
0090 | 5C 85 64 2D 05 B1 C6 2C C0 49 BF 83 50 EC FC CA
00A0 | 60 BA 0E 96 38 81 0D 8A 65 26 E7 C7 0F AB 96 EE
00B0 | 5D 9B 37 CF 00 DB 1C F4 70 FD 74 62 DD E2 4A F3
00C0 | B6 22 00 24 4D 4C 48 FC 8B 27 9F 9A A9 DB 1E A6
00D0 | ED 6E 9A 82 56 02 CF 26 1D A6 A7 1A FE 62 3E C6
00E0 | 25 6F 95 F3 0E A6 B4 63 A7 FE EE 2B F2 29 44 2E
00F0 | 60 F3 7F 90 33 61 2C 26 EE 94 DA 93 D9 D3 12 E1
0100 | EE 4E 19 ED 4E 49 64 3B 5A 45 67 46 8E 92 41 75
0110 | E6 C1 2B C6 F5 C8 31 C8 90 06 D7 F9 E8 C8 02 85
0120 | 43 80 21 A3 F0 7B BE 1C 25 39 6C 29 FD EB 56 FD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010016E9B03125F2DD2D32F872FB</code> <code>79EA53BBFEAE6EA67FC947EBDE2850B4</code> <code>995B4C478D08515A86D1701B971587EE</code> <code>B89F93E6789D047564BB6636803C26C3</code> <code>9D4FAE9C8E947E73DB3F883B8CE95FCA</code> <code>9DFA71EB290336406C39CEE48558D1F3</code> <code>FC03EAC25C85642D05B1C62CC049BF83</code> <code>50ECFCCA60BA0E9638810D8A6526E7C7</code> <code>0FAB96EE5D9B37CF00DB1CF470FD7462</code> <code>DDE24AF3B62200244D4C48FC8B279F9A</code> <code>A9DB1EA6ED6E9A825602CF261DA6A71A</code> <code>FE623EC6256F95F30EA6B463A7FEEE2B</code> <code>F229442E60F37F9033612C26EE94DA93</code> <code>D9D312E1EE4E19ED4E49643B5A456746</code> <code>8E924175E6C12BC6F5C831C89006D7F9</code> <code>E8C80285438021A3F07BBE1C25396C29</code><br> <code>FDEB56FD</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E630715E43E541FEF250161A6F945FEE318334CB09F7319ADB64E70CF86F71EE0000000000000000FE00010016E9B03125F2DD2D32F872FB79EA53BBFEAE6EA67FC947EBDE2850B4995B4C478D08515A86D1701B971587EEB89F93E6789D047564BB6636803C26C39D4FAE9C8E947E73DB3F883B8CE95FCA9DFA71EB290336406C39CEE48558D1F3FC03EAC25C85642D05B1C62CC049BF8350ECFCCA60BA0E9638810D8A6526E7C70FAB96EE5D9B37CF00DB1CF470FD7462DDE24AF3B62200244D4C48FC8B279F9AA9DB1EA6ED6E9A825602CF261DA6A71AFE623EC6256F95F30EA6B463A7FEEE2BF229442E60F37F9033612C26EE94DA93D9D312E1EE4E19ED4E49643B5A4567468E924175E6C12BC6F5C831C89006D7F9E8C80285438021A3F07BBE1C25396C29FDEB56FD
padding = 516F39E50BE87DA0E0F9296C
tmp_aes_key = EA14E9A712F393590E9C8687E5707DB80C1AD41DE73CDF7B2604B9D404C5D861
tmp_aes_iv = CE540854CE41E440BABAB487596ED10533BEA1CA98AACE609A6ED5684FF254CF</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 0D4748016F16F10E5EA6CB407C6843CF50C95DD9D2CF2BB9A3A41DC194ADB4316461C161C516EB190B94A532492FAAB34EC36193B8966DD222521D3515605622F62DC443AAAD848D95F93DC6914F10507227984CEFD3399A430AD244AA86AEDEC89AA2FBD9D7A748AA1BBDC0FDACBF6CC5E0254E2B9952B732FC786C95F4E0F2A1A723F36BC1FAD08C753D63792A5559CFDDBA81C191F303971AD5BB750B837A651A2E71E3E266DD9DDBC92F7868FF0CFFA02152DE0E54E87FDF1DD4C04C46B0158126640BCC75EBF4F2E7E2D140783976F5D7C2B063F68C8822C0BD25B32D93C7A45712B675BDA05E84357D0522423BDC783D998415213F99CBF13F612C9462F88520B9E62254B5D6E896C31A87CC36BE251F70611E73CB801A3235AF8111D0B530340B86E7F6563140749EE08CE5E8EA35582FBA5226A863273CB26450D513F11060D54FF2F0B29FA3C47E6178AABC</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 5B 06 00 E4 CD 59 67
0010 | 78 01 00 00 1F 5F 04 F5 E6 30 71 5E 43 E5 41 FE
0020 | F2 50 16 1A 6F 94 5F EE 31 83 34 CB 09 F7 31 9A
0030 | DB 64 E7 0C F8 6F 71 EE FE 50 01 00 0D 47 48 01
0040 | 6F 16 F1 0E 5E A6 CB 40 7C 68 43 CF 50 C9 5D D9
0050 | D2 CF 2B B9 A3 A4 1D C1 94 AD B4 31 64 61 C1 61
0060 | C5 16 EB 19 0B 94 A5 32 49 2F AA B3 4E C3 61 93
0070 | B8 96 6D D2 22 52 1D 35 15 60 56 22 F6 2D C4 43
0080 | AA AD 84 8D 95 F9 3D C6 91 4F 10 50 72 27 98 4C
0090 | EF D3 39 9A 43 0A D2 44 AA 86 AE DE C8 9A A2 FB
00A0 | D9 D7 A7 48 AA 1B BD C0 FD AC BF 6C C5 E0 25 4E
00B0 | 2B 99 52 B7 32 FC 78 6C 95 F4 E0 F2 A1 A7 23 F3
00C0 | 6B C1 FA D0 8C 75 3D 63 79 2A 55 59 CF DD BA 81
00D0 | C1 91 F3 03 97 1A D5 BB 75 0B 83 7A 65 1A 2E 71
00E0 | E3 E2 66 DD 9D DB C9 2F 78 68 FF 0C FF A0 21 52
00F0 | DE 0E 54 E8 7F DF 1D D4 C0 4C 46 B0 15 81 26 64
0100 | 0B CC 75 EB F4 F2 E7 E2 D1 40 78 39 76 F5 D7 C2
0110 | B0 63 F6 8C 88 22 C0 BD 25 B3 2D 93 C7 A4 57 12
0120 | B6 75 BD A0 5E 84 35 7D 05 22 42 3B DC 78 3D 99
0130 | 84 15 21 3F 99 CB F1 3F 61 2C 94 62 F8 85 20 B9
0140 | E6 22 54 B5 D6 E8 96 C3 1A 87 CC 36 BE 25 1F 70
0150 | 61 1E 73 CB 80 1A 32 35 AF 81 11 D0 B5 30 34 0B
0160 | 86 E7 F6 56 31 40 74 9E E0 8C E5 E8 EA 35 58 2F
0170 | BA 52 26 A8 63 27 3C B2 64 50 D5 13 F1 10 60 D5
0180 | 4F F2 F0 B2 9F A3 C4 7E 61 78 AA BC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>085B0600E4CD5967</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001000D4748016F16F10E5EA6CB40</code> <code>7C6843CF50C95DD9D2CF2BB9A3A41DC1</code> <code>94ADB4316461C161C516EB190B94A532</code> <code>492FAAB34EC36193B8966DD222521D35</code> <code>15605622F62DC443AAAD848D95F93DC6</code> <code>914F10507227984CEFD3399A430AD244</code> <code>AA86AEDEC89AA2FBD9D7A748AA1BBDC0</code> <code>FDACBF6CC5E0254E2B9952B732FC786C</code> <code>95F4E0F2A1A723F36BC1FAD08C753D63</code> <code>792A5559CFDDBA81C191F303971AD5BB</code> <code>750B837A651A2E71E3E266DD9DDBC92F</code> <code>7868FF0CFFA02152DE0E54E87FDF1DD4</code> <code>C04C46B0158126640BCC75EBF4F2E7E2</code> <code>D140783976F5D7C2B063F68C8822C0BD</code> <code>25B32D93C7A45712B675BDA05E84357D</code> <code>0522423BDC783D998415213F99CBF13F</code> <code>612C9462F88520B9E62254B5D6E896C3</code> <code>1A87CC36BE251F70611E73CB801A3235</code> <code>AF8111D0B530340B86E7F6563140749E</code> <code>E08CE5E8EA35582FBA5226A863273CB2</code> <code>6450D513F11060D54FF2F0B29FA3C47E</code><br> <code>6178AABC</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 080E00C209E6008A4C9E519ACFD05F60E5F120C9BAEDD401950CC9377E191F39577569A9306A0543D356EFA0A07A74E97F2CE4631E377FF3E94ED5E8CD3F9E8AA0F4EB839DBA3876216FE23337F9CB113CF2BC7AE7F3DB38E74B3960905AA1E053FD50B376D8F8E47DA2950218AF9D1CA0880F0EEEFD54D09E7DC8350C4988B6FF8B970430D55F500FBE70EE08F3995D056C4A6E2347E40F7D9E1EA454F0F38E7E9E36D7AD35B06FC0A3F5690ECFB09EC7BED00C1A1856247E468372F1D17B832B72AAE452C0B3A8DDBBDB020E84053EEDEBF6EBF3F479CC3BA9AED193CC6C89D5E723A41F54A956A885E27A1B1528355030136C350FC6E60D20B5C7228F1B2D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 44 3E C4 E4 CD 59 67
0010 | 34 00 00 00 34 F7 CB 3B E6 30 71 5E 43 E5 41 FE
0020 | F2 50 16 1A 6F 94 5F EE 31 83 34 CB 09 F7 31 9A
0030 | DB 64 E7 0C F8 6F 71 EE 44 C3 9C 18 EF 94 10 9D
0040 | E2 5F EC 5E 57 0C 72 71</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01443EC4E4CD5967</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E630715E43E541FEF250161A6F945FEE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>318334CB09F7319ADB64E70CF86F71EE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>44C39C18EF94109DE25FEC5E570C7271</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

