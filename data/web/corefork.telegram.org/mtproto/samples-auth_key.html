<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 9C 92 00 00 F8 19 C4 68
0010 | 14 00 00 00 F1 8E 7E BE E7 E1 F9 E4 F1 4E EC 16
0020 | 08 C9 D9 97 FD 2F C7 46</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>9C920000F819C468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C BF 6C F8 19 C4 68
0010 | 50 00 00 00 63 24 16 05 E7 E1 F9 E4 F1 4E EC 16
0020 | 08 C9 D9 97 FD 2F C7 46 24 6C 42 20 BC 4A E4 15
0030 | D0 3C C9 59 10 BA A3 C0 08 20 95 36 58 4D 2E 2F
0040 | 7B 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017CBF6CF819C468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08209536584D2E2F7B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2347842533623476091</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2347842533623476091</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2347842533623476091 = 1280219333 * 1833937727</code></p>
<pre><code>p = 1280219333
q = 1833937727</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 95 36 58 4D 2E 2F 7B 00 00 00
0010 | 04 4C 4E 98 C5 00 00 00 04 6D 4F AB 3F 00 00 00
0020 | E7 E1 F9 E4 F1 4E EC 16 08 C9 D9 97 FD 2F C7 46
0030 | 24 6C 42 20 BC 4A E4 15 D0 3C C9 59 10 BA A3 C0
0040 | 71 5A 4E CB 07 A4 A2 8A 69 4B B3 5D 95 B5 78 55
0050 | 6A B7 9B B6 21 F5 85 F5 35 1F 37 A2 F1 6E 3E E8
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08209536584D2E2F7B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2347842533623476091</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044C4E98C5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1280219333</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046D4FAB3F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1833937727</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>715A4ECB07A4A28A694BB35D95B57855</code> <code>6AB79BB621F585F5351F37A2F16E3EE8</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908209536584D2E2F7B000000044C4E98C5000000046D4FAB3F000000E7E1F9E4F14EEC1608C9D997FD2FC746246C4220BC4AE415D03CC95910BAA3C0715A4ECB07A4A28A694BB35D95B578556AB79BB621F585F5351F37A2F16E3EE802000000
random_padding_bytes = EABEAEE135DC114C5AFFB610A2E1F5337956B6D5474B7CA3B9B2B2624114A7688C7F83D99CD88D85EBD0F2B8D511CBFBD3CB155F17F803248A0CD74228136A613498E0F91901E31438100D9EA3F1BBB48806BAC5734531B1FACC58E5</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 701D259A904C08266A52F6D72371E820D014EAE040DA47F51356E53D9C34A36751E651AE2728F41CAF6F657C83753C36D5B122C2BE2F50A70B2445FC70F3B50C307D04C72EA19016EAC578CC9AC63B5C1B585869429DAFE0CF87ABE1A7BFF62B1010CF61B730F1FCEFBD5967469082844A981C7313E4F0D3369CF4B9CD9A54F4E74530A3FC1BF73D215122AB3F91B75E41C9B26DED2A60C62A91A883A82108AF9212F03E03B2BDC9D797EA714F27F4A99715220BDA71D5F58A53E8969C1EA3C9DE4834BA5750AC194059B5414165B2A685E6F3E34EBB15CFAEE351A3D5D77221DB2BB24DA0418E31FE2EF6FAC1A678CDBB37D88F21DEBE29F10734227D5AF79E</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E8 DA 09 00 F8 19 C4 68
0010 | 40 01 00 00 BE E4 12 D7 E7 E1 F9 E4 F1 4E EC 16
0020 | 08 C9 D9 97 FD 2F C7 46 24 6C 42 20 BC 4A E4 15
0030 | D0 3C C9 59 10 BA A3 C0 04 4C 4E 98 C5 00 00 00
0040 | 04 6D 4F AB 3F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 70 1D 25 9A 90 4C 08 26 6A 52 F6 D7
0060 | 23 71 E8 20 D0 14 EA E0 40 DA 47 F5 13 56 E5 3D
0070 | 9C 34 A3 67 51 E6 51 AE 27 28 F4 1C AF 6F 65 7C
0080 | 83 75 3C 36 D5 B1 22 C2 BE 2F 50 A7 0B 24 45 FC
0090 | 70 F3 B5 0C 30 7D 04 C7 2E A1 90 16 EA C5 78 CC
00A0 | 9A C6 3B 5C 1B 58 58 69 42 9D AF E0 CF 87 AB E1
00B0 | A7 BF F6 2B 10 10 CF 61 B7 30 F1 FC EF BD 59 67
00C0 | 46 90 82 84 4A 98 1C 73 13 E4 F0 D3 36 9C F4 B9
00D0 | CD 9A 54 F4 E7 45 30 A3 FC 1B F7 3D 21 51 22 AB
00E0 | 3F 91 B7 5E 41 C9 B2 6D ED 2A 60 C6 2A 91 A8 83
00F0 | A8 21 08 AF 92 12 F0 3E 03 B2 BD C9 D7 97 EA 71
0100 | 4F 27 F4 A9 97 15 22 0B DA 71 D5 F5 8A 53 E8 96
0110 | 9C 1E A3 C9 DE 48 34 BA 57 50 AC 19 40 59 B5 41
0120 | 41 65 B2 A6 85 E6 F3 E3 4E BB 15 CF AE E3 51 A3
0130 | D5 D7 72 21 DB 2B B2 4D A0 41 8E 31 FE 2E F6 FA
0140 | C1 A6 78 CD BB 37 D8 8F 21 DE BE 29 F1 07 34 22
0150 | 7D 5A F7 9E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E8DA0900F819C468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044C4E98C5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1280219333</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046D4FAB3F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1833937727</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100701D259A904C08266A52F6D7</code> <code>2371E820D014EAE040DA47F51356E53D</code> <code>9C34A36751E651AE2728F41CAF6F657C</code> <code>83753C36D5B122C2BE2F50A70B2445FC</code> <code>70F3B50C307D04C72EA19016EAC578CC</code> <code>9AC63B5C1B585869429DAFE0CF87ABE1</code> <code>A7BFF62B1010CF61B730F1FCEFBD5967</code> <code>469082844A981C7313E4F0D3369CF4B9</code> <code>CD9A54F4E74530A3FC1BF73D215122AB</code> <code>3F91B75E41C9B26DED2A60C62A91A883</code> <code>A82108AF9212F03E03B2BDC9D797EA71</code> <code>4F27F4A99715220BDA71D5F58A53E896</code> <code>9C1EA3C9DE4834BA5750AC194059B541</code> <code>4165B2A685E6F3E34EBB15CFAEE351A3</code> <code>D5D77221DB2BB24DA0418E31FE2EF6FA</code> <code>C1A678CDBB37D88F21DEBE29F1073422</code><br> <code>7D5AF79E</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F4 0C 94 F8 19 C4 68
0010 | 78 02 00 00 5C 07 E8 D0 E7 E1 F9 E4 F1 4E EC 16
0020 | 08 C9 D9 97 FD 2F C7 46 24 6C 42 20 BC 4A E4 15
0030 | D0 3C C9 59 10 BA A3 C0 FE 50 02 00 D0 08 D7 AC
0040 | 3E 75 96 67 B1 75 EA FB C8 F5 52 6D 53 7D 90 D7
0050 | F2 9A 39 54 B8 E5 DB 6A FB 37 C5 2A EB 7E 97 9C
0060 | DB 2E 06 2F E3 EF A1 FA 41 4C 4D 36 97 42 0E 5A
0070 | 17 F5 26 80 4B 91 6D 18 81 F7 D8 73 57 DC 1A 1E
0080 | 94 41 36 EF 87 A0 F6 47 70 23 42 B2 D4 F9 6B 11
0090 | 08 D0 49 E1 EB 89 63 BA C0 43 A0 D2 3A FF CD 49
00A0 | 77 7D E9 32 C5 2C 25 B2 8E 4D CA 84 F7 BC C5 8E
00B0 | 17 90 6E 51 17 36 E5 45 AF 81 51 5B 3E D7 56 C6
00C0 | F2 59 98 29 6E C1 86 1A 3E D2 D3 5B BC E5 A2 8F
00D0 | FD 2C 5A C9 7F 18 A5 B3 33 EB 0B 2B 3F 02 42 2C
00E0 | 97 AF F7 7B 9F D4 86 67 9B 7C 25 E7 8F 00 FC C4
00F0 | 33 90 9C 75 73 BC CE C5 6E 1F 73 F2 E8 A3 B8 7E
0100 | 03 A9 DF AB CF B7 22 C8 F2 03 21 34 CB 43 98 7C
0110 | EC C9 F0 CC 0E 9B D1 12 64 BA 56 50 FA 83 4D 1A
0120 | F1 1E 19 E9 C2 D0 85 3B F1 51 6B E2 5E 95 D1 9E
0130 | 27 E7 95 13 63 1A 38 32 E9 EC 95 7B 99 92 AA 69
0140 | BF 4D 7F 8C 1C 49 7E C4 C2 27 D4 9B D1 A9 8E 39
0150 | C1 AD 3F A8 CA 7C E3 3D 15 9D 72 D4 D7 D1 2C 43
0160 | E3 71 44 FB 72 0A A3 72 B8 04 0B 16 64 83 EA A6
0170 | 33 A3 39 56 FE BA B6 7F 9B 8F F9 0D 2A 8D 5B 90
0180 | 88 AC D6 42 43 3F B9 9A 3D 6C 90 A7 F5 A6 4E 6D
0190 | 88 EF AC B8 D3 89 E3 52 56 B2 FB BD 2D A6 D8 D1
01A0 | C9 36 AA F9 6F F4 41 60 02 1D 08 7F 75 3A 61 42
01B0 | 97 DC 1F 74 07 65 C6 FB 5C EF C2 98 88 63 D8 94
01C0 | FE F4 E8 77 72 FC D3 70 9E 5E 6D 12 97 AB B6 64
01D0 | 4D 92 22 A6 5D 19 9D D1 CB C6 BE DC 50 BC E8 33
01E0 | BC 4B E4 DB E1 F9 6D B1 D4 65 55 EC F5 98 13 4A
01F0 | AB 49 11 76 A7 B4 6F 20 06 12 1F 1D 0B C5 07 0D
0200 | FF 2C 0D 75 50 A4 43 29 59 05 16 26 EA 09 F5 5A
0210 | AE 10 97 20 A2 74 1F F8 44 81 34 B4 F1 54 54 BF
0220 | 69 FA C6 71 70 FF AA 16 50 65 FF 7C 90 8D 70 46
0230 | DA 84 81 6A 81 E9 29 8B DE 15 6A 56 87 44 D6 3A
0240 | FA DD 2F 78 FE AF 85 D7 A5 DA C4 48 06 7C A5 1F
0250 | 08 91 9F 57 FF F4 78 0B 8D 0F FC 2B 2D CC D8 72
0260 | D9 53 6E 4E F2 C2 2F 93 F2 80 D8 04 C0 E5 BA 1D
0270 | 99 8B 5F A7 FB D7 C2 86 4E C3 0F D2 41 97 11 F6
0280 | 96 93 24 45 07 6B 36 B9 4E 6D 68 9B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F40C94F819C468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200D008D7AC3E759667B175EAFB</code> <code>C8F5526D537D90D7F29A3954B8E5DB6A</code> <code>FB37C52AEB7E979CDB2E062FE3EFA1FA</code> <code>414C4D3697420E5A17F526804B916D18</code> <code>81F7D87357DC1A1E944136EF87A0F647</code> <code>702342B2D4F96B1108D049E1EB8963BA</code> <code>C043A0D23AFFCD49777DE932C52C25B2</code> <code>8E4DCA84F7BCC58E17906E511736E545</code> <code>AF81515B3ED756C6F25998296EC1861A</code> <code>3ED2D35BBCE5A28FFD2C5AC97F18A5B3</code> <code>33EB0B2B3F02422C97AFF77B9FD48667</code> <code>9B7C25E78F00FCC433909C7573BCCEC5</code> <code>6E1F73F2E8A3B87E03A9DFABCFB722C8</code> <code>F2032134CB43987CECC9F0CC0E9BD112</code> <code>64BA5650FA834D1AF11E19E9C2D0853B</code> <code>F1516BE25E95D19E27E79513631A3832</code> <code>E9EC957B9992AA69BF4D7F8C1C497EC4</code> <code>C227D49BD1A98E39C1AD3FA8CA7CE33D</code> <code>159D72D4D7D12C43E37144FB720AA372</code> <code>B8040B166483EAA633A33956FEBAB67F</code> <code>9B8FF90D2A8D5B9088ACD642433FB99A</code> <code>3D6C90A7F5A64E6D88EFACB8D389E352</code> <code>56B2FBBD2DA6D8D1C936AAF96FF44160</code> <code>021D087F753A614297DC1F740765C6FB</code> <code>5CEFC2988863D894FEF4E87772FCD370</code> <code>9E5E6D1297ABB6644D9222A65D199DD1</code> <code>CBC6BEDC50BCE833BC4BE4DBE1F96DB1</code> <code>D46555ECF598134AAB491176A7B46F20</code> <code>06121F1D0BC5070DFF2C0D7550A44329</code> <code>59051626EA09F55AAE109720A2741FF8</code> <code>448134B4F15454BF69FAC67170FFAA16</code> <code>5065FF7C908D7046DA84816A81E9298B</code> <code>DE156A568744D63AFADD2F78FEAF85D7</code> <code>A5DAC448067CA51F08919F57FFF4780B</code> <code>8D0FFC2B2DCCD872D9536E4EF2C22F93</code> <code>F280D804C0E5BA1D998B5FA7FBD7C286</code> <code>4EC30FD2419711F696932445076B36B9</code><br> <code>4E6D689B</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = D008D7AC3E759667B175EAFBC8F5526D537D90D7F29A3954B8E5DB6AFB37C52AEB7E979CDB2E062FE3EFA1FA414C4D3697420E5A17F526804B916D1881F7D87357DC1A1E944136EF87A0F647702342B2D4F96B1108D049E1EB8963BAC043A0D23AFFCD49777DE932C52C25B28E4DCA84F7BCC58E17906E511736E545AF81515B3ED756C6F25998296EC1861A3ED2D35BBCE5A28FFD2C5AC97F18A5B333EB0B2B3F02422C97AFF77B9FD486679B7C25E78F00FCC433909C7573BCCEC56E1F73F2E8A3B87E03A9DFABCFB722C8F2032134CB43987CECC9F0CC0E9BD11264BA5650FA834D1AF11E19E9C2D0853BF1516BE25E95D19E27E79513631A3832E9EC957B9992AA69BF4D7F8C1C497EC4C227D49BD1A98E39C1AD3FA8CA7CE33D159D72D4D7D12C43E37144FB720AA372B8040B166483EAA633A33956FEBAB67F9B8FF90D2A8D5B9088ACD642433FB99A3D6C90A7F5A64E6D88EFACB8D389E35256B2FBBD2DA6D8D1C936AAF96FF44160021D087F753A614297DC1F740765C6FB5CEFC2988863D894FEF4E87772FCD3709E5E6D1297ABB6644D9222A65D199DD1CBC6BEDC50BCE833BC4BE4DBE1F96DB1D46555ECF598134AAB491176A7B46F2006121F1D0BC5070DFF2C0D7550A4432959051626EA09F55AAE109720A2741FF8448134B4F15454BF69FAC67170FFAA165065FF7C908D7046DA84816A81E9298BDE156A568744D63AFADD2F78FEAF85D7A5DAC448067CA51F08919F57FFF4780B8D0FFC2B2DCCD872D9536E4EF2C22F93F280D804C0E5BA1D998B5FA7FBD7C2864EC30FD2419711F696932445076B36B94E6D689B
tmp_aes_key = 20CAEC160FBC933EC17415090F3D2072AFF2CB6EB901B3933326F7C79FA294E3
tmp_aes_iv = 980C4CFDABB2ED1C3395876AE83F11BDC3FC35E57B6E7FBE04D88162715A4ECB</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = DB7433E57D993AF7A8E8C1BD147DB33DAAA5DC88BA0D89B5E7E1F9E4F14EEC1608C9D997FD2FC746246C4220BC4AE415D03CC95910BAA3C003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009BCF5601C4249AA20AE62D7FD58B3A3D648A14489A2E33F70DAE898AAC1C9175EDD71CEC4EB705F64BB2C2DF86B6BE12D3F8A4BD97F87DAA0DFC8431D754D5CE85467B0E63502F386C1CEB80593F954E562E301DD22E29B86E7BE1DC7E50BF0D46C4AACC84CD5AB7B3C488B9D5A5D029247E1301BA77653BBA8C38CCC29AB60505A034F42D9807AA27DDE2B668DFA86D6B7320A909EC8C5768EF26485E1B103C9E761404D972A65F3595ECF91D9A0E67DAC13F0D74B1BD5C64F4A9F8B40F5B6E45E517471A985389F86C250E481E8DE9E736E88E98F6D0DB39B06D71FBCAFAE5CE0C0C9BB9670E55CE8A88478D0B9E666739BE8BDD87AC9AEEE830BCFE7B4F13F819C46871679C423A933D1C
answer = BA0D89B5E7E1F9E4F14EEC1608C9D997FD2FC746246C4220BC4AE415D03CC95910BAA3C003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009BCF5601C4249AA20AE62D7FD58B3A3D648A14489A2E33F70DAE898AAC1C9175EDD71CEC4EB705F64BB2C2DF86B6BE12D3F8A4BD97F87DAA0DFC8431D754D5CE85467B0E63502F386C1CEB80593F954E562E301DD22E29B86E7BE1DC7E50BF0D46C4AACC84CD5AB7B3C488B9D5A5D029247E1301BA77653BBA8C38CCC29AB60505A034F42D9807AA27DDE2B668DFA86D6B7320A909EC8C5768EF26485E1B103C9E761404D972A65F3595ECF91D9A0E67DAC13F0D74B1BD5C64F4A9F8B40F5B6E45E517471A985389F86C250E481E8DE9E736E88E98F6D0DB39B06D71FBCAFAE5CE0C0C9BB9670E55CE8A88478D0B9E666739BE8BDD87AC9AEEE830BCFE7B4F13F819C46871679C423A933D1C</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E7 E1 F9 E4 F1 4E EC 16 08 C9 D9 97
0010 | FD 2F C7 46 24 6C 42 20 BC 4A E4 15 D0 3C C9 59
0020 | 10 BA A3 C0 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 9B CF 56 01 C4 24 9A A2 0A E6 2D 7F D5 8B 3A 3D
0140 | 64 8A 14 48 9A 2E 33 F7 0D AE 89 8A AC 1C 91 75
0150 | ED D7 1C EC 4E B7 05 F6 4B B2 C2 DF 86 B6 BE 12
0160 | D3 F8 A4 BD 97 F8 7D AA 0D FC 84 31 D7 54 D5 CE
0170 | 85 46 7B 0E 63 50 2F 38 6C 1C EB 80 59 3F 95 4E
0180 | 56 2E 30 1D D2 2E 29 B8 6E 7B E1 DC 7E 50 BF 0D
0190 | 46 C4 AA CC 84 CD 5A B7 B3 C4 88 B9 D5 A5 D0 29
01A0 | 24 7E 13 01 BA 77 65 3B BA 8C 38 CC C2 9A B6 05
01B0 | 05 A0 34 F4 2D 98 07 AA 27 DD E2 B6 68 DF A8 6D
01C0 | 6B 73 20 A9 09 EC 8C 57 68 EF 26 48 5E 1B 10 3C
01D0 | 9E 76 14 04 D9 72 A6 5F 35 95 EC F9 1D 9A 0E 67
01E0 | DA C1 3F 0D 74 B1 BD 5C 64 F4 A9 F8 B4 0F 5B 6E
01F0 | 45 E5 17 47 1A 98 53 89 F8 6C 25 0E 48 1E 8D E9
0200 | E7 36 E8 8E 98 F6 D0 DB 39 B0 6D 71 FB CA FA E5
0210 | CE 0C 0C 9B B9 67 0E 55 CE 8A 88 47 8D 0B 9E 66
0220 | 67 39 BE 8B DD 87 AC 9A EE E8 30 BC FE 7B 4F 13
0230 | F8 19 C4 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001009BCF5601C4249AA20AE62D7F</code> <code>D58B3A3D648A14489A2E33F70DAE898A</code> <code>AC1C9175EDD71CEC4EB705F64BB2C2DF</code> <code>86B6BE12D3F8A4BD97F87DAA0DFC8431</code> <code>D754D5CE85467B0E63502F386C1CEB80</code> <code>593F954E562E301DD22E29B86E7BE1DC</code> <code>7E50BF0D46C4AACC84CD5AB7B3C488B9</code> <code>D5A5D029247E1301BA77653BBA8C38CC</code> <code>C29AB60505A034F42D9807AA27DDE2B6</code> <code>68DFA86D6B7320A909EC8C5768EF2648</code> <code>5E1B103C9E761404D972A65F3595ECF9</code> <code>1D9A0E67DAC13F0D74B1BD5C64F4A9F8</code> <code>B40F5B6E45E517471A985389F86C250E</code> <code>481E8DE9E736E88E98F6D0DB39B06D71</code> <code>FBCAFAE5CE0C0C9BB9670E55CE8A8847</code> <code>8D0B9E666739BE8BDD87AC9AEEE830BC</code><br> <code>FE7B4F13</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>F819C468</code> (1757682168 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 1FBECAE560A63179A761A725510EF5A9BF890035E39A300428A0D407596750AAEAC21DA2525B649F20CDE10B24036B09E63D81D369678E82CFD8096531E44CE4677B077DD87FC29B866B58BFB31E70D5B1078633CA35B076A4FE0FCE24DC324835D4178DA572AAF3F3B49A22894CC690B05C69E845D48F3681F1245EC06AB86215B34EA6CC150F7846B756757864931EDF9402DAB477B6D1FE2B0C01DEC731F847D677FCA9DB4D31B451C10B94121D55B879DB648A8D676714A02184DE2F4659394CD07EAFDA8F0D542240894C18AABF229EAB97E335A73332F4D77FC892C87EB4DE4487046140857EB6E24E69D1B36DB41CCCCB1721143283D4BE5E2645404B</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 24EFE882758F437D8AF46914984B232C99401D633D656A1D35E173F6ED0F3E75C2CE78A492A974C3E507FE3B949F2F16D39B49BC8C2DBA5023CE2830082C6F6951D5F3086F93B5A0A9B857D5C51786D54E570DE721CF30B783C16C737D8C9F1D6ACFF699DC7CA74A9E22C136143B7E275492B014F29C67F5CF15B3B040515DB13494955E508DE6188F34F0D0D3A0359CEC8B8576601CCC9494BF2D187ABD242CAADE66925E8976E33DB8ED99910820C9E40784109EFCD42EA383B297F775FC24A9D5D3B16A05BDABB93C8F8843F627DB93A5C4281BA200301383DF0DB240DD89BF3CC4897351E5D0562005B8660777A3D7D3AAC38CE15AB3C368EA718C11E032</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E7 E1 F9 E4 F1 4E EC 16 08 C9 D9 97
0010 | FD 2F C7 46 24 6C 42 20 BC 4A E4 15 D0 3C C9 59
0020 | 10 BA A3 C0 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 24 EF E8 82 75 8F 43 7D 8A F4 69 14 98 4B 23 2C
0040 | 99 40 1D 63 3D 65 6A 1D 35 E1 73 F6 ED 0F 3E 75
0050 | C2 CE 78 A4 92 A9 74 C3 E5 07 FE 3B 94 9F 2F 16
0060 | D3 9B 49 BC 8C 2D BA 50 23 CE 28 30 08 2C 6F 69
0070 | 51 D5 F3 08 6F 93 B5 A0 A9 B8 57 D5 C5 17 86 D5
0080 | 4E 57 0D E7 21 CF 30 B7 83 C1 6C 73 7D 8C 9F 1D
0090 | 6A CF F6 99 DC 7C A7 4A 9E 22 C1 36 14 3B 7E 27
00A0 | 54 92 B0 14 F2 9C 67 F5 CF 15 B3 B0 40 51 5D B1
00B0 | 34 94 95 5E 50 8D E6 18 8F 34 F0 D0 D3 A0 35 9C
00C0 | EC 8B 85 76 60 1C CC 94 94 BF 2D 18 7A BD 24 2C
00D0 | AA DE 66 92 5E 89 76 E3 3D B8 ED 99 91 08 20 C9
00E0 | E4 07 84 10 9E FC D4 2E A3 83 B2 97 F7 75 FC 24
00F0 | A9 D5 D3 B1 6A 05 BD AB B9 3C 8F 88 43 F6 27 DB
0100 | 93 A5 C4 28 1B A2 00 30 13 83 DF 0D B2 40 DD 89
0110 | BF 3C C4 89 73 51 E5 D0 56 20 05 B8 66 07 77 A3
0120 | D7 D3 AA C3 8C E1 5A B3 C3 68 EA 71 8C 11 E0 32</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010024EFE882758F437D8AF46914</code> <code>984B232C99401D633D656A1D35E173F6</code> <code>ED0F3E75C2CE78A492A974C3E507FE3B</code> <code>949F2F16D39B49BC8C2DBA5023CE2830</code> <code>082C6F6951D5F3086F93B5A0A9B857D5</code> <code>C51786D54E570DE721CF30B783C16C73</code> <code>7D8C9F1D6ACFF699DC7CA74A9E22C136</code> <code>143B7E275492B014F29C67F5CF15B3B0</code> <code>40515DB13494955E508DE6188F34F0D0</code> <code>D3A0359CEC8B8576601CCC9494BF2D18</code> <code>7ABD242CAADE66925E8976E33DB8ED99</code> <code>910820C9E40784109EFCD42EA383B297</code> <code>F775FC24A9D5D3B16A05BDABB93C8F88</code> <code>43F627DB93A5C4281BA200301383DF0D</code> <code>B240DD89BF3CC4897351E5D0562005B8</code> <code>660777A3D7D3AAC38CE15AB3C368EA71</code><br> <code>8C11E032</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E7E1F9E4F14EEC1608C9D997FD2FC746246C4220BC4AE415D03CC95910BAA3C00000000000000000FE00010024EFE882758F437D8AF46914984B232C99401D633D656A1D35E173F6ED0F3E75C2CE78A492A974C3E507FE3B949F2F16D39B49BC8C2DBA5023CE2830082C6F6951D5F3086F93B5A0A9B857D5C51786D54E570DE721CF30B783C16C737D8C9F1D6ACFF699DC7CA74A9E22C136143B7E275492B014F29C67F5CF15B3B040515DB13494955E508DE6188F34F0D0D3A0359CEC8B8576601CCC9494BF2D187ABD242CAADE66925E8976E33DB8ED99910820C9E40784109EFCD42EA383B297F775FC24A9D5D3B16A05BDABB93C8F8843F627DB93A5C4281BA200301383DF0DB240DD89BF3CC4897351E5D0562005B8660777A3D7D3AAC38CE15AB3C368EA718C11E032
padding = 7C579D8D64F7E9F067E3E2A0
tmp_aes_key = 20CAEC160FBC933EC17415090F3D2072AFF2CB6EB901B3933326F7C79FA294E3
tmp_aes_iv = 980C4CFDABB2ED1C3395876AE83F11BDC3FC35E57B6E7FBE04D88162715A4ECB</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 23D4C5F3C62822454A59BACC773B70E907212162E16A289616C7962CBE146296320B54473764ADDE87E7D9DB12645A92AA9E661C933F0D7FDB92471C568CB9DF8E15374A4D82FC5F050FE77ACDCA3627007962804EC5C08340AB698DA4E8EFAB080DD9E4DD4E7A5E7C31116F3C62ABF133A5323B79762D16C945790FFF7B1D8DFDAB09E9C1FB53A5C9F07C26D7478B762992AF0770EB0B49DA04E5A2A401BF3802A2EA5CB4B0CDE8E728E0926A4BF68EF8B126FEAF0A71AAF4A950C4E5D9724A193C4F71374DD77B2B9446F6E4748DC534C3FBF24F278B33508F8C607EA1013477BED6D644399C5F74675819B6261883D41DA6149357C654F52DBD4304829C1C423BD7FBDF7F9C9D3BF826FB2035575FE7A78133336BA37331B1BE17E1E001B62F896097C43B27802CDD46D713D62E703D99BAC2D3A5620F37AC5C04ED8233CBA732F5935772E33D0D45CDF47C351456</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC DA 09 00 F8 19 C4 68
0010 | 78 01 00 00 1F 5F 04 F5 E7 E1 F9 E4 F1 4E EC 16
0020 | 08 C9 D9 97 FD 2F C7 46 24 6C 42 20 BC 4A E4 15
0030 | D0 3C C9 59 10 BA A3 C0 FE 50 01 00 23 D4 C5 F3
0040 | C6 28 22 45 4A 59 BA CC 77 3B 70 E9 07 21 21 62
0050 | E1 6A 28 96 16 C7 96 2C BE 14 62 96 32 0B 54 47
0060 | 37 64 AD DE 87 E7 D9 DB 12 64 5A 92 AA 9E 66 1C
0070 | 93 3F 0D 7F DB 92 47 1C 56 8C B9 DF 8E 15 37 4A
0080 | 4D 82 FC 5F 05 0F E7 7A CD CA 36 27 00 79 62 80
0090 | 4E C5 C0 83 40 AB 69 8D A4 E8 EF AB 08 0D D9 E4
00A0 | DD 4E 7A 5E 7C 31 11 6F 3C 62 AB F1 33 A5 32 3B
00B0 | 79 76 2D 16 C9 45 79 0F FF 7B 1D 8D FD AB 09 E9
00C0 | C1 FB 53 A5 C9 F0 7C 26 D7 47 8B 76 29 92 AF 07
00D0 | 70 EB 0B 49 DA 04 E5 A2 A4 01 BF 38 02 A2 EA 5C
00E0 | B4 B0 CD E8 E7 28 E0 92 6A 4B F6 8E F8 B1 26 FE
00F0 | AF 0A 71 AA F4 A9 50 C4 E5 D9 72 4A 19 3C 4F 71
0100 | 37 4D D7 7B 2B 94 46 F6 E4 74 8D C5 34 C3 FB F2
0110 | 4F 27 8B 33 50 8F 8C 60 7E A1 01 34 77 BE D6 D6
0120 | 44 39 9C 5F 74 67 58 19 B6 26 18 83 D4 1D A6 14
0130 | 93 57 C6 54 F5 2D BD 43 04 82 9C 1C 42 3B D7 FB
0140 | DF 7F 9C 9D 3B F8 26 FB 20 35 57 5F E7 A7 81 33
0150 | 33 6B A3 73 31 B1 BE 17 E1 E0 01 B6 2F 89 60 97
0160 | C4 3B 27 80 2C DD 46 D7 13 D6 2E 70 3D 99 BA C2
0170 | D3 A5 62 0F 37 AC 5C 04 ED 82 33 CB A7 32 F5 93
0180 | 57 72 E3 3D 0D 45 CD F4 7C 35 14 56</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>ECDA0900F819C468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010023D4C5F3C62822454A59BACC</code> <code>773B70E907212162E16A289616C7962C</code> <code>BE146296320B54473764ADDE87E7D9DB</code> <code>12645A92AA9E661C933F0D7FDB92471C</code> <code>568CB9DF8E15374A4D82FC5F050FE77A</code> <code>CDCA3627007962804EC5C08340AB698D</code> <code>A4E8EFAB080DD9E4DD4E7A5E7C31116F</code> <code>3C62ABF133A5323B79762D16C945790F</code> <code>FF7B1D8DFDAB09E9C1FB53A5C9F07C26</code> <code>D7478B762992AF0770EB0B49DA04E5A2</code> <code>A401BF3802A2EA5CB4B0CDE8E728E092</code> <code>6A4BF68EF8B126FEAF0A71AAF4A950C4</code> <code>E5D9724A193C4F71374DD77B2B9446F6</code> <code>E4748DC534C3FBF24F278B33508F8C60</code> <code>7EA1013477BED6D644399C5F74675819</code> <code>B6261883D41DA6149357C654F52DBD43</code> <code>04829C1C423BD7FBDF7F9C9D3BF826FB</code> <code>2035575FE7A78133336BA37331B1BE17</code> <code>E1E001B62F896097C43B27802CDD46D7</code> <code>13D62E703D99BAC2D3A5620F37AC5C04</code> <code>ED8233CBA732F5935772E33D0D45CDF4</code><br> <code>7C351456</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 6D4C57D012E9848BCED492145FC13E3CD5A5CA76B5DB468109C498414DC2F47649139F5F3C3126DC547E0B85B895F9E27509D6E3BBC037ADAF3DB80DC2BD147C1B96B38A98579C71182D0B01B4B2A22E1721D0F4EF3441786F4326F476485A135DDDBE34F93C8A11C6FB9B71D206A5FDA3B5DB001AAAC5236689E9973349A99020C95E2712EDB22B17ABE8B93A65C71CEA0CA6EF3D63FF85BAE441DC551D70BC9D0241EBF031F3576D42C4592ED32865A3B2ACB2E7A412D2BDDB24E17E1889713F6414DAF05A9B12690E11326C6D0FF2296890E50A7CF2E79D2E9AF3C41B374735F7B107825A2A859E68B43D7508A2D5EB2A28AE36A6C2D6E8A5A86489ACFA8B</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E4 DC 41 FA 19 C4 68
0010 | 34 00 00 00 34 F7 CB 3B E7 E1 F9 E4 F1 4E EC 16
0020 | 08 C9 D9 97 FD 2F C7 46 24 6C 42 20 BC 4A E4 15
0030 | D0 3C C9 59 10 BA A3 C0 4D BE 9D 09 5A 81 87 92
0040 | B6 17 5A DA 3F DB F4 86</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E4DC41FA19C468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E7E1F9E4F14EEC1608C9D997FD2FC746</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>246C4220BC4AE415D03CC95910BAA3C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4DBE9D095A818792B6175ADA3FDBF486</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

