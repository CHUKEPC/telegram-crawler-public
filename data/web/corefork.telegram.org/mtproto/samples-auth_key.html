<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 28 A6 0A 00 39 2D 84 66
0010 | 14 00 00 00 F1 8E 7E BE 1A 94 A9 17 FE BC 44 54
0020 | 8A E7 C4 3D 89 59 88 62</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>28A60A00392D8466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F8 D0 D3 39 2D 84 66
0010 | AC 00 00 00 63 24 16 05 1A 94 A9 17 FE BC 44 54
0020 | 8A E7 C4 3D 89 59 88 62 43 F0 01 27 70 6C 84 C2
0030 | D5 A5 4D 2F F3 BB 47 F9 08 23 1B 8A 9B F4 50 30
0040 | 61 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F8D0D3392D8466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>AC000000</code> (172 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08231B8A9BF4503061000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2529768018122125409</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2529768018122125409</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2529768018122125409 = 1309951991 * 1931191399</code></p>
<pre><code>p = 1309951991
q = 1931191399</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 23 1B 8A 9B F4 50 30 61 00 00 00
0010 | 04 4E 14 47 F7 00 00 00 04 73 1B A4 67 00 00 00
0020 | 1A 94 A9 17 FE BC 44 54 8A E7 C4 3D 89 59 88 62
0030 | 43 F0 01 27 70 6C 84 C2 D5 A5 4D 2F F3 BB 47 F9
0040 | 24 10 9E 24 CC 01 BA D5 6D 46 9C 89 21 0C 92 F6
0050 | 5B 41 FF D5 75 B2 E2 4C 07 50 CE C3 6A 2E D1 FF
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08231B8A9BF4503061000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2529768018122125409</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044E1447F7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1309951991</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04731BA467000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1931191399</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>24109E24CC01BAD56D469C89210C92F6</code> <code>5B41FFD575B2E24C0750CEC36A2ED1FF</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908231B8A9BF4503061000000044E1447F700000004731BA4670000001A94A917FEBC44548AE7C43D8959886243F00127706C84C2D5A54D2FF3BB47F924109E24CC01BAD56D469C89210C92F65B41FFD575B2E24C0750CEC36A2ED1FF02000000
random_padding_bytes = EB75C8EC89B1B09FBD2F085C17CBAC8B52ABCDC87D39C69A505DA6B761905C030CB6DF24A3A1E4779B10189B9347EFBC4F6E4C736409DC806D333DAEABF5D98CD2E7FD62779A8CDC70CEB823F5FCAFD619CFE92CFDC20A53D7CFBDCE</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = E4314C927C9FE8E26B5DB8BD33991DE57EF45E33AEC796366252DCA56BB52B3867B6927BD13442D82AE24F396AD5EE8CC7E13B27375BCA2A687434D0782B88C7B248594EF88B04C6D3EAAEF897B1F1CC768015593EA88157BCE78D18639CC64541C297CA67553C0751B6AA833F2A0619F058FCA0B53FA1ADC71D854F24F4AD12364887F3E113826788909864470E117B55F57C033B2F7037D87E860599654AFFA19B14EE009DF832D93D174E9668B687857373BCB22D12524C1C9245C9032DF1EFC89D7C919EE417D1764D2D248E1E8B4A4307E943669B24841F7AE9FD95621CF2DFE3CBEEECB585FF02B0583BD12920F056B778797D0231802D27D73E4FEA4E</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C4 EE 0B 00 3A 2D 84 66
0010 | 40 01 00 00 BE E4 12 D7 1A 94 A9 17 FE BC 44 54
0020 | 8A E7 C4 3D 89 59 88 62 43 F0 01 27 70 6C 84 C2
0030 | D5 A5 4D 2F F3 BB 47 F9 04 4E 14 47 F7 00 00 00
0040 | 04 73 1B A4 67 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 E4 31 4C 92 7C 9F E8 E2 6B 5D B8 BD
0060 | 33 99 1D E5 7E F4 5E 33 AE C7 96 36 62 52 DC A5
0070 | 6B B5 2B 38 67 B6 92 7B D1 34 42 D8 2A E2 4F 39
0080 | 6A D5 EE 8C C7 E1 3B 27 37 5B CA 2A 68 74 34 D0
0090 | 78 2B 88 C7 B2 48 59 4E F8 8B 04 C6 D3 EA AE F8
00A0 | 97 B1 F1 CC 76 80 15 59 3E A8 81 57 BC E7 8D 18
00B0 | 63 9C C6 45 41 C2 97 CA 67 55 3C 07 51 B6 AA 83
00C0 | 3F 2A 06 19 F0 58 FC A0 B5 3F A1 AD C7 1D 85 4F
00D0 | 24 F4 AD 12 36 48 87 F3 E1 13 82 67 88 90 98 64
00E0 | 47 0E 11 7B 55 F5 7C 03 3B 2F 70 37 D8 7E 86 05
00F0 | 99 65 4A FF A1 9B 14 EE 00 9D F8 32 D9 3D 17 4E
0100 | 96 68 B6 87 85 73 73 BC B2 2D 12 52 4C 1C 92 45
0110 | C9 03 2D F1 EF C8 9D 7C 91 9E E4 17 D1 76 4D 2D
0120 | 24 8E 1E 8B 4A 43 07 E9 43 66 9B 24 84 1F 7A E9
0130 | FD 95 62 1C F2 DF E3 CB EE EC B5 85 FF 02 B0 58
0140 | 3B D1 29 20 F0 56 B7 78 79 7D 02 31 80 2D 27 D7
0150 | 3E 4F EA 4E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C4EE0B003A2D8466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044E1447F7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1309951991</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04731BA467000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1931191399</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100E4314C927C9FE8E26B5DB8BD</code> <code>33991DE57EF45E33AEC796366252DCA5</code> <code>6BB52B3867B6927BD13442D82AE24F39</code> <code>6AD5EE8CC7E13B27375BCA2A687434D0</code> <code>782B88C7B248594EF88B04C6D3EAAEF8</code> <code>97B1F1CC768015593EA88157BCE78D18</code> <code>639CC64541C297CA67553C0751B6AA83</code> <code>3F2A0619F058FCA0B53FA1ADC71D854F</code> <code>24F4AD12364887F3E113826788909864</code> <code>470E117B55F57C033B2F7037D87E8605</code> <code>99654AFFA19B14EE009DF832D93D174E</code> <code>9668B687857373BCB22D12524C1C9245</code> <code>C9032DF1EFC89D7C919EE417D1764D2D</code> <code>248E1E8B4A4307E943669B24841F7AE9</code> <code>FD95621CF2DFE3CBEEECB585FF02B058</code> <code>3BD12920F056B778797D0231802D27D7</code><br> <code>3E4FEA4E</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 04 79 93 3A 2D 84 66
0010 | C8 02 00 00 5C 07 E8 D0 1A 94 A9 17 FE BC 44 54
0020 | 8A E7 C4 3D 89 59 88 62 43 F0 01 27 70 6C 84 C2
0030 | D5 A5 4D 2F F3 BB 47 F9 FE 50 02 00 9F 71 96 CC
0040 | 99 47 24 2B 88 D5 63 D4 73 59 25 5E A9 4B D7 6A
0050 | 39 86 8C CC 18 CA 61 31 93 F9 AE 1A 24 45 2A 51
0060 | 8E 16 6F ED 71 99 C7 96 BF 9F 87 6A 50 FD 02 A3
0070 | 18 1F 50 46 09 9D 5F E6 10 6A FB AC CB 27 F3 0F
0080 | 3D B7 05 6C D3 27 95 DE 32 49 1C 4C 91 E4 DE 5A
0090 | C9 D1 89 8E CC DA 48 14 8C E5 91 D7 81 61 E7 58
00A0 | 64 59 7A 07 E6 C6 88 57 8C 84 4E 40 FE 33 2C 5C
00B0 | 9B AE 43 85 80 0A E9 B8 59 5A AD 19 C5 2E 7F 1E
00C0 | 1F A1 2E C1 0F E8 D0 47 F8 39 C2 7D 88 36 29 47
00D0 | 63 96 45 F0 5D C1 67 7A BB 34 97 97 2E 82 45 49
00E0 | ED CB 4B 92 3B 00 67 FA 07 AF E4 74 BC B0 30 AE
00F0 | D0 F2 62 C9 03 FB B4 6F 9D BE F0 71 74 0B B2 16
0100 | 2B A1 C3 A1 CB CA BD 6D FC 61 03 ED 36 BA C2 30
0110 | 09 82 C6 54 07 E0 7F 38 EF 98 EC AA 94 A7 30 EA
0120 | 3A 31 61 5C F5 17 B8 C9 90 F0 86 B4 1B 6F 0C B4
0130 | 7A 7C 62 47 E3 EB AB 01 5C 7E F3 3E E4 C8 D6 FD
0140 | D4 42 F5 7F 55 BB 53 AC 3E 29 C0 31 C3 25 6E 03
0150 | 82 21 0E 5D A2 D6 1A 29 93 33 1F DC 5E E9 EB 1E
0160 | 55 21 09 AE 6D 25 5A 0E C8 47 5D 62 B4 20 57 B3
0170 | 21 7C 14 F1 C5 78 37 B2 95 A7 44 51 37 AF 56 12
0180 | 76 03 23 2F BA 95 CF 6B D4 60 36 FE F1 B8 F7 45
0190 | 38 BE CE 9A AC 28 7E 17 C8 47 B0 75 DC D7 41 D6
01A0 | 4A 82 34 A1 88 36 8D 67 2C 61 69 30 13 24 A9 A3
01B0 | B4 40 05 74 8E 50 51 34 6E 72 AE E2 1D 04 CD 64
01C0 | DD EB 50 A0 7A 99 48 35 68 02 6D 17 44 DF 21 C5
01D0 | 1A BC 3F 12 F9 20 5A E2 65 C5 61 DA A3 96 A2 46
01E0 | 6D C8 B0 FB FF D2 49 F2 10 60 C2 E1 2E D0 64 C8
01F0 | 9B 63 0E F6 60 57 CA 1A 1E 01 26 7A 19 8A 74 CE
0200 | B6 22 96 F1 A7 8C C5 CC 8F A0 E0 A3 45 C8 E0 86
0210 | 43 F6 2C 46 EC A8 14 3C 40 7F 31 3E 28 A0 8B 96
0220 | 79 11 B6 A4 72 47 8C F1 A9 D2 28 2F BB E2 91 CB
0230 | A8 E9 72 5D 01 0F 52 69 B3 42 F6 82 98 9F D5 3A
0240 | F8 0F D9 B0 4E F7 4C 54 7F 2B 0B 26 A3 6D C1 98
0250 | 99 E6 61 C3 51 FB 53 2E 23 A0 BE DB 3E 30 8B 82
0260 | EF 16 FF 39 56 63 86 8E 94 28 4C AF 55 E7 72 4F
0270 | BC 2A AB 12 91 C8 10 82 F4 C7 35 C8 23 F3 56 47
0280 | 11 EB 65 3E 57 88 9A AF 9A 41 B3 02</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>010479933A2D8466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C8020000</code> (712 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002009F7196CC9947242B88D563D4</code> <code>7359255EA94BD76A39868CCC18CA6131</code> <code>93F9AE1A24452A518E166FED7199C796</code> <code>BF9F876A50FD02A3181F5046099D5FE6</code> <code>106AFBACCB27F30F3DB7056CD32795DE</code> <code>32491C4C91E4DE5AC9D1898ECCDA4814</code> <code>8CE591D78161E75864597A07E6C68857</code> <code>8C844E40FE332C5C9BAE4385800AE9B8</code> <code>595AAD19C52E7F1E1FA12EC10FE8D047</code> <code>F839C27D88362947639645F05DC1677A</code> <code>BB3497972E824549EDCB4B923B0067FA</code> <code>07AFE474BCB030AED0F262C903FBB46F</code> <code>9DBEF071740BB2162BA1C3A1CBCABD6D</code> <code>FC6103ED36BAC2300982C65407E07F38</code> <code>EF98ECAA94A730EA3A31615CF517B8C9</code> <code>90F086B41B6F0CB47A7C6247E3EBAB01</code> <code>5C7EF33EE4C8D6FDD442F57F55BB53AC</code> <code>3E29C031C3256E0382210E5DA2D61A29</code> <code>93331FDC5EE9EB1E552109AE6D255A0E</code> <code>C8475D62B42057B3217C14F1C57837B2</code> <code>95A7445137AF56127603232FBA95CF6B</code> <code>D46036FEF1B8F74538BECE9AAC287E17</code> <code>C847B075DCD741D64A8234A188368D67</code> <code>2C6169301324A9A3B44005748E505134</code> <code>6E72AEE21D04CD64DDEB50A07A994835</code> <code>68026D1744DF21C51ABC3F12F9205AE2</code> <code>65C561DAA396A2466DC8B0FBFFD249F2</code> <code>1060C2E12ED064C89B630EF66057CA1A</code> <code>1E01267A198A74CEB62296F1A78CC5CC</code> <code>8FA0E0A345C8E08643F62C46ECA8143C</code> <code>407F313E28A08B967911B6A472478CF1</code> <code>A9D2282FBBE291CBA8E9725D010F5269</code> <code>B342F682989FD53AF80FD9B04EF74C54</code> <code>7F2B0B26A36DC19899E661C351FB532E</code> <code>23A0BEDB3E308B82EF16FF395663868E</code> <code>94284CAF55E7724FBC2AAB1291C81082</code> <code>F4C735C823F3564711EB653E57889AAF</code><br> <code>9A41B302</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 9F7196CC9947242B88D563D47359255EA94BD76A39868CCC18CA613193F9AE1A24452A518E166FED7199C796BF9F876A50FD02A3181F5046099D5FE6106AFBACCB27F30F3DB7056CD32795DE32491C4C91E4DE5AC9D1898ECCDA48148CE591D78161E75864597A07E6C688578C844E40FE332C5C9BAE4385800AE9B8595AAD19C52E7F1E1FA12EC10FE8D047F839C27D88362947639645F05DC1677ABB3497972E824549EDCB4B923B0067FA07AFE474BCB030AED0F262C903FBB46F9DBEF071740BB2162BA1C3A1CBCABD6DFC6103ED36BAC2300982C65407E07F38EF98ECAA94A730EA3A31615CF517B8C990F086B41B6F0CB47A7C6247E3EBAB015C7EF33EE4C8D6FDD442F57F55BB53AC3E29C031C3256E0382210E5DA2D61A2993331FDC5EE9EB1E552109AE6D255A0EC8475D62B42057B3217C14F1C57837B295A7445137AF56127603232FBA95CF6BD46036FEF1B8F74538BECE9AAC287E17C847B075DCD741D64A8234A188368D672C6169301324A9A3B44005748E5051346E72AEE21D04CD64DDEB50A07A99483568026D1744DF21C51ABC3F12F9205AE265C561DAA396A2466DC8B0FBFFD249F21060C2E12ED064C89B630EF66057CA1A1E01267A198A74CEB62296F1A78CC5CC8FA0E0A345C8E08643F62C46ECA8143C407F313E28A08B967911B6A472478CF1A9D2282FBBE291CBA8E9725D010F5269B342F682989FD53AF80FD9B04EF74C547F2B0B26A36DC19899E661C351FB532E23A0BEDB3E308B82EF16FF395663868E94284CAF55E7724FBC2AAB1291C81082F4C735C823F3564711EB653E57889AAF9A41B302
tmp_aes_key = 7DA5236D64FC809C96A324DBD616FB2BD5EBFFC083EABEC2415AE73F9B3EF9A4
tmp_aes_iv = A8E1F607C11E6CAEB30BBDE6BC938A9A7755FA364D555B86DEFBB4FE24109E24</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = E7AC77ACCFDC82ACC3A81FCB9FC21975056BA4EBBA0D89B51A94A917FEBC44548AE7C43D8959886243F00127706C84C2D5A54D2FF3BB47F903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100A2597E432B73B4A3E13B8A814F27102C5ABE4AA8F4718DFC2D7E18DAA6896B0D9FAB2B044BC2F8DA7EFFC108DF28F7F4AF1420637E89482EF240D4D4C2EB7F2DD3BD05BEA485AD6AB942E5B6DEFF63897B4056305422B8F5BCD55FC1676E6A6FC033F8A9538F910351ED3432F2C6515A659AB26F9BBF3672C38C6B910D9CE00F501491BA029C15F95C9E84348EE386B788F104F6BB25F74DAA6CDE5FA7D49FCB656B9E921B84834C6A45AA9CF1C35A3C3C5A3093F80FD736711834D960C3207C7C87999AA4691F112A62F832FA57A9AAF43C2F8AACC7CC34A12E6EA88C30ECA08BA730D9C3E59E121892FE3B6B40F999304B5A8E27A0C0690F5F47DCD9D768913A2D84665A4105EA72EFC5EF
answer = BA0D89B51A94A917FEBC44548AE7C43D8959886243F00127706C84C2D5A54D2FF3BB47F903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100A2597E432B73B4A3E13B8A814F27102C5ABE4AA8F4718DFC2D7E18DAA6896B0D9FAB2B044BC2F8DA7EFFC108DF28F7F4AF1420637E89482EF240D4D4C2EB7F2DD3BD05BEA485AD6AB942E5B6DEFF63897B4056305422B8F5BCD55FC1676E6A6FC033F8A9538F910351ED3432F2C6515A659AB26F9BBF3672C38C6B910D9CE00F501491BA029C15F95C9E84348EE386B788F104F6BB25F74DAA6CDE5FA7D49FCB656B9E921B84834C6A45AA9CF1C35A3C3C5A3093F80FD736711834D960C3207C7C87999AA4691F112A62F832FA57A9AAF43C2F8AACC7CC34A12E6EA88C30ECA08BA730D9C3E59E121892FE3B6B40F999304B5A8E27A0C0690F5F47DCD9D768913A2D84665A4105EA72EFC5EF</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 1A 94 A9 17 FE BC 44 54 8A E7 C4 3D
0010 | 89 59 88 62 43 F0 01 27 70 6C 84 C2 D5 A5 4D 2F
0020 | F3 BB 47 F9 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | A2 59 7E 43 2B 73 B4 A3 E1 3B 8A 81 4F 27 10 2C
0140 | 5A BE 4A A8 F4 71 8D FC 2D 7E 18 DA A6 89 6B 0D
0150 | 9F AB 2B 04 4B C2 F8 DA 7E FF C1 08 DF 28 F7 F4
0160 | AF 14 20 63 7E 89 48 2E F2 40 D4 D4 C2 EB 7F 2D
0170 | D3 BD 05 BE A4 85 AD 6A B9 42 E5 B6 DE FF 63 89
0180 | 7B 40 56 30 54 22 B8 F5 BC D5 5F C1 67 6E 6A 6F
0190 | C0 33 F8 A9 53 8F 91 03 51 ED 34 32 F2 C6 51 5A
01A0 | 65 9A B2 6F 9B BF 36 72 C3 8C 6B 91 0D 9C E0 0F
01B0 | 50 14 91 BA 02 9C 15 F9 5C 9E 84 34 8E E3 86 B7
01C0 | 88 F1 04 F6 BB 25 F7 4D AA 6C DE 5F A7 D4 9F CB
01D0 | 65 6B 9E 92 1B 84 83 4C 6A 45 AA 9C F1 C3 5A 3C
01E0 | 3C 5A 30 93 F8 0F D7 36 71 18 34 D9 60 C3 20 7C
01F0 | 7C 87 99 9A A4 69 1F 11 2A 62 F8 32 FA 57 A9 AA
0200 | F4 3C 2F 8A AC C7 CC 34 A1 2E 6E A8 8C 30 EC A0
0210 | 8B A7 30 D9 C3 E5 9E 12 18 92 FE 3B 6B 40 F9 99
0220 | 30 4B 5A 8E 27 A0 C0 69 0F 5F 47 DC D9 D7 68 91
0230 | 3A 2D 84 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100A2597E432B73B4A3E13B8A81</code> <code>4F27102C5ABE4AA8F4718DFC2D7E18DA</code> <code>A6896B0D9FAB2B044BC2F8DA7EFFC108</code> <code>DF28F7F4AF1420637E89482EF240D4D4</code> <code>C2EB7F2DD3BD05BEA485AD6AB942E5B6</code> <code>DEFF63897B4056305422B8F5BCD55FC1</code> <code>676E6A6FC033F8A9538F910351ED3432</code> <code>F2C6515A659AB26F9BBF3672C38C6B91</code> <code>0D9CE00F501491BA029C15F95C9E8434</code> <code>8EE386B788F104F6BB25F74DAA6CDE5F</code> <code>A7D49FCB656B9E921B84834C6A45AA9C</code> <code>F1C35A3C3C5A3093F80FD736711834D9</code> <code>60C3207C7C87999AA4691F112A62F832</code> <code>FA57A9AAF43C2F8AACC7CC34A12E6EA8</code> <code>8C30ECA08BA730D9C3E59E121892FE3B</code> <code>6B40F999304B5A8E27A0C0690F5F47DC</code><br> <code>D9D76891</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>3A2D8466</code> (1719938362 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 7DC544D6B5C32ABEC8936F702B6E4D6C4458248958BE0089F1D291414048A473D369164ECCEB0F9B2B534BA9715CBCAA9B82E405CA177BF8881F0C87EECBA33DC996731703516C220067852E68518AD2A9EFE1BA1BA60FB7C2D4B42A3EBF26DA55F5ADF49AEE670E91A509EA2D46E8F71CACE8F8153D363943F9F0D6641B449B5E3419F9D3188DC4D4CF21C5240D417ACE861476CBAC4D4A0A22F08D0F07632EACD20AAB7C9570840ECCD9A36433573E7B5488FE4712076CFB3E85D3E59C0BA89E5CB61FE99656B74A613DC3B160AF55EF86371C372068815984A823116C92A431B0200F4A27471847D6BE99006EBF0F08A46DB382C9DEB4A54F6354051236AB</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 85E5D61553B37EE260427F6761ECBAB0825DDA15C55F56EEEA25A466A35350EFFAB4A7C94D6584B04E205E7E73D8D3B6C1485DF7A8794F34134E6D2330A1A6C6703B1BEABEA84CF906CBE81A14AD727220F47A103636911C26F53405D6C9B017C86413DBFEE8E0B77A3D5A7E487396A90837D39AB2E9F6D3CF93AC9E5A1AC4BB836636D3F7F4629A1BCA297D019FD15D5090807AB408D82DD86612AEEBCA3C4FC4E4C51D77FB2C674D614E92F773C239FA9B792B995DFBA3D0F86713F1BCA9532D964AFBBA3282DF95E39BB68D149398100CD79330046161990E46453618840947E6D304BA138461C9398028049CF3C81374B89C540A48AE97F07EE8419CA1AA</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 1A 94 A9 17 FE BC 44 54 8A E7 C4 3D
0010 | 89 59 88 62 43 F0 01 27 70 6C 84 C2 D5 A5 4D 2F
0020 | F3 BB 47 F9 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 85 E5 D6 15 53 B3 7E E2 60 42 7F 67 61 EC BA B0
0040 | 82 5D DA 15 C5 5F 56 EE EA 25 A4 66 A3 53 50 EF
0050 | FA B4 A7 C9 4D 65 84 B0 4E 20 5E 7E 73 D8 D3 B6
0060 | C1 48 5D F7 A8 79 4F 34 13 4E 6D 23 30 A1 A6 C6
0070 | 70 3B 1B EA BE A8 4C F9 06 CB E8 1A 14 AD 72 72
0080 | 20 F4 7A 10 36 36 91 1C 26 F5 34 05 D6 C9 B0 17
0090 | C8 64 13 DB FE E8 E0 B7 7A 3D 5A 7E 48 73 96 A9
00A0 | 08 37 D3 9A B2 E9 F6 D3 CF 93 AC 9E 5A 1A C4 BB
00B0 | 83 66 36 D3 F7 F4 62 9A 1B CA 29 7D 01 9F D1 5D
00C0 | 50 90 80 7A B4 08 D8 2D D8 66 12 AE EB CA 3C 4F
00D0 | C4 E4 C5 1D 77 FB 2C 67 4D 61 4E 92 F7 73 C2 39
00E0 | FA 9B 79 2B 99 5D FB A3 D0 F8 67 13 F1 BC A9 53
00F0 | 2D 96 4A FB BA 32 82 DF 95 E3 9B B6 8D 14 93 98
0100 | 10 0C D7 93 30 04 61 61 99 0E 46 45 36 18 84 09
0110 | 47 E6 D3 04 BA 13 84 61 C9 39 80 28 04 9C F3 C8
0120 | 13 74 B8 9C 54 0A 48 AE 97 F0 7E E8 41 9C A1 AA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010085E5D61553B37EE260427F67</code> <code>61ECBAB0825DDA15C55F56EEEA25A466</code> <code>A35350EFFAB4A7C94D6584B04E205E7E</code> <code>73D8D3B6C1485DF7A8794F34134E6D23</code> <code>30A1A6C6703B1BEABEA84CF906CBE81A</code> <code>14AD727220F47A103636911C26F53405</code> <code>D6C9B017C86413DBFEE8E0B77A3D5A7E</code> <code>487396A90837D39AB2E9F6D3CF93AC9E</code> <code>5A1AC4BB836636D3F7F4629A1BCA297D</code> <code>019FD15D5090807AB408D82DD86612AE</code> <code>EBCA3C4FC4E4C51D77FB2C674D614E92</code> <code>F773C239FA9B792B995DFBA3D0F86713</code> <code>F1BCA9532D964AFBBA3282DF95E39BB6</code> <code>8D149398100CD79330046161990E4645</code> <code>3618840947E6D304BA138461C9398028</code> <code>049CF3C81374B89C540A48AE97F07EE8</code><br> <code>419CA1AA</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643661A94A917FEBC44548AE7C43D8959886243F00127706C84C2D5A54D2FF3BB47F90000000000000000FE00010085E5D61553B37EE260427F6761ECBAB0825DDA15C55F56EEEA25A466A35350EFFAB4A7C94D6584B04E205E7E73D8D3B6C1485DF7A8794F34134E6D2330A1A6C6703B1BEABEA84CF906CBE81A14AD727220F47A103636911C26F53405D6C9B017C86413DBFEE8E0B77A3D5A7E487396A90837D39AB2E9F6D3CF93AC9E5A1AC4BB836636D3F7F4629A1BCA297D019FD15D5090807AB408D82DD86612AEEBCA3C4FC4E4C51D77FB2C674D614E92F773C239FA9B792B995DFBA3D0F86713F1BCA9532D964AFBBA3282DF95E39BB68D149398100CD79330046161990E46453618840947E6D304BA138461C9398028049CF3C81374B89C540A48AE97F07EE8419CA1AA
padding = 23D9CED845AD58F83C312CDF
tmp_aes_key = 7DA5236D64FC809C96A324DBD616FB2BD5EBFFC083EABEC2415AE73F9B3EF9A4
tmp_aes_iv = A8E1F607C11E6CAEB30BBDE6BC938A9A7755FA364D555B86DEFBB4FE24109E24</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C37CEF5A60678B6CF63BF90D4CCE31176C464A1D496F03F9FB1551F4F8B8F59E7202647593C3F1AFA548D08F248BC4BA06DC7DFF7FD1433D5110076B805D0FD43D3DF5B7872BED15ECB100B6C17F85EF7293B23E7F734F581695D547561E94703F61E7E094817135D0A9772D7E9911B78B64556066EFC57E3A4E02975A9ADB468DCC8EB0D094E825CFFF1379EA57C89A195A3F4879BAA2E1EBAB38DE74D1B65D902CD6F0A0D03013D90D227DA51402304A1A2577D1D0EB48166C5C9382E2999261C3ACDFD1C04F470A043BDE07365D41381F81D514D5FC6AD77C816D09B8A3777C495938BF2ED70C63A818CC399D8BA47208FEA5668FD99ED42A7074E87D8A2DA48527F1D5746B44D46182656D353D0EC47B2F034ED1CEAC1E3E05D793098B878D95701A2A2432BBFDF5DAFD2C166DE39B6E9B19AD60B71CA47D66D5AD6712A9431A6AECA4880C82D937B869EE5DA26A</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 EE 0B 00 3A 2D 84 66
0010 | 78 01 00 00 1F 5F 04 F5 1A 94 A9 17 FE BC 44 54
0020 | 8A E7 C4 3D 89 59 88 62 43 F0 01 27 70 6C 84 C2
0030 | D5 A5 4D 2F F3 BB 47 F9 FE 50 01 00 C3 7C EF 5A
0040 | 60 67 8B 6C F6 3B F9 0D 4C CE 31 17 6C 46 4A 1D
0050 | 49 6F 03 F9 FB 15 51 F4 F8 B8 F5 9E 72 02 64 75
0060 | 93 C3 F1 AF A5 48 D0 8F 24 8B C4 BA 06 DC 7D FF
0070 | 7F D1 43 3D 51 10 07 6B 80 5D 0F D4 3D 3D F5 B7
0080 | 87 2B ED 15 EC B1 00 B6 C1 7F 85 EF 72 93 B2 3E
0090 | 7F 73 4F 58 16 95 D5 47 56 1E 94 70 3F 61 E7 E0
00A0 | 94 81 71 35 D0 A9 77 2D 7E 99 11 B7 8B 64 55 60
00B0 | 66 EF C5 7E 3A 4E 02 97 5A 9A DB 46 8D CC 8E B0
00C0 | D0 94 E8 25 CF FF 13 79 EA 57 C8 9A 19 5A 3F 48
00D0 | 79 BA A2 E1 EB AB 38 DE 74 D1 B6 5D 90 2C D6 F0
00E0 | A0 D0 30 13 D9 0D 22 7D A5 14 02 30 4A 1A 25 77
00F0 | D1 D0 EB 48 16 6C 5C 93 82 E2 99 92 61 C3 AC DF
0100 | D1 C0 4F 47 0A 04 3B DE 07 36 5D 41 38 1F 81 D5
0110 | 14 D5 FC 6A D7 7C 81 6D 09 B8 A3 77 7C 49 59 38
0120 | BF 2E D7 0C 63 A8 18 CC 39 9D 8B A4 72 08 FE A5
0130 | 66 8F D9 9E D4 2A 70 74 E8 7D 8A 2D A4 85 27 F1
0140 | D5 74 6B 44 D4 61 82 65 6D 35 3D 0E C4 7B 2F 03
0150 | 4E D1 CE AC 1E 3E 05 D7 93 09 8B 87 8D 95 70 1A
0160 | 2A 24 32 BB FD F5 DA FD 2C 16 6D E3 9B 6E 9B 19
0170 | AD 60 B7 1C A4 7D 66 D5 AD 67 12 A9 43 1A 6A EC
0180 | A4 88 0C 82 D9 37 B8 69 EE 5D A2 6A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C8EE0B003A2D8466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C37CEF5A60678B6CF63BF90D</code> <code>4CCE31176C464A1D496F03F9FB1551F4</code> <code>F8B8F59E7202647593C3F1AFA548D08F</code> <code>248BC4BA06DC7DFF7FD1433D5110076B</code> <code>805D0FD43D3DF5B7872BED15ECB100B6</code> <code>C17F85EF7293B23E7F734F581695D547</code> <code>561E94703F61E7E094817135D0A9772D</code> <code>7E9911B78B64556066EFC57E3A4E0297</code> <code>5A9ADB468DCC8EB0D094E825CFFF1379</code> <code>EA57C89A195A3F4879BAA2E1EBAB38DE</code> <code>74D1B65D902CD6F0A0D03013D90D227D</code> <code>A51402304A1A2577D1D0EB48166C5C93</code> <code>82E2999261C3ACDFD1C04F470A043BDE</code> <code>07365D41381F81D514D5FC6AD77C816D</code> <code>09B8A3777C495938BF2ED70C63A818CC</code> <code>399D8BA47208FEA5668FD99ED42A7074</code> <code>E87D8A2DA48527F1D5746B44D4618265</code> <code>6D353D0EC47B2F034ED1CEAC1E3E05D7</code> <code>93098B878D95701A2A2432BBFDF5DAFD</code> <code>2C166DE39B6E9B19AD60B71CA47D66D5</code> <code>AD6712A9431A6AECA4880C82D937B869</code><br> <code>EE5DA26A</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 3012C0DC69550576E606CEE1E158B0FD048BA9B8887F763EDE7E9F3EE723C4976AAA60265B790724E80447DB3717A7C4E54E36F41F0BC122F64E4A3E84F8F7CE43DE304DD8843B33AF5963A7A227C334A992EF20FA2D859D486685A9CCB2A0365B315319C4723441E47A592E0A6D61AD3C697FE1431B9AB28DD4FD247A812CF8F46C684B53C72237E8A8B27BBD101FBFE5693BF956396405A8AE2A480952F651755E5927076B61043172B49868E5F6DA563A3C6A0E160F2FDB6EB43740B30C8A609A8655CE11495D496651944A6E2712208945D781708C1A5CCE8ED36A2D67A19D459A2A9197DFE53ED00C121C849CE265A95584B25832948B86E5520BB39E01</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 5E E7 3B 2D 84 66
0010 | 54 00 00 00 34 F7 CB 3B 1A 94 A9 17 FE BC 44 54
0020 | 8A E7 C4 3D 89 59 88 62 43 F0 01 27 70 6C 84 C2
0030 | D5 A5 4D 2F F3 BB 47 F9 70 43 69 20 E2 CA 04 8F
0040 | 3B 30 63 BF 54 29 2E 89</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01985EE73B2D8466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1A94A917FEBC44548AE7C43D89598862</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>43F00127706C84C2D5A54D2FF3BB47F9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>70436920E2CA048F3B3063BF54292E89</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

