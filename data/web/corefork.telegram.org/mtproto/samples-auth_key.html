<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?245" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 FC B0 09 00 EE AB 83 68
0010 | 14 00 00 00 F1 8E 7E BE 63 97 F5 B5 E8 85 23 CA
0020 | CB 9B 7F 7C 5D 30 B3 61</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>FCB00900EEAB8368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 4C B3 72 EE AB 83 68
0010 | 50 00 00 00 63 24 16 05 63 97 F5 B5 E8 85 23 CA
0020 | CB 9B 7F 7C 5D 30 B3 61 E1 94 6E 88 C3 DF 05 61
0030 | E8 AE 10 5F 4A 81 DB C3 08 2C 46 1A 0A CE D8 21
0040 | 7B 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014CB372EEAB8368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082C461A0ACED8217B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3190266019760841083</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3190266019760841083</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3190266019760841083 = 1732144691 * 1841801113</code></p>
<pre><code>p = 1732144691
q = 1841801113</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2C 46 1A 0A CE D8 21 7B 00 00 00
0010 | 04 67 3E 6E 33 00 00 00 04 6D C7 A7 99 00 00 00
0020 | 63 97 F5 B5 E8 85 23 CA CB 9B 7F 7C 5D 30 B3 61
0030 | E1 94 6E 88 C3 DF 05 61 E8 AE 10 5F 4A 81 DB C3
0040 | ED 83 A3 54 2C 02 1D 93 42 B6 74 03 1A EF 02 4C
0050 | 2E 5A BE F5 B6 2C 42 9A 11 5D C8 83 E3 F6 11 36
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082C461A0ACED8217B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3190266019760841083</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04673E6E33000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1732144691</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046DC7A799000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1841801113</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>ED83A3542C021D9342B674031AEF024C</code> <code>2E5ABEF5B62C429A115DC883E3F61136</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082C461A0ACED8217B00000004673E6E33000000046DC7A7990000006397F5B5E88523CACB9B7F7C5D30B361E1946E88C3DF0561E8AE105F4A81DBC3ED83A3542C021D9342B674031AEF024C2E5ABEF5B62C429A115DC883E3F6113602000000
random_padding_bytes = 5552320C5527FC98D380183002DC15098CC71FBC698E8B40B89A54C4DDF646EEB92F6F95B3F634E0105BC95C498AF49FFF91A33408DBEC1651031E4454B747A870C7B6530FAA699C079639A193FFABD69CA1EE054876739F14E486BA</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 9689437E3076636D7E85CDA46AD7896E746DF3C8669A1CAA68DABE9101655E94E937466088ECF2034BECC7335B117865AA47153A23DD744B2C97917B664C9A001516A931BECCCA7ED9B2F832F0E809D2DFBDB39C308D1A5EE5D2530943125980A1B43834D6E67EC1DC2B9BB5255EE6984D32491ACF5C32A84ACD11165C61A9BA2080C4F1F37C43B5516B9B75B56148D7072B0B0D33E1EC055FEA4362D23DB3DB25298671D0C63686A7C66948C76B060C9C6B469A94427C3BA6E4408791BA61E9C4E90501EF372743EA9E7D5E949CC48113CC57FB8E86F14729EB0A2723293AD38BCB77922F0120092E0C25057BF6BE58CFD23EF6CF698613329DA95EDE472C5C</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 00 B1 09 00 EE AB 83 68
0010 | 40 01 00 00 BE E4 12 D7 63 97 F5 B5 E8 85 23 CA
0020 | CB 9B 7F 7C 5D 30 B3 61 E1 94 6E 88 C3 DF 05 61
0030 | E8 AE 10 5F 4A 81 DB C3 04 67 3E 6E 33 00 00 00
0040 | 04 6D C7 A7 99 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 96 89 43 7E 30 76 63 6D 7E 85 CD A4
0060 | 6A D7 89 6E 74 6D F3 C8 66 9A 1C AA 68 DA BE 91
0070 | 01 65 5E 94 E9 37 46 60 88 EC F2 03 4B EC C7 33
0080 | 5B 11 78 65 AA 47 15 3A 23 DD 74 4B 2C 97 91 7B
0090 | 66 4C 9A 00 15 16 A9 31 BE CC CA 7E D9 B2 F8 32
00A0 | F0 E8 09 D2 DF BD B3 9C 30 8D 1A 5E E5 D2 53 09
00B0 | 43 12 59 80 A1 B4 38 34 D6 E6 7E C1 DC 2B 9B B5
00C0 | 25 5E E6 98 4D 32 49 1A CF 5C 32 A8 4A CD 11 16
00D0 | 5C 61 A9 BA 20 80 C4 F1 F3 7C 43 B5 51 6B 9B 75
00E0 | B5 61 48 D7 07 2B 0B 0D 33 E1 EC 05 5F EA 43 62
00F0 | D2 3D B3 DB 25 29 86 71 D0 C6 36 86 A7 C6 69 48
0100 | C7 6B 06 0C 9C 6B 46 9A 94 42 7C 3B A6 E4 40 87
0110 | 91 BA 61 E9 C4 E9 05 01 EF 37 27 43 EA 9E 7D 5E
0120 | 94 9C C4 81 13 CC 57 FB 8E 86 F1 47 29 EB 0A 27
0130 | 23 29 3A D3 8B CB 77 92 2F 01 20 09 2E 0C 25 05
0140 | 7B F6 BE 58 CF D2 3E F6 CF 69 86 13 32 9D A9 5E
0150 | DE 47 2C 5C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>00B10900EEAB8368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04673E6E33000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1732144691</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046DC7A799000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1841801113</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001009689437E3076636D7E85CDA4</code> <code>6AD7896E746DF3C8669A1CAA68DABE91</code> <code>01655E94E937466088ECF2034BECC733</code> <code>5B117865AA47153A23DD744B2C97917B</code> <code>664C9A001516A931BECCCA7ED9B2F832</code> <code>F0E809D2DFBDB39C308D1A5EE5D25309</code> <code>43125980A1B43834D6E67EC1DC2B9BB5</code> <code>255EE6984D32491ACF5C32A84ACD1116</code> <code>5C61A9BA2080C4F1F37C43B5516B9B75</code> <code>B56148D7072B0B0D33E1EC055FEA4362</code> <code>D23DB3DB25298671D0C63686A7C66948</code> <code>C76B060C9C6B469A94427C3BA6E44087</code> <code>91BA61E9C4E90501EF372743EA9E7D5E</code> <code>949CC48113CC57FB8E86F14729EB0A27</code> <code>23293AD38BCB77922F0120092E0C2505</code> <code>7BF6BE58CFD23EF6CF698613329DA95E</code><br> <code>DE472C5C</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 10 AA 97 EE AB 83 68
0010 | 78 02 00 00 5C 07 E8 D0 63 97 F5 B5 E8 85 23 CA
0020 | CB 9B 7F 7C 5D 30 B3 61 E1 94 6E 88 C3 DF 05 61
0030 | E8 AE 10 5F 4A 81 DB C3 FE 50 02 00 F7 E9 D9 93
0040 | 35 71 07 A0 54 DA 48 C1 C0 32 2C 85 7B A5 42 66
0050 | 40 DB 6E 8E ED 04 D0 41 A4 E2 9B F5 4D 79 40 0E
0060 | 77 B6 4A 9A E6 CF 97 A3 BD 7F 95 1E E7 F4 CA FA
0070 | FD 04 9E 43 7C 62 F9 45 40 88 4E 4E 73 93 35 0A
0080 | 23 27 00 03 A8 22 56 1C 89 BD 96 D3 8F 0F 41 E9
0090 | 00 99 CD F5 50 90 C0 12 6C 97 07 1A E6 10 31 0F
00A0 | 91 1B 78 E0 EB D6 97 0C 7E 8B DE A6 7A 6F D5 9C
00B0 | 32 0F 99 4B 14 02 03 2A AE DF 44 CC 10 C7 A0 86
00C0 | 3D 17 F7 C3 14 8F A4 69 C5 A2 1D 76 3A 76 05 12
00D0 | E7 A5 6D 83 E4 FC AF 7A A3 F6 19 3F 4B B6 AD C6
00E0 | 29 E4 29 65 F3 CE 5E 3B 88 6C 11 07 09 AC 6A 26
00F0 | C0 96 42 90 29 81 92 77 D8 B8 89 67 C5 83 97 51
0100 | 98 CB FA 58 5B A0 48 0D 30 0C 8B AA C0 C3 B6 FE
0110 | 1E 9E CC 0E AF F9 27 7E 60 E0 3A 4D 96 E6 33 9D
0120 | 22 79 00 BF B7 12 DA 1C FD 57 E9 EB 7C 59 10 A1
0130 | A0 43 97 A3 51 63 95 79 51 05 E7 57 DA AC A1 AA
0140 | B2 FA E0 1E E9 4C 62 BC 40 F8 84 CF 63 15 BA 1A
0150 | 6E CF E1 0D E9 F4 49 5B 54 35 3B 2C 42 90 B5 D9
0160 | 3E 93 58 B6 CE 1F 34 EB 85 B0 4B E6 AE 9A 3C C9
0170 | 3A 6D B5 84 CB C3 85 00 29 83 53 B9 DF 44 7C 65
0180 | 86 19 2D 52 2F 46 68 28 D8 16 58 E1 5A 69 3A EA
0190 | 6C 7B 2F DC E8 2A 17 B5 AB 87 D4 85 E2 D6 6D DB
01A0 | 86 FE 77 E3 EA FF B6 64 0A 27 B9 0C F9 38 AC 56
01B0 | 08 B9 9B 8E 93 B6 39 85 C2 1B 71 04 06 7E 47 68
01C0 | 14 8A E8 E0 52 AB 9A 05 A9 4F BE 04 9B 54 A6 CB
01D0 | 41 E4 94 99 08 56 58 56 A6 B4 2C 24 4B ED 19 92
01E0 | CE A2 C0 F5 B5 AD 55 5C 3F 84 2D 57 DB F0 6E 23
01F0 | 51 CB B8 81 91 A8 3D D1 5D 29 EA 51 0B 64 EF 02
0200 | BB 9D A7 FC E1 6B 90 A6 F7 B5 03 AC AF 6A 89 E8
0210 | 4A D6 86 38 FB 35 DC 20 17 DA BB F5 3E C4 65 EB
0220 | 58 50 C7 F4 35 F8 75 0A 9A 0F 86 D0 FC 00 A4 87
0230 | DE 8D 64 49 84 7B 28 F1 80 21 FE D9 44 6A BC 26
0240 | 1C AD 43 3B 27 02 2C 5E C3 DE 45 4F 7B A2 9A 6C
0250 | 28 7F BB 06 A0 97 DD 80 2D 98 2A 9C 2F B0 76 C4
0260 | 1E 1F BD 47 88 CC B2 B5 32 ED D0 CB F5 BA 53 0C
0270 | 5D 6A A7 F0 8C B3 67 A6 F2 3D 21 F4 23 93 99 22
0280 | B6 37 45 9B C2 CF 47 B9 08 91 40 B1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0110AA97EEAB8368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200F7E9D993357107A054DA48C1</code> <code>C0322C857BA5426640DB6E8EED04D041</code> <code>A4E29BF54D79400E77B64A9AE6CF97A3</code> <code>BD7F951EE7F4CAFAFD049E437C62F945</code> <code>40884E4E7393350A23270003A822561C</code> <code>89BD96D38F0F41E90099CDF55090C012</code> <code>6C97071AE610310F911B78E0EBD6970C</code> <code>7E8BDEA67A6FD59C320F994B1402032A</code> <code>AEDF44CC10C7A0863D17F7C3148FA469</code> <code>C5A21D763A760512E7A56D83E4FCAF7A</code> <code>A3F6193F4BB6ADC629E42965F3CE5E3B</code> <code>886C110709AC6A26C096429029819277</code> <code>D8B88967C583975198CBFA585BA0480D</code> <code>300C8BAAC0C3B6FE1E9ECC0EAFF9277E</code> <code>60E03A4D96E6339D227900BFB712DA1C</code> <code>FD57E9EB7C5910A1A04397A351639579</code> <code>5105E757DAACA1AAB2FAE01EE94C62BC</code> <code>40F884CF6315BA1A6ECFE10DE9F4495B</code> <code>54353B2C4290B5D93E9358B6CE1F34EB</code> <code>85B04BE6AE9A3CC93A6DB584CBC38500</code> <code>298353B9DF447C6586192D522F466828</code> <code>D81658E15A693AEA6C7B2FDCE82A17B5</code> <code>AB87D485E2D66DDB86FE77E3EAFFB664</code> <code>0A27B90CF938AC5608B99B8E93B63985</code> <code>C21B7104067E4768148AE8E052AB9A05</code> <code>A94FBE049B54A6CB41E4949908565856</code> <code>A6B42C244BED1992CEA2C0F5B5AD555C</code> <code>3F842D57DBF06E2351CBB88191A83DD1</code> <code>5D29EA510B64EF02BB9DA7FCE16B90A6</code> <code>F7B503ACAF6A89E84AD68638FB35DC20</code> <code>17DABBF53EC465EB5850C7F435F8750A</code> <code>9A0F86D0FC00A487DE8D6449847B28F1</code> <code>8021FED9446ABC261CAD433B27022C5E</code> <code>C3DE454F7BA29A6C287FBB06A097DD80</code> <code>2D982A9C2FB076C41E1FBD4788CCB2B5</code> <code>32EDD0CBF5BA530C5D6AA7F08CB367A6</code> <code>F23D21F423939922B637459BC2CF47B9</code><br> <code>089140B1</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = F7E9D993357107A054DA48C1C0322C857BA5426640DB6E8EED04D041A4E29BF54D79400E77B64A9AE6CF97A3BD7F951EE7F4CAFAFD049E437C62F94540884E4E7393350A23270003A822561C89BD96D38F0F41E90099CDF55090C0126C97071AE610310F911B78E0EBD6970C7E8BDEA67A6FD59C320F994B1402032AAEDF44CC10C7A0863D17F7C3148FA469C5A21D763A760512E7A56D83E4FCAF7AA3F6193F4BB6ADC629E42965F3CE5E3B886C110709AC6A26C096429029819277D8B88967C583975198CBFA585BA0480D300C8BAAC0C3B6FE1E9ECC0EAFF9277E60E03A4D96E6339D227900BFB712DA1CFD57E9EB7C5910A1A04397A3516395795105E757DAACA1AAB2FAE01EE94C62BC40F884CF6315BA1A6ECFE10DE9F4495B54353B2C4290B5D93E9358B6CE1F34EB85B04BE6AE9A3CC93A6DB584CBC38500298353B9DF447C6586192D522F466828D81658E15A693AEA6C7B2FDCE82A17B5AB87D485E2D66DDB86FE77E3EAFFB6640A27B90CF938AC5608B99B8E93B63985C21B7104067E4768148AE8E052AB9A05A94FBE049B54A6CB41E4949908565856A6B42C244BED1992CEA2C0F5B5AD555C3F842D57DBF06E2351CBB88191A83DD15D29EA510B64EF02BB9DA7FCE16B90A6F7B503ACAF6A89E84AD68638FB35DC2017DABBF53EC465EB5850C7F435F8750A9A0F86D0FC00A487DE8D6449847B28F18021FED9446ABC261CAD433B27022C5EC3DE454F7BA29A6C287FBB06A097DD802D982A9C2FB076C41E1FBD4788CCB2B532EDD0CBF5BA530C5D6AA7F08CB367A6F23D21F423939922B637459BC2CF47B9089140B1
tmp_aes_key = 0C593A9D8ED92DC2C1016315F22BEB1F5064A22AF900D64F623ACA60D7D50E0C
tmp_aes_iv = 08AF955439662D83E055E495868D4CD4B752A4C1722324702B95A6BBED83A354</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 636148A1B36A96C90C09AC144E03964CF7CBF95ABA0D89B56397F5B5E88523CACB9B7F7C5D30B361E1946E88C3DF0561E8AE105F4A81DBC303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009B64584568B718E647A3CB92BA08F3AE7C88B89CA8150A7FF943AB8B2F90F011A141C3B410C55142E1FA454DE849E2A848D35F7AB00FC028DEEA33F4018A0807CEDACA69C9E4110C48DAD75007415AE6D571F4E794C73DD513B69C8571801ABD8A19A98B4AFEEDAFBE2244E04D7993E8C709A78C9D5FECF40D7D7A45809D6210C3DA993787F07D09BFE7C46C6529762A6131D61B3DA2E10A65FF5410CC8178289138684EFCA9C638A8FAFE4A0CAD396C21C58EF049BC17230361B4C3281DEF7434D094D8CE4E4459A931A001926FF39DEF84040020D8C29EAF01F50EB067A1CE635D2C4613D5BE4A14C2643B3B95722373FB5B90E479BA6B65AB6E7B093DCF63EEAB83680641ED31B6457D01
answer = BA0D89B56397F5B5E88523CACB9B7F7C5D30B361E1946E88C3DF0561E8AE105F4A81DBC303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009B64584568B718E647A3CB92BA08F3AE7C88B89CA8150A7FF943AB8B2F90F011A141C3B410C55142E1FA454DE849E2A848D35F7AB00FC028DEEA33F4018A0807CEDACA69C9E4110C48DAD75007415AE6D571F4E794C73DD513B69C8571801ABD8A19A98B4AFEEDAFBE2244E04D7993E8C709A78C9D5FECF40D7D7A45809D6210C3DA993787F07D09BFE7C46C6529762A6131D61B3DA2E10A65FF5410CC8178289138684EFCA9C638A8FAFE4A0CAD396C21C58EF049BC17230361B4C3281DEF7434D094D8CE4E4459A931A001926FF39DEF84040020D8C29EAF01F50EB067A1CE635D2C4613D5BE4A14C2643B3B95722373FB5B90E479BA6B65AB6E7B093DCF63EEAB83680641ED31B6457D01</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 63 97 F5 B5 E8 85 23 CA CB 9B 7F 7C
0010 | 5D 30 B3 61 E1 94 6E 88 C3 DF 05 61 E8 AE 10 5F
0020 | 4A 81 DB C3 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 9B 64 58 45 68 B7 18 E6 47 A3 CB 92 BA 08 F3 AE
0140 | 7C 88 B8 9C A8 15 0A 7F F9 43 AB 8B 2F 90 F0 11
0150 | A1 41 C3 B4 10 C5 51 42 E1 FA 45 4D E8 49 E2 A8
0160 | 48 D3 5F 7A B0 0F C0 28 DE EA 33 F4 01 8A 08 07
0170 | CE DA CA 69 C9 E4 11 0C 48 DA D7 50 07 41 5A E6
0180 | D5 71 F4 E7 94 C7 3D D5 13 B6 9C 85 71 80 1A BD
0190 | 8A 19 A9 8B 4A FE ED AF BE 22 44 E0 4D 79 93 E8
01A0 | C7 09 A7 8C 9D 5F EC F4 0D 7D 7A 45 80 9D 62 10
01B0 | C3 DA 99 37 87 F0 7D 09 BF E7 C4 6C 65 29 76 2A
01C0 | 61 31 D6 1B 3D A2 E1 0A 65 FF 54 10 CC 81 78 28
01D0 | 91 38 68 4E FC A9 C6 38 A8 FA FE 4A 0C AD 39 6C
01E0 | 21 C5 8E F0 49 BC 17 23 03 61 B4 C3 28 1D EF 74
01F0 | 34 D0 94 D8 CE 4E 44 59 A9 31 A0 01 92 6F F3 9D
0200 | EF 84 04 00 20 D8 C2 9E AF 01 F5 0E B0 67 A1 CE
0210 | 63 5D 2C 46 13 D5 BE 4A 14 C2 64 3B 3B 95 72 23
0220 | 73 FB 5B 90 E4 79 BA 6B 65 AB 6E 7B 09 3D CF 63
0230 | EE AB 83 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001009B64584568B718E647A3CB92</code> <code>BA08F3AE7C88B89CA8150A7FF943AB8B</code> <code>2F90F011A141C3B410C55142E1FA454D</code> <code>E849E2A848D35F7AB00FC028DEEA33F4</code> <code>018A0807CEDACA69C9E4110C48DAD750</code> <code>07415AE6D571F4E794C73DD513B69C85</code> <code>71801ABD8A19A98B4AFEEDAFBE2244E0</code> <code>4D7993E8C709A78C9D5FECF40D7D7A45</code> <code>809D6210C3DA993787F07D09BFE7C46C</code> <code>6529762A6131D61B3DA2E10A65FF5410</code> <code>CC8178289138684EFCA9C638A8FAFE4A</code> <code>0CAD396C21C58EF049BC17230361B4C3</code> <code>281DEF7434D094D8CE4E4459A931A001</code> <code>926FF39DEF84040020D8C29EAF01F50E</code> <code>B067A1CE635D2C4613D5BE4A14C2643B</code> <code>3B95722373FB5B90E479BA6B65AB6E7B</code><br> <code>093DCF63</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>EEAB8368</code> (1753459694 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 217ECB9D241A9B1F1134CB65999017BB61A773408D21CD75F0C30A7746E295117EC744D3AC704A2B946BE94782327EF53807160AD7DB292A81E9F155EC33D445EBD963499441C55F1791665D580D41AF638E0E28C30D0418A4B3341B3E50C72D57D365B4EE4524240F95BF39847A920B93C613A6683F49AF1B81E2989F462011CF362C967D0BA5322EBC03B1533E6A424B890B2F309F633FDD8A1F7B806DFE5B6C76838035BEC1B855A74BAEB0A8417AFF1F8103837F647B3C44CA35D2F548E55C46883487A29BA7D4B73DBF36756E3941731EED4EB435A3726CE1D57367CF2E082A0EC68177211D368AC08A43593E30DCA9D309A44E3C71E8FFEBFFF204FFA8</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 70C8BCADA661F5BCE4751968AB381FE9CD5EA4FE401B8A46B4D924ACC5E45E79EF734A9AD57337B2FF3442D9CC23DC7ADB323340C607ABB614AB626CF8D567555261825F2002F5DC3450C117B0006CB3074256AE64CCE3377A2AD88D35B566A9D310D96E5F93E2A67DDFBB106B868458D4B4348741957881F04613243671006B0FDCA61C25985DFF25B303B44EB89B0D981AE447D8DC2905E91CC7959FBFE261314C40ED43D7B3E40E925B43E2B1962898289DB41DA0668604C600C1ABD08BD6BC218B09C05AE67EA6942F746177F3AFDC16773C01376AC5ABC0E32025893219A9934241773831CA7B62DD43FE8895F7608503647C523630F0B55B7A507DFEB8</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 63 97 F5 B5 E8 85 23 CA CB 9B 7F 7C
0010 | 5D 30 B3 61 E1 94 6E 88 C3 DF 05 61 E8 AE 10 5F
0020 | 4A 81 DB C3 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 70 C8 BC AD A6 61 F5 BC E4 75 19 68 AB 38 1F E9
0040 | CD 5E A4 FE 40 1B 8A 46 B4 D9 24 AC C5 E4 5E 79
0050 | EF 73 4A 9A D5 73 37 B2 FF 34 42 D9 CC 23 DC 7A
0060 | DB 32 33 40 C6 07 AB B6 14 AB 62 6C F8 D5 67 55
0070 | 52 61 82 5F 20 02 F5 DC 34 50 C1 17 B0 00 6C B3
0080 | 07 42 56 AE 64 CC E3 37 7A 2A D8 8D 35 B5 66 A9
0090 | D3 10 D9 6E 5F 93 E2 A6 7D DF BB 10 6B 86 84 58
00A0 | D4 B4 34 87 41 95 78 81 F0 46 13 24 36 71 00 6B
00B0 | 0F DC A6 1C 25 98 5D FF 25 B3 03 B4 4E B8 9B 0D
00C0 | 98 1A E4 47 D8 DC 29 05 E9 1C C7 95 9F BF E2 61
00D0 | 31 4C 40 ED 43 D7 B3 E4 0E 92 5B 43 E2 B1 96 28
00E0 | 98 28 9D B4 1D A0 66 86 04 C6 00 C1 AB D0 8B D6
00F0 | BC 21 8B 09 C0 5A E6 7E A6 94 2F 74 61 77 F3 AF
0100 | DC 16 77 3C 01 37 6A C5 AB C0 E3 20 25 89 32 19
0110 | A9 93 42 41 77 38 31 CA 7B 62 DD 43 FE 88 95 F7
0120 | 60 85 03 64 7C 52 36 30 F0 B5 5B 7A 50 7D FE B8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010070C8BCADA661F5BCE4751968</code> <code>AB381FE9CD5EA4FE401B8A46B4D924AC</code> <code>C5E45E79EF734A9AD57337B2FF3442D9</code> <code>CC23DC7ADB323340C607ABB614AB626C</code> <code>F8D567555261825F2002F5DC3450C117</code> <code>B0006CB3074256AE64CCE3377A2AD88D</code> <code>35B566A9D310D96E5F93E2A67DDFBB10</code> <code>6B868458D4B4348741957881F0461324</code> <code>3671006B0FDCA61C25985DFF25B303B4</code> <code>4EB89B0D981AE447D8DC2905E91CC795</code> <code>9FBFE261314C40ED43D7B3E40E925B43</code> <code>E2B1962898289DB41DA0668604C600C1</code> <code>ABD08BD6BC218B09C05AE67EA6942F74</code> <code>6177F3AFDC16773C01376AC5ABC0E320</code> <code>25893219A9934241773831CA7B62DD43</code> <code>FE8895F7608503647C523630F0B55B7A</code><br> <code>507DFEB8</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643666397F5B5E88523CACB9B7F7C5D30B361E1946E88C3DF0561E8AE105F4A81DBC30000000000000000FE00010070C8BCADA661F5BCE4751968AB381FE9CD5EA4FE401B8A46B4D924ACC5E45E79EF734A9AD57337B2FF3442D9CC23DC7ADB323340C607ABB614AB626CF8D567555261825F2002F5DC3450C117B0006CB3074256AE64CCE3377A2AD88D35B566A9D310D96E5F93E2A67DDFBB106B868458D4B4348741957881F04613243671006B0FDCA61C25985DFF25B303B44EB89B0D981AE447D8DC2905E91CC7959FBFE261314C40ED43D7B3E40E925B43E2B1962898289DB41DA0668604C600C1ABD08BD6BC218B09C05AE67EA6942F746177F3AFDC16773C01376AC5ABC0E32025893219A9934241773831CA7B62DD43FE8895F7608503647C523630F0B55B7A507DFEB8
padding = 1D9AD0000E8D05305AB3C972
tmp_aes_key = 0C593A9D8ED92DC2C1016315F22BEB1F5064A22AF900D64F623ACA60D7D50E0C
tmp_aes_iv = 08AF955439662D83E055E495868D4CD4B752A4C1722324702B95A6BBED83A354</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 051459AE2C248685ABD11B05C223C88F6ECD33A36223D15A9DBF2347A0AC446B0682C1C02629B87BDAF5731D583E3C7089D33E29B2640F543C508897855FE5EF45B86A81ED2F842AEF3EEC88EC2088045B531494979CA26FAF0E6FF622C8099805B87C6E562549DA9B27A8A72443C0D70EA96D61429D1AF29CFC7EA0CA0E5A67939D61C0999A6C305CCF2090CBEC5C7A934328A4B03337FBD73BFE41378C0A268D87EB23E4BDB41AB97A116DCA41B8595BFE657024FFD8270DFDC227DB34F81AB72BE42B676C3892DEC8AAEC52540DFB3C3C782D857D1175AD610EACE651DD8F278AFD61F827CD93F90851DAD305C0ABC88504E11698B21648FD0CCC40E7C99284036BDFCF4E5CF22A13CE079D506DE3BF5EADF872168FB97638D88437EB476E4251D6520188706EC16EBA8F92CC64659B13742E652C835C04DC6FD6C2E244D04662AD700694DFC18F719EDFB84905E2</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 04 B1 09 00 EE AB 83 68
0010 | 78 01 00 00 1F 5F 04 F5 63 97 F5 B5 E8 85 23 CA
0020 | CB 9B 7F 7C 5D 30 B3 61 E1 94 6E 88 C3 DF 05 61
0030 | E8 AE 10 5F 4A 81 DB C3 FE 50 01 00 05 14 59 AE
0040 | 2C 24 86 85 AB D1 1B 05 C2 23 C8 8F 6E CD 33 A3
0050 | 62 23 D1 5A 9D BF 23 47 A0 AC 44 6B 06 82 C1 C0
0060 | 26 29 B8 7B DA F5 73 1D 58 3E 3C 70 89 D3 3E 29
0070 | B2 64 0F 54 3C 50 88 97 85 5F E5 EF 45 B8 6A 81
0080 | ED 2F 84 2A EF 3E EC 88 EC 20 88 04 5B 53 14 94
0090 | 97 9C A2 6F AF 0E 6F F6 22 C8 09 98 05 B8 7C 6E
00A0 | 56 25 49 DA 9B 27 A8 A7 24 43 C0 D7 0E A9 6D 61
00B0 | 42 9D 1A F2 9C FC 7E A0 CA 0E 5A 67 93 9D 61 C0
00C0 | 99 9A 6C 30 5C CF 20 90 CB EC 5C 7A 93 43 28 A4
00D0 | B0 33 37 FB D7 3B FE 41 37 8C 0A 26 8D 87 EB 23
00E0 | E4 BD B4 1A B9 7A 11 6D CA 41 B8 59 5B FE 65 70
00F0 | 24 FF D8 27 0D FD C2 27 DB 34 F8 1A B7 2B E4 2B
0100 | 67 6C 38 92 DE C8 AA EC 52 54 0D FB 3C 3C 78 2D
0110 | 85 7D 11 75 AD 61 0E AC E6 51 DD 8F 27 8A FD 61
0120 | F8 27 CD 93 F9 08 51 DA D3 05 C0 AB C8 85 04 E1
0130 | 16 98 B2 16 48 FD 0C CC 40 E7 C9 92 84 03 6B DF
0140 | CF 4E 5C F2 2A 13 CE 07 9D 50 6D E3 BF 5E AD F8
0150 | 72 16 8F B9 76 38 D8 84 37 EB 47 6E 42 51 D6 52
0160 | 01 88 70 6E C1 6E BA 8F 92 CC 64 65 9B 13 74 2E
0170 | 65 2C 83 5C 04 DC 6F D6 C2 E2 44 D0 46 62 AD 70
0180 | 06 94 DF C1 8F 71 9E DF B8 49 05 E2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>04B10900EEAB8368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100051459AE2C248685ABD11B05</code> <code>C223C88F6ECD33A36223D15A9DBF2347</code> <code>A0AC446B0682C1C02629B87BDAF5731D</code> <code>583E3C7089D33E29B2640F543C508897</code> <code>855FE5EF45B86A81ED2F842AEF3EEC88</code> <code>EC2088045B531494979CA26FAF0E6FF6</code> <code>22C8099805B87C6E562549DA9B27A8A7</code> <code>2443C0D70EA96D61429D1AF29CFC7EA0</code> <code>CA0E5A67939D61C0999A6C305CCF2090</code> <code>CBEC5C7A934328A4B03337FBD73BFE41</code> <code>378C0A268D87EB23E4BDB41AB97A116D</code> <code>CA41B8595BFE657024FFD8270DFDC227</code> <code>DB34F81AB72BE42B676C3892DEC8AAEC</code> <code>52540DFB3C3C782D857D1175AD610EAC</code> <code>E651DD8F278AFD61F827CD93F90851DA</code> <code>D305C0ABC88504E11698B21648FD0CCC</code> <code>40E7C99284036BDFCF4E5CF22A13CE07</code> <code>9D506DE3BF5EADF872168FB97638D884</code> <code>37EB476E4251D6520188706EC16EBA8F</code> <code>92CC64659B13742E652C835C04DC6FD6</code> <code>C2E244D04662AD700694DFC18F719EDF</code><br> <code>B84905E2</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 72E0B79ECC146069F207B09FA2435ADCCCBAE4FEAE68A94B34A4A0B40E77C18C69DFFD7A6E720F7960A08EFC284A8C261D4E7B701A4E50B61747F9FADF8F00CB7D89EF26C12AE38D5A02E19227FF3964514DF7FF34811967C9A6F2119FC315884B524D9C2C8A0F1C06E82C8084D7632D6634C6C4A2BB713E0F931B45AA43E25FEA2302E8968CE5A4B66DE0BA5E7BE8C7CAB2FD5CBDEE3851AA599F43DF98A4CD0C4C1688299CA94922EBC91B74A929B74DAB71E101565B1AFA17F5E1EDC0A33CF46038EACA626AE82FB95EEDA84C995C35B91BBCD1CB101F0BD93E487F39DE6BD55FAD91FB9051864AF0B2A66E991AAD6A309D64B7C61AB5DEE2D9A530B4E0A9</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C 4A BF EF AB 83 68
0010 | 34 00 00 00 34 F7 CB 3B 63 97 F5 B5 E8 85 23 CA
0020 | CB 9B 7F 7C 5D 30 B3 61 E1 94 6E 88 C3 DF 05 61
0030 | E8 AE 10 5F 4A 81 DB C3 D2 27 50 BC A8 D8 27 E4
0040 | D0 B0 23 DB A9 F1 D9 A7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017C4ABFEFAB8368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6397F5B5E88523CACB9B7F7C5D30B361</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E1946E88C3DF0561E8AE105F4A81DBC3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>D22750BCA8D827E4D0B023DBA9F1D9A7</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

