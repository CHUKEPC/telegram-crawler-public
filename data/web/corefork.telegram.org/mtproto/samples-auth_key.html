<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 24 22 03 00 19 B9 8E 66
0010 | 14 00 00 00 F1 8E 7E BE E9 F0 C9 0B 74 FD 5E 4C
0020 | A8 67 C6 D1 75 FC E7 56</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>2422030019B98E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 EF 33 19 B9 8E 66
0010 | BC 00 00 00 63 24 16 05 E9 F0 C9 0B 74 FD 5E 4C
0020 | A8 67 C6 D1 75 FC E7 56 03 A2 27 40 6B 8B E9 CD
0030 | B4 A2 08 97 49 C8 05 C9 08 1D 25 05 47 7F 66 A4
0040 | 15 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0194EF3319B98E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC000000</code> (188 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081D2505477F66A415000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2100090605876454421</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2100090605876454421</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2100090605876454421 = 1378804061 * 1523124761</code></p>
<pre><code>p = 1378804061
q = 1523124761</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1D 25 05 47 7F 66 A4 15 00 00 00
0010 | 04 52 2E E1 5D 00 00 00 04 5A C9 0A 19 00 00 00
0020 | E9 F0 C9 0B 74 FD 5E 4C A8 67 C6 D1 75 FC E7 56
0030 | 03 A2 27 40 6B 8B E9 CD B4 A2 08 97 49 C8 05 C9
0040 | BB FA CE F6 99 A2 92 C1 E4 25 E9 EA 00 72 86 52
0050 | 41 A3 28 5E 7D AA 43 EF 3C FE 62 CB 00 B8 47 22
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081D2505477F66A415000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2100090605876454421</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04522EE15D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1378804061</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045AC90A19000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1523124761</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>BBFACEF699A292C1E425E9EA00728652</code> <code>41A3285E7DAA43EF3CFE62CB00B84722</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081D2505477F66A41500000004522EE15D000000045AC90A19000000E9F0C90B74FD5E4CA867C6D175FCE75603A227406B8BE9CDB4A2089749C805C9BBFACEF699A292C1E425E9EA0072865241A3285E7DAA43EF3CFE62CB00B8472202000000
random_padding_bytes = 1CD090452733235383AB289E5BAFA9ADA9DCF867C4909DA15873C1F69EB39A3DBB95A5A6F3E25613DDC3DC2F423038396A0C0F3CB45B9C9A346163A94F2A5229C0EFE0B40920D7C349AE4C81F11BB78A7C25C2C5A3C0E61896648CC8</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D489D989F63605755FCECDEFEA0CBF565159F328FBF8A91F20175DCAE43747302AAF0A736477ED4E13C654D63158A07AD4C2F0F88187A668911237A64E3428686929F85CA4543B803E05029CB09A4BE4C2D5576298CD04E964FB2EA4C02051C1B2A36C2D0822EBB7020EAA6DFDA1F2219C3614E51B598CACBAFD76E5A4851637239800EE8477408CF9A7524C863E8A33222EB21C80756746F07895B79BBAE81622E321EC2D33D0C62082CA25A25FDED86A68A44B5D6539CA3D8FAAABB0EE7F3517F567B290D4A3472118541AD283770507391F0A9F7EE7E7691097FED6D1595CB15E2F28804CAE9E0992C15A5019ED5C2BE52EF7A5A2D1414CA7B4DC8C2829F6</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 B6 0D 00 19 B9 8E 66
0010 | 40 01 00 00 BE E4 12 D7 E9 F0 C9 0B 74 FD 5E 4C
0020 | A8 67 C6 D1 75 FC E7 56 03 A2 27 40 6B 8B E9 CD
0030 | B4 A2 08 97 49 C8 05 C9 04 52 2E E1 5D 00 00 00
0040 | 04 5A C9 0A 19 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D4 89 D9 89 F6 36 05 75 5F CE CD EF
0060 | EA 0C BF 56 51 59 F3 28 FB F8 A9 1F 20 17 5D CA
0070 | E4 37 47 30 2A AF 0A 73 64 77 ED 4E 13 C6 54 D6
0080 | 31 58 A0 7A D4 C2 F0 F8 81 87 A6 68 91 12 37 A6
0090 | 4E 34 28 68 69 29 F8 5C A4 54 3B 80 3E 05 02 9C
00A0 | B0 9A 4B E4 C2 D5 57 62 98 CD 04 E9 64 FB 2E A4
00B0 | C0 20 51 C1 B2 A3 6C 2D 08 22 EB B7 02 0E AA 6D
00C0 | FD A1 F2 21 9C 36 14 E5 1B 59 8C AC BA FD 76 E5
00D0 | A4 85 16 37 23 98 00 EE 84 77 40 8C F9 A7 52 4C
00E0 | 86 3E 8A 33 22 2E B2 1C 80 75 67 46 F0 78 95 B7
00F0 | 9B BA E8 16 22 E3 21 EC 2D 33 D0 C6 20 82 CA 25
0100 | A2 5F DE D8 6A 68 A4 4B 5D 65 39 CA 3D 8F AA AB
0110 | B0 EE 7F 35 17 F5 67 B2 90 D4 A3 47 21 18 54 1A
0120 | D2 83 77 05 07 39 1F 0A 9F 7E E7 E7 69 10 97 FE
0130 | D6 D1 59 5C B1 5E 2F 28 80 4C AE 9E 09 92 C1 5A
0140 | 50 19 ED 5C 2B E5 2E F7 A5 A2 D1 41 4C A7 B4 DC
0150 | 8C 28 29 F6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C0B60D0019B98E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04522EE15D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1378804061</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045AC90A19000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1523124761</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D489D989F63605755FCECDEF</code> <code>EA0CBF565159F328FBF8A91F20175DCA</code> <code>E43747302AAF0A736477ED4E13C654D6</code> <code>3158A07AD4C2F0F88187A668911237A6</code> <code>4E3428686929F85CA4543B803E05029C</code> <code>B09A4BE4C2D5576298CD04E964FB2EA4</code> <code>C02051C1B2A36C2D0822EBB7020EAA6D</code> <code>FDA1F2219C3614E51B598CACBAFD76E5</code> <code>A4851637239800EE8477408CF9A7524C</code> <code>863E8A33222EB21C80756746F07895B7</code> <code>9BBAE81622E321EC2D33D0C62082CA25</code> <code>A25FDED86A68A44B5D6539CA3D8FAAAB</code> <code>B0EE7F3517F567B290D4A3472118541A</code> <code>D283770507391F0A9F7EE7E7691097FE</code> <code>D6D1595CB15E2F28804CAE9E0992C15A</code> <code>5019ED5C2BE52EF7A5A2D1414CA7B4DC</code><br> <code>8C2829F6</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 18 D9 F0 19 B9 8E 66
0010 | AC 02 00 00 5C 07 E8 D0 E9 F0 C9 0B 74 FD 5E 4C
0020 | A8 67 C6 D1 75 FC E7 56 03 A2 27 40 6B 8B E9 CD
0030 | B4 A2 08 97 49 C8 05 C9 FE 50 02 00 1B 86 76 60
0040 | 6D D6 AE A8 B2 D8 62 4E B2 D8 DE F0 43 FD 24 F8
0050 | F3 59 7D 47 6D 2A 25 43 4E 84 99 39 B5 13 1E 87
0060 | 99 14 56 B0 0F 6C 86 41 07 6A E3 F4 BC FB F7 CE
0070 | E1 D5 D0 15 21 A2 7C 14 48 80 42 92 28 C2 99 6A
0080 | 89 EC 75 2F 8D 7B 80 D6 59 48 DE 4C 23 D6 EB 9E
0090 | 41 37 C2 6E 7E 7E 75 D5 4E 32 C4 18 C3 93 CE B7
00A0 | B4 CB 94 33 0F 64 D3 2C 97 BC C9 0B AB F1 A8 E3
00B0 | A8 79 EA 67 EB 04 7A EE F4 38 47 63 03 F5 60 8F
00C0 | 7D BB 57 46 57 68 A4 45 69 D8 51 6D 7B CB 62 85
00D0 | 2A 6D 92 20 F3 89 2F E5 E2 D2 6D 87 85 AE 64 D4
00E0 | DB 8B 53 6F 8A 86 D8 0C D4 C9 23 B2 5F 59 CD 37
00F0 | A9 03 65 77 C8 09 27 C7 83 7E D7 8D 29 F0 79 D5
0100 | EE D2 C3 65 76 D1 3F 8B DB 4C 33 1D 2E 85 5E E8
0110 | 3F 47 23 D2 1B 97 94 D0 12 BF 1D 7B 38 2C C7 A7
0120 | 40 A8 9E 76 B1 8A AD DA CA FE 56 ED B3 52 5C 2F
0130 | 65 96 53 BE AB EA 10 3C 36 8E 06 43 12 C4 20 F6
0140 | E3 50 2F 87 81 B8 52 1E 21 F1 6A 34 F4 F9 20 43
0150 | 23 CF 32 28 EB 47 CD 96 13 7E 04 31 CB A9 2E 6E
0160 | A4 E4 54 83 D4 47 B3 45 55 50 71 2E F2 97 F5 3E
0170 | BC 0F 1A 20 C0 4F 76 8C AE C3 50 86 3A 6E A7 70
0180 | 14 ED 8E 73 28 88 69 ED 5C 8E A8 A1 44 F1 B3 6C
0190 | 93 A1 A1 D9 3B 4F 60 C1 67 B0 20 C7 51 EF 30 DD
01A0 | B7 1E 48 7A C0 2A 14 4A 39 DC B6 2A 03 E2 A4 D8
01B0 | D1 52 44 D6 A2 A0 85 10 81 C3 D8 37 55 20 25 0A
01C0 | 3C AE E4 3E 41 BB B4 FA AD 8F A7 63 28 5C 57 66
01D0 | BD 44 24 7A B9 54 2D 22 24 0E 8A 5F 2F 21 6B 10
01E0 | EE A1 E8 D1 E9 70 F8 0A BC 78 17 F3 DB A4 B3 AF
01F0 | 3E EF B0 4A 26 2E 0F 68 BD 63 05 AB CF 43 26 83
0200 | E8 50 0B 7D EF 01 68 A5 60 28 3F 64 F0 64 4C EF
0210 | 52 AF 73 12 7B DC 8F 4C 22 20 C8 0B 00 72 AD 64
0220 | 2D 82 29 3B 52 3D 6E 03 97 A4 62 97 D0 EF 9A EA
0230 | DD 36 22 26 49 5E 0D F5 A9 E0 D4 43 49 FE 60 BC
0240 | 7E 52 DA 61 96 F9 89 C2 C5 EC 65 94 C6 9B F8 AA
0250 | 20 39 10 CE 8E 0D B5 48 EB 8C 61 4D 00 B7 5F 9D
0260 | 35 D2 E6 50 72 24 40 A4 01 D9 9A D0 F0 99 37 8A
0270 | F7 C1 8D 7A 37 4E 03 D3 AE 44 58 43 18 33 4F F0
0280 | 48 8F 71 BE ED 87 87 25 DF 72 AA E3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0118D9F019B98E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>AC020000</code> (684 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002001B8676606DD6AEA8B2D8624E</code> <code>B2D8DEF043FD24F8F3597D476D2A2543</code> <code>4E849939B5131E87991456B00F6C8641</code> <code>076AE3F4BCFBF7CEE1D5D01521A27C14</code> <code>4880429228C2996A89EC752F8D7B80D6</code> <code>5948DE4C23D6EB9E4137C26E7E7E75D5</code> <code>4E32C418C393CEB7B4CB94330F64D32C</code> <code>97BCC90BABF1A8E3A879EA67EB047AEE</code> <code>F438476303F5608F7DBB57465768A445</code> <code>69D8516D7BCB62852A6D9220F3892FE5</code> <code>E2D26D8785AE64D4DB8B536F8A86D80C</code> <code>D4C923B25F59CD37A9036577C80927C7</code> <code>837ED78D29F079D5EED2C36576D13F8B</code> <code>DB4C331D2E855EE83F4723D21B9794D0</code> <code>12BF1D7B382CC7A740A89E76B18AADDA</code> <code>CAFE56EDB3525C2F659653BEABEA103C</code> <code>368E064312C420F6E3502F8781B8521E</code> <code>21F16A34F4F9204323CF3228EB47CD96</code> <code>137E0431CBA92E6EA4E45483D447B345</code> <code>5550712EF297F53EBC0F1A20C04F768C</code> <code>AEC350863A6EA77014ED8E73288869ED</code> <code>5C8EA8A144F1B36C93A1A1D93B4F60C1</code> <code>67B020C751EF30DDB71E487AC02A144A</code> <code>39DCB62A03E2A4D8D15244D6A2A08510</code> <code>81C3D8375520250A3CAEE43E41BBB4FA</code> <code>AD8FA763285C5766BD44247AB9542D22</code> <code>240E8A5F2F216B10EEA1E8D1E970F80A</code> <code>BC7817F3DBA4B3AF3EEFB04A262E0F68</code> <code>BD6305ABCF432683E8500B7DEF0168A5</code> <code>60283F64F0644CEF52AF73127BDC8F4C</code> <code>2220C80B0072AD642D82293B523D6E03</code> <code>97A46297D0EF9AEADD362226495E0DF5</code> <code>A9E0D44349FE60BC7E52DA6196F989C2</code> <code>C5EC6594C69BF8AA203910CE8E0DB548</code> <code>EB8C614D00B75F9D35D2E650722440A4</code> <code>01D99AD0F099378AF7C18D7A374E03D3</code> <code>AE44584318334FF0488F71BEED878725</code><br> <code>DF72AAE3</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 1B8676606DD6AEA8B2D8624EB2D8DEF043FD24F8F3597D476D2A25434E849939B5131E87991456B00F6C8641076AE3F4BCFBF7CEE1D5D01521A27C144880429228C2996A89EC752F8D7B80D65948DE4C23D6EB9E4137C26E7E7E75D54E32C418C393CEB7B4CB94330F64D32C97BCC90BABF1A8E3A879EA67EB047AEEF438476303F5608F7DBB57465768A44569D8516D7BCB62852A6D9220F3892FE5E2D26D8785AE64D4DB8B536F8A86D80CD4C923B25F59CD37A9036577C80927C7837ED78D29F079D5EED2C36576D13F8BDB4C331D2E855EE83F4723D21B9794D012BF1D7B382CC7A740A89E76B18AADDACAFE56EDB3525C2F659653BEABEA103C368E064312C420F6E3502F8781B8521E21F16A34F4F9204323CF3228EB47CD96137E0431CBA92E6EA4E45483D447B3455550712EF297F53EBC0F1A20C04F768CAEC350863A6EA77014ED8E73288869ED5C8EA8A144F1B36C93A1A1D93B4F60C167B020C751EF30DDB71E487AC02A144A39DCB62A03E2A4D8D15244D6A2A0851081C3D8375520250A3CAEE43E41BBB4FAAD8FA763285C5766BD44247AB9542D22240E8A5F2F216B10EEA1E8D1E970F80ABC7817F3DBA4B3AF3EEFB04A262E0F68BD6305ABCF432683E8500B7DEF0168A560283F64F0644CEF52AF73127BDC8F4C2220C80B0072AD642D82293B523D6E0397A46297D0EF9AEADD362226495E0DF5A9E0D44349FE60BC7E52DA6196F989C2C5EC6594C69BF8AA203910CE8E0DB548EB8C614D00B75F9D35D2E650722440A401D99AD0F099378AF7C18D7A374E03D3AE44584318334FF0488F71BEED878725DF72AAE3
tmp_aes_key = 4B1FC0BB5AEEB48000D464517C3F51C86446FF46D48D1E8B5943CB8D53704586
tmp_aes_iv = 827E440658018F2BF544D1E58D761A8FDC27720E952D37EA7A71C66BBBFACEF6</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = FDC73C9532916188A113D3699EE14872D694DE42BA0D89B5E9F0C90B74FD5E4CA867C6D175FCE75603A227406B8BE9CDB4A2089749C805C903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010057F653EFBA15BFC1850B47BE7C388554B4916090033397032D9380162500698EC90250462F9C6D085C48E230F1F8ED6B32EA2496F8F34AC438BA6A846D55D1182253AAC403424BBEA07DEF3AF92DDE35A6A6F9531E2FCAC902EB61F51B8D8DAB44AE7D4532DB26C33C3F9DDFB404D53A0DD0DB659E8E7D97936960D96354595276AB3E2AEF00ECBFA29C27A4CC9C35C5AD4810403CCF60448AE4A3D8A420740CA99E1B98CF02424D7835B102745F5D9D2CE990162FFBDE55CE9E1124A3C5A31E8BA54DD332EA6F12C2EB7A5ADE8194966C16EBEA2333058A3308A88438F63019511A48CCA47E48DB2451132395E025BF1BBF4DC274AF74CEB64FDAD974ECD9F619B98E660EEAF6D25B0A055E
answer = BA0D89B5E9F0C90B74FD5E4CA867C6D175FCE75603A227406B8BE9CDB4A2089749C805C903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010057F653EFBA15BFC1850B47BE7C388554B4916090033397032D9380162500698EC90250462F9C6D085C48E230F1F8ED6B32EA2496F8F34AC438BA6A846D55D1182253AAC403424BBEA07DEF3AF92DDE35A6A6F9531E2FCAC902EB61F51B8D8DAB44AE7D4532DB26C33C3F9DDFB404D53A0DD0DB659E8E7D97936960D96354595276AB3E2AEF00ECBFA29C27A4CC9C35C5AD4810403CCF60448AE4A3D8A420740CA99E1B98CF02424D7835B102745F5D9D2CE990162FFBDE55CE9E1124A3C5A31E8BA54DD332EA6F12C2EB7A5ADE8194966C16EBEA2333058A3308A88438F63019511A48CCA47E48DB2451132395E025BF1BBF4DC274AF74CEB64FDAD974ECD9F619B98E660EEAF6D25B0A055E</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E9 F0 C9 0B 74 FD 5E 4C A8 67 C6 D1
0010 | 75 FC E7 56 03 A2 27 40 6B 8B E9 CD B4 A2 08 97
0020 | 49 C8 05 C9 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 57 F6 53 EF BA 15 BF C1 85 0B 47 BE 7C 38 85 54
0140 | B4 91 60 90 03 33 97 03 2D 93 80 16 25 00 69 8E
0150 | C9 02 50 46 2F 9C 6D 08 5C 48 E2 30 F1 F8 ED 6B
0160 | 32 EA 24 96 F8 F3 4A C4 38 BA 6A 84 6D 55 D1 18
0170 | 22 53 AA C4 03 42 4B BE A0 7D EF 3A F9 2D DE 35
0180 | A6 A6 F9 53 1E 2F CA C9 02 EB 61 F5 1B 8D 8D AB
0190 | 44 AE 7D 45 32 DB 26 C3 3C 3F 9D DF B4 04 D5 3A
01A0 | 0D D0 DB 65 9E 8E 7D 97 93 69 60 D9 63 54 59 52
01B0 | 76 AB 3E 2A EF 00 EC BF A2 9C 27 A4 CC 9C 35 C5
01C0 | AD 48 10 40 3C CF 60 44 8A E4 A3 D8 A4 20 74 0C
01D0 | A9 9E 1B 98 CF 02 42 4D 78 35 B1 02 74 5F 5D 9D
01E0 | 2C E9 90 16 2F FB DE 55 CE 9E 11 24 A3 C5 A3 1E
01F0 | 8B A5 4D D3 32 EA 6F 12 C2 EB 7A 5A DE 81 94 96
0200 | 6C 16 EB EA 23 33 05 8A 33 08 A8 84 38 F6 30 19
0210 | 51 1A 48 CC A4 7E 48 DB 24 51 13 23 95 E0 25 BF
0220 | 1B BF 4D C2 74 AF 74 CE B6 4F DA D9 74 EC D9 F6
0230 | 19 B9 8E 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010057F653EFBA15BFC1850B47BE</code> <code>7C388554B4916090033397032D938016</code> <code>2500698EC90250462F9C6D085C48E230</code> <code>F1F8ED6B32EA2496F8F34AC438BA6A84</code> <code>6D55D1182253AAC403424BBEA07DEF3A</code> <code>F92DDE35A6A6F9531E2FCAC902EB61F5</code> <code>1B8D8DAB44AE7D4532DB26C33C3F9DDF</code> <code>B404D53A0DD0DB659E8E7D97936960D9</code> <code>6354595276AB3E2AEF00ECBFA29C27A4</code> <code>CC9C35C5AD4810403CCF60448AE4A3D8</code> <code>A420740CA99E1B98CF02424D7835B102</code> <code>745F5D9D2CE990162FFBDE55CE9E1124</code> <code>A3C5A31E8BA54DD332EA6F12C2EB7A5A</code> <code>DE8194966C16EBEA2333058A3308A884</code> <code>38F63019511A48CCA47E48DB24511323</code> <code>95E025BF1BBF4DC274AF74CEB64FDAD9</code><br> <code>74ECD9F6</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>19B98E66</code> (1720629529 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = FC0A88D80534D941EDB44DD44A69CFFD47C22344B9D6BC67F0E8CF0EBDAEEB626A470D56461C2480262A3BF9A911339C2F209AAF8FA01CB08486C8FAD99E761134CEE10B1AD4538777EE8F3576C7F3C9073DA0041FB8522FEF253967890C0D76D56FE8F116C0975725B3B1142CB6FD32373758346BB04AD7D18A035EDC5BE8FE356498FCB823AC27446BC7B195C285AD3180897F0F4BE635B1B8B6DACA240B7BC5A28D58103077525E4CA622C7AF6573717F7592005393038E8EB5DE2C8C2265211E503297938C4AC296077EE680504A05AE658A1EFD0C8203E8A533FA7EEDDA3B480F4B1A4C4C707278A81693DC310C4AA3EF714E458C177CFFB1A689CFCC44</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 59DFCABB95FC5BC927FF2BDE3FBCD0A8B1E1009632FF85C697434F919173720273893E6E88E70A75E3FF80C63623A44A05B890460DA9C30326304771C45F6823B47A9D5DEF5E29065D542116C5F4A7EBF1C12FBC204D501062E3E8DC6EF7BABAAB239110B0F50E2E2387E3792BB32AEDD9D2FA0C2041329F20B96D06B59CCE2ED22451A12C1648C9B50C2C9DA796C5415E24D7D3905A6470CC45E050B48086A71239EDBB29131B63C391DB14C702E5B3833947028CA9576B819FF4FC106C8AF7DD63A4ACB0158BC7F761658169EFA0CDA8805C31546A05A498D52C2C1A50C7F5899F0D058D77FD718F8B6772405980CE49F413292049F2FDD9919C24EFC5A4BF</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E9 F0 C9 0B 74 FD 5E 4C A8 67 C6 D1
0010 | 75 FC E7 56 03 A2 27 40 6B 8B E9 CD B4 A2 08 97
0020 | 49 C8 05 C9 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 59 DF CA BB 95 FC 5B C9 27 FF 2B DE 3F BC D0 A8
0040 | B1 E1 00 96 32 FF 85 C6 97 43 4F 91 91 73 72 02
0050 | 73 89 3E 6E 88 E7 0A 75 E3 FF 80 C6 36 23 A4 4A
0060 | 05 B8 90 46 0D A9 C3 03 26 30 47 71 C4 5F 68 23
0070 | B4 7A 9D 5D EF 5E 29 06 5D 54 21 16 C5 F4 A7 EB
0080 | F1 C1 2F BC 20 4D 50 10 62 E3 E8 DC 6E F7 BA BA
0090 | AB 23 91 10 B0 F5 0E 2E 23 87 E3 79 2B B3 2A ED
00A0 | D9 D2 FA 0C 20 41 32 9F 20 B9 6D 06 B5 9C CE 2E
00B0 | D2 24 51 A1 2C 16 48 C9 B5 0C 2C 9D A7 96 C5 41
00C0 | 5E 24 D7 D3 90 5A 64 70 CC 45 E0 50 B4 80 86 A7
00D0 | 12 39 ED BB 29 13 1B 63 C3 91 DB 14 C7 02 E5 B3
00E0 | 83 39 47 02 8C A9 57 6B 81 9F F4 FC 10 6C 8A F7
00F0 | DD 63 A4 AC B0 15 8B C7 F7 61 65 81 69 EF A0 CD
0100 | A8 80 5C 31 54 6A 05 A4 98 D5 2C 2C 1A 50 C7 F5
0110 | 89 9F 0D 05 8D 77 FD 71 8F 8B 67 72 40 59 80 CE
0120 | 49 F4 13 29 20 49 F2 FD D9 91 9C 24 EF C5 A4 BF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010059DFCABB95FC5BC927FF2BDE</code> <code>3FBCD0A8B1E1009632FF85C697434F91</code> <code>9173720273893E6E88E70A75E3FF80C6</code> <code>3623A44A05B890460DA9C30326304771</code> <code>C45F6823B47A9D5DEF5E29065D542116</code> <code>C5F4A7EBF1C12FBC204D501062E3E8DC</code> <code>6EF7BABAAB239110B0F50E2E2387E379</code> <code>2BB32AEDD9D2FA0C2041329F20B96D06</code> <code>B59CCE2ED22451A12C1648C9B50C2C9D</code> <code>A796C5415E24D7D3905A6470CC45E050</code> <code>B48086A71239EDBB29131B63C391DB14</code> <code>C702E5B3833947028CA9576B819FF4FC</code> <code>106C8AF7DD63A4ACB0158BC7F7616581</code> <code>69EFA0CDA8805C31546A05A498D52C2C</code> <code>1A50C7F5899F0D058D77FD718F8B6772</code> <code>405980CE49F413292049F2FDD9919C24</code><br> <code>EFC5A4BF</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E9F0C90B74FD5E4CA867C6D175FCE75603A227406B8BE9CDB4A2089749C805C90000000000000000FE00010059DFCABB95FC5BC927FF2BDE3FBCD0A8B1E1009632FF85C697434F919173720273893E6E88E70A75E3FF80C63623A44A05B890460DA9C30326304771C45F6823B47A9D5DEF5E29065D542116C5F4A7EBF1C12FBC204D501062E3E8DC6EF7BABAAB239110B0F50E2E2387E3792BB32AEDD9D2FA0C2041329F20B96D06B59CCE2ED22451A12C1648C9B50C2C9DA796C5415E24D7D3905A6470CC45E050B48086A71239EDBB29131B63C391DB14C702E5B3833947028CA9576B819FF4FC106C8AF7DD63A4ACB0158BC7F761658169EFA0CDA8805C31546A05A498D52C2C1A50C7F5899F0D058D77FD718F8B6772405980CE49F413292049F2FDD9919C24EFC5A4BF
padding = 50AC8E7A783D2A6C6574D715
tmp_aes_key = 4B1FC0BB5AEEB48000D464517C3F51C86446FF46D48D1E8B5943CB8D53704586
tmp_aes_iv = 827E440658018F2BF544D1E58D761A8FDC27720E952D37EA7A71C66BBBFACEF6</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 9A3F05B76B4C210CA7F3F56A88EEAA86763C699D4D4CD3F6DCE1DDF5E1EEAD1EA6131546C389312D74289BF67D020C74D8AACB336A9101396004C7558A87D9525C08A8599E02B63B7E23B0495A099E389DB2BF25AEC6AF4D7D7D3257558DD71E9141CC88BABB86F4ACA65574D18CF404B75E61F133B827DFAB845FBE824D3D2F5CFEF6E67A85E8E5BF4AC0CB1E81BB8408670D355AD972C8F1C786602159962827360A64D00E49006B2C0852B387A8DA49C87AE5B2B0972F04B16CC0B5F6952524EB4EEDBF5B76F3A9A3CF8BAE87AD5CF8204E4E20A1878E46A536C4BC16430CB379D2D59DE922C2815751ECC532B7703A86C6086C638CE61391795FA56DF876758CDA328860275F9548980D30F7C935C19423B36478DF2905E204884B5A77663F3495D9BC5E49BE58BBAAE8EF37A98A0284A2B7B7EE3CBA12A670F7739D3807FEC36950B167E0385C719F54845F51C2</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC 62 0B 00 1A B9 8E 66
0010 | 78 01 00 00 1F 5F 04 F5 E9 F0 C9 0B 74 FD 5E 4C
0020 | A8 67 C6 D1 75 FC E7 56 03 A2 27 40 6B 8B E9 CD
0030 | B4 A2 08 97 49 C8 05 C9 FE 50 01 00 9A 3F 05 B7
0040 | 6B 4C 21 0C A7 F3 F5 6A 88 EE AA 86 76 3C 69 9D
0050 | 4D 4C D3 F6 DC E1 DD F5 E1 EE AD 1E A6 13 15 46
0060 | C3 89 31 2D 74 28 9B F6 7D 02 0C 74 D8 AA CB 33
0070 | 6A 91 01 39 60 04 C7 55 8A 87 D9 52 5C 08 A8 59
0080 | 9E 02 B6 3B 7E 23 B0 49 5A 09 9E 38 9D B2 BF 25
0090 | AE C6 AF 4D 7D 7D 32 57 55 8D D7 1E 91 41 CC 88
00A0 | BA BB 86 F4 AC A6 55 74 D1 8C F4 04 B7 5E 61 F1
00B0 | 33 B8 27 DF AB 84 5F BE 82 4D 3D 2F 5C FE F6 E6
00C0 | 7A 85 E8 E5 BF 4A C0 CB 1E 81 BB 84 08 67 0D 35
00D0 | 5A D9 72 C8 F1 C7 86 60 21 59 96 28 27 36 0A 64
00E0 | D0 0E 49 00 6B 2C 08 52 B3 87 A8 DA 49 C8 7A E5
00F0 | B2 B0 97 2F 04 B1 6C C0 B5 F6 95 25 24 EB 4E ED
0100 | BF 5B 76 F3 A9 A3 CF 8B AE 87 AD 5C F8 20 4E 4E
0110 | 20 A1 87 8E 46 A5 36 C4 BC 16 43 0C B3 79 D2 D5
0120 | 9D E9 22 C2 81 57 51 EC C5 32 B7 70 3A 86 C6 08
0130 | 6C 63 8C E6 13 91 79 5F A5 6D F8 76 75 8C DA 32
0140 | 88 60 27 5F 95 48 98 0D 30 F7 C9 35 C1 94 23 B3
0150 | 64 78 DF 29 05 E2 04 88 4B 5A 77 66 3F 34 95 D9
0160 | BC 5E 49 BE 58 BB AA E8 EF 37 A9 8A 02 84 A2 B7
0170 | B7 EE 3C BA 12 A6 70 F7 73 9D 38 07 FE C3 69 50
0180 | B1 67 E0 38 5C 71 9F 54 84 5F 51 C2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>EC620B001AB98E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001009A3F05B76B4C210CA7F3F56A</code> <code>88EEAA86763C699D4D4CD3F6DCE1DDF5</code> <code>E1EEAD1EA6131546C389312D74289BF6</code> <code>7D020C74D8AACB336A9101396004C755</code> <code>8A87D9525C08A8599E02B63B7E23B049</code> <code>5A099E389DB2BF25AEC6AF4D7D7D3257</code> <code>558DD71E9141CC88BABB86F4ACA65574</code> <code>D18CF404B75E61F133B827DFAB845FBE</code> <code>824D3D2F5CFEF6E67A85E8E5BF4AC0CB</code> <code>1E81BB8408670D355AD972C8F1C78660</code> <code>2159962827360A64D00E49006B2C0852</code> <code>B387A8DA49C87AE5B2B0972F04B16CC0</code> <code>B5F6952524EB4EEDBF5B76F3A9A3CF8B</code> <code>AE87AD5CF8204E4E20A1878E46A536C4</code> <code>BC16430CB379D2D59DE922C2815751EC</code> <code>C532B7703A86C6086C638CE61391795F</code> <code>A56DF876758CDA328860275F9548980D</code> <code>30F7C935C19423B36478DF2905E20488</code> <code>4B5A77663F3495D9BC5E49BE58BBAAE8</code> <code>EF37A98A0284A2B7B7EE3CBA12A670F7</code> <code>739D3807FEC36950B167E0385C719F54</code><br> <code>845F51C2</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 98FA1E08C3021458B8949CD48A3DFB4C434E18081B8E2F3C2669E491EBD35F07CAE6E2B386CDA8E43E2AC416F83CD6E01A7162E0849FD90471A6AE7E21147F2374239F71326CCD45E69086679162107283A7CAFD46AE40B130C8BB8425FACD31B39F84F7B8186A2E5E28ACBB4804C991231CC921FBE6F7EE92DF9B9A340E86EFA3CF7974C9DFCDEEA9102026C2A889F80804256913F301FFCD399E984E52D588714A2E13F1D63FCD75D5A4C34141AD8B4F3B924FD65FA65D2BD259C1403CFA657FFC23FDCB424B9FB75829FEFF0FD94B118F7BE41BDBC851E97D5FD03F8CC7901A844305C22BAF3353E58A69DB75702DAC0E959D826761463353541DA8200D8D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B8 AE 0B 1B B9 8E 66
0010 | 4C 00 00 00 34 F7 CB 3B E9 F0 C9 0B 74 FD 5E 4C
0020 | A8 67 C6 D1 75 FC E7 56 03 A2 27 40 6B 8B E9 CD
0030 | B4 A2 08 97 49 C8 05 C9 18 BF 8F 42 BF 66 AE 86
0040 | 19 0A 9B CC 01 D1 31 9F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B8AE0B1BB98E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>4C000000</code> (76 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E9F0C90B74FD5E4CA867C6D175FCE756</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>03A227406B8BE9CDB4A2089749C805C9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>18BF8F42BF66AE86190A9BCC01D1319F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

