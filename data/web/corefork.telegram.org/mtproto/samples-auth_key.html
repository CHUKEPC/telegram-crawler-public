<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F4 AB 0E 00 BD DA 72 67
0010 | 14 00 00 00 F1 8E 7E BE B3 D5 9D 9C EE 7C 64 4C
0020 | 71 1B C8 71 27 BD 77 51</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F4AB0E00BDDA7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 48 97 39 BD DA 72 67
0010 | 50 00 00 00 63 24 16 05 B3 D5 9D 9C EE 7C 64 4C
0020 | 71 1B C8 71 27 BD 77 51 3E 68 57 B4 F1 68 D0 10
0030 | 17 F5 5E 80 A4 C3 DE D1 08 1A 88 21 89 E0 2D 1E
0040 | D5 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01489739BDDA7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081A882189E02D1ED5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1911814917874065109</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1911814917874065109</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1911814917874065109 = 1009278173 * 1894239833</code></p>
<pre><code>p = 1009278173
q = 1894239833</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1A 88 21 89 E0 2D 1E D5 00 00 00
0010 | 04 3C 28 5C DD 00 00 00 04 70 E7 CE 59 00 00 00
0020 | B3 D5 9D 9C EE 7C 64 4C 71 1B C8 71 27 BD 77 51
0030 | 3E 68 57 B4 F1 68 D0 10 17 F5 5E 80 A4 C3 DE D1
0040 | D5 45 77 A4 70 4A 61 82 AF C7 87 48 C7 0F AF 90
0050 | 14 E9 81 22 06 0B 8F 0C 42 18 E0 29 3F CC 75 EF
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081A882189E02D1ED5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1911814917874065109</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043C285CDD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1009278173</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0470E7CE59000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1894239833</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>D54577A4704A6182AFC78748C70FAF90</code> <code>14E98122060B8F0C4218E0293FCC75EF</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081A882189E02D1ED5000000043C285CDD0000000470E7CE59000000B3D59D9CEE7C644C711BC87127BD77513E6857B4F168D01017F55E80A4C3DED1D54577A4704A6182AFC78748C70FAF9014E98122060B8F0C4218E0293FCC75EF02000000
random_padding_bytes = 77FE96DD7337908B8BB7B8771B1A8334ED5283FD746C009138A58AA1D6BFDE7CAEABA1A7B8BEA7D0134105E25D385AD09118E28F451838AF8A081374D3D97EE4DB2DB093AEB4BEDD3E3643A5E2984D570911690E9B80AEBB32D2BF98</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 1B602A8E7167BF449E8951704E75D1B829FB9C344BD6212291A1331E4BEA11B1883C4C5D494123AC5B56F21490635F5FEF87E44B8619A27BE19B189425A59D3C8C4ADE529F9936E730A03957D0D4912FF296D5C2DC1A98CD464B00A3E9743179EE689D168EA62BD11B61419DC82A3B0B3B986A5869F9082CB8F045E9AEE8098CF1F621B9AD1D4CD89D3F5ECD0D07D26AE170038E7CD2928C55E8F0381FE334E64DF880F27AC7098200DE673CF801DA1FBC4590C251B741CB4ED1B6D1FB5C103AE6FC8D57A507437C8801B11B878E13544D27CE986AB7553CBB2F80794949A800E4C6E12A2A3B9138038953351C89E544A6231A0407CDF0F5CE55FE1B4E77C562</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F8 AB 0E 00 BD DA 72 67
0010 | 40 01 00 00 BE E4 12 D7 B3 D5 9D 9C EE 7C 64 4C
0020 | 71 1B C8 71 27 BD 77 51 3E 68 57 B4 F1 68 D0 10
0030 | 17 F5 5E 80 A4 C3 DE D1 04 3C 28 5C DD 00 00 00
0040 | 04 70 E7 CE 59 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 1B 60 2A 8E 71 67 BF 44 9E 89 51 70
0060 | 4E 75 D1 B8 29 FB 9C 34 4B D6 21 22 91 A1 33 1E
0070 | 4B EA 11 B1 88 3C 4C 5D 49 41 23 AC 5B 56 F2 14
0080 | 90 63 5F 5F EF 87 E4 4B 86 19 A2 7B E1 9B 18 94
0090 | 25 A5 9D 3C 8C 4A DE 52 9F 99 36 E7 30 A0 39 57
00A0 | D0 D4 91 2F F2 96 D5 C2 DC 1A 98 CD 46 4B 00 A3
00B0 | E9 74 31 79 EE 68 9D 16 8E A6 2B D1 1B 61 41 9D
00C0 | C8 2A 3B 0B 3B 98 6A 58 69 F9 08 2C B8 F0 45 E9
00D0 | AE E8 09 8C F1 F6 21 B9 AD 1D 4C D8 9D 3F 5E CD
00E0 | 0D 07 D2 6A E1 70 03 8E 7C D2 92 8C 55 E8 F0 38
00F0 | 1F E3 34 E6 4D F8 80 F2 7A C7 09 82 00 DE 67 3C
0100 | F8 01 DA 1F BC 45 90 C2 51 B7 41 CB 4E D1 B6 D1
0110 | FB 5C 10 3A E6 FC 8D 57 A5 07 43 7C 88 01 B1 1B
0120 | 87 8E 13 54 4D 27 CE 98 6A B7 55 3C BB 2F 80 79
0130 | 49 49 A8 00 E4 C6 E1 2A 2A 3B 91 38 03 89 53 35
0140 | 1C 89 E5 44 A6 23 1A 04 07 CD F0 F5 CE 55 FE 1B
0150 | 4E 77 C5 62</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F8AB0E00BDDA7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043C285CDD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1009278173</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0470E7CE59000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1894239833</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001001B602A8E7167BF449E895170</code> <code>4E75D1B829FB9C344BD6212291A1331E</code> <code>4BEA11B1883C4C5D494123AC5B56F214</code> <code>90635F5FEF87E44B8619A27BE19B1894</code> <code>25A59D3C8C4ADE529F9936E730A03957</code> <code>D0D4912FF296D5C2DC1A98CD464B00A3</code> <code>E9743179EE689D168EA62BD11B61419D</code> <code>C82A3B0B3B986A5869F9082CB8F045E9</code> <code>AEE8098CF1F621B9AD1D4CD89D3F5ECD</code> <code>0D07D26AE170038E7CD2928C55E8F038</code> <code>1FE334E64DF880F27AC7098200DE673C</code> <code>F801DA1FBC4590C251B741CB4ED1B6D1</code> <code>FB5C103AE6FC8D57A507437C8801B11B</code> <code>878E13544D27CE986AB7553CBB2F8079</code> <code>4949A800E4C6E12A2A3B913803895335</code> <code>1C89E544A6231A0407CDF0F5CE55FE1B</code><br> <code>4E77C562</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 18 F5 4F BD DA 72 67
0010 | 78 02 00 00 5C 07 E8 D0 B3 D5 9D 9C EE 7C 64 4C
0020 | 71 1B C8 71 27 BD 77 51 3E 68 57 B4 F1 68 D0 10
0030 | 17 F5 5E 80 A4 C3 DE D1 FE 50 02 00 7C C7 26 23
0040 | 15 8C AC 18 64 88 37 A7 01 78 8F 80 1A 34 01 68
0050 | A1 99 A0 CD D8 CA 33 5B 8C A5 14 81 90 0C EA 4F
0060 | C7 92 CA 71 AD 4E A1 6B 07 16 4B B5 4B 42 70 F9
0070 | 8A 3A 53 C8 DF 37 3F A0 AD 5C D2 FA B6 1D 01 27
0080 | AE 94 DF 95 BC 69 0F BE AA 45 1A 5A 9A C7 D4 25
0090 | C6 CB 3B FE 17 AC BA C1 43 4E 66 F1 E7 59 33 44
00A0 | 19 59 CE F3 EB 5D 5B 2A 1B 95 EF 00 A3 20 84 6B
00B0 | EB E2 74 A2 0C E8 D1 45 F4 84 72 7D 94 20 CE 43
00C0 | 13 84 17 44 E7 E1 3C 45 CE 30 A8 99 5E 16 74 36
00D0 | FF 33 0A 49 97 C9 97 A9 25 2B 81 46 09 7D 49 A7
00E0 | E1 A4 7B E0 73 D4 21 35 10 3D 4D 33 F8 77 43 06
00F0 | 8D B9 15 DA 93 0B DD 24 0A DB 6D D3 0C 2F FE F3
0100 | 56 4B 43 12 89 A5 D2 E7 D3 4E F7 04 E7 02 10 F8
0110 | 0A 1D 98 F5 65 DE 73 D8 C8 76 ED B6 9E 5F 85 84
0120 | 5D 92 B0 8B 8D D4 D2 88 EA 67 A1 EE D6 15 35 44
0130 | 32 5C 1A 0D D6 67 5D 47 05 7B 21 67 FF 59 F5 72
0140 | 53 6F 45 6B 1F 97 38 50 B9 30 D3 68 43 E1 97 9D
0150 | D8 FA FA 17 89 F1 C2 03 11 9A 59 6A B6 12 E3 43
0160 | 88 B7 0A DB 40 F8 88 93 04 78 80 5B 2F 20 D7 99
0170 | 60 A9 F9 B2 57 E8 59 0D 46 8B 67 52 16 3A EF 9D
0180 | C7 B4 63 40 24 52 69 68 41 7C 9C 0A 5A 70 6B 1B
0190 | C4 71 14 FE 4B D0 31 FE 50 35 C4 29 1B CF 28 BE
01A0 | F3 59 5C 65 4A A7 F0 C0 A4 05 C3 4E FC 33 F7 D7
01B0 | 3D 24 7C 28 8F 2B F0 B5 66 BF 66 4F 88 6F 9B 3C
01C0 | A8 9D AC 5C FB 28 F5 79 A4 7B B4 EA 6D DA 15 83
01D0 | 39 5E 4B 03 1A EB 3B 6D 4B BF 71 95 E0 8A CF 66
01E0 | AC 1A 56 1E 8E 9D 2E 69 81 F7 02 DA 21 52 EE 1A
01F0 | 1D CC 39 0C 85 D7 33 D1 AB 8E 24 F6 BF B4 54 86
0200 | 82 78 D2 5D F8 35 38 7E 34 F2 1A BC E8 15 F9 D7
0210 | B8 1E 76 5B 2D 87 22 2D F8 FA E4 BD 00 2B 9C 3F
0220 | 2C E4 3A F3 05 15 30 AF 83 96 7A 61 07 CE C7 A5
0230 | 34 FA 90 ED B6 DC 28 9D 0D 04 1C E8 B3 70 77 FB
0240 | 12 F7 33 A0 53 A5 7B 9E 74 34 7C 8C FB 4A 8E 23
0250 | EE A9 A6 DA B7 FF 6C C5 90 1E 73 36 D3 06 F9 9A
0260 | 4E F7 2F A5 0F 17 8C 4F 01 4B 97 20 EB 4F CD 07
0270 | A6 2C 8B 4A 40 DA 79 6C 39 40 4F FD B3 00 20 CF
0280 | C6 00 DA B3 00 64 D7 F8 AC 66 24 26</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0118F54FBDDA7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002007CC72623158CAC18648837A7</code> <code>01788F801A340168A199A0CDD8CA335B</code> <code>8CA51481900CEA4FC792CA71AD4EA16B</code> <code>07164BB54B4270F98A3A53C8DF373FA0</code> <code>AD5CD2FAB61D0127AE94DF95BC690FBE</code> <code>AA451A5A9AC7D425C6CB3BFE17ACBAC1</code> <code>434E66F1E75933441959CEF3EB5D5B2A</code> <code>1B95EF00A320846BEBE274A20CE8D145</code> <code>F484727D9420CE4313841744E7E13C45</code> <code>CE30A8995E167436FF330A4997C997A9</code> <code>252B8146097D49A7E1A47BE073D42135</code> <code>103D4D33F87743068DB915DA930BDD24</code> <code>0ADB6DD30C2FFEF3564B431289A5D2E7</code> <code>D34EF704E70210F80A1D98F565DE73D8</code> <code>C876EDB69E5F85845D92B08B8DD4D288</code> <code>EA67A1EED6153544325C1A0DD6675D47</code> <code>057B2167FF59F572536F456B1F973850</code> <code>B930D36843E1979DD8FAFA1789F1C203</code> <code>119A596AB612E34388B70ADB40F88893</code> <code>0478805B2F20D79960A9F9B257E8590D</code> <code>468B6752163AEF9DC7B4634024526968</code> <code>417C9C0A5A706B1BC47114FE4BD031FE</code> <code>5035C4291BCF28BEF3595C654AA7F0C0</code> <code>A405C34EFC33F7D73D247C288F2BF0B5</code> <code>66BF664F886F9B3CA89DAC5CFB28F579</code> <code>A47BB4EA6DDA1583395E4B031AEB3B6D</code> <code>4BBF7195E08ACF66AC1A561E8E9D2E69</code> <code>81F702DA2152EE1A1DCC390C85D733D1</code> <code>AB8E24F6BFB454868278D25DF835387E</code> <code>34F21ABCE815F9D7B81E765B2D87222D</code> <code>F8FAE4BD002B9C3F2CE43AF3051530AF</code> <code>83967A6107CEC7A534FA90EDB6DC289D</code> <code>0D041CE8B37077FB12F733A053A57B9E</code> <code>74347C8CFB4A8E23EEA9A6DAB7FF6CC5</code> <code>901E7336D306F99A4EF72FA50F178C4F</code> <code>014B9720EB4FCD07A62C8B4A40DA796C</code> <code>39404FFDB30020CFC600DAB30064D7F8</code><br> <code>AC662426</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 7CC72623158CAC18648837A701788F801A340168A199A0CDD8CA335B8CA51481900CEA4FC792CA71AD4EA16B07164BB54B4270F98A3A53C8DF373FA0AD5CD2FAB61D0127AE94DF95BC690FBEAA451A5A9AC7D425C6CB3BFE17ACBAC1434E66F1E75933441959CEF3EB5D5B2A1B95EF00A320846BEBE274A20CE8D145F484727D9420CE4313841744E7E13C45CE30A8995E167436FF330A4997C997A9252B8146097D49A7E1A47BE073D42135103D4D33F87743068DB915DA930BDD240ADB6DD30C2FFEF3564B431289A5D2E7D34EF704E70210F80A1D98F565DE73D8C876EDB69E5F85845D92B08B8DD4D288EA67A1EED6153544325C1A0DD6675D47057B2167FF59F572536F456B1F973850B930D36843E1979DD8FAFA1789F1C203119A596AB612E34388B70ADB40F888930478805B2F20D79960A9F9B257E8590D468B6752163AEF9DC7B4634024526968417C9C0A5A706B1BC47114FE4BD031FE5035C4291BCF28BEF3595C654AA7F0C0A405C34EFC33F7D73D247C288F2BF0B566BF664F886F9B3CA89DAC5CFB28F579A47BB4EA6DDA1583395E4B031AEB3B6D4BBF7195E08ACF66AC1A561E8E9D2E6981F702DA2152EE1A1DCC390C85D733D1AB8E24F6BFB454868278D25DF835387E34F21ABCE815F9D7B81E765B2D87222DF8FAE4BD002B9C3F2CE43AF3051530AF83967A6107CEC7A534FA90EDB6DC289D0D041CE8B37077FB12F733A053A57B9E74347C8CFB4A8E23EEA9A6DAB7FF6CC5901E7336D306F99A4EF72FA50F178C4F014B9720EB4FCD07A62C8B4A40DA796C39404FFDB30020CFC600DAB30064D7F8AC662426
tmp_aes_key = 1E23D895B57243B3F1C7B5EFA8953A185BE25564B44C08DF43BBD5FDFF6C0FB5
tmp_aes_iv = C7D0940B1475817020338B1C1B9A7AB2DBCE591F84C56EEE7E009C0AD54577A4</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 28DAF1694ABB06D21DC0B885FFF3E06D7C0F46C1BA0D89B5B3D59D9CEE7C644C711BC87127BD77513E6857B4F168D01017F55E80A4C3DED103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010062A4AB8469F8AB8145D64EE0CD9D8F0F9116765BDB25FF5D71A178F65BDBC4CE35D3FE9C39EE1E92F4EB37D134FE951E5A9BE04E9AEA912DD69FA9F757A86E736E606683CDF5C2D5EC325203B9FC2171B29F0CD2F54243F23CE88191B1F10CA94C5825B4D526B3C9031E12D2FC77AE20E20EC04B7A20EDF7A4C6F16FFAE7A91C158C0DE325AFE3387533D45520D5B310FF95F8ACA3A9A76165A6919B1D8932A451C93C55556BE32E40BB733EC5072FFD39BA1EA3D083EEAD6C394DD3BA16C19ED51B41B38D58BAE35DCE3F603017503D40D65A9D8797FA3D98CE653B9888C7EB04D50C481C417BB9E447542CA0C2BD9029749714EF335D1BDEECEDAA8D59DCCDBDDA72679694D11F6E0BAF6A
answer = BA0D89B5B3D59D9CEE7C644C711BC87127BD77513E6857B4F168D01017F55E80A4C3DED103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010062A4AB8469F8AB8145D64EE0CD9D8F0F9116765BDB25FF5D71A178F65BDBC4CE35D3FE9C39EE1E92F4EB37D134FE951E5A9BE04E9AEA912DD69FA9F757A86E736E606683CDF5C2D5EC325203B9FC2171B29F0CD2F54243F23CE88191B1F10CA94C5825B4D526B3C9031E12D2FC77AE20E20EC04B7A20EDF7A4C6F16FFAE7A91C158C0DE325AFE3387533D45520D5B310FF95F8ACA3A9A76165A6919B1D8932A451C93C55556BE32E40BB733EC5072FFD39BA1EA3D083EEAD6C394DD3BA16C19ED51B41B38D58BAE35DCE3F603017503D40D65A9D8797FA3D98CE653B9888C7EB04D50C481C417BB9E447542CA0C2BD9029749714EF335D1BDEECEDAA8D59DCCDBDDA72679694D11F6E0BAF6A</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 B3 D5 9D 9C EE 7C 64 4C 71 1B C8 71
0010 | 27 BD 77 51 3E 68 57 B4 F1 68 D0 10 17 F5 5E 80
0020 | A4 C3 DE D1 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 62 A4 AB 84 69 F8 AB 81 45 D6 4E E0 CD 9D 8F 0F
0140 | 91 16 76 5B DB 25 FF 5D 71 A1 78 F6 5B DB C4 CE
0150 | 35 D3 FE 9C 39 EE 1E 92 F4 EB 37 D1 34 FE 95 1E
0160 | 5A 9B E0 4E 9A EA 91 2D D6 9F A9 F7 57 A8 6E 73
0170 | 6E 60 66 83 CD F5 C2 D5 EC 32 52 03 B9 FC 21 71
0180 | B2 9F 0C D2 F5 42 43 F2 3C E8 81 91 B1 F1 0C A9
0190 | 4C 58 25 B4 D5 26 B3 C9 03 1E 12 D2 FC 77 AE 20
01A0 | E2 0E C0 4B 7A 20 ED F7 A4 C6 F1 6F FA E7 A9 1C
01B0 | 15 8C 0D E3 25 AF E3 38 75 33 D4 55 20 D5 B3 10
01C0 | FF 95 F8 AC A3 A9 A7 61 65 A6 91 9B 1D 89 32 A4
01D0 | 51 C9 3C 55 55 6B E3 2E 40 BB 73 3E C5 07 2F FD
01E0 | 39 BA 1E A3 D0 83 EE AD 6C 39 4D D3 BA 16 C1 9E
01F0 | D5 1B 41 B3 8D 58 BA E3 5D CE 3F 60 30 17 50 3D
0200 | 40 D6 5A 9D 87 97 FA 3D 98 CE 65 3B 98 88 C7 EB
0210 | 04 D5 0C 48 1C 41 7B B9 E4 47 54 2C A0 C2 BD 90
0220 | 29 74 97 14 EF 33 5D 1B DE EC ED AA 8D 59 DC CD
0230 | BD DA 72 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010062A4AB8469F8AB8145D64EE0</code> <code>CD9D8F0F9116765BDB25FF5D71A178F6</code> <code>5BDBC4CE35D3FE9C39EE1E92F4EB37D1</code> <code>34FE951E5A9BE04E9AEA912DD69FA9F7</code> <code>57A86E736E606683CDF5C2D5EC325203</code> <code>B9FC2171B29F0CD2F54243F23CE88191</code> <code>B1F10CA94C5825B4D526B3C9031E12D2</code> <code>FC77AE20E20EC04B7A20EDF7A4C6F16F</code> <code>FAE7A91C158C0DE325AFE3387533D455</code> <code>20D5B310FF95F8ACA3A9A76165A6919B</code> <code>1D8932A451C93C55556BE32E40BB733E</code> <code>C5072FFD39BA1EA3D083EEAD6C394DD3</code> <code>BA16C19ED51B41B38D58BAE35DCE3F60</code> <code>3017503D40D65A9D8797FA3D98CE653B</code> <code>9888C7EB04D50C481C417BB9E447542C</code> <code>A0C2BD9029749714EF335D1BDEECEDAA</code><br> <code>8D59DCCD</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>BDDA7267</code> (1735580349 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 8E4209B32970071591AE90455CC570C1B753CA50A387C39C98E4EAC3C46F907E63B2A7ED4749917CCF0E229DD6A8DD06735400FE8EF9A1296A5D48B03A9A81E1481BF7C3CDF8ECAFA565F45188A5EFD57C842EC906FADC990D8383D0EDB7E4B86E7F53DC8A9176C4198F3C9876F874052EBB3D010926A503DF83FCBB6A77FAA40A7530513B9C995EF7F6452A144959E85D11181E6A8534C8535C60D1D212B696930E446AFDE438DBD3E730E7DFE167D82D35E198B4289043643A3E02EFC31B2ED83E2F52EC0698A0E4548DCDA58C4E0EA2C42582C00C5D7B107756803536211C03D82AEF89E3FE30E351358911CCF9DE126F4A42EB2BCDD6ED14E72813F097C6</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4B2F9AE10F52FD6B09541D9994AA085F477376B4B6EB2A8D3EA418B68D91A21B2AE6BB6495208F275A28DEB412C03C3EF45ACA71C386CEDBB45060AD4A72975D040B464F09C03E671C7C43886C9F7ED91ACC732A1DB9EDE0EFE4CF59F7D3E5A1FF87D8FED88DC4F99781258053157BDF5D8559212716ACD6959FEFCE9A930D431AC0D9BE321ED09358CBBC04694F4791BC5F05EC0BB10E99738E09D865AEEC48AE160E16330A253CEFA173850F6B42BEE1E662B0A291A33170C0D2CFD3AD98A8F5E693BD9CAFB3D837CA3E4EB9C6505FE2679DF78741AE55D733C520C70FE0A02A6FCF484F4379BD33C4A5532D25782242972423C29F76CD33366EC1D7632B45</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 B3 D5 9D 9C EE 7C 64 4C 71 1B C8 71
0010 | 27 BD 77 51 3E 68 57 B4 F1 68 D0 10 17 F5 5E 80
0020 | A4 C3 DE D1 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 4B 2F 9A E1 0F 52 FD 6B 09 54 1D 99 94 AA 08 5F
0040 | 47 73 76 B4 B6 EB 2A 8D 3E A4 18 B6 8D 91 A2 1B
0050 | 2A E6 BB 64 95 20 8F 27 5A 28 DE B4 12 C0 3C 3E
0060 | F4 5A CA 71 C3 86 CE DB B4 50 60 AD 4A 72 97 5D
0070 | 04 0B 46 4F 09 C0 3E 67 1C 7C 43 88 6C 9F 7E D9
0080 | 1A CC 73 2A 1D B9 ED E0 EF E4 CF 59 F7 D3 E5 A1
0090 | FF 87 D8 FE D8 8D C4 F9 97 81 25 80 53 15 7B DF
00A0 | 5D 85 59 21 27 16 AC D6 95 9F EF CE 9A 93 0D 43
00B0 | 1A C0 D9 BE 32 1E D0 93 58 CB BC 04 69 4F 47 91
00C0 | BC 5F 05 EC 0B B1 0E 99 73 8E 09 D8 65 AE EC 48
00D0 | AE 16 0E 16 33 0A 25 3C EF A1 73 85 0F 6B 42 BE
00E0 | E1 E6 62 B0 A2 91 A3 31 70 C0 D2 CF D3 AD 98 A8
00F0 | F5 E6 93 BD 9C AF B3 D8 37 CA 3E 4E B9 C6 50 5F
0100 | E2 67 9D F7 87 41 AE 55 D7 33 C5 20 C7 0F E0 A0
0110 | 2A 6F CF 48 4F 43 79 BD 33 C4 A5 53 2D 25 78 22
0120 | 42 97 24 23 C2 9F 76 CD 33 36 6E C1 D7 63 2B 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004B2F9AE10F52FD6B09541D99</code> <code>94AA085F477376B4B6EB2A8D3EA418B6</code> <code>8D91A21B2AE6BB6495208F275A28DEB4</code> <code>12C03C3EF45ACA71C386CEDBB45060AD</code> <code>4A72975D040B464F09C03E671C7C4388</code> <code>6C9F7ED91ACC732A1DB9EDE0EFE4CF59</code> <code>F7D3E5A1FF87D8FED88DC4F997812580</code> <code>53157BDF5D8559212716ACD6959FEFCE</code> <code>9A930D431AC0D9BE321ED09358CBBC04</code> <code>694F4791BC5F05EC0BB10E99738E09D8</code> <code>65AEEC48AE160E16330A253CEFA17385</code> <code>0F6B42BEE1E662B0A291A33170C0D2CF</code> <code>D3AD98A8F5E693BD9CAFB3D837CA3E4E</code> <code>B9C6505FE2679DF78741AE55D733C520</code> <code>C70FE0A02A6FCF484F4379BD33C4A553</code> <code>2D25782242972423C29F76CD33366EC1</code><br> <code>D7632B45</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366B3D59D9CEE7C644C711BC87127BD77513E6857B4F168D01017F55E80A4C3DED10000000000000000FE0001004B2F9AE10F52FD6B09541D9994AA085F477376B4B6EB2A8D3EA418B68D91A21B2AE6BB6495208F275A28DEB412C03C3EF45ACA71C386CEDBB45060AD4A72975D040B464F09C03E671C7C43886C9F7ED91ACC732A1DB9EDE0EFE4CF59F7D3E5A1FF87D8FED88DC4F99781258053157BDF5D8559212716ACD6959FEFCE9A930D431AC0D9BE321ED09358CBBC04694F4791BC5F05EC0BB10E99738E09D865AEEC48AE160E16330A253CEFA173850F6B42BEE1E662B0A291A33170C0D2CFD3AD98A8F5E693BD9CAFB3D837CA3E4EB9C6505FE2679DF78741AE55D733C520C70FE0A02A6FCF484F4379BD33C4A5532D25782242972423C29F76CD33366EC1D7632B45
padding = 7DB0BBE643BE0223A15D8309
tmp_aes_key = 1E23D895B57243B3F1C7B5EFA8953A185BE25564B44C08DF43BBD5FDFF6C0FB5
tmp_aes_iv = C7D0940B1475817020338B1C1B9A7AB2DBCE591F84C56EEE7E009C0AD54577A4</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = F1CC5ECB3F4ED333465CEDE888F4BA4415D1DDE9D9182E2014D10407C21E36F9EA191890925A74170B0CC505CCA28F8B380D1052A1A9AFFD25D362BBE8269C5C31546C1007F07ED2E1BD976B7D3C2FCC79AF6EE2551457BABDDDEFF6B5CC329B26FE09ECE75238EF8BC55A5393861F16F793DAD379437627423E532FC24B5EAD7CEA67619079240A639EDD675AE8763401652D3FDE54F302F4C29CFD51159EC9B99812A0A8F05EC40ED6D09442DA6E9FC8A3D61F9C8939D35B08F25AAD254189C88EDA3540611E69CC4E7D145B521F0BE7813826DAB812D975B5C97BF09D6343C176D847199958E08035E9C774BAF1B7D36A897FCA9C0F0701A0C56A06D7D9DE93BFE4EB57D7AE9D3454AD2FD3356947BA86C484A180A1D7613F5C958497781C3A08BC7ECFFF76F9F26D2F87C17249DE31B5E7AA7DDF6DF3FDFF06767A44DEDE0B39926A5E03E975ECB9CE4E6EAA0FF8</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 FC AB 0E 00 BD DA 72 67
0010 | 78 01 00 00 1F 5F 04 F5 B3 D5 9D 9C EE 7C 64 4C
0020 | 71 1B C8 71 27 BD 77 51 3E 68 57 B4 F1 68 D0 10
0030 | 17 F5 5E 80 A4 C3 DE D1 FE 50 01 00 F1 CC 5E CB
0040 | 3F 4E D3 33 46 5C ED E8 88 F4 BA 44 15 D1 DD E9
0050 | D9 18 2E 20 14 D1 04 07 C2 1E 36 F9 EA 19 18 90
0060 | 92 5A 74 17 0B 0C C5 05 CC A2 8F 8B 38 0D 10 52
0070 | A1 A9 AF FD 25 D3 62 BB E8 26 9C 5C 31 54 6C 10
0080 | 07 F0 7E D2 E1 BD 97 6B 7D 3C 2F CC 79 AF 6E E2
0090 | 55 14 57 BA BD DD EF F6 B5 CC 32 9B 26 FE 09 EC
00A0 | E7 52 38 EF 8B C5 5A 53 93 86 1F 16 F7 93 DA D3
00B0 | 79 43 76 27 42 3E 53 2F C2 4B 5E AD 7C EA 67 61
00C0 | 90 79 24 0A 63 9E DD 67 5A E8 76 34 01 65 2D 3F
00D0 | DE 54 F3 02 F4 C2 9C FD 51 15 9E C9 B9 98 12 A0
00E0 | A8 F0 5E C4 0E D6 D0 94 42 DA 6E 9F C8 A3 D6 1F
00F0 | 9C 89 39 D3 5B 08 F2 5A AD 25 41 89 C8 8E DA 35
0100 | 40 61 1E 69 CC 4E 7D 14 5B 52 1F 0B E7 81 38 26
0110 | DA B8 12 D9 75 B5 C9 7B F0 9D 63 43 C1 76 D8 47
0120 | 19 99 58 E0 80 35 E9 C7 74 BA F1 B7 D3 6A 89 7F
0130 | CA 9C 0F 07 01 A0 C5 6A 06 D7 D9 DE 93 BF E4 EB
0140 | 57 D7 AE 9D 34 54 AD 2F D3 35 69 47 BA 86 C4 84
0150 | A1 80 A1 D7 61 3F 5C 95 84 97 78 1C 3A 08 BC 7E
0160 | CF FF 76 F9 F2 6D 2F 87 C1 72 49 DE 31 B5 E7 AA
0170 | 7D DF 6D F3 FD FF 06 76 7A 44 DE DE 0B 39 92 6A
0180 | 5E 03 E9 75 EC B9 CE 4E 6E AA 0F F8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>FCAB0E00BDDA7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100F1CC5ECB3F4ED333465CEDE8</code> <code>88F4BA4415D1DDE9D9182E2014D10407</code> <code>C21E36F9EA191890925A74170B0CC505</code> <code>CCA28F8B380D1052A1A9AFFD25D362BB</code> <code>E8269C5C31546C1007F07ED2E1BD976B</code> <code>7D3C2FCC79AF6EE2551457BABDDDEFF6</code> <code>B5CC329B26FE09ECE75238EF8BC55A53</code> <code>93861F16F793DAD379437627423E532F</code> <code>C24B5EAD7CEA67619079240A639EDD67</code> <code>5AE8763401652D3FDE54F302F4C29CFD</code> <code>51159EC9B99812A0A8F05EC40ED6D094</code> <code>42DA6E9FC8A3D61F9C8939D35B08F25A</code> <code>AD254189C88EDA3540611E69CC4E7D14</code> <code>5B521F0BE7813826DAB812D975B5C97B</code> <code>F09D6343C176D847199958E08035E9C7</code> <code>74BAF1B7D36A897FCA9C0F0701A0C56A</code> <code>06D7D9DE93BFE4EB57D7AE9D3454AD2F</code> <code>D3356947BA86C484A180A1D7613F5C95</code> <code>8497781C3A08BC7ECFFF76F9F26D2F87</code> <code>C17249DE31B5E7AA7DDF6DF3FDFF0676</code> <code>7A44DEDE0B39926A5E03E975ECB9CE4E</code><br> <code>6EAA0FF8</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 060E9F45ABF40E12642C01A6C20B89801F0D14AC4ED656ECB05EFB3E1F520A732BE5A30E6A8886CD10C0D864154CB90B034C96A843744736AED95B52AA844613B737750891DD478C5078858A921039CCC5E40415E0B3D06BF0FEBBBF86AA3A3C9DE4B24AE06BEEEC0E5C1C6FF9450C8F583B434A9B468958CE5A8B1D5CA5C092BF0DEF0CFB46F7A379EF79DEA388DFF08168947AC18B40713D55FDC8601B212C382DFC58AECE848153A525D5171671FFF02FA3F31CCF525E2D020FD91F60CA6A2B01ADCBAF9B1318BC93E9BDC6DB6CECC940C7F86A9C139753E5D418DC8F4AF88AC96B95E1B3861481A9702993CDF9E96068EECA26E120B47AAC3737647C9EBD</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C 14 74 BE DA 72 67
0010 | 34 00 00 00 34 F7 CB 3B B3 D5 9D 9C EE 7C 64 4C
0020 | 71 1B C8 71 27 BD 77 51 3E 68 57 B4 F1 68 D0 10
0030 | 17 F5 5E 80 A4 C3 DE D1 4D 1C F7 C8 51 6C FF DD
0040 | BD 69 8F D8 84 4E B6 BF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019C1474BEDA7267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>B3D59D9CEE7C644C711BC87127BD7751</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3E6857B4F168D01017F55E80A4C3DED1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4D1CF7C8516CFFDDBD698FD8844EB6BF</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

