<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F4 FE 0C 00 03 D7 38 67
0010 | 14 00 00 00 F1 8E 7E BE 9A 5B A4 1B 3D 34 52 05
0020 | 97 27 4D F2 D3 77 B5 20</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F4FE0C0003D73867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 4C 00 CA 03 D7 38 67
0010 | 50 00 00 00 63 24 16 05 9A 5B A4 1B 3D 34 52 05
0020 | 97 27 4D F2 D3 77 B5 20 2D 4F 3B FC C9 F3 A6 C2
0030 | D6 A5 FD 96 13 D8 97 9B 08 22 7D B0 86 B4 19 39
0040 | E9 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014C00CA03D73867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08227DB086B41939E9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2485336661972040169</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2485336661972040169</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2485336661972040169 = 1305374701 * 1903925869</code></p>
<pre><code>p = 1305374701
q = 1903925869</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 22 7D B0 86 B4 19 39 E9 00 00 00
0010 | 04 4D CE 6F ED 00 00 00 04 71 7B 9A 6D 00 00 00
0020 | 9A 5B A4 1B 3D 34 52 05 97 27 4D F2 D3 77 B5 20
0030 | 2D 4F 3B FC C9 F3 A6 C2 D6 A5 FD 96 13 D8 97 9B
0040 | F1 9B 19 37 87 16 9A 9F A5 76 B0 40 94 EB 94 5D
0050 | DE 45 05 D5 A8 F2 1B F2 B2 43 CD B9 F4 51 EF 90
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08227DB086B41939E9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2485336661972040169</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044DCE6FED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1305374701</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04717B9A6D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1903925869</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>F19B193787169A9FA576B04094EB945D</code> <code>DE4505D5A8F21BF2B243CDB9F451EF90</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908227DB086B41939E9000000044DCE6FED00000004717B9A6D0000009A5BA41B3D34520597274DF2D377B5202D4F3BFCC9F3A6C2D6A5FD9613D8979BF19B193787169A9FA576B04094EB945DDE4505D5A8F21BF2B243CDB9F451EF9002000000
random_padding_bytes = 737F0EDCF6715AE78A3F73A045C58BAD897322FC4E01CEDBD4BEB2B67CA12D68F6C5BB00333C2C65AB54C0BB1F1C10D80899B8DF32BF1D82E912748F4B55C55DAA4949F4D00C9C6989CD45642BA79039DBE15CF7846A62AE6EE3F3EE</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 331AE866F377D9C51531B8BAEE08A181B7332769B1B24C120F79D70DE9E5A6EC13AD2777FC02BDE2267248187CE3EBCE0B7B67D8C1C6458269B4B759B4AB6E91BB60EE0539256A73A307D3AF98C2F52B048620B59B033E3ECCC7ED0BF453D25AFBDC7B1B35313181E6D8864942F254B7B5B7601FE008BE339A2CD16496114F088EE3F87D6F0ACE729B920898C252210CDFBB5127E17493AAFB7466B832A068992FF1266E30A1402555E29EAA945BE35D7DAA56EFAC0D85547723E831DD435CD52B7C1C47F23F8325ECAF1995F46044577A08632B5FE4F8115F4C4F790096207FA69316F83318B2720DCA7785D3BA657F096DF42CB8B00B844EA714D815426B25</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F8 FE 0C 00 03 D7 38 67
0010 | 40 01 00 00 BE E4 12 D7 9A 5B A4 1B 3D 34 52 05
0020 | 97 27 4D F2 D3 77 B5 20 2D 4F 3B FC C9 F3 A6 C2
0030 | D6 A5 FD 96 13 D8 97 9B 04 4D CE 6F ED 00 00 00
0040 | 04 71 7B 9A 6D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 33 1A E8 66 F3 77 D9 C5 15 31 B8 BA
0060 | EE 08 A1 81 B7 33 27 69 B1 B2 4C 12 0F 79 D7 0D
0070 | E9 E5 A6 EC 13 AD 27 77 FC 02 BD E2 26 72 48 18
0080 | 7C E3 EB CE 0B 7B 67 D8 C1 C6 45 82 69 B4 B7 59
0090 | B4 AB 6E 91 BB 60 EE 05 39 25 6A 73 A3 07 D3 AF
00A0 | 98 C2 F5 2B 04 86 20 B5 9B 03 3E 3E CC C7 ED 0B
00B0 | F4 53 D2 5A FB DC 7B 1B 35 31 31 81 E6 D8 86 49
00C0 | 42 F2 54 B7 B5 B7 60 1F E0 08 BE 33 9A 2C D1 64
00D0 | 96 11 4F 08 8E E3 F8 7D 6F 0A CE 72 9B 92 08 98
00E0 | C2 52 21 0C DF BB 51 27 E1 74 93 AA FB 74 66 B8
00F0 | 32 A0 68 99 2F F1 26 6E 30 A1 40 25 55 E2 9E AA
0100 | 94 5B E3 5D 7D AA 56 EF AC 0D 85 54 77 23 E8 31
0110 | DD 43 5C D5 2B 7C 1C 47 F2 3F 83 25 EC AF 19 95
0120 | F4 60 44 57 7A 08 63 2B 5F E4 F8 11 5F 4C 4F 79
0130 | 00 96 20 7F A6 93 16 F8 33 18 B2 72 0D CA 77 85
0140 | D3 BA 65 7F 09 6D F4 2C B8 B0 0B 84 4E A7 14 D8
0150 | 15 42 6B 25</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F8FE0C0003D73867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044DCE6FED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1305374701</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04717B9A6D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1903925869</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100331AE866F377D9C51531B8BA</code> <code>EE08A181B7332769B1B24C120F79D70D</code> <code>E9E5A6EC13AD2777FC02BDE226724818</code> <code>7CE3EBCE0B7B67D8C1C6458269B4B759</code> <code>B4AB6E91BB60EE0539256A73A307D3AF</code> <code>98C2F52B048620B59B033E3ECCC7ED0B</code> <code>F453D25AFBDC7B1B35313181E6D88649</code> <code>42F254B7B5B7601FE008BE339A2CD164</code> <code>96114F088EE3F87D6F0ACE729B920898</code> <code>C252210CDFBB5127E17493AAFB7466B8</code> <code>32A068992FF1266E30A1402555E29EAA</code> <code>945BE35D7DAA56EFAC0D85547723E831</code> <code>DD435CD52B7C1C47F23F8325ECAF1995</code> <code>F46044577A08632B5FE4F8115F4C4F79</code> <code>0096207FA69316F83318B2720DCA7785</code> <code>D3BA657F096DF42CB8B00B844EA714D8</code><br> <code>15426B25</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F4 2E EB 03 D7 38 67
0010 | 78 02 00 00 5C 07 E8 D0 9A 5B A4 1B 3D 34 52 05
0020 | 97 27 4D F2 D3 77 B5 20 2D 4F 3B FC C9 F3 A6 C2
0030 | D6 A5 FD 96 13 D8 97 9B FE 50 02 00 46 CC 6E 91
0040 | 84 C8 07 08 31 C3 87 4E DC A1 FF 0C 87 F5 EB 43
0050 | B6 2B 77 2D 3A 40 87 38 F9 32 38 4D F4 77 8B 22
0060 | 0D 8F D4 6A EE C5 6C 76 78 83 8C 6A 10 4C B9 DF
0070 | 2B D9 B7 48 3A 8E 4F 1E 2A D5 C0 7F C8 84 57 72
0080 | B5 EE DD EA A5 CE 10 95 98 F4 F6 63 D2 5A 79 F8
0090 | 63 98 DE 73 6F 28 6E 9E E0 12 79 F4 20 7F 43 94
00A0 | 43 46 56 E1 13 7D 6C D8 1A F4 6E 32 0E 58 6A D8
00B0 | 9A C7 35 37 AB 24 86 F5 0D D6 C9 9C 2B 40 5A 83
00C0 | 96 FC B8 06 4B 46 8F E6 60 DF A8 27 6A 3D 8B 9E
00D0 | 67 BA 51 30 5A 3E 29 FD D6 7D F9 22 83 2D 1A A5
00E0 | 70 A8 BD C0 94 78 3E 77 CB CB 2A A5 CF 6C 15 59
00F0 | 5F C7 32 AF DE 08 C8 76 58 56 A7 D3 FC A3 22 55
0100 | DA 2F 20 4D 14 21 61 12 6B 4D 51 69 CC 2B FD 1F
0110 | 2E B0 86 56 26 F6 02 0C 1D 5C 9B BB AA 4F 1B 12
0120 | 12 4A E0 32 4B FA 9E 6A C5 9E 40 A1 95 24 86 D4
0130 | D3 A6 B9 3B AB C5 A1 13 24 45 FE FD CA 3D C8 47
0140 | 73 D3 E3 E7 A9 15 96 C1 C1 67 09 A8 1F A9 74 C8
0150 | F1 28 F5 34 33 CD A3 89 D3 F4 84 11 2E 42 89 5F
0160 | 99 3E 1E 4D B8 D1 F6 41 B6 37 7D C6 38 D4 DE 2E
0170 | 79 80 C0 D3 D0 33 EC 28 79 C8 80 70 11 AD 52 5B
0180 | 5D 8D F8 75 AE 12 0B BF 1B 0B BE CE 6D D4 0C D1
0190 | 40 4C B3 E8 59 2E BC DE C5 F1 63 DA EF 67 F1 11
01A0 | 74 C0 92 E0 61 41 7D 73 B8 5C E1 54 93 B9 E7 C7
01B0 | B2 88 E7 AB D0 23 0C 96 00 22 EB 97 2B 51 17 22
01C0 | 89 10 AD 90 1B A5 B5 C7 BF D0 D8 6D 4A 45 49 B5
01D0 | 81 DC 37 6C 59 B1 32 60 6F 7E 7F D7 F9 6D AD 3D
01E0 | 71 04 AB 26 F9 15 5C 13 FC 10 71 BE 04 C8 CF D1
01F0 | 25 9C BC 55 7D 3D 54 DB B5 17 C7 A4 C4 D1 63 52
0200 | 78 23 99 14 63 72 9C 03 25 B0 5F 01 05 FB 47 6A
0210 | 9B 75 6C 44 7A 82 11 7B A8 1C CC AA 38 93 31 CC
0220 | C7 88 B4 DC 0D ED 79 8C 78 63 EB 22 EC 30 C2 69
0230 | 76 DC 3E 69 F4 4A 8D 40 74 0D FF 72 D6 D6 B4 2E
0240 | 49 2A FE 93 7A 34 33 F3 2A CF 4F 1C AC FB FE 2B
0250 | C3 A7 80 45 C0 BF 4B 34 46 F2 41 1A 8D 84 7D 20
0260 | 66 3F C4 72 4F 57 3C 95 A5 66 94 49 33 22 1A 73
0270 | A7 B5 CB 1E 92 3A E5 8C 2A 0B AE E2 FD 23 B8 5A
0280 | A3 65 B3 A2 19 3B 36 55 74 23 44 B5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F42EEB03D73867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020046CC6E9184C8070831C3874E</code> <code>DCA1FF0C87F5EB43B62B772D3A408738</code> <code>F932384DF4778B220D8FD46AEEC56C76</code> <code>78838C6A104CB9DF2BD9B7483A8E4F1E</code> <code>2AD5C07FC8845772B5EEDDEAA5CE1095</code> <code>98F4F663D25A79F86398DE736F286E9E</code> <code>E01279F4207F4394434656E1137D6CD8</code> <code>1AF46E320E586AD89AC73537AB2486F5</code> <code>0DD6C99C2B405A8396FCB8064B468FE6</code> <code>60DFA8276A3D8B9E67BA51305A3E29FD</code> <code>D67DF922832D1AA570A8BDC094783E77</code> <code>CBCB2AA5CF6C15595FC732AFDE08C876</code> <code>5856A7D3FCA32255DA2F204D14216112</code> <code>6B4D5169CC2BFD1F2EB0865626F6020C</code> <code>1D5C9BBBAA4F1B12124AE0324BFA9E6A</code> <code>C59E40A1952486D4D3A6B93BABC5A113</code> <code>2445FEFDCA3DC84773D3E3E7A91596C1</code> <code>C16709A81FA974C8F128F53433CDA389</code> <code>D3F484112E42895F993E1E4DB8D1F641</code> <code>B6377DC638D4DE2E7980C0D3D033EC28</code> <code>79C8807011AD525B5D8DF875AE120BBF</code> <code>1B0BBECE6DD40CD1404CB3E8592EBCDE</code> <code>C5F163DAEF67F11174C092E061417D73</code> <code>B85CE15493B9E7C7B288E7ABD0230C96</code> <code>0022EB972B5117228910AD901BA5B5C7</code> <code>BFD0D86D4A4549B581DC376C59B13260</code> <code>6F7E7FD7F96DAD3D7104AB26F9155C13</code> <code>FC1071BE04C8CFD1259CBC557D3D54DB</code> <code>B517C7A4C4D163527823991463729C03</code> <code>25B05F0105FB476A9B756C447A82117B</code> <code>A81CCCAA389331CCC788B4DC0DED798C</code> <code>7863EB22EC30C26976DC3E69F44A8D40</code> <code>740DFF72D6D6B42E492AFE937A3433F3</code> <code>2ACF4F1CACFBFE2BC3A78045C0BF4B34</code> <code>46F2411A8D847D20663FC4724F573C95</code> <code>A566944933221A73A7B5CB1E923AE58C</code> <code>2A0BAEE2FD23B85AA365B3A2193B3655</code><br> <code>742344B5</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 46CC6E9184C8070831C3874EDCA1FF0C87F5EB43B62B772D3A408738F932384DF4778B220D8FD46AEEC56C7678838C6A104CB9DF2BD9B7483A8E4F1E2AD5C07FC8845772B5EEDDEAA5CE109598F4F663D25A79F86398DE736F286E9EE01279F4207F4394434656E1137D6CD81AF46E320E586AD89AC73537AB2486F50DD6C99C2B405A8396FCB8064B468FE660DFA8276A3D8B9E67BA51305A3E29FDD67DF922832D1AA570A8BDC094783E77CBCB2AA5CF6C15595FC732AFDE08C8765856A7D3FCA32255DA2F204D142161126B4D5169CC2BFD1F2EB0865626F6020C1D5C9BBBAA4F1B12124AE0324BFA9E6AC59E40A1952486D4D3A6B93BABC5A1132445FEFDCA3DC84773D3E3E7A91596C1C16709A81FA974C8F128F53433CDA389D3F484112E42895F993E1E4DB8D1F641B6377DC638D4DE2E7980C0D3D033EC2879C8807011AD525B5D8DF875AE120BBF1B0BBECE6DD40CD1404CB3E8592EBCDEC5F163DAEF67F11174C092E061417D73B85CE15493B9E7C7B288E7ABD0230C960022EB972B5117228910AD901BA5B5C7BFD0D86D4A4549B581DC376C59B132606F7E7FD7F96DAD3D7104AB26F9155C13FC1071BE04C8CFD1259CBC557D3D54DBB517C7A4C4D163527823991463729C0325B05F0105FB476A9B756C447A82117BA81CCCAA389331CCC788B4DC0DED798C7863EB22EC30C26976DC3E69F44A8D40740DFF72D6D6B42E492AFE937A3433F32ACF4F1CACFBFE2BC3A78045C0BF4B3446F2411A8D847D20663FC4724F573C95A566944933221A73A7B5CB1E923AE58C2A0BAEE2FD23B85AA365B3A2193B3655742344B5
tmp_aes_key = 43304FF1FC6B7BAF07DB39696A08365AB6194F59460F1E6C4B1605F765C86676
tmp_aes_iv = 1F93981C89E1ADACE692CC4BDBD2738BA309C47BDCB3B90907074E7CF19B1937</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 16C0C99B915CE6D6DACF77CC3E07D4692C522D4DBA0D89B59A5BA41B3D34520597274DF2D377B5202D4F3BFCC9F3A6C2D6A5FD9613D8979B03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005CCC288C6903A793C0A53F04A570DCDBD3CA139421500CF06E1B37E2D5139E6CF728A16D07311EF980A3CAC80E37E51AA1FC459F472F0186F2B7F1E8270540B43CF34048ADA93BC160793F04D06BE2D4F49F3578E7665C23D4077A0DF03E3E71BC0F1FC0987DD4C100CB4DC9D2DDCF8F36A5D59C2197313AADF3E7E90F21DB08492D1E3BD7AD1BE2AF0913F3434443B9FE1E44393087A99EE50325A83027CF79609DF108F1544CF228263A073DC4CAC37ED9D1B843BACD23F2FC3426F39604015AC45BF1A255609DD1790CCF93D2183B20B8339AD27E9991C012CAC55D6FA12883440745340DF5B5D67C0BE9B2A45DFFB28BFDA5B147F34017594255F6FF279903D7386706263D9E00FD6324
answer = BA0D89B59A5BA41B3D34520597274DF2D377B5202D4F3BFCC9F3A6C2D6A5FD9613D8979B03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005CCC288C6903A793C0A53F04A570DCDBD3CA139421500CF06E1B37E2D5139E6CF728A16D07311EF980A3CAC80E37E51AA1FC459F472F0186F2B7F1E8270540B43CF34048ADA93BC160793F04D06BE2D4F49F3578E7665C23D4077A0DF03E3E71BC0F1FC0987DD4C100CB4DC9D2DDCF8F36A5D59C2197313AADF3E7E90F21DB08492D1E3BD7AD1BE2AF0913F3434443B9FE1E44393087A99EE50325A83027CF79609DF108F1544CF228263A073DC4CAC37ED9D1B843BACD23F2FC3426F39604015AC45BF1A255609DD1790CCF93D2183B20B8339AD27E9991C012CAC55D6FA12883440745340DF5B5D67C0BE9B2A45DFFB28BFDA5B147F34017594255F6FF279903D7386706263D9E00FD6324</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 9A 5B A4 1B 3D 34 52 05 97 27 4D F2
0010 | D3 77 B5 20 2D 4F 3B FC C9 F3 A6 C2 D6 A5 FD 96
0020 | 13 D8 97 9B 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 5C CC 28 8C 69 03 A7 93 C0 A5 3F 04 A5 70 DC DB
0140 | D3 CA 13 94 21 50 0C F0 6E 1B 37 E2 D5 13 9E 6C
0150 | F7 28 A1 6D 07 31 1E F9 80 A3 CA C8 0E 37 E5 1A
0160 | A1 FC 45 9F 47 2F 01 86 F2 B7 F1 E8 27 05 40 B4
0170 | 3C F3 40 48 AD A9 3B C1 60 79 3F 04 D0 6B E2 D4
0180 | F4 9F 35 78 E7 66 5C 23 D4 07 7A 0D F0 3E 3E 71
0190 | BC 0F 1F C0 98 7D D4 C1 00 CB 4D C9 D2 DD CF 8F
01A0 | 36 A5 D5 9C 21 97 31 3A AD F3 E7 E9 0F 21 DB 08
01B0 | 49 2D 1E 3B D7 AD 1B E2 AF 09 13 F3 43 44 43 B9
01C0 | FE 1E 44 39 30 87 A9 9E E5 03 25 A8 30 27 CF 79
01D0 | 60 9D F1 08 F1 54 4C F2 28 26 3A 07 3D C4 CA C3
01E0 | 7E D9 D1 B8 43 BA CD 23 F2 FC 34 26 F3 96 04 01
01F0 | 5A C4 5B F1 A2 55 60 9D D1 79 0C CF 93 D2 18 3B
0200 | 20 B8 33 9A D2 7E 99 91 C0 12 CA C5 5D 6F A1 28
0210 | 83 44 07 45 34 0D F5 B5 D6 7C 0B E9 B2 A4 5D FF
0220 | B2 8B FD A5 B1 47 F3 40 17 59 42 55 F6 FF 27 99
0230 | 03 D7 38 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001005CCC288C6903A793C0A53F04</code> <code>A570DCDBD3CA139421500CF06E1B37E2</code> <code>D5139E6CF728A16D07311EF980A3CAC8</code> <code>0E37E51AA1FC459F472F0186F2B7F1E8</code> <code>270540B43CF34048ADA93BC160793F04</code> <code>D06BE2D4F49F3578E7665C23D4077A0D</code> <code>F03E3E71BC0F1FC0987DD4C100CB4DC9</code> <code>D2DDCF8F36A5D59C2197313AADF3E7E9</code> <code>0F21DB08492D1E3BD7AD1BE2AF0913F3</code> <code>434443B9FE1E44393087A99EE50325A8</code> <code>3027CF79609DF108F1544CF228263A07</code> <code>3DC4CAC37ED9D1B843BACD23F2FC3426</code> <code>F39604015AC45BF1A255609DD1790CCF</code> <code>93D2183B20B8339AD27E9991C012CAC5</code> <code>5D6FA12883440745340DF5B5D67C0BE9</code> <code>B2A45DFFB28BFDA5B147F34017594255</code><br> <code>F6FF2799</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>03D73867</code> (1731778307 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = E6616A623C7773B393C821A08F715B250A8F5C5116FA3995ECE8268D55D47C02406FE3638F03F9B1F013415E3C3B7547658A4683C6BE90043A6179B46CA7600CFCD8389819E88562A0FA4096C09D40783255F3938D5835E25ED3F489821AFB8F5E6AC15EFD22CE9E2454BD475D5AD2870B38FE713F38431F6547DF6F1F01F6674572AEEE075B37FEEE562E0D8C12AF262F9C22E2986D82F59B799CE5269C7048B395702577D1457EEB4FDF1D857D616562F7B854EAD8482D185017691A244F41D965AB2F84B25C9271AD04AE3AA5D1118A98767C0571301E71266DC55152503E721B5B506D45F790418361EE174E1E0831A27189FB46A59488664BAB8E44EF60</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 905BB047A141C068AD84271294378C6A5D7BE8A079C83FAF527490FF7E24A6C865C88B3EA86524E0D3DC831CCD98429AFFE729C3BBDDE4F194623C998D79DFCFD26E79D84528F61E8BCAF89288A6464F7D7A60026BA6AEA4C4932F17A2798F0202D7B9F94D791878E362865B8069CFEFD78B9B7DAE75A5D68C811C207F2BBE19DC2B72967735BB6E1EED93AD2BAE379C88582CC0970AC79A62D7CE5BA31195709E13E0F84E950EDF4B85E1BF1EE5109E933C4E0DA0822BC20B0EB2EB55D8EBF8C14CD143627B9D3BCCF1075757E0EB369F9BA42FC2036D89B77B6546D3E7EB6E62CBEF6A5B1B9B562A9DA9D42C6DA2DC0B8C94D9A30397628670996368961C97</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 9A 5B A4 1B 3D 34 52 05 97 27 4D F2
0010 | D3 77 B5 20 2D 4F 3B FC C9 F3 A6 C2 D6 A5 FD 96
0020 | 13 D8 97 9B 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 90 5B B0 47 A1 41 C0 68 AD 84 27 12 94 37 8C 6A
0040 | 5D 7B E8 A0 79 C8 3F AF 52 74 90 FF 7E 24 A6 C8
0050 | 65 C8 8B 3E A8 65 24 E0 D3 DC 83 1C CD 98 42 9A
0060 | FF E7 29 C3 BB DD E4 F1 94 62 3C 99 8D 79 DF CF
0070 | D2 6E 79 D8 45 28 F6 1E 8B CA F8 92 88 A6 46 4F
0080 | 7D 7A 60 02 6B A6 AE A4 C4 93 2F 17 A2 79 8F 02
0090 | 02 D7 B9 F9 4D 79 18 78 E3 62 86 5B 80 69 CF EF
00A0 | D7 8B 9B 7D AE 75 A5 D6 8C 81 1C 20 7F 2B BE 19
00B0 | DC 2B 72 96 77 35 BB 6E 1E ED 93 AD 2B AE 37 9C
00C0 | 88 58 2C C0 97 0A C7 9A 62 D7 CE 5B A3 11 95 70
00D0 | 9E 13 E0 F8 4E 95 0E DF 4B 85 E1 BF 1E E5 10 9E
00E0 | 93 3C 4E 0D A0 82 2B C2 0B 0E B2 EB 55 D8 EB F8
00F0 | C1 4C D1 43 62 7B 9D 3B CC F1 07 57 57 E0 EB 36
0100 | 9F 9B A4 2F C2 03 6D 89 B7 7B 65 46 D3 E7 EB 6E
0110 | 62 CB EF 6A 5B 1B 9B 56 2A 9D A9 D4 2C 6D A2 DC
0120 | 0B 8C 94 D9 A3 03 97 62 86 70 99 63 68 96 1C 97</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100905BB047A141C068AD842712</code> <code>94378C6A5D7BE8A079C83FAF527490FF</code> <code>7E24A6C865C88B3EA86524E0D3DC831C</code> <code>CD98429AFFE729C3BBDDE4F194623C99</code> <code>8D79DFCFD26E79D84528F61E8BCAF892</code> <code>88A6464F7D7A60026BA6AEA4C4932F17</code> <code>A2798F0202D7B9F94D791878E362865B</code> <code>8069CFEFD78B9B7DAE75A5D68C811C20</code> <code>7F2BBE19DC2B72967735BB6E1EED93AD</code> <code>2BAE379C88582CC0970AC79A62D7CE5B</code> <code>A31195709E13E0F84E950EDF4B85E1BF</code> <code>1EE5109E933C4E0DA0822BC20B0EB2EB</code> <code>55D8EBF8C14CD143627B9D3BCCF10757</code> <code>57E0EB369F9BA42FC2036D89B77B6546</code> <code>D3E7EB6E62CBEF6A5B1B9B562A9DA9D4</code> <code>2C6DA2DC0B8C94D9A303976286709963</code><br> <code>68961C97</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643669A5BA41B3D34520597274DF2D377B5202D4F3BFCC9F3A6C2D6A5FD9613D8979B0000000000000000FE000100905BB047A141C068AD84271294378C6A5D7BE8A079C83FAF527490FF7E24A6C865C88B3EA86524E0D3DC831CCD98429AFFE729C3BBDDE4F194623C998D79DFCFD26E79D84528F61E8BCAF89288A6464F7D7A60026BA6AEA4C4932F17A2798F0202D7B9F94D791878E362865B8069CFEFD78B9B7DAE75A5D68C811C207F2BBE19DC2B72967735BB6E1EED93AD2BAE379C88582CC0970AC79A62D7CE5BA31195709E13E0F84E950EDF4B85E1BF1EE5109E933C4E0DA0822BC20B0EB2EB55D8EBF8C14CD143627B9D3BCCF1075757E0EB369F9BA42FC2036D89B77B6546D3E7EB6E62CBEF6A5B1B9B562A9DA9D42C6DA2DC0B8C94D9A30397628670996368961C97
padding = 0BD0253E3F500BA4BB7D7226
tmp_aes_key = 43304FF1FC6B7BAF07DB39696A08365AB6194F59460F1E6C4B1605F765C86676
tmp_aes_iv = 1F93981C89E1ADACE692CC4BDBD2738BA309C47BDCB3B90907074E7CF19B1937</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 426EBB1B144CBE678B2C46B0B1B1A9BC931CFE43A7B2470F944DB414429067B3E0154ECB3B08DAB0822BBAD3790B70EFAEBB172202DABC0042B84D60A1113055B447913E5214B0A10743A1130C25DFCF848A62F9B060D30D522DA5812AACF6BED88CFA4AC06398BF1584845855445CA46DAEB747A8C47710EF9CBDC8FF515F7B9DD9BFB14ADFC07E518F58438189E4A2CD6312F08E50A79FCE91E51900B308FE096E9802AF6D82C39AE0C5E43BAEF94BB3539749CE7894C7CD420FC0CA3123811D15A7A42961F256686FBA6E6ED80320C98EC6FADB8EF47FDD175A9540BF19A022B18CE4F8A8E995010FB4E285E2FE8FD05D97B6D6BF2F9ED786DC5E7915BEFA38EF2807E2587DE16E224ABD3C13C99F506A510297EF667405AAD9589D6EAD121D5669844EA71FACFD1C511E37EBEF81F6D5006D75736940C8A06F407DCF8D86E173A904F6E1A9F3B738DA1FFDC29C29</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 FC FE 0C 00 03 D7 38 67
0010 | 78 01 00 00 1F 5F 04 F5 9A 5B A4 1B 3D 34 52 05
0020 | 97 27 4D F2 D3 77 B5 20 2D 4F 3B FC C9 F3 A6 C2
0030 | D6 A5 FD 96 13 D8 97 9B FE 50 01 00 42 6E BB 1B
0040 | 14 4C BE 67 8B 2C 46 B0 B1 B1 A9 BC 93 1C FE 43
0050 | A7 B2 47 0F 94 4D B4 14 42 90 67 B3 E0 15 4E CB
0060 | 3B 08 DA B0 82 2B BA D3 79 0B 70 EF AE BB 17 22
0070 | 02 DA BC 00 42 B8 4D 60 A1 11 30 55 B4 47 91 3E
0080 | 52 14 B0 A1 07 43 A1 13 0C 25 DF CF 84 8A 62 F9
0090 | B0 60 D3 0D 52 2D A5 81 2A AC F6 BE D8 8C FA 4A
00A0 | C0 63 98 BF 15 84 84 58 55 44 5C A4 6D AE B7 47
00B0 | A8 C4 77 10 EF 9C BD C8 FF 51 5F 7B 9D D9 BF B1
00C0 | 4A DF C0 7E 51 8F 58 43 81 89 E4 A2 CD 63 12 F0
00D0 | 8E 50 A7 9F CE 91 E5 19 00 B3 08 FE 09 6E 98 02
00E0 | AF 6D 82 C3 9A E0 C5 E4 3B AE F9 4B B3 53 97 49
00F0 | CE 78 94 C7 CD 42 0F C0 CA 31 23 81 1D 15 A7 A4
0100 | 29 61 F2 56 68 6F BA 6E 6E D8 03 20 C9 8E C6 FA
0110 | DB 8E F4 7F DD 17 5A 95 40 BF 19 A0 22 B1 8C E4
0120 | F8 A8 E9 95 01 0F B4 E2 85 E2 FE 8F D0 5D 97 B6
0130 | D6 BF 2F 9E D7 86 DC 5E 79 15 BE FA 38 EF 28 07
0140 | E2 58 7D E1 6E 22 4A BD 3C 13 C9 9F 50 6A 51 02
0150 | 97 EF 66 74 05 AA D9 58 9D 6E AD 12 1D 56 69 84
0160 | 4E A7 1F AC FD 1C 51 1E 37 EB EF 81 F6 D5 00 6D
0170 | 75 73 69 40 C8 A0 6F 40 7D CF 8D 86 E1 73 A9 04
0180 | F6 E1 A9 F3 B7 38 DA 1F FD C2 9C 29</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>FCFE0C0003D73867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100426EBB1B144CBE678B2C46B0</code> <code>B1B1A9BC931CFE43A7B2470F944DB414</code> <code>429067B3E0154ECB3B08DAB0822BBAD3</code> <code>790B70EFAEBB172202DABC0042B84D60</code> <code>A1113055B447913E5214B0A10743A113</code> <code>0C25DFCF848A62F9B060D30D522DA581</code> <code>2AACF6BED88CFA4AC06398BF15848458</code> <code>55445CA46DAEB747A8C47710EF9CBDC8</code> <code>FF515F7B9DD9BFB14ADFC07E518F5843</code> <code>8189E4A2CD6312F08E50A79FCE91E519</code> <code>00B308FE096E9802AF6D82C39AE0C5E4</code> <code>3BAEF94BB3539749CE7894C7CD420FC0</code> <code>CA3123811D15A7A42961F256686FBA6E</code> <code>6ED80320C98EC6FADB8EF47FDD175A95</code> <code>40BF19A022B18CE4F8A8E995010FB4E2</code> <code>85E2FE8FD05D97B6D6BF2F9ED786DC5E</code> <code>7915BEFA38EF2807E2587DE16E224ABD</code> <code>3C13C99F506A510297EF667405AAD958</code> <code>9D6EAD121D5669844EA71FACFD1C511E</code> <code>37EBEF81F6D5006D75736940C8A06F40</code> <code>7DCF8D86E173A904F6E1A9F3B738DA1F</code><br> <code>FDC29C29</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 5FFE49378BD08A285BFF82C7787F8354BC133BC9CF09FD890BD00DAB488ADAD1AFB5405293674191DEB60C7DAF5E93C54C3DF3E50A5B86C843C9C0637F1AC0551B5134DCDDDA2A71CF4F2F08440C8DF31BE6499A24A9B5A5D1D3192780EE1421F1C2E4878229C1420C5B28087EFB0F7597F8DE0D3C4D3D4D8714702E905C4E1ACBF256B920CC32D81825678652FA0CE1252B285110602F2B478A19F94CBBFCCA2729100279494FFA6286FA3B169415836EBB7B4CB4CF3548E33AA5AFC385B472057EF22782FA5E4C4F1F6270568C6328357A35D146249B09DC3A91FFDFC849B09EBCC7D45891E856AFA122175DC210D6F317C92E15DAD7806EBF940BF005D415</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 7C 3A 05 D7 38 67
0010 | 34 00 00 00 34 F7 CB 3B 9A 5B A4 1B 3D 34 52 05
0020 | 97 27 4D F2 D3 77 B5 20 2D 4F 3B FC C9 F3 A6 C2
0030 | D6 A5 FD 96 13 D8 97 9B 0B 93 97 1B C6 80 0E 7F
0040 | 47 A3 6E DE 1A D3 0B 58</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01387C3A05D73867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9A5BA41B3D34520597274DF2D377B520</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>2D4F3BFCC9F3A6C2D6A5FD9613D8979B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>0B93971BC6800E7F47A36EDE1AD30B58</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

