<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?245" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F8 80 06 00 7F FC 88 68
0010 | 14 00 00 00 F1 8E 7E BE DC 16 50 15 E3 D3 F1 30
0020 | 9E EF E1 4A 0B 34 45 C5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F88006007FFC8868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 48 05 CB 7F FC 88 68
0010 | 50 00 00 00 63 24 16 05 DC 16 50 15 E3 D3 F1 30
0020 | 9E EF E1 4A 0B 34 45 C5 E6 EF 0F FD 2C 27 3B C9
0030 | C0 EA D4 1A CE 14 C3 1B 08 26 39 E8 06 49 AB 7B
0040 | 7F 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014805CB7FFC8868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082639E80649AB7B7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2754487760817191807</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2754487760817191807</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2754487760817191807 = 1512697367 * 1820911321</code></p>
<pre><code>p = 1512697367
q = 1820911321</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 26 39 E8 06 49 AB 7B 7F 00 00 00
0010 | 04 5A 29 EE 17 00 00 00 04 6C 88 E6 D9 00 00 00
0020 | DC 16 50 15 E3 D3 F1 30 9E EF E1 4A 0B 34 45 C5
0030 | E6 EF 0F FD 2C 27 3B C9 C0 EA D4 1A CE 14 C3 1B
0040 | EE 38 F7 D9 6C AC EB AE 24 C6 26 D8 C6 7E 89 90
0050 | 94 3F 69 E9 9C BF 53 11 14 94 47 DC F3 04 5C 3D
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082639E80649AB7B7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2754487760817191807</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045A29EE17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1512697367</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046C88E6D9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1820911321</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>EE38F7D96CACEBAE24C626D8C67E8990</code> <code>943F69E99CBF5311149447DCF3045C3D</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082639E80649AB7B7F000000045A29EE17000000046C88E6D9000000DC165015E3D3F1309EEFE14A0B3445C5E6EF0FFD2C273BC9C0EAD41ACE14C31BEE38F7D96CACEBAE24C626D8C67E8990943F69E99CBF5311149447DCF3045C3D02000000
random_padding_bytes = 40CB732A34CA541505BDCF0C913826C6976989ACD22FF98E696790B68EECBF5EED8C7B099EC268385D43EA717571CF69394D1BC92CF8F7F668A26D8C9CDC4B7BDA81F1F5CA627F62A3DB348C89A5786EB49441165F6AC33A08DCC4AC</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 3CF02D52AD4FCF33C7B6D21744C44139C8DCAB3E6A8496BE11D11AFE89F3863FAE6D9FC50C5388981F086A54373FD501962562AC2AEC3C6AE5A74821A880A413EC41396F9EBE5E3806B1AFBA62DE9B6C6EB7BF575950AB8CB7E49FBE37FA2DD8907F0149DF7988D718CACB26E57B723A42F7EF16B8644744D7BF44800D9F8D5460F1FAD4390FBB7855350520FA3FF48306DD20D803F61F230F0AD77BB6CC7D3CA2C9810EAA9EC290CC2E18BFC919D98F49CFF4C8946E1E533593AD799908075C58D22B9ACA8F09703BDEF284CB5920AF5215E971846AEE31FFA22E7ACF994CCF9602151DEDBB4334E3DEE7EEF28D1F75C365863016D212AC87215A72E031B4D7</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 04 A9 0E 00 7F FC 88 68
0010 | 40 01 00 00 BE E4 12 D7 DC 16 50 15 E3 D3 F1 30
0020 | 9E EF E1 4A 0B 34 45 C5 E6 EF 0F FD 2C 27 3B C9
0030 | C0 EA D4 1A CE 14 C3 1B 04 5A 29 EE 17 00 00 00
0040 | 04 6C 88 E6 D9 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 3C F0 2D 52 AD 4F CF 33 C7 B6 D2 17
0060 | 44 C4 41 39 C8 DC AB 3E 6A 84 96 BE 11 D1 1A FE
0070 | 89 F3 86 3F AE 6D 9F C5 0C 53 88 98 1F 08 6A 54
0080 | 37 3F D5 01 96 25 62 AC 2A EC 3C 6A E5 A7 48 21
0090 | A8 80 A4 13 EC 41 39 6F 9E BE 5E 38 06 B1 AF BA
00A0 | 62 DE 9B 6C 6E B7 BF 57 59 50 AB 8C B7 E4 9F BE
00B0 | 37 FA 2D D8 90 7F 01 49 DF 79 88 D7 18 CA CB 26
00C0 | E5 7B 72 3A 42 F7 EF 16 B8 64 47 44 D7 BF 44 80
00D0 | 0D 9F 8D 54 60 F1 FA D4 39 0F BB 78 55 35 05 20
00E0 | FA 3F F4 83 06 DD 20 D8 03 F6 1F 23 0F 0A D7 7B
00F0 | B6 CC 7D 3C A2 C9 81 0E AA 9E C2 90 CC 2E 18 BF
0100 | C9 19 D9 8F 49 CF F4 C8 94 6E 1E 53 35 93 AD 79
0110 | 99 08 07 5C 58 D2 2B 9A CA 8F 09 70 3B DE F2 84
0120 | CB 59 20 AF 52 15 E9 71 84 6A EE 31 FF A2 2E 7A
0130 | CF 99 4C CF 96 02 15 1D ED BB 43 34 E3 DE E7 EE
0140 | F2 8D 1F 75 C3 65 86 30 16 D2 12 AC 87 21 5A 72
0150 | E0 31 B4 D7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>04A90E007FFC8868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045A29EE17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1512697367</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046C88E6D9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1820911321</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001003CF02D52AD4FCF33C7B6D217</code> <code>44C44139C8DCAB3E6A8496BE11D11AFE</code> <code>89F3863FAE6D9FC50C5388981F086A54</code> <code>373FD501962562AC2AEC3C6AE5A74821</code> <code>A880A413EC41396F9EBE5E3806B1AFBA</code> <code>62DE9B6C6EB7BF575950AB8CB7E49FBE</code> <code>37FA2DD8907F0149DF7988D718CACB26</code> <code>E57B723A42F7EF16B8644744D7BF4480</code> <code>0D9F8D5460F1FAD4390FBB7855350520</code> <code>FA3FF48306DD20D803F61F230F0AD77B</code> <code>B6CC7D3CA2C9810EAA9EC290CC2E18BF</code> <code>C919D98F49CFF4C8946E1E533593AD79</code> <code>9908075C58D22B9ACA8F09703BDEF284</code> <code>CB5920AF5215E971846AEE31FFA22E7A</code> <code>CF994CCF9602151DEDBB4334E3DEE7EE</code> <code>F28D1F75C365863016D212AC87215A72</code><br> <code>E031B4D7</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 80 9F F1 7F FC 88 68
0010 | 78 02 00 00 5C 07 E8 D0 DC 16 50 15 E3 D3 F1 30
0020 | 9E EF E1 4A 0B 34 45 C5 E6 EF 0F FD 2C 27 3B C9
0030 | C0 EA D4 1A CE 14 C3 1B FE 50 02 00 7D B1 46 06
0040 | 72 7E D0 DC 3A 3F 12 03 7C 2A 13 11 73 B2 87 35
0050 | 5E E6 CF 1D 74 02 B9 38 57 4D A0 18 73 FE 21 9F
0060 | 92 27 EC 57 E2 FE 2D 6A C6 3A 03 C9 BF 70 65 BD
0070 | 78 B9 43 B4 F7 4D DA 0E B7 41 4C B7 8B ED F1 C5
0080 | 87 B0 E2 FD FB EC BC 4F BB A3 3E 64 BB 98 A4 8F
0090 | 24 FB 60 DA 8E 14 47 8A AE 46 CF 9D A4 24 A1 4B
00A0 | C8 6E 76 B4 3B DA FB 50 3F 8D AD 23 74 F2 F4 0B
00B0 | 91 BB 14 A2 F2 84 98 46 95 16 78 63 67 82 CB 6C
00C0 | 25 36 16 99 3B 15 DC E3 DE 71 96 EA C1 E5 CE 74
00D0 | E7 F9 47 39 D5 50 A1 40 83 69 22 E6 62 7D 1B 8F
00E0 | C8 F1 F8 0A C3 24 6A 86 15 61 66 C3 ED AD B8 EE
00F0 | BF 77 18 15 6F 2A F7 56 9E 21 3E 7D 7C 22 7D 14
0100 | B8 3C 09 92 5F 41 98 74 C4 94 6F 23 F1 00 D0 9B
0110 | 6F 55 27 7B EF 1E D2 21 C2 81 58 B9 0E A8 90 56
0120 | 44 39 37 B1 8F B5 2F 8E FB B3 F5 F0 16 C8 80 3C
0130 | 38 C4 70 6D 6F 65 9C 52 64 02 45 22 73 AF F4 86
0140 | 24 81 DD D7 58 48 6A E6 F1 70 2B 2B 39 FA 6F BC
0150 | 13 BD 47 EC 61 87 07 3A 16 00 91 71 89 35 54 F1
0160 | 37 F2 54 75 CF F3 BF 0B 17 2F AA 49 12 87 4F 77
0170 | 18 21 3D 11 C0 1F CF 20 B3 6D 48 2C 5E 34 BD 9C
0180 | 1C C8 F7 85 C4 48 45 E0 83 24 BE 90 BF 78 53 31
0190 | BA 3A 94 99 BD DC 4D 72 A7 AD 57 ED 88 75 DD 28
01A0 | 10 30 98 17 2E 6B A1 F4 F8 28 35 BD 6B DF 68 A3
01B0 | 40 BD 70 57 C1 E6 11 09 3B 76 BC 56 A6 ED 6F 4D
01C0 | B8 66 B2 98 77 4F 93 57 A4 E1 2F 21 1E C0 BD 89
01D0 | 23 55 E9 3F FA AA 2A 11 9B 0A 10 E0 BD 30 52 DA
01E0 | 97 E3 65 B6 97 38 3A 3C 0F 92 2E F9 7E 3E 77 A5
01F0 | 1A F4 99 78 86 BB 06 7D 2F DD B6 DE 44 12 67 BD
0200 | CD B7 59 8D DD 07 96 D1 42 45 62 23 41 5D 50 58
0210 | 9B 81 AB 79 27 16 EE B2 64 00 78 8A BA 86 88 36
0220 | DE 3D 4F 90 42 38 DD 73 5C 37 C7 43 B3 DD 05 8D
0230 | 52 BF 71 A6 BB C6 B1 35 06 DB F3 A1 8F 1A 77 61
0240 | 13 15 0A 9F 90 3D 2E 24 A5 4C B0 D7 36 19 37 0F
0250 | B0 FC 04 41 BA F7 E6 D8 6F B1 57 65 19 9C 1B 80
0260 | CA 27 E5 D5 38 96 66 AC 90 B6 57 3B 1C EB 5E FB
0270 | E0 67 2B 20 D5 B9 8E 4C A6 20 6F BA CD 83 94 60
0280 | F8 E2 16 19 71 21 80 7D E7 21 BA 60</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01809FF17FFC8868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002007DB14606727ED0DC3A3F1203</code> <code>7C2A131173B287355EE6CF1D7402B938</code> <code>574DA01873FE219F9227EC57E2FE2D6A</code> <code>C63A03C9BF7065BD78B943B4F74DDA0E</code> <code>B7414CB78BEDF1C587B0E2FDFBECBC4F</code> <code>BBA33E64BB98A48F24FB60DA8E14478A</code> <code>AE46CF9DA424A14BC86E76B43BDAFB50</code> <code>3F8DAD2374F2F40B91BB14A2F2849846</code> <code>951678636782CB6C253616993B15DCE3</code> <code>DE7196EAC1E5CE74E7F94739D550A140</code> <code>836922E6627D1B8FC8F1F80AC3246A86</code> <code>156166C3EDADB8EEBF7718156F2AF756</code> <code>9E213E7D7C227D14B83C09925F419874</code> <code>C4946F23F100D09B6F55277BEF1ED221</code> <code>C28158B90EA89056443937B18FB52F8E</code> <code>FBB3F5F016C8803C38C4706D6F659C52</code> <code>6402452273AFF4862481DDD758486AE6</code> <code>F1702B2B39FA6FBC13BD47EC6187073A</code> <code>16009171893554F137F25475CFF3BF0B</code> <code>172FAA4912874F7718213D11C01FCF20</code> <code>B36D482C5E34BD9C1CC8F785C44845E0</code> <code>8324BE90BF785331BA3A9499BDDC4D72</code> <code>A7AD57ED8875DD28103098172E6BA1F4</code> <code>F82835BD6BDF68A340BD7057C1E61109</code> <code>3B76BC56A6ED6F4DB866B298774F9357</code> <code>A4E12F211EC0BD892355E93FFAAA2A11</code> <code>9B0A10E0BD3052DA97E365B697383A3C</code> <code>0F922EF97E3E77A51AF4997886BB067D</code> <code>2FDDB6DE441267BDCDB7598DDD0796D1</code> <code>42456223415D50589B81AB792716EEB2</code> <code>6400788ABA868836DE3D4F904238DD73</code> <code>5C37C743B3DD058D52BF71A6BBC6B135</code> <code>06DBF3A18F1A776113150A9F903D2E24</code> <code>A54CB0D73619370FB0FC0441BAF7E6D8</code> <code>6FB15765199C1B80CA27E5D5389666AC</code> <code>90B6573B1CEB5EFBE0672B20D5B98E4C</code> <code>A6206FBACD839460F8E216197121807D</code><br> <code>E721BA60</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 7DB14606727ED0DC3A3F12037C2A131173B287355EE6CF1D7402B938574DA01873FE219F9227EC57E2FE2D6AC63A03C9BF7065BD78B943B4F74DDA0EB7414CB78BEDF1C587B0E2FDFBECBC4FBBA33E64BB98A48F24FB60DA8E14478AAE46CF9DA424A14BC86E76B43BDAFB503F8DAD2374F2F40B91BB14A2F2849846951678636782CB6C253616993B15DCE3DE7196EAC1E5CE74E7F94739D550A140836922E6627D1B8FC8F1F80AC3246A86156166C3EDADB8EEBF7718156F2AF7569E213E7D7C227D14B83C09925F419874C4946F23F100D09B6F55277BEF1ED221C28158B90EA89056443937B18FB52F8EFBB3F5F016C8803C38C4706D6F659C526402452273AFF4862481DDD758486AE6F1702B2B39FA6FBC13BD47EC6187073A16009171893554F137F25475CFF3BF0B172FAA4912874F7718213D11C01FCF20B36D482C5E34BD9C1CC8F785C44845E08324BE90BF785331BA3A9499BDDC4D72A7AD57ED8875DD28103098172E6BA1F4F82835BD6BDF68A340BD7057C1E611093B76BC56A6ED6F4DB866B298774F9357A4E12F211EC0BD892355E93FFAAA2A119B0A10E0BD3052DA97E365B697383A3C0F922EF97E3E77A51AF4997886BB067D2FDDB6DE441267BDCDB7598DDD0796D142456223415D50589B81AB792716EEB26400788ABA868836DE3D4F904238DD735C37C743B3DD058D52BF71A6BBC6B13506DBF3A18F1A776113150A9F903D2E24A54CB0D73619370FB0FC0441BAF7E6D86FB15765199C1B80CA27E5D5389666AC90B6573B1CEB5EFBE0672B20D5B98E4CA6206FBACD839460F8E216197121807DE721BA60
tmp_aes_key = D8D8E668E96F5124F8F061F7E20EADDCFD79FE54999E02551FE7124A569EA9AE
tmp_aes_iv = FC0FBA01B05BB76D5EE8A16C8AF998DD39579533BA735301A49E6EB7EE38F7D9</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 32678CF2F59725304EC580592100F09E99E26B40BA0D89B5DC165015E3D3F1309EEFE14A0B3445C5E6EF0FFD2C273BC9C0EAD41ACE14C31B03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B990BF36E8E699B2AF576823C3A5E2EFEF40685F25B10D6B94D225D328B575074A6A9BB428CCB1831E209B5E32908C2E0C50112F28ECF8893CB4455F8AF8D1D70A85FA5AEF91962CDD2DD33E9B0AAA8E37ABB3DBA75C0524DF6B4CB7CFB7E91379BA7582C70C882C8E149C2C912FCFB60C51E6145C18ACDD000C1CEC88D63507E7F28B85E018626538EC5897621D3A6C5868EB6C1F72784B9C30227399CA03CF400D8369DEBD1A944F590CFDD267317F79D7ABBC0075FF149F763F6AB0AB67C2FE44C2F7DDBA90014522806A80132F5D50F5496ABEF036B967C45B98E8488F95E671F555106F08ADB65A9BDD58E2ACB1606CAC14BDDD6AF7C3E368B09CBD6C9C7FFC88683BC77A84CE42733B
answer = BA0D89B5DC165015E3D3F1309EEFE14A0B3445C5E6EF0FFD2C273BC9C0EAD41ACE14C31B03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B990BF36E8E699B2AF576823C3A5E2EFEF40685F25B10D6B94D225D328B575074A6A9BB428CCB1831E209B5E32908C2E0C50112F28ECF8893CB4455F8AF8D1D70A85FA5AEF91962CDD2DD33E9B0AAA8E37ABB3DBA75C0524DF6B4CB7CFB7E91379BA7582C70C882C8E149C2C912FCFB60C51E6145C18ACDD000C1CEC88D63507E7F28B85E018626538EC5897621D3A6C5868EB6C1F72784B9C30227399CA03CF400D8369DEBD1A944F590CFDD267317F79D7ABBC0075FF149F763F6AB0AB67C2FE44C2F7DDBA90014522806A80132F5D50F5496ABEF036B967C45B98E8488F95E671F555106F08ADB65A9BDD58E2ACB1606CAC14BDDD6AF7C3E368B09CBD6C9C7FFC88683BC77A84CE42733B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 DC 16 50 15 E3 D3 F1 30 9E EF E1 4A
0010 | 0B 34 45 C5 E6 EF 0F FD 2C 27 3B C9 C0 EA D4 1A
0020 | CE 14 C3 1B 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | B9 90 BF 36 E8 E6 99 B2 AF 57 68 23 C3 A5 E2 EF
0140 | EF 40 68 5F 25 B1 0D 6B 94 D2 25 D3 28 B5 75 07
0150 | 4A 6A 9B B4 28 CC B1 83 1E 20 9B 5E 32 90 8C 2E
0160 | 0C 50 11 2F 28 EC F8 89 3C B4 45 5F 8A F8 D1 D7
0170 | 0A 85 FA 5A EF 91 96 2C DD 2D D3 3E 9B 0A AA 8E
0180 | 37 AB B3 DB A7 5C 05 24 DF 6B 4C B7 CF B7 E9 13
0190 | 79 BA 75 82 C7 0C 88 2C 8E 14 9C 2C 91 2F CF B6
01A0 | 0C 51 E6 14 5C 18 AC DD 00 0C 1C EC 88 D6 35 07
01B0 | E7 F2 8B 85 E0 18 62 65 38 EC 58 97 62 1D 3A 6C
01C0 | 58 68 EB 6C 1F 72 78 4B 9C 30 22 73 99 CA 03 CF
01D0 | 40 0D 83 69 DE BD 1A 94 4F 59 0C FD D2 67 31 7F
01E0 | 79 D7 AB BC 00 75 FF 14 9F 76 3F 6A B0 AB 67 C2
01F0 | FE 44 C2 F7 DD BA 90 01 45 22 80 6A 80 13 2F 5D
0200 | 50 F5 49 6A BE F0 36 B9 67 C4 5B 98 E8 48 8F 95
0210 | E6 71 F5 55 10 6F 08 AD B6 5A 9B DD 58 E2 AC B1
0220 | 60 6C AC 14 BD DD 6A F7 C3 E3 68 B0 9C BD 6C 9C
0230 | 7F FC 88 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100B990BF36E8E699B2AF576823</code> <code>C3A5E2EFEF40685F25B10D6B94D225D3</code> <code>28B575074A6A9BB428CCB1831E209B5E</code> <code>32908C2E0C50112F28ECF8893CB4455F</code> <code>8AF8D1D70A85FA5AEF91962CDD2DD33E</code> <code>9B0AAA8E37ABB3DBA75C0524DF6B4CB7</code> <code>CFB7E91379BA7582C70C882C8E149C2C</code> <code>912FCFB60C51E6145C18ACDD000C1CEC</code> <code>88D63507E7F28B85E018626538EC5897</code> <code>621D3A6C5868EB6C1F72784B9C302273</code> <code>99CA03CF400D8369DEBD1A944F590CFD</code> <code>D267317F79D7ABBC0075FF149F763F6A</code> <code>B0AB67C2FE44C2F7DDBA90014522806A</code> <code>80132F5D50F5496ABEF036B967C45B98</code> <code>E8488F95E671F555106F08ADB65A9BDD</code> <code>58E2ACB1606CAC14BDDD6AF7C3E368B0</code><br> <code>9CBD6C9C</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>7FFC8868</code> (1753807999 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = D1AD6D8C199DC936B47D2AB6B4BB03A24BE09005BF321FAD681439238AA37215808C89A3C19B9251D0F674A6711EC9FC66BF8923AFA9A8B888B3F5248E37DD99BA4162965C85AB00AD364B3E0023267EA57F7ACB6E6833B766011DEC0CEEBC0A8BBFFAE52550FF3C18288CAF209A278DD2B7549FBC733D954D9AA8C7CDEB91A3C440A2DFD33ADB3C48A73BC7C73294F4E81C5EABF1A9E5E1189EE8F04867E6C52DE234E8ABC81414038BC1C4130D9BF8D3EFBA835E3EAB157D1CA6A08125A254AF3A3440415B2D787D7488CD4618A6F6FD07EA1833E748ACD02044A8B4BE4B70AB799E31B94F2CA37C9B1CDC04DC265E9F204C89A60E59A1975D7DF24E84BF71</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 82B7CB0DB26FECA270847F8148BDC6AC135A139CF6F6FDC0E929BBC4D3750DFE885594055EE094BFEA82BDEF8E7A07D6C4CB65771694E5374234508FB86A31265A6EE3123236C3F10606A4713F4A0E0A47063D564D0C2A8FC3C36BF9B5DD12C591FD595D73E81677DD3E5A73E7F58ACD6EB0FFB83E5D7AD544B2C022F088F4E2A6EB5F6CE0EBA5672C4BCEDC8256D18F6BA429CF17931F910D893BCDAA0C70BC356DD738FCB96307D67AEE01423425A1AE54F76D2931994BD87E0E7466B821D847D8FBB59C73D46593D0003E3DC5AAFA0187C68E963EEDA1BEF71A2083886A62BBE1873351D9BDE4EE87C7F3CA88E94E1DDD7B88D66DD003D44004EDC5B75C04</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 DC 16 50 15 E3 D3 F1 30 9E EF E1 4A
0010 | 0B 34 45 C5 E6 EF 0F FD 2C 27 3B C9 C0 EA D4 1A
0020 | CE 14 C3 1B 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 82 B7 CB 0D B2 6F EC A2 70 84 7F 81 48 BD C6 AC
0040 | 13 5A 13 9C F6 F6 FD C0 E9 29 BB C4 D3 75 0D FE
0050 | 88 55 94 05 5E E0 94 BF EA 82 BD EF 8E 7A 07 D6
0060 | C4 CB 65 77 16 94 E5 37 42 34 50 8F B8 6A 31 26
0070 | 5A 6E E3 12 32 36 C3 F1 06 06 A4 71 3F 4A 0E 0A
0080 | 47 06 3D 56 4D 0C 2A 8F C3 C3 6B F9 B5 DD 12 C5
0090 | 91 FD 59 5D 73 E8 16 77 DD 3E 5A 73 E7 F5 8A CD
00A0 | 6E B0 FF B8 3E 5D 7A D5 44 B2 C0 22 F0 88 F4 E2
00B0 | A6 EB 5F 6C E0 EB A5 67 2C 4B CE DC 82 56 D1 8F
00C0 | 6B A4 29 CF 17 93 1F 91 0D 89 3B CD AA 0C 70 BC
00D0 | 35 6D D7 38 FC B9 63 07 D6 7A EE 01 42 34 25 A1
00E0 | AE 54 F7 6D 29 31 99 4B D8 7E 0E 74 66 B8 21 D8
00F0 | 47 D8 FB B5 9C 73 D4 65 93 D0 00 3E 3D C5 AA FA
0100 | 01 87 C6 8E 96 3E ED A1 BE F7 1A 20 83 88 6A 62
0110 | BB E1 87 33 51 D9 BD E4 EE 87 C7 F3 CA 88 E9 4E
0120 | 1D DD 7B 88 D6 6D D0 03 D4 40 04 ED C5 B7 5C 04</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010082B7CB0DB26FECA270847F81</code> <code>48BDC6AC135A139CF6F6FDC0E929BBC4</code> <code>D3750DFE885594055EE094BFEA82BDEF</code> <code>8E7A07D6C4CB65771694E5374234508F</code> <code>B86A31265A6EE3123236C3F10606A471</code> <code>3F4A0E0A47063D564D0C2A8FC3C36BF9</code> <code>B5DD12C591FD595D73E81677DD3E5A73</code> <code>E7F58ACD6EB0FFB83E5D7AD544B2C022</code> <code>F088F4E2A6EB5F6CE0EBA5672C4BCEDC</code> <code>8256D18F6BA429CF17931F910D893BCD</code> <code>AA0C70BC356DD738FCB96307D67AEE01</code> <code>423425A1AE54F76D2931994BD87E0E74</code> <code>66B821D847D8FBB59C73D46593D0003E</code> <code>3DC5AAFA0187C68E963EEDA1BEF71A20</code> <code>83886A62BBE1873351D9BDE4EE87C7F3</code> <code>CA88E94E1DDD7B88D66DD003D44004ED</code><br> <code>C5B75C04</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366DC165015E3D3F1309EEFE14A0B3445C5E6EF0FFD2C273BC9C0EAD41ACE14C31B0000000000000000FE00010082B7CB0DB26FECA270847F8148BDC6AC135A139CF6F6FDC0E929BBC4D3750DFE885594055EE094BFEA82BDEF8E7A07D6C4CB65771694E5374234508FB86A31265A6EE3123236C3F10606A4713F4A0E0A47063D564D0C2A8FC3C36BF9B5DD12C591FD595D73E81677DD3E5A73E7F58ACD6EB0FFB83E5D7AD544B2C022F088F4E2A6EB5F6CE0EBA5672C4BCEDC8256D18F6BA429CF17931F910D893BCDAA0C70BC356DD738FCB96307D67AEE01423425A1AE54F76D2931994BD87E0E7466B821D847D8FBB59C73D46593D0003E3DC5AAFA0187C68E963EEDA1BEF71A2083886A62BBE1873351D9BDE4EE87C7F3CA88E94E1DDD7B88D66DD003D44004EDC5B75C04
padding = D035CF1916BE593F0F6E946E
tmp_aes_key = D8D8E668E96F5124F8F061F7E20EADDCFD79FE54999E02551FE7124A569EA9AE
tmp_aes_iv = FC0FBA01B05BB76D5EE8A16C8AF998DD39579533BA735301A49E6EB7EE38F7D9</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = E9B1091EA1FEB5012D8CAFED0384B44E11E01BB5EB3E43CE219CDC14FFC56A59E51E60227FFEDD8FD5CDC971ECE24B663C5202F5D894251FF7F3C570F6EA696CD22040FF0A6143B14EB8E4467010B57933243B6F4FC58878CB528C66FD67F1499E21229FBBFD3305054EC4639B4CA7BD40A3DDE7F31C2CB2CD30CBCCD621BE63D32DFD6D8C4807924B5B8261EE41AE4B9B2321B98331DEE024284AB9806B9F839DB2828F9167BAE558F7E93378496130285BECC014D9E4BD10EA0B21CC47CA5DFD3265675B39EBB99B32B4D354F9B07DAAAA164564FB73B37691D5189A635A5261D0FB16243C60309B2E0CF0B3A4A724B95B28A1EC948EA32CD3D417FE560463566F33DEC11FC8B5266F24F0E82BE50025592E0EDD65773C5C45CE9CFF62E8277EA42B2F88E7068C10C7B17C14392AF1C62F15DC9CCD57CA593251468568C4C3C8C57192FE2182A8DEB710946F613CC5</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 A9 0E 00 7F FC 88 68
0010 | 78 01 00 00 1F 5F 04 F5 DC 16 50 15 E3 D3 F1 30
0020 | 9E EF E1 4A 0B 34 45 C5 E6 EF 0F FD 2C 27 3B C9
0030 | C0 EA D4 1A CE 14 C3 1B FE 50 01 00 E9 B1 09 1E
0040 | A1 FE B5 01 2D 8C AF ED 03 84 B4 4E 11 E0 1B B5
0050 | EB 3E 43 CE 21 9C DC 14 FF C5 6A 59 E5 1E 60 22
0060 | 7F FE DD 8F D5 CD C9 71 EC E2 4B 66 3C 52 02 F5
0070 | D8 94 25 1F F7 F3 C5 70 F6 EA 69 6C D2 20 40 FF
0080 | 0A 61 43 B1 4E B8 E4 46 70 10 B5 79 33 24 3B 6F
0090 | 4F C5 88 78 CB 52 8C 66 FD 67 F1 49 9E 21 22 9F
00A0 | BB FD 33 05 05 4E C4 63 9B 4C A7 BD 40 A3 DD E7
00B0 | F3 1C 2C B2 CD 30 CB CC D6 21 BE 63 D3 2D FD 6D
00C0 | 8C 48 07 92 4B 5B 82 61 EE 41 AE 4B 9B 23 21 B9
00D0 | 83 31 DE E0 24 28 4A B9 80 6B 9F 83 9D B2 82 8F
00E0 | 91 67 BA E5 58 F7 E9 33 78 49 61 30 28 5B EC C0
00F0 | 14 D9 E4 BD 10 EA 0B 21 CC 47 CA 5D FD 32 65 67
0100 | 5B 39 EB B9 9B 32 B4 D3 54 F9 B0 7D AA AA 16 45
0110 | 64 FB 73 B3 76 91 D5 18 9A 63 5A 52 61 D0 FB 16
0120 | 24 3C 60 30 9B 2E 0C F0 B3 A4 A7 24 B9 5B 28 A1
0130 | EC 94 8E A3 2C D3 D4 17 FE 56 04 63 56 6F 33 DE
0140 | C1 1F C8 B5 26 6F 24 F0 E8 2B E5 00 25 59 2E 0E
0150 | DD 65 77 3C 5C 45 CE 9C FF 62 E8 27 7E A4 2B 2F
0160 | 88 E7 06 8C 10 C7 B1 7C 14 39 2A F1 C6 2F 15 DC
0170 | 9C CD 57 CA 59 32 51 46 85 68 C4 C3 C8 C5 71 92
0180 | FE 21 82 A8 DE B7 10 94 6F 61 3C C5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>08A90E007FFC8868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100E9B1091EA1FEB5012D8CAFED</code> <code>0384B44E11E01BB5EB3E43CE219CDC14</code> <code>FFC56A59E51E60227FFEDD8FD5CDC971</code> <code>ECE24B663C5202F5D894251FF7F3C570</code> <code>F6EA696CD22040FF0A6143B14EB8E446</code> <code>7010B57933243B6F4FC58878CB528C66</code> <code>FD67F1499E21229FBBFD3305054EC463</code> <code>9B4CA7BD40A3DDE7F31C2CB2CD30CBCC</code> <code>D621BE63D32DFD6D8C4807924B5B8261</code> <code>EE41AE4B9B2321B98331DEE024284AB9</code> <code>806B9F839DB2828F9167BAE558F7E933</code> <code>78496130285BECC014D9E4BD10EA0B21</code> <code>CC47CA5DFD3265675B39EBB99B32B4D3</code> <code>54F9B07DAAAA164564FB73B37691D518</code> <code>9A635A5261D0FB16243C60309B2E0CF0</code> <code>B3A4A724B95B28A1EC948EA32CD3D417</code> <code>FE560463566F33DEC11FC8B5266F24F0</code> <code>E82BE50025592E0EDD65773C5C45CE9C</code> <code>FF62E8277EA42B2F88E7068C10C7B17C</code> <code>14392AF1C62F15DC9CCD57CA59325146</code> <code>8568C4C3C8C57192FE2182A8DEB71094</code><br> <code>6F613CC5</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 6381EF06D86BB8D2C86F2D4615E68EF3C0CA38AB39BE9310599D5487EC8A9E916164A65D76675DC841F9C985F9BE643DFE0CC4FF54CE076C7A293A243DD943A241839F6FFB8435E45DB519FDE8AAA56662FFF0FF60143E448523D9B26E78A6E2A560914DD1F76AF56B87BC26EC06D25F04EE68D7F044720525B7F39761F9B94D927C2D1A05A571D07E5EEF545C9322E713EDD541CB422307BA7433A6FFDAE8367C65C64DD8E6B4026C665D4E107E2E2C47635DE49D2A6FEEF7E1A724D4FB0B8D108E3C567F17BC2B8053E72D1DDDA27FB66C112CBA161DDE5056F91EBAA3B2CCDC47B0454E1913728BA045E2A997A3638A39A9AB4CDF2A9E98FDD2EB210586D0</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C 9B 6D 81 FC 88 68
0010 | 34 00 00 00 34 F7 CB 3B DC 16 50 15 E3 D3 F1 30
0020 | 9E EF E1 4A 0B 34 45 C5 E6 EF 0F FD 2C 27 3B C9
0030 | C0 EA D4 1A CE 14 C3 1B A4 3C 12 AA E7 4D DA 91
0040 | 35 CD 91 88 70 9A E6 24</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019C9B6D81FC8868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DC165015E3D3F1309EEFE14A0B3445C5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E6EF0FFD2C273BC9C0EAD41ACE14C31B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>A43C12AAE74DDA9135CD9188709AE624</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

