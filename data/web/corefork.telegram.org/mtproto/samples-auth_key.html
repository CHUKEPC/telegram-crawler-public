<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 B7 09 00 67 4B AE 66
0010 | 14 00 00 00 F1 8E 7E BE 98 6F 64 A7 DD EA 29 51
0020 | 4E 0E 8D 15 D6 F2 76 D2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B0B70900674BAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 D3 9B 67 4B AE 66
0010 | A8 00 00 00 63 24 16 05 98 6F 64 A7 DD EA 29 51
0020 | 4E 0E 8D 15 D6 F2 76 D2 A5 02 24 04 0E D5 17 4D
0030 | F5 66 64 9C 15 AE 15 24 08 13 FA F3 8D D9 35 E1
0040 | F5 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130D39B674BAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8000000</code> (168 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0813FAF38DD935E1F5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1439730821458420213</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1439730821458420213</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1439730821458420213 = 1153968341 * 1247634593</code></p>
<pre><code>p = 1153968341
q = 1247634593</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 13 FA F3 8D D9 35 E1 F5 00 00 00
0010 | 04 44 C8 28 D5 00 00 00 04 4A 5D 64 A1 00 00 00
0020 | 98 6F 64 A7 DD EA 29 51 4E 0E 8D 15 D6 F2 76 D2
0030 | A5 02 24 04 0E D5 17 4D F5 66 64 9C 15 AE 15 24
0040 | D0 D6 F4 71 6B F2 EB 1F 40 0D E3 11 C7 A9 5B 06
0050 | E0 DC 0A 00 A1 9C B8 A1 AC 6F 73 3C E8 DB 3E 4F
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0813FAF38DD935E1F5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1439730821458420213</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0444C828D5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1153968341</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044A5D64A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1247634593</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>D0D6F4716BF2EB1F400DE311C7A95B06</code> <code>E0DC0A00A19CB8A1AC6F733CE8DB3E4F</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90813FAF38DD935E1F50000000444C828D5000000044A5D64A1000000986F64A7DDEA29514E0E8D15D6F276D2A50224040ED5174DF566649C15AE1524D0D6F4716BF2EB1F400DE311C7A95B06E0DC0A00A19CB8A1AC6F733CE8DB3E4F02000000
random_padding_bytes = D7A82E654340BE8EBCE5A3E542BCA740ACD8D1081AA705383236E39CFD0F538AB643964988D5269A5B9C4E3929F6CF83C60C8D46A560E227BD50B7F60449DCD2324FB5A7FCAEAB1068144A9280009D0A16C918350FD5E9C6A8E5AF66</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 990B0DA1D97893E9E6911475778E7F2B616911D838E11078CB16FB5863F7EED6DFC8FE8B8B76D1FD7A8C25CA3B5CDCD91A8A642891FCFBE6D2B3531AF6B8EF063960F5FE92814FA0CC027C24C26F142FF762AC32690C616D36ABDCA5FE7C37C277E6EA23DC09F1D912F8AF2DBB18B9007EAE21111441DD0C20AACBCF2091C50E5778A2FDD24A5AADF1415BB3753F0B521AD1DCE8E825B100F18E3A593DED86C6FEFC4096733972FBC83969CCACBBEC4A13B57A7A395B56925C823CC5C39CA974D20A7807E0EA9B94E40000893A89CBB9A64C624DF9D005A6505E2B08F581C5ABC226245539971FCE174505A135C80E5B6FD77018DA11BDA529D91E3D35407873</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC 70 0B 00 67 4B AE 66
0010 | 40 01 00 00 BE E4 12 D7 98 6F 64 A7 DD EA 29 51
0020 | 4E 0E 8D 15 D6 F2 76 D2 A5 02 24 04 0E D5 17 4D
0030 | F5 66 64 9C 15 AE 15 24 04 44 C8 28 D5 00 00 00
0040 | 04 4A 5D 64 A1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 99 0B 0D A1 D9 78 93 E9 E6 91 14 75
0060 | 77 8E 7F 2B 61 69 11 D8 38 E1 10 78 CB 16 FB 58
0070 | 63 F7 EE D6 DF C8 FE 8B 8B 76 D1 FD 7A 8C 25 CA
0080 | 3B 5C DC D9 1A 8A 64 28 91 FC FB E6 D2 B3 53 1A
0090 | F6 B8 EF 06 39 60 F5 FE 92 81 4F A0 CC 02 7C 24
00A0 | C2 6F 14 2F F7 62 AC 32 69 0C 61 6D 36 AB DC A5
00B0 | FE 7C 37 C2 77 E6 EA 23 DC 09 F1 D9 12 F8 AF 2D
00C0 | BB 18 B9 00 7E AE 21 11 14 41 DD 0C 20 AA CB CF
00D0 | 20 91 C5 0E 57 78 A2 FD D2 4A 5A AD F1 41 5B B3
00E0 | 75 3F 0B 52 1A D1 DC E8 E8 25 B1 00 F1 8E 3A 59
00F0 | 3D ED 86 C6 FE FC 40 96 73 39 72 FB C8 39 69 CC
0100 | AC BB EC 4A 13 B5 7A 7A 39 5B 56 92 5C 82 3C C5
0110 | C3 9C A9 74 D2 0A 78 07 E0 EA 9B 94 E4 00 00 89
0120 | 3A 89 CB B9 A6 4C 62 4D F9 D0 05 A6 50 5E 2B 08
0130 | F5 81 C5 AB C2 26 24 55 39 97 1F CE 17 45 05 A1
0140 | 35 C8 0E 5B 6F D7 70 18 DA 11 BD A5 29 D9 1E 3D
0150 | 35 40 78 73</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CC700B00674BAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0444C828D5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1153968341</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044A5D64A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1247634593</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100990B0DA1D97893E9E6911475</code> <code>778E7F2B616911D838E11078CB16FB58</code> <code>63F7EED6DFC8FE8B8B76D1FD7A8C25CA</code> <code>3B5CDCD91A8A642891FCFBE6D2B3531A</code> <code>F6B8EF063960F5FE92814FA0CC027C24</code> <code>C26F142FF762AC32690C616D36ABDCA5</code> <code>FE7C37C277E6EA23DC09F1D912F8AF2D</code> <code>BB18B9007EAE21111441DD0C20AACBCF</code> <code>2091C50E5778A2FDD24A5AADF1415BB3</code> <code>753F0B521AD1DCE8E825B100F18E3A59</code> <code>3DED86C6FEFC4096733972FBC83969CC</code> <code>ACBBEC4A13B57A7A395B56925C823CC5</code> <code>C39CA974D20A7807E0EA9B94E4000089</code> <code>3A89CBB9A64C624DF9D005A6505E2B08</code> <code>F581C5ABC226245539971FCE174505A1</code> <code>35C80E5B6FD77018DA11BDA529D91E3D</code><br> <code>35407873</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 FC DE 5A 68 4B AE 66
0010 | 84 02 00 00 5C 07 E8 D0 98 6F 64 A7 DD EA 29 51
0020 | 4E 0E 8D 15 D6 F2 76 D2 A5 02 24 04 0E D5 17 4D
0030 | F5 66 64 9C 15 AE 15 24 FE 50 02 00 7C 9C B6 FE
0040 | 47 ED E7 FB C4 2C 21 CD 7E EA D1 01 D0 FE 4B 0B
0050 | 50 89 0C 7C 61 AE 1A 04 E7 B6 67 34 10 3B 89 4E
0060 | 28 80 E1 9D 46 A2 44 52 DD 02 7F 9F E8 BF 41 10
0070 | 3B A2 C4 85 62 62 38 0A 9F CF 1D 86 11 6E 61 20
0080 | E5 90 BC CB BF CA D8 83 E3 2D 6A 57 CA 90 A0 60
0090 | 04 E3 6D FF E9 B8 80 F8 F1 EE 83 F6 6A 66 B0 A2
00A0 | 36 23 66 E8 B7 B7 AC C3 AF 3B 21 15 C1 A5 5C C3
00B0 | 02 0C 86 D1 39 69 9D A3 E2 83 A3 62 5B D8 B1 D4
00C0 | AE 4A 16 56 F0 C6 40 F2 A7 16 18 40 A4 0F C8 D6
00D0 | EF 99 ED 9F 96 4D FF 0D 6C 33 6B DE 1B B2 97 F2
00E0 | 52 17 86 3F 25 53 9B B7 75 76 02 B5 9D F3 4D 50
00F0 | 14 92 0F CF E2 82 20 57 F2 09 FC 60 65 F1 FD 53
0100 | 23 A8 28 9C D8 60 A8 48 71 28 53 25 1E 79 FE B8
0110 | F6 D5 47 44 57 87 29 6E 89 C0 DE 68 49 2A 2F 8B
0120 | BB DB 8D 34 32 D4 D6 AD AA 94 A4 2B 45 13 28 9D
0130 | BC 67 D6 FF 94 47 DB 4D E4 EF D8 BA 85 68 B6 DF
0140 | 1B D8 C1 60 27 7B 20 FB A3 80 00 7E D0 D9 B1 FC
0150 | 61 DF 36 96 77 A5 21 2C 88 E1 E5 08 D1 BF 3B 0C
0160 | 53 00 E4 B6 FE C0 AC AF 46 A9 89 E6 32 06 33 B9
0170 | E1 53 4A 22 8A 5A AA B9 1E 1F D0 8C 52 87 37 6A
0180 | 3E 5F D2 81 52 B2 04 4C 9A AE 2A 87 86 BB A5 90
0190 | 08 C0 4A CF 99 02 00 4B EA F6 77 67 40 AC C6 51
01A0 | 7A 6E FC 21 02 FF 6F 69 11 B0 83 3C 94 6D 91 9C
01B0 | DF 9D AF 04 D7 30 9F D5 0C 9C F3 3B 2B E8 35 1F
01C0 | 18 FD 99 4D F5 EA D2 20 44 EB F6 55 DC 35 DE 98
01D0 | 8E 0B 93 FC D3 EB 21 63 F6 DB 6D 45 75 BA D4 14
01E0 | 8F C8 5E B7 AA E2 C1 B8 21 1A 2D 5F 75 BB 46 1D
01F0 | 38 BD 8A 1F 42 23 34 3B 3B 62 66 5F 28 9C 5A 89
0200 | 12 59 46 56 D9 54 FD BC 97 33 67 F6 17 E9 D7 C0
0210 | B6 6F 3C DE 69 2C DE B3 A7 3E 0C FA 13 C9 CF EC
0220 | 1A EC C1 6E 91 2A 4B 2F 37 8E E0 5A AA 04 CC BE
0230 | 10 AB 8C 7D 6C 0D 72 26 8A 02 D0 F6 1F 02 F0 15
0240 | 68 92 69 81 4B 96 60 8B 27 57 85 E8 4E D9 47 08
0250 | 1D 74 85 DB 60 2E 8B CC 9A 0A A7 02 A3 24 23 B1
0260 | 6C 9E F1 37 6D C6 FC AC 77 A3 F6 9A C1 9A F2 51
0270 | 33 C1 A1 19 89 EF 7C D8 2E 41 26 F1 37 40 06 11
0280 | 96 3F 9E C7 AE 6A C5 BB 89 2E 5F 1D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01FCDE5A684BAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>84020000</code> (644 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002007C9CB6FE47EDE7FBC42C21CD</code> <code>7EEAD101D0FE4B0B50890C7C61AE1A04</code> <code>E7B66734103B894E2880E19D46A24452</code> <code>DD027F9FE8BF41103BA2C4856262380A</code> <code>9FCF1D86116E6120E590BCCBBFCAD883</code> <code>E32D6A57CA90A06004E36DFFE9B880F8</code> <code>F1EE83F66A66B0A2362366E8B7B7ACC3</code> <code>AF3B2115C1A55CC3020C86D139699DA3</code> <code>E283A3625BD8B1D4AE4A1656F0C640F2</code> <code>A7161840A40FC8D6EF99ED9F964DFF0D</code> <code>6C336BDE1BB297F25217863F25539BB7</code> <code>757602B59DF34D5014920FCFE2822057</code> <code>F209FC6065F1FD5323A8289CD860A848</code> <code>712853251E79FEB8F6D547445787296E</code> <code>89C0DE68492A2F8BBBDB8D3432D4D6AD</code> <code>AA94A42B4513289DBC67D6FF9447DB4D</code> <code>E4EFD8BA8568B6DF1BD8C160277B20FB</code> <code>A380007ED0D9B1FC61DF369677A5212C</code> <code>88E1E508D1BF3B0C5300E4B6FEC0ACAF</code> <code>46A989E6320633B9E1534A228A5AAAB9</code> <code>1E1FD08C5287376A3E5FD28152B2044C</code> <code>9AAE2A8786BBA59008C04ACF9902004B</code> <code>EAF6776740ACC6517A6EFC2102FF6F69</code> <code>11B0833C946D919CDF9DAF04D7309FD5</code> <code>0C9CF33B2BE8351F18FD994DF5EAD220</code> <code>44EBF655DC35DE988E0B93FCD3EB2163</code> <code>F6DB6D4575BAD4148FC85EB7AAE2C1B8</code> <code>211A2D5F75BB461D38BD8A1F4223343B</code> <code>3B62665F289C5A8912594656D954FDBC</code> <code>973367F617E9D7C0B66F3CDE692CDEB3</code> <code>A73E0CFA13C9CFEC1AECC16E912A4B2F</code> <code>378EE05AAA04CCBE10AB8C7D6C0D7226</code> <code>8A02D0F61F02F015689269814B96608B</code> <code>275785E84ED947081D7485DB602E8BCC</code> <code>9A0AA702A32423B16C9EF1376DC6FCAC</code> <code>77A3F69AC19AF25133C1A11989EF7CD8</code> <code>2E4126F137400611963F9EC7AE6AC5BB</code><br> <code>892E5F1D</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 7C9CB6FE47EDE7FBC42C21CD7EEAD101D0FE4B0B50890C7C61AE1A04E7B66734103B894E2880E19D46A24452DD027F9FE8BF41103BA2C4856262380A9FCF1D86116E6120E590BCCBBFCAD883E32D6A57CA90A06004E36DFFE9B880F8F1EE83F66A66B0A2362366E8B7B7ACC3AF3B2115C1A55CC3020C86D139699DA3E283A3625BD8B1D4AE4A1656F0C640F2A7161840A40FC8D6EF99ED9F964DFF0D6C336BDE1BB297F25217863F25539BB7757602B59DF34D5014920FCFE2822057F209FC6065F1FD5323A8289CD860A848712853251E79FEB8F6D547445787296E89C0DE68492A2F8BBBDB8D3432D4D6ADAA94A42B4513289DBC67D6FF9447DB4DE4EFD8BA8568B6DF1BD8C160277B20FBA380007ED0D9B1FC61DF369677A5212C88E1E508D1BF3B0C5300E4B6FEC0ACAF46A989E6320633B9E1534A228A5AAAB91E1FD08C5287376A3E5FD28152B2044C9AAE2A8786BBA59008C04ACF9902004BEAF6776740ACC6517A6EFC2102FF6F6911B0833C946D919CDF9DAF04D7309FD50C9CF33B2BE8351F18FD994DF5EAD22044EBF655DC35DE988E0B93FCD3EB2163F6DB6D4575BAD4148FC85EB7AAE2C1B8211A2D5F75BB461D38BD8A1F4223343B3B62665F289C5A8912594656D954FDBC973367F617E9D7C0B66F3CDE692CDEB3A73E0CFA13C9CFEC1AECC16E912A4B2F378EE05AAA04CCBE10AB8C7D6C0D72268A02D0F61F02F015689269814B96608B275785E84ED947081D7485DB602E8BCC9A0AA702A32423B16C9EF1376DC6FCAC77A3F69AC19AF25133C1A11989EF7CD82E4126F137400611963F9EC7AE6AC5BB892E5F1D
tmp_aes_key = A44135AA9E8C2BAC86949B14ECA5F27C08B11F0C16B920282C852BF645376715
tmp_aes_iv = FF950162823557628C3C6586D31EC8A3C0A7DDE6AFF79F993B46F855D0D6F471</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 6701F663E989B85A8BDDBAFD97757F4F38A074E5BA0D89B5986F64A7DDEA29514E0E8D15D6F276D2A50224040ED5174DF566649C15AE152403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002BBAA01F68318E1CB4DCF61B36930C77E7AB021C9B1B06E42CAB9C1561E30DE1156D5B5504B7B558CFC9A4FDDF61D78AB43562F243CD0791D9BD1E1FB48F5854C42D716EDC49D047E52621FDC447B165DAFE7FC93F8CA53D333686E1170893952A8278901617796656E138CCB3C4FFB7396DF8D730661456361D4B36DBD9A3253A051160B84E3643EBABDC93C1A2975B0BA06DEBA057A9F06279059486CC0726CA7FA8FFFF941035512A063ADD2AEE7839DB9F318B23ADC1FF8A0F1CBFB9EC19C5022721A15713DC05B119EA10C3D4B99FEFCDCFD3871F7949528F60F44529A03B5241E91589610C755FD3F311EB70706A79A799EE65386D43B9BB451A9E507C684BAE6677B14F7FD21E2F51
answer = BA0D89B5986F64A7DDEA29514E0E8D15D6F276D2A50224040ED5174DF566649C15AE152403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002BBAA01F68318E1CB4DCF61B36930C77E7AB021C9B1B06E42CAB9C1561E30DE1156D5B5504B7B558CFC9A4FDDF61D78AB43562F243CD0791D9BD1E1FB48F5854C42D716EDC49D047E52621FDC447B165DAFE7FC93F8CA53D333686E1170893952A8278901617796656E138CCB3C4FFB7396DF8D730661456361D4B36DBD9A3253A051160B84E3643EBABDC93C1A2975B0BA06DEBA057A9F06279059486CC0726CA7FA8FFFF941035512A063ADD2AEE7839DB9F318B23ADC1FF8A0F1CBFB9EC19C5022721A15713DC05B119EA10C3D4B99FEFCDCFD3871F7949528F60F44529A03B5241E91589610C755FD3F311EB70706A79A799EE65386D43B9BB451A9E507C684BAE6677B14F7FD21E2F51</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 98 6F 64 A7 DD EA 29 51 4E 0E 8D 15
0010 | D6 F2 76 D2 A5 02 24 04 0E D5 17 4D F5 66 64 9C
0020 | 15 AE 15 24 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 2B BA A0 1F 68 31 8E 1C B4 DC F6 1B 36 93 0C 77
0140 | E7 AB 02 1C 9B 1B 06 E4 2C AB 9C 15 61 E3 0D E1
0150 | 15 6D 5B 55 04 B7 B5 58 CF C9 A4 FD DF 61 D7 8A
0160 | B4 35 62 F2 43 CD 07 91 D9 BD 1E 1F B4 8F 58 54
0170 | C4 2D 71 6E DC 49 D0 47 E5 26 21 FD C4 47 B1 65
0180 | DA FE 7F C9 3F 8C A5 3D 33 36 86 E1 17 08 93 95
0190 | 2A 82 78 90 16 17 79 66 56 E1 38 CC B3 C4 FF B7
01A0 | 39 6D F8 D7 30 66 14 56 36 1D 4B 36 DB D9 A3 25
01B0 | 3A 05 11 60 B8 4E 36 43 EB AB DC 93 C1 A2 97 5B
01C0 | 0B A0 6D EB A0 57 A9 F0 62 79 05 94 86 CC 07 26
01D0 | CA 7F A8 FF FF 94 10 35 51 2A 06 3A DD 2A EE 78
01E0 | 39 DB 9F 31 8B 23 AD C1 FF 8A 0F 1C BF B9 EC 19
01F0 | C5 02 27 21 A1 57 13 DC 05 B1 19 EA 10 C3 D4 B9
0200 | 9F EF CD CF D3 87 1F 79 49 52 8F 60 F4 45 29 A0
0210 | 3B 52 41 E9 15 89 61 0C 75 5F D3 F3 11 EB 70 70
0220 | 6A 79 A7 99 EE 65 38 6D 43 B9 BB 45 1A 9E 50 7C
0230 | 68 4B AE 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001002BBAA01F68318E1CB4DCF61B</code> <code>36930C77E7AB021C9B1B06E42CAB9C15</code> <code>61E30DE1156D5B5504B7B558CFC9A4FD</code> <code>DF61D78AB43562F243CD0791D9BD1E1F</code> <code>B48F5854C42D716EDC49D047E52621FD</code> <code>C447B165DAFE7FC93F8CA53D333686E1</code> <code>170893952A8278901617796656E138CC</code> <code>B3C4FFB7396DF8D730661456361D4B36</code> <code>DBD9A3253A051160B84E3643EBABDC93</code> <code>C1A2975B0BA06DEBA057A9F062790594</code> <code>86CC0726CA7FA8FFFF941035512A063A</code> <code>DD2AEE7839DB9F318B23ADC1FF8A0F1C</code> <code>BFB9EC19C5022721A15713DC05B119EA</code> <code>10C3D4B99FEFCDCFD3871F7949528F60</code> <code>F44529A03B5241E91589610C755FD3F3</code> <code>11EB70706A79A799EE65386D43B9BB45</code><br> <code>1A9E507C</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>684BAE66</code> (1722698600 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 54DDBA8398983CC2DBBAA8348BA456295ECA6453F7BDF4AC05542AA16020129894833FACC43208368BB560F1957CAD964DA1E8588B577D2EA0FA435E5BE052C2FF16E31F5AC25C2C288A99ED9BA16A48351018CF24FDAF1CDE50D8B9587CEF1C765DD3A84EB04A3B31022D16BDF9AAFC7C2AA6A284F7A20EF1D59670E2EA1C39F48AD5A9CD87DA28CC9CA2CDBA1D851952AD2527A5C58AB5B45A2448D126AEE29FD4F1D6465C4DA1BCE5E243B943D87B75F1BC2EB6FE79FD45F0B28E57B63D196A6E7CF787F8E9E8411282AC5C4170C731318C365A595AA8CAF91B297D335A6D23B76A74F83D8FD91F3C48613724DDFABDFA72ABF7DFC5F20038673F6CC032CC</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 81FAC94270A6CDD90B9AB63F17C7CC192D2CD65F31DCB5A18EC18F206956282A3B2D048F5A9C32FC10AE538D16D12649AE840447AFD19802452BCA28C0447389C063E9E79551B36FAE0EA72E39FDC302412C3FC293DA658B36BC435411793A32CE9125BD310FB517DC59E38EAD664965B900564B7B5EA328E46A132BA637C65B963F5452092FC1121FF8C6C2B9C9CC12FB72D5CB99CD8CDC703CE687715FB6ADCF753FFBAE27956DCD1BB424BCB026D259060C66787A71EFB3BCD566BF6832CC363495083BC72657C5A756D8748464B8E28E8A01CC8C962B06FF234DA3051E9E4824BDCDB7071B2A43E55E663B5A9A9AD4472997F696566B50F4B22516B4082E</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 98 6F 64 A7 DD EA 29 51 4E 0E 8D 15
0010 | D6 F2 76 D2 A5 02 24 04 0E D5 17 4D F5 66 64 9C
0020 | 15 AE 15 24 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 81 FA C9 42 70 A6 CD D9 0B 9A B6 3F 17 C7 CC 19
0040 | 2D 2C D6 5F 31 DC B5 A1 8E C1 8F 20 69 56 28 2A
0050 | 3B 2D 04 8F 5A 9C 32 FC 10 AE 53 8D 16 D1 26 49
0060 | AE 84 04 47 AF D1 98 02 45 2B CA 28 C0 44 73 89
0070 | C0 63 E9 E7 95 51 B3 6F AE 0E A7 2E 39 FD C3 02
0080 | 41 2C 3F C2 93 DA 65 8B 36 BC 43 54 11 79 3A 32
0090 | CE 91 25 BD 31 0F B5 17 DC 59 E3 8E AD 66 49 65
00A0 | B9 00 56 4B 7B 5E A3 28 E4 6A 13 2B A6 37 C6 5B
00B0 | 96 3F 54 52 09 2F C1 12 1F F8 C6 C2 B9 C9 CC 12
00C0 | FB 72 D5 CB 99 CD 8C DC 70 3C E6 87 71 5F B6 AD
00D0 | CF 75 3F FB AE 27 95 6D CD 1B B4 24 BC B0 26 D2
00E0 | 59 06 0C 66 78 7A 71 EF B3 BC D5 66 BF 68 32 CC
00F0 | 36 34 95 08 3B C7 26 57 C5 A7 56 D8 74 84 64 B8
0100 | E2 8E 8A 01 CC 8C 96 2B 06 FF 23 4D A3 05 1E 9E
0110 | 48 24 BD CD B7 07 1B 2A 43 E5 5E 66 3B 5A 9A 9A
0120 | D4 47 29 97 F6 96 56 6B 50 F4 B2 25 16 B4 08 2E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010081FAC94270A6CDD90B9AB63F</code> <code>17C7CC192D2CD65F31DCB5A18EC18F20</code> <code>6956282A3B2D048F5A9C32FC10AE538D</code> <code>16D12649AE840447AFD19802452BCA28</code> <code>C0447389C063E9E79551B36FAE0EA72E</code> <code>39FDC302412C3FC293DA658B36BC4354</code> <code>11793A32CE9125BD310FB517DC59E38E</code> <code>AD664965B900564B7B5EA328E46A132B</code> <code>A637C65B963F5452092FC1121FF8C6C2</code> <code>B9C9CC12FB72D5CB99CD8CDC703CE687</code> <code>715FB6ADCF753FFBAE27956DCD1BB424</code> <code>BCB026D259060C66787A71EFB3BCD566</code> <code>BF6832CC363495083BC72657C5A756D8</code> <code>748464B8E28E8A01CC8C962B06FF234D</code> <code>A3051E9E4824BDCDB7071B2A43E55E66</code> <code>3B5A9A9AD4472997F696566B50F4B225</code><br> <code>16B4082E</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366986F64A7DDEA29514E0E8D15D6F276D2A50224040ED5174DF566649C15AE15240000000000000000FE00010081FAC94270A6CDD90B9AB63F17C7CC192D2CD65F31DCB5A18EC18F206956282A3B2D048F5A9C32FC10AE538D16D12649AE840447AFD19802452BCA28C0447389C063E9E79551B36FAE0EA72E39FDC302412C3FC293DA658B36BC435411793A32CE9125BD310FB517DC59E38EAD664965B900564B7B5EA328E46A132BA637C65B963F5452092FC1121FF8C6C2B9C9CC12FB72D5CB99CD8CDC703CE687715FB6ADCF753FFBAE27956DCD1BB424BCB026D259060C66787A71EFB3BCD566BF6832CC363495083BC72657C5A756D8748464B8E28E8A01CC8C962B06FF234DA3051E9E4824BDCDB7071B2A43E55E663B5A9A9AD4472997F696566B50F4B22516B4082E
padding = 9C866DF39A2B96056D276D7B
tmp_aes_key = A44135AA9E8C2BAC86949B14ECA5F27C08B11F0C16B920282C852BF645376715
tmp_aes_iv = FF950162823557628C3C6586D31EC8A3C0A7DDE6AFF79F993B46F855D0D6F471</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = ABE1B56BE263762EA0D5E710BF0A2AD10C393B30D7AEC4E33C0FDF67A1FF5B6F263B827858AF464E62545D4FC2153DFBF33B8DAB02E361C2772CB266500F688B3827A2AEBCFA6585B66C07B185FF620BECBD28A1958CBB4EEC14229EFD37A110C160AE2EE3388123EAB0025B553C27470DB21C6E6D06CFAE4BDCE6297E6AC2A1FC387AA0FA5D3ABD5B8C8305E0B401B79F40F2E3C7456DBB7F23B324326354C721E88034A6229F5471719C2778A242F46B752A909D30E2EB28654F8EBE53DA516DEE189E199CDC09678B40A65C1D9854B3A4E45188D36D962175125C2781067DE1322E66787E0279B822FFE6BC0CD34B493356F87BCFF15EDE597EA7347E40E5F599C9F6869A77AF6D2F1DA0E8CC26E03EC2535707E56E3D337CCC331FB98C7C66FCE5CD56C5BC6F2D77E0BD42F4CDB72B65A25F0CF01CE147C7D1580C974B6FC3BE4DF316B9D6FE6A1AB87423C3DB7E</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 A7 06 00 68 4B AE 66
0010 | 78 01 00 00 1F 5F 04 F5 98 6F 64 A7 DD EA 29 51
0020 | 4E 0E 8D 15 D6 F2 76 D2 A5 02 24 04 0E D5 17 4D
0030 | F5 66 64 9C 15 AE 15 24 FE 50 01 00 AB E1 B5 6B
0040 | E2 63 76 2E A0 D5 E7 10 BF 0A 2A D1 0C 39 3B 30
0050 | D7 AE C4 E3 3C 0F DF 67 A1 FF 5B 6F 26 3B 82 78
0060 | 58 AF 46 4E 62 54 5D 4F C2 15 3D FB F3 3B 8D AB
0070 | 02 E3 61 C2 77 2C B2 66 50 0F 68 8B 38 27 A2 AE
0080 | BC FA 65 85 B6 6C 07 B1 85 FF 62 0B EC BD 28 A1
0090 | 95 8C BB 4E EC 14 22 9E FD 37 A1 10 C1 60 AE 2E
00A0 | E3 38 81 23 EA B0 02 5B 55 3C 27 47 0D B2 1C 6E
00B0 | 6D 06 CF AE 4B DC E6 29 7E 6A C2 A1 FC 38 7A A0
00C0 | FA 5D 3A BD 5B 8C 83 05 E0 B4 01 B7 9F 40 F2 E3
00D0 | C7 45 6D BB 7F 23 B3 24 32 63 54 C7 21 E8 80 34
00E0 | A6 22 9F 54 71 71 9C 27 78 A2 42 F4 6B 75 2A 90
00F0 | 9D 30 E2 EB 28 65 4F 8E BE 53 DA 51 6D EE 18 9E
0100 | 19 9C DC 09 67 8B 40 A6 5C 1D 98 54 B3 A4 E4 51
0110 | 88 D3 6D 96 21 75 12 5C 27 81 06 7D E1 32 2E 66
0120 | 78 7E 02 79 B8 22 FF E6 BC 0C D3 4B 49 33 56 F8
0130 | 7B CF F1 5E DE 59 7E A7 34 7E 40 E5 F5 99 C9 F6
0140 | 86 9A 77 AF 6D 2F 1D A0 E8 CC 26 E0 3E C2 53 57
0150 | 07 E5 6E 3D 33 7C CC 33 1F B9 8C 7C 66 FC E5 CD
0160 | 56 C5 BC 6F 2D 77 E0 BD 42 F4 CD B7 2B 65 A2 5F
0170 | 0C F0 1C E1 47 C7 D1 58 0C 97 4B 6F C3 BE 4D F3
0180 | 16 B9 D6 FE 6A 1A B8 74 23 C3 DB 7E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>78A70600684BAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100ABE1B56BE263762EA0D5E710</code> <code>BF0A2AD10C393B30D7AEC4E33C0FDF67</code> <code>A1FF5B6F263B827858AF464E62545D4F</code> <code>C2153DFBF33B8DAB02E361C2772CB266</code> <code>500F688B3827A2AEBCFA6585B66C07B1</code> <code>85FF620BECBD28A1958CBB4EEC14229E</code> <code>FD37A110C160AE2EE3388123EAB0025B</code> <code>553C27470DB21C6E6D06CFAE4BDCE629</code> <code>7E6AC2A1FC387AA0FA5D3ABD5B8C8305</code> <code>E0B401B79F40F2E3C7456DBB7F23B324</code> <code>326354C721E88034A6229F5471719C27</code> <code>78A242F46B752A909D30E2EB28654F8E</code> <code>BE53DA516DEE189E199CDC09678B40A6</code> <code>5C1D9854B3A4E45188D36D962175125C</code> <code>2781067DE1322E66787E0279B822FFE6</code> <code>BC0CD34B493356F87BCFF15EDE597EA7</code> <code>347E40E5F599C9F6869A77AF6D2F1DA0</code> <code>E8CC26E03EC2535707E56E3D337CCC33</code> <code>1FB98C7C66FCE5CD56C5BC6F2D77E0BD</code> <code>42F4CDB72B65A25F0CF01CE147C7D158</code> <code>0C974B6FC3BE4DF316B9D6FE6A1AB874</code><br> <code>23C3DB7E</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 29952891DEB88692CDBE7786DF0A8E36BF22842EF5DE2DA64E09811931C660F539C30850E21A95F6039A0F83436EF692E96D9F66A75209DC33935072E531363C5D58BE1F9C2C53C66AA224D612AF301A2E54E6EEFB8AC0A785F6134692100C91508ACAAE31F874C3614FBDF8759B8CA9EABA2B9A07E98FB274738A9D61F99ED1C2665CB44B920DEE33B84DF427240F83C59DEF87211C36BB0A99E69655091A7BD96358F6EFF595CF729471DC9586FB460C5E8854EBBD82CEE228811C432D7E3054CE43652216F74D6EA8AFC0E5589337C23DAA0F5E4EE4ADA2B53DC68511EAA493C4F9740718C7AA69112EFFF6B2644BD509B20C6E3472765ED1476035EC580A</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D0 ED F3 68 4B AE 66
0010 | 94 00 00 00 34 F7 CB 3B 98 6F 64 A7 DD EA 29 51
0020 | 4E 0E 8D 15 D6 F2 76 D2 A5 02 24 04 0E D5 17 4D
0030 | F5 66 64 9C 15 AE 15 24 BF 15 02 47 83 45 01 C5
0040 | 3B 1E E2 0F DC 89 E0 E4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D0EDF3684BAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>94000000</code> (148 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>986F64A7DDEA29514E0E8D15D6F276D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A50224040ED5174DF566649C15AE1524</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>BF150247834501C53B1EE20FDC89E0E4</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

