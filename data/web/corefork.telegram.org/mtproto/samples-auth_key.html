<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 84 47 0D 00 C3 E5 D7 68
0010 | 14 00 00 00 F1 8E 7E BE FC 37 72 BB A9 5C 97 B6
0020 | 7A CA 58 9F 8A B9 BF 53</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>84470D00C3E5D768</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 50 F4 9C C3 E5 D7 68
0010 | 50 00 00 00 63 24 16 05 FC 37 72 BB A9 5C 97 B6
0020 | 7A CA 58 9F 8A B9 BF 53 61 E3 EA FB 36 CB F5 14
0030 | 6E 30 30 A2 AC 60 FA C4 08 13 71 42 D1 32 E0 82
0040 | 15 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0150F49CC3E5D768</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08137142D132E08215000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1400974425358107157</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1400974425358107157</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1400974425358107157 = 1075372183 * 1302780979</code></p>
<pre><code>p = 1075372183
q = 1302780979</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 13 71 42 D1 32 E0 82 15 00 00 00
0010 | 04 40 18 E0 97 00 00 00 04 4D A6 DC 33 00 00 00
0020 | FC 37 72 BB A9 5C 97 B6 7A CA 58 9F 8A B9 BF 53
0030 | 61 E3 EA FB 36 CB F5 14 6E 30 30 A2 AC 60 FA C4
0040 | 26 63 5D 9C 37 E4 A8 4D 26 06 A0 60 6E 21 B7 45
0050 | 1F D0 9C 5E 6E 2C 4A 68 D6 05 3D 31 6C 98 19 87
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08137142D132E08215000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1400974425358107157</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044018E097000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1075372183</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044DA6DC33000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1302780979</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>26635D9C37E4A84D2606A0606E21B745</code> <code>1FD09C5E6E2C4A68D6053D316C981987</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908137142D132E08215000000044018E097000000044DA6DC33000000FC3772BBA95C97B67ACA589F8AB9BF5361E3EAFB36CBF5146E3030A2AC60FAC426635D9C37E4A84D2606A0606E21B7451FD09C5E6E2C4A68D6053D316C98198702000000
random_padding_bytes = ABC074102546F02B358716ECDCA26A8789CC46F621CE3FD923AA973A4D7BD1206B998C1FD32FE3948A45FDCD6A677420BF8AC34F54CCA8D0584C8958418C315C78C700B997672EADFB6CA37B8CB9FB9223A0E2D8FC5DC25FF1E8F8AF</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = C02E2B3F4B13A4A09523950995776BFDFF165B0BB28A9986FC6A08DD5B5440AC51A479B2C3E6E72DE41D97D4AE2D4853A398B8DEC1FF9D657A0F7FC874456B4F02A7BB152F704021E79F1FC0EAEFEDAB9F6BD2F04AF5B20A73C2BDF2BD6233D2200F2C04349309F05E7100A6ED2D76E82BF76CB8178CBC15ADC261DC9B156DAC0396AFCA67037621492902E6600F86E8D30B21415F6E4776419F64D3F74384A122E2C5FFC3D12D3BFBF73E1E66C64710C058444CEA4719DF55DC04A11B9AFCF2C0EE04C6A6E2D63149DB9126BBC64D4CB18C05489C76062D2A5AFAAAFE5511DA32DE4947B3AED9597576EC347F7B619E428AB294D73FF02678613416E3791218</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 88 47 0D 00 C3 E5 D7 68
0010 | 40 01 00 00 BE E4 12 D7 FC 37 72 BB A9 5C 97 B6
0020 | 7A CA 58 9F 8A B9 BF 53 61 E3 EA FB 36 CB F5 14
0030 | 6E 30 30 A2 AC 60 FA C4 04 40 18 E0 97 00 00 00
0040 | 04 4D A6 DC 33 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 C0 2E 2B 3F 4B 13 A4 A0 95 23 95 09
0060 | 95 77 6B FD FF 16 5B 0B B2 8A 99 86 FC 6A 08 DD
0070 | 5B 54 40 AC 51 A4 79 B2 C3 E6 E7 2D E4 1D 97 D4
0080 | AE 2D 48 53 A3 98 B8 DE C1 FF 9D 65 7A 0F 7F C8
0090 | 74 45 6B 4F 02 A7 BB 15 2F 70 40 21 E7 9F 1F C0
00A0 | EA EF ED AB 9F 6B D2 F0 4A F5 B2 0A 73 C2 BD F2
00B0 | BD 62 33 D2 20 0F 2C 04 34 93 09 F0 5E 71 00 A6
00C0 | ED 2D 76 E8 2B F7 6C B8 17 8C BC 15 AD C2 61 DC
00D0 | 9B 15 6D AC 03 96 AF CA 67 03 76 21 49 29 02 E6
00E0 | 60 0F 86 E8 D3 0B 21 41 5F 6E 47 76 41 9F 64 D3
00F0 | F7 43 84 A1 22 E2 C5 FF C3 D1 2D 3B FB F7 3E 1E
0100 | 66 C6 47 10 C0 58 44 4C EA 47 19 DF 55 DC 04 A1
0110 | 1B 9A FC F2 C0 EE 04 C6 A6 E2 D6 31 49 DB 91 26
0120 | BB C6 4D 4C B1 8C 05 48 9C 76 06 2D 2A 5A FA AA
0130 | FE 55 11 DA 32 DE 49 47 B3 AE D9 59 75 76 EC 34
0140 | 7F 7B 61 9E 42 8A B2 94 D7 3F F0 26 78 61 34 16
0150 | E3 79 12 18</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>88470D00C3E5D768</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044018E097000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1075372183</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044DA6DC33000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1302780979</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100C02E2B3F4B13A4A095239509</code> <code>95776BFDFF165B0BB28A9986FC6A08DD</code> <code>5B5440AC51A479B2C3E6E72DE41D97D4</code> <code>AE2D4853A398B8DEC1FF9D657A0F7FC8</code> <code>74456B4F02A7BB152F704021E79F1FC0</code> <code>EAEFEDAB9F6BD2F04AF5B20A73C2BDF2</code> <code>BD6233D2200F2C04349309F05E7100A6</code> <code>ED2D76E82BF76CB8178CBC15ADC261DC</code> <code>9B156DAC0396AFCA67037621492902E6</code> <code>600F86E8D30B21415F6E4776419F64D3</code> <code>F74384A122E2C5FFC3D12D3BFBF73E1E</code> <code>66C64710C058444CEA4719DF55DC04A1</code> <code>1B9AFCF2C0EE04C6A6E2D63149DB9126</code> <code>BBC64D4CB18C05489C76062D2A5AFAAA</code> <code>FE5511DA32DE4947B3AED9597576EC34</code> <code>7F7B619E428AB294D73FF02678613416</code><br> <code>E3791218</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 18 0E C2 C3 E5 D7 68
0010 | 78 02 00 00 5C 07 E8 D0 FC 37 72 BB A9 5C 97 B6
0020 | 7A CA 58 9F 8A B9 BF 53 61 E3 EA FB 36 CB F5 14
0030 | 6E 30 30 A2 AC 60 FA C4 FE 50 02 00 FA A9 7C 12
0040 | B6 6D 7B D8 53 06 4E DB 3C 0C 16 C3 6D E7 56 C6
0050 | 3C 45 2E 3E 96 87 04 00 3D 14 4B ED 06 0D E2 85
0060 | 52 F9 BE 7F A6 7C 64 DD 51 FE A4 3A 79 21 B2 7B
0070 | 9A A4 D4 24 99 18 BD 0C 7A 33 5D 54 C5 E5 05 4C
0080 | BF 3D 95 92 9B B1 73 CE 21 E8 07 CF E0 47 B5 69
0090 | 5B F8 33 A5 E2 FF 85 29 B9 60 9E 54 95 91 3F CE
00A0 | 8B 09 DD 66 4B 50 EB 29 88 76 49 EF 1D A1 0F D4
00B0 | 47 55 DA 3A 86 F9 CC C6 FF 5A 96 D9 BB 9D F2 40
00C0 | 98 FB 9E DE DA A4 15 06 28 EE 36 74 EF 17 E5 18
00D0 | C7 B9 1F 25 86 A2 A9 9D 7A E2 B6 A5 2E A4 11 B1
00E0 | 7C FD 3B AA B8 22 F2 EF 23 26 1E DA 5F 65 05 F1
00F0 | 7D DF 18 6A 3E DE 10 AE 05 DF 11 65 CF B3 E7 73
0100 | 76 8E 9F F8 5C E8 C4 79 D8 EC 24 2E 4E 54 5D 78
0110 | 9D CE 74 BA D3 D0 52 C2 1B 77 AE 1A 43 F5 DA 33
0120 | A6 CA EA E6 47 D2 78 90 C8 44 F2 C3 DD 38 58 80
0130 | E2 53 0E D6 1F 72 46 B3 40 7C CA B0 9F CF 51 38
0140 | EC AD 23 88 F7 37 3A 9C 7C A0 D4 C8 E2 23 85 E7
0150 | 3F 7B 67 13 CC 6C 70 8C 0C C1 7B EE 9A 00 A9 43
0160 | 25 19 49 69 20 C1 3C D2 53 73 4F C5 7B 0E 15 BD
0170 | 15 F7 4D BD B3 C5 AC 9C 32 A3 CF CA FE 30 F4 13
0180 | 14 4D C0 18 DE BD E1 E9 7E F0 08 CA 86 52 C3 7A
0190 | 82 0E D9 A4 19 B9 52 06 06 11 ED B3 1B AB 7F 5E
01A0 | 8E 3F CC 2D 9F E7 30 D3 56 66 18 75 77 56 E9 17
01B0 | 4F AA 9B E0 1D D2 C1 9E FF 89 76 D7 E2 15 43 92
01C0 | B8 57 41 CE 49 6F 03 B0 6E E0 D1 26 05 F5 A3 03
01D0 | E9 BD 30 3B 30 27 48 20 36 AB 00 66 1B 41 44 06
01E0 | 47 C0 B3 0C F3 4A E7 93 8D 44 74 4B 45 DE D2 29
01F0 | 05 3E 59 A0 82 5B 62 49 FF 22 2B 59 C6 D0 79 5B
0200 | 13 DC B4 15 50 2F 51 9F 60 8D 4D 96 D5 12 97 65
0210 | B1 69 84 9B AD 2F 31 69 E3 E7 34 57 F2 50 3D B2
0220 | 80 A3 B2 6A 7C 1C F8 87 2E 37 ED B9 58 1A 11 86
0230 | 36 66 24 31 F8 53 1E 13 C0 93 3E D9 34 AE 6E D4
0240 | EE 19 BE 9F A2 90 30 45 B5 BF DE 9A F9 42 68 A0
0250 | 14 48 6F 02 3C 3D E2 68 97 70 1C 84 60 D4 74 90
0260 | 51 30 69 6B 28 38 84 CB 2C 67 48 97 83 2C DF 6E
0270 | 94 96 9D 2C 67 A0 D9 EB 25 FB 2F EF 87 79 56 B7
0280 | 6D 73 EE EE F7 E0 63 D1 6A 3E 4E 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01180EC2C3E5D768</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200FAA97C12B66D7BD853064EDB</code> <code>3C0C16C36DE756C63C452E3E96870400</code> <code>3D144BED060DE28552F9BE7FA67C64DD</code> <code>51FEA43A7921B27B9AA4D4249918BD0C</code> <code>7A335D54C5E5054CBF3D95929BB173CE</code> <code>21E807CFE047B5695BF833A5E2FF8529</code> <code>B9609E5495913FCE8B09DD664B50EB29</code> <code>887649EF1DA10FD44755DA3A86F9CCC6</code> <code>FF5A96D9BB9DF24098FB9EDEDAA41506</code> <code>28EE3674EF17E518C7B91F2586A2A99D</code> <code>7AE2B6A52EA411B17CFD3BAAB822F2EF</code> <code>23261EDA5F6505F17DDF186A3EDE10AE</code> <code>05DF1165CFB3E773768E9FF85CE8C479</code> <code>D8EC242E4E545D789DCE74BAD3D052C2</code> <code>1B77AE1A43F5DA33A6CAEAE647D27890</code> <code>C844F2C3DD385880E2530ED61F7246B3</code> <code>407CCAB09FCF5138ECAD2388F7373A9C</code> <code>7CA0D4C8E22385E73F7B6713CC6C708C</code> <code>0CC17BEE9A00A9432519496920C13CD2</code> <code>53734FC57B0E15BD15F74DBDB3C5AC9C</code> <code>32A3CFCAFE30F413144DC018DEBDE1E9</code> <code>7EF008CA8652C37A820ED9A419B95206</code> <code>0611EDB31BAB7F5E8E3FCC2D9FE730D3</code> <code>566618757756E9174FAA9BE01DD2C19E</code> <code>FF8976D7E2154392B85741CE496F03B0</code> <code>6EE0D12605F5A303E9BD303B30274820</code> <code>36AB00661B41440647C0B30CF34AE793</code> <code>8D44744B45DED229053E59A0825B6249</code> <code>FF222B59C6D0795B13DCB415502F519F</code> <code>608D4D96D5129765B169849BAD2F3169</code> <code>E3E73457F2503DB280A3B26A7C1CF887</code> <code>2E37EDB9581A118636662431F8531E13</code> <code>C0933ED934AE6ED4EE19BE9FA2903045</code> <code>B5BFDE9AF94268A014486F023C3DE268</code> <code>97701C8460D474905130696B283884CB</code> <code>2C674897832CDF6E94969D2C67A0D9EB</code> <code>25FB2FEF877956B76D73EEEEF7E063D1</code><br> <code>6A3E4E1E</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = FAA97C12B66D7BD853064EDB3C0C16C36DE756C63C452E3E968704003D144BED060DE28552F9BE7FA67C64DD51FEA43A7921B27B9AA4D4249918BD0C7A335D54C5E5054CBF3D95929BB173CE21E807CFE047B5695BF833A5E2FF8529B9609E5495913FCE8B09DD664B50EB29887649EF1DA10FD44755DA3A86F9CCC6FF5A96D9BB9DF24098FB9EDEDAA4150628EE3674EF17E518C7B91F2586A2A99D7AE2B6A52EA411B17CFD3BAAB822F2EF23261EDA5F6505F17DDF186A3EDE10AE05DF1165CFB3E773768E9FF85CE8C479D8EC242E4E545D789DCE74BAD3D052C21B77AE1A43F5DA33A6CAEAE647D27890C844F2C3DD385880E2530ED61F7246B3407CCAB09FCF5138ECAD2388F7373A9C7CA0D4C8E22385E73F7B6713CC6C708C0CC17BEE9A00A9432519496920C13CD253734FC57B0E15BD15F74DBDB3C5AC9C32A3CFCAFE30F413144DC018DEBDE1E97EF008CA8652C37A820ED9A419B952060611EDB31BAB7F5E8E3FCC2D9FE730D3566618757756E9174FAA9BE01DD2C19EFF8976D7E2154392B85741CE496F03B06EE0D12605F5A303E9BD303B3027482036AB00661B41440647C0B30CF34AE7938D44744B45DED229053E59A0825B6249FF222B59C6D0795B13DCB415502F519F608D4D96D5129765B169849BAD2F3169E3E73457F2503DB280A3B26A7C1CF8872E37EDB9581A118636662431F8531E13C0933ED934AE6ED4EE19BE9FA2903045B5BFDE9AF94268A014486F023C3DE26897701C8460D474905130696B283884CB2C674897832CDF6E94969D2C67A0D9EB25FB2FEF877956B76D73EEEEF7E063D16A3E4E1E
tmp_aes_key = 23E9023EE86690A01559440434C02FF3EF45BE33058C4D59B39FC069D653B849
tmp_aes_iv = AF4B0FD7E4E1E221E42610D80BA0F521F999D88EBBAEE95E152C421126635D9C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1CD9DC501E611266367A877BE58209232B268002BA0D89B5FC3772BBA95C97B67ACA589F8AB9BF5361E3EAFB36CBF5146E3030A2AC60FAC403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010059764412F1B1CDE35DF49E6E0B101B7F90702287E1C694690020652E8FAD74F9A3F7BF8E925752E5B5D1E52689DB4D1EF9FDB6D9D0BE85838DC937B1F73ECB709DF498CF53F43744961EA7120928265B662BF4024F9C674A7BE61F648CE612C4928A765CBA5B501F2B0F1055A2055A284C93E43679BEE1DF2610CB0761FDCC4480985E9AB12AD3D60B3D79AA0365C3039BA51231B1017EA1DD6A83F67AE2D36C5BFD967028CC58833C42A09EB055D07B8B2C2AC06BD67A9C19504380440B7602E28541D909A2E5845E23B8D356B631F2E09FFDA9913412CA10EA93D04C2ACC153FDBE867DB0C2DBA76748C2DE6501627A7DDFB368EA3AE51913C06A29B16965BC3E5D768A7B07AABB746D7B4
answer = BA0D89B5FC3772BBA95C97B67ACA589F8AB9BF5361E3EAFB36CBF5146E3030A2AC60FAC403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010059764412F1B1CDE35DF49E6E0B101B7F90702287E1C694690020652E8FAD74F9A3F7BF8E925752E5B5D1E52689DB4D1EF9FDB6D9D0BE85838DC937B1F73ECB709DF498CF53F43744961EA7120928265B662BF4024F9C674A7BE61F648CE612C4928A765CBA5B501F2B0F1055A2055A284C93E43679BEE1DF2610CB0761FDCC4480985E9AB12AD3D60B3D79AA0365C3039BA51231B1017EA1DD6A83F67AE2D36C5BFD967028CC58833C42A09EB055D07B8B2C2AC06BD67A9C19504380440B7602E28541D909A2E5845E23B8D356B631F2E09FFDA9913412CA10EA93D04C2ACC153FDBE867DB0C2DBA76748C2DE6501627A7DDFB368EA3AE51913C06A29B16965BC3E5D768A7B07AABB746D7B4</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 FC 37 72 BB A9 5C 97 B6 7A CA 58 9F
0010 | 8A B9 BF 53 61 E3 EA FB 36 CB F5 14 6E 30 30 A2
0020 | AC 60 FA C4 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 59 76 44 12 F1 B1 CD E3 5D F4 9E 6E 0B 10 1B 7F
0140 | 90 70 22 87 E1 C6 94 69 00 20 65 2E 8F AD 74 F9
0150 | A3 F7 BF 8E 92 57 52 E5 B5 D1 E5 26 89 DB 4D 1E
0160 | F9 FD B6 D9 D0 BE 85 83 8D C9 37 B1 F7 3E CB 70
0170 | 9D F4 98 CF 53 F4 37 44 96 1E A7 12 09 28 26 5B
0180 | 66 2B F4 02 4F 9C 67 4A 7B E6 1F 64 8C E6 12 C4
0190 | 92 8A 76 5C BA 5B 50 1F 2B 0F 10 55 A2 05 5A 28
01A0 | 4C 93 E4 36 79 BE E1 DF 26 10 CB 07 61 FD CC 44
01B0 | 80 98 5E 9A B1 2A D3 D6 0B 3D 79 AA 03 65 C3 03
01C0 | 9B A5 12 31 B1 01 7E A1 DD 6A 83 F6 7A E2 D3 6C
01D0 | 5B FD 96 70 28 CC 58 83 3C 42 A0 9E B0 55 D0 7B
01E0 | 8B 2C 2A C0 6B D6 7A 9C 19 50 43 80 44 0B 76 02
01F0 | E2 85 41 D9 09 A2 E5 84 5E 23 B8 D3 56 B6 31 F2
0200 | E0 9F FD A9 91 34 12 CA 10 EA 93 D0 4C 2A CC 15
0210 | 3F DB E8 67 DB 0C 2D BA 76 74 8C 2D E6 50 16 27
0220 | A7 DD FB 36 8E A3 AE 51 91 3C 06 A2 9B 16 96 5B
0230 | C3 E5 D7 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010059764412F1B1CDE35DF49E6E</code> <code>0B101B7F90702287E1C694690020652E</code> <code>8FAD74F9A3F7BF8E925752E5B5D1E526</code> <code>89DB4D1EF9FDB6D9D0BE85838DC937B1</code> <code>F73ECB709DF498CF53F43744961EA712</code> <code>0928265B662BF4024F9C674A7BE61F64</code> <code>8CE612C4928A765CBA5B501F2B0F1055</code> <code>A2055A284C93E43679BEE1DF2610CB07</code> <code>61FDCC4480985E9AB12AD3D60B3D79AA</code> <code>0365C3039BA51231B1017EA1DD6A83F6</code> <code>7AE2D36C5BFD967028CC58833C42A09E</code> <code>B055D07B8B2C2AC06BD67A9C19504380</code> <code>440B7602E28541D909A2E5845E23B8D3</code> <code>56B631F2E09FFDA9913412CA10EA93D0</code> <code>4C2ACC153FDBE867DB0C2DBA76748C2D</code> <code>E6501627A7DDFB368EA3AE51913C06A2</code><br> <code>9B16965B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>C3E5D768</code> (1758979523 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 2346E07D269E2407CBFAB7B165C0DA86F60D00FA2EE44F95343187DF3833DA4E4CE55595A924CFDA63874EBCB0A8C13508140396D48DB45A0F520E6342DEBF0698E0F5B1F2EB42A9877B75F2879A59B332B44E18538C57D3211B14EF27DDE6017F8E19CF151E6C088B759BC727E7DA40652FA8B9F257722EB2C366F0B49B57838FB1CF20B87526AB48174BD62D8001579A586B815648AEE3A3E2627F2432B062841B843DB9A71820B2C651A60A7F6F8E8A353DB933733526F6899C69CAC144CC6B7B67EB428DB7E2742E58BF3EA1D2B67A600A12A25E15B22549677C45562EF9CB7822065B8AC4232DD2A69C374B6C64EAE513F135C4AFCC0E908D7FB4E6D4FE</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 7C71B6E523386CB3AE4F5E13CB929931E85DA819626D66A148C677E24C53843C5DD14F0B45C99275221B64D5B371A88561DC9103F848D796834826E14C40242EE1B7300F5381FBC05E4FE215E47A853F10AA04168ECC94BB437641F178F6827C9C212EDB839893E73B6A561F9E4D7E0C8B269215599C7566AEF40B35B129A4E53EB3FAB888A23C4906465ADC4C66655241BDEBB73D44A1A69895644CE181BD1034FD64541F6AB9C0B59F10350364CFFD06EE8DDD78D3FCE53940E8C9B036A86C6DC8792C4B18A6EBD44ED3B0293E2E86215DF3ECB9873F36827D0F8B93CB367AE4416641944B168608949EB2B63DE67FD388B6AEDF85600704E1A5C8D81DA239</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 FC 37 72 BB A9 5C 97 B6 7A CA 58 9F
0010 | 8A B9 BF 53 61 E3 EA FB 36 CB F5 14 6E 30 30 A2
0020 | AC 60 FA C4 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 7C 71 B6 E5 23 38 6C B3 AE 4F 5E 13 CB 92 99 31
0040 | E8 5D A8 19 62 6D 66 A1 48 C6 77 E2 4C 53 84 3C
0050 | 5D D1 4F 0B 45 C9 92 75 22 1B 64 D5 B3 71 A8 85
0060 | 61 DC 91 03 F8 48 D7 96 83 48 26 E1 4C 40 24 2E
0070 | E1 B7 30 0F 53 81 FB C0 5E 4F E2 15 E4 7A 85 3F
0080 | 10 AA 04 16 8E CC 94 BB 43 76 41 F1 78 F6 82 7C
0090 | 9C 21 2E DB 83 98 93 E7 3B 6A 56 1F 9E 4D 7E 0C
00A0 | 8B 26 92 15 59 9C 75 66 AE F4 0B 35 B1 29 A4 E5
00B0 | 3E B3 FA B8 88 A2 3C 49 06 46 5A DC 4C 66 65 52
00C0 | 41 BD EB B7 3D 44 A1 A6 98 95 64 4C E1 81 BD 10
00D0 | 34 FD 64 54 1F 6A B9 C0 B5 9F 10 35 03 64 CF FD
00E0 | 06 EE 8D DD 78 D3 FC E5 39 40 E8 C9 B0 36 A8 6C
00F0 | 6D C8 79 2C 4B 18 A6 EB D4 4E D3 B0 29 3E 2E 86
0100 | 21 5D F3 EC B9 87 3F 36 82 7D 0F 8B 93 CB 36 7A
0110 | E4 41 66 41 94 4B 16 86 08 94 9E B2 B6 3D E6 7F
0120 | D3 88 B6 AE DF 85 60 07 04 E1 A5 C8 D8 1D A2 39</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001007C71B6E523386CB3AE4F5E13</code> <code>CB929931E85DA819626D66A148C677E2</code> <code>4C53843C5DD14F0B45C99275221B64D5</code> <code>B371A88561DC9103F848D796834826E1</code> <code>4C40242EE1B7300F5381FBC05E4FE215</code> <code>E47A853F10AA04168ECC94BB437641F1</code> <code>78F6827C9C212EDB839893E73B6A561F</code> <code>9E4D7E0C8B269215599C7566AEF40B35</code> <code>B129A4E53EB3FAB888A23C4906465ADC</code> <code>4C66655241BDEBB73D44A1A69895644C</code> <code>E181BD1034FD64541F6AB9C0B59F1035</code> <code>0364CFFD06EE8DDD78D3FCE53940E8C9</code> <code>B036A86C6DC8792C4B18A6EBD44ED3B0</code> <code>293E2E86215DF3ECB9873F36827D0F8B</code> <code>93CB367AE4416641944B168608949EB2</code> <code>B63DE67FD388B6AEDF85600704E1A5C8</code><br> <code>D81DA239</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366FC3772BBA95C97B67ACA589F8AB9BF5361E3EAFB36CBF5146E3030A2AC60FAC40000000000000000FE0001007C71B6E523386CB3AE4F5E13CB929931E85DA819626D66A148C677E24C53843C5DD14F0B45C99275221B64D5B371A88561DC9103F848D796834826E14C40242EE1B7300F5381FBC05E4FE215E47A853F10AA04168ECC94BB437641F178F6827C9C212EDB839893E73B6A561F9E4D7E0C8B269215599C7566AEF40B35B129A4E53EB3FAB888A23C4906465ADC4C66655241BDEBB73D44A1A69895644CE181BD1034FD64541F6AB9C0B59F10350364CFFD06EE8DDD78D3FCE53940E8C9B036A86C6DC8792C4B18A6EBD44ED3B0293E2E86215DF3ECB9873F36827D0F8B93CB367AE4416641944B168608949EB2B63DE67FD388B6AEDF85600704E1A5C8D81DA239
padding = 1E7FD2BB4BA93ED0FE50CDBC
tmp_aes_key = 23E9023EE86690A01559440434C02FF3EF45BE33058C4D59B39FC069D653B849
tmp_aes_iv = AF4B0FD7E4E1E221E42610D80BA0F521F999D88EBBAEE95E152C421126635D9C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 6FD6CA277BE8FF5FC70E8A542055E3A9A0AD1B753EF85914AB8C243BEB80B222AA19443661C8243081FBD8FEB40EAADC644CF28752E79AE239A17CCF85242A600EA32F5FB15D8474AD5526392B273659690ABF40D8656F4B1523ADE9121096A3BFCB891E380E518BB05334A9746AB142C1958A810516A5CB3CECA54D7B963553F24D6DC32A7810E18F98E0D511A50FF9C0745E32216DDA7C9C80D8F74033F8C038065BCF5E5583AFABE1ABA5E4708A044E844B0D5C3349112368FC82CA3C818BAA3989110B3F9C532F7C2B7B3AC0EA126B9F31F8318B4D2E76A721FC374B515A858C2D6B25A717CEE2F0F6D3E53757ABC9AD325AE3F5ED9A1FC5687969B8D42E846B7312722815832A5B9D6E3BE98BBAE37AD439664B9211D0196E25506A0D0340424C024BA5930570EF11E7D5B5931694600951CECABCB31B13BECCFD629C9B9B73EF3F2016537C4462F72864ABAC08</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D0 99 0D 00 C3 E5 D7 68
0010 | 78 01 00 00 1F 5F 04 F5 FC 37 72 BB A9 5C 97 B6
0020 | 7A CA 58 9F 8A B9 BF 53 61 E3 EA FB 36 CB F5 14
0030 | 6E 30 30 A2 AC 60 FA C4 FE 50 01 00 6F D6 CA 27
0040 | 7B E8 FF 5F C7 0E 8A 54 20 55 E3 A9 A0 AD 1B 75
0050 | 3E F8 59 14 AB 8C 24 3B EB 80 B2 22 AA 19 44 36
0060 | 61 C8 24 30 81 FB D8 FE B4 0E AA DC 64 4C F2 87
0070 | 52 E7 9A E2 39 A1 7C CF 85 24 2A 60 0E A3 2F 5F
0080 | B1 5D 84 74 AD 55 26 39 2B 27 36 59 69 0A BF 40
0090 | D8 65 6F 4B 15 23 AD E9 12 10 96 A3 BF CB 89 1E
00A0 | 38 0E 51 8B B0 53 34 A9 74 6A B1 42 C1 95 8A 81
00B0 | 05 16 A5 CB 3C EC A5 4D 7B 96 35 53 F2 4D 6D C3
00C0 | 2A 78 10 E1 8F 98 E0 D5 11 A5 0F F9 C0 74 5E 32
00D0 | 21 6D DA 7C 9C 80 D8 F7 40 33 F8 C0 38 06 5B CF
00E0 | 5E 55 83 AF AB E1 AB A5 E4 70 8A 04 4E 84 4B 0D
00F0 | 5C 33 49 11 23 68 FC 82 CA 3C 81 8B AA 39 89 11
0100 | 0B 3F 9C 53 2F 7C 2B 7B 3A C0 EA 12 6B 9F 31 F8
0110 | 31 8B 4D 2E 76 A7 21 FC 37 4B 51 5A 85 8C 2D 6B
0120 | 25 A7 17 CE E2 F0 F6 D3 E5 37 57 AB C9 AD 32 5A
0130 | E3 F5 ED 9A 1F C5 68 79 69 B8 D4 2E 84 6B 73 12
0140 | 72 28 15 83 2A 5B 9D 6E 3B E9 8B BA E3 7A D4 39
0150 | 66 4B 92 11 D0 19 6E 25 50 6A 0D 03 40 42 4C 02
0160 | 4B A5 93 05 70 EF 11 E7 D5 B5 93 16 94 60 09 51
0170 | CE CA BC B3 1B 13 BE CC FD 62 9C 9B 9B 73 EF 3F
0180 | 20 16 53 7C 44 62 F7 28 64 AB AC 08</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D0990D00C3E5D768</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001006FD6CA277BE8FF5FC70E8A54</code> <code>2055E3A9A0AD1B753EF85914AB8C243B</code> <code>EB80B222AA19443661C8243081FBD8FE</code> <code>B40EAADC644CF28752E79AE239A17CCF</code> <code>85242A600EA32F5FB15D8474AD552639</code> <code>2B273659690ABF40D8656F4B1523ADE9</code> <code>121096A3BFCB891E380E518BB05334A9</code> <code>746AB142C1958A810516A5CB3CECA54D</code> <code>7B963553F24D6DC32A7810E18F98E0D5</code> <code>11A50FF9C0745E32216DDA7C9C80D8F7</code> <code>4033F8C038065BCF5E5583AFABE1ABA5</code> <code>E4708A044E844B0D5C3349112368FC82</code> <code>CA3C818BAA3989110B3F9C532F7C2B7B</code> <code>3AC0EA126B9F31F8318B4D2E76A721FC</code> <code>374B515A858C2D6B25A717CEE2F0F6D3</code> <code>E53757ABC9AD325AE3F5ED9A1FC56879</code> <code>69B8D42E846B7312722815832A5B9D6E</code> <code>3BE98BBAE37AD439664B9211D0196E25</code> <code>506A0D0340424C024BA5930570EF11E7</code> <code>D5B5931694600951CECABCB31B13BECC</code> <code>FD629C9B9B73EF3F2016537C4462F728</code><br> <code>64ABAC08</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 64FA8FA72D1F84DE9418326B2698F5816898518895EDEEA9AF1BD62FD9537D9F7A53D4A3B9C29BF1D4C1021F2D90429C90C1F23B050CFD05C75069B86B1F4C24C64491501870DC5101CD36383058DBFA8D66027061DF0689A456FA085BA97C0D91566A5A4418C48BAA1F9FC591C55E2BB529D94834F76B42664747CD79D8FF63448335855D85840D82185AA804F48E189C036CFEC4A73588FCA9D531451F3E9D98995D5BD63F6AEF3379F567D43179704B5D218D44225817661EEE15AC66F0047399381E5A2E1B5903A78A7F062AC2BAF8E84E910679BD2E1FB90C4B75103C4D6D9B817B2879E67EFC2CDE4E69FE5A96B9EEE4832FE24A27490A485B4CD17BAE</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 15 D7 C4 E5 D7 68
0010 | 34 00 00 00 34 F7 CB 3B FC 37 72 BB A9 5C 97 B6
0020 | 7A CA 58 9F 8A B9 BF 53 61 E3 EA FB 36 CB F5 14
0030 | 6E 30 30 A2 AC 60 FA C4 85 C9 21 37 D0 18 42 11
0040 | F6 F9 0A 07 B0 CF 0C FD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C415D7C4E5D768</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FC3772BBA95C97B67ACA589F8AB9BF53</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>61E3EAFB36CBF5146E3030A2AC60FAC4</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>85C92137D0184211F6F90A07B0CF0CFD</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

