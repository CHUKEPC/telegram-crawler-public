<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 10 85 08 00 3D 30 36 67
0010 | 14 00 00 00 F1 8E 7E BE 54 DA A8 B2 DC EB EE E5
0020 | 17 AF C9 51 30 15 70 BE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>108508003D303667</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 BD 74 3D 30 36 67
0010 | 50 00 00 00 63 24 16 05 54 DA A8 B2 DC EB EE E5
0020 | 17 AF C9 51 30 15 70 BE 81 FF 56 11 A6 F0 7A E1
0030 | 01 5B D4 18 9E 60 68 7C 08 1F 1F C6 6E 4F BE 17
0040 | B3 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0160BD743D303667</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081F1FC66E4FBE17B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2242729316540356531</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2242729316540356531</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2242729316540356531 = 1264011563 * 1774294937</code></p>
<pre><code>p = 1264011563
q = 1774294937</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1F 1F C6 6E 4F BE 17 B3 00 00 00
0010 | 04 4B 57 49 2B 00 00 00 04 69 C1 97 99 00 00 00
0020 | 54 DA A8 B2 DC EB EE E5 17 AF C9 51 30 15 70 BE
0030 | 81 FF 56 11 A6 F0 7A E1 01 5B D4 18 9E 60 68 7C
0040 | 7A 60 4C AB 45 B4 5B F0 42 7F 21 87 79 75 84 83
0050 | AE 46 51 59 68 72 7D 4B 69 3E E7 7D 4F 9E 13 E6
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081F1FC66E4FBE17B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2242729316540356531</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044B57492B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1264011563</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0469C19799000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1774294937</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>7A604CAB45B45BF0427F218779758483</code> <code>AE46515968727D4B693EE77D4F9E13E6</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081F1FC66E4FBE17B3000000044B57492B0000000469C1979900000054DAA8B2DCEBEEE517AFC951301570BE81FF5611A6F07AE1015BD4189E60687C7A604CAB45B45BF0427F218779758483AE46515968727D4B693EE77D4F9E13E602000000
random_padding_bytes = D503DA1E32E2EBC9631A4D993D1CED6CFB4B2A11B6455D57DD36876CDD95574DCE2A4E86BC68648665AF75884AFB7E2224AAAF47F39AE7682FD5B53C70AB2E89B099B925ED9160F9A65DFA0EF1918F508EAE015BED1DFE8D117A3B52</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A081BF56C2D856A0E357DA4B778979AD521AEBB49C3B3FA282937104F02DFBBA21EE8AE8DE17D9F1A223325244BD232DCA89ECBD1D87C719EA6094827BD42357D03F7797481529516EBC600213B079683EC15FEC36E01ACBFAC69907D47B6947022607D96E2841FB421F4F733CB17F36A1BFC8CEF775B759985435DB9C24F7A5CCE34439CA4A0A5DF1BF1B243DF35B85D6447FE241C2945405686B8A238BA3DA952366568E887956757DF99DA1EB2C668F1A8FB37C3D4D22A8DB2A7BDAE78D7A806D2D32B027C6EB5512FFECCCBBE7D94F4291547679FF559CAE940878EFF411361AD0C6C218ACF1D8E74A8BE6E55F8E569C36E00F14C9733BFBF88D6D377E1A</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 14 85 08 00 3D 30 36 67
0010 | 40 01 00 00 BE E4 12 D7 54 DA A8 B2 DC EB EE E5
0020 | 17 AF C9 51 30 15 70 BE 81 FF 56 11 A6 F0 7A E1
0030 | 01 5B D4 18 9E 60 68 7C 04 4B 57 49 2B 00 00 00
0040 | 04 69 C1 97 99 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A0 81 BF 56 C2 D8 56 A0 E3 57 DA 4B
0060 | 77 89 79 AD 52 1A EB B4 9C 3B 3F A2 82 93 71 04
0070 | F0 2D FB BA 21 EE 8A E8 DE 17 D9 F1 A2 23 32 52
0080 | 44 BD 23 2D CA 89 EC BD 1D 87 C7 19 EA 60 94 82
0090 | 7B D4 23 57 D0 3F 77 97 48 15 29 51 6E BC 60 02
00A0 | 13 B0 79 68 3E C1 5F EC 36 E0 1A CB FA C6 99 07
00B0 | D4 7B 69 47 02 26 07 D9 6E 28 41 FB 42 1F 4F 73
00C0 | 3C B1 7F 36 A1 BF C8 CE F7 75 B7 59 98 54 35 DB
00D0 | 9C 24 F7 A5 CC E3 44 39 CA 4A 0A 5D F1 BF 1B 24
00E0 | 3D F3 5B 85 D6 44 7F E2 41 C2 94 54 05 68 6B 8A
00F0 | 23 8B A3 DA 95 23 66 56 8E 88 79 56 75 7D F9 9D
0100 | A1 EB 2C 66 8F 1A 8F B3 7C 3D 4D 22 A8 DB 2A 7B
0110 | DA E7 8D 7A 80 6D 2D 32 B0 27 C6 EB 55 12 FF EC
0120 | CC BB E7 D9 4F 42 91 54 76 79 FF 55 9C AE 94 08
0130 | 78 EF F4 11 36 1A D0 C6 C2 18 AC F1 D8 E7 4A 8B
0140 | E6 E5 5F 8E 56 9C 36 E0 0F 14 C9 73 3B FB F8 8D
0150 | 6D 37 7E 1A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>148508003D303667</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044B57492B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1264011563</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0469C19799000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1774294937</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A081BF56C2D856A0E357DA4B</code> <code>778979AD521AEBB49C3B3FA282937104</code> <code>F02DFBBA21EE8AE8DE17D9F1A2233252</code> <code>44BD232DCA89ECBD1D87C719EA609482</code> <code>7BD42357D03F7797481529516EBC6002</code> <code>13B079683EC15FEC36E01ACBFAC69907</code> <code>D47B6947022607D96E2841FB421F4F73</code> <code>3CB17F36A1BFC8CEF775B759985435DB</code> <code>9C24F7A5CCE34439CA4A0A5DF1BF1B24</code> <code>3DF35B85D6447FE241C2945405686B8A</code> <code>238BA3DA952366568E887956757DF99D</code> <code>A1EB2C668F1A8FB37C3D4D22A8DB2A7B</code> <code>DAE78D7A806D2D32B027C6EB5512FFEC</code> <code>CCBBE7D94F4291547679FF559CAE9408</code> <code>78EFF411361AD0C6C218ACF1D8E74A8B</code> <code>E6E55F8E569C36E00F14C9733BFBF88D</code><br> <code>6D377E1A</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 5C F2 8F 3D 30 36 67
0010 | 78 02 00 00 5C 07 E8 D0 54 DA A8 B2 DC EB EE E5
0020 | 17 AF C9 51 30 15 70 BE 81 FF 56 11 A6 F0 7A E1
0030 | 01 5B D4 18 9E 60 68 7C FE 50 02 00 6B 76 AC D9
0040 | 99 18 16 CC 04 EA 66 07 7E 7F 79 93 E3 7C 70 B1
0050 | 39 A4 D9 B9 34 79 68 56 E5 E7 7C C3 66 12 2C A5
0060 | E7 B0 11 D1 FB 38 9F F7 96 E6 12 57 A9 6E D8 6E
0070 | 89 CD 4F 8B 96 C7 7E 0D 83 6D 4A E1 6C 36 D5 DA
0080 | E9 FD D8 22 0D E1 F6 CB E4 A4 59 EB 73 D6 AC 1E
0090 | A9 07 3A 2A EF 6E 3D 1D 01 9C DB 8E 27 1C D2 1D
00A0 | 6E 30 38 61 75 DF 53 16 71 3C EA 47 E0 CA C3 59
00B0 | 3C 9C 63 7D BF 1B D4 C3 68 F7 DC 8F 5F 0D 2E 9A
00C0 | 47 4F 5B 90 DA EB 22 91 66 61 67 0C A6 20 6C 7E
00D0 | 0B 0F 25 72 81 E1 8F EA B5 5B 94 B9 DC B8 90 8D
00E0 | 67 56 2B 76 CB 44 47 DF 8F EB 31 CE B3 85 59 AD
00F0 | 41 3D 96 48 EC BE 08 2B 87 23 99 5E 01 EF 34 3D
0100 | 8C 27 AC EE BB 7B F6 33 04 88 4A 6C 25 7F 93 24
0110 | 7A F6 C6 9E C7 F9 4D 2C 91 D0 BC 83 EC B0 9C 98
0120 | 63 04 A3 C7 5A FD 54 E7 2F 25 F6 99 3B D2 81 AC
0130 | F2 BB 2D 59 15 83 D1 58 28 BE 6C AE 28 25 0E D9
0140 | A0 0E 22 4D 1A 9F 88 9D BC 98 7E FD 45 C8 D8 C8
0150 | 44 D9 AC 18 F9 E0 E0 44 D8 9F AC 9B 80 BC 09 F3
0160 | FE F4 ED B6 EC CB EF 4C 2D 37 FF BB 05 C1 E0 8E
0170 | F1 00 1F 7F 22 A4 89 1C C5 FD 0D 10 1E AB 64 6B
0180 | F0 23 7B DB 5B 90 F8 87 67 1E 18 2B A1 2C 2A EC
0190 | 00 DC BC B4 E9 70 36 11 1D 3E 01 C0 B1 69 E9 46
01A0 | 0E 8C 3C 66 06 42 C2 9D 7C 1B 7C 1E 03 2E 2F 11
01B0 | B2 E5 0A 6C CC 28 3D 54 92 00 E9 63 55 7B 67 6F
01C0 | 42 A6 80 72 A5 5D EE DE 8D BF 08 C0 C1 09 D5 80
01D0 | B3 BD DD 34 D5 1F 81 70 38 06 9E D7 48 12 36 A3
01E0 | AD CD F9 08 B8 83 1B 32 7E CF E7 AC DA E6 D0 5C
01F0 | 6B EE CB 99 F1 15 95 CF 7C 67 B3 A4 90 52 7E B6
0200 | EF 31 DD 8A 4D 3E 8B 3B 8A 37 21 DF 6D FD 3A 93
0210 | 68 FB EF 4C F8 F0 79 AB 1D C5 D5 5F F9 41 DA 71
0220 | E8 0E EB F5 91 4B E9 9A D1 DC 0F CF D8 2D 72 64
0230 | 02 37 C7 40 03 5A 4B 6A 4D 22 95 9B BA E2 10 2C
0240 | BF 54 C9 18 9F 35 A7 02 A8 B8 3D C2 2A 26 DD 0C
0250 | C0 0F 10 84 9B 19 2B 76 1A 5B B8 BC 48 1D 81 D4
0260 | 4A 61 B7 36 D0 72 FD 80 39 FF 7D 7E EA 53 67 BB
0270 | 58 93 AD 68 5F 7B B4 73 9B 59 8D 54 E6 85 66 FD
0280 | E6 13 FC 9E 25 C9 37 EA CE 7F 8B 19</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015CF28F3D303667</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002006B76ACD9991816CC04EA6607</code> <code>7E7F7993E37C70B139A4D9B934796856</code> <code>E5E77CC366122CA5E7B011D1FB389FF7</code> <code>96E61257A96ED86E89CD4F8B96C77E0D</code> <code>836D4AE16C36D5DAE9FDD8220DE1F6CB</code> <code>E4A459EB73D6AC1EA9073A2AEF6E3D1D</code> <code>019CDB8E271CD21D6E30386175DF5316</code> <code>713CEA47E0CAC3593C9C637DBF1BD4C3</code> <code>68F7DC8F5F0D2E9A474F5B90DAEB2291</code> <code>6661670CA6206C7E0B0F257281E18FEA</code> <code>B55B94B9DCB8908D67562B76CB4447DF</code> <code>8FEB31CEB38559AD413D9648ECBE082B</code> <code>8723995E01EF343D8C27ACEEBB7BF633</code> <code>04884A6C257F93247AF6C69EC7F94D2C</code> <code>91D0BC83ECB09C986304A3C75AFD54E7</code> <code>2F25F6993BD281ACF2BB2D591583D158</code> <code>28BE6CAE28250ED9A00E224D1A9F889D</code> <code>BC987EFD45C8D8C844D9AC18F9E0E044</code> <code>D89FAC9B80BC09F3FEF4EDB6ECCBEF4C</code> <code>2D37FFBB05C1E08EF1001F7F22A4891C</code> <code>C5FD0D101EAB646BF0237BDB5B90F887</code> <code>671E182BA12C2AEC00DCBCB4E9703611</code> <code>1D3E01C0B169E9460E8C3C660642C29D</code> <code>7C1B7C1E032E2F11B2E50A6CCC283D54</code> <code>9200E963557B676F42A68072A55DEEDE</code> <code>8DBF08C0C109D580B3BDDD34D51F8170</code> <code>38069ED7481236A3ADCDF908B8831B32</code> <code>7ECFE7ACDAE6D05C6BEECB99F11595CF</code> <code>7C67B3A490527EB6EF31DD8A4D3E8B3B</code> <code>8A3721DF6DFD3A9368FBEF4CF8F079AB</code> <code>1DC5D55FF941DA71E80EEBF5914BE99A</code> <code>D1DC0FCFD82D72640237C740035A4B6A</code> <code>4D22959BBAE2102CBF54C9189F35A702</code> <code>A8B83DC22A26DD0CC00F10849B192B76</code> <code>1A5BB8BC481D81D44A61B736D072FD80</code> <code>39FF7D7EEA5367BB5893AD685F7BB473</code> <code>9B598D54E68566FDE613FC9E25C937EA</code><br> <code>CE7F8B19</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 6B76ACD9991816CC04EA66077E7F7993E37C70B139A4D9B934796856E5E77CC366122CA5E7B011D1FB389FF796E61257A96ED86E89CD4F8B96C77E0D836D4AE16C36D5DAE9FDD8220DE1F6CBE4A459EB73D6AC1EA9073A2AEF6E3D1D019CDB8E271CD21D6E30386175DF5316713CEA47E0CAC3593C9C637DBF1BD4C368F7DC8F5F0D2E9A474F5B90DAEB22916661670CA6206C7E0B0F257281E18FEAB55B94B9DCB8908D67562B76CB4447DF8FEB31CEB38559AD413D9648ECBE082B8723995E01EF343D8C27ACEEBB7BF63304884A6C257F93247AF6C69EC7F94D2C91D0BC83ECB09C986304A3C75AFD54E72F25F6993BD281ACF2BB2D591583D15828BE6CAE28250ED9A00E224D1A9F889DBC987EFD45C8D8C844D9AC18F9E0E044D89FAC9B80BC09F3FEF4EDB6ECCBEF4C2D37FFBB05C1E08EF1001F7F22A4891CC5FD0D101EAB646BF0237BDB5B90F887671E182BA12C2AEC00DCBCB4E97036111D3E01C0B169E9460E8C3C660642C29D7C1B7C1E032E2F11B2E50A6CCC283D549200E963557B676F42A68072A55DEEDE8DBF08C0C109D580B3BDDD34D51F817038069ED7481236A3ADCDF908B8831B327ECFE7ACDAE6D05C6BEECB99F11595CF7C67B3A490527EB6EF31DD8A4D3E8B3B8A3721DF6DFD3A9368FBEF4CF8F079AB1DC5D55FF941DA71E80EEBF5914BE99AD1DC0FCFD82D72640237C740035A4B6A4D22959BBAE2102CBF54C9189F35A702A8B83DC22A26DD0CC00F10849B192B761A5BB8BC481D81D44A61B736D072FD8039FF7D7EEA5367BB5893AD685F7BB4739B598D54E68566FDE613FC9E25C937EACE7F8B19
tmp_aes_key = 3A849EC95DD739CDF5CBB89541EF40A7AC44B6DD578FE0EEFB6F69D6A7F53B0E
tmp_aes_iv = 017E0CD56F04427115EB81053316733539313883BBCFDF9868E7952F7A604CAB</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 84109E5E4B9CB0090396548F852A37C9728ECA4BBA0D89B554DAA8B2DCEBEEE517AFC951301570BE81FF5611A6F07AE1015BD4189E60687C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001006C2129B293D09F638E9EFBBA9BE6989A9C7791E02A1B74B94ECA7B576A19550C58D97B2AB1D93FAD1F5202F70E3C3EEEF410483CCCE89EDEA24BB163CEFC39222A52A761947F6E79A93F672A934398062EAD653B2CE6FCE627DA0E1A92DD5931BD2FB9220CA95235EF0E3C9CBFA70FF5125BB278E1BA5D3EFCC6AC957C02EA5F5BFA7351C510E39CD272C93E7FF5D10AD38DF3FD54B7088CCB794175A50A604AACC4645B43DEC95C9331C9F7B27273336C31DD7D4300B908AB2CD7B6ECE287F5E6FF7F0AB9A22E1530A53A5460A9723FE50A0625261C23E69C8FB3FEF057C6B97A33111A0DAEF38F15EB5F5DCFC993BC91E43800ACFD1CB660D9E4A49A5CF36D3D303667E4FB5CDE5675AC62
answer = BA0D89B554DAA8B2DCEBEEE517AFC951301570BE81FF5611A6F07AE1015BD4189E60687C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001006C2129B293D09F638E9EFBBA9BE6989A9C7791E02A1B74B94ECA7B576A19550C58D97B2AB1D93FAD1F5202F70E3C3EEEF410483CCCE89EDEA24BB163CEFC39222A52A761947F6E79A93F672A934398062EAD653B2CE6FCE627DA0E1A92DD5931BD2FB9220CA95235EF0E3C9CBFA70FF5125BB278E1BA5D3EFCC6AC957C02EA5F5BFA7351C510E39CD272C93E7FF5D10AD38DF3FD54B7088CCB794175A50A604AACC4645B43DEC95C9331C9F7B27273336C31DD7D4300B908AB2CD7B6ECE287F5E6FF7F0AB9A22E1530A53A5460A9723FE50A0625261C23E69C8FB3FEF057C6B97A33111A0DAEF38F15EB5F5DCFC993BC91E43800ACFD1CB660D9E4A49A5CF36D3D303667E4FB5CDE5675AC62</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 54 DA A8 B2 DC EB EE E5 17 AF C9 51
0010 | 30 15 70 BE 81 FF 56 11 A6 F0 7A E1 01 5B D4 18
0020 | 9E 60 68 7C 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 6C 21 29 B2 93 D0 9F 63 8E 9E FB BA 9B E6 98 9A
0140 | 9C 77 91 E0 2A 1B 74 B9 4E CA 7B 57 6A 19 55 0C
0150 | 58 D9 7B 2A B1 D9 3F AD 1F 52 02 F7 0E 3C 3E EE
0160 | F4 10 48 3C CC E8 9E DE A2 4B B1 63 CE FC 39 22
0170 | 2A 52 A7 61 94 7F 6E 79 A9 3F 67 2A 93 43 98 06
0180 | 2E AD 65 3B 2C E6 FC E6 27 DA 0E 1A 92 DD 59 31
0190 | BD 2F B9 22 0C A9 52 35 EF 0E 3C 9C BF A7 0F F5
01A0 | 12 5B B2 78 E1 BA 5D 3E FC C6 AC 95 7C 02 EA 5F
01B0 | 5B FA 73 51 C5 10 E3 9C D2 72 C9 3E 7F F5 D1 0A
01C0 | D3 8D F3 FD 54 B7 08 8C CB 79 41 75 A5 0A 60 4A
01D0 | AC C4 64 5B 43 DE C9 5C 93 31 C9 F7 B2 72 73 33
01E0 | 6C 31 DD 7D 43 00 B9 08 AB 2C D7 B6 EC E2 87 F5
01F0 | E6 FF 7F 0A B9 A2 2E 15 30 A5 3A 54 60 A9 72 3F
0200 | E5 0A 06 25 26 1C 23 E6 9C 8F B3 FE F0 57 C6 B9
0210 | 7A 33 11 1A 0D AE F3 8F 15 EB 5F 5D CF C9 93 BC
0220 | 91 E4 38 00 AC FD 1C B6 60 D9 E4 A4 9A 5C F3 6D
0230 | 3D 30 36 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001006C2129B293D09F638E9EFBBA</code> <code>9BE6989A9C7791E02A1B74B94ECA7B57</code> <code>6A19550C58D97B2AB1D93FAD1F5202F7</code> <code>0E3C3EEEF410483CCCE89EDEA24BB163</code> <code>CEFC39222A52A761947F6E79A93F672A</code> <code>934398062EAD653B2CE6FCE627DA0E1A</code> <code>92DD5931BD2FB9220CA95235EF0E3C9C</code> <code>BFA70FF5125BB278E1BA5D3EFCC6AC95</code> <code>7C02EA5F5BFA7351C510E39CD272C93E</code> <code>7FF5D10AD38DF3FD54B7088CCB794175</code> <code>A50A604AACC4645B43DEC95C9331C9F7</code> <code>B27273336C31DD7D4300B908AB2CD7B6</code> <code>ECE287F5E6FF7F0AB9A22E1530A53A54</code> <code>60A9723FE50A0625261C23E69C8FB3FE</code> <code>F057C6B97A33111A0DAEF38F15EB5F5D</code> <code>CFC993BC91E43800ACFD1CB660D9E4A4</code><br> <code>9A5CF36D</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>3D303667</code> (1731604541 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 353D376BDE44BBA9E1BE09825CFF0863C77359727AC175F07A0E0AC76E6598573F5010DCB20C8DC317E93FA5E22804918B5F2288ED1CEADBA6E90E708CB88D62B58EF9DAAE65B19AC09E8E37CE1ACFDC78DAB097C35DA2789ECFE46A7614374EE66B3FD2564CFCA490A75BA56AE18708110C30C62AF5293D06B6D0B023168FCFE1BD1B2FA54A162B46A4BB6D2CD3E0014025C8C4255AAC034D98790F8864E01C24E4E5696731B018C98B86EACDC73EC98C8232A8E2C103D270BFF30595ECC3F268640F0BF1B427D42C284FF8BC729B574C35BA2E83FDA21C7179508E215091C62DD3F8C7934331E0444A56F9A8BFF17D05BC50E978BC8519F96258A8B0872FCF</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 27553384031FA706EB6B3EE06F5C00CBC7EFD7269ABDC21FDFD94C41D1AEE347C4C95BCD509990ED3E7FAE6706D3F8A041006A5EF0A75C4F803A39958E42BC3E46CA9EFF36189277807F74C79FD381B845B25D03D18FA0216469868CB9C007A1BA388D868B9834868C179DF2A07FAA93350B5AACCBD40905265699578A341599F73A35A4A7CF22F1464143472671F929FC11D38E49E3E9D4E19CBEB323479A626121D2F7FE5B20F37D4943E50C146F80AE2189E17A7C3342249B30EA7C4F49E535FBD4F3A39660B2A663315147873F8952E6E15AC48FE1473A7FFF13A21E05244E5435665AA8569B6BF1953007E67839C5B974AFFB3589DFBCB97E84D4C1C845</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 54 DA A8 B2 DC EB EE E5 17 AF C9 51
0010 | 30 15 70 BE 81 FF 56 11 A6 F0 7A E1 01 5B D4 18
0020 | 9E 60 68 7C 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 27 55 33 84 03 1F A7 06 EB 6B 3E E0 6F 5C 00 CB
0040 | C7 EF D7 26 9A BD C2 1F DF D9 4C 41 D1 AE E3 47
0050 | C4 C9 5B CD 50 99 90 ED 3E 7F AE 67 06 D3 F8 A0
0060 | 41 00 6A 5E F0 A7 5C 4F 80 3A 39 95 8E 42 BC 3E
0070 | 46 CA 9E FF 36 18 92 77 80 7F 74 C7 9F D3 81 B8
0080 | 45 B2 5D 03 D1 8F A0 21 64 69 86 8C B9 C0 07 A1
0090 | BA 38 8D 86 8B 98 34 86 8C 17 9D F2 A0 7F AA 93
00A0 | 35 0B 5A AC CB D4 09 05 26 56 99 57 8A 34 15 99
00B0 | F7 3A 35 A4 A7 CF 22 F1 46 41 43 47 26 71 F9 29
00C0 | FC 11 D3 8E 49 E3 E9 D4 E1 9C BE B3 23 47 9A 62
00D0 | 61 21 D2 F7 FE 5B 20 F3 7D 49 43 E5 0C 14 6F 80
00E0 | AE 21 89 E1 7A 7C 33 42 24 9B 30 EA 7C 4F 49 E5
00F0 | 35 FB D4 F3 A3 96 60 B2 A6 63 31 51 47 87 3F 89
0100 | 52 E6 E1 5A C4 8F E1 47 3A 7F FF 13 A2 1E 05 24
0110 | 4E 54 35 66 5A A8 56 9B 6B F1 95 30 07 E6 78 39
0120 | C5 B9 74 AF FB 35 89 DF BC B9 7E 84 D4 C1 C8 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010027553384031FA706EB6B3EE0</code> <code>6F5C00CBC7EFD7269ABDC21FDFD94C41</code> <code>D1AEE347C4C95BCD509990ED3E7FAE67</code> <code>06D3F8A041006A5EF0A75C4F803A3995</code> <code>8E42BC3E46CA9EFF36189277807F74C7</code> <code>9FD381B845B25D03D18FA0216469868C</code> <code>B9C007A1BA388D868B9834868C179DF2</code> <code>A07FAA93350B5AACCBD4090526569957</code> <code>8A341599F73A35A4A7CF22F146414347</code> <code>2671F929FC11D38E49E3E9D4E19CBEB3</code> <code>23479A626121D2F7FE5B20F37D4943E5</code> <code>0C146F80AE2189E17A7C3342249B30EA</code> <code>7C4F49E535FBD4F3A39660B2A6633151</code> <code>47873F8952E6E15AC48FE1473A7FFF13</code> <code>A21E05244E5435665AA8569B6BF19530</code> <code>07E67839C5B974AFFB3589DFBCB97E84</code><br> <code>D4C1C845</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436654DAA8B2DCEBEEE517AFC951301570BE81FF5611A6F07AE1015BD4189E60687C0000000000000000FE00010027553384031FA706EB6B3EE06F5C00CBC7EFD7269ABDC21FDFD94C41D1AEE347C4C95BCD509990ED3E7FAE6706D3F8A041006A5EF0A75C4F803A39958E42BC3E46CA9EFF36189277807F74C79FD381B845B25D03D18FA0216469868CB9C007A1BA388D868B9834868C179DF2A07FAA93350B5AACCBD40905265699578A341599F73A35A4A7CF22F1464143472671F929FC11D38E49E3E9D4E19CBEB323479A626121D2F7FE5B20F37D4943E50C146F80AE2189E17A7C3342249B30EA7C4F49E535FBD4F3A39660B2A663315147873F8952E6E15AC48FE1473A7FFF13A21E05244E5435665AA8569B6BF1953007E67839C5B974AFFB3589DFBCB97E84D4C1C845
padding = D8C3647BA78018A7ED0F2093
tmp_aes_key = 3A849EC95DD739CDF5CBB89541EF40A7AC44B6DD578FE0EEFB6F69D6A7F53B0E
tmp_aes_iv = 017E0CD56F04427115EB81053316733539313883BBCFDF9868E7952F7A604CAB</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = DBF952AAC6181513561242846EBED486A81A0A97B17E15D691DED01E0868835B193AC47460302F8DC6C69F84F1B255BF4595684AE14A6A07CAD0F4A5139893C07257F2FBF3BD06FAD327A36BCB7FB9642DD1B127FB1B84AF113BB2504914A9E6E5C13ECB25400880DC874C8A775D74F53765CE3403BEE872D5796A5593D8A932F5CF1561F7C4F1D5673D28875BC17411F95CFFAB69980F874B3D73873D716DF168615D2605564412AFAED46620120E5554F698A5CC69954CBA64FECE0AD2837556C3AD7E58B9F8A80B263754E5A46B7FE01D0208770A77243A360523DFF646692013215ED2D92F345AC00CE9CF417B01AB81473F978767DFAD007FB22F94565E80595327AAFE5B008EA0EFCDF3E005A66F201C7D3C84EE88761E9951A64677E5FF9F0CC5F4FF781827886539179BEA68510E7539D94B9DD197F4066463D455F9C9C71358BBEF520018F2B5F68196E625</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C B0 0E 00 3D 30 36 67
0010 | 78 01 00 00 1F 5F 04 F5 54 DA A8 B2 DC EB EE E5
0020 | 17 AF C9 51 30 15 70 BE 81 FF 56 11 A6 F0 7A E1
0030 | 01 5B D4 18 9E 60 68 7C FE 50 01 00 DB F9 52 AA
0040 | C6 18 15 13 56 12 42 84 6E BE D4 86 A8 1A 0A 97
0050 | B1 7E 15 D6 91 DE D0 1E 08 68 83 5B 19 3A C4 74
0060 | 60 30 2F 8D C6 C6 9F 84 F1 B2 55 BF 45 95 68 4A
0070 | E1 4A 6A 07 CA D0 F4 A5 13 98 93 C0 72 57 F2 FB
0080 | F3 BD 06 FA D3 27 A3 6B CB 7F B9 64 2D D1 B1 27
0090 | FB 1B 84 AF 11 3B B2 50 49 14 A9 E6 E5 C1 3E CB
00A0 | 25 40 08 80 DC 87 4C 8A 77 5D 74 F5 37 65 CE 34
00B0 | 03 BE E8 72 D5 79 6A 55 93 D8 A9 32 F5 CF 15 61
00C0 | F7 C4 F1 D5 67 3D 28 87 5B C1 74 11 F9 5C FF AB
00D0 | 69 98 0F 87 4B 3D 73 87 3D 71 6D F1 68 61 5D 26
00E0 | 05 56 44 12 AF AE D4 66 20 12 0E 55 54 F6 98 A5
00F0 | CC 69 95 4C BA 64 FE CE 0A D2 83 75 56 C3 AD 7E
0100 | 58 B9 F8 A8 0B 26 37 54 E5 A4 6B 7F E0 1D 02 08
0110 | 77 0A 77 24 3A 36 05 23 DF F6 46 69 20 13 21 5E
0120 | D2 D9 2F 34 5A C0 0C E9 CF 41 7B 01 AB 81 47 3F
0130 | 97 87 67 DF AD 00 7F B2 2F 94 56 5E 80 59 53 27
0140 | AA FE 5B 00 8E A0 EF CD F3 E0 05 A6 6F 20 1C 7D
0150 | 3C 84 EE 88 76 1E 99 51 A6 46 77 E5 FF 9F 0C C5
0160 | F4 FF 78 18 27 88 65 39 17 9B EA 68 51 0E 75 39
0170 | D9 4B 9D D1 97 F4 06 64 63 D4 55 F9 C9 C7 13 58
0180 | BB EF 52 00 18 F2 B5 F6 81 96 E6 25</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7CB00E003D303667</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100DBF952AAC618151356124284</code> <code>6EBED486A81A0A97B17E15D691DED01E</code> <code>0868835B193AC47460302F8DC6C69F84</code> <code>F1B255BF4595684AE14A6A07CAD0F4A5</code> <code>139893C07257F2FBF3BD06FAD327A36B</code> <code>CB7FB9642DD1B127FB1B84AF113BB250</code> <code>4914A9E6E5C13ECB25400880DC874C8A</code> <code>775D74F53765CE3403BEE872D5796A55</code> <code>93D8A932F5CF1561F7C4F1D5673D2887</code> <code>5BC17411F95CFFAB69980F874B3D7387</code> <code>3D716DF168615D2605564412AFAED466</code> <code>20120E5554F698A5CC69954CBA64FECE</code> <code>0AD2837556C3AD7E58B9F8A80B263754</code> <code>E5A46B7FE01D0208770A77243A360523</code> <code>DFF646692013215ED2D92F345AC00CE9</code> <code>CF417B01AB81473F978767DFAD007FB2</code> <code>2F94565E80595327AAFE5B008EA0EFCD</code> <code>F3E005A66F201C7D3C84EE88761E9951</code> <code>A64677E5FF9F0CC5F4FF781827886539</code> <code>179BEA68510E7539D94B9DD197F40664</code> <code>63D455F9C9C71358BBEF520018F2B5F6</code><br> <code>8196E625</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 27614781C5EFCF2E7327FBEB32D97ED420F5E58E134ED9A3D62239DE8034788D62168C8E5EC1E53BA0711D21DE91F4524E846040B056894D4C586E70E7EFEDCAAC4E49A3C941AA9200C170B7FE8C6F4DA6047222DA49ABD3CCD387EAAC2BE96457F1B14CA4CC28CF9A406927B3525B031DB0629152FA55AED310C00247F57F391A0C37B93CBB25369ACBC5D27D8A4B7A883FB57E9265C89C7E34654CCF02EADDC3BE08ACE3A85247487DBFA6BD66458D1D4301BB76B80529B3BB9E8D28458AAF3A4CB1DABC0135600F0430407CD3918E6821E00C641E298C5C413C9EB8FCD5996314887D185114C75648F752A6E20011075939F7F440FF9664049FEF7F615BBB</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C0 41 9C 3F 30 36 67
0010 | 34 00 00 00 34 F7 CB 3B 54 DA A8 B2 DC EB EE E5
0020 | 17 AF C9 51 30 15 70 BE 81 FF 56 11 A6 F0 7A E1
0030 | 01 5B D4 18 9E 60 68 7C 18 B5 6C D1 0D DD B2 0E
0040 | 0A 75 E9 74 75 80 7D AC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C0419C3F303667</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>54DAA8B2DCEBEEE517AFC951301570BE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81FF5611A6F07AE1015BD4189E60687C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>18B56CD10DDDB20E0A75E97475807DAC</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

