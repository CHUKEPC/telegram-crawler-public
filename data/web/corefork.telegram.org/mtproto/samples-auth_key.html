<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 F2 02 00 38 BD BA 68
0010 | 14 00 00 00 F1 8E 7E BE F0 8E AD 7E 66 3D 75 49
0020 | 94 59 B4 B5 AC A9 14 0D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C0F2020038BDBA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 80 D8 D8 38 BD BA 68
0010 | 50 00 00 00 63 24 16 05 F0 8E AD 7E 66 3D 75 49
0020 | 94 59 B4 B5 AC A9 14 0D 3B A2 3A ED 2B 35 83 40
0030 | 32 AC 24 9B 68 1B BC 29 08 17 AB 12 40 E7 6F 70
0040 | ED 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0180D8D838BDBA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0817AB1240E76F70ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1705476953859911917</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1705476953859911917</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1705476953859911917 = 1060795511 * 1607733947</code></p>
<pre><code>p = 1060795511
q = 1607733947</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 17 AB 12 40 E7 6F 70 ED 00 00 00
0010 | 04 3F 3A 74 77 00 00 00 04 5F D4 12 BB 00 00 00
0020 | F0 8E AD 7E 66 3D 75 49 94 59 B4 B5 AC A9 14 0D
0030 | 3B A2 3A ED 2B 35 83 40 32 AC 24 9B 68 1B BC 29
0040 | 2C 24 4E 62 DC 12 09 8A 25 35 5A 41 F9 29 76 6B
0050 | 39 0E E0 CD 56 D5 90 8C 87 2A 71 0D CE B9 FE 1C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0817AB1240E76F70ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1705476953859911917</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043F3A7477000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1060795511</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045FD412BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1607733947</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>2C244E62DC12098A25355A41F929766B</code> <code>390EE0CD56D5908C872A710DCEB9FE1C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90817AB1240E76F70ED000000043F3A7477000000045FD412BB000000F08EAD7E663D75499459B4B5ACA9140D3BA23AED2B35834032AC249B681BBC292C244E62DC12098A25355A41F929766B390EE0CD56D5908C872A710DCEB9FE1C02000000
random_padding_bytes = 58C918D4008AF4CA88591EDF0C6B16ACA3D24D55786A40C5D7996DE9C0CC2F54ABD6229BD31408525D268151B3F8BF1F3E2E0C488E7E2342576D0775E6615341AE7E3B5EA91A54EF767AFB047E1E3BAC97DAB5EB580F4F04F51ACBC4</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 239FD81239E2C1D88DD20C684D1A4EAEB52F1AB525CADBE5B77AC86FFC87100FD419C6D77285E8D2588CD64A65FEEC945D32BE89502F8D2A4D578CB0E37CE949ACDD45933767E2EC9ECB93FEEE4A7D07B2AF2A561ED0E2B11779771EE0D3D2068D43C01FDB1F934B57E60D216EBA64CFD22CDE6963B8BBFAEF27D0B6E0215EE62A801E3A02A8D4285961A5DC82F5944DF66702C52A27D2E15335B6F7019132A2CD274111C6FE766FF9136DE4051D8D1174952F59CF1E05424BA40CF1BDAE91BF68049043FB040F089D5675F7FF9F78E24FB4737AD34B0072D34B18F1444227075352A9BFEB8AEFFC4AEB1EE64E37E81B666069ABF72420EB7519DAF5DAB3306B</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F8 31 04 00 38 BD BA 68
0010 | 40 01 00 00 BE E4 12 D7 F0 8E AD 7E 66 3D 75 49
0020 | 94 59 B4 B5 AC A9 14 0D 3B A2 3A ED 2B 35 83 40
0030 | 32 AC 24 9B 68 1B BC 29 04 3F 3A 74 77 00 00 00
0040 | 04 5F D4 12 BB 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 23 9F D8 12 39 E2 C1 D8 8D D2 0C 68
0060 | 4D 1A 4E AE B5 2F 1A B5 25 CA DB E5 B7 7A C8 6F
0070 | FC 87 10 0F D4 19 C6 D7 72 85 E8 D2 58 8C D6 4A
0080 | 65 FE EC 94 5D 32 BE 89 50 2F 8D 2A 4D 57 8C B0
0090 | E3 7C E9 49 AC DD 45 93 37 67 E2 EC 9E CB 93 FE
00A0 | EE 4A 7D 07 B2 AF 2A 56 1E D0 E2 B1 17 79 77 1E
00B0 | E0 D3 D2 06 8D 43 C0 1F DB 1F 93 4B 57 E6 0D 21
00C0 | 6E BA 64 CF D2 2C DE 69 63 B8 BB FA EF 27 D0 B6
00D0 | E0 21 5E E6 2A 80 1E 3A 02 A8 D4 28 59 61 A5 DC
00E0 | 82 F5 94 4D F6 67 02 C5 2A 27 D2 E1 53 35 B6 F7
00F0 | 01 91 32 A2 CD 27 41 11 C6 FE 76 6F F9 13 6D E4
0100 | 05 1D 8D 11 74 95 2F 59 CF 1E 05 42 4B A4 0C F1
0110 | BD AE 91 BF 68 04 90 43 FB 04 0F 08 9D 56 75 F7
0120 | FF 9F 78 E2 4F B4 73 7A D3 4B 00 72 D3 4B 18 F1
0130 | 44 42 27 07 53 52 A9 BF EB 8A EF FC 4A EB 1E E6
0140 | 4E 37 E8 1B 66 60 69 AB F7 24 20 EB 75 19 DA F5
0150 | DA B3 30 6B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F831040038BDBA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043F3A7477000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1060795511</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045FD412BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1607733947</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100239FD81239E2C1D88DD20C68</code> <code>4D1A4EAEB52F1AB525CADBE5B77AC86F</code> <code>FC87100FD419C6D77285E8D2588CD64A</code> <code>65FEEC945D32BE89502F8D2A4D578CB0</code> <code>E37CE949ACDD45933767E2EC9ECB93FE</code> <code>EE4A7D07B2AF2A561ED0E2B11779771E</code> <code>E0D3D2068D43C01FDB1F934B57E60D21</code> <code>6EBA64CFD22CDE6963B8BBFAEF27D0B6</code> <code>E0215EE62A801E3A02A8D4285961A5DC</code> <code>82F5944DF66702C52A27D2E15335B6F7</code> <code>019132A2CD274111C6FE766FF9136DE4</code> <code>051D8D1174952F59CF1E05424BA40CF1</code> <code>BDAE91BF68049043FB040F089D5675F7</code> <code>FF9F78E24FB4737AD34B0072D34B18F1</code> <code>444227075352A9BFEB8AEFFC4AEB1EE6</code> <code>4E37E81B666069ABF72420EB7519DAF5</code><br> <code>DAB3306B</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E4 75 00 39 BD BA 68
0010 | 78 02 00 00 5C 07 E8 D0 F0 8E AD 7E 66 3D 75 49
0020 | 94 59 B4 B5 AC A9 14 0D 3B A2 3A ED 2B 35 83 40
0030 | 32 AC 24 9B 68 1B BC 29 FE 50 02 00 C9 A6 7C DD
0040 | CC 3A 16 96 49 9D E7 45 A8 49 4D 80 FC 48 E7 BC
0050 | 1E 6B D5 C4 97 F0 3A BD 04 6D EA 2E 58 5B 92 B7
0060 | FD BB 80 86 E1 38 8C 50 7D F6 E3 AB EB EE D9 9E
0070 | B3 3F 6F 0E 8B FC 24 2B ED E8 4C EF 52 BE 81 E1
0080 | 86 5C 1C 81 41 28 1E C5 9B B7 39 29 F8 6F 92 84
0090 | 6A 7C 01 3C 71 FF FC 2A 48 CC E3 8A 77 1A FF BD
00A0 | AF 1F 31 1C 6D E3 54 8F 09 4C DE B7 14 33 AC 20
00B0 | 02 98 AC C7 FE 62 26 47 03 26 5C 0A C0 FD 3B B8
00C0 | DE 83 4B 15 1D F3 84 01 5F 65 12 25 16 2A 09 F4
00D0 | 88 17 BA 86 9F EE 45 9E 60 CF A4 6A 15 62 D6 D3
00E0 | C1 7A 79 5C 48 C0 69 22 01 3C A4 09 AB 2A 2A 97
00F0 | E1 1A 8C 28 82 4A 0C 94 94 BE E9 DE EF 3F 5A CF
0100 | 70 12 27 42 15 53 04 67 CD 2B 98 F8 72 20 C3 1A
0110 | CD A8 7B AF 32 96 F8 D0 32 C1 15 FE AF 21 4B 75
0120 | FC E3 0F 14 82 28 EA 87 DB 25 15 D5 E5 14 7A 6D
0130 | 76 29 ED A0 C2 C9 39 1C F7 58 A6 9F E0 1F DF 3A
0140 | 37 A3 D4 C3 43 82 A3 19 A4 5A 4A 57 AF 71 CB 1F
0150 | 1D 58 DF 10 50 BA 36 18 D0 94 14 BD D0 90 86 2E
0160 | 1C E3 33 C8 91 56 F0 29 FD E4 A1 98 CE 00 69 AE
0170 | EE D8 1D E9 CC 19 8E 47 1B F4 3C 27 17 E2 D4 A3
0180 | 6A F8 2B 35 AF 0E AA D5 54 71 9C A2 EC B5 59 8C
0190 | 4E C2 04 89 FE 14 04 78 66 96 DD D6 AE 43 94 6F
01A0 | AF A3 12 C1 3B 00 52 DC F2 A3 7D 85 C2 D3 B9 2C
01B0 | 31 C6 4D D5 59 64 D0 D5 7C 18 6B 27 4C A6 D0 C0
01C0 | 7F 3B AF 49 94 A8 D3 1E 9F F9 37 29 15 B6 E1 85
01D0 | 39 1B 75 99 41 CA 53 91 06 81 A4 5C 9D 04 4A 0E
01E0 | 0F 70 33 05 2E 36 BF 62 2C 1A 05 87 BD 86 5D B4
01F0 | 9B 94 4C CC 82 5B 1C 08 4D EC B9 27 33 75 37 90
0200 | 11 6C 87 AF B8 54 0E 05 E2 96 09 5C 7D C0 6D 41
0210 | 21 C7 A1 03 C2 22 06 D2 BE 26 7C 17 4E D8 8F AD
0220 | 46 D3 1D F8 5C 5F 7D 5D 7E D1 39 EF 8B E9 28 A9
0230 | CB AC 21 3A E1 29 A8 F7 3D C6 40 EF 78 61 9E 1C
0240 | EE A4 6E 4B 8C 5A E7 AF 25 4E 2B 98 D4 27 82 0E
0250 | 8C 53 74 E0 75 3B 68 C0 B1 10 73 A3 F3 4B 45 57
0260 | 99 EE 69 DA A5 61 4E 9B 6A 4B 9E C1 96 49 4D 66
0270 | F4 D8 A3 89 76 42 9E 98 B2 B2 F6 EE 8D 19 3D FC
0280 | 9D C4 F3 90 F7 0F 70 CF 0C 00 18 F4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E4750039BDBA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200C9A67CDDCC3A1696499DE745</code> <code>A8494D80FC48E7BC1E6BD5C497F03ABD</code> <code>046DEA2E585B92B7FDBB8086E1388C50</code> <code>7DF6E3ABEBEED99EB33F6F0E8BFC242B</code> <code>EDE84CEF52BE81E1865C1C8141281EC5</code> <code>9BB73929F86F92846A7C013C71FFFC2A</code> <code>48CCE38A771AFFBDAF1F311C6DE3548F</code> <code>094CDEB71433AC200298ACC7FE622647</code> <code>03265C0AC0FD3BB8DE834B151DF38401</code> <code>5F651225162A09F48817BA869FEE459E</code> <code>60CFA46A1562D6D3C17A795C48C06922</code> <code>013CA409AB2A2A97E11A8C28824A0C94</code> <code>94BEE9DEEF3F5ACF7012274215530467</code> <code>CD2B98F87220C31ACDA87BAF3296F8D0</code> <code>32C115FEAF214B75FCE30F148228EA87</code> <code>DB2515D5E5147A6D7629EDA0C2C9391C</code> <code>F758A69FE01FDF3A37A3D4C34382A319</code> <code>A45A4A57AF71CB1F1D58DF1050BA3618</code> <code>D09414BDD090862E1CE333C89156F029</code> <code>FDE4A198CE0069AEEED81DE9CC198E47</code> <code>1BF43C2717E2D4A36AF82B35AF0EAAD5</code> <code>54719CA2ECB5598C4EC20489FE140478</code> <code>6696DDD6AE43946FAFA312C13B0052DC</code> <code>F2A37D85C2D3B92C31C64DD55964D0D5</code> <code>7C186B274CA6D0C07F3BAF4994A8D31E</code> <code>9FF9372915B6E185391B759941CA5391</code> <code>0681A45C9D044A0E0F7033052E36BF62</code> <code>2C1A0587BD865DB49B944CCC825B1C08</code> <code>4DECB92733753790116C87AFB8540E05</code> <code>E296095C7DC06D4121C7A103C22206D2</code> <code>BE267C174ED88FAD46D31DF85C5F7D5D</code> <code>7ED139EF8BE928A9CBAC213AE129A8F7</code> <code>3DC640EF78619E1CEEA46E4B8C5AE7AF</code> <code>254E2B98D427820E8C5374E0753B68C0</code> <code>B11073A3F34B455799EE69DAA5614E9B</code> <code>6A4B9EC196494D66F4D8A38976429E98</code> <code>B2B2F6EE8D193DFC9DC4F390F70F70CF</code><br> <code>0C0018F4</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = C9A67CDDCC3A1696499DE745A8494D80FC48E7BC1E6BD5C497F03ABD046DEA2E585B92B7FDBB8086E1388C507DF6E3ABEBEED99EB33F6F0E8BFC242BEDE84CEF52BE81E1865C1C8141281EC59BB73929F86F92846A7C013C71FFFC2A48CCE38A771AFFBDAF1F311C6DE3548F094CDEB71433AC200298ACC7FE62264703265C0AC0FD3BB8DE834B151DF384015F651225162A09F48817BA869FEE459E60CFA46A1562D6D3C17A795C48C06922013CA409AB2A2A97E11A8C28824A0C9494BEE9DEEF3F5ACF7012274215530467CD2B98F87220C31ACDA87BAF3296F8D032C115FEAF214B75FCE30F148228EA87DB2515D5E5147A6D7629EDA0C2C9391CF758A69FE01FDF3A37A3D4C34382A319A45A4A57AF71CB1F1D58DF1050BA3618D09414BDD090862E1CE333C89156F029FDE4A198CE0069AEEED81DE9CC198E471BF43C2717E2D4A36AF82B35AF0EAAD554719CA2ECB5598C4EC20489FE1404786696DDD6AE43946FAFA312C13B0052DCF2A37D85C2D3B92C31C64DD55964D0D57C186B274CA6D0C07F3BAF4994A8D31E9FF9372915B6E185391B759941CA53910681A45C9D044A0E0F7033052E36BF622C1A0587BD865DB49B944CCC825B1C084DECB92733753790116C87AFB8540E05E296095C7DC06D4121C7A103C22206D2BE267C174ED88FAD46D31DF85C5F7D5D7ED139EF8BE928A9CBAC213AE129A8F73DC640EF78619E1CEEA46E4B8C5AE7AF254E2B98D427820E8C5374E0753B68C0B11073A3F34B455799EE69DAA5614E9B6A4B9EC196494D66F4D8A38976429E98B2B2F6EE8D193DFC9DC4F390F70F70CF0C0018F4
tmp_aes_key = 53C2AAE1F151FDD38BB9FA2CDCD1CDC04857FAD2E43EE541DC1DB82231D03608
tmp_aes_iv = 788758FC1928E59C08139F13F67E753DD65BEEB438B5F1FE2F842B7E2C244E62</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 2331CC3150AE0F14F6AEBA687290995B6539553EBA0D89B5F08EAD7E663D75499459B4B5ACA9140D3BA23AED2B35834032AC249B681BBC2903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007E2D9E895317D026F17812D57070328D242BAF9C4EA1BFB9EE605F2FD20C53F527C584F3E3C58BDABE02C066587618ADD6C34DBEBD4FE4F89413365E83F4D81DF169A8AB51AAD7D9812BE504857C315F1F197606DFE4194B919BCDFB5440AC42891451F9B7F1EC3B4C28F4AAE33E03B4B9C5A644393CC14DAC68712F09908183DDD3CC6500CF421EAD19B27E70611EB4228BD4B32D1C580E247D12531B68D6ACF38B53A53C846480541E15B3F8CC15A6331CBCA742D732F88AA96E3D61B014BFBE4DD089EC641C746C64246C7784E0958DC33A2E03864BB77F1AFA7BDFA47180DBF0FB171838892FA525D50F0D3DB304A60356E61446E19EF9978F5F9F0A82E838BDBA682841CAEEC91EF615
answer = BA0D89B5F08EAD7E663D75499459B4B5ACA9140D3BA23AED2B35834032AC249B681BBC2903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007E2D9E895317D026F17812D57070328D242BAF9C4EA1BFB9EE605F2FD20C53F527C584F3E3C58BDABE02C066587618ADD6C34DBEBD4FE4F89413365E83F4D81DF169A8AB51AAD7D9812BE504857C315F1F197606DFE4194B919BCDFB5440AC42891451F9B7F1EC3B4C28F4AAE33E03B4B9C5A644393CC14DAC68712F09908183DDD3CC6500CF421EAD19B27E70611EB4228BD4B32D1C580E247D12531B68D6ACF38B53A53C846480541E15B3F8CC15A6331CBCA742D732F88AA96E3D61B014BFBE4DD089EC641C746C64246C7784E0958DC33A2E03864BB77F1AFA7BDFA47180DBF0FB171838892FA525D50F0D3DB304A60356E61446E19EF9978F5F9F0A82E838BDBA682841CAEEC91EF615</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 F0 8E AD 7E 66 3D 75 49 94 59 B4 B5
0010 | AC A9 14 0D 3B A2 3A ED 2B 35 83 40 32 AC 24 9B
0020 | 68 1B BC 29 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 7E 2D 9E 89 53 17 D0 26 F1 78 12 D5 70 70 32 8D
0140 | 24 2B AF 9C 4E A1 BF B9 EE 60 5F 2F D2 0C 53 F5
0150 | 27 C5 84 F3 E3 C5 8B DA BE 02 C0 66 58 76 18 AD
0160 | D6 C3 4D BE BD 4F E4 F8 94 13 36 5E 83 F4 D8 1D
0170 | F1 69 A8 AB 51 AA D7 D9 81 2B E5 04 85 7C 31 5F
0180 | 1F 19 76 06 DF E4 19 4B 91 9B CD FB 54 40 AC 42
0190 | 89 14 51 F9 B7 F1 EC 3B 4C 28 F4 AA E3 3E 03 B4
01A0 | B9 C5 A6 44 39 3C C1 4D AC 68 71 2F 09 90 81 83
01B0 | DD D3 CC 65 00 CF 42 1E AD 19 B2 7E 70 61 1E B4
01C0 | 22 8B D4 B3 2D 1C 58 0E 24 7D 12 53 1B 68 D6 AC
01D0 | F3 8B 53 A5 3C 84 64 80 54 1E 15 B3 F8 CC 15 A6
01E0 | 33 1C BC A7 42 D7 32 F8 8A A9 6E 3D 61 B0 14 BF
01F0 | BE 4D D0 89 EC 64 1C 74 6C 64 24 6C 77 84 E0 95
0200 | 8D C3 3A 2E 03 86 4B B7 7F 1A FA 7B DF A4 71 80
0210 | DB F0 FB 17 18 38 89 2F A5 25 D5 0F 0D 3D B3 04
0220 | A6 03 56 E6 14 46 E1 9E F9 97 8F 5F 9F 0A 82 E8
0230 | 38 BD BA 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007E2D9E895317D026F17812D5</code> <code>7070328D242BAF9C4EA1BFB9EE605F2F</code> <code>D20C53F527C584F3E3C58BDABE02C066</code> <code>587618ADD6C34DBEBD4FE4F89413365E</code> <code>83F4D81DF169A8AB51AAD7D9812BE504</code> <code>857C315F1F197606DFE4194B919BCDFB</code> <code>5440AC42891451F9B7F1EC3B4C28F4AA</code> <code>E33E03B4B9C5A644393CC14DAC68712F</code> <code>09908183DDD3CC6500CF421EAD19B27E</code> <code>70611EB4228BD4B32D1C580E247D1253</code> <code>1B68D6ACF38B53A53C846480541E15B3</code> <code>F8CC15A6331CBCA742D732F88AA96E3D</code> <code>61B014BFBE4DD089EC641C746C64246C</code> <code>7784E0958DC33A2E03864BB77F1AFA7B</code> <code>DFA47180DBF0FB171838892FA525D50F</code> <code>0D3DB304A60356E61446E19EF9978F5F</code><br> <code>9F0A82E8</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>38BDBA68</code> (1757068600 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 5F8E6FA5E743C00F681FEFD5ED4646F0382A48E1760B2A52C78D52B39F8FA0CBEEB4DCF4F955EFC7B7E0E3C30CC787498AB396B6E4C6539A906FEB9F6079C1A200CB2AF497833E3ED7EC79A79EA9B8A84823F07DE42334F8CBF41E564ABCFED78E1C6B7E520BCEF9F59FAE961F88994401E8E3350C22B3C6398E2A9B2AFBD0438A042A9EF2558890983A857002D77DE17EFC0FCB99ED14CC5CEAD1268FEF8CE7DB4BDD704A09615D10C12C64C2A3E3EA3E490FB5988FD6CBC6CA05E60DFF740D934458E657F1DE074EEE641D1A1BA9A65CE3F68BD660E37A37A6553300F4E0399D647FB86E79A3418F68540EB324A426A17CD92FBF7300F8D3FE26336BDA0913</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 8774DC974F1269D9868D8CFA2F3AA465808EBA29AC3246C9A620D773847D480C87428B842E678E2107AD8A5EB4BCD300435259EE4A2770C0274C1E69034CA5AA292764A3A051838AA594058A23A0A4FD8DC8BC4D7A076ADBE699E6590B540AD399FF039A39CA46949DB6ED26C08BC499C18924540ACECD9AC7E2E2D4E23D9A3A8EE777BAD1A0D8091D834F768F103CEC3227718683DF4DA01DFDC6215F852D5B270E819ECBE60C7CEDB5A2EA5F4B5D8CDD8DDF737F3051067CCF9A25CB0B465252703F704E55C2DBBBC90C83D2C8C1DA6A9006E2833B874B76AF78180FABD325F52D66F3A372F222630313F9087FCEE100C3E9BFA905AEED238D2FE89A9AC9E7</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 F0 8E AD 7E 66 3D 75 49 94 59 B4 B5
0010 | AC A9 14 0D 3B A2 3A ED 2B 35 83 40 32 AC 24 9B
0020 | 68 1B BC 29 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 87 74 DC 97 4F 12 69 D9 86 8D 8C FA 2F 3A A4 65
0040 | 80 8E BA 29 AC 32 46 C9 A6 20 D7 73 84 7D 48 0C
0050 | 87 42 8B 84 2E 67 8E 21 07 AD 8A 5E B4 BC D3 00
0060 | 43 52 59 EE 4A 27 70 C0 27 4C 1E 69 03 4C A5 AA
0070 | 29 27 64 A3 A0 51 83 8A A5 94 05 8A 23 A0 A4 FD
0080 | 8D C8 BC 4D 7A 07 6A DB E6 99 E6 59 0B 54 0A D3
0090 | 99 FF 03 9A 39 CA 46 94 9D B6 ED 26 C0 8B C4 99
00A0 | C1 89 24 54 0A CE CD 9A C7 E2 E2 D4 E2 3D 9A 3A
00B0 | 8E E7 77 BA D1 A0 D8 09 1D 83 4F 76 8F 10 3C EC
00C0 | 32 27 71 86 83 DF 4D A0 1D FD C6 21 5F 85 2D 5B
00D0 | 27 0E 81 9E CB E6 0C 7C ED B5 A2 EA 5F 4B 5D 8C
00E0 | DD 8D DF 73 7F 30 51 06 7C CF 9A 25 CB 0B 46 52
00F0 | 52 70 3F 70 4E 55 C2 DB BB C9 0C 83 D2 C8 C1 DA
0100 | 6A 90 06 E2 83 3B 87 4B 76 AF 78 18 0F AB D3 25
0110 | F5 2D 66 F3 A3 72 F2 22 63 03 13 F9 08 7F CE E1
0120 | 00 C3 E9 BF A9 05 AE ED 23 8D 2F E8 9A 9A C9 E7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001008774DC974F1269D9868D8CFA</code> <code>2F3AA465808EBA29AC3246C9A620D773</code> <code>847D480C87428B842E678E2107AD8A5E</code> <code>B4BCD300435259EE4A2770C0274C1E69</code> <code>034CA5AA292764A3A051838AA594058A</code> <code>23A0A4FD8DC8BC4D7A076ADBE699E659</code> <code>0B540AD399FF039A39CA46949DB6ED26</code> <code>C08BC499C18924540ACECD9AC7E2E2D4</code> <code>E23D9A3A8EE777BAD1A0D8091D834F76</code> <code>8F103CEC3227718683DF4DA01DFDC621</code> <code>5F852D5B270E819ECBE60C7CEDB5A2EA</code> <code>5F4B5D8CDD8DDF737F3051067CCF9A25</code> <code>CB0B465252703F704E55C2DBBBC90C83</code> <code>D2C8C1DA6A9006E2833B874B76AF7818</code> <code>0FABD325F52D66F3A372F222630313F9</code> <code>087FCEE100C3E9BFA905AEED238D2FE8</code><br> <code>9A9AC9E7</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366F08EAD7E663D75499459B4B5ACA9140D3BA23AED2B35834032AC249B681BBC290000000000000000FE0001008774DC974F1269D9868D8CFA2F3AA465808EBA29AC3246C9A620D773847D480C87428B842E678E2107AD8A5EB4BCD300435259EE4A2770C0274C1E69034CA5AA292764A3A051838AA594058A23A0A4FD8DC8BC4D7A076ADBE699E6590B540AD399FF039A39CA46949DB6ED26C08BC499C18924540ACECD9AC7E2E2D4E23D9A3A8EE777BAD1A0D8091D834F768F103CEC3227718683DF4DA01DFDC6215F852D5B270E819ECBE60C7CEDB5A2EA5F4B5D8CDD8DDF737F3051067CCF9A25CB0B465252703F704E55C2DBBBC90C83D2C8C1DA6A9006E2833B874B76AF78180FABD325F52D66F3A372F222630313F9087FCEE100C3E9BFA905AEED238D2FE89A9AC9E7
padding = AD615B3F14C4E576545C2B63
tmp_aes_key = 53C2AAE1F151FDD38BB9FA2CDCD1CDC04857FAD2E43EE541DC1DB82231D03608
tmp_aes_iv = 788758FC1928E59C08139F13F67E753DD65BEEB438B5F1FE2F842B7E2C244E62</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 24FDE60F3DE3F10F28D73D6CBE95C8F002C0824FACA018BF39DAF10229F7C2A50062FD0369843D8786C18F3CC25D3195963577E694F5873CF4372E4E6C69DAA6EDA3DF31351A820CCD354274E44200EFA8531720473DBD4CB439CF2DA1DF8FA95C0A9D3ECE55B0539B6E5229304AC1711A896E1EBF927EBDBF2C7ADA4A3C6CB2203581F67216AE09C3CCA4A90D4B9A54A4D5BC632C543EE967222E4892C6EB9667AC7FD20AFBDAA757029CCF1A693B88E9429EB337BE97FA21970A2F0A7613F0BB381C673772BF39FB942675CF588F5F0CB54320D58B54B67178C01F20AB30F786E4ACB8B1EB7F153294C24069E984E9100D151C04E497DF4CD9E1F396961888FB0DE4A2D1D53748DF495EB9DB50E11B0AF4D108DD8DC3CEA08CDD22FA0D1DBC29E7F6E81942B697BEA4FC062EF67E4D07EF3036AC9E0DF887F1D68E49DA4702737326BF4BFE5C2A9469696B58F3F12D</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 3C 4C 0D 00 38 BD BA 68
0010 | 78 01 00 00 1F 5F 04 F5 F0 8E AD 7E 66 3D 75 49
0020 | 94 59 B4 B5 AC A9 14 0D 3B A2 3A ED 2B 35 83 40
0030 | 32 AC 24 9B 68 1B BC 29 FE 50 01 00 24 FD E6 0F
0040 | 3D E3 F1 0F 28 D7 3D 6C BE 95 C8 F0 02 C0 82 4F
0050 | AC A0 18 BF 39 DA F1 02 29 F7 C2 A5 00 62 FD 03
0060 | 69 84 3D 87 86 C1 8F 3C C2 5D 31 95 96 35 77 E6
0070 | 94 F5 87 3C F4 37 2E 4E 6C 69 DA A6 ED A3 DF 31
0080 | 35 1A 82 0C CD 35 42 74 E4 42 00 EF A8 53 17 20
0090 | 47 3D BD 4C B4 39 CF 2D A1 DF 8F A9 5C 0A 9D 3E
00A0 | CE 55 B0 53 9B 6E 52 29 30 4A C1 71 1A 89 6E 1E
00B0 | BF 92 7E BD BF 2C 7A DA 4A 3C 6C B2 20 35 81 F6
00C0 | 72 16 AE 09 C3 CC A4 A9 0D 4B 9A 54 A4 D5 BC 63
00D0 | 2C 54 3E E9 67 22 2E 48 92 C6 EB 96 67 AC 7F D2
00E0 | 0A FB DA A7 57 02 9C CF 1A 69 3B 88 E9 42 9E B3
00F0 | 37 BE 97 FA 21 97 0A 2F 0A 76 13 F0 BB 38 1C 67
0100 | 37 72 BF 39 FB 94 26 75 CF 58 8F 5F 0C B5 43 20
0110 | D5 8B 54 B6 71 78 C0 1F 20 AB 30 F7 86 E4 AC B8
0120 | B1 EB 7F 15 32 94 C2 40 69 E9 84 E9 10 0D 15 1C
0130 | 04 E4 97 DF 4C D9 E1 F3 96 96 18 88 FB 0D E4 A2
0140 | D1 D5 37 48 DF 49 5E B9 DB 50 E1 1B 0A F4 D1 08
0150 | DD 8D C3 CE A0 8C DD 22 FA 0D 1D BC 29 E7 F6 E8
0160 | 19 42 B6 97 BE A4 FC 06 2E F6 7E 4D 07 EF 30 36
0170 | AC 9E 0D F8 87 F1 D6 8E 49 DA 47 02 73 73 26 BF
0180 | 4B FE 5C 2A 94 69 69 6B 58 F3 F1 2D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>3C4C0D0038BDBA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010024FDE60F3DE3F10F28D73D6C</code> <code>BE95C8F002C0824FACA018BF39DAF102</code> <code>29F7C2A50062FD0369843D8786C18F3C</code> <code>C25D3195963577E694F5873CF4372E4E</code> <code>6C69DAA6EDA3DF31351A820CCD354274</code> <code>E44200EFA8531720473DBD4CB439CF2D</code> <code>A1DF8FA95C0A9D3ECE55B0539B6E5229</code> <code>304AC1711A896E1EBF927EBDBF2C7ADA</code> <code>4A3C6CB2203581F67216AE09C3CCA4A9</code> <code>0D4B9A54A4D5BC632C543EE967222E48</code> <code>92C6EB9667AC7FD20AFBDAA757029CCF</code> <code>1A693B88E9429EB337BE97FA21970A2F</code> <code>0A7613F0BB381C673772BF39FB942675</code> <code>CF588F5F0CB54320D58B54B67178C01F</code> <code>20AB30F786E4ACB8B1EB7F153294C240</code> <code>69E984E9100D151C04E497DF4CD9E1F3</code> <code>96961888FB0DE4A2D1D53748DF495EB9</code> <code>DB50E11B0AF4D108DD8DC3CEA08CDD22</code> <code>FA0D1DBC29E7F6E81942B697BEA4FC06</code> <code>2EF67E4D07EF3036AC9E0DF887F1D68E</code> <code>49DA4702737326BF4BFE5C2A9469696B</code><br> <code>58F3F12D</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 8962F9E58E8AE980CB3447FE8F9474D3AAEE5C6DC47C0CF80A66558A1DEA22BE302EDF53C53CD1D58FE110701CBB82BBD02A96A3EF5A8D198BBAD1A142F0B7E07A8A984BF1441F4449D214C857A40475E1FFD3011D44A62C425E04DA3610F754A19EDDB6BC6F9E8B778BBB6C9DAFD8066DA1DDF23B29478F2932A7CD13AC8AEDB803886D1DA2003527E8A8256AA82251163336D1E734FD0C158955BF66EC4A98D0BF673D8F065C991C24DDDE793F2ACF7D9A23A41D037AF7CE113135F82550946C322D7534E26EAC4B606E768FB359D83E7AB67C82B1B2BFA0FE2E6119007A44EE52045B321D1D02FAB3BF077DC0B2CC3C295C7131717E5D73066F30F81156C7</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 88 90 3A BD BA 68
0010 | 34 00 00 00 34 F7 CB 3B F0 8E AD 7E 66 3D 75 49
0020 | 94 59 B4 B5 AC A9 14 0D 3B A2 3A ED 2B 35 83 40
0030 | 32 AC 24 9B 68 1B BC 29 7A 15 99 52 9E 5F 16 BE
0040 | 39 52 E0 B9 B5 E7 D2 4C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E888903ABDBA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F08EAD7E663D75499459B4B5ACA9140D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>3BA23AED2B35834032AC249B681BBC29</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>7A1599529E5F16BE3952E0B9B5E7D24C</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

