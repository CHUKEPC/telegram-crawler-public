<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?237" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 CC E5 02 00 E8 2E 7B 66
0010 | 14 00 00 00 F1 8E 7E BE FE 76 51 D6 28 ED 47 10
0020 | EE 66 DE C7 F2 89 F2 D3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>CCE50200E82E7B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 11 97 E8 2E 7B 66
0010 | B4 00 00 00 63 24 16 05 FE 76 51 D6 28 ED 47 10
0020 | EE 66 DE C7 F2 89 F2 D3 A8 71 EC 90 54 40 E9 4F
0030 | 36 CA AE 3C 16 AE 24 E1 08 29 0B 62 FE 56 DA C8
0040 | B3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E81197E82E7B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B4000000</code> (180 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08290B62FE56DAC8B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2957566424817256627</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2957566424817256627</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2957566424817256627 = 1650247297 * 1792195891</code></p>
<pre><code>p = 1650247297
q = 1792195891</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 29 0B 62 FE 56 DA C8 B3 00 00 00
0010 | 04 62 5C C6 81 00 00 00 04 6A D2 BD 33 00 00 00
0020 | FE 76 51 D6 28 ED 47 10 EE 66 DE C7 F2 89 F2 D3
0030 | A8 71 EC 90 54 40 E9 4F 36 CA AE 3C 16 AE 24 E1
0040 | 69 56 FE C1 57 B9 00 B9 C0 FF 2E F9 33 2B D8 FD
0050 | F0 CB 19 0F BE 4F 10 49 41 F7 4C FE 6C C0 A2 D8
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08290B62FE56DAC8B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2957566424817256627</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04625CC681000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1650247297</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046AD2BD33000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1792195891</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>6956FEC157B900B9C0FF2EF9332BD8FD</code> <code>F0CB190FBE4F104941F74CFE6CC0A2D8</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908290B62FE56DAC8B300000004625CC681000000046AD2BD33000000FE7651D628ED4710EE66DEC7F289F2D3A871EC905440E94F36CAAE3C16AE24E16956FEC157B900B9C0FF2EF9332BD8FDF0CB190FBE4F104941F74CFE6CC0A2D802000000
random_padding_bytes = 10E6A86C7055C990CB7E20A61032FEEC341959199DBE48C3B6EF7B24AFF34152C1D89BA48A3325D3C90D4E67420F61FAC601BE55E54B6242B17DC8FFEE182AC86EA9CFF52396B9608E175478B678AFADEFF5A2CB310798054172AD88</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 50F897F754BC90122EC904E0797B56062100C1091339D3EBF5991350BAFFA1B096DDC7CD6DE9AA8ED200A7B3F0D73A568BFC94F2833EFE005BD990C02A0B80B49C6370D46B97BE7CEC46F5A228D01014DD0D9BA1FBDC1D841AEC0BFF5EA2067AB9E504B4FE2FD8340C1828B5C5D278698ED7AE01F08D494A35648C3B31147C38A13F62EFD65510F0E0C3583FED00048C6DADFAF143398B24ED7F1338FCCBEA03DFC0AD86247F5D380706F59CCA61F1E22636FE985B421BF33AE45843B96548DAB274D624AAEDA2054CFCC8DCED7867E409B78952CDA85CFC6BF2F56FA028C591BD90A8A77E976D73BFCF2FAE57546E7C036E6D5390EC7C070360CD6E8F9E44CA</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 70 06 00 E8 2E 7B 66
0010 | 40 01 00 00 BE E4 12 D7 FE 76 51 D6 28 ED 47 10
0020 | EE 66 DE C7 F2 89 F2 D3 A8 71 EC 90 54 40 E9 4F
0030 | 36 CA AE 3C 16 AE 24 E1 04 62 5C C6 81 00 00 00
0040 | 04 6A D2 BD 33 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 50 F8 97 F7 54 BC 90 12 2E C9 04 E0
0060 | 79 7B 56 06 21 00 C1 09 13 39 D3 EB F5 99 13 50
0070 | BA FF A1 B0 96 DD C7 CD 6D E9 AA 8E D2 00 A7 B3
0080 | F0 D7 3A 56 8B FC 94 F2 83 3E FE 00 5B D9 90 C0
0090 | 2A 0B 80 B4 9C 63 70 D4 6B 97 BE 7C EC 46 F5 A2
00A0 | 28 D0 10 14 DD 0D 9B A1 FB DC 1D 84 1A EC 0B FF
00B0 | 5E A2 06 7A B9 E5 04 B4 FE 2F D8 34 0C 18 28 B5
00C0 | C5 D2 78 69 8E D7 AE 01 F0 8D 49 4A 35 64 8C 3B
00D0 | 31 14 7C 38 A1 3F 62 EF D6 55 10 F0 E0 C3 58 3F
00E0 | ED 00 04 8C 6D AD FA F1 43 39 8B 24 ED 7F 13 38
00F0 | FC CB EA 03 DF C0 AD 86 24 7F 5D 38 07 06 F5 9C
0100 | CA 61 F1 E2 26 36 FE 98 5B 42 1B F3 3A E4 58 43
0110 | B9 65 48 DA B2 74 D6 24 AA ED A2 05 4C FC C8 DC
0120 | ED 78 67 E4 09 B7 89 52 CD A8 5C FC 6B F2 F5 6F
0130 | A0 28 C5 91 BD 90 A8 A7 7E 97 6D 73 BF CF 2F AE
0140 | 57 54 6E 7C 03 6E 6D 53 90 EC 7C 07 03 60 CD 6E
0150 | 8F 9E 44 CA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0700600E82E7B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04625CC681000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1650247297</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046AD2BD33000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1792195891</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010050F897F754BC90122EC904E0</code> <code>797B56062100C1091339D3EBF5991350</code> <code>BAFFA1B096DDC7CD6DE9AA8ED200A7B3</code> <code>F0D73A568BFC94F2833EFE005BD990C0</code> <code>2A0B80B49C6370D46B97BE7CEC46F5A2</code> <code>28D01014DD0D9BA1FBDC1D841AEC0BFF</code> <code>5EA2067AB9E504B4FE2FD8340C1828B5</code> <code>C5D278698ED7AE01F08D494A35648C3B</code> <code>31147C38A13F62EFD65510F0E0C3583F</code> <code>ED00048C6DADFAF143398B24ED7F1338</code> <code>FCCBEA03DFC0AD86247F5D380706F59C</code> <code>CA61F1E22636FE985B421BF33AE45843</code> <code>B96548DAB274D624AAEDA2054CFCC8DC</code> <code>ED7867E409B78952CDA85CFC6BF2F56F</code> <code>A028C591BD90A8A77E976D73BFCF2FAE</code> <code>57546E7C036E6D5390EC7C070360CD6E</code><br> <code>8F9E44CA</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 5C F5 4F E9 2E 7B 66
0010 | C0 02 00 00 5C 07 E8 D0 FE 76 51 D6 28 ED 47 10
0020 | EE 66 DE C7 F2 89 F2 D3 A8 71 EC 90 54 40 E9 4F
0030 | 36 CA AE 3C 16 AE 24 E1 FE 50 02 00 7B 33 7C 45
0040 | 5B C8 B9 56 F0 BA 88 DA 47 72 4C E9 C3 79 5B 2F
0050 | 87 03 98 67 B0 4A 1F 16 D7 27 E0 33 A7 0D 00 18
0060 | FF 6D 63 20 B6 E7 FC 41 94 7F 96 8A F9 BD 4E 91
0070 | E8 4B 7B 43 8E 6C 23 E2 51 7C 8C 47 A2 8E D7 55
0080 | 6F 18 4B AF 5A B3 5E 17 82 BD 0D 34 FC 0F 0D 4D
0090 | CB D0 F7 BE C7 27 B1 CD FE F4 BC 37 E9 82 F8 9E
00A0 | 0B DA 30 8A D2 D3 31 54 B8 78 07 3F 46 F9 4E 8B
00B0 | E2 41 0D 2A 36 A8 99 51 3E 0D 3E 73 EA 56 B1 12
00C0 | AA 3D 26 7D 71 CB AA CC 73 53 B8 CF ED 98 40 C4
00D0 | 50 36 6F 33 1A C1 C1 23 7C B4 4B 58 F1 46 3B B1
00E0 | 99 C0 D9 E4 97 14 C9 C2 5E FC F9 8A DE DC 81 21
00F0 | 4A 2A CF 62 4A 18 BE A0 81 43 54 B9 10 79 54 77
0100 | EF 87 28 6D 27 4C 48 09 DC 93 21 19 9D D0 73 CD
0110 | A5 E7 E0 AB 42 C2 9C 23 62 ED B8 FE E9 98 8B DF
0120 | 31 2C 8D 6D 2B 74 74 C6 92 29 1F 53 3A 36 93 E3
0130 | 6C A6 AE CB 30 F9 10 E2 79 F4 42 83 A3 7F 53 93
0140 | 0A C4 05 5D F5 49 3D A7 DC E7 AE 3B 5B B7 1D 10
0150 | BC 3D 20 DF 5A F7 9F B4 7F B2 91 6B 77 AC 47 7F
0160 | FC 89 0D 64 6C DE C2 3A AD B5 7C A6 AA 05 87 94
0170 | 7F 74 65 BC A4 09 02 12 3E 97 EB 97 ED 1D A5 C1
0180 | 33 2D 34 A8 93 10 C4 06 B7 29 E2 64 4F A3 F7 D2
0190 | 4B A1 70 0C 13 27 27 4E 78 D1 93 18 5E 4B D0 4C
01A0 | 99 0F 3A E7 AD 30 3E FF BA 61 C7 76 D5 6D 2C A1
01B0 | F5 06 94 9B 82 A7 8F ED 69 E7 75 C6 6C 17 F1 8C
01C0 | B0 38 77 E4 08 28 D0 11 ED 2A 62 54 11 FE 8D 12
01D0 | 63 4B 38 E3 14 90 E2 0A 4A 52 96 38 11 08 51 0E
01E0 | 6D 8B E8 77 79 5F 78 E4 08 3D 56 DA 6E 5D F0 BB
01F0 | 57 A6 E7 BF C1 58 8B 3A 6B B7 DB 99 AE DB 98 BD
0200 | C3 BC F9 C8 98 DA 65 DB 19 78 70 AB 7A F3 B7 E3
0210 | 36 5F 18 F3 9A 37 7A E0 7C 17 24 08 85 A3 D9 A9
0220 | AC 2A C1 74 00 E9 83 96 6F AA BF 89 05 30 B2 81
0230 | BA FE 53 C7 D5 A3 0F A4 CA DA 81 4F 5B AB 69 85
0240 | 67 BE BC 09 B1 C9 64 23 E9 36 6E AB 82 8D 25 2A
0250 | 42 1D C0 4E C3 BF DF 8D DB 16 2B 9D 9B AC 4A 42
0260 | CC 60 1D 69 A0 55 10 B4 81 0D DA C4 2B 3D B6 45
0270 | 91 13 CC 4C 7A F3 1D 7C 7F F8 38 18 56 19 AA 30
0280 | FE 96 8E B4 59 B5 26 E7 6C 60 34 FC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015CF54FE92E7B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C0020000</code> (704 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002007B337C455BC8B956F0BA88DA</code> <code>47724CE9C3795B2F87039867B04A1F16</code> <code>D727E033A70D0018FF6D6320B6E7FC41</code> <code>947F968AF9BD4E91E84B7B438E6C23E2</code> <code>517C8C47A28ED7556F184BAF5AB35E17</code> <code>82BD0D34FC0F0D4DCBD0F7BEC727B1CD</code> <code>FEF4BC37E982F89E0BDA308AD2D33154</code> <code>B878073F46F94E8BE2410D2A36A89951</code> <code>3E0D3E73EA56B112AA3D267D71CBAACC</code> <code>7353B8CFED9840C450366F331AC1C123</code> <code>7CB44B58F1463BB199C0D9E49714C9C2</code> <code>5EFCF98ADEDC81214A2ACF624A18BEA0</code> <code>814354B910795477EF87286D274C4809</code> <code>DC9321199DD073CDA5E7E0AB42C29C23</code> <code>62EDB8FEE9988BDF312C8D6D2B7474C6</code> <code>92291F533A3693E36CA6AECB30F910E2</code> <code>79F44283A37F53930AC4055DF5493DA7</code> <code>DCE7AE3B5BB71D10BC3D20DF5AF79FB4</code> <code>7FB2916B77AC477FFC890D646CDEC23A</code> <code>ADB57CA6AA0587947F7465BCA4090212</code> <code>3E97EB97ED1DA5C1332D34A89310C406</code> <code>B729E2644FA3F7D24BA1700C1327274E</code> <code>78D193185E4BD04C990F3AE7AD303EFF</code> <code>BA61C776D56D2CA1F506949B82A78FED</code> <code>69E775C66C17F18CB03877E40828D011</code> <code>ED2A625411FE8D12634B38E31490E20A</code> <code>4A5296381108510E6D8BE877795F78E4</code> <code>083D56DA6E5DF0BB57A6E7BFC1588B3A</code> <code>6BB7DB99AEDB98BDC3BCF9C898DA65DB</code> <code>197870AB7AF3B7E3365F18F39A377AE0</code> <code>7C17240885A3D9A9AC2AC17400E98396</code> <code>6FAABF890530B281BAFE53C7D5A30FA4</code> <code>CADA814F5BAB698567BEBC09B1C96423</code> <code>E9366EAB828D252A421DC04EC3BFDF8D</code> <code>DB162B9D9BAC4A42CC601D69A05510B4</code> <code>810DDAC42B3DB6459113CC4C7AF31D7C</code> <code>7FF838185619AA30FE968EB459B526E7</code><br> <code>6C6034FC</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 7B337C455BC8B956F0BA88DA47724CE9C3795B2F87039867B04A1F16D727E033A70D0018FF6D6320B6E7FC41947F968AF9BD4E91E84B7B438E6C23E2517C8C47A28ED7556F184BAF5AB35E1782BD0D34FC0F0D4DCBD0F7BEC727B1CDFEF4BC37E982F89E0BDA308AD2D33154B878073F46F94E8BE2410D2A36A899513E0D3E73EA56B112AA3D267D71CBAACC7353B8CFED9840C450366F331AC1C1237CB44B58F1463BB199C0D9E49714C9C25EFCF98ADEDC81214A2ACF624A18BEA0814354B910795477EF87286D274C4809DC9321199DD073CDA5E7E0AB42C29C2362EDB8FEE9988BDF312C8D6D2B7474C692291F533A3693E36CA6AECB30F910E279F44283A37F53930AC4055DF5493DA7DCE7AE3B5BB71D10BC3D20DF5AF79FB47FB2916B77AC477FFC890D646CDEC23AADB57CA6AA0587947F7465BCA40902123E97EB97ED1DA5C1332D34A89310C406B729E2644FA3F7D24BA1700C1327274E78D193185E4BD04C990F3AE7AD303EFFBA61C776D56D2CA1F506949B82A78FED69E775C66C17F18CB03877E40828D011ED2A625411FE8D12634B38E31490E20A4A5296381108510E6D8BE877795F78E4083D56DA6E5DF0BB57A6E7BFC1588B3A6BB7DB99AEDB98BDC3BCF9C898DA65DB197870AB7AF3B7E3365F18F39A377AE07C17240885A3D9A9AC2AC17400E983966FAABF890530B281BAFE53C7D5A30FA4CADA814F5BAB698567BEBC09B1C96423E9366EAB828D252A421DC04EC3BFDF8DDB162B9D9BAC4A42CC601D69A05510B4810DDAC42B3DB6459113CC4C7AF31D7C7FF838185619AA30FE968EB459B526E76C6034FC
tmp_aes_key = D643DDC0A2EF8831729DB7D01C356F174CE09C6C8C26008E1A16BD197F89579A
tmp_aes_iv = 5136F208E6F269F4963A2965142188C736DBB06227671DFBAB563A056956FEC1</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 661B87493E4C91D6651897768B9645D16457093BBA0D89B5FE7651D628ED4710EE66DEC7F289F2D3A871EC905440E94F36CAAE3C16AE24E103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B0772194A508D6F92C5E914769EB206F31E755D07DB39AF339376EB2F3873B980F3F3BCAD528FF333F0AB24190887EE1D07E6112269098CE31D3EE52BAA09AF0EEAA1260A9B269F97916C9276B6176D314D1B65A55A59B523D41DFA9F7138D18FD73F265F93B52B93980841B1BE965BD775D3F52A23D5544367C6F6E8FB2F0D237D5970BD0A326606C7325B740EBCB82C30C69D62EB9D2E412567795A891878F0FEC03572B70A7396EC7186EDF10AF4A07F92964ED8FD6C397FDE724B33B150B4C58FE81CC0173731F40EA16F1ACD2C26EF2B88CE1AAA4572162D6F13EF04056CD54EE6AC8709B3CA411957240CFAA66354D5D4257FF5342B110F22AE3C3B186E92E7B664E5FA4C64957CFB2
answer = BA0D89B5FE7651D628ED4710EE66DEC7F289F2D3A871EC905440E94F36CAAE3C16AE24E103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B0772194A508D6F92C5E914769EB206F31E755D07DB39AF339376EB2F3873B980F3F3BCAD528FF333F0AB24190887EE1D07E6112269098CE31D3EE52BAA09AF0EEAA1260A9B269F97916C9276B6176D314D1B65A55A59B523D41DFA9F7138D18FD73F265F93B52B93980841B1BE965BD775D3F52A23D5544367C6F6E8FB2F0D237D5970BD0A326606C7325B740EBCB82C30C69D62EB9D2E412567795A891878F0FEC03572B70A7396EC7186EDF10AF4A07F92964ED8FD6C397FDE724B33B150B4C58FE81CC0173731F40EA16F1ACD2C26EF2B88CE1AAA4572162D6F13EF04056CD54EE6AC8709B3CA411957240CFAA66354D5D4257FF5342B110F22AE3C3B186E92E7B664E5FA4C64957CFB2</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 FE 76 51 D6 28 ED 47 10 EE 66 DE C7
0010 | F2 89 F2 D3 A8 71 EC 90 54 40 E9 4F 36 CA AE 3C
0020 | 16 AE 24 E1 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | B0 77 21 94 A5 08 D6 F9 2C 5E 91 47 69 EB 20 6F
0140 | 31 E7 55 D0 7D B3 9A F3 39 37 6E B2 F3 87 3B 98
0150 | 0F 3F 3B CA D5 28 FF 33 3F 0A B2 41 90 88 7E E1
0160 | D0 7E 61 12 26 90 98 CE 31 D3 EE 52 BA A0 9A F0
0170 | EE AA 12 60 A9 B2 69 F9 79 16 C9 27 6B 61 76 D3
0180 | 14 D1 B6 5A 55 A5 9B 52 3D 41 DF A9 F7 13 8D 18
0190 | FD 73 F2 65 F9 3B 52 B9 39 80 84 1B 1B E9 65 BD
01A0 | 77 5D 3F 52 A2 3D 55 44 36 7C 6F 6E 8F B2 F0 D2
01B0 | 37 D5 97 0B D0 A3 26 60 6C 73 25 B7 40 EB CB 82
01C0 | C3 0C 69 D6 2E B9 D2 E4 12 56 77 95 A8 91 87 8F
01D0 | 0F EC 03 57 2B 70 A7 39 6E C7 18 6E DF 10 AF 4A
01E0 | 07 F9 29 64 ED 8F D6 C3 97 FD E7 24 B3 3B 15 0B
01F0 | 4C 58 FE 81 CC 01 73 73 1F 40 EA 16 F1 AC D2 C2
0200 | 6E F2 B8 8C E1 AA A4 57 21 62 D6 F1 3E F0 40 56
0210 | CD 54 EE 6A C8 70 9B 3C A4 11 95 72 40 CF AA 66
0220 | 35 4D 5D 42 57 FF 53 42 B1 10 F2 2A E3 C3 B1 86
0230 | E9 2E 7B 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100B0772194A508D6F92C5E9147</code> <code>69EB206F31E755D07DB39AF339376EB2</code> <code>F3873B980F3F3BCAD528FF333F0AB241</code> <code>90887EE1D07E6112269098CE31D3EE52</code> <code>BAA09AF0EEAA1260A9B269F97916C927</code> <code>6B6176D314D1B65A55A59B523D41DFA9</code> <code>F7138D18FD73F265F93B52B93980841B</code> <code>1BE965BD775D3F52A23D5544367C6F6E</code> <code>8FB2F0D237D5970BD0A326606C7325B7</code> <code>40EBCB82C30C69D62EB9D2E412567795</code> <code>A891878F0FEC03572B70A7396EC7186E</code> <code>DF10AF4A07F92964ED8FD6C397FDE724</code> <code>B33B150B4C58FE81CC0173731F40EA16</code> <code>F1ACD2C26EF2B88CE1AAA4572162D6F1</code> <code>3EF04056CD54EE6AC8709B3CA4119572</code> <code>40CFAA66354D5D4257FF5342B110F22A</code><br> <code>E3C3B186</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E92E7B66</code> (1719348969 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = D50EA9047898647D4588A719EA6250AA9397A825CABBDE031EEB5F5D7599CD9C0C75FC693E10B1EEDC7218C5AFFA726ADDF4D1F873EB0FBC22997720873B942A698B0F99453934207D85EE0B5365CF2C9F2303AABDC705DFC0052FC27EC512024999D507012BCB3F8321FC461D34280F910BE7F9190AD931B9FDACCDF82448324025F84D65B472D090BA6E2DF03C5DF5A888A530AC1231B123A90E68F4CF1FDBD752A573682ED61C3893C1FFA38C729970AF28D4ECCF2AD1713957D695E550A978B88FDCE4531B936E4AAB7240815209A14AEB1D26EE8B48499E1E144F35CCDAFEDF3F203AD8357369CE7D8579133B4CD9929F6668A8492645932C334CAA16F8</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 61F9C703D8BDB0F8C7F74ACD60E59C65B013F2933B888DA35D41195A13A548C27800FDCFEAEA1705DF8FE846734A74338A0CF0AAE517ABD824DFFEF0560C8F985375088B5E5DEB8F90D05863B8ACD0F5B53E625414D28E91AB1014A1EAA54D1465438ABCB19C0881751643689E674FBE3889D260455DC419A28FBB93499DBBC30C9F33CB2F1C35942198D66E89351C136762783773276E1C531F6CA97AA65CA92E4DD3106D62B277253A8594E838FF3BC858D7922D505ED1FA141A7F5339E33A59EAB18FA971FEE834D927D745580341C9ADF3467CB14DE6B7E54DE03402A86CCDD93D5E65A06B09C702F36E565116789F0D4E366F8E21FD992FFB63C6BBA32B</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 FE 76 51 D6 28 ED 47 10 EE 66 DE C7
0010 | F2 89 F2 D3 A8 71 EC 90 54 40 E9 4F 36 CA AE 3C
0020 | 16 AE 24 E1 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 61 F9 C7 03 D8 BD B0 F8 C7 F7 4A CD 60 E5 9C 65
0040 | B0 13 F2 93 3B 88 8D A3 5D 41 19 5A 13 A5 48 C2
0050 | 78 00 FD CF EA EA 17 05 DF 8F E8 46 73 4A 74 33
0060 | 8A 0C F0 AA E5 17 AB D8 24 DF FE F0 56 0C 8F 98
0070 | 53 75 08 8B 5E 5D EB 8F 90 D0 58 63 B8 AC D0 F5
0080 | B5 3E 62 54 14 D2 8E 91 AB 10 14 A1 EA A5 4D 14
0090 | 65 43 8A BC B1 9C 08 81 75 16 43 68 9E 67 4F BE
00A0 | 38 89 D2 60 45 5D C4 19 A2 8F BB 93 49 9D BB C3
00B0 | 0C 9F 33 CB 2F 1C 35 94 21 98 D6 6E 89 35 1C 13
00C0 | 67 62 78 37 73 27 6E 1C 53 1F 6C A9 7A A6 5C A9
00D0 | 2E 4D D3 10 6D 62 B2 77 25 3A 85 94 E8 38 FF 3B
00E0 | C8 58 D7 92 2D 50 5E D1 FA 14 1A 7F 53 39 E3 3A
00F0 | 59 EA B1 8F A9 71 FE E8 34 D9 27 D7 45 58 03 41
0100 | C9 AD F3 46 7C B1 4D E6 B7 E5 4D E0 34 02 A8 6C
0110 | CD D9 3D 5E 65 A0 6B 09 C7 02 F3 6E 56 51 16 78
0120 | 9F 0D 4E 36 6F 8E 21 FD 99 2F FB 63 C6 BB A3 2B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010061F9C703D8BDB0F8C7F74ACD</code> <code>60E59C65B013F2933B888DA35D41195A</code> <code>13A548C27800FDCFEAEA1705DF8FE846</code> <code>734A74338A0CF0AAE517ABD824DFFEF0</code> <code>560C8F985375088B5E5DEB8F90D05863</code> <code>B8ACD0F5B53E625414D28E91AB1014A1</code> <code>EAA54D1465438ABCB19C088175164368</code> <code>9E674FBE3889D260455DC419A28FBB93</code> <code>499DBBC30C9F33CB2F1C35942198D66E</code> <code>89351C136762783773276E1C531F6CA9</code> <code>7AA65CA92E4DD3106D62B277253A8594</code> <code>E838FF3BC858D7922D505ED1FA141A7F</code> <code>5339E33A59EAB18FA971FEE834D927D7</code> <code>45580341C9ADF3467CB14DE6B7E54DE0</code> <code>3402A86CCDD93D5E65A06B09C702F36E</code> <code>565116789F0D4E366F8E21FD992FFB63</code><br> <code>C6BBA32B</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366FE7651D628ED4710EE66DEC7F289F2D3A871EC905440E94F36CAAE3C16AE24E10000000000000000FE00010061F9C703D8BDB0F8C7F74ACD60E59C65B013F2933B888DA35D41195A13A548C27800FDCFEAEA1705DF8FE846734A74338A0CF0AAE517ABD824DFFEF0560C8F985375088B5E5DEB8F90D05863B8ACD0F5B53E625414D28E91AB1014A1EAA54D1465438ABCB19C0881751643689E674FBE3889D260455DC419A28FBB93499DBBC30C9F33CB2F1C35942198D66E89351C136762783773276E1C531F6CA97AA65CA92E4DD3106D62B277253A8594E838FF3BC858D7922D505ED1FA141A7F5339E33A59EAB18FA971FEE834D927D745580341C9ADF3467CB14DE6B7E54DE03402A86CCDD93D5E65A06B09C702F36E565116789F0D4E366F8E21FD992FFB63C6BBA32B
padding = 320D2D4A2E5B51C92719E3AD
tmp_aes_key = D643DDC0A2EF8831729DB7D01C356F174CE09C6C8C26008E1A16BD197F89579A
tmp_aes_iv = 5136F208E6F269F4963A2965142188C736DBB06227671DFBAB563A056956FEC1</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 3404452FC25D9F806B4D8ED3FA3D410A031315318896713D798C32F19F95714728522AA4A0D2E86AC2F107E09E4D238E2BDDB26F99B5E5D18B8B5B7FF0E9C93F8D830430F458EA441EBEF3FD69C7A60F29E21F96D2703D1B94AA469C7BE2278ECF37C01DC715FE6679D929C09EF433AEACB9CE5B74E55085F35EC48AB6FCB3DFA3210DEA29F8079CA9C27791019AAD20B7D10FD7C47F21EBE7123DE1F712C0BAE5F1EBFCA4D7863523B8870FDD1C3EC48344ED223684444C0FF0542487F3F4B35FB7015C384D560A3A5E249586283DCA8C3C7702019ADD46094CEC9C8F3BB233B6437252B27657CD9EBA7D675CADB9CD6E18C2B969E7FB78F6042C87AB6108E76043503CC7A785C521EA86EAE6F790BA87B1103FBB00C6E50090E2F0ECBC5118E91E7A8849E320B3132CB65AA6A4F11067376DA01879D8CEDEB9B10783A212798E2A32435018F527795CB34FC5FA2FB9</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B8 3F 07 00 E9 2E 7B 66
0010 | 78 01 00 00 1F 5F 04 F5 FE 76 51 D6 28 ED 47 10
0020 | EE 66 DE C7 F2 89 F2 D3 A8 71 EC 90 54 40 E9 4F
0030 | 36 CA AE 3C 16 AE 24 E1 FE 50 01 00 34 04 45 2F
0040 | C2 5D 9F 80 6B 4D 8E D3 FA 3D 41 0A 03 13 15 31
0050 | 88 96 71 3D 79 8C 32 F1 9F 95 71 47 28 52 2A A4
0060 | A0 D2 E8 6A C2 F1 07 E0 9E 4D 23 8E 2B DD B2 6F
0070 | 99 B5 E5 D1 8B 8B 5B 7F F0 E9 C9 3F 8D 83 04 30
0080 | F4 58 EA 44 1E BE F3 FD 69 C7 A6 0F 29 E2 1F 96
0090 | D2 70 3D 1B 94 AA 46 9C 7B E2 27 8E CF 37 C0 1D
00A0 | C7 15 FE 66 79 D9 29 C0 9E F4 33 AE AC B9 CE 5B
00B0 | 74 E5 50 85 F3 5E C4 8A B6 FC B3 DF A3 21 0D EA
00C0 | 29 F8 07 9C A9 C2 77 91 01 9A AD 20 B7 D1 0F D7
00D0 | C4 7F 21 EB E7 12 3D E1 F7 12 C0 BA E5 F1 EB FC
00E0 | A4 D7 86 35 23 B8 87 0F DD 1C 3E C4 83 44 ED 22
00F0 | 36 84 44 4C 0F F0 54 24 87 F3 F4 B3 5F B7 01 5C
0100 | 38 4D 56 0A 3A 5E 24 95 86 28 3D CA 8C 3C 77 02
0110 | 01 9A DD 46 09 4C EC 9C 8F 3B B2 33 B6 43 72 52
0120 | B2 76 57 CD 9E BA 7D 67 5C AD B9 CD 6E 18 C2 B9
0130 | 69 E7 FB 78 F6 04 2C 87 AB 61 08 E7 60 43 50 3C
0140 | C7 A7 85 C5 21 EA 86 EA E6 F7 90 BA 87 B1 10 3F
0150 | BB 00 C6 E5 00 90 E2 F0 EC BC 51 18 E9 1E 7A 88
0160 | 49 E3 20 B3 13 2C B6 5A A6 A4 F1 10 67 37 6D A0
0170 | 18 79 D8 CE DE B9 B1 07 83 A2 12 79 8E 2A 32 43
0180 | 50 18 F5 27 79 5C B3 4F C5 FA 2F B9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B83F0700E92E7B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001003404452FC25D9F806B4D8ED3</code> <code>FA3D410A031315318896713D798C32F1</code> <code>9F95714728522AA4A0D2E86AC2F107E0</code> <code>9E4D238E2BDDB26F99B5E5D18B8B5B7F</code> <code>F0E9C93F8D830430F458EA441EBEF3FD</code> <code>69C7A60F29E21F96D2703D1B94AA469C</code> <code>7BE2278ECF37C01DC715FE6679D929C0</code> <code>9EF433AEACB9CE5B74E55085F35EC48A</code> <code>B6FCB3DFA3210DEA29F8079CA9C27791</code> <code>019AAD20B7D10FD7C47F21EBE7123DE1</code> <code>F712C0BAE5F1EBFCA4D7863523B8870F</code> <code>DD1C3EC48344ED223684444C0FF05424</code> <code>87F3F4B35FB7015C384D560A3A5E2495</code> <code>86283DCA8C3C7702019ADD46094CEC9C</code> <code>8F3BB233B6437252B27657CD9EBA7D67</code> <code>5CADB9CD6E18C2B969E7FB78F6042C87</code> <code>AB6108E76043503CC7A785C521EA86EA</code> <code>E6F790BA87B1103FBB00C6E50090E2F0</code> <code>ECBC5118E91E7A8849E320B3132CB65A</code> <code>A6A4F11067376DA01879D8CEDEB9B107</code> <code>83A212798E2A32435018F527795CB34F</code><br> <code>C5FA2FB9</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = AD531187B49B35724A4CDEA28360522C24D572DE3DBA4B701B79E6486E10F3165BEBCB5BA36369FFD390E79C7AE018936CDCD44486F195DEF8A920CC24C6B8B94D615066E86A5F565A1554C292ABC403BB0184BBC66649FC1BA2F2394621C036B8ECA39496595CCEDBAF61FFC0E324167720FD0F597E28C43026089EC2B8BCDC50D20873AC30FD60F6A9AD59D8600E4BE4C1EA6F8B23625F45F16B780DFDD7C717A87E8732D1C2EF1A2698BC3FBEE569E09EB36B0E3797CCE231E084CCE3C4B815AF1BC463D84200104A514E4E29C809B59954A94AD3A54DECF7F2CB09B2D7AE01C7AB73DE9FEB8784CED6A81E744F7F7A77064411AF4574F1B717AF60CD4552</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 BC B7 71 EA 2E 7B 66
0010 | 90 00 00 00 34 F7 CB 3B FE 76 51 D6 28 ED 47 10
0020 | EE 66 DE C7 F2 89 F2 D3 A8 71 EC 90 54 40 E9 4F
0030 | 36 CA AE 3C 16 AE 24 E1 BA FA BD FA 3C 62 E4 2A
0040 | 9E 9D 11 78 6F B9 72 9F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01BCB771EA2E7B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90000000</code> (144 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7651D628ED4710EE66DEC7F289F2D3</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A871EC905440E94F36CAAE3C16AE24E1</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>BAFABDFA3C62E42A9E9D11786FB9729F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

