<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?237" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C B5 02 00 0B 64 70 66
0010 | 14 00 00 00 F1 8E 7E BE 17 62 E3 D8 C2 13 A8 FA
0020 | C5 F4 12 25 E3 60 13 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6CB502000B647066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 84 15 7C 0B 64 70 66
0010 | C8 00 00 00 63 24 16 05 17 62 E3 D8 C2 13 A8 FA
0020 | C5 F4 12 25 E3 60 13 1E B2 70 60 7F 52 AD 68 D1
0030 | 56 29 8C 9D DC 64 5F 70 08 24 94 4C C1 89 C8 19
0040 | 35 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0184157C0B647066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C8000000</code> (200 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0824944CC189C81935000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2635816076042574133</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2635816076042574133</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2635816076042574133 = 1483259383 * 1777043251</code></p>
<pre><code>p = 1483259383
q = 1777043251</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 24 94 4C C1 89 C8 19 35 00 00 00
0010 | 04 58 68 BD F7 00 00 00 04 69 EB 87 33 00 00 00
0020 | 17 62 E3 D8 C2 13 A8 FA C5 F4 12 25 E3 60 13 1E
0030 | B2 70 60 7F 52 AD 68 D1 56 29 8C 9D DC 64 5F 70
0040 | C2 50 D3 66 BC D2 3A F7 90 B2 10 E6 A0 28 2F 21
0050 | 53 41 D4 F8 F0 DA 17 FB 19 CC 86 ED 4E 88 42 8E
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0824944CC189C81935000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2635816076042574133</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045868BDF7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1483259383</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0469EB8733000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1777043251</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>C250D366BCD23AF790B210E6A0282F21</code> <code>5341D4F8F0DA17FB19CC86ED4E88428E</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90824944CC189C81935000000045868BDF70000000469EB87330000001762E3D8C213A8FAC5F41225E360131EB270607F52AD68D156298C9DDC645F70C250D366BCD23AF790B210E6A0282F215341D4F8F0DA17FB19CC86ED4E88428E02000000
random_padding_bytes = AE894413AD56A8DB9DFDCC19CB18DD30032C25DFCD9E780E7974F4A9348814AB223D786762F142BDF503FA2CCD238D35EB42FCE3A4E25DC3792884979375C1140E889FB5100A16622665BFA428462B23AA146DEA7CE09E56C94C90CA</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 3EEF398E2F83E13916B2C845F347C16F06255E8BB779C8F35F7DD834842B88735F8199A5603755DBD12F7A9232DCC9C0E00E8A6AA42515C93AC245AC29DB1888C74F2523BC387F37FC602158617AB0F8CCF27FAF12A199683CD4829AB14FE94FDB27181BF46D178B1CCC705BDF7FB8A6496FEBA611DE84B689F7A0E7C6E0F1D307E4ABEF1B7E30E46A1335EE7E98A4FD69EB6F0CA7356B64509AF68196F57586D81DE5CEB9321E36E63D626DEF496AE9560C0ABDF11EE71C915D71C889F161DBCA905728DC6F52C942C82785F6C854B71B0E853773174E922F48B51E968D90DE22DE605CDF3E1BD1BDD9C5E1D351640C6373A0821ABB1D8F42988368734F602D</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 A3 06 00 0B 64 70 66
0010 | 40 01 00 00 BE E4 12 D7 17 62 E3 D8 C2 13 A8 FA
0020 | C5 F4 12 25 E3 60 13 1E B2 70 60 7F 52 AD 68 D1
0030 | 56 29 8C 9D DC 64 5F 70 04 58 68 BD F7 00 00 00
0040 | 04 69 EB 87 33 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 3E EF 39 8E 2F 83 E1 39 16 B2 C8 45
0060 | F3 47 C1 6F 06 25 5E 8B B7 79 C8 F3 5F 7D D8 34
0070 | 84 2B 88 73 5F 81 99 A5 60 37 55 DB D1 2F 7A 92
0080 | 32 DC C9 C0 E0 0E 8A 6A A4 25 15 C9 3A C2 45 AC
0090 | 29 DB 18 88 C7 4F 25 23 BC 38 7F 37 FC 60 21 58
00A0 | 61 7A B0 F8 CC F2 7F AF 12 A1 99 68 3C D4 82 9A
00B0 | B1 4F E9 4F DB 27 18 1B F4 6D 17 8B 1C CC 70 5B
00C0 | DF 7F B8 A6 49 6F EB A6 11 DE 84 B6 89 F7 A0 E7
00D0 | C6 E0 F1 D3 07 E4 AB EF 1B 7E 30 E4 6A 13 35 EE
00E0 | 7E 98 A4 FD 69 EB 6F 0C A7 35 6B 64 50 9A F6 81
00F0 | 96 F5 75 86 D8 1D E5 CE B9 32 1E 36 E6 3D 62 6D
0100 | EF 49 6A E9 56 0C 0A BD F1 1E E7 1C 91 5D 71 C8
0110 | 89 F1 61 DB CA 90 57 28 DC 6F 52 C9 42 C8 27 85
0120 | F6 C8 54 B7 1B 0E 85 37 73 17 4E 92 2F 48 B5 1E
0130 | 96 8D 90 DE 22 DE 60 5C DF 3E 1B D1 BD D9 C5 E1
0140 | D3 51 64 0C 63 73 A0 82 1A BB 1D 8F 42 98 83 68
0150 | 73 4F 60 2D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>08A306000B647066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045868BDF7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1483259383</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0469EB8733000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1777043251</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001003EEF398E2F83E13916B2C845</code> <code>F347C16F06255E8BB779C8F35F7DD834</code> <code>842B88735F8199A5603755DBD12F7A92</code> <code>32DCC9C0E00E8A6AA42515C93AC245AC</code> <code>29DB1888C74F2523BC387F37FC602158</code> <code>617AB0F8CCF27FAF12A199683CD4829A</code> <code>B14FE94FDB27181BF46D178B1CCC705B</code> <code>DF7FB8A6496FEBA611DE84B689F7A0E7</code> <code>C6E0F1D307E4ABEF1B7E30E46A1335EE</code> <code>7E98A4FD69EB6F0CA7356B64509AF681</code> <code>96F57586D81DE5CEB9321E36E63D626D</code> <code>EF496AE9560C0ABDF11EE71C915D71C8</code> <code>89F161DBCA905728DC6F52C942C82785</code> <code>F6C854B71B0E853773174E922F48B51E</code> <code>968D90DE22DE605CDF3E1BD1BDD9C5E1</code> <code>D351640C6373A0821ABB1D8F42988368</code><br> <code>734F602D</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 68 7D 3D 0C 64 70 66
0010 | E8 02 00 00 5C 07 E8 D0 17 62 E3 D8 C2 13 A8 FA
0020 | C5 F4 12 25 E3 60 13 1E B2 70 60 7F 52 AD 68 D1
0030 | 56 29 8C 9D DC 64 5F 70 FE 50 02 00 E1 E2 B2 FC
0040 | 85 EB 30 7F 56 AC 3A A1 09 FB 02 65 93 E0 84 6C
0050 | BB B7 06 E7 25 0A 6B C5 CE 72 39 BE 64 D8 00 F5
0060 | 8D D6 27 37 24 37 0A B5 4F 1E CD B9 4D 9C 9A 03
0070 | DA 0F C1 85 E1 E7 72 9B 4A DE 2C 6A B5 09 1D 14
0080 | E3 31 00 9A 27 0D D2 22 A5 FC E8 22 10 22 04 01
0090 | A1 C2 B1 9D DF 21 48 D6 44 3B D6 B6 CC B4 0E 15
00A0 | BC 49 BD B3 AC 6B 72 49 E2 AD 51 97 80 CF 03 3A
00B0 | 0A E8 F4 EB BC 59 78 9D 80 30 4E 51 D5 80 9B 05
00C0 | A6 58 EF 1E 12 D8 90 DA 2E AF 6E 21 9D F2 7C EC
00D0 | 1C 76 05 A5 53 84 62 A9 5F D1 59 7C 79 EF E8 A5
00E0 | F4 1F 11 AE E7 59 75 18 06 9A 9F EA 54 0E 63 CA
00F0 | A1 CA 39 62 C0 A8 88 3B 9D C3 AA B1 67 8F FD CC
0100 | B0 78 10 6C 57 B4 E5 1C 1D D7 5A A8 2A FD EC 25
0110 | 0B 9C 6E 73 71 21 4A 64 BE 6A CF 23 C9 7E 4B 04
0120 | B6 D4 40 26 04 5E B8 0F B6 DC 7E 42 C0 34 92 11
0130 | 5F 0F 39 D5 7E 8D 71 81 B7 08 6E 90 E1 71 BC 3A
0140 | D5 C5 DD 3D 2E 37 FD 14 9D 9D F1 95 87 17 97 4A
0150 | 8B 5B 9F 7C 52 03 18 07 94 54 6F 77 50 03 E8 0C
0160 | 6E 38 F9 66 64 1C 4F A3 77 BE 42 E4 27 4B C4 45
0170 | DE 19 71 5A 36 CE 2F 30 99 3A 29 86 10 4D 71 62
0180 | 46 C5 4D 4A D8 B9 CA 2C 3B 00 8F F1 1B B0 AE ED
0190 | A5 A7 03 61 2B DF CB 09 AD FE 26 F8 44 6C 86 10
01A0 | 42 A4 79 AF 15 27 27 B0 22 00 BB 04 70 12 57 3E
01B0 | 59 36 44 E4 58 65 0B 03 EB E3 8C B3 B8 D0 1B AE
01C0 | EF FD 2B 74 4F A2 06 B0 1E D7 E1 9B 49 95 63 25
01D0 | A3 04 13 3C 8E 0A 09 F5 EE 4F B9 A9 C1 42 D2 33
01E0 | F3 5E 19 6A 30 14 9F 5D 07 06 F1 41 E9 64 C1 39
01F0 | A6 13 BF 84 55 75 3E 57 99 50 9A 40 7E AD 06 9E
0200 | E5 D8 0C 29 23 70 57 05 9B B6 C7 70 E0 4B 3B E8
0210 | 3F 76 F6 2C 5D 01 35 92 08 4B 7F 9D D4 04 44 CE
0220 | 87 33 53 CE 57 E3 24 AE 3B EA 2A A7 49 39 37 C0
0230 | 8B 7B 3B 5A 2E 68 31 FB F6 A5 13 96 9F A5 DE 85
0240 | 30 69 FA 45 B8 5E 81 43 0D 09 21 23 31 4C 39 C3
0250 | E8 12 B9 32 BB 93 94 8F 33 1E CA 54 DC 5C 74 FA
0260 | E3 0C FB 4B 8F 60 89 14 0D 26 B5 EB 14 F2 43 B0
0270 | 88 75 23 CE 45 69 82 F0 A4 12 01 38 52 F9 EC AE
0280 | 5C 96 2A 89 D0 F5 DC 53 F0 88 6C 27</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01687D3D0C647066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>E8020000</code> (744 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200E1E2B2FC85EB307F56AC3AA1</code> <code>09FB026593E0846CBBB706E7250A6BC5</code> <code>CE7239BE64D800F58DD6273724370AB5</code> <code>4F1ECDB94D9C9A03DA0FC185E1E7729B</code> <code>4ADE2C6AB5091D14E331009A270DD222</code> <code>A5FCE82210220401A1C2B19DDF2148D6</code> <code>443BD6B6CCB40E15BC49BDB3AC6B7249</code> <code>E2AD519780CF033A0AE8F4EBBC59789D</code> <code>80304E51D5809B05A658EF1E12D890DA</code> <code>2EAF6E219DF27CEC1C7605A5538462A9</code> <code>5FD1597C79EFE8A5F41F11AEE7597518</code> <code>069A9FEA540E63CAA1CA3962C0A8883B</code> <code>9DC3AAB1678FFDCCB078106C57B4E51C</code> <code>1DD75AA82AFDEC250B9C6E7371214A64</code> <code>BE6ACF23C97E4B04B6D44026045EB80F</code> <code>B6DC7E42C03492115F0F39D57E8D7181</code> <code>B7086E90E171BC3AD5C5DD3D2E37FD14</code> <code>9D9DF1958717974A8B5B9F7C52031807</code> <code>94546F775003E80C6E38F966641C4FA3</code> <code>77BE42E4274BC445DE19715A36CE2F30</code> <code>993A2986104D716246C54D4AD8B9CA2C</code> <code>3B008FF11BB0AEEDA5A703612BDFCB09</code> <code>ADFE26F8446C861042A479AF152727B0</code> <code>2200BB047012573E593644E458650B03</code> <code>EBE38CB3B8D01BAEEFFD2B744FA206B0</code> <code>1ED7E19B49956325A304133C8E0A09F5</code> <code>EE4FB9A9C142D233F35E196A30149F5D</code> <code>0706F141E964C139A613BF8455753E57</code> <code>99509A407EAD069EE5D80C2923705705</code> <code>9BB6C770E04B3BE83F76F62C5D013592</code> <code>084B7F9DD40444CE873353CE57E324AE</code> <code>3BEA2AA7493937C08B7B3B5A2E6831FB</code> <code>F6A513969FA5DE853069FA45B85E8143</code> <code>0D092123314C39C3E812B932BB93948F</code> <code>331ECA54DC5C74FAE30CFB4B8F608914</code> <code>0D26B5EB14F243B0887523CE456982F0</code> <code>A412013852F9ECAE5C962A89D0F5DC53</code><br> <code>F0886C27</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = E1E2B2FC85EB307F56AC3AA109FB026593E0846CBBB706E7250A6BC5CE7239BE64D800F58DD6273724370AB54F1ECDB94D9C9A03DA0FC185E1E7729B4ADE2C6AB5091D14E331009A270DD222A5FCE82210220401A1C2B19DDF2148D6443BD6B6CCB40E15BC49BDB3AC6B7249E2AD519780CF033A0AE8F4EBBC59789D80304E51D5809B05A658EF1E12D890DA2EAF6E219DF27CEC1C7605A5538462A95FD1597C79EFE8A5F41F11AEE7597518069A9FEA540E63CAA1CA3962C0A8883B9DC3AAB1678FFDCCB078106C57B4E51C1DD75AA82AFDEC250B9C6E7371214A64BE6ACF23C97E4B04B6D44026045EB80FB6DC7E42C03492115F0F39D57E8D7181B7086E90E171BC3AD5C5DD3D2E37FD149D9DF1958717974A8B5B9F7C5203180794546F775003E80C6E38F966641C4FA377BE42E4274BC445DE19715A36CE2F30993A2986104D716246C54D4AD8B9CA2C3B008FF11BB0AEEDA5A703612BDFCB09ADFE26F8446C861042A479AF152727B02200BB047012573E593644E458650B03EBE38CB3B8D01BAEEFFD2B744FA206B01ED7E19B49956325A304133C8E0A09F5EE4FB9A9C142D233F35E196A30149F5D0706F141E964C139A613BF8455753E5799509A407EAD069EE5D80C29237057059BB6C770E04B3BE83F76F62C5D013592084B7F9DD40444CE873353CE57E324AE3BEA2AA7493937C08B7B3B5A2E6831FBF6A513969FA5DE853069FA45B85E81430D092123314C39C3E812B932BB93948F331ECA54DC5C74FAE30CFB4B8F6089140D26B5EB14F243B0887523CE456982F0A412013852F9ECAE5C962A89D0F5DC53F0886C27
tmp_aes_key = B0B3A3AAB2040BDFDACC0ED2FDF2D766E3FAA894B9E3DBE96430E6C2794C9B1D
tmp_aes_iv = 0C4B1363835D9408D10AA3D134F1E30010658955718C19A6FDEA3EC7C250D366</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 88903DE3A32E750A262EF1F40C7B6DA1D935DABFBA0D89B51762E3D8C213A8FAC5F41225E360131EB270607F52AD68D156298C9DDC645F7003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100410090887964CEE17E9C053A404F9F241CCF1605B68150C675CB248E4E35D41F82C6ED283660A7482F1DFF41853FB6E570A30666B6350393641A9C87B2EE65D1A13118C083282D631CECC7281D29E94E426BA1AC357CC7732D6AB9DCA77CC93BB6020407F2C78B4B1FE7BB12F45DE24B530F500803B860AC5DA0791CE8F30C60E7F0A15CC5CC48C51FA02AF87E6D240FD70C3A8CD490CE0A4FB2C5F70A99851CFBB1764A9DD1F458A3407B70E457BAD41D21D763F321258D3669479C63638C789C3816D731155C209E87D10A573FE3D061BAA4D7CA7CFFDADC10976498347C7A0230E1708F9777A3F64D66871975BA3C0C1A06E171FF3B4D4BF15653607E02580C64706697FA2829946E9345
answer = BA0D89B51762E3D8C213A8FAC5F41225E360131EB270607F52AD68D156298C9DDC645F7003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100410090887964CEE17E9C053A404F9F241CCF1605B68150C675CB248E4E35D41F82C6ED283660A7482F1DFF41853FB6E570A30666B6350393641A9C87B2EE65D1A13118C083282D631CECC7281D29E94E426BA1AC357CC7732D6AB9DCA77CC93BB6020407F2C78B4B1FE7BB12F45DE24B530F500803B860AC5DA0791CE8F30C60E7F0A15CC5CC48C51FA02AF87E6D240FD70C3A8CD490CE0A4FB2C5F70A99851CFBB1764A9DD1F458A3407B70E457BAD41D21D763F321258D3669479C63638C789C3816D731155C209E87D10A573FE3D061BAA4D7CA7CFFDADC10976498347C7A0230E1708F9777A3F64D66871975BA3C0C1A06E171FF3B4D4BF15653607E02580C64706697FA2829946E9345</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 17 62 E3 D8 C2 13 A8 FA C5 F4 12 25
0010 | E3 60 13 1E B2 70 60 7F 52 AD 68 D1 56 29 8C 9D
0020 | DC 64 5F 70 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 41 00 90 88 79 64 CE E1 7E 9C 05 3A 40 4F 9F 24
0140 | 1C CF 16 05 B6 81 50 C6 75 CB 24 8E 4E 35 D4 1F
0150 | 82 C6 ED 28 36 60 A7 48 2F 1D FF 41 85 3F B6 E5
0160 | 70 A3 06 66 B6 35 03 93 64 1A 9C 87 B2 EE 65 D1
0170 | A1 31 18 C0 83 28 2D 63 1C EC C7 28 1D 29 E9 4E
0180 | 42 6B A1 AC 35 7C C7 73 2D 6A B9 DC A7 7C C9 3B
0190 | B6 02 04 07 F2 C7 8B 4B 1F E7 BB 12 F4 5D E2 4B
01A0 | 53 0F 50 08 03 B8 60 AC 5D A0 79 1C E8 F3 0C 60
01B0 | E7 F0 A1 5C C5 CC 48 C5 1F A0 2A F8 7E 6D 24 0F
01C0 | D7 0C 3A 8C D4 90 CE 0A 4F B2 C5 F7 0A 99 85 1C
01D0 | FB B1 76 4A 9D D1 F4 58 A3 40 7B 70 E4 57 BA D4
01E0 | 1D 21 D7 63 F3 21 25 8D 36 69 47 9C 63 63 8C 78
01F0 | 9C 38 16 D7 31 15 5C 20 9E 87 D1 0A 57 3F E3 D0
0200 | 61 BA A4 D7 CA 7C FF DA DC 10 97 64 98 34 7C 7A
0210 | 02 30 E1 70 8F 97 77 A3 F6 4D 66 87 19 75 BA 3C
0220 | 0C 1A 06 E1 71 FF 3B 4D 4B F1 56 53 60 7E 02 58
0230 | 0C 64 70 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100410090887964CEE17E9C053A</code> <code>404F9F241CCF1605B68150C675CB248E</code> <code>4E35D41F82C6ED283660A7482F1DFF41</code> <code>853FB6E570A30666B6350393641A9C87</code> <code>B2EE65D1A13118C083282D631CECC728</code> <code>1D29E94E426BA1AC357CC7732D6AB9DC</code> <code>A77CC93BB6020407F2C78B4B1FE7BB12</code> <code>F45DE24B530F500803B860AC5DA0791C</code> <code>E8F30C60E7F0A15CC5CC48C51FA02AF8</code> <code>7E6D240FD70C3A8CD490CE0A4FB2C5F7</code> <code>0A99851CFBB1764A9DD1F458A3407B70</code> <code>E457BAD41D21D763F321258D3669479C</code> <code>63638C789C3816D731155C209E87D10A</code> <code>573FE3D061BAA4D7CA7CFFDADC109764</code> <code>98347C7A0230E1708F9777A3F64D6687</code> <code>1975BA3C0C1A06E171FF3B4D4BF15653</code><br> <code>607E0258</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>0C647066</code> (1718641676 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 4798CB6F6A65840C28E623B5CEF94D35A74CB5CBE9EDCDC07F6E8630DE340B31C5A766CD377880FF163D403F74263EECEDFCFB9287D9CE2AED99834DE1B748879AADCB4F9DDDDB1F2E9B14952C3607C787D47E8396817E30C9BD7E1AB67B82343BC9F3C38F0D805ECCAC31002A305594398F7DE51A66AC3AFF1B547F7E7098EB26D17D8F9E9AABD77B98663372A5B5CC182F5754E942BE126A43EE7F6E5F71CD077E40DBA1332869EAC345DC1F368B9BF5A570C936F469580287FB3E82CC81338200BC94BAB88DA41BC565B9B0BA170BC2E99CAE401877D8B8C2E2C68C606AAC4D29DA845F6C3C3E6CB85D299DB4D9BCE26136CE15EEFBB1172064FB84D28AAE</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4DAC03C2027F002773D10312FEB1215DF466B228B1E35F9D714A36CCA17376D03E983B0CBD1A7F7BE5C6643CEBA0933A1BD927143ED737406B0876CEEDC7E3C6E746021EC64DB9BECFBC48022B562437FAF5B4F89252FEB7C5FD9AF05A92FC745CAF17123613352E21D369BB1C39B4177C6E75898E86756E1638096917E7CB33945A6B53A13E6B009BFFD3925791EC4B20EAD489EDDB530F511DC35FB9C3638817728DF7C234F14AFCE39C5912FC6303483CA5344E944AE52336884DE9243A27F6E292304E3E96F98DD7C14DA89C89A7B247CC2E95754FA3B60D87BD6CA8A3B25812CC018C85EAEBBE44E134C4EED6FFC1E7E536D005FF9A68482ECEC853058A</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 17 62 E3 D8 C2 13 A8 FA C5 F4 12 25
0010 | E3 60 13 1E B2 70 60 7F 52 AD 68 D1 56 29 8C 9D
0020 | DC 64 5F 70 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 4D AC 03 C2 02 7F 00 27 73 D1 03 12 FE B1 21 5D
0040 | F4 66 B2 28 B1 E3 5F 9D 71 4A 36 CC A1 73 76 D0
0050 | 3E 98 3B 0C BD 1A 7F 7B E5 C6 64 3C EB A0 93 3A
0060 | 1B D9 27 14 3E D7 37 40 6B 08 76 CE ED C7 E3 C6
0070 | E7 46 02 1E C6 4D B9 BE CF BC 48 02 2B 56 24 37
0080 | FA F5 B4 F8 92 52 FE B7 C5 FD 9A F0 5A 92 FC 74
0090 | 5C AF 17 12 36 13 35 2E 21 D3 69 BB 1C 39 B4 17
00A0 | 7C 6E 75 89 8E 86 75 6E 16 38 09 69 17 E7 CB 33
00B0 | 94 5A 6B 53 A1 3E 6B 00 9B FF D3 92 57 91 EC 4B
00C0 | 20 EA D4 89 ED DB 53 0F 51 1D C3 5F B9 C3 63 88
00D0 | 17 72 8D F7 C2 34 F1 4A FC E3 9C 59 12 FC 63 03
00E0 | 48 3C A5 34 4E 94 4A E5 23 36 88 4D E9 24 3A 27
00F0 | F6 E2 92 30 4E 3E 96 F9 8D D7 C1 4D A8 9C 89 A7
0100 | B2 47 CC 2E 95 75 4F A3 B6 0D 87 BD 6C A8 A3 B2
0110 | 58 12 CC 01 8C 85 EA EB BE 44 E1 34 C4 EE D6 FF
0120 | C1 E7 E5 36 D0 05 FF 9A 68 48 2E CE C8 53 05 8A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004DAC03C2027F002773D10312</code> <code>FEB1215DF466B228B1E35F9D714A36CC</code> <code>A17376D03E983B0CBD1A7F7BE5C6643C</code> <code>EBA0933A1BD927143ED737406B0876CE</code> <code>EDC7E3C6E746021EC64DB9BECFBC4802</code> <code>2B562437FAF5B4F89252FEB7C5FD9AF0</code> <code>5A92FC745CAF17123613352E21D369BB</code> <code>1C39B4177C6E75898E86756E16380969</code> <code>17E7CB33945A6B53A13E6B009BFFD392</code> <code>5791EC4B20EAD489EDDB530F511DC35F</code> <code>B9C3638817728DF7C234F14AFCE39C59</code> <code>12FC6303483CA5344E944AE52336884D</code> <code>E9243A27F6E292304E3E96F98DD7C14D</code> <code>A89C89A7B247CC2E95754FA3B60D87BD</code> <code>6CA8A3B25812CC018C85EAEBBE44E134</code> <code>C4EED6FFC1E7E536D005FF9A68482ECE</code><br> <code>C853058A</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643661762E3D8C213A8FAC5F41225E360131EB270607F52AD68D156298C9DDC645F700000000000000000FE0001004DAC03C2027F002773D10312FEB1215DF466B228B1E35F9D714A36CCA17376D03E983B0CBD1A7F7BE5C6643CEBA0933A1BD927143ED737406B0876CEEDC7E3C6E746021EC64DB9BECFBC48022B562437FAF5B4F89252FEB7C5FD9AF05A92FC745CAF17123613352E21D369BB1C39B4177C6E75898E86756E1638096917E7CB33945A6B53A13E6B009BFFD3925791EC4B20EAD489EDDB530F511DC35FB9C3638817728DF7C234F14AFCE39C5912FC6303483CA5344E944AE52336884DE9243A27F6E292304E3E96F98DD7C14DA89C89A7B247CC2E95754FA3B60D87BD6CA8A3B25812CC018C85EAEBBE44E134C4EED6FFC1E7E536D005FF9A68482ECEC853058A
padding = B428DCF3654A51121F6AD091
tmp_aes_key = B0B3A3AAB2040BDFDACC0ED2FDF2D766E3FAA894B9E3DBE96430E6C2794C9B1D
tmp_aes_iv = 0C4B1363835D9408D10AA3D134F1E30010658955718C19A6FDEA3EC7C250D366</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 85EF8FF898129E4AE01F89B80922CC1EF0C8C0813AFC2DE57F003D98C87AC318FE5825B613A967BA99026BF4AC55C3FCC93E007A451FFFB535C382F5D3A0D0FDBC193ADEABD061194A6C8B498E7AEC3FE3EDAF036E665DD3BFC11FA43FDD45A79C4FDCC11EF5AF9FFA9A149E846DA415195B856B08F0B7CC4EC337D32220C6DA9EBC3B05F5EEBA8685E5AB389079D377AE7F6AFB9E6F82CEB02856065B301EC0E93D4AFA400BB65E66815BCEC15486B5C62DAC9222D4DC60859FF765AF1EAA3397841F3443C41081FA106B5345F5881104ADBC9A87CFCB9DD63E671B8DF63F49B216A5BB1B017BB950555BE235F48080AF90D75C4961D8758752D0FDCBB189649A8BC729DB8D9F76E8B119D84644EFFD034BDD772C7FA7A68617475B8A762358628E9BDDD18D73A4DDA6351559AC91FD375483A06A7E12641ECF5B3A43050E5F05FD1F50E876B7A34008568F7DEF5BD1</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 17 0F 00 0C 64 70 66
0010 | 78 01 00 00 1F 5F 04 F5 17 62 E3 D8 C2 13 A8 FA
0020 | C5 F4 12 25 E3 60 13 1E B2 70 60 7F 52 AD 68 D1
0030 | 56 29 8C 9D DC 64 5F 70 FE 50 01 00 85 EF 8F F8
0040 | 98 12 9E 4A E0 1F 89 B8 09 22 CC 1E F0 C8 C0 81
0050 | 3A FC 2D E5 7F 00 3D 98 C8 7A C3 18 FE 58 25 B6
0060 | 13 A9 67 BA 99 02 6B F4 AC 55 C3 FC C9 3E 00 7A
0070 | 45 1F FF B5 35 C3 82 F5 D3 A0 D0 FD BC 19 3A DE
0080 | AB D0 61 19 4A 6C 8B 49 8E 7A EC 3F E3 ED AF 03
0090 | 6E 66 5D D3 BF C1 1F A4 3F DD 45 A7 9C 4F DC C1
00A0 | 1E F5 AF 9F FA 9A 14 9E 84 6D A4 15 19 5B 85 6B
00B0 | 08 F0 B7 CC 4E C3 37 D3 22 20 C6 DA 9E BC 3B 05
00C0 | F5 EE BA 86 85 E5 AB 38 90 79 D3 77 AE 7F 6A FB
00D0 | 9E 6F 82 CE B0 28 56 06 5B 30 1E C0 E9 3D 4A FA
00E0 | 40 0B B6 5E 66 81 5B CE C1 54 86 B5 C6 2D AC 92
00F0 | 22 D4 DC 60 85 9F F7 65 AF 1E AA 33 97 84 1F 34
0100 | 43 C4 10 81 FA 10 6B 53 45 F5 88 11 04 AD BC 9A
0110 | 87 CF CB 9D D6 3E 67 1B 8D F6 3F 49 B2 16 A5 BB
0120 | 1B 01 7B B9 50 55 5B E2 35 F4 80 80 AF 90 D7 5C
0130 | 49 61 D8 75 87 52 D0 FD CB B1 89 64 9A 8B C7 29
0140 | DB 8D 9F 76 E8 B1 19 D8 46 44 EF FD 03 4B DD 77
0150 | 2C 7F A7 A6 86 17 47 5B 8A 76 23 58 62 8E 9B DD
0160 | D1 8D 73 A4 DD A6 35 15 59 AC 91 FD 37 54 83 A0
0170 | 6A 7E 12 64 1E CF 5B 3A 43 05 0E 5F 05 FD 1F 50
0180 | E8 76 B7 A3 40 08 56 8F 7D EF 5B D1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>78170F000C647066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010085EF8FF898129E4AE01F89B8</code> <code>0922CC1EF0C8C0813AFC2DE57F003D98</code> <code>C87AC318FE5825B613A967BA99026BF4</code> <code>AC55C3FCC93E007A451FFFB535C382F5</code> <code>D3A0D0FDBC193ADEABD061194A6C8B49</code> <code>8E7AEC3FE3EDAF036E665DD3BFC11FA4</code> <code>3FDD45A79C4FDCC11EF5AF9FFA9A149E</code> <code>846DA415195B856B08F0B7CC4EC337D3</code> <code>2220C6DA9EBC3B05F5EEBA8685E5AB38</code> <code>9079D377AE7F6AFB9E6F82CEB0285606</code> <code>5B301EC0E93D4AFA400BB65E66815BCE</code> <code>C15486B5C62DAC9222D4DC60859FF765</code> <code>AF1EAA3397841F3443C41081FA106B53</code> <code>45F5881104ADBC9A87CFCB9DD63E671B</code> <code>8DF63F49B216A5BB1B017BB950555BE2</code> <code>35F48080AF90D75C4961D8758752D0FD</code> <code>CBB189649A8BC729DB8D9F76E8B119D8</code> <code>4644EFFD034BDD772C7FA7A68617475B</code> <code>8A762358628E9BDDD18D73A4DDA63515</code> <code>59AC91FD375483A06A7E12641ECF5B3A</code> <code>43050E5F05FD1F50E876B7A34008568F</code><br> <code>7DEF5BD1</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 8427AB3AF255694313082C5B064784AB927738A5187BC8FC4C5FED395BF3B0B6CAF69630F2338F8CAB3C5D1421054D29FACAE91E3618F9A80026D91B7F4AD916D2D477284CAC9D543572FA534DAA24BC59E4CF0A1361BA1A696E2DAF3FD7974E6000A803B9D70BE51089C1179D6743E23657F05CE361378834C12CD8ED362AE7F77F91932D8FFF15FA8C9170B3BFB664F2BF5D1D95E214DA518B11D4F17A78602143BF3352F33CB66D9E83EC1C1F1EB970F9AF92D7FC37BF5D126216C8B47F5C13D8F69957B850AB6FBD4B3E33E291FC1EBFF00FE8E422A054F7FF6CACBC7CE8605DEC4CACD9143B166CB9904D11AD1EC9246BADECA8D6CF0AEF0A2B809BA7B4</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 CA A5 0C 64 70 66
0010 | 74 00 00 00 34 F7 CB 3B 17 62 E3 D8 C2 13 A8 FA
0020 | C5 F4 12 25 E3 60 13 1E B2 70 60 7F 52 AD 68 D1
0030 | 56 29 8C 9D DC 64 5F 70 28 31 CF ED AB 09 96 CF
0040 | 21 F7 63 44 B0 93 B2 AB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0138CAA50C647066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>74000000</code> (116 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1762E3D8C213A8FAC5F41225E360131E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B270607F52AD68D156298C9DDC645F70</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>2831CFEDAB0996CF21F76344B093B2AB</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

