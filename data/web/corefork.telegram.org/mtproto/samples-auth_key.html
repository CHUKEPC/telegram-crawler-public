<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 6C 01 00 AF 87 B4 66
0010 | 14 00 00 00 F1 8E 7E BE 99 EC CC 0F 6B 19 C1 6F
0020 | DD 4F FC 71 78 87 18 9E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B06C0100AF87B466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A8 FF CC AF 87 B4 66
0010 | 6C 00 00 00 63 24 16 05 99 EC CC 0F 6B 19 C1 6F
0020 | DD 4F FC 71 78 87 18 9E AC 68 B1 64 19 5C 2E FC
0030 | 74 7D D7 3B 71 E2 04 53 08 16 49 06 B8 D4 FD 1B
0040 | BF 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A8FFCCAF87B466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>6C000000</code> (108 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08164906B8D4FD1BBF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1605822133051399103</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1605822133051399103</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1605822133051399103 = 1025649271 * 1565663993</code></p>
<pre><code>p = 1025649271
q = 1565663993</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 49 06 B8 D4 FD 1B BF 00 00 00
0010 | 04 3D 22 2A 77 00 00 00 04 5D 52 22 F9 00 00 00
0020 | 99 EC CC 0F 6B 19 C1 6F DD 4F FC 71 78 87 18 9E
0030 | AC 68 B1 64 19 5C 2E FC 74 7D D7 3B 71 E2 04 53
0040 | F7 C5 B9 A0 ED D3 6C C2 FC B9 A3 D1 E4 E4 4B 2E
0050 | C0 B6 32 CA 3C D6 04 2C A6 E6 19 72 96 A2 7C 31
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08164906B8D4FD1BBF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1605822133051399103</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043D222A77000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1025649271</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045D5222F9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1565663993</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>F7C5B9A0EDD36CC2FCB9A3D1E4E44B2E</code> <code>C0B632CA3CD6042CA6E6197296A27C31</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908164906B8D4FD1BBF000000043D222A77000000045D5222F900000099ECCC0F6B19C16FDD4FFC717887189EAC68B164195C2EFC747DD73B71E20453F7C5B9A0EDD36CC2FCB9A3D1E4E44B2EC0B632CA3CD6042CA6E6197296A27C3102000000
random_padding_bytes = E23B1704D32FCBC16E74965D14350B320D29AB7D4E2122F16AD2D1918AB3ECC21DC7F80AE0B3CCF693BCFF1FD3E4ED32475BF98CE1F2266E02A1E38A8E063E45275FEDE5440761FE23290D9540EB6C29438CFFE901B62EB67B35DE30</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B16201FAAC617C02890E3F2EF4E38AF92BC4098F4C5305670692872400A38855D3420A9C6E43E5CA84A675EFE5E8032432ED760A3293F243CEEB7E15249C0C3DFECC4E62E080F47A304DC7FC6A41260D3D58635754BDD6733EF31C7ABC7AFC37F0D3E911CC307EBFCFF1A2FAE5EECB3B8F8393CAA164C4BB4DF39D287FC2E33D03A91C8BE671CFE4596C52134659FFD1B569EC63F5E51559F13B4A6AD17E1494CD5653FBD85EB7592F7A80246AD0A164979E1A885BEEF08CE018982F39D2AAFC6C6EF52399D9812C5D0804E48877E5FDF4EB5E02D5B7EC19DBA6C5BEBB39EF6D4EE4B9CACF2090A423E4783B8F8437CE4A1E8586379077E58CFAB70FE26D68D4</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 38 F7 07 00 AF 87 B4 66
0010 | 40 01 00 00 BE E4 12 D7 99 EC CC 0F 6B 19 C1 6F
0020 | DD 4F FC 71 78 87 18 9E AC 68 B1 64 19 5C 2E FC
0030 | 74 7D D7 3B 71 E2 04 53 04 3D 22 2A 77 00 00 00
0040 | 04 5D 52 22 F9 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B1 62 01 FA AC 61 7C 02 89 0E 3F 2E
0060 | F4 E3 8A F9 2B C4 09 8F 4C 53 05 67 06 92 87 24
0070 | 00 A3 88 55 D3 42 0A 9C 6E 43 E5 CA 84 A6 75 EF
0080 | E5 E8 03 24 32 ED 76 0A 32 93 F2 43 CE EB 7E 15
0090 | 24 9C 0C 3D FE CC 4E 62 E0 80 F4 7A 30 4D C7 FC
00A0 | 6A 41 26 0D 3D 58 63 57 54 BD D6 73 3E F3 1C 7A
00B0 | BC 7A FC 37 F0 D3 E9 11 CC 30 7E BF CF F1 A2 FA
00C0 | E5 EE CB 3B 8F 83 93 CA A1 64 C4 BB 4D F3 9D 28
00D0 | 7F C2 E3 3D 03 A9 1C 8B E6 71 CF E4 59 6C 52 13
00E0 | 46 59 FF D1 B5 69 EC 63 F5 E5 15 59 F1 3B 4A 6A
00F0 | D1 7E 14 94 CD 56 53 FB D8 5E B7 59 2F 7A 80 24
0100 | 6A D0 A1 64 97 9E 1A 88 5B EE F0 8C E0 18 98 2F
0110 | 39 D2 AA FC 6C 6E F5 23 99 D9 81 2C 5D 08 04 E4
0120 | 88 77 E5 FD F4 EB 5E 02 D5 B7 EC 19 DB A6 C5 BE
0130 | BB 39 EF 6D 4E E4 B9 CA CF 20 90 A4 23 E4 78 3B
0140 | 8F 84 37 CE 4A 1E 85 86 37 90 77 E5 8C FA B7 0F
0150 | E2 6D 68 D4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>38F70700AF87B466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043D222A77000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1025649271</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045D5222F9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1565663993</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B16201FAAC617C02890E3F2E</code> <code>F4E38AF92BC4098F4C53056706928724</code> <code>00A38855D3420A9C6E43E5CA84A675EF</code> <code>E5E8032432ED760A3293F243CEEB7E15</code> <code>249C0C3DFECC4E62E080F47A304DC7FC</code> <code>6A41260D3D58635754BDD6733EF31C7A</code> <code>BC7AFC37F0D3E911CC307EBFCFF1A2FA</code> <code>E5EECB3B8F8393CAA164C4BB4DF39D28</code> <code>7FC2E33D03A91C8BE671CFE4596C5213</code> <code>4659FFD1B569EC63F5E51559F13B4A6A</code> <code>D17E1494CD5653FBD85EB7592F7A8024</code> <code>6AD0A164979E1A885BEEF08CE018982F</code> <code>39D2AAFC6C6EF52399D9812C5D0804E4</code> <code>8877E5FDF4EB5E02D5B7EC19DBA6C5BE</code> <code>BB39EF6D4EE4B9CACF2090A423E4783B</code> <code>8F8437CE4A1E8586379077E58CFAB70F</code><br> <code>E26D68D4</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 3B 9E B0 87 B4 66
0010 | C8 02 00 00 5C 07 E8 D0 99 EC CC 0F 6B 19 C1 6F
0020 | DD 4F FC 71 78 87 18 9E AC 68 B1 64 19 5C 2E FC
0030 | 74 7D D7 3B 71 E2 04 53 FE 50 02 00 62 98 E1 76
0040 | DA E1 BE 81 E1 23 EC BE F2 A1 75 C5 B4 0D 7B F1
0050 | 54 3F FE 88 13 10 23 37 20 B6 9A 46 3E F4 97 6D
0060 | 78 A9 62 08 BD C0 76 13 D9 74 99 B6 C9 20 31 95
0070 | D8 7E 19 5E AE 38 EE 31 A2 D4 83 02 D4 30 9B 0E
0080 | 18 EE 96 19 58 CE 17 1D 34 D2 07 BA AD A5 B7 B5
0090 | F9 3D 13 02 BE 19 E5 F6 4D 8C 2D DC EA E4 72 92
00A0 | 12 49 1A EF 7D 9A A9 EF 5B 55 DE DD 16 08 A7 5B
00B0 | A0 D2 B7 B9 6C 33 AF FF 91 CD 7C 64 16 EE 08 F5
00C0 | F5 4B 07 61 FD DE F5 6A 5C CB 37 24 FB B1 34 6B
00D0 | B4 63 91 ED 90 D7 12 FE 55 B1 6D DF F9 3D 49 BD
00E0 | A3 52 0E CB CA 9E 09 69 C4 F5 D7 97 70 20 DD 08
00F0 | 17 C0 38 6D B0 80 9E 70 18 E0 04 F5 DD 53 A3 10
0100 | C6 38 F4 80 A8 09 AC 17 61 66 96 0C 86 60 86 EB
0110 | 30 5D 41 3C E2 CB 96 A4 4B 9E F1 F7 7C AE C0 88
0120 | 88 E9 D0 82 E5 F4 94 D7 88 09 DE 12 F2 43 88 CA
0130 | F2 E0 FA E1 AC 46 0D 57 E2 1F E5 4D E5 66 D1 79
0140 | 67 4F F1 50 6A 57 B2 54 BD 79 9A 15 63 F8 3C 6D
0150 | 2D CE 53 2F 0D 4B CF 6E 5D 2D 17 B7 F2 27 64 DC
0160 | 4E 23 95 D0 E9 F4 52 12 2B 40 82 F7 CE 60 25 4F
0170 | A8 92 D3 4B CB 86 C5 2F 60 19 46 07 67 29 BE 7E
0180 | FA 98 3A 9B 74 7E AA A6 29 3F 69 78 4A FC DB 17
0190 | 75 31 A5 D3 E7 D4 A2 84 21 90 78 4C 6F FF D7 B9
01A0 | F3 69 D0 B8 34 DE 79 9C 8A FA 31 C8 CF 80 46 F5
01B0 | FE 06 CE 67 C1 A7 34 AF 75 DC 4F F0 B3 33 E1 A2
01C0 | 30 00 C5 D0 7B 45 1F 92 B0 09 67 B4 85 3E 70 44
01D0 | A7 C4 77 C1 82 19 1E 76 E5 7C 2C EB 6E 1D D0 FA
01E0 | 2C F6 DB 82 44 32 CA 77 41 09 C1 36 3C AD 58 E4
01F0 | F0 F9 C6 C4 D0 61 77 93 73 2B C5 F0 B0 9C 9F 8C
0200 | EF 2E 38 BF EB 62 42 21 8C F6 FF 7D 95 C9 01 86
0210 | 5E FA 06 F6 F1 CF 00 28 9A B7 AE 83 BB E7 1A 0C
0220 | 40 A9 77 42 19 1E 5E F1 05 BA 13 35 87 71 E4 CE
0230 | D8 BD EE A9 DC 68 44 BA C6 BE 89 7C 95 C2 09 C6
0240 | 70 CC 38 6B E9 14 8D 41 63 72 28 3F E6 7D C5 70
0250 | 68 62 B8 9E F3 0A 6E 65 62 2A 0B 50 13 BC BA B0
0260 | 6E 67 ED B4 3A 20 23 9D 95 1E 46 9C 5B B0 6F 3D
0270 | 6D 02 36 29 18 12 40 1B 7B F5 12 81 F8 14 92 E7
0280 | 3F DA 2B DC AF F3 3A 82 89 C3 41 57</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E83B9EB087B466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C8020000</code> (712 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002006298E176DAE1BE81E123ECBE</code> <code>F2A175C5B40D7BF1543FFE8813102337</code> <code>20B69A463EF4976D78A96208BDC07613</code> <code>D97499B6C9203195D87E195EAE38EE31</code> <code>A2D48302D4309B0E18EE961958CE171D</code> <code>34D207BAADA5B7B5F93D1302BE19E5F6</code> <code>4D8C2DDCEAE4729212491AEF7D9AA9EF</code> <code>5B55DEDD1608A75BA0D2B7B96C33AFFF</code> <code>91CD7C6416EE08F5F54B0761FDDEF56A</code> <code>5CCB3724FBB1346BB46391ED90D712FE</code> <code>55B16DDFF93D49BDA3520ECBCA9E0969</code> <code>C4F5D7977020DD0817C0386DB0809E70</code> <code>18E004F5DD53A310C638F480A809AC17</code> <code>6166960C866086EB305D413CE2CB96A4</code> <code>4B9EF1F77CAEC08888E9D082E5F494D7</code> <code>8809DE12F24388CAF2E0FAE1AC460D57</code> <code>E21FE54DE566D179674FF1506A57B254</code> <code>BD799A1563F83C6D2DCE532F0D4BCF6E</code> <code>5D2D17B7F22764DC4E2395D0E9F45212</code> <code>2B4082F7CE60254FA892D34BCB86C52F</code> <code>601946076729BE7EFA983A9B747EAAA6</code> <code>293F69784AFCDB177531A5D3E7D4A284</code> <code>2190784C6FFFD7B9F369D0B834DE799C</code> <code>8AFA31C8CF8046F5FE06CE67C1A734AF</code> <code>75DC4FF0B333E1A23000C5D07B451F92</code> <code>B00967B4853E7044A7C477C182191E76</code> <code>E57C2CEB6E1DD0FA2CF6DB824432CA77</code> <code>4109C1363CAD58E4F0F9C6C4D0617793</code> <code>732BC5F0B09C9F8CEF2E38BFEB624221</code> <code>8CF6FF7D95C901865EFA06F6F1CF0028</code> <code>9AB7AE83BBE71A0C40A97742191E5EF1</code> <code>05BA13358771E4CED8BDEEA9DC6844BA</code> <code>C6BE897C95C209C670CC386BE9148D41</code> <code>6372283FE67DC5706862B89EF30A6E65</code> <code>622A0B5013BCBAB06E67EDB43A20239D</code> <code>951E469C5BB06F3D6D0236291812401B</code> <code>7BF51281F81492E73FDA2BDCAFF33A82</code><br> <code>89C34157</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 6298E176DAE1BE81E123ECBEF2A175C5B40D7BF1543FFE881310233720B69A463EF4976D78A96208BDC07613D97499B6C9203195D87E195EAE38EE31A2D48302D4309B0E18EE961958CE171D34D207BAADA5B7B5F93D1302BE19E5F64D8C2DDCEAE4729212491AEF7D9AA9EF5B55DEDD1608A75BA0D2B7B96C33AFFF91CD7C6416EE08F5F54B0761FDDEF56A5CCB3724FBB1346BB46391ED90D712FE55B16DDFF93D49BDA3520ECBCA9E0969C4F5D7977020DD0817C0386DB0809E7018E004F5DD53A310C638F480A809AC176166960C866086EB305D413CE2CB96A44B9EF1F77CAEC08888E9D082E5F494D78809DE12F24388CAF2E0FAE1AC460D57E21FE54DE566D179674FF1506A57B254BD799A1563F83C6D2DCE532F0D4BCF6E5D2D17B7F22764DC4E2395D0E9F452122B4082F7CE60254FA892D34BCB86C52F601946076729BE7EFA983A9B747EAAA6293F69784AFCDB177531A5D3E7D4A2842190784C6FFFD7B9F369D0B834DE799C8AFA31C8CF8046F5FE06CE67C1A734AF75DC4FF0B333E1A23000C5D07B451F92B00967B4853E7044A7C477C182191E76E57C2CEB6E1DD0FA2CF6DB824432CA774109C1363CAD58E4F0F9C6C4D0617793732BC5F0B09C9F8CEF2E38BFEB6242218CF6FF7D95C901865EFA06F6F1CF00289AB7AE83BBE71A0C40A97742191E5EF105BA13358771E4CED8BDEEA9DC6844BAC6BE897C95C209C670CC386BE9148D416372283FE67DC5706862B89EF30A6E65622A0B5013BCBAB06E67EDB43A20239D951E469C5BB06F3D6D0236291812401B7BF51281F81492E73FDA2BDCAFF33A8289C34157
tmp_aes_key = B57216FBF6DAB012F1B4998A01FFE22401270B9925B87167DB7FE54C40CBB7A7
tmp_aes_iv = 0C456240B4813C535B6552A331F66BF653407346266DEC029EA59885F7C5B9A0</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = BA102B9BF0233800932346CD26E3CFEF440FEFD4BA0D89B599ECCC0F6B19C16FDD4FFC717887189EAC68B164195C2EFC747DD73B71E2045303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003EB790B75D1E855DAE0C9A87507EC82ABCE4D43B84836A9158B77E7F14B98E1684D00913A8715C5D876AD60EE1FEB6C6D76B5240B765F193904722B631611900BD5ACCF84AD0FC9066A352FF4CDBC65E64A6A42E1A3865A84FB7DD34E11598043A0039428836711CA2D3A5AC9524A5E5C74FE64118399A949EABD4036B5CAA16807D15EB908F88EE5B80B0CBD460622A23F4B8CAAD924E7A7B98C9C6280C5CA447E00493C2FC5546C09A674F5BFA7402B5AAEA8736BA976F2B24F2169300FC3D5EA50A879E7EF0B89A2C997035392DAD6DF7D8E7F21E9C5928E0ADD571A31077ADFC85DDA17BAD2559656CADE175786D47ED62B50B19D6710409D9AC3319477FB087B466C78D940B1F4C9846
answer = BA0D89B599ECCC0F6B19C16FDD4FFC717887189EAC68B164195C2EFC747DD73B71E2045303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003EB790B75D1E855DAE0C9A87507EC82ABCE4D43B84836A9158B77E7F14B98E1684D00913A8715C5D876AD60EE1FEB6C6D76B5240B765F193904722B631611900BD5ACCF84AD0FC9066A352FF4CDBC65E64A6A42E1A3865A84FB7DD34E11598043A0039428836711CA2D3A5AC9524A5E5C74FE64118399A949EABD4036B5CAA16807D15EB908F88EE5B80B0CBD460622A23F4B8CAAD924E7A7B98C9C6280C5CA447E00493C2FC5546C09A674F5BFA7402B5AAEA8736BA976F2B24F2169300FC3D5EA50A879E7EF0B89A2C997035392DAD6DF7D8E7F21E9C5928E0ADD571A31077ADFC85DDA17BAD2559656CADE175786D47ED62B50B19D6710409D9AC3319477FB087B466C78D940B1F4C9846</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 99 EC CC 0F 6B 19 C1 6F DD 4F FC 71
0010 | 78 87 18 9E AC 68 B1 64 19 5C 2E FC 74 7D D7 3B
0020 | 71 E2 04 53 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 3E B7 90 B7 5D 1E 85 5D AE 0C 9A 87 50 7E C8 2A
0140 | BC E4 D4 3B 84 83 6A 91 58 B7 7E 7F 14 B9 8E 16
0150 | 84 D0 09 13 A8 71 5C 5D 87 6A D6 0E E1 FE B6 C6
0160 | D7 6B 52 40 B7 65 F1 93 90 47 22 B6 31 61 19 00
0170 | BD 5A CC F8 4A D0 FC 90 66 A3 52 FF 4C DB C6 5E
0180 | 64 A6 A4 2E 1A 38 65 A8 4F B7 DD 34 E1 15 98 04
0190 | 3A 00 39 42 88 36 71 1C A2 D3 A5 AC 95 24 A5 E5
01A0 | C7 4F E6 41 18 39 9A 94 9E AB D4 03 6B 5C AA 16
01B0 | 80 7D 15 EB 90 8F 88 EE 5B 80 B0 CB D4 60 62 2A
01C0 | 23 F4 B8 CA AD 92 4E 7A 7B 98 C9 C6 28 0C 5C A4
01D0 | 47 E0 04 93 C2 FC 55 46 C0 9A 67 4F 5B FA 74 02
01E0 | B5 AA EA 87 36 BA 97 6F 2B 24 F2 16 93 00 FC 3D
01F0 | 5E A5 0A 87 9E 7E F0 B8 9A 2C 99 70 35 39 2D AD
0200 | 6D F7 D8 E7 F2 1E 9C 59 28 E0 AD D5 71 A3 10 77
0210 | AD FC 85 DD A1 7B AD 25 59 65 6C AD E1 75 78 6D
0220 | 47 ED 62 B5 0B 19 D6 71 04 09 D9 AC 33 19 47 7F
0230 | B0 87 B4 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001003EB790B75D1E855DAE0C9A87</code> <code>507EC82ABCE4D43B84836A9158B77E7F</code> <code>14B98E1684D00913A8715C5D876AD60E</code> <code>E1FEB6C6D76B5240B765F193904722B6</code> <code>31611900BD5ACCF84AD0FC9066A352FF</code> <code>4CDBC65E64A6A42E1A3865A84FB7DD34</code> <code>E11598043A0039428836711CA2D3A5AC</code> <code>9524A5E5C74FE64118399A949EABD403</code> <code>6B5CAA16807D15EB908F88EE5B80B0CB</code> <code>D460622A23F4B8CAAD924E7A7B98C9C6</code> <code>280C5CA447E00493C2FC5546C09A674F</code> <code>5BFA7402B5AAEA8736BA976F2B24F216</code> <code>9300FC3D5EA50A879E7EF0B89A2C9970</code> <code>35392DAD6DF7D8E7F21E9C5928E0ADD5</code> <code>71A31077ADFC85DDA17BAD2559656CAD</code> <code>E175786D47ED62B50B19D6710409D9AC</code><br> <code>3319477F</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B087B466</code> (1723107248 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = EB10955BE3815A9B4A0190824E516024BC4CB1260A37A0264383E7EE188C119CA4B5768F979D81F6328659B57306E800AF9D5CA4B122D167B4F7D4CBA38B3251F57F873E804B4A83F5531F6ED9D5220DE33C27BCC7FE4642B5BE7DEC47AC9EA4F49C42E1B400BE48A8C700EDF3A925F107BC9FAE32DC5D8DC52AAF6E0BAEE1D999AA1E9257CFA4EF0525BC57F29E3D9CE2149680D410346F865FDE6294D9B08B7375FF4B3236C87CFA03AF897E94568A513FE45F55BA0852E390EAFA46326EA4F3CB05C358BACA1767BB657D885C6E99D4BE2723396366E553DADD67187124C3EDF6824DFC608C69FE818C5F7B35BAAD32BEF1F5707D1EC1508731F8C726037A</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 97F8134E9580C5F6B35503AE99F15F06068FE414F1AD84FC1A8EB94590755AD20BF6B06A30998FF6FAD05C4455E5DF8757F85AB25AB17AF0AEACE4CCC530B1750ED5DF2150D34D4FB0C9B07719E37A7FEF020F3852B9EEFD8CCD96ECA15803EACB21FF7EDFA6C04F10EAEC4C062513119F2CA789ACCD0F77952A1FC8B292D7A0AE6EE4570DFB0F9D9ABEDF829E4145FD11AEFBA573C39329277674C85E5DA3CB36B98ADD317D864AFD84A3DADF27F51C22BD4521C36F00BA9F769EACDBAB9D6812FA03E4134B31BCDA52DBD4882B51DAF4659D891B5BAC0A3879F6E10351CEFB123ED46FB109ADC2D0ADEE31C06ADBEA8844BFAFADF0DB631275D1D82851AF15</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 99 EC CC 0F 6B 19 C1 6F DD 4F FC 71
0010 | 78 87 18 9E AC 68 B1 64 19 5C 2E FC 74 7D D7 3B
0020 | 71 E2 04 53 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 97 F8 13 4E 95 80 C5 F6 B3 55 03 AE 99 F1 5F 06
0040 | 06 8F E4 14 F1 AD 84 FC 1A 8E B9 45 90 75 5A D2
0050 | 0B F6 B0 6A 30 99 8F F6 FA D0 5C 44 55 E5 DF 87
0060 | 57 F8 5A B2 5A B1 7A F0 AE AC E4 CC C5 30 B1 75
0070 | 0E D5 DF 21 50 D3 4D 4F B0 C9 B0 77 19 E3 7A 7F
0080 | EF 02 0F 38 52 B9 EE FD 8C CD 96 EC A1 58 03 EA
0090 | CB 21 FF 7E DF A6 C0 4F 10 EA EC 4C 06 25 13 11
00A0 | 9F 2C A7 89 AC CD 0F 77 95 2A 1F C8 B2 92 D7 A0
00B0 | AE 6E E4 57 0D FB 0F 9D 9A BE DF 82 9E 41 45 FD
00C0 | 11 AE FB A5 73 C3 93 29 27 76 74 C8 5E 5D A3 CB
00D0 | 36 B9 8A DD 31 7D 86 4A FD 84 A3 DA DF 27 F5 1C
00E0 | 22 BD 45 21 C3 6F 00 BA 9F 76 9E AC DB AB 9D 68
00F0 | 12 FA 03 E4 13 4B 31 BC DA 52 DB D4 88 2B 51 DA
0100 | F4 65 9D 89 1B 5B AC 0A 38 79 F6 E1 03 51 CE FB
0110 | 12 3E D4 6F B1 09 AD C2 D0 AD EE 31 C0 6A DB EA
0120 | 88 44 BF AF AD F0 DB 63 12 75 D1 D8 28 51 AF 15</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010097F8134E9580C5F6B35503AE</code> <code>99F15F06068FE414F1AD84FC1A8EB945</code> <code>90755AD20BF6B06A30998FF6FAD05C44</code> <code>55E5DF8757F85AB25AB17AF0AEACE4CC</code> <code>C530B1750ED5DF2150D34D4FB0C9B077</code> <code>19E37A7FEF020F3852B9EEFD8CCD96EC</code> <code>A15803EACB21FF7EDFA6C04F10EAEC4C</code> <code>062513119F2CA789ACCD0F77952A1FC8</code> <code>B292D7A0AE6EE4570DFB0F9D9ABEDF82</code> <code>9E4145FD11AEFBA573C39329277674C8</code> <code>5E5DA3CB36B98ADD317D864AFD84A3DA</code> <code>DF27F51C22BD4521C36F00BA9F769EAC</code> <code>DBAB9D6812FA03E4134B31BCDA52DBD4</code> <code>882B51DAF4659D891B5BAC0A3879F6E1</code> <code>0351CEFB123ED46FB109ADC2D0ADEE31</code> <code>C06ADBEA8844BFAFADF0DB631275D1D8</code><br> <code>2851AF15</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436699ECCC0F6B19C16FDD4FFC717887189EAC68B164195C2EFC747DD73B71E204530000000000000000FE00010097F8134E9580C5F6B35503AE99F15F06068FE414F1AD84FC1A8EB94590755AD20BF6B06A30998FF6FAD05C4455E5DF8757F85AB25AB17AF0AEACE4CCC530B1750ED5DF2150D34D4FB0C9B07719E37A7FEF020F3852B9EEFD8CCD96ECA15803EACB21FF7EDFA6C04F10EAEC4C062513119F2CA789ACCD0F77952A1FC8B292D7A0AE6EE4570DFB0F9D9ABEDF829E4145FD11AEFBA573C39329277674C85E5DA3CB36B98ADD317D864AFD84A3DADF27F51C22BD4521C36F00BA9F769EACDBAB9D6812FA03E4134B31BCDA52DBD4882B51DAF4659D891B5BAC0A3879F6E10351CEFB123ED46FB109ADC2D0ADEE31C06ADBEA8844BFAFADF0DB631275D1D82851AF15
padding = 43C273A1022B254B5DD69898
tmp_aes_key = B57216FBF6DAB012F1B4998A01FFE22401270B9925B87167DB7FE54C40CBB7A7
tmp_aes_iv = 0C456240B4813C535B6552A331F66BF653407346266DEC029EA59885F7C5B9A0</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 2A17055B4CB3149B442D350CC072C58755D0F192D9AFCF916667E5286434ABF6E36338B99D04506460A79C660D8C39833630BED623DB67D716E40B295407A1B7508D7DD8CE0568E491A7277DD22541EE705A3273B909241EF099610282D9D5F38C0EEB1840142088F3186D0DE351F5FF61D0B954980CBB5FF7B2316BD2016D2418D990CED17C2E3142D98B960113A7ABB0B32ABF695968D0283EEC4BEDDA8499E67787396D18C849871DC6231C45FA9363B58FCFE00505D516760BCEDF4229C0E8DFAE8B9395F082CBFBB26C4CD88E1522675F58AEE2B766C8818527CFBF08D7742F968C111F7E0CE49ECC9A147CFC53B01AF4303E0A4C6E1BB32B5065A459893961FB2066D933FC25D8A16D9630E1084F75CA52F4B28334C133A26FCB268A5F9D2D8F35553BB6E5D565C6C0A416D18EB46CB04D4418229EEE37BCB3B06B8BB182610FAA4F57B8B74D10C4BB900C295C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C 5F 0A 00 B1 87 B4 66
0010 | 78 01 00 00 1F 5F 04 F5 99 EC CC 0F 6B 19 C1 6F
0020 | DD 4F FC 71 78 87 18 9E AC 68 B1 64 19 5C 2E FC
0030 | 74 7D D7 3B 71 E2 04 53 FE 50 01 00 2A 17 05 5B
0040 | 4C B3 14 9B 44 2D 35 0C C0 72 C5 87 55 D0 F1 92
0050 | D9 AF CF 91 66 67 E5 28 64 34 AB F6 E3 63 38 B9
0060 | 9D 04 50 64 60 A7 9C 66 0D 8C 39 83 36 30 BE D6
0070 | 23 DB 67 D7 16 E4 0B 29 54 07 A1 B7 50 8D 7D D8
0080 | CE 05 68 E4 91 A7 27 7D D2 25 41 EE 70 5A 32 73
0090 | B9 09 24 1E F0 99 61 02 82 D9 D5 F3 8C 0E EB 18
00A0 | 40 14 20 88 F3 18 6D 0D E3 51 F5 FF 61 D0 B9 54
00B0 | 98 0C BB 5F F7 B2 31 6B D2 01 6D 24 18 D9 90 CE
00C0 | D1 7C 2E 31 42 D9 8B 96 01 13 A7 AB B0 B3 2A BF
00D0 | 69 59 68 D0 28 3E EC 4B ED DA 84 99 E6 77 87 39
00E0 | 6D 18 C8 49 87 1D C6 23 1C 45 FA 93 63 B5 8F CF
00F0 | E0 05 05 D5 16 76 0B CE DF 42 29 C0 E8 DF AE 8B
0100 | 93 95 F0 82 CB FB B2 6C 4C D8 8E 15 22 67 5F 58
0110 | AE E2 B7 66 C8 81 85 27 CF BF 08 D7 74 2F 96 8C
0120 | 11 1F 7E 0C E4 9E CC 9A 14 7C FC 53 B0 1A F4 30
0130 | 3E 0A 4C 6E 1B B3 2B 50 65 A4 59 89 39 61 FB 20
0140 | 66 D9 33 FC 25 D8 A1 6D 96 30 E1 08 4F 75 CA 52
0150 | F4 B2 83 34 C1 33 A2 6F CB 26 8A 5F 9D 2D 8F 35
0160 | 55 3B B6 E5 D5 65 C6 C0 A4 16 D1 8E B4 6C B0 4D
0170 | 44 18 22 9E EE 37 BC B3 B0 6B 8B B1 82 61 0F AA
0180 | 4F 57 B8 B7 4D 10 C4 BB 90 0C 29 5C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6C5F0A00B187B466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001002A17055B4CB3149B442D350C</code> <code>C072C58755D0F192D9AFCF916667E528</code> <code>6434ABF6E36338B99D04506460A79C66</code> <code>0D8C39833630BED623DB67D716E40B29</code> <code>5407A1B7508D7DD8CE0568E491A7277D</code> <code>D22541EE705A3273B909241EF0996102</code> <code>82D9D5F38C0EEB1840142088F3186D0D</code> <code>E351F5FF61D0B954980CBB5FF7B2316B</code> <code>D2016D2418D990CED17C2E3142D98B96</code> <code>0113A7ABB0B32ABF695968D0283EEC4B</code> <code>EDDA8499E67787396D18C849871DC623</code> <code>1C45FA9363B58FCFE00505D516760BCE</code> <code>DF4229C0E8DFAE8B9395F082CBFBB26C</code> <code>4CD88E1522675F58AEE2B766C8818527</code> <code>CFBF08D7742F968C111F7E0CE49ECC9A</code> <code>147CFC53B01AF4303E0A4C6E1BB32B50</code> <code>65A459893961FB2066D933FC25D8A16D</code> <code>9630E1084F75CA52F4B28334C133A26F</code> <code>CB268A5F9D2D8F35553BB6E5D565C6C0</code> <code>A416D18EB46CB04D4418229EEE37BCB3</code> <code>B06B8BB182610FAA4F57B8B74D10C4BB</code><br> <code>900C295C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 758C0E3DB229EBA3721E6B42DECE38FB9413051408102434FFCD50B54670A6D6B1305E4162509339151FE43028254EAA0D5B59755E7B997169F28FBA5A5131F51BCF7F7B3AA2254EEEAED50334A1FAC9DCBB927F1B1FD967C26909A8423E8472C13651A594CF6CF19B367AF0C1EBE7DAEF96834CDFB029DD72CB21D9DB50BC833CD09F7DFDA5A1E4A04B10E73DE9C1B05911668BFE8885A14470BAD146A794145B66E57B5A11B8A12BD4C1197208DC21EA75656148DF23CF4CD2A2564882256AF2ACB1680EB981FE2DDBC6D85711F8AE0E9973857BCDDF9EE8BB6EC3E2EC79366211914D12E51027F0ED1CFA01878BAAA5A518EB87B0C843FDF759AF0608994D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 50 AC 24 B2 87 B4 66
0010 | 84 00 00 00 34 F7 CB 3B 99 EC CC 0F 6B 19 C1 6F
0020 | DD 4F FC 71 78 87 18 9E AC 68 B1 64 19 5C 2E FC
0030 | 74 7D D7 3B 71 E2 04 53 3B 75 62 C1 AA 43 05 11
0040 | CD 97 3D 4A 31 DC 36 E9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0150AC24B287B466</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>84000000</code> (132 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>99ECCC0F6B19C16FDD4FFC717887189E</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>AC68B164195C2EFC747DD73B71E20453</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>3B7562C1AA430511CD973D4A31DC36E9</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

