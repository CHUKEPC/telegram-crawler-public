<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 7C 0C 00 01 B9 AB 66
0010 | 14 00 00 00 F1 8E 7E BE A7 DE B1 F0 60 93 B2 7E
0020 | 6E 98 40 24 9B D3 CC 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B07C0C0001B9AB66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 33 47 01 B9 AB 66
0010 | 6C 00 00 00 63 24 16 05 A7 DE B1 F0 60 93 B2 7E
0020 | 6E 98 40 24 9B D3 CC 00 79 6D 6C 2F 93 79 BD C3
0030 | 3B 8E D0 94 91 64 C4 44 08 20 B3 A6 52 7B D9 8C
0040 | 5F 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0160334701B9AB66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>6C000000</code> (108 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0820B3A6527BD98C5F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2356409903240285279</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2356409903240285279</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2356409903240285279 = 1465403767 * 1608027737</code></p>
<pre><code>p = 1465403767
q = 1608027737</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 B3 A6 52 7B D9 8C 5F 00 00 00
0010 | 04 57 58 49 77 00 00 00 04 5F D8 8E 59 00 00 00
0020 | A7 DE B1 F0 60 93 B2 7E 6E 98 40 24 9B D3 CC 00
0030 | 79 6D 6C 2F 93 79 BD C3 3B 8E D0 94 91 64 C4 44
0040 | 25 02 2B C0 F4 48 36 6E 6A 81 6A 00 37 54 20 C8
0050 | BF 1E 35 EA E6 45 26 9F 0E 96 02 7C 07 CD F5 00
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0820B3A6527BD98C5F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2356409903240285279</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0457584977000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1465403767</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045FD88E59000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1608027737</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>25022BC0F448366E6A816A00375420C8</code> <code>BF1E35EAE645269F0E96027C07CDF500</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90820B3A6527BD98C5F0000000457584977000000045FD88E59000000A7DEB1F06093B27E6E9840249BD3CC00796D6C2F9379BDC33B8ED0949164C44425022BC0F448366E6A816A00375420C8BF1E35EAE645269F0E96027C07CDF50002000000
random_padding_bytes = 370349728C611B3B5FBD135DA242B23A91DB12514EB3D3B0A44C9BF7B71D69CB2F4CA827B64399721E88D8C215AEE2EF3786FA19DF9D380344E1CF81A76B1D0A582D3856938A1D5A3536B7A270A7663FD32B3E568FDA37199612D21C</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 6D6E8A696EF41351D3F75C502BDA372FD264C46B62F6D23B5E56DBCF25FB528D78F0E0A17E4700CA36D9726D7A067B1DD5A6E22B56664B2ECD4F14436421F7F0ABBECB74139CB14FED6105D377714602EFEF632641C78370B917B492EBD5DA7E8F5A0CD8811408ACF0C021B8530DA4E3AABD332EE111BB83384018150DCD76640D6E4C89A316665020AD69B48590F4AAC24425DE2E6678E6DD2246FFCB483B9A30E2ED47BCBAC4E47859D76E8BCE15AE471EB53FC313C7D5BCAD77F013F685D3A5C932D873A268050308D80F4FF6A2AB39CC9B10CB399A4CA9ED6492B868B3475CBB362AAFC6655DE707724C183EC84F057453E38CC5FBE50BFE694A4E1B39B3</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B4 7C 0C 00 01 B9 AB 66
0010 | 40 01 00 00 BE E4 12 D7 A7 DE B1 F0 60 93 B2 7E
0020 | 6E 98 40 24 9B D3 CC 00 79 6D 6C 2F 93 79 BD C3
0030 | 3B 8E D0 94 91 64 C4 44 04 57 58 49 77 00 00 00
0040 | 04 5F D8 8E 59 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 6D 6E 8A 69 6E F4 13 51 D3 F7 5C 50
0060 | 2B DA 37 2F D2 64 C4 6B 62 F6 D2 3B 5E 56 DB CF
0070 | 25 FB 52 8D 78 F0 E0 A1 7E 47 00 CA 36 D9 72 6D
0080 | 7A 06 7B 1D D5 A6 E2 2B 56 66 4B 2E CD 4F 14 43
0090 | 64 21 F7 F0 AB BE CB 74 13 9C B1 4F ED 61 05 D3
00A0 | 77 71 46 02 EF EF 63 26 41 C7 83 70 B9 17 B4 92
00B0 | EB D5 DA 7E 8F 5A 0C D8 81 14 08 AC F0 C0 21 B8
00C0 | 53 0D A4 E3 AA BD 33 2E E1 11 BB 83 38 40 18 15
00D0 | 0D CD 76 64 0D 6E 4C 89 A3 16 66 50 20 AD 69 B4
00E0 | 85 90 F4 AA C2 44 25 DE 2E 66 78 E6 DD 22 46 FF
00F0 | CB 48 3B 9A 30 E2 ED 47 BC BA C4 E4 78 59 D7 6E
0100 | 8B CE 15 AE 47 1E B5 3F C3 13 C7 D5 BC AD 77 F0
0110 | 13 F6 85 D3 A5 C9 32 D8 73 A2 68 05 03 08 D8 0F
0120 | 4F F6 A2 AB 39 CC 9B 10 CB 39 9A 4C A9 ED 64 92
0130 | B8 68 B3 47 5C BB 36 2A AF C6 65 5D E7 07 72 4C
0140 | 18 3E C8 4F 05 74 53 E3 8C C5 FB E5 0B FE 69 4A
0150 | 4E 1B 39 B3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B47C0C0001B9AB66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0457584977000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1465403767</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045FD88E59000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1608027737</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001006D6E8A696EF41351D3F75C50</code> <code>2BDA372FD264C46B62F6D23B5E56DBCF</code> <code>25FB528D78F0E0A17E4700CA36D9726D</code> <code>7A067B1DD5A6E22B56664B2ECD4F1443</code> <code>6421F7F0ABBECB74139CB14FED6105D3</code> <code>77714602EFEF632641C78370B917B492</code> <code>EBD5DA7E8F5A0CD8811408ACF0C021B8</code> <code>530DA4E3AABD332EE111BB8338401815</code> <code>0DCD76640D6E4C89A316665020AD69B4</code> <code>8590F4AAC24425DE2E6678E6DD2246FF</code> <code>CB483B9A30E2ED47BCBAC4E47859D76E</code> <code>8BCE15AE471EB53FC313C7D5BCAD77F0</code> <code>13F685D3A5C932D873A268050308D80F</code> <code>4FF6A2AB39CC9B10CB399A4CA9ED6492</code> <code>B868B3475CBB362AAFC6655DE707724C</code> <code>183EC84F057453E38CC5FBE50BFE694A</code><br> <code>4E1B39B3</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 24 B7 ED 01 B9 AB 66
0010 | E4 02 00 00 5C 07 E8 D0 A7 DE B1 F0 60 93 B2 7E
0020 | 6E 98 40 24 9B D3 CC 00 79 6D 6C 2F 93 79 BD C3
0030 | 3B 8E D0 94 91 64 C4 44 FE 50 02 00 5F A3 62 58
0040 | 28 AD 50 78 AF 38 E5 72 0F 5B 58 76 BB 5B 48 7F
0050 | 5D C9 0E AA 2F 3A 4E DF 98 05 05 B7 CD C6 7C 47
0060 | 28 B6 C0 DB 2A 01 42 7E 15 E4 21 88 10 E2 85 19
0070 | F7 F5 CC 45 AA 78 45 2E B8 EC 1D 9A 79 6A 1B 8A
0080 | F1 1E 40 1B 50 79 B9 2C 91 74 26 06 D3 AE 7F 12
0090 | 1C A1 12 8B 1D A8 17 CD F0 3C 39 F4 68 12 06 C3
00A0 | 93 16 59 D0 60 AA E9 11 A3 B9 88 20 6C D1 B6 42
00B0 | AA A9 9D 1F 91 FD 6B DE EE 83 D2 D7 99 1E 1B 19
00C0 | 04 A6 EE 41 46 04 28 1E 43 02 AF C7 81 9E 74 14
00D0 | EE FF 9E C8 CD D4 29 31 07 34 5D A1 35 10 EE 8B
00E0 | F7 62 35 0F 2B 9B 73 46 90 89 4A A0 8E 3B F7 14
00F0 | 92 77 F9 1D CE 97 D8 B8 4F 1C 68 A4 7B B7 10 40
0100 | 77 E4 B2 B0 44 A0 EF 44 E8 F0 CF 89 CF AA F6 49
0110 | 0C F7 C5 16 50 41 27 43 D0 34 41 FA 15 EE 46 94
0120 | 96 74 74 79 F0 B2 46 CB EE 64 F3 4F 17 8C FA 91
0130 | 50 68 B0 A8 1F BB F1 3B CF 60 6B 08 28 F1 CC CA
0140 | 48 A4 1E 5E 3F FE F8 F1 70 33 F1 3B D1 D3 C2 50
0150 | 26 6C 75 0E DA DF A7 5D DF E4 15 22 67 0C F5 DE
0160 | CD 46 76 6E 99 FC 10 6D 2A 17 1B C3 DA 2A 82 B2
0170 | 4E 1B C4 5D 97 5C 5E EE FE EE 52 33 FD C6 CB 33
0180 | D1 3D DE 33 31 BE 7B AD 6D BB E1 1C 60 38 9C E7
0190 | 76 B2 75 DD 09 89 91 B1 EA EB 7E C7 E2 CB 39 47
01A0 | EB 54 B1 9E 82 0D 78 E0 B6 21 BE A4 61 6C 8A 24
01B0 | F4 7C FA 2F 8F 05 AD 92 E0 73 69 10 7C 80 6D 3B
01C0 | 40 C6 A6 03 1D EC 11 67 BF 16 79 E2 C4 34 85 25
01D0 | E9 6B 88 CC 43 19 AF 4D ED 61 A0 52 E4 2C 3D FE
01E0 | 47 C9 94 6A 8A 37 86 2F 1D B3 CB 0E AE 2F EF 06
01F0 | A1 EF C5 6E 67 5D 27 17 C6 00 02 47 EB 0E 0F 3A
0200 | EF 5F 18 76 66 8D C7 78 3A 63 45 B5 D4 0B 31 0F
0210 | 51 A6 B6 B8 B2 29 BA 7B 02 E3 87 66 CA AC 94 DB
0220 | 50 B9 4C 35 43 53 B7 5C C6 E8 68 37 A5 D6 C2 1A
0230 | 94 36 02 DA 08 7D CF 1E B0 6E 7D A2 B3 E8 B7 8D
0240 | CB 09 3B 9F A4 8E 27 22 C7 A0 45 49 D5 DE 8E F6
0250 | B4 19 FB 58 64 08 73 B3 0D 56 B2 B8 2F F6 59 2A
0260 | A5 57 42 C2 FB 52 FB 58 A7 07 40 87 2D F8 5C FD
0270 | A0 23 D1 65 CD D7 D3 86 24 49 93 EE ED 77 3F 37
0280 | E8 22 3E 8D E0 BA AE 61 5A FB DD F9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0124B7ED01B9AB66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>E4020000</code> (740 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002005FA3625828AD5078AF38E572</code> <code>0F5B5876BB5B487F5DC90EAA2F3A4EDF</code> <code>980505B7CDC67C4728B6C0DB2A01427E</code> <code>15E4218810E28519F7F5CC45AA78452E</code> <code>B8EC1D9A796A1B8AF11E401B5079B92C</code> <code>91742606D3AE7F121CA1128B1DA817CD</code> <code>F03C39F4681206C3931659D060AAE911</code> <code>A3B988206CD1B642AAA99D1F91FD6BDE</code> <code>EE83D2D7991E1B1904A6EE414604281E</code> <code>4302AFC7819E7414EEFF9EC8CDD42931</code> <code>07345DA13510EE8BF762350F2B9B7346</code> <code>90894AA08E3BF7149277F91DCE97D8B8</code> <code>4F1C68A47BB7104077E4B2B044A0EF44</code> <code>E8F0CF89CFAAF6490CF7C51650412743</code> <code>D03441FA15EE469496747479F0B246CB</code> <code>EE64F34F178CFA915068B0A81FBBF13B</code> <code>CF606B0828F1CCCA48A41E5E3FFEF8F1</code> <code>7033F13BD1D3C250266C750EDADFA75D</code> <code>DFE41522670CF5DECD46766E99FC106D</code> <code>2A171BC3DA2A82B24E1BC45D975C5EEE</code> <code>FEEE5233FDC6CB33D13DDE3331BE7BAD</code> <code>6DBBE11C60389CE776B275DD098991B1</code> <code>EAEB7EC7E2CB3947EB54B19E820D78E0</code> <code>B621BEA4616C8A24F47CFA2F8F05AD92</code> <code>E07369107C806D3B40C6A6031DEC1167</code> <code>BF1679E2C4348525E96B88CC4319AF4D</code> <code>ED61A052E42C3DFE47C9946A8A37862F</code> <code>1DB3CB0EAE2FEF06A1EFC56E675D2717</code> <code>C6000247EB0E0F3AEF5F1876668DC778</code> <code>3A6345B5D40B310F51A6B6B8B229BA7B</code> <code>02E38766CAAC94DB50B94C354353B75C</code> <code>C6E86837A5D6C21A943602DA087DCF1E</code> <code>B06E7DA2B3E8B78DCB093B9FA48E2722</code> <code>C7A04549D5DE8EF6B419FB58640873B3</code> <code>0D56B2B82FF6592AA55742C2FB52FB58</code> <code>A70740872DF85CFDA023D165CDD7D386</code> <code>244993EEED773F37E8223E8DE0BAAE61</code><br> <code>5AFBDDF9</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 5FA3625828AD5078AF38E5720F5B5876BB5B487F5DC90EAA2F3A4EDF980505B7CDC67C4728B6C0DB2A01427E15E4218810E28519F7F5CC45AA78452EB8EC1D9A796A1B8AF11E401B5079B92C91742606D3AE7F121CA1128B1DA817CDF03C39F4681206C3931659D060AAE911A3B988206CD1B642AAA99D1F91FD6BDEEE83D2D7991E1B1904A6EE414604281E4302AFC7819E7414EEFF9EC8CDD4293107345DA13510EE8BF762350F2B9B734690894AA08E3BF7149277F91DCE97D8B84F1C68A47BB7104077E4B2B044A0EF44E8F0CF89CFAAF6490CF7C51650412743D03441FA15EE469496747479F0B246CBEE64F34F178CFA915068B0A81FBBF13BCF606B0828F1CCCA48A41E5E3FFEF8F17033F13BD1D3C250266C750EDADFA75DDFE41522670CF5DECD46766E99FC106D2A171BC3DA2A82B24E1BC45D975C5EEEFEEE5233FDC6CB33D13DDE3331BE7BAD6DBBE11C60389CE776B275DD098991B1EAEB7EC7E2CB3947EB54B19E820D78E0B621BEA4616C8A24F47CFA2F8F05AD92E07369107C806D3B40C6A6031DEC1167BF1679E2C4348525E96B88CC4319AF4DED61A052E42C3DFE47C9946A8A37862F1DB3CB0EAE2FEF06A1EFC56E675D2717C6000247EB0E0F3AEF5F1876668DC7783A6345B5D40B310F51A6B6B8B229BA7B02E38766CAAC94DB50B94C354353B75CC6E86837A5D6C21A943602DA087DCF1EB06E7DA2B3E8B78DCB093B9FA48E2722C7A04549D5DE8EF6B419FB58640873B30D56B2B82FF6592AA55742C2FB52FB58A70740872DF85CFDA023D165CDD7D386244993EEED773F37E8223E8DE0BAAE615AFBDDF9
tmp_aes_key = 2C99D95C8A6F7256F976E8EC2DE74F7FA48A1D1BBD2C3CE21040B45A0C9FF10C
tmp_aes_iv = FFC0644F47C406AAFC9F41386ADE90487D82EEB7F2C5DEAD4BC0294D25022BC0</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 04D26F8BD0B19BD24417777A66EBDE32E695833CBA0D89B5A7DEB1F06093B27E6E9840249BD3CC00796D6C2F9379BDC33B8ED0949164C44403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009E576DA4788AF103ED40CB497A595E1858D9001DC1D3A658A13F09E8EC0259B2EB3388C539AA515E95D0DBC4B072C1762ECD34715E10E56B508A85311EDEAA190BD45ED1E35BFCA889DC0BA60FCD9CDCCB029CA821A01DBFFC278A10AFFCC2A9A59AC19FCEB8283CC937D1970D4BD9B643DAE1E028D0582238C59B68BDA5664B52438885AEB23B0FD1558E0BF63C74595A4D128F0C0F6FB6BD0FEB8802E1BC251716A6C8CE9B33766810698FBA0BAAF04B094E502697E1B4B8B903A2F20844D52FA557313C0C24F3AB3A9011606364A432B0B70D688BF72B05D0E4485BC43B7FC4CA7FF74C76D91A653DC45C4CD71E3A1D2551A435E24344460C6CD2E7CC8ABA01B9AB66818DBA9804E2C998
answer = BA0D89B5A7DEB1F06093B27E6E9840249BD3CC00796D6C2F9379BDC33B8ED0949164C44403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009E576DA4788AF103ED40CB497A595E1858D9001DC1D3A658A13F09E8EC0259B2EB3388C539AA515E95D0DBC4B072C1762ECD34715E10E56B508A85311EDEAA190BD45ED1E35BFCA889DC0BA60FCD9CDCCB029CA821A01DBFFC278A10AFFCC2A9A59AC19FCEB8283CC937D1970D4BD9B643DAE1E028D0582238C59B68BDA5664B52438885AEB23B0FD1558E0BF63C74595A4D128F0C0F6FB6BD0FEB8802E1BC251716A6C8CE9B33766810698FBA0BAAF04B094E502697E1B4B8B903A2F20844D52FA557313C0C24F3AB3A9011606364A432B0B70D688BF72B05D0E4485BC43B7FC4CA7FF74C76D91A653DC45C4CD71E3A1D2551A435E24344460C6CD2E7CC8ABA01B9AB66818DBA9804E2C998</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 A7 DE B1 F0 60 93 B2 7E 6E 98 40 24
0010 | 9B D3 CC 00 79 6D 6C 2F 93 79 BD C3 3B 8E D0 94
0020 | 91 64 C4 44 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 9E 57 6D A4 78 8A F1 03 ED 40 CB 49 7A 59 5E 18
0140 | 58 D9 00 1D C1 D3 A6 58 A1 3F 09 E8 EC 02 59 B2
0150 | EB 33 88 C5 39 AA 51 5E 95 D0 DB C4 B0 72 C1 76
0160 | 2E CD 34 71 5E 10 E5 6B 50 8A 85 31 1E DE AA 19
0170 | 0B D4 5E D1 E3 5B FC A8 89 DC 0B A6 0F CD 9C DC
0180 | CB 02 9C A8 21 A0 1D BF FC 27 8A 10 AF FC C2 A9
0190 | A5 9A C1 9F CE B8 28 3C C9 37 D1 97 0D 4B D9 B6
01A0 | 43 DA E1 E0 28 D0 58 22 38 C5 9B 68 BD A5 66 4B
01B0 | 52 43 88 85 AE B2 3B 0F D1 55 8E 0B F6 3C 74 59
01C0 | 5A 4D 12 8F 0C 0F 6F B6 BD 0F EB 88 02 E1 BC 25
01D0 | 17 16 A6 C8 CE 9B 33 76 68 10 69 8F BA 0B AA F0
01E0 | 4B 09 4E 50 26 97 E1 B4 B8 B9 03 A2 F2 08 44 D5
01F0 | 2F A5 57 31 3C 0C 24 F3 AB 3A 90 11 60 63 64 A4
0200 | 32 B0 B7 0D 68 8B F7 2B 05 D0 E4 48 5B C4 3B 7F
0210 | C4 CA 7F F7 4C 76 D9 1A 65 3D C4 5C 4C D7 1E 3A
0220 | 1D 25 51 A4 35 E2 43 44 46 0C 6C D2 E7 CC 8A BA
0230 | 01 B9 AB 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001009E576DA4788AF103ED40CB49</code> <code>7A595E1858D9001DC1D3A658A13F09E8</code> <code>EC0259B2EB3388C539AA515E95D0DBC4</code> <code>B072C1762ECD34715E10E56B508A8531</code> <code>1EDEAA190BD45ED1E35BFCA889DC0BA6</code> <code>0FCD9CDCCB029CA821A01DBFFC278A10</code> <code>AFFCC2A9A59AC19FCEB8283CC937D197</code> <code>0D4BD9B643DAE1E028D0582238C59B68</code> <code>BDA5664B52438885AEB23B0FD1558E0B</code> <code>F63C74595A4D128F0C0F6FB6BD0FEB88</code> <code>02E1BC251716A6C8CE9B33766810698F</code> <code>BA0BAAF04B094E502697E1B4B8B903A2</code> <code>F20844D52FA557313C0C24F3AB3A9011</code> <code>606364A432B0B70D688BF72B05D0E448</code> <code>5BC43B7FC4CA7FF74C76D91A653DC45C</code> <code>4CD71E3A1D2551A435E24344460C6CD2</code><br> <code>E7CC8ABA</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>01B9AB66</code> (1722530049 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 6AB4D768658E8532C19DAF62622423922FBA72EACBC50849C94EB9ADF846ECE963D5FCD4C949934A50EC013776D81E8AD4F89E6CBB1780F3A9D9CE330A5334D2162C68DA5D2EB2802E126EFDE2A130200CD41E9893CD7C562531B047B141013F15579E27437D5838AF42D68FA7DC43EE562366D4EE2F0B800C1C053CA90664438E3608BA18FBBDDF83B0DA7FA347BECBB2E6281AEC730FD6FDB69326854A9C70E13D0C34104A81DC26178155FBB502D82414A7EE8BF8B572E779A7FBE9E44FA2C66684B87438DF426B23FE3342CBE64E86244C07EE7DAAAD3B9E5D4EC1884773C2DFBAB6E565A254F7DE6E9340C7C772B6C0D2CB1F555F59ADC546205D1D7414</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = F4DD39A1882D3797A05F76A66535388FABE5E8767EAA2C1E27A484DE070F49F90278DF4D77345802D7D36230B12687E46D5C8C372D3856FE2FA79819688697187D056321C224CFC48ED308B2F055D8F06A7E6EDE33DD2EF0C86D4D423132440F67A32A263EC794724165E1FF2922B5CA19EBBF9BDA71242FC0A6427D6BB6B62F80EA293B972F889A68C70FD8F8A763D80725516A3FF81513143038DB59E0788E12BF812F9D7235FA1D91DBDE451165E0EF24226922B63D6C9A03AD09209B339816261949917C8CA55E3231A105042DD683A404DB6A271B95A0D61341675F340CAD420DED46BA0089F93CC14CFB6D264A1D16C59D61F98F5ABA5EDC80637753</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 A7 DE B1 F0 60 93 B2 7E 6E 98 40 24
0010 | 9B D3 CC 00 79 6D 6C 2F 93 79 BD C3 3B 8E D0 94
0020 | 91 64 C4 44 00 00 00 00 00 00 00 00 FE FF 00 00
0030 | F4 DD 39 A1 88 2D 37 97 A0 5F 76 A6 65 35 38 8F
0040 | AB E5 E8 76 7E AA 2C 1E 27 A4 84 DE 07 0F 49 F9
0050 | 02 78 DF 4D 77 34 58 02 D7 D3 62 30 B1 26 87 E4
0060 | 6D 5C 8C 37 2D 38 56 FE 2F A7 98 19 68 86 97 18
0070 | 7D 05 63 21 C2 24 CF C4 8E D3 08 B2 F0 55 D8 F0
0080 | 6A 7E 6E DE 33 DD 2E F0 C8 6D 4D 42 31 32 44 0F
0090 | 67 A3 2A 26 3E C7 94 72 41 65 E1 FF 29 22 B5 CA
00A0 | 19 EB BF 9B DA 71 24 2F C0 A6 42 7D 6B B6 B6 2F
00B0 | 80 EA 29 3B 97 2F 88 9A 68 C7 0F D8 F8 A7 63 D8
00C0 | 07 25 51 6A 3F F8 15 13 14 30 38 DB 59 E0 78 8E
00D0 | 12 BF 81 2F 9D 72 35 FA 1D 91 DB DE 45 11 65 E0
00E0 | EF 24 22 69 22 B6 3D 6C 9A 03 AD 09 20 9B 33 98
00F0 | 16 26 19 49 91 7C 8C A5 5E 32 31 A1 05 04 2D D6
0100 | 83 A4 04 DB 6A 27 1B 95 A0 D6 13 41 67 5F 34 0C
0110 | AD 42 0D ED 46 BA 00 89 F9 3C C1 4C FB 6D 26 4A
0120 | 1D 16 C5 9D 61 F9 8F 5A BA 5E DC 80 63 77 53 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FEFF0000F4DD39A1882D3797A05F76A6</code> <code>6535388FABE5E8767EAA2C1E27A484DE</code> <code>070F49F90278DF4D77345802D7D36230</code> <code>B12687E46D5C8C372D3856FE2FA79819</code> <code>688697187D056321C224CFC48ED308B2</code> <code>F055D8F06A7E6EDE33DD2EF0C86D4D42</code> <code>3132440F67A32A263EC794724165E1FF</code> <code>2922B5CA19EBBF9BDA71242FC0A6427D</code> <code>6BB6B62F80EA293B972F889A68C70FD8</code> <code>F8A763D80725516A3FF81513143038DB</code> <code>59E0788E12BF812F9D7235FA1D91DBDE</code> <code>451165E0EF24226922B63D6C9A03AD09</code> <code>209B339816261949917C8CA55E3231A1</code> <code>05042DD683A404DB6A271B95A0D61341</code> <code>675F340CAD420DED46BA0089F93CC14C</code> <code>FB6D264A1D16C59D61F98F5ABA5EDC80</code><br> <code>63775300</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366A7DEB1F06093B27E6E9840249BD3CC00796D6C2F9379BDC33B8ED0949164C4440000000000000000FEFF0000F4DD39A1882D3797A05F76A66535388FABE5E8767EAA2C1E27A484DE070F49F90278DF4D77345802D7D36230B12687E46D5C8C372D3856FE2FA79819688697187D056321C224CFC48ED308B2F055D8F06A7E6EDE33DD2EF0C86D4D423132440F67A32A263EC794724165E1FF2922B5CA19EBBF9BDA71242FC0A6427D6BB6B62F80EA293B972F889A68C70FD8F8A763D80725516A3FF81513143038DB59E0788E12BF812F9D7235FA1D91DBDE451165E0EF24226922B63D6C9A03AD09209B339816261949917C8CA55E3231A105042DD683A404DB6A271B95A0D61341675F340CAD420DED46BA0089F93CC14CFB6D264A1D16C59D61F98F5ABA5EDC8063775300
padding = D484187F9FB4A72524CE5E91
tmp_aes_key = 2C99D95C8A6F7256F976E8EC2DE74F7FA48A1D1BBD2C3CE21040B45A0C9FF10C
tmp_aes_iv = FFC0644F47C406AAFC9F41386ADE90487D82EEB7F2C5DEAD4BC0294D25022BC0</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = E32444EE858E03DD56CCD7DDC77B709FE16A919EA9208BA61BA3B94988932AD5AA7B71912006DE6E76B431BA59B464A0FD31D920E4834DD86A04BE1283187A5E3E740D895534E8FBCA9B388E32DADBF191F2D58F98BD74EAD27171A34700825D7FA1D5E996D8BDBCC791005A4188A6B99EC7F404B2D652D27CD4A27E96E4E81C832777B97679FB3826DB1C88CAF77805382A1B142A0AC983C0E56DCEDC34E894E04E6C7D9A8DCCAB1FF963A6626A930577B778B364F38A8BB21629E6C1DCF8B2D1AE719D5D030264E2BFFBF07310032DADB4DB477E7C953C2C1BFFAAB9DDF368A00BB8DEFCFDF08D277F656A32B08E9510EC7D3D5D34900C6BD0EFE67EF28B062380C6F245F5A6D38537E370FE7E015D0BD259FC972336ADE50E8B415821301A95CDE79A843B50F9A6996F3D54BD7BD33401A99253D188BA21E06B4A4675B657399F06D7AE0BE867590CB69665E3AED5</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B8 7C 0C 00 01 B9 AB 66
0010 | 78 01 00 00 1F 5F 04 F5 A7 DE B1 F0 60 93 B2 7E
0020 | 6E 98 40 24 9B D3 CC 00 79 6D 6C 2F 93 79 BD C3
0030 | 3B 8E D0 94 91 64 C4 44 FE 50 01 00 E3 24 44 EE
0040 | 85 8E 03 DD 56 CC D7 DD C7 7B 70 9F E1 6A 91 9E
0050 | A9 20 8B A6 1B A3 B9 49 88 93 2A D5 AA 7B 71 91
0060 | 20 06 DE 6E 76 B4 31 BA 59 B4 64 A0 FD 31 D9 20
0070 | E4 83 4D D8 6A 04 BE 12 83 18 7A 5E 3E 74 0D 89
0080 | 55 34 E8 FB CA 9B 38 8E 32 DA DB F1 91 F2 D5 8F
0090 | 98 BD 74 EA D2 71 71 A3 47 00 82 5D 7F A1 D5 E9
00A0 | 96 D8 BD BC C7 91 00 5A 41 88 A6 B9 9E C7 F4 04
00B0 | B2 D6 52 D2 7C D4 A2 7E 96 E4 E8 1C 83 27 77 B9
00C0 | 76 79 FB 38 26 DB 1C 88 CA F7 78 05 38 2A 1B 14
00D0 | 2A 0A C9 83 C0 E5 6D CE DC 34 E8 94 E0 4E 6C 7D
00E0 | 9A 8D CC AB 1F F9 63 A6 62 6A 93 05 77 B7 78 B3
00F0 | 64 F3 8A 8B B2 16 29 E6 C1 DC F8 B2 D1 AE 71 9D
0100 | 5D 03 02 64 E2 BF FB F0 73 10 03 2D AD B4 DB 47
0110 | 7E 7C 95 3C 2C 1B FF AA B9 DD F3 68 A0 0B B8 DE
0120 | FC FD F0 8D 27 7F 65 6A 32 B0 8E 95 10 EC 7D 3D
0130 | 5D 34 90 0C 6B D0 EF E6 7E F2 8B 06 23 80 C6 F2
0140 | 45 F5 A6 D3 85 37 E3 70 FE 7E 01 5D 0B D2 59 FC
0150 | 97 23 36 AD E5 0E 8B 41 58 21 30 1A 95 CD E7 9A
0160 | 84 3B 50 F9 A6 99 6F 3D 54 BD 7B D3 34 01 A9 92
0170 | 53 D1 88 BA 21 E0 6B 4A 46 75 B6 57 39 9F 06 D7
0180 | AE 0B E8 67 59 0C B6 96 65 E3 AE D5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B87C0C0001B9AB66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100E32444EE858E03DD56CCD7DD</code> <code>C77B709FE16A919EA9208BA61BA3B949</code> <code>88932AD5AA7B71912006DE6E76B431BA</code> <code>59B464A0FD31D920E4834DD86A04BE12</code> <code>83187A5E3E740D895534E8FBCA9B388E</code> <code>32DADBF191F2D58F98BD74EAD27171A3</code> <code>4700825D7FA1D5E996D8BDBCC791005A</code> <code>4188A6B99EC7F404B2D652D27CD4A27E</code> <code>96E4E81C832777B97679FB3826DB1C88</code> <code>CAF77805382A1B142A0AC983C0E56DCE</code> <code>DC34E894E04E6C7D9A8DCCAB1FF963A6</code> <code>626A930577B778B364F38A8BB21629E6</code> <code>C1DCF8B2D1AE719D5D030264E2BFFBF0</code> <code>7310032DADB4DB477E7C953C2C1BFFAA</code> <code>B9DDF368A00BB8DEFCFDF08D277F656A</code> <code>32B08E9510EC7D3D5D34900C6BD0EFE6</code> <code>7EF28B062380C6F245F5A6D38537E370</code> <code>FE7E015D0BD259FC972336ADE50E8B41</code> <code>5821301A95CDE79A843B50F9A6996F3D</code> <code>54BD7BD33401A99253D188BA21E06B4A</code> <code>4675B657399F06D7AE0BE867590CB696</code><br> <code>65E3AED5</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 76E9AEB229641A756F4CC3F012011621DD75CD92DDCDEF6532030F476E6C704524E40BB9B3DD8699099525F3292B47C688060F027097CE6C31A41FF02F68ADB1A76713F34D5C01A713FAD782E1789B6F27D0C577257DE3100BE9104A8E7E3FFB6EAA06BDD4594463151D5D2F87D044DCED14A1DA9A0603903726698A34ABBB5EA5053DE2AAC42D1F81A4432063B424821053A8CFF6E55290D9C2DA18FD0393FDB20147FDA2F52346C17EDF64499ABB0FB7B6BF0AC4B5BB99A4E4F5C53429C5756A6177674B884F99054B34FC7957E187D05C76B1096080ADB4B018A4A310FF150C5976E6C2EF062B660A5745A47E6B08A16BF88D207439EFFE9B3B89C2F15E71</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C 7B 95 02 B9 AB 66
0010 | AC 00 00 00 34 F7 CB 3B A7 DE B1 F0 60 93 B2 7E
0020 | 6E 98 40 24 9B D3 CC 00 79 6D 6C 2F 93 79 BD C3
0030 | 3B 8E D0 94 91 64 C4 44 73 0B AF C8 1C 16 7E D8
0040 | 51 2D 2F 4A 89 E2 53 F4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017C7B9502B9AB66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>AC000000</code> (172 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A7DEB1F06093B27E6E9840249BD3CC00</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>796D6C2F9379BDC33B8ED0949164C444</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>730BAFC81C167ED8512D2F4A89E253F4</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

