<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 00 5D 09 00 B0 2B AD 66
0010 | 14 00 00 00 F1 8E 7E BE 82 91 BF CD 2A 9A 38 CE
0020 | F5 EB EE 6C AD 60 F4 63</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>005D0900B02BAD66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 0C 41 22 B0 2B AD 66
0010 | 80 00 00 00 63 24 16 05 82 91 BF CD 2A 9A 38 CE
0020 | F5 EB EE 6C AD 60 F4 63 A1 EE AF 50 0B C3 0D 41
0030 | 09 77 56 B4 2D 34 DE 4D 08 1D 84 81 1A 9E 2F 59
0040 | F3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>010C4122B02BAD66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>80000000</code> (128 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081D84811A9E2F59F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2126966875348752883</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2126966875348752883</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2126966875348752883 = 1142860457 * 1861090619</code></p>
<pre><code>p = 1142860457
q = 1861090619</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1D 84 81 1A 9E 2F 59 F3 00 00 00
0010 | 04 44 1E AA A9 00 00 00 04 6E ED FD 3B 00 00 00
0020 | 82 91 BF CD 2A 9A 38 CE F5 EB EE 6C AD 60 F4 63
0030 | A1 EE AF 50 0B C3 0D 41 09 77 56 B4 2D 34 DE 4D
0040 | E0 FD 6F AF 1B 19 C2 06 30 2B F3 8B A4 6A AD 96
0050 | FE 2E AC BC 62 11 8E FE 9A D9 1D BC 9B 5D 35 96
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081D84811A9E2F59F3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2126966875348752883</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04441EAAA9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1142860457</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046EEDFD3B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1861090619</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>E0FD6FAF1B19C206302BF38BA46AAD96</code> <code>FE2EACBC62118EFE9AD91DBC9B5D3596</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081D84811A9E2F59F300000004441EAAA9000000046EEDFD3B0000008291BFCD2A9A38CEF5EBEE6CAD60F463A1EEAF500BC30D41097756B42D34DE4DE0FD6FAF1B19C206302BF38BA46AAD96FE2EACBC62118EFE9AD91DBC9B5D359602000000
random_padding_bytes = DAB834055781E41EA6A1AB7A455298F68CD372DB39D83DD17D29D8B9095DEED7F588C302C0E95EE57F2FFE72A78149DE28B6B39D22C9ACC112302ADCF7CA01774C6922018F5CE769A351682F66908202298FC3A0710BDD69C7AF1FA5</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 5C1D9E4E77F14C499F888FB25DD6AF577825AEE3A5F72615BF629FC52625FA8E0C01CEC78586D42FD6FA0995F506E2EE380CA35D4900D16716BA17667B3AFF9B829EBF3A238CC925A67384F8A0526390F57EDC9B56AA0705F7BB44C7900B3AF4D5F7F12B15FDD6EE91122C388B1294B8ECC2B1E7C34DBB2607BE6B8BD002A3E73ED6FC0128255E92E2EC9245764E8C5B55416E715BF0BAD2F8A926EAD0D90ECD64DA6BF1C3905ED158E66BE3FF5E0FE0ADE8F8B403C285300B2D686D4E6C70375EF2E14E74365CF952862E0F88004FB70CBCDC45E96FE03423AF921C11BB7893D4E3362A29561D84D752ABCA7A2CE3C7DBB8E01826821A512D6A2EA24F05C6E3</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 0C 68 0E 00 B0 2B AD 66
0010 | 40 01 00 00 BE E4 12 D7 82 91 BF CD 2A 9A 38 CE
0020 | F5 EB EE 6C AD 60 F4 63 A1 EE AF 50 0B C3 0D 41
0030 | 09 77 56 B4 2D 34 DE 4D 04 44 1E AA A9 00 00 00
0040 | 04 6E ED FD 3B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 5C 1D 9E 4E 77 F1 4C 49 9F 88 8F B2
0060 | 5D D6 AF 57 78 25 AE E3 A5 F7 26 15 BF 62 9F C5
0070 | 26 25 FA 8E 0C 01 CE C7 85 86 D4 2F D6 FA 09 95
0080 | F5 06 E2 EE 38 0C A3 5D 49 00 D1 67 16 BA 17 66
0090 | 7B 3A FF 9B 82 9E BF 3A 23 8C C9 25 A6 73 84 F8
00A0 | A0 52 63 90 F5 7E DC 9B 56 AA 07 05 F7 BB 44 C7
00B0 | 90 0B 3A F4 D5 F7 F1 2B 15 FD D6 EE 91 12 2C 38
00C0 | 8B 12 94 B8 EC C2 B1 E7 C3 4D BB 26 07 BE 6B 8B
00D0 | D0 02 A3 E7 3E D6 FC 01 28 25 5E 92 E2 EC 92 45
00E0 | 76 4E 8C 5B 55 41 6E 71 5B F0 BA D2 F8 A9 26 EA
00F0 | D0 D9 0E CD 64 DA 6B F1 C3 90 5E D1 58 E6 6B E3
0100 | FF 5E 0F E0 AD E8 F8 B4 03 C2 85 30 0B 2D 68 6D
0110 | 4E 6C 70 37 5E F2 E1 4E 74 36 5C F9 52 86 2E 0F
0120 | 88 00 4F B7 0C BC DC 45 E9 6F E0 34 23 AF 92 1C
0130 | 11 BB 78 93 D4 E3 36 2A 29 56 1D 84 D7 52 AB CA
0140 | 7A 2C E3 C7 DB B8 E0 18 26 82 1A 51 2D 6A 2E A2
0150 | 4F 05 C6 E3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0C680E00B02BAD66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04441EAAA9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1142860457</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046EEDFD3B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1861090619</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001005C1D9E4E77F14C499F888FB2</code> <code>5DD6AF577825AEE3A5F72615BF629FC5</code> <code>2625FA8E0C01CEC78586D42FD6FA0995</code> <code>F506E2EE380CA35D4900D16716BA1766</code> <code>7B3AFF9B829EBF3A238CC925A67384F8</code> <code>A0526390F57EDC9B56AA0705F7BB44C7</code> <code>900B3AF4D5F7F12B15FDD6EE91122C38</code> <code>8B1294B8ECC2B1E7C34DBB2607BE6B8B</code> <code>D002A3E73ED6FC0128255E92E2EC9245</code> <code>764E8C5B55416E715BF0BAD2F8A926EA</code> <code>D0D90ECD64DA6BF1C3905ED158E66BE3</code> <code>FF5E0FE0ADE8F8B403C285300B2D686D</code> <code>4E6C70375EF2E14E74365CF952862E0F</code> <code>88004FB70CBCDC45E96FE03423AF921C</code> <code>11BB7893D4E3362A29561D84D752ABCA</code> <code>7A2CE3C7DBB8E01826821A512D6A2EA2</code><br> <code>4F05C6E3</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D0 45 F2 B0 2B AD 66
0010 | 78 02 00 00 5C 07 E8 D0 82 91 BF CD 2A 9A 38 CE
0020 | F5 EB EE 6C AD 60 F4 63 A1 EE AF 50 0B C3 0D 41
0030 | 09 77 56 B4 2D 34 DE 4D FE 50 02 00 89 0C 30 D8
0040 | 26 06 8A 80 A7 19 07 E4 5D 17 3E 47 57 0B 28 ED
0050 | 48 8D D0 EB C2 10 39 2D 79 99 D1 8D 11 10 DB 65
0060 | 00 41 9B 5B B5 8A 11 D0 63 11 22 99 E8 7E C0 E4
0070 | 49 7F C6 13 9D 55 CB 4E 59 8E 1C 92 FB 77 DA 96
0080 | 61 5C 22 34 47 5B E3 61 5D 9E 79 82 6E AE E4 85
0090 | DD 2D 30 22 18 68 66 8E 9B A9 D6 62 19 30 DF 0E
00A0 | A2 D4 44 F4 B2 00 75 58 67 EC 82 98 F4 86 67 97
00B0 | 77 BA 82 5C 0A 01 97 60 BD CD 28 FF 79 E7 C9 A4
00C0 | D3 70 26 BE BD A0 9D F0 D6 EF B0 AA FC 70 C7 D0
00D0 | A7 2F A5 FA A0 72 EA BB EE 22 6C FA 81 E4 14 F5
00E0 | E1 4B 18 99 50 71 A9 0B 4B AD 6C 85 51 AB AF 69
00F0 | F6 70 19 8D 29 01 49 FF 98 E3 CC D0 6A 8E 22 33
0100 | 91 82 D0 42 DE CA FB 01 1F 43 44 21 36 3F 63 AC
0110 | DB 41 A8 0F 05 EB DE 43 F5 19 50 7D 0E 7B 05 B1
0120 | E6 CA 23 75 9F 62 BC E5 1E B0 B4 FD 7A 75 C9 AA
0130 | A8 36 C0 31 1A C1 90 64 BF 5B E6 CE 41 2E E1 82
0140 | C3 41 3E C6 F7 5C 57 84 7E 1B 55 9F 6B 9C 1A 0A
0150 | 86 03 A4 13 FC CD 45 37 F1 D1 41 DB 99 69 47 AD
0160 | C2 E4 49 A2 E7 FD BB A5 56 9C D3 07 FD 3C 3F 6C
0170 | 34 B5 9B CC C0 D4 0E F1 29 B9 B7 FF AE 60 B5 A4
0180 | 32 FD BF 66 A7 47 D6 18 A9 A1 3D 31 4C B9 5A 5A
0190 | BE 53 3D 60 26 BF 92 C0 93 8D C3 DB E7 B0 71 3E
01A0 | 09 BE 93 85 44 EA CC 85 D3 3D 39 CD 8F 2F C4 FA
01B0 | FB 52 D0 D0 75 6E 36 6E 35 4D C3 F0 4D EB 6D 69
01C0 | 50 60 10 0E B4 BC F6 6A 04 92 11 A7 3D AC 4E 2E
01D0 | 94 E9 75 19 CA 0E 7A 78 F7 1C 49 E8 04 6E 64 80
01E0 | 44 CA 50 C9 3F 2F FB 12 32 A2 7B FB D7 D3 BB 3A
01F0 | 4B 20 08 88 E1 1A 68 0A A9 B6 3F CB 79 D7 9A 5E
0200 | 78 EF DA 6F 95 FF 0C A9 63 A2 3C B3 41 F0 47 34
0210 | 2A 0D 8A B4 E3 EB 51 E8 17 1F DD 3D 8A B0 56 C2
0220 | BE A4 54 E3 60 AE F3 D2 12 72 4F 34 A1 E9 2F 4C
0230 | 77 27 D3 54 F8 8F 6B 2F 13 A1 A8 61 29 F3 08 2C
0240 | 9E C2 24 2C 67 57 9B 71 33 56 77 7A 7E EE 19 C7
0250 | 52 34 CD 26 47 C8 B8 F0 50 35 CA F4 07 99 22 C0
0260 | 4C 1C D4 0B 73 1D 40 87 57 86 27 CE 44 EC 04 67
0270 | 06 91 9E 6B 38 4F 8A D9 B5 9E D5 89 A2 51 2B A5
0280 | 75 26 B6 DE EA B5 B9 FA 4F 63 52 11</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D045F2B02BAD66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200890C30D826068A80A71907E4</code> <code>5D173E47570B28ED488DD0EBC210392D</code> <code>7999D18D1110DB6500419B5BB58A11D0</code> <code>63112299E87EC0E4497FC6139D55CB4E</code> <code>598E1C92FB77DA96615C2234475BE361</code> <code>5D9E79826EAEE485DD2D30221868668E</code> <code>9BA9D6621930DF0EA2D444F4B2007558</code> <code>67EC8298F486679777BA825C0A019760</code> <code>BDCD28FF79E7C9A4D37026BEBDA09DF0</code> <code>D6EFB0AAFC70C7D0A72FA5FAA072EABB</code> <code>EE226CFA81E414F5E14B18995071A90B</code> <code>4BAD6C8551ABAF69F670198D290149FF</code> <code>98E3CCD06A8E22339182D042DECAFB01</code> <code>1F434421363F63ACDB41A80F05EBDE43</code> <code>F519507D0E7B05B1E6CA23759F62BCE5</code> <code>1EB0B4FD7A75C9AAA836C0311AC19064</code> <code>BF5BE6CE412EE182C3413EC6F75C5784</code> <code>7E1B559F6B9C1A0A8603A413FCCD4537</code> <code>F1D141DB996947ADC2E449A2E7FDBBA5</code> <code>569CD307FD3C3F6C34B59BCCC0D40EF1</code> <code>29B9B7FFAE60B5A432FDBF66A747D618</code> <code>A9A13D314CB95A5ABE533D6026BF92C0</code> <code>938DC3DBE7B0713E09BE938544EACC85</code> <code>D33D39CD8F2FC4FAFB52D0D0756E366E</code> <code>354DC3F04DEB6D695060100EB4BCF66A</code> <code>049211A73DAC4E2E94E97519CA0E7A78</code> <code>F71C49E8046E648044CA50C93F2FFB12</code> <code>32A27BFBD7D3BB3A4B200888E11A680A</code> <code>A9B63FCB79D79A5E78EFDA6F95FF0CA9</code> <code>63A23CB341F047342A0D8AB4E3EB51E8</code> <code>171FDD3D8AB056C2BEA454E360AEF3D2</code> <code>12724F34A1E92F4C7727D354F88F6B2F</code> <code>13A1A86129F3082C9EC2242C67579B71</code> <code>3356777A7EEE19C75234CD2647C8B8F0</code> <code>5035CAF4079922C04C1CD40B731D4087</code> <code>578627CE44EC046706919E6B384F8AD9</code> <code>B59ED589A2512BA57526B6DEEAB5B9FA</code><br> <code>4F635211</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 890C30D826068A80A71907E45D173E47570B28ED488DD0EBC210392D7999D18D1110DB6500419B5BB58A11D063112299E87EC0E4497FC6139D55CB4E598E1C92FB77DA96615C2234475BE3615D9E79826EAEE485DD2D30221868668E9BA9D6621930DF0EA2D444F4B200755867EC8298F486679777BA825C0A019760BDCD28FF79E7C9A4D37026BEBDA09DF0D6EFB0AAFC70C7D0A72FA5FAA072EABBEE226CFA81E414F5E14B18995071A90B4BAD6C8551ABAF69F670198D290149FF98E3CCD06A8E22339182D042DECAFB011F434421363F63ACDB41A80F05EBDE43F519507D0E7B05B1E6CA23759F62BCE51EB0B4FD7A75C9AAA836C0311AC19064BF5BE6CE412EE182C3413EC6F75C57847E1B559F6B9C1A0A8603A413FCCD4537F1D141DB996947ADC2E449A2E7FDBBA5569CD307FD3C3F6C34B59BCCC0D40EF129B9B7FFAE60B5A432FDBF66A747D618A9A13D314CB95A5ABE533D6026BF92C0938DC3DBE7B0713E09BE938544EACC85D33D39CD8F2FC4FAFB52D0D0756E366E354DC3F04DEB6D695060100EB4BCF66A049211A73DAC4E2E94E97519CA0E7A78F71C49E8046E648044CA50C93F2FFB1232A27BFBD7D3BB3A4B200888E11A680AA9B63FCB79D79A5E78EFDA6F95FF0CA963A23CB341F047342A0D8AB4E3EB51E8171FDD3D8AB056C2BEA454E360AEF3D212724F34A1E92F4C7727D354F88F6B2F13A1A86129F3082C9EC2242C67579B713356777A7EEE19C75234CD2647C8B8F05035CAF4079922C04C1CD40B731D4087578627CE44EC046706919E6B384F8AD9B59ED589A2512BA57526B6DEEAB5B9FA4F635211
tmp_aes_key = 6D848880E69F68B2DCF8956FADABFA6670B22AD2FA517E2DE6D304C85C9037E7
tmp_aes_iv = F53CBAADFD57CD5DA787712E20BFAA9A7EE079C06825E4DE074FAAD1E0FD6FAF</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1549CE96572BA03A35EF560F6EC58EC2D9851823BA0D89B58291BFCD2A9A38CEF5EBEE6CAD60F463A1EEAF500BC30D41097756B42D34DE4D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000A9322F43BC15A8C0AF7F41311899555F92420BA08DA07B79E3E9DCD12C19A700D60D5DCA48260651A90F586D49E5BED116CCEA6EF35412F6EE5E9DC9DE04235851A3D997B093803B12BB68AE0C36A9DD7B73AE3061B02B42B999613E178BBA7E7920700F6FF8AA1BEC34D2A6AFCA1242A2661DEB61D2EA15A4A9C4738E494D22627C4BCEE44E9D344C9E48E600D1387FDA1699F4A0FF1D7D3D18F60131101F3B9C41B0C91EC1D3D7A28E25CDBEBDEB274539996171F0C8D0B117C65F5E6AF799B772EFE062AA3EEA195B5B4663570C83B26AD596020ED27C85AA31EC1EE3AC0A11FBEA062E044A386D6D82009BE96504DAE4354529DAB9794D514BCC5CBD801B02BAD6683C513BE6E3A9F89
answer = BA0D89B58291BFCD2A9A38CEF5EBEE6CAD60F463A1EEAF500BC30D41097756B42D34DE4D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000A9322F43BC15A8C0AF7F41311899555F92420BA08DA07B79E3E9DCD12C19A700D60D5DCA48260651A90F586D49E5BED116CCEA6EF35412F6EE5E9DC9DE04235851A3D997B093803B12BB68AE0C36A9DD7B73AE3061B02B42B999613E178BBA7E7920700F6FF8AA1BEC34D2A6AFCA1242A2661DEB61D2EA15A4A9C4738E494D22627C4BCEE44E9D344C9E48E600D1387FDA1699F4A0FF1D7D3D18F60131101F3B9C41B0C91EC1D3D7A28E25CDBEBDEB274539996171F0C8D0B117C65F5E6AF799B772EFE062AA3EEA195B5B4663570C83B26AD596020ED27C85AA31EC1EE3AC0A11FBEA062E044A386D6D82009BE96504DAE4354529DAB9794D514BCC5CBD801B02BAD6683C513BE6E3A9F89</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 82 91 BF CD 2A 9A 38 CE F5 EB EE 6C
0010 | AD 60 F4 63 A1 EE AF 50 0B C3 0D 41 09 77 56 B4
0020 | 2D 34 DE 4D 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 0A 93 22 F4 3B C1 5A 8C 0A F7 F4 13 11 89 95 55
0140 | F9 24 20 BA 08 DA 07 B7 9E 3E 9D CD 12 C1 9A 70
0150 | 0D 60 D5 DC A4 82 60 65 1A 90 F5 86 D4 9E 5B ED
0160 | 11 6C CE A6 EF 35 41 2F 6E E5 E9 DC 9D E0 42 35
0170 | 85 1A 3D 99 7B 09 38 03 B1 2B B6 8A E0 C3 6A 9D
0180 | D7 B7 3A E3 06 1B 02 B4 2B 99 96 13 E1 78 BB A7
0190 | E7 92 07 00 F6 FF 8A A1 BE C3 4D 2A 6A FC A1 24
01A0 | 2A 26 61 DE B6 1D 2E A1 5A 4A 9C 47 38 E4 94 D2
01B0 | 26 27 C4 BC EE 44 E9 D3 44 C9 E4 8E 60 0D 13 87
01C0 | FD A1 69 9F 4A 0F F1 D7 D3 D1 8F 60 13 11 01 F3
01D0 | B9 C4 1B 0C 91 EC 1D 3D 7A 28 E2 5C DB EB DE B2
01E0 | 74 53 99 96 17 1F 0C 8D 0B 11 7C 65 F5 E6 AF 79
01F0 | 9B 77 2E FE 06 2A A3 EE A1 95 B5 B4 66 35 70 C8
0200 | 3B 26 AD 59 60 20 ED 27 C8 5A A3 1E C1 EE 3A C0
0210 | A1 1F BE A0 62 E0 44 A3 86 D6 D8 20 09 BE 96 50
0220 | 4D AE 43 54 52 9D AB 97 94 D5 14 BC C5 CB D8 01
0230 | B0 2B AD 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001000A9322F43BC15A8C0AF7F413</code> <code>11899555F92420BA08DA07B79E3E9DCD</code> <code>12C19A700D60D5DCA48260651A90F586</code> <code>D49E5BED116CCEA6EF35412F6EE5E9DC</code> <code>9DE04235851A3D997B093803B12BB68A</code> <code>E0C36A9DD7B73AE3061B02B42B999613</code> <code>E178BBA7E7920700F6FF8AA1BEC34D2A</code> <code>6AFCA1242A2661DEB61D2EA15A4A9C47</code> <code>38E494D22627C4BCEE44E9D344C9E48E</code> <code>600D1387FDA1699F4A0FF1D7D3D18F60</code> <code>131101F3B9C41B0C91EC1D3D7A28E25C</code> <code>DBEBDEB274539996171F0C8D0B117C65</code> <code>F5E6AF799B772EFE062AA3EEA195B5B4</code> <code>663570C83B26AD596020ED27C85AA31E</code> <code>C1EE3AC0A11FBEA062E044A386D6D820</code> <code>09BE96504DAE4354529DAB9794D514BC</code><br> <code>C5CBD801</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B02BAD66</code> (1722624944 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = ECC62DE6CA382AA921460B5A4D2392808E7FCDB0CAA212113D10E3882BCAE0B6F259E3D7E2F406694590CA60C472240702F2B40F0A09A51843367F6CECCB4F4815B3F90011915FF9267116BAD195860FCAF6E4B27A20E196C95FED261E4D6C0B40FF15D4318E5710357DD9EAB8C3683C0134BE9C415B83518EA585DEDABE89AD7C0EBC39E28432E4954C42B69EBEAF1919F3A203A5E7184605D91D95D07A92792E1201DCAB3F0882CC4285D6185D515A90F39C9B54CCB847263B772F71594DC852F41CE9FF3C9CA0A8C4BF54336A946F0CCE02BB8BC33EE10F85610A4954F1F8452B704F3BB11C83C3E53AB52185B22BD01E6EC98FE77E8FC770CA82A79E98F3</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = A5562D78CDE79D9C8BFB9732B939B00A7F5783C7653775BF92CA7376A4ED7E445A48EC4DB8DBE741FE02A8A3E5577990A668B80DE7066D6BA7AE53C1FA9C71331A22AF5F9837A9D1555CF55FA5AC245F0AE3CEDDB86F6795743BEA444A8242FC7D62E777AF350F55F9A03A6610BD302FA9B52EC2700EE1814501C15BBCFD8105F54E48835BE72D099010069ECD40193519D1D43705A52B55D4E4E1ADE192746A817FCCAA4462017E4EA9377B23ECDC4513C5E8E622EBCC601F64B903036EEF680ADC7BE8B530EE514B7D1F55AA7531AE849E0AA178B1D0F56C2C20FD4DA92E830150FBE272714F73788208832BDB0DA4AEC617C3170EAE75BD9CFB7592E594E6</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 82 91 BF CD 2A 9A 38 CE F5 EB EE 6C
0010 | AD 60 F4 63 A1 EE AF 50 0B C3 0D 41 09 77 56 B4
0020 | 2D 34 DE 4D 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | A5 56 2D 78 CD E7 9D 9C 8B FB 97 32 B9 39 B0 0A
0040 | 7F 57 83 C7 65 37 75 BF 92 CA 73 76 A4 ED 7E 44
0050 | 5A 48 EC 4D B8 DB E7 41 FE 02 A8 A3 E5 57 79 90
0060 | A6 68 B8 0D E7 06 6D 6B A7 AE 53 C1 FA 9C 71 33
0070 | 1A 22 AF 5F 98 37 A9 D1 55 5C F5 5F A5 AC 24 5F
0080 | 0A E3 CE DD B8 6F 67 95 74 3B EA 44 4A 82 42 FC
0090 | 7D 62 E7 77 AF 35 0F 55 F9 A0 3A 66 10 BD 30 2F
00A0 | A9 B5 2E C2 70 0E E1 81 45 01 C1 5B BC FD 81 05
00B0 | F5 4E 48 83 5B E7 2D 09 90 10 06 9E CD 40 19 35
00C0 | 19 D1 D4 37 05 A5 2B 55 D4 E4 E1 AD E1 92 74 6A
00D0 | 81 7F CC AA 44 62 01 7E 4E A9 37 7B 23 EC DC 45
00E0 | 13 C5 E8 E6 22 EB CC 60 1F 64 B9 03 03 6E EF 68
00F0 | 0A DC 7B E8 B5 30 EE 51 4B 7D 1F 55 AA 75 31 AE
0100 | 84 9E 0A A1 78 B1 D0 F5 6C 2C 20 FD 4D A9 2E 83
0110 | 01 50 FB E2 72 71 4F 73 78 82 08 83 2B DB 0D A4
0120 | AE C6 17 C3 17 0E AE 75 BD 9C FB 75 92 E5 94 E6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100A5562D78CDE79D9C8BFB9732</code> <code>B939B00A7F5783C7653775BF92CA7376</code> <code>A4ED7E445A48EC4DB8DBE741FE02A8A3</code> <code>E5577990A668B80DE7066D6BA7AE53C1</code> <code>FA9C71331A22AF5F9837A9D1555CF55F</code> <code>A5AC245F0AE3CEDDB86F6795743BEA44</code> <code>4A8242FC7D62E777AF350F55F9A03A66</code> <code>10BD302FA9B52EC2700EE1814501C15B</code> <code>BCFD8105F54E48835BE72D099010069E</code> <code>CD40193519D1D43705A52B55D4E4E1AD</code> <code>E192746A817FCCAA4462017E4EA9377B</code> <code>23ECDC4513C5E8E622EBCC601F64B903</code> <code>036EEF680ADC7BE8B530EE514B7D1F55</code> <code>AA7531AE849E0AA178B1D0F56C2C20FD</code> <code>4DA92E830150FBE272714F7378820883</code> <code>2BDB0DA4AEC617C3170EAE75BD9CFB75</code><br> <code>92E594E6</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643668291BFCD2A9A38CEF5EBEE6CAD60F463A1EEAF500BC30D41097756B42D34DE4D0000000000000000FE000100A5562D78CDE79D9C8BFB9732B939B00A7F5783C7653775BF92CA7376A4ED7E445A48EC4DB8DBE741FE02A8A3E5577990A668B80DE7066D6BA7AE53C1FA9C71331A22AF5F9837A9D1555CF55FA5AC245F0AE3CEDDB86F6795743BEA444A8242FC7D62E777AF350F55F9A03A6610BD302FA9B52EC2700EE1814501C15BBCFD8105F54E48835BE72D099010069ECD40193519D1D43705A52B55D4E4E1ADE192746A817FCCAA4462017E4EA9377B23ECDC4513C5E8E622EBCC601F64B903036EEF680ADC7BE8B530EE514B7D1F55AA7531AE849E0AA178B1D0F56C2C20FD4DA92E830150FBE272714F73788208832BDB0DA4AEC617C3170EAE75BD9CFB7592E594E6
padding = 3E72C6297A21CAC75CA2CB11
tmp_aes_key = 6D848880E69F68B2DCF8956FADABFA6670B22AD2FA517E2DE6D304C85C9037E7
tmp_aes_iv = F53CBAADFD57CD5DA787712E20BFAA9A7EE079C06825E4DE074FAAD1E0FD6FAF</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 896CD15E5BD7D97ACF6D62726F22C7347401FB362966ED17F14C59E3C391EDDE598E058692ABF10A20C0E4C5A9FA6009005CCBDF4146F658AC01C5DEBF5C790E0714E27F6EA124AD6C8BB1F78F40B2132B7789BDCCA32290161D628F583324B1E4ADD666BC50C79DDC1126043009CA36446B0692424A51E8609B738C316825BEBC27AC78485DF524E9D1F1E060AB6322FCB2BC2485164022E664693D4591245951CE83B649F9C3D8CB7BFAAF7D7C6FCCC241D3C4599FA792C3C5FD422946759B8F6FA25960BF67A7291F041F1447024B16EAD2363635A7F9CDA97E07E89C3C6DFB7B7DA7F5CBB48815ECB86CBABA51E248B6DC98276CF71F18DB4701DB79471D24F8A6C4079B1136CD03A8B3E5A4F867088343EC77EC8F1BC9AD253A982D6068CD5528BFDC9FC0C0CCB7B600EA775EA1ED15B21E050434C316CA5EF093D796C50492C84989450B55240456AB155AD5C9</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 92 0A 00 B1 2B AD 66
0010 | 78 01 00 00 1F 5F 04 F5 82 91 BF CD 2A 9A 38 CE
0020 | F5 EB EE 6C AD 60 F4 63 A1 EE AF 50 0B C3 0D 41
0030 | 09 77 56 B4 2D 34 DE 4D FE 50 01 00 89 6C D1 5E
0040 | 5B D7 D9 7A CF 6D 62 72 6F 22 C7 34 74 01 FB 36
0050 | 29 66 ED 17 F1 4C 59 E3 C3 91 ED DE 59 8E 05 86
0060 | 92 AB F1 0A 20 C0 E4 C5 A9 FA 60 09 00 5C CB DF
0070 | 41 46 F6 58 AC 01 C5 DE BF 5C 79 0E 07 14 E2 7F
0080 | 6E A1 24 AD 6C 8B B1 F7 8F 40 B2 13 2B 77 89 BD
0090 | CC A3 22 90 16 1D 62 8F 58 33 24 B1 E4 AD D6 66
00A0 | BC 50 C7 9D DC 11 26 04 30 09 CA 36 44 6B 06 92
00B0 | 42 4A 51 E8 60 9B 73 8C 31 68 25 BE BC 27 AC 78
00C0 | 48 5D F5 24 E9 D1 F1 E0 60 AB 63 22 FC B2 BC 24
00D0 | 85 16 40 22 E6 64 69 3D 45 91 24 59 51 CE 83 B6
00E0 | 49 F9 C3 D8 CB 7B FA AF 7D 7C 6F CC C2 41 D3 C4
00F0 | 59 9F A7 92 C3 C5 FD 42 29 46 75 9B 8F 6F A2 59
0100 | 60 BF 67 A7 29 1F 04 1F 14 47 02 4B 16 EA D2 36
0110 | 36 35 A7 F9 CD A9 7E 07 E8 9C 3C 6D FB 7B 7D A7
0120 | F5 CB B4 88 15 EC B8 6C BA BA 51 E2 48 B6 DC 98
0130 | 27 6C F7 1F 18 DB 47 01 DB 79 47 1D 24 F8 A6 C4
0140 | 07 9B 11 36 CD 03 A8 B3 E5 A4 F8 67 08 83 43 EC
0150 | 77 EC 8F 1B C9 AD 25 3A 98 2D 60 68 CD 55 28 BF
0160 | DC 9F C0 C0 CC B7 B6 00 EA 77 5E A1 ED 15 B2 1E
0170 | 05 04 34 C3 16 CA 5E F0 93 D7 96 C5 04 92 C8 49
0180 | 89 45 0B 55 24 04 56 AB 15 5A D5 C9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C0920A00B12BAD66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100896CD15E5BD7D97ACF6D6272</code> <code>6F22C7347401FB362966ED17F14C59E3</code> <code>C391EDDE598E058692ABF10A20C0E4C5</code> <code>A9FA6009005CCBDF4146F658AC01C5DE</code> <code>BF5C790E0714E27F6EA124AD6C8BB1F7</code> <code>8F40B2132B7789BDCCA32290161D628F</code> <code>583324B1E4ADD666BC50C79DDC112604</code> <code>3009CA36446B0692424A51E8609B738C</code> <code>316825BEBC27AC78485DF524E9D1F1E0</code> <code>60AB6322FCB2BC2485164022E664693D</code> <code>4591245951CE83B649F9C3D8CB7BFAAF</code> <code>7D7C6FCCC241D3C4599FA792C3C5FD42</code> <code>2946759B8F6FA25960BF67A7291F041F</code> <code>1447024B16EAD2363635A7F9CDA97E07</code> <code>E89C3C6DFB7B7DA7F5CBB48815ECB86C</code> <code>BABA51E248B6DC98276CF71F18DB4701</code> <code>DB79471D24F8A6C4079B1136CD03A8B3</code> <code>E5A4F867088343EC77EC8F1BC9AD253A</code> <code>982D6068CD5528BFDC9FC0C0CCB7B600</code> <code>EA775EA1ED15B21E050434C316CA5EF0</code> <code>93D796C50492C84989450B55240456AB</code><br> <code>155AD5C9</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 899610CDC590BF2CB34BD46C6098072E43779543CFAD667B2DE5A4F785F75E806ED20D5C89625A8E0E6D13A97CCE3EF0923D6DE31BDC722032792FE0FF4F51D59583E766644298EB29FC7728C30106FD2A095E4F4556BB655F6D8E96BB11B5C0DBCD849765C09690FAB6DF692A9BB90FFDBAF98B2052F589D4F54A3F6E823320083A3101E8B417C682CF1C432B8AA58A3C1B0F50589856E75DB38A7338DFFFE1C732CE91A2EE41427C155A58145B2F53B91DA189AFCDC80373F75E6A043358F424A3540CC9B18B7F072250D2DCB8FFF794FCB825FD241599F262BD9E0381420CE586022DC42F12D32E9F11173153C5C5D2211E5C828E0E20497543207AC9F999</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 78 5C 8C B2 2B AD 66
0010 | 94 00 00 00 34 F7 CB 3B 82 91 BF CD 2A 9A 38 CE
0020 | F5 EB EE 6C AD 60 F4 63 A1 EE AF 50 0B C3 0D 41
0030 | 09 77 56 B4 2D 34 DE 4D 00 F0 D0 9C 50 95 F4 06
0040 | 94 ED BD 9D 6C 81 80 02</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01785C8CB22BAD66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>94000000</code> (148 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>8291BFCD2A9A38CEF5EBEE6CAD60F463</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A1EEAF500BC30D41097756B42D34DE4D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>00F0D09C5095F40694EDBD9D6C818002</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

