<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 00 71 01 00 6A F6 62 67
0010 | 14 00 00 00 F1 8E 7E BE 74 D1 BB AE 7E 4F C7 85
0020 | 73 C5 25 D0 4B 40 88 FD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>007101006AF66267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 EC A9 E7 6A F6 62 67
0010 | 50 00 00 00 63 24 16 05 74 D1 BB AE 7E 4F C7 85
0020 | 73 C5 25 D0 4B 40 88 FD 4E E1 58 D5 8C 4C D1 27
0030 | 06 1B F6 5A D2 23 AF 78 08 2B 73 52 31 68 30 74
0040 | A1 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01ECA9E76AF66267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082B735231683074A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3130936538107507873</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3130936538107507873</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3130936538107507873 = 1619970727 * 1932711799</code></p>
<pre><code>p = 1619970727
q = 1932711799</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2B 73 52 31 68 30 74 A1 00 00 00
0010 | 04 60 8E CA A7 00 00 00 04 73 32 D7 77 00 00 00
0020 | 74 D1 BB AE 7E 4F C7 85 73 C5 25 D0 4B 40 88 FD
0030 | 4E E1 58 D5 8C 4C D1 27 06 1B F6 5A D2 23 AF 78
0040 | EA DD 92 93 7C 95 B5 F5 72 80 68 20 23 52 8C 70
0050 | 73 2C 44 4B F2 69 C7 DE 0E EE 19 01 14 58 37 63
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082B735231683074A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3130936538107507873</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04608ECAA7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1619970727</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047332D777000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1932711799</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>EADD92937C95B5F57280682023528C70</code> <code>732C444BF269C7DE0EEE190114583763</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082B735231683074A100000004608ECAA7000000047332D77700000074D1BBAE7E4FC78573C525D04B4088FD4EE158D58C4CD127061BF65AD223AF78EADD92937C95B5F57280682023528C70732C444BF269C7DE0EEE19011458376302000000
random_padding_bytes = 50B51A8987054A04B53AEB09CF71A5B2B9419728594B2C62266C1FD2FBE14C9349559B388EFB5139767AF82E1AE3BC6F5ADD830CB7EB133B30078D5D26BAAD55309864E6A6CE9C3FA7FB3485160C687F6A6C9AD38BB0C1662C6691A0</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 1AE15C24EA0BFC90ABE9B7D5996FD06411D04E652B4DFC9288BF1232257A8CE165A2F3562D93CCD2D8D6FE006EC886203D86FA43DEF030E9743E208FD656FC9B2FF29621AAD919B79D50AB4AF26637961D0E9E8BAD32183342AA23C1A7998E02C50AA6D32C3813570F38AEA2A691E56132B677D560B410FAA8A8428D151C81952396B367CBD68E6222549E7A6BF6AE87152473FF9C31839E051493261DF5E8F915A08CBB81391F71BC8F380E7014735697441EF7DB8E133A6389EA1360A6EFB679AC4BE37EB44D1756D49385C693C35732E533FE327634B07C1E0E24434612BFD00E9867E5841DD2268A3EAEF570A04D991D8E1DA838AD7666A6739FEF17CB40</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 1C EA 09 00 6A F6 62 67
0010 | 40 01 00 00 BE E4 12 D7 74 D1 BB AE 7E 4F C7 85
0020 | 73 C5 25 D0 4B 40 88 FD 4E E1 58 D5 8C 4C D1 27
0030 | 06 1B F6 5A D2 23 AF 78 04 60 8E CA A7 00 00 00
0040 | 04 73 32 D7 77 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 1A E1 5C 24 EA 0B FC 90 AB E9 B7 D5
0060 | 99 6F D0 64 11 D0 4E 65 2B 4D FC 92 88 BF 12 32
0070 | 25 7A 8C E1 65 A2 F3 56 2D 93 CC D2 D8 D6 FE 00
0080 | 6E C8 86 20 3D 86 FA 43 DE F0 30 E9 74 3E 20 8F
0090 | D6 56 FC 9B 2F F2 96 21 AA D9 19 B7 9D 50 AB 4A
00A0 | F2 66 37 96 1D 0E 9E 8B AD 32 18 33 42 AA 23 C1
00B0 | A7 99 8E 02 C5 0A A6 D3 2C 38 13 57 0F 38 AE A2
00C0 | A6 91 E5 61 32 B6 77 D5 60 B4 10 FA A8 A8 42 8D
00D0 | 15 1C 81 95 23 96 B3 67 CB D6 8E 62 22 54 9E 7A
00E0 | 6B F6 AE 87 15 24 73 FF 9C 31 83 9E 05 14 93 26
00F0 | 1D F5 E8 F9 15 A0 8C BB 81 39 1F 71 BC 8F 38 0E
0100 | 70 14 73 56 97 44 1E F7 DB 8E 13 3A 63 89 EA 13
0110 | 60 A6 EF B6 79 AC 4B E3 7E B4 4D 17 56 D4 93 85
0120 | C6 93 C3 57 32 E5 33 FE 32 76 34 B0 7C 1E 0E 24
0130 | 43 46 12 BF D0 0E 98 67 E5 84 1D D2 26 8A 3E AE
0140 | F5 70 A0 4D 99 1D 8E 1D A8 38 AD 76 66 A6 73 9F
0150 | EF 17 CB 40</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>1CEA09006AF66267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04608ECAA7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1619970727</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047332D777000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1932711799</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001001AE15C24EA0BFC90ABE9B7D5</code> <code>996FD06411D04E652B4DFC9288BF1232</code> <code>257A8CE165A2F3562D93CCD2D8D6FE00</code> <code>6EC886203D86FA43DEF030E9743E208F</code> <code>D656FC9B2FF29621AAD919B79D50AB4A</code> <code>F26637961D0E9E8BAD32183342AA23C1</code> <code>A7998E02C50AA6D32C3813570F38AEA2</code> <code>A691E56132B677D560B410FAA8A8428D</code> <code>151C81952396B367CBD68E6222549E7A</code> <code>6BF6AE87152473FF9C31839E05149326</code> <code>1DF5E8F915A08CBB81391F71BC8F380E</code> <code>7014735697441EF7DB8E133A6389EA13</code> <code>60A6EFB679AC4BE37EB44D1756D49385</code> <code>C693C35732E533FE327634B07C1E0E24</code> <code>434612BFD00E9867E5841DD2268A3EAE</code> <code>F570A04D991D8E1DA838AD7666A6739F</code><br> <code>EF17CB40</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C0 66 06 6B F6 62 67
0010 | 78 02 00 00 5C 07 E8 D0 74 D1 BB AE 7E 4F C7 85
0020 | 73 C5 25 D0 4B 40 88 FD 4E E1 58 D5 8C 4C D1 27
0030 | 06 1B F6 5A D2 23 AF 78 FE 50 02 00 9A 67 98 2C
0040 | 46 8D B8 B6 CF FD 52 23 6F 87 6A 33 40 40 23 70
0050 | 06 4A B7 F9 2C F3 80 1A 02 F7 7A 90 C0 D9 CA F9
0060 | 5B 7D B8 79 83 C8 54 CF 9F 8C 12 76 AC 34 FB D0
0070 | 1A 80 BE 16 3C 3E F6 37 F4 4D 76 19 B0 44 F8 31
0080 | 60 F8 29 40 0C 76 38 89 4D 57 D5 35 23 8D 27 47
0090 | 0D 94 CE 75 88 46 A5 6C AE 5A 7E 1E 8B 42 49 00
00A0 | 9B F8 18 5F 58 CD A8 8D A9 23 4C A4 7F 89 3C 01
00B0 | C5 26 29 F5 BC EB 7A 93 8A 4A 8E 13 59 80 8E DE
00C0 | AB 5A 0C D2 B3 0E 09 FC DD 7A 39 ED C1 B1 C1 93
00D0 | D7 81 8E D5 49 A5 45 70 1F F4 F5 BE 9B 8F 08 CF
00E0 | 84 A2 BB 53 09 1E 2F 82 87 D9 F9 5E 37 AF 88 37
00F0 | 61 82 A5 B9 E9 B7 D8 57 93 2C 1A 15 4D FC F8 76
0100 | F4 0F 7F 17 D3 B3 62 6E 5A DA 8B E7 3C 01 75 C0
0110 | DF 8D 37 1E 65 C5 87 C4 67 4D 8F 2C 91 0F 4C 31
0120 | 16 33 D2 8F 26 B9 EE 59 68 D6 82 07 27 B7 75 76
0130 | 59 83 E2 08 D9 77 99 3B F0 30 A7 7C CA A3 7C 8E
0140 | 7E 9B A1 A8 01 91 40 75 90 E0 9C F9 6D 8F 90 7A
0150 | E5 13 3E 53 83 21 1D 21 1D 1E 38 F2 A7 C7 CA 28
0160 | 3A CC 84 60 F6 D4 CD 4B 13 0A 37 D3 9A B3 F8 62
0170 | 39 19 02 57 B4 59 C4 FA 3D 48 75 52 C6 07 91 2B
0180 | 08 CF 46 3B 08 BE 91 99 C4 C0 CF C5 12 F3 0E D5
0190 | 36 C2 E5 FF D8 65 91 25 04 D2 70 96 6C A5 E9 B6
01A0 | CC CA DD 2E 86 24 4A 87 66 05 75 6D C6 75 73 A0
01B0 | D6 53 BB 34 72 9D C9 74 94 09 D1 76 16 D0 26 5C
01C0 | 02 07 00 03 E1 DE D9 27 F0 89 63 FE 6C 5F B5 5C
01D0 | F9 3F A3 6B 15 47 9F F6 C2 1D 9A 1D EC E5 30 F7
01E0 | F6 88 70 AE C9 17 57 A5 29 42 1D 90 ED F4 FB 16
01F0 | FB 02 3B 96 9A CF F8 3C 56 76 D7 E9 AA 2C 24 AE
0200 | 26 F6 63 05 DB FB 5F EC 9C 80 53 C4 CF 4D 5E 98
0210 | 8E D9 C6 9F 39 EF AE BD 0B 63 A8 14 B9 76 6C D4
0220 | 3E FF 23 87 8E 04 C6 23 CF 42 4C 50 74 1A F6 02
0230 | 4E B3 2E 59 27 D7 99 84 45 15 E8 6F 6A 98 71 BC
0240 | 62 A0 77 52 B3 DD A3 CA 63 FA A0 88 B0 11 36 30
0250 | D4 11 E3 74 5A 6C 7F 15 56 40 9A B6 A9 61 6D B1
0260 | 29 22 F5 CE 89 97 EA 5C 1D 2E 63 4F A7 8C 6A F5
0270 | 9A EA 7E 38 BF 18 24 06 94 8C 95 F6 A1 BD 30 A8
0280 | 60 D9 8F 39 5D C4 54 58 0A FC D0 8C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C066066BF66267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002009A67982C468DB8B6CFFD5223</code> <code>6F876A3340402370064AB7F92CF3801A</code> <code>02F77A90C0D9CAF95B7DB87983C854CF</code> <code>9F8C1276AC34FBD01A80BE163C3EF637</code> <code>F44D7619B044F83160F829400C763889</code> <code>4D57D535238D27470D94CE758846A56C</code> <code>AE5A7E1E8B4249009BF8185F58CDA88D</code> <code>A9234CA47F893C01C52629F5BCEB7A93</code> <code>8A4A8E1359808EDEAB5A0CD2B30E09FC</code> <code>DD7A39EDC1B1C193D7818ED549A54570</code> <code>1FF4F5BE9B8F08CF84A2BB53091E2F82</code> <code>87D9F95E37AF88376182A5B9E9B7D857</code> <code>932C1A154DFCF876F40F7F17D3B3626E</code> <code>5ADA8BE73C0175C0DF8D371E65C587C4</code> <code>674D8F2C910F4C311633D28F26B9EE59</code> <code>68D6820727B775765983E208D977993B</code> <code>F030A77CCAA37C8E7E9BA1A801914075</code> <code>90E09CF96D8F907AE5133E5383211D21</code> <code>1D1E38F2A7C7CA283ACC8460F6D4CD4B</code> <code>130A37D39AB3F86239190257B459C4FA</code> <code>3D487552C607912B08CF463B08BE9199</code> <code>C4C0CFC512F30ED536C2E5FFD8659125</code> <code>04D270966CA5E9B6CCCADD2E86244A87</code> <code>6605756DC67573A0D653BB34729DC974</code> <code>9409D17616D0265C02070003E1DED927</code> <code>F08963FE6C5FB55CF93FA36B15479FF6</code> <code>C21D9A1DECE530F7F68870AEC91757A5</code> <code>29421D90EDF4FB16FB023B969ACFF83C</code> <code>5676D7E9AA2C24AE26F66305DBFB5FEC</code> <code>9C8053C4CF4D5E988ED9C69F39EFAEBD</code> <code>0B63A814B9766CD43EFF23878E04C623</code> <code>CF424C50741AF6024EB32E5927D79984</code> <code>4515E86F6A9871BC62A07752B3DDA3CA</code> <code>63FAA088B0113630D411E3745A6C7F15</code> <code>56409AB6A9616DB12922F5CE8997EA5C</code> <code>1D2E634FA78C6AF59AEA7E38BF182406</code> <code>948C95F6A1BD30A860D98F395DC45458</code><br> <code>0AFCD08C</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 9A67982C468DB8B6CFFD52236F876A3340402370064AB7F92CF3801A02F77A90C0D9CAF95B7DB87983C854CF9F8C1276AC34FBD01A80BE163C3EF637F44D7619B044F83160F829400C7638894D57D535238D27470D94CE758846A56CAE5A7E1E8B4249009BF8185F58CDA88DA9234CA47F893C01C52629F5BCEB7A938A4A8E1359808EDEAB5A0CD2B30E09FCDD7A39EDC1B1C193D7818ED549A545701FF4F5BE9B8F08CF84A2BB53091E2F8287D9F95E37AF88376182A5B9E9B7D857932C1A154DFCF876F40F7F17D3B3626E5ADA8BE73C0175C0DF8D371E65C587C4674D8F2C910F4C311633D28F26B9EE5968D6820727B775765983E208D977993BF030A77CCAA37C8E7E9BA1A80191407590E09CF96D8F907AE5133E5383211D211D1E38F2A7C7CA283ACC8460F6D4CD4B130A37D39AB3F86239190257B459C4FA3D487552C607912B08CF463B08BE9199C4C0CFC512F30ED536C2E5FFD865912504D270966CA5E9B6CCCADD2E86244A876605756DC67573A0D653BB34729DC9749409D17616D0265C02070003E1DED927F08963FE6C5FB55CF93FA36B15479FF6C21D9A1DECE530F7F68870AEC91757A529421D90EDF4FB16FB023B969ACFF83C5676D7E9AA2C24AE26F66305DBFB5FEC9C8053C4CF4D5E988ED9C69F39EFAEBD0B63A814B9766CD43EFF23878E04C623CF424C50741AF6024EB32E5927D799844515E86F6A9871BC62A07752B3DDA3CA63FAA088B0113630D411E3745A6C7F1556409AB6A9616DB12922F5CE8997EA5C1D2E634FA78C6AF59AEA7E38BF182406948C95F6A1BD30A860D98F395DC454580AFCD08C
tmp_aes_key = F806D0D1EAFFC6188AA7C5F7629C25C83026C567B9EA7FB5E01454F0FE8BF278
tmp_aes_iv = BCC4DD5F5E7473E84EE0A9E837599B4E78545D1CEF6CDBB3CC3E90A2EADD9293</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = C7C73B4DE3B578FA4AFE1E7E4E4C2AE023C107D0BA0D89B574D1BBAE7E4FC78573C525D04B4088FD4EE158D58C4CD127061BF65AD223AF7803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B5A2266FE92F62DD88F96FB92836F3D0DDBFD89BBCD390A05424D6C4335A66346ABBB0CDAF5EE22F2D85763ED38BF34B09630E1D9A992ADB32F48E99F24F326DB0B5640136F74204462230300E7C12EBDDD0480FC0F44B3120D725B86B0130A8B59E851A382A85CF323E7195090F9110BCB91C442889477BB5F778D708EA9EB96078257F731988BE72C4C1919B898A70FEBB0A3F2A05C6BA9FE8E8BDCB52F7937499AF44470E260ECCF2BB1AC32DBF3AE0AF60F03D22D6286247DE1C2280D0C286D7CC5DC6B875BF9AD28131F922970CC0EA39432703613C5515BA87B1647F3E5E9CA839DFD25FFB2F55FCA3D1689B1B19DAC044738BE96F150921E8EAEBB9616BF66267DF378720E24D2B27
answer = BA0D89B574D1BBAE7E4FC78573C525D04B4088FD4EE158D58C4CD127061BF65AD223AF7803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B5A2266FE92F62DD88F96FB92836F3D0DDBFD89BBCD390A05424D6C4335A66346ABBB0CDAF5EE22F2D85763ED38BF34B09630E1D9A992ADB32F48E99F24F326DB0B5640136F74204462230300E7C12EBDDD0480FC0F44B3120D725B86B0130A8B59E851A382A85CF323E7195090F9110BCB91C442889477BB5F778D708EA9EB96078257F731988BE72C4C1919B898A70FEBB0A3F2A05C6BA9FE8E8BDCB52F7937499AF44470E260ECCF2BB1AC32DBF3AE0AF60F03D22D6286247DE1C2280D0C286D7CC5DC6B875BF9AD28131F922970CC0EA39432703613C5515BA87B1647F3E5E9CA839DFD25FFB2F55FCA3D1689B1B19DAC044738BE96F150921E8EAEBB9616BF66267DF378720E24D2B27</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 74 D1 BB AE 7E 4F C7 85 73 C5 25 D0
0010 | 4B 40 88 FD 4E E1 58 D5 8C 4C D1 27 06 1B F6 5A
0020 | D2 23 AF 78 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | B5 A2 26 6F E9 2F 62 DD 88 F9 6F B9 28 36 F3 D0
0140 | DD BF D8 9B BC D3 90 A0 54 24 D6 C4 33 5A 66 34
0150 | 6A BB B0 CD AF 5E E2 2F 2D 85 76 3E D3 8B F3 4B
0160 | 09 63 0E 1D 9A 99 2A DB 32 F4 8E 99 F2 4F 32 6D
0170 | B0 B5 64 01 36 F7 42 04 46 22 30 30 0E 7C 12 EB
0180 | DD D0 48 0F C0 F4 4B 31 20 D7 25 B8 6B 01 30 A8
0190 | B5 9E 85 1A 38 2A 85 CF 32 3E 71 95 09 0F 91 10
01A0 | BC B9 1C 44 28 89 47 7B B5 F7 78 D7 08 EA 9E B9
01B0 | 60 78 25 7F 73 19 88 BE 72 C4 C1 91 9B 89 8A 70
01C0 | FE BB 0A 3F 2A 05 C6 BA 9F E8 E8 BD CB 52 F7 93
01D0 | 74 99 AF 44 47 0E 26 0E CC F2 BB 1A C3 2D BF 3A
01E0 | E0 AF 60 F0 3D 22 D6 28 62 47 DE 1C 22 80 D0 C2
01F0 | 86 D7 CC 5D C6 B8 75 BF 9A D2 81 31 F9 22 97 0C
0200 | C0 EA 39 43 27 03 61 3C 55 15 BA 87 B1 64 7F 3E
0210 | 5E 9C A8 39 DF D2 5F FB 2F 55 FC A3 D1 68 9B 1B
0220 | 19 DA C0 44 73 8B E9 6F 15 09 21 E8 EA EB B9 61
0230 | 6B F6 62 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100B5A2266FE92F62DD88F96FB9</code> <code>2836F3D0DDBFD89BBCD390A05424D6C4</code> <code>335A66346ABBB0CDAF5EE22F2D85763E</code> <code>D38BF34B09630E1D9A992ADB32F48E99</code> <code>F24F326DB0B5640136F7420446223030</code> <code>0E7C12EBDDD0480FC0F44B3120D725B8</code> <code>6B0130A8B59E851A382A85CF323E7195</code> <code>090F9110BCB91C442889477BB5F778D7</code> <code>08EA9EB96078257F731988BE72C4C191</code> <code>9B898A70FEBB0A3F2A05C6BA9FE8E8BD</code> <code>CB52F7937499AF44470E260ECCF2BB1A</code> <code>C32DBF3AE0AF60F03D22D6286247DE1C</code> <code>2280D0C286D7CC5DC6B875BF9AD28131</code> <code>F922970CC0EA39432703613C5515BA87</code> <code>B1647F3E5E9CA839DFD25FFB2F55FCA3</code> <code>D1689B1B19DAC044738BE96F150921E8</code><br> <code>EAEBB961</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>6BF66267</code> (1734538859 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 5D8C5205B6CEF849826AB65B9CBCD803D6B8509AA7E996748848E542A45F563A6EF3E9EA22B425589EA19234B844A96205521C85C0A3C988D8487BF6ADC857EDA8F3FEF7FC05DC00FC8E47C0E06B9698F6C4A3F574800A05B30A3D7CB9E854A3CDFF961D430B2BA37E796D202B01CB53707E79107A2E93B2CC3FCFEF2B350352ACAE561CD72695299DCECEF28D10A23C39C36CFF0ACE97712AB52049DBF4692F00FD2995F590059285B0011EEA4FBAED00F8CB919ADEA8DB2A559141ABA91C0F7A14E3CEE1C65FF1D855141A9193BCCF61B73C0D88A729AA7F3172D6942C5D4EDDB6C417A410B5270B7E6546CA90C8DAEFB335B1B45F84468985CA15AC19CD04</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = A1D764C255FFB8EBB1AB27F1D8D2735226236E846BCC7000B05A810C4236C403932C2CBA94DA00458A5995C9D5FD497FCA110A94B32AEEED661883C6AC0DC925D3F133176AA13A34D89FD36F569CE83F7E8EB3CFDE467B4038EB0840B8A054E5791AA37B57AC18E89F8BE4EF4F2822E0ADC003B942BC5ADDCEB5B871A32401710B152F5E771709EEE0348170B858874A18DA7EE378F3D1359B4984CDD0BC90181E8780CDC944553C973EC8A1EAFCD99CCC177B3B9CB71E86923FD55834DB8606677A22ADF63ADF9A9959D0FAB3FF6C1F94B9A3CB12A07050A4E7365C6FE45D6E66C10CD03A7F7964F1C3788689833AFB17E1D857E7658450226F9EA7A9B59920</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 74 D1 BB AE 7E 4F C7 85 73 C5 25 D0
0010 | 4B 40 88 FD 4E E1 58 D5 8C 4C D1 27 06 1B F6 5A
0020 | D2 23 AF 78 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | A1 D7 64 C2 55 FF B8 EB B1 AB 27 F1 D8 D2 73 52
0040 | 26 23 6E 84 6B CC 70 00 B0 5A 81 0C 42 36 C4 03
0050 | 93 2C 2C BA 94 DA 00 45 8A 59 95 C9 D5 FD 49 7F
0060 | CA 11 0A 94 B3 2A EE ED 66 18 83 C6 AC 0D C9 25
0070 | D3 F1 33 17 6A A1 3A 34 D8 9F D3 6F 56 9C E8 3F
0080 | 7E 8E B3 CF DE 46 7B 40 38 EB 08 40 B8 A0 54 E5
0090 | 79 1A A3 7B 57 AC 18 E8 9F 8B E4 EF 4F 28 22 E0
00A0 | AD C0 03 B9 42 BC 5A DD CE B5 B8 71 A3 24 01 71
00B0 | 0B 15 2F 5E 77 17 09 EE E0 34 81 70 B8 58 87 4A
00C0 | 18 DA 7E E3 78 F3 D1 35 9B 49 84 CD D0 BC 90 18
00D0 | 1E 87 80 CD C9 44 55 3C 97 3E C8 A1 EA FC D9 9C
00E0 | CC 17 7B 3B 9C B7 1E 86 92 3F D5 58 34 DB 86 06
00F0 | 67 7A 22 AD F6 3A DF 9A 99 59 D0 FA B3 FF 6C 1F
0100 | 94 B9 A3 CB 12 A0 70 50 A4 E7 36 5C 6F E4 5D 6E
0110 | 66 C1 0C D0 3A 7F 79 64 F1 C3 78 86 89 83 3A FB
0120 | 17 E1 D8 57 E7 65 84 50 22 6F 9E A7 A9 B5 99 20</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100A1D764C255FFB8EBB1AB27F1</code> <code>D8D2735226236E846BCC7000B05A810C</code> <code>4236C403932C2CBA94DA00458A5995C9</code> <code>D5FD497FCA110A94B32AEEED661883C6</code> <code>AC0DC925D3F133176AA13A34D89FD36F</code> <code>569CE83F7E8EB3CFDE467B4038EB0840</code> <code>B8A054E5791AA37B57AC18E89F8BE4EF</code> <code>4F2822E0ADC003B942BC5ADDCEB5B871</code> <code>A32401710B152F5E771709EEE0348170</code> <code>B858874A18DA7EE378F3D1359B4984CD</code> <code>D0BC90181E8780CDC944553C973EC8A1</code> <code>EAFCD99CCC177B3B9CB71E86923FD558</code> <code>34DB8606677A22ADF63ADF9A9959D0FA</code> <code>B3FF6C1F94B9A3CB12A07050A4E7365C</code> <code>6FE45D6E66C10CD03A7F7964F1C37886</code> <code>89833AFB17E1D857E7658450226F9EA7</code><br> <code>A9B59920</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436674D1BBAE7E4FC78573C525D04B4088FD4EE158D58C4CD127061BF65AD223AF780000000000000000FE000100A1D764C255FFB8EBB1AB27F1D8D2735226236E846BCC7000B05A810C4236C403932C2CBA94DA00458A5995C9D5FD497FCA110A94B32AEEED661883C6AC0DC925D3F133176AA13A34D89FD36F569CE83F7E8EB3CFDE467B4038EB0840B8A054E5791AA37B57AC18E89F8BE4EF4F2822E0ADC003B942BC5ADDCEB5B871A32401710B152F5E771709EEE0348170B858874A18DA7EE378F3D1359B4984CDD0BC90181E8780CDC944553C973EC8A1EAFCD99CCC177B3B9CB71E86923FD55834DB8606677A22ADF63ADF9A9959D0FAB3FF6C1F94B9A3CB12A07050A4E7365C6FE45D6E66C10CD03A7F7964F1C3788689833AFB17E1D857E7658450226F9EA7A9B59920
padding = 577A688236E9D7115FB7C93B
tmp_aes_key = F806D0D1EAFFC6188AA7C5F7629C25C83026C567B9EA7FB5E01454F0FE8BF278
tmp_aes_iv = BCC4DD5F5E7473E84EE0A9E837599B4E78545D1CEF6CDBB3CC3E90A2EADD9293</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 449E326D2D5E24863C473F1A153BC047163E2898C1D142FC0BB48FF38CB9A22B0A3A18BB3C3CFA1FF21DAB672CC2CF75B1A7CC77993A1F505191DFA98701DF635DA4A441CA7A30FBDF0032883A141D1FCD60CCB4AFADC6741DE3908B086EB236501F20E38413623825C2EC47A008FB624D2761507C758FE9E8461FDD9A1F46F94FCBCBABAEFBDA91B325D2C8685D3691815832398E881D5D92F9C398A1B7733E4289AF7BF811CD47BAD72F070AEA3E5BD98E86C73A3446F84A6679441326CB38D257CB5094C5680F6164B8DCEFA4280636F6122327E483EFA7CBB6FAC409AAFFE7A6F8BB02257718A7C097DED58F572FD8EE98BEAC738BC2AEDDE097BF869B9D26AB192DC5CA9970D5A9071DA6E2ADD87117CE931DF2EB0D4E35F2BCAEBFF745BE94A3B8082AF51F1CC634DAC65D6175A9CEAF72CA9510FF9F159C615DDFA7CE3B74D56374D75F2E73E5639C0E221D44</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 10 02 04 00 6B F6 62 67
0010 | 78 01 00 00 1F 5F 04 F5 74 D1 BB AE 7E 4F C7 85
0020 | 73 C5 25 D0 4B 40 88 FD 4E E1 58 D5 8C 4C D1 27
0030 | 06 1B F6 5A D2 23 AF 78 FE 50 01 00 44 9E 32 6D
0040 | 2D 5E 24 86 3C 47 3F 1A 15 3B C0 47 16 3E 28 98
0050 | C1 D1 42 FC 0B B4 8F F3 8C B9 A2 2B 0A 3A 18 BB
0060 | 3C 3C FA 1F F2 1D AB 67 2C C2 CF 75 B1 A7 CC 77
0070 | 99 3A 1F 50 51 91 DF A9 87 01 DF 63 5D A4 A4 41
0080 | CA 7A 30 FB DF 00 32 88 3A 14 1D 1F CD 60 CC B4
0090 | AF AD C6 74 1D E3 90 8B 08 6E B2 36 50 1F 20 E3
00A0 | 84 13 62 38 25 C2 EC 47 A0 08 FB 62 4D 27 61 50
00B0 | 7C 75 8F E9 E8 46 1F DD 9A 1F 46 F9 4F CB CB AB
00C0 | AE FB DA 91 B3 25 D2 C8 68 5D 36 91 81 58 32 39
00D0 | 8E 88 1D 5D 92 F9 C3 98 A1 B7 73 3E 42 89 AF 7B
00E0 | F8 11 CD 47 BA D7 2F 07 0A EA 3E 5B D9 8E 86 C7
00F0 | 3A 34 46 F8 4A 66 79 44 13 26 CB 38 D2 57 CB 50
0100 | 94 C5 68 0F 61 64 B8 DC EF A4 28 06 36 F6 12 23
0110 | 27 E4 83 EF A7 CB B6 FA C4 09 AA FF E7 A6 F8 BB
0120 | 02 25 77 18 A7 C0 97 DE D5 8F 57 2F D8 EE 98 BE
0130 | AC 73 8B C2 AE DD E0 97 BF 86 9B 9D 26 AB 19 2D
0140 | C5 CA 99 70 D5 A9 07 1D A6 E2 AD D8 71 17 CE 93
0150 | 1D F2 EB 0D 4E 35 F2 BC AE BF F7 45 BE 94 A3 B8
0160 | 08 2A F5 1F 1C C6 34 DA C6 5D 61 75 A9 CE AF 72
0170 | CA 95 10 FF 9F 15 9C 61 5D DF A7 CE 3B 74 D5 63
0180 | 74 D7 5F 2E 73 E5 63 9C 0E 22 1D 44</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>100204006BF66267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100449E326D2D5E24863C473F1A</code> <code>153BC047163E2898C1D142FC0BB48FF3</code> <code>8CB9A22B0A3A18BB3C3CFA1FF21DAB67</code> <code>2CC2CF75B1A7CC77993A1F505191DFA9</code> <code>8701DF635DA4A441CA7A30FBDF003288</code> <code>3A141D1FCD60CCB4AFADC6741DE3908B</code> <code>086EB236501F20E38413623825C2EC47</code> <code>A008FB624D2761507C758FE9E8461FDD</code> <code>9A1F46F94FCBCBABAEFBDA91B325D2C8</code> <code>685D3691815832398E881D5D92F9C398</code> <code>A1B7733E4289AF7BF811CD47BAD72F07</code> <code>0AEA3E5BD98E86C73A3446F84A667944</code> <code>1326CB38D257CB5094C5680F6164B8DC</code> <code>EFA4280636F6122327E483EFA7CBB6FA</code> <code>C409AAFFE7A6F8BB02257718A7C097DE</code> <code>D58F572FD8EE98BEAC738BC2AEDDE097</code> <code>BF869B9D26AB192DC5CA9970D5A9071D</code> <code>A6E2ADD87117CE931DF2EB0D4E35F2BC</code> <code>AEBFF745BE94A3B8082AF51F1CC634DA</code> <code>C65D6175A9CEAF72CA9510FF9F159C61</code> <code>5DDFA7CE3B74D56374D75F2E73E5639C</code><br> <code>0E221D44</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 62929EAE577D0096E522262F482B2F4CD701D194E7F92299C2C591157B747F4BB1A2C91A1A33BF4C5B66B96992DAB9A73DA24359D85AB9D3DD9874AA08D75ED0936BBB3E16FF2E27D950D31497E87ADD59DD04CBD01DA88F9AE7DD06C21BC2B7A5FC887197FE1713300E8FFA61409950BC23F35C7090AA9A47D49959ECBB5891B7573658D1BE821FAA7815F4B212F7931B11A7476B674742C442496ADA7D2590F17FA67842E564319420E1E9D4D06189597ADDC819A2959A6FCB80A51EE3DA150AC418F616859E22A21E3FD3DBD1FC4FCDBE77E51522FAAEF56DD1BEA0CFDE46FE3DE6B3FA493C92BD3DF16CF2F6073AF9A61C4FDC5D0AE5349BE7F91EA3AD15</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 39 11 6C F6 62 67
0010 | 34 00 00 00 34 F7 CB 3B 74 D1 BB AE 7E 4F C7 85
0020 | 73 C5 25 D0 4B 40 88 FD 4E E1 58 D5 8C 4C D1 27
0030 | 06 1B F6 5A D2 23 AF 78 AA 28 61 1C 62 22 EF F0
0040 | C6 74 FC 9A E8 D7 5A B3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E039116CF66267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>74D1BBAE7E4FC78573C525D04B4088FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4EE158D58C4CD127061BF65AD223AF78</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>AA28611C6222EFF0C674FC9AE8D75AB3</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

