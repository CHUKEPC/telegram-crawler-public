<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E0 60 09 00 B7 95 72 67
0010 | 14 00 00 00 F1 8E 7E BE D2 C0 BB 42 D5 AE 94 65
0020 | 81 2B 7E 8B D8 D4 79 29</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E0600900B7957267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A0 A2 49 B7 95 72 67
0010 | 50 00 00 00 63 24 16 05 D2 C0 BB 42 D5 AE 94 65
0020 | 81 2B 7E 8B D8 D4 79 29 76 05 2B 6A 35 A2 B9 D9
0030 | F3 6B B7 49 B4 45 C6 55 08 23 A4 60 CC 8B C9 36
0040 | 33 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A0A249B7957267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0823A460CC8BC93633000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2568284119142839859</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2568284119142839859</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2568284119142839859 = 1555754593 * 1650828563</code></p>
<pre><code>p = 1555754593
q = 1650828563</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 23 A4 60 CC 8B C9 36 33 00 00 00
0010 | 04 5C BA EE 61 00 00 00 04 62 65 A5 13 00 00 00
0020 | D2 C0 BB 42 D5 AE 94 65 81 2B 7E 8B D8 D4 79 29
0030 | 76 05 2B 6A 35 A2 B9 D9 F3 6B B7 49 B4 45 C6 55
0040 | 23 F4 F5 48 69 CA 2D 13 A3 64 3C E8 CA 7B 19 5E
0050 | 78 EF 47 DE 56 73 55 E6 A7 C1 6B AB 3A E2 DC A5
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0823A460CC8BC93633000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2568284119142839859</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045CBAEE61000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1555754593</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046265A513000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1650828563</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>23F4F54869CA2D13A3643CE8CA7B195E</code> <code>78EF47DE567355E6A7C16BAB3AE2DCA5</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90823A460CC8BC93633000000045CBAEE61000000046265A513000000D2C0BB42D5AE9465812B7E8BD8D4792976052B6A35A2B9D9F36BB749B445C65523F4F54869CA2D13A3643CE8CA7B195E78EF47DE567355E6A7C16BAB3AE2DCA502000000
random_padding_bytes = E2D8FFA88FA9C674B61F6B194DF562A95EB01B1C0901ACE244C5FA7FBA9C2547C001E542CC6170B6CE33C4EE775BA3F35434ABCBD8B9F21CE616D97B47CA7ACFA60E35C5AFA36722C12C851C31E75A0F5447CE93844418A585CB440D</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 80E429A94900A1AA791ECCEDFF14F91675BAF387B2AD5CDD04BA054BBC4237728DA877323F9CEEF2AC0AF1B8CAFCDEDB37FA6C926391023B886033D9891A15D106E2ED2309AD614C841B2A843651A12D3A5B8A43C8E3B1D21ED5E09FCFDD777AC20EEA7D014D63A8203D490A517D05DD1B5444A098DAB606D2A72E4E08EFEDD41A4375D362139F8763B6255E10FCBEFC644CA2FC25ED633082BBC7852A503C4D719E4F5B7C92A698BB4C2ACA99DD9C7F544CDB31B9589684B5785F013D0743962991110CB5AD10402551D5B55514FDDA4D0CE10470A45D83CBFAA457C4DDAA3DBE5C0FB5B387B9C51C7C02652BABC0F9F87C7893D93221C18248A2691E062DB3</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 60 09 00 B7 95 72 67
0010 | 40 01 00 00 BE E4 12 D7 D2 C0 BB 42 D5 AE 94 65
0020 | 81 2B 7E 8B D8 D4 79 29 76 05 2B 6A 35 A2 B9 D9
0030 | F3 6B B7 49 B4 45 C6 55 04 5C BA EE 61 00 00 00
0040 | 04 62 65 A5 13 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 80 E4 29 A9 49 00 A1 AA 79 1E CC ED
0060 | FF 14 F9 16 75 BA F3 87 B2 AD 5C DD 04 BA 05 4B
0070 | BC 42 37 72 8D A8 77 32 3F 9C EE F2 AC 0A F1 B8
0080 | CA FC DE DB 37 FA 6C 92 63 91 02 3B 88 60 33 D9
0090 | 89 1A 15 D1 06 E2 ED 23 09 AD 61 4C 84 1B 2A 84
00A0 | 36 51 A1 2D 3A 5B 8A 43 C8 E3 B1 D2 1E D5 E0 9F
00B0 | CF DD 77 7A C2 0E EA 7D 01 4D 63 A8 20 3D 49 0A
00C0 | 51 7D 05 DD 1B 54 44 A0 98 DA B6 06 D2 A7 2E 4E
00D0 | 08 EF ED D4 1A 43 75 D3 62 13 9F 87 63 B6 25 5E
00E0 | 10 FC BE FC 64 4C A2 FC 25 ED 63 30 82 BB C7 85
00F0 | 2A 50 3C 4D 71 9E 4F 5B 7C 92 A6 98 BB 4C 2A CA
0100 | 99 DD 9C 7F 54 4C DB 31 B9 58 96 84 B5 78 5F 01
0110 | 3D 07 43 96 29 91 11 0C B5 AD 10 40 25 51 D5 B5
0120 | 55 14 FD DA 4D 0C E1 04 70 A4 5D 83 CB FA A4 57
0130 | C4 DD AA 3D BE 5C 0F B5 B3 87 B9 C5 1C 7C 02 65
0140 | 2B AB C0 F9 F8 7C 78 93 D9 32 21 C1 82 48 A2 69
0150 | 1E 06 2D B3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E4600900B7957267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045CBAEE61000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1555754593</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046265A513000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1650828563</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010080E429A94900A1AA791ECCED</code> <code>FF14F91675BAF387B2AD5CDD04BA054B</code> <code>BC4237728DA877323F9CEEF2AC0AF1B8</code> <code>CAFCDEDB37FA6C926391023B886033D9</code> <code>891A15D106E2ED2309AD614C841B2A84</code> <code>3651A12D3A5B8A43C8E3B1D21ED5E09F</code> <code>CFDD777AC20EEA7D014D63A8203D490A</code> <code>517D05DD1B5444A098DAB606D2A72E4E</code> <code>08EFEDD41A4375D362139F8763B6255E</code> <code>10FCBEFC644CA2FC25ED633082BBC785</code> <code>2A503C4D719E4F5B7C92A698BB4C2ACA</code> <code>99DD9C7F544CDB31B9589684B5785F01</code> <code>3D0743962991110CB5AD10402551D5B5</code> <code>5514FDDA4D0CE10470A45D83CBFAA457</code> <code>C4DDAA3DBE5C0FB5B387B9C51C7C0265</code> <code>2BABC0F9F87C7893D93221C18248A269</code><br> <code>1E062DB3</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 FC 44 60 B7 95 72 67
0010 | 78 02 00 00 5C 07 E8 D0 D2 C0 BB 42 D5 AE 94 65
0020 | 81 2B 7E 8B D8 D4 79 29 76 05 2B 6A 35 A2 B9 D9
0030 | F3 6B B7 49 B4 45 C6 55 FE 50 02 00 2C 78 A7 69
0040 | CC 8C BD E3 4C 48 40 32 8E 39 F6 F9 BD 5A 75 D5
0050 | C1 EE 90 6E F1 BD 2C B4 57 A7 37 AC 65 D6 F9 26
0060 | 59 96 7C 1A 59 D1 CE 88 B1 64 0C 04 C2 4A 4F 6C
0070 | 05 EE 28 A1 70 2E 59 7E D1 97 DB C4 7C 93 B9 4B
0080 | 27 91 E6 A0 D0 6D 3F 19 B2 CB 9C F9 A9 66 48 33
0090 | AD 91 83 63 1A C3 CE CD 4D 85 43 8B 0D 60 7E B8
00A0 | 36 8A 67 F5 1D 36 19 40 93 DF EE 1B 22 3B B4 D2
00B0 | C6 A5 63 84 28 2B 23 CB 45 FF 0A 39 E6 5F 4F 29
00C0 | 7D B7 0C C2 E4 3D 26 95 6C 89 2F 99 49 E7 41 50
00D0 | E8 EF 71 B2 71 4B 92 4F DF 35 D4 01 3B 13 7A A9
00E0 | 0F 68 40 D5 14 81 FB A8 A1 0D AC 98 DE BD F5 91
00F0 | D5 B4 1E 60 DC 54 1E 39 15 A0 53 50 86 9F 35 5B
0100 | A5 8F 5B 0C 81 44 1E 61 43 8E E4 5A C0 F7 4F A3
0110 | 0A EB A2 8C 1D 6A E6 5D 55 EA AC D4 AF 09 A3 84
0120 | 91 DF 8A 41 A5 CE E5 BC 89 E1 D9 C5 3A 47 55 90
0130 | D6 85 6A F4 3F 1D B5 72 88 C4 65 98 B4 BC ED CB
0140 | 01 B9 5E 6F 8E 0B FB 16 81 D0 6D 0F D8 B5 AB 3C
0150 | 70 90 8A FD 2D 7E EC B7 77 63 85 EB E2 7E 5D BF
0160 | D4 BB 7B 08 AF 24 3C 48 60 FE 46 C1 F0 7B 3C A9
0170 | 4F 20 27 79 2F 2F 7B C4 A6 A2 99 99 A2 5F 0B 3B
0180 | E1 81 BB EE 21 59 3C 14 97 4F 33 8C DA 2C A2 C7
0190 | 01 7C F0 1A D0 A3 C7 BC 17 20 A1 D1 5D C9 29 CF
01A0 | 3D D2 B0 66 86 97 75 F9 47 BC 62 29 2C 20 E0 D8
01B0 | B1 07 01 69 1B 23 6C FF C5 98 AB 54 9B 0F 6E 59
01C0 | FD B1 5E F4 B9 AE 7A F8 1B 22 A4 41 38 19 C8 D2
01D0 | BA CB 81 0E B2 EC 73 42 12 17 AB 2E 31 6A E7 E4
01E0 | E3 57 51 FE 70 32 3E 40 35 28 E7 5C 00 02 71 E3
01F0 | 27 67 09 A5 2D 61 ED 10 5D 13 97 37 00 F7 74 28
0200 | 29 29 99 CD 0C D0 0F FA 6D 3F 31 B6 F3 A3 5D 91
0210 | 9C 64 EB 2C 86 AF E0 92 59 28 2E AF EE FF 2C A0
0220 | B3 6E 4F 9C 8E DA C8 26 C6 88 24 94 3C A7 80 32
0230 | 07 32 C5 C1 B5 2E 1E E0 82 7F 65 79 68 1D 19 42
0240 | 49 B2 65 E2 E9 28 59 CF 2C C9 04 CC 88 C4 93 76
0250 | B4 34 BE 4B 7B C3 7B 1C 75 CB A5 47 2D 99 3A FC
0260 | 29 2F C7 3B F1 1A 22 98 25 73 E5 8F 43 B9 20 31
0270 | C8 CB 78 D6 0C 84 BD 78 75 1B 52 3F DD CC 20 84
0280 | F1 E9 32 2F F2 B1 73 87 D5 00 F4 89</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01FC4460B7957267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002002C78A769CC8CBDE34C484032</code> <code>8E39F6F9BD5A75D5C1EE906EF1BD2CB4</code> <code>57A737AC65D6F92659967C1A59D1CE88</code> <code>B1640C04C24A4F6C05EE28A1702E597E</code> <code>D197DBC47C93B94B2791E6A0D06D3F19</code> <code>B2CB9CF9A9664833AD9183631AC3CECD</code> <code>4D85438B0D607EB8368A67F51D361940</code> <code>93DFEE1B223BB4D2C6A56384282B23CB</code> <code>45FF0A39E65F4F297DB70CC2E43D2695</code> <code>6C892F9949E74150E8EF71B2714B924F</code> <code>DF35D4013B137AA90F6840D51481FBA8</code> <code>A10DAC98DEBDF591D5B41E60DC541E39</code> <code>15A05350869F355BA58F5B0C81441E61</code> <code>438EE45AC0F74FA30AEBA28C1D6AE65D</code> <code>55EAACD4AF09A38491DF8A41A5CEE5BC</code> <code>89E1D9C53A475590D6856AF43F1DB572</code> <code>88C46598B4BCEDCB01B95E6F8E0BFB16</code> <code>81D06D0FD8B5AB3C70908AFD2D7EECB7</code> <code>776385EBE27E5DBFD4BB7B08AF243C48</code> <code>60FE46C1F07B3CA94F2027792F2F7BC4</code> <code>A6A29999A25F0B3BE181BBEE21593C14</code> <code>974F338CDA2CA2C7017CF01AD0A3C7BC</code> <code>1720A1D15DC929CF3DD2B066869775F9</code> <code>47BC62292C20E0D8B10701691B236CFF</code> <code>C598AB549B0F6E59FDB15EF4B9AE7AF8</code> <code>1B22A4413819C8D2BACB810EB2EC7342</code> <code>1217AB2E316AE7E4E35751FE70323E40</code> <code>3528E75C000271E3276709A52D61ED10</code> <code>5D13973700F77428292999CD0CD00FFA</code> <code>6D3F31B6F3A35D919C64EB2C86AFE092</code> <code>59282EAFEEFF2CA0B36E4F9C8EDAC826</code> <code>C68824943CA780320732C5C1B52E1EE0</code> <code>827F6579681D194249B265E2E92859CF</code> <code>2CC904CC88C49376B434BE4B7BC37B1C</code> <code>75CBA5472D993AFC292FC73BF11A2298</code> <code>2573E58F43B92031C8CB78D60C84BD78</code> <code>751B523FDDCC2084F1E9322FF2B17387</code><br> <code>D500F489</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 2C78A769CC8CBDE34C4840328E39F6F9BD5A75D5C1EE906EF1BD2CB457A737AC65D6F92659967C1A59D1CE88B1640C04C24A4F6C05EE28A1702E597ED197DBC47C93B94B2791E6A0D06D3F19B2CB9CF9A9664833AD9183631AC3CECD4D85438B0D607EB8368A67F51D36194093DFEE1B223BB4D2C6A56384282B23CB45FF0A39E65F4F297DB70CC2E43D26956C892F9949E74150E8EF71B2714B924FDF35D4013B137AA90F6840D51481FBA8A10DAC98DEBDF591D5B41E60DC541E3915A05350869F355BA58F5B0C81441E61438EE45AC0F74FA30AEBA28C1D6AE65D55EAACD4AF09A38491DF8A41A5CEE5BC89E1D9C53A475590D6856AF43F1DB57288C46598B4BCEDCB01B95E6F8E0BFB1681D06D0FD8B5AB3C70908AFD2D7EECB7776385EBE27E5DBFD4BB7B08AF243C4860FE46C1F07B3CA94F2027792F2F7BC4A6A29999A25F0B3BE181BBEE21593C14974F338CDA2CA2C7017CF01AD0A3C7BC1720A1D15DC929CF3DD2B066869775F947BC62292C20E0D8B10701691B236CFFC598AB549B0F6E59FDB15EF4B9AE7AF81B22A4413819C8D2BACB810EB2EC73421217AB2E316AE7E4E35751FE70323E403528E75C000271E3276709A52D61ED105D13973700F77428292999CD0CD00FFA6D3F31B6F3A35D919C64EB2C86AFE09259282EAFEEFF2CA0B36E4F9C8EDAC826C68824943CA780320732C5C1B52E1EE0827F6579681D194249B265E2E92859CF2CC904CC88C49376B434BE4B7BC37B1C75CBA5472D993AFC292FC73BF11A22982573E58F43B92031C8CB78D60C84BD78751B523FDDCC2084F1E9322FF2B17387D500F489
tmp_aes_key = 6BCFCB17FD54E12071CC35D41809F813F93B48EF520FA22BEE1733E816A2D2E2
tmp_aes_iv = 65A06FAB09B3B8180CBB151CC79B46771A63768B5EEF2D717733499423F4F548</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = C65D3BC8C1F488B41AEBB2D90BC14DCED6B40580BA0D89B5D2C0BB42D5AE9465812B7E8BD8D4792976052B6A35A2B9D9F36BB749B445C65503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002137416851862E47031C8FE1FB53A996851D9081AF8ADD547DB67A8606355734C18CD936244251E834678D55BDAE28465556DD74EE54C98203502523F0C90108AC84B2C48B0614FCA2577DF6AF16F6AD1DC197F409DBE0B86CE1F8C1E370142C12B42274E1F2A396B144274C5911AD4D9247F2D4000961D08B671E56545714CF13597FBCBED99F071C2654F7032687B7A4576496502F1C8DF5574391E2966E89635AFF500E47D75C02AFAA018C54DFEBC7B82970A5AFA5BC624788956081578D0B5C1BB360F08826562321587490C6CFB52F40E3667337A18A5221E86C594D1BEB4981DB7321D6DB8A0702348EA8AB3BE273774AFA57C134F6E7709A0D799A33B795726732EE5E8C02D86209
answer = BA0D89B5D2C0BB42D5AE9465812B7E8BD8D4792976052B6A35A2B9D9F36BB749B445C65503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002137416851862E47031C8FE1FB53A996851D9081AF8ADD547DB67A8606355734C18CD936244251E834678D55BDAE28465556DD74EE54C98203502523F0C90108AC84B2C48B0614FCA2577DF6AF16F6AD1DC197F409DBE0B86CE1F8C1E370142C12B42274E1F2A396B144274C5911AD4D9247F2D4000961D08B671E56545714CF13597FBCBED99F071C2654F7032687B7A4576496502F1C8DF5574391E2966E89635AFF500E47D75C02AFAA018C54DFEBC7B82970A5AFA5BC624788956081578D0B5C1BB360F08826562321587490C6CFB52F40E3667337A18A5221E86C594D1BEB4981DB7321D6DB8A0702348EA8AB3BE273774AFA57C134F6E7709A0D799A33B795726732EE5E8C02D86209</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 D2 C0 BB 42 D5 AE 94 65 81 2B 7E 8B
0010 | D8 D4 79 29 76 05 2B 6A 35 A2 B9 D9 F3 6B B7 49
0020 | B4 45 C6 55 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 21 37 41 68 51 86 2E 47 03 1C 8F E1 FB 53 A9 96
0140 | 85 1D 90 81 AF 8A DD 54 7D B6 7A 86 06 35 57 34
0150 | C1 8C D9 36 24 42 51 E8 34 67 8D 55 BD AE 28 46
0160 | 55 56 DD 74 EE 54 C9 82 03 50 25 23 F0 C9 01 08
0170 | AC 84 B2 C4 8B 06 14 FC A2 57 7D F6 AF 16 F6 AD
0180 | 1D C1 97 F4 09 DB E0 B8 6C E1 F8 C1 E3 70 14 2C
0190 | 12 B4 22 74 E1 F2 A3 96 B1 44 27 4C 59 11 AD 4D
01A0 | 92 47 F2 D4 00 09 61 D0 8B 67 1E 56 54 57 14 CF
01B0 | 13 59 7F BC BE D9 9F 07 1C 26 54 F7 03 26 87 B7
01C0 | A4 57 64 96 50 2F 1C 8D F5 57 43 91 E2 96 6E 89
01D0 | 63 5A FF 50 0E 47 D7 5C 02 AF AA 01 8C 54 DF EB
01E0 | C7 B8 29 70 A5 AF A5 BC 62 47 88 95 60 81 57 8D
01F0 | 0B 5C 1B B3 60 F0 88 26 56 23 21 58 74 90 C6 CF
0200 | B5 2F 40 E3 66 73 37 A1 8A 52 21 E8 6C 59 4D 1B
0210 | EB 49 81 DB 73 21 D6 DB 8A 07 02 34 8E A8 AB 3B
0220 | E2 73 77 4A FA 57 C1 34 F6 E7 70 9A 0D 79 9A 33
0230 | B7 95 72 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001002137416851862E47031C8FE1</code> <code>FB53A996851D9081AF8ADD547DB67A86</code> <code>06355734C18CD936244251E834678D55</code> <code>BDAE28465556DD74EE54C98203502523</code> <code>F0C90108AC84B2C48B0614FCA2577DF6</code> <code>AF16F6AD1DC197F409DBE0B86CE1F8C1</code> <code>E370142C12B42274E1F2A396B144274C</code> <code>5911AD4D9247F2D4000961D08B671E56</code> <code>545714CF13597FBCBED99F071C2654F7</code> <code>032687B7A4576496502F1C8DF5574391</code> <code>E2966E89635AFF500E47D75C02AFAA01</code> <code>8C54DFEBC7B82970A5AFA5BC62478895</code> <code>6081578D0B5C1BB360F0882656232158</code> <code>7490C6CFB52F40E3667337A18A5221E8</code> <code>6C594D1BEB4981DB7321D6DB8A070234</code> <code>8EA8AB3BE273774AFA57C134F6E7709A</code><br> <code>0D799A33</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B7957267</code> (1735562679 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 8F6BC8FEEEA0A0D4324CED45102F32E5BC051B7D35497CDF8B8188E72B1752B10AC3880685B64157C03AA4217997A2462E85C3A024EE418AAB663BBEEA2BDE6530FB14193F52D3A2A967A3C5E7BB717053427186BDB35D0D922D8BA67536F400C4166191E534D19E5F8E1390B5BEB2E1C3B92FE7BE1E955C9E1614ACC718DC6FF4EFCF803DC962B654CDAF1E35143548C891E9914CA5C3F6B29F6E02D0F5BFECD0C3A65BA2167C5E39E2346D9D5BD63BFB9F28C392CB9B6132EA2D7E0C9FD07E82CFB1C012290B83F6F4FBDA6A5F877D332033E7B8C21B1B44703B8BF419B09AB8AA0B2E81E9148035ABAECA07C55E85A07662AAA481A14E58961465FD64DBD2</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 959623B4D45976E5AEFB8B8982179D21DF30BE33A037B008109D9A3928552E7A85F357FD10891DD906983BCB21963B0A078FAE07CAE824A1F29FDAB6B12790C6F0D16A48469AFB4BE90C6BA560BE0042311F374A7AD689196DDB393BFE3C7028493C708B13D4550413BD7DD05DD07DE457B396A4C66C03966DB86DE20672BC5F5E6CEF0EF89501519FFE34B4AD5DDA656191A709759EE303F2B917250E56C5E709BCFCCB99E41B50CFDA4D2CAEEB9A3F97026793D041BBB5439AA63B59FB07F6391F063F1D7B2AF907677079108F609D7C44F84CFF4F897D1B8634C8C5440DE4BB131DD48C89F4F6154B90A4D0A84AF546B174204607BD50E3D054A5BE6F2795</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 D2 C0 BB 42 D5 AE 94 65 81 2B 7E 8B
0010 | D8 D4 79 29 76 05 2B 6A 35 A2 B9 D9 F3 6B B7 49
0020 | B4 45 C6 55 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 95 96 23 B4 D4 59 76 E5 AE FB 8B 89 82 17 9D 21
0040 | DF 30 BE 33 A0 37 B0 08 10 9D 9A 39 28 55 2E 7A
0050 | 85 F3 57 FD 10 89 1D D9 06 98 3B CB 21 96 3B 0A
0060 | 07 8F AE 07 CA E8 24 A1 F2 9F DA B6 B1 27 90 C6
0070 | F0 D1 6A 48 46 9A FB 4B E9 0C 6B A5 60 BE 00 42
0080 | 31 1F 37 4A 7A D6 89 19 6D DB 39 3B FE 3C 70 28
0090 | 49 3C 70 8B 13 D4 55 04 13 BD 7D D0 5D D0 7D E4
00A0 | 57 B3 96 A4 C6 6C 03 96 6D B8 6D E2 06 72 BC 5F
00B0 | 5E 6C EF 0E F8 95 01 51 9F FE 34 B4 AD 5D DA 65
00C0 | 61 91 A7 09 75 9E E3 03 F2 B9 17 25 0E 56 C5 E7
00D0 | 09 BC FC CB 99 E4 1B 50 CF DA 4D 2C AE EB 9A 3F
00E0 | 97 02 67 93 D0 41 BB B5 43 9A A6 3B 59 FB 07 F6
00F0 | 39 1F 06 3F 1D 7B 2A F9 07 67 70 79 10 8F 60 9D
0100 | 7C 44 F8 4C FF 4F 89 7D 1B 86 34 C8 C5 44 0D E4
0110 | BB 13 1D D4 8C 89 F4 F6 15 4B 90 A4 D0 A8 4A F5
0120 | 46 B1 74 20 46 07 BD 50 E3 D0 54 A5 BE 6F 27 95</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100959623B4D45976E5AEFB8B89</code> <code>82179D21DF30BE33A037B008109D9A39</code> <code>28552E7A85F357FD10891DD906983BCB</code> <code>21963B0A078FAE07CAE824A1F29FDAB6</code> <code>B12790C6F0D16A48469AFB4BE90C6BA5</code> <code>60BE0042311F374A7AD689196DDB393B</code> <code>FE3C7028493C708B13D4550413BD7DD0</code> <code>5DD07DE457B396A4C66C03966DB86DE2</code> <code>0672BC5F5E6CEF0EF89501519FFE34B4</code> <code>AD5DDA656191A709759EE303F2B91725</code> <code>0E56C5E709BCFCCB99E41B50CFDA4D2C</code> <code>AEEB9A3F97026793D041BBB5439AA63B</code> <code>59FB07F6391F063F1D7B2AF907677079</code> <code>108F609D7C44F84CFF4F897D1B8634C8</code> <code>C5440DE4BB131DD48C89F4F6154B90A4</code> <code>D0A84AF546B174204607BD50E3D054A5</code><br> <code>BE6F2795</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366D2C0BB42D5AE9465812B7E8BD8D4792976052B6A35A2B9D9F36BB749B445C6550000000000000000FE000100959623B4D45976E5AEFB8B8982179D21DF30BE33A037B008109D9A3928552E7A85F357FD10891DD906983BCB21963B0A078FAE07CAE824A1F29FDAB6B12790C6F0D16A48469AFB4BE90C6BA560BE0042311F374A7AD689196DDB393BFE3C7028493C708B13D4550413BD7DD05DD07DE457B396A4C66C03966DB86DE20672BC5F5E6CEF0EF89501519FFE34B4AD5DDA656191A709759EE303F2B917250E56C5E709BCFCCB99E41B50CFDA4D2CAEEB9A3F97026793D041BBB5439AA63B59FB07F6391F063F1D7B2AF907677079108F609D7C44F84CFF4F897D1B8634C8C5440DE4BB131DD48C89F4F6154B90A4D0A84AF546B174204607BD50E3D054A5BE6F2795
padding = 78E4635E5B3B84AA510A6685
tmp_aes_key = 6BCFCB17FD54E12071CC35D41809F813F93B48EF520FA22BEE1733E816A2D2E2
tmp_aes_iv = 65A06FAB09B3B8180CBB151CC79B46771A63768B5EEF2D717733499423F4F548</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 04E0A07C00CB1D87CD9A85067C8257B3FC0B649B349376F49308425C58DFD9CB95E1FEA45E416A5E7EBFF10C381DE3150F958835159979872406F4DD24BB2BA6719B125CE572E222B1A32079A998AB2BE5BB2A7D2E89D3F7488D4EC3B265E6D15F507700917C952BD6BA3974DF884F4E015AA649B1F83C39A719C80B822A292C5468893883A0319F7172FD2D61488DD14C2A5DC3EAD197FB78C1694DB5BB3F0B2BB65D1D46F9E4D9E9FBB1AECDB2193D253C1C7F62EA3066F76BC3FE5F1A81CFBA5F2A1EC1E7499513B3FF28304439E382FAB52980E158B867B8DD757B3C0996E30169256E838A21800636A3776B3AA161E9465F516990EF1AE79B41DC57EAFE1629358855374D0F33D8BB50866017E45F4F0EEA08AB9B5316410ABD7F57036A0FF0544245CC52B5B2A1A80CA993E85C6EE1F0C118077F9B61CEEFE79E526C3874E779C5A5A47DA59E69FF7BA24F0F87</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 EE 0A 00 B7 95 72 67
0010 | 78 01 00 00 1F 5F 04 F5 D2 C0 BB 42 D5 AE 94 65
0020 | 81 2B 7E 8B D8 D4 79 29 76 05 2B 6A 35 A2 B9 D9
0030 | F3 6B B7 49 B4 45 C6 55 FE 50 01 00 04 E0 A0 7C
0040 | 00 CB 1D 87 CD 9A 85 06 7C 82 57 B3 FC 0B 64 9B
0050 | 34 93 76 F4 93 08 42 5C 58 DF D9 CB 95 E1 FE A4
0060 | 5E 41 6A 5E 7E BF F1 0C 38 1D E3 15 0F 95 88 35
0070 | 15 99 79 87 24 06 F4 DD 24 BB 2B A6 71 9B 12 5C
0080 | E5 72 E2 22 B1 A3 20 79 A9 98 AB 2B E5 BB 2A 7D
0090 | 2E 89 D3 F7 48 8D 4E C3 B2 65 E6 D1 5F 50 77 00
00A0 | 91 7C 95 2B D6 BA 39 74 DF 88 4F 4E 01 5A A6 49
00B0 | B1 F8 3C 39 A7 19 C8 0B 82 2A 29 2C 54 68 89 38
00C0 | 83 A0 31 9F 71 72 FD 2D 61 48 8D D1 4C 2A 5D C3
00D0 | EA D1 97 FB 78 C1 69 4D B5 BB 3F 0B 2B B6 5D 1D
00E0 | 46 F9 E4 D9 E9 FB B1 AE CD B2 19 3D 25 3C 1C 7F
00F0 | 62 EA 30 66 F7 6B C3 FE 5F 1A 81 CF BA 5F 2A 1E
0100 | C1 E7 49 95 13 B3 FF 28 30 44 39 E3 82 FA B5 29
0110 | 80 E1 58 B8 67 B8 DD 75 7B 3C 09 96 E3 01 69 25
0120 | 6E 83 8A 21 80 06 36 A3 77 6B 3A A1 61 E9 46 5F
0130 | 51 69 90 EF 1A E7 9B 41 DC 57 EA FE 16 29 35 88
0140 | 55 37 4D 0F 33 D8 BB 50 86 60 17 E4 5F 4F 0E EA
0150 | 08 AB 9B 53 16 41 0A BD 7F 57 03 6A 0F F0 54 42
0160 | 45 CC 52 B5 B2 A1 A8 0C A9 93 E8 5C 6E E1 F0 C1
0170 | 18 07 7F 9B 61 CE EF E7 9E 52 6C 38 74 E7 79 C5
0180 | A5 A4 7D A5 9E 69 FF 7B A2 4F 0F 87</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A8EE0A00B7957267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010004E0A07C00CB1D87CD9A8506</code> <code>7C8257B3FC0B649B349376F49308425C</code> <code>58DFD9CB95E1FEA45E416A5E7EBFF10C</code> <code>381DE3150F958835159979872406F4DD</code> <code>24BB2BA6719B125CE572E222B1A32079</code> <code>A998AB2BE5BB2A7D2E89D3F7488D4EC3</code> <code>B265E6D15F507700917C952BD6BA3974</code> <code>DF884F4E015AA649B1F83C39A719C80B</code> <code>822A292C5468893883A0319F7172FD2D</code> <code>61488DD14C2A5DC3EAD197FB78C1694D</code> <code>B5BB3F0B2BB65D1D46F9E4D9E9FBB1AE</code> <code>CDB2193D253C1C7F62EA3066F76BC3FE</code> <code>5F1A81CFBA5F2A1EC1E7499513B3FF28</code> <code>304439E382FAB52980E158B867B8DD75</code> <code>7B3C0996E30169256E838A21800636A3</code> <code>776B3AA161E9465F516990EF1AE79B41</code> <code>DC57EAFE1629358855374D0F33D8BB50</code> <code>866017E45F4F0EEA08AB9B5316410ABD</code> <code>7F57036A0FF0544245CC52B5B2A1A80C</code> <code>A993E85C6EE1F0C118077F9B61CEEFE7</code> <code>9E526C3874E779C5A5A47DA59E69FF7B</code><br> <code>A24F0F87</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 962F98EA38015BAA86231D27DEDCC0D61C50581F19A90E506E8A3F81FE68C872269CA8BD6598729580E9EEC7C2FE249129AED3BFF16C0F7BE11F7FF848A1FD406A60C6B8B35FBE6688283D0DB87B603A92E600E076F431CDB2E4A7B9757CB066B58B744371949E0A1DBC3F6B4DA1E360E50B43E7418D8270FC25742525E7B1114CD7C4584ACE324D603CA077C5FE4345C0A253965DA099DA111F0C387B299E93B5392E1CC35615242F3903A10CA8ABCD30E2E1E9570732E9B06795CD5CF2E4A57997F0EB1E536008E1C1200CFD9EB566CDBECD193B7F4F45DED19D811D4C0AA0EE7B69917DD332C554A65E98975F3FAECA4C509B0C2F74EDF4CD796126968D3C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 74 0E D5 B8 95 72 67
0010 | 34 00 00 00 34 F7 CB 3B D2 C0 BB 42 D5 AE 94 65
0020 | 81 2B 7E 8B D8 D4 79 29 76 05 2B 6A 35 A2 B9 D9
0030 | F3 6B B7 49 B4 45 C6 55 2B 56 24 7D B4 61 6C E9
0040 | 38 74 AE F3 24 28 CB CE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01740ED5B8957267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2C0BB42D5AE9465812B7E8BD8D47929</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>76052B6A35A2B9D9F36BB749B445C655</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>2B56247DB4616CE93874AEF32428CBCE</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

