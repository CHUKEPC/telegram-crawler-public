<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 54 FF 09 00 79 5A 99 66
0010 | 14 00 00 00 F1 8E 7E BE 66 1D B0 4F 07 59 BA 01
0020 | 12 AF 0F 39 23 A2 49 6C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>54FF0900795A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D8 D9 E7 79 5A 99 66
0010 | 9C 00 00 00 63 24 16 05 66 1D B0 4F 07 59 BA 01
0020 | 12 AF 0F 39 23 A2 49 6C 48 E1 4C F6 49 34 95 00
0030 | BF 9F 7D B9 A9 72 79 46 08 19 21 50 1D 5D 3E A3
0040 | CF 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D8D9E7795A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>9C000000</code> (156 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081921501D5D3EA3CF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1810816612228309967</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1810816612228309967</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1810816612228309967 = 1033917223 * 1751413529</code></p>
<pre><code>p = 1033917223
q = 1751413529</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 21 50 1D 5D 3E A3 CF 00 00 00
0010 | 04 3D A0 53 27 00 00 00 04 68 64 73 19 00 00 00
0020 | 66 1D B0 4F 07 59 BA 01 12 AF 0F 39 23 A2 49 6C
0030 | 48 E1 4C F6 49 34 95 00 BF 9F 7D B9 A9 72 79 46
0040 | 3E 94 B4 C7 15 50 62 E6 79 67 69 11 C8 FC BD BC
0050 | 95 A7 51 29 76 08 24 0F 37 85 4B D2 EE 49 FA 54
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081921501D5D3EA3CF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1810816612228309967</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043DA05327000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1033917223</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0468647319000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1751413529</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>3E94B4C7155062E679676911C8FCBDBC</code> <code>95A751297608240F37854BD2EE49FA54</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081921501D5D3EA3CF000000043DA053270000000468647319000000661DB04F0759BA0112AF0F3923A2496C48E14CF649349500BF9F7DB9A97279463E94B4C7155062E679676911C8FCBDBC95A751297608240F37854BD2EE49FA5402000000
random_padding_bytes = 31BFA2AA3B357FDD3EF1EA929237378B200028E8B0FDC23E2EF673A3094EC21A83792D7FF69B33BFBEAB21F45027437CF1F0E78FF5497A14237020FD926EA26A242F5EF3F0C9040D56D188093366EFB6EDDB66D14B649F6F37C98BD2</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 9410F5D93A9A4109250C5365EDA96FB3D5D5300941DE02D63C5C2F17FF90A38A8A77B9E0A39AFBDA45112C814007A8F5B4EB950F6745CC9797542C7B619DC6CE2E81CB19A2C63ED565C54BDAABE1E22584AFA3E1FFB50B625A756A64AD00F11511C41C70A1F27E9E3CFCE86581FBCBE32DAB4A756383234BAA3DD2C5B76D68E58E2997D60D9099722D866784AFD2788F1362B7A77B60929F6AF7264121C688EFC2045E1AAA158A29C376236B6F1CB97812BAA14C354DC03C567E566A221E598FC1FADA42AE3239E6E572EDACCD2EADD99B39C573DD015BF5872B1EC41E4C9DB12230AD5CF0B5B1EB9D92AD832B1CD58A43B46CB9A0B88475A86276C7E5FFD1B3</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 04 E6 03 00 7A 5A 99 66
0010 | 40 01 00 00 BE E4 12 D7 66 1D B0 4F 07 59 BA 01
0020 | 12 AF 0F 39 23 A2 49 6C 48 E1 4C F6 49 34 95 00
0030 | BF 9F 7D B9 A9 72 79 46 04 3D A0 53 27 00 00 00
0040 | 04 68 64 73 19 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 94 10 F5 D9 3A 9A 41 09 25 0C 53 65
0060 | ED A9 6F B3 D5 D5 30 09 41 DE 02 D6 3C 5C 2F 17
0070 | FF 90 A3 8A 8A 77 B9 E0 A3 9A FB DA 45 11 2C 81
0080 | 40 07 A8 F5 B4 EB 95 0F 67 45 CC 97 97 54 2C 7B
0090 | 61 9D C6 CE 2E 81 CB 19 A2 C6 3E D5 65 C5 4B DA
00A0 | AB E1 E2 25 84 AF A3 E1 FF B5 0B 62 5A 75 6A 64
00B0 | AD 00 F1 15 11 C4 1C 70 A1 F2 7E 9E 3C FC E8 65
00C0 | 81 FB CB E3 2D AB 4A 75 63 83 23 4B AA 3D D2 C5
00D0 | B7 6D 68 E5 8E 29 97 D6 0D 90 99 72 2D 86 67 84
00E0 | AF D2 78 8F 13 62 B7 A7 7B 60 92 9F 6A F7 26 41
00F0 | 21 C6 88 EF C2 04 5E 1A AA 15 8A 29 C3 76 23 6B
0100 | 6F 1C B9 78 12 BA A1 4C 35 4D C0 3C 56 7E 56 6A
0110 | 22 1E 59 8F C1 FA DA 42 AE 32 39 E6 E5 72 ED AC
0120 | CD 2E AD D9 9B 39 C5 73 DD 01 5B F5 87 2B 1E C4
0130 | 1E 4C 9D B1 22 30 AD 5C F0 B5 B1 EB 9D 92 AD 83
0140 | 2B 1C D5 8A 43 B4 6C B9 A0 B8 84 75 A8 62 76 C7
0150 | E5 FF D1 B3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>04E603007A5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043DA05327000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1033917223</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0468647319000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1751413529</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001009410F5D93A9A4109250C5365</code> <code>EDA96FB3D5D5300941DE02D63C5C2F17</code> <code>FF90A38A8A77B9E0A39AFBDA45112C81</code> <code>4007A8F5B4EB950F6745CC9797542C7B</code> <code>619DC6CE2E81CB19A2C63ED565C54BDA</code> <code>ABE1E22584AFA3E1FFB50B625A756A64</code> <code>AD00F11511C41C70A1F27E9E3CFCE865</code> <code>81FBCBE32DAB4A756383234BAA3DD2C5</code> <code>B76D68E58E2997D60D9099722D866784</code> <code>AFD2788F1362B7A77B60929F6AF72641</code> <code>21C688EFC2045E1AAA158A29C376236B</code> <code>6F1CB97812BAA14C354DC03C567E566A</code> <code>221E598FC1FADA42AE3239E6E572EDAC</code> <code>CD2EADD99B39C573DD015BF5872B1EC4</code> <code>1E4C9DB12230AD5CF0B5B1EB9D92AD83</code> <code>2B1CD58A43B46CB9A0B88475A86276C7</code><br> <code>E5FFD1B3</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 4B B0 7A 5A 99 66
0010 | A0 02 00 00 5C 07 E8 D0 66 1D B0 4F 07 59 BA 01
0020 | 12 AF 0F 39 23 A2 49 6C 48 E1 4C F6 49 34 95 00
0030 | BF 9F 7D B9 A9 72 79 46 FE 50 02 00 69 69 7F CB
0040 | CC F9 EB 24 42 5B 5B 30 76 04 D9 6A A6 49 F1 92
0050 | C6 1A B1 DB 31 31 3D 71 E4 A4 C5 BC 86 A4 FC 06
0060 | 84 5E A4 BF 7D F4 58 B5 B5 2B BF 5F 1B 3D 4F 21
0070 | 25 41 01 F6 62 20 D3 4B 40 15 36 EF 73 E9 10 FB
0080 | 2A D4 50 EE 2A B1 93 98 24 60 8E C6 3E 4F 28 A1
0090 | 7C BD CD CA AE F3 56 7B DF 42 AB 18 5E 99 9D 04
00A0 | 85 FC 58 5E 9F CA BB 5E B0 B5 BB CB F0 2F E2 D1
00B0 | D2 E3 9E 7B 81 9A E0 C6 3E B2 2A 96 67 B7 4E B5
00C0 | 5E BB 53 A6 9D 62 AB 13 C6 53 39 CA 0D 97 38 92
00D0 | 8D D6 73 31 2B E3 63 2B 54 2D 81 DB 45 6D BB 2C
00E0 | 3D 9C 51 6B E0 27 0C A0 00 52 42 C2 67 2D 71 FC
00F0 | 6F C0 00 67 9C 3E 9D 4B 00 C7 12 23 F5 FA 27 97
0100 | E2 D4 2A FE 73 95 EB 21 2B AA 8B 4F 2F 72 B1 74
0110 | 73 94 0B 06 69 AF 93 26 4B 5D 84 D5 C6 FD 92 82
0120 | 5B 7C 2D A6 5B 13 D8 91 1C E3 4A 2D BD 0B 97 74
0130 | 50 A9 35 A5 5A D6 A9 40 11 8A EF 5B A2 87 2C 0C
0140 | 70 33 FA CC 9B 53 AC 27 D7 F5 4B 8C 2F FD 43 F9
0150 | DF 45 D2 4C A7 10 70 77 3E A0 91 EB 8A A6 99 01
0160 | 19 94 C7 29 69 F1 10 0F 3C 49 5E 91 B6 67 5C 2B
0170 | 08 0D 6F 05 1C 3E 11 60 77 A1 00 57 53 47 5D 8C
0180 | EC B7 E8 3B 9C 7B BD 23 2F 14 7D 55 A1 33 6B 65
0190 | 45 CF 9A 0D FF 6C F7 00 B7 65 67 6B 75 D9 EF 53
01A0 | 5B 98 39 49 52 1F 76 3E 8D DD FC 29 EC ED D0 A9
01B0 | 65 DC B3 A7 11 A4 95 CA 88 22 9F 51 3B 70 F2 DF
01C0 | 36 55 D6 6F 39 1F F6 95 09 B1 D7 78 7B 21 36 BB
01D0 | C8 84 46 50 09 DA 7D B2 62 EB E4 9F C3 8E 16 75
01E0 | CF EF 0E A6 15 18 ED 42 9A 99 D7 7A B0 00 F7 42
01F0 | AA 53 E3 78 2F 03 DC FF 15 19 02 B1 A8 75 05 1C
0200 | 2C 90 12 7D 57 78 8D 96 35 53 1C A3 11 54 C9 8D
0210 | 84 02 E0 26 05 5C 68 14 6B F7 E1 61 E0 A8 47 EB
0220 | 87 5C 3E 90 43 90 0C 1B 50 44 9E 57 07 2F 31 B9
0230 | 63 69 22 6A BA 5C 04 B7 E2 19 EC 2B D5 7D E7 4C
0240 | B5 49 41 E8 D7 B4 3F 28 49 03 FF 8A 79 35 71 08
0250 | D6 BF B4 99 71 CF 77 B7 DF CF D8 4D E7 6E DF 37
0260 | 11 AF C2 7E CB EF ED E2 E6 22 A9 C6 64 57 4F 80
0270 | 37 BD A9 D1 C4 8A 26 76 D8 FD 3B 64 A7 0D 99 EE
0280 | 2F 42 17 54 B3 B1 56 44 6B F3 E5 5B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B44BB07A5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A0020000</code> (672 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020069697FCBCCF9EB24425B5B30</code> <code>7604D96AA649F192C61AB1DB31313D71</code> <code>E4A4C5BC86A4FC06845EA4BF7DF458B5</code> <code>B52BBF5F1B3D4F21254101F66220D34B</code> <code>401536EF73E910FB2AD450EE2AB19398</code> <code>24608EC63E4F28A17CBDCDCAAEF3567B</code> <code>DF42AB185E999D0485FC585E9FCABB5E</code> <code>B0B5BBCBF02FE2D1D2E39E7B819AE0C6</code> <code>3EB22A9667B74EB55EBB53A69D62AB13</code> <code>C65339CA0D9738928DD673312BE3632B</code> <code>542D81DB456DBB2C3D9C516BE0270CA0</code> <code>005242C2672D71FC6FC000679C3E9D4B</code> <code>00C71223F5FA2797E2D42AFE7395EB21</code> <code>2BAA8B4F2F72B17473940B0669AF9326</code> <code>4B5D84D5C6FD92825B7C2DA65B13D891</code> <code>1CE34A2DBD0B977450A935A55AD6A940</code> <code>118AEF5BA2872C0C7033FACC9B53AC27</code> <code>D7F54B8C2FFD43F9DF45D24CA7107077</code> <code>3EA091EB8AA699011994C72969F1100F</code> <code>3C495E91B6675C2B080D6F051C3E1160</code> <code>77A1005753475D8CECB7E83B9C7BBD23</code> <code>2F147D55A1336B6545CF9A0DFF6CF700</code> <code>B765676B75D9EF535B983949521F763E</code> <code>8DDDFC29ECEDD0A965DCB3A711A495CA</code> <code>88229F513B70F2DF3655D66F391FF695</code> <code>09B1D7787B2136BBC884465009DA7DB2</code> <code>62EBE49FC38E1675CFEF0EA61518ED42</code> <code>9A99D77AB000F742AA53E3782F03DCFF</code> <code>151902B1A875051C2C90127D57788D96</code> <code>35531CA31154C98D8402E026055C6814</code> <code>6BF7E161E0A847EB875C3E9043900C1B</code> <code>50449E57072F31B96369226ABA5C04B7</code> <code>E219EC2BD57DE74CB54941E8D7B43F28</code> <code>4903FF8A79357108D6BFB49971CF77B7</code> <code>DFCFD84DE76EDF3711AFC27ECBEFEDE2</code> <code>E622A9C664574F8037BDA9D1C48A2676</code> <code>D8FD3B64A70D99EE2F421754B3B15644</code><br> <code>6BF3E55B</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 69697FCBCCF9EB24425B5B307604D96AA649F192C61AB1DB31313D71E4A4C5BC86A4FC06845EA4BF7DF458B5B52BBF5F1B3D4F21254101F66220D34B401536EF73E910FB2AD450EE2AB1939824608EC63E4F28A17CBDCDCAAEF3567BDF42AB185E999D0485FC585E9FCABB5EB0B5BBCBF02FE2D1D2E39E7B819AE0C63EB22A9667B74EB55EBB53A69D62AB13C65339CA0D9738928DD673312BE3632B542D81DB456DBB2C3D9C516BE0270CA0005242C2672D71FC6FC000679C3E9D4B00C71223F5FA2797E2D42AFE7395EB212BAA8B4F2F72B17473940B0669AF93264B5D84D5C6FD92825B7C2DA65B13D8911CE34A2DBD0B977450A935A55AD6A940118AEF5BA2872C0C7033FACC9B53AC27D7F54B8C2FFD43F9DF45D24CA71070773EA091EB8AA699011994C72969F1100F3C495E91B6675C2B080D6F051C3E116077A1005753475D8CECB7E83B9C7BBD232F147D55A1336B6545CF9A0DFF6CF700B765676B75D9EF535B983949521F763E8DDDFC29ECEDD0A965DCB3A711A495CA88229F513B70F2DF3655D66F391FF69509B1D7787B2136BBC884465009DA7DB262EBE49FC38E1675CFEF0EA61518ED429A99D77AB000F742AA53E3782F03DCFF151902B1A875051C2C90127D57788D9635531CA31154C98D8402E026055C68146BF7E161E0A847EB875C3E9043900C1B50449E57072F31B96369226ABA5C04B7E219EC2BD57DE74CB54941E8D7B43F284903FF8A79357108D6BFB49971CF77B7DFCFD84DE76EDF3711AFC27ECBEFEDE2E622A9C664574F8037BDA9D1C48A2676D8FD3B64A70D99EE2F421754B3B156446BF3E55B
tmp_aes_key = C0AE07F359E603AE019348325A3FE140E375F720C5C6D2C10AEB06CA0E4D9D57
tmp_aes_iv = 451C92CCB113C91BD2488002975E2504B0186EE1450111840D5906603E94B4C7</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 288147F1BCF11685D3569711433F906477CA224EBA0D89B5661DB04F0759BA0112AF0F3923A2496C48E14CF649349500BF9F7DB9A972794603000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000E1D6A0D29F32896B87BE1029282AD002A22DE92A01C8DDF79911C5B2463F322B23905813FAED87A96162ABA0D7A7D8CE5F46BB5B99FB16932F2558AEE499B8B66C0C8176583139D279BEBBFF40238DC124D4380E060EDEB449D5C7C04A975EA334B26B0E5871A89F0FEC564F42CFD6159AEE5FAE5FFC9147495F69E0EBE6E70E290E73B1FEDFBA9AA91BA354A97454C999D2F43ADF058DDC87756C9CD2CE06D225AF0D362295B40126358A6BBD8B83BA7F4A8D312B81FAF0D035E93E0CEA19BCD82AEBD527EBD993D964DEE9295039968E7C22CC922B89803AB79E8F2672C3AA1F35817CB301A270E783359317F244641901CF9AEA5854D10DC5E74146D2C9C7A5A99668465683E46BBA9BA
answer = BA0D89B5661DB04F0759BA0112AF0F3923A2496C48E14CF649349500BF9F7DB9A972794603000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000E1D6A0D29F32896B87BE1029282AD002A22DE92A01C8DDF79911C5B2463F322B23905813FAED87A96162ABA0D7A7D8CE5F46BB5B99FB16932F2558AEE499B8B66C0C8176583139D279BEBBFF40238DC124D4380E060EDEB449D5C7C04A975EA334B26B0E5871A89F0FEC564F42CFD6159AEE5FAE5FFC9147495F69E0EBE6E70E290E73B1FEDFBA9AA91BA354A97454C999D2F43ADF058DDC87756C9CD2CE06D225AF0D362295B40126358A6BBD8B83BA7F4A8D312B81FAF0D035E93E0CEA19BCD82AEBD527EBD993D964DEE9295039968E7C22CC922B89803AB79E8F2672C3AA1F35817CB301A270E783359317F244641901CF9AEA5854D10DC5E74146D2C9C7A5A99668465683E46BBA9BA</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 66 1D B0 4F 07 59 BA 01 12 AF 0F 39
0010 | 23 A2 49 6C 48 E1 4C F6 49 34 95 00 BF 9F 7D B9
0020 | A9 72 79 46 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 0E 1D 6A 0D 29 F3 28 96 B8 7B E1 02 92 82 AD 00
0140 | 2A 22 DE 92 A0 1C 8D DF 79 91 1C 5B 24 63 F3 22
0150 | B2 39 05 81 3F AE D8 7A 96 16 2A BA 0D 7A 7D 8C
0160 | E5 F4 6B B5 B9 9F B1 69 32 F2 55 8A EE 49 9B 8B
0170 | 66 C0 C8 17 65 83 13 9D 27 9B EB BF F4 02 38 DC
0180 | 12 4D 43 80 E0 60 ED EB 44 9D 5C 7C 04 A9 75 EA
0190 | 33 4B 26 B0 E5 87 1A 89 F0 FE C5 64 F4 2C FD 61
01A0 | 59 AE E5 FA E5 FF C9 14 74 95 F6 9E 0E BE 6E 70
01B0 | E2 90 E7 3B 1F ED FB A9 AA 91 BA 35 4A 97 45 4C
01C0 | 99 9D 2F 43 AD F0 58 DD C8 77 56 C9 CD 2C E0 6D
01D0 | 22 5A F0 D3 62 29 5B 40 12 63 58 A6 BB D8 B8 3B
01E0 | A7 F4 A8 D3 12 B8 1F AF 0D 03 5E 93 E0 CE A1 9B
01F0 | CD 82 AE BD 52 7E BD 99 3D 96 4D EE 92 95 03 99
0200 | 68 E7 C2 2C C9 22 B8 98 03 AB 79 E8 F2 67 2C 3A
0210 | A1 F3 58 17 CB 30 1A 27 0E 78 33 59 31 7F 24 46
0220 | 41 90 1C F9 AE A5 85 4D 10 DC 5E 74 14 6D 2C 9C
0230 | 7A 5A 99 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001000E1D6A0D29F32896B87BE102</code> <code>9282AD002A22DE92A01C8DDF79911C5B</code> <code>2463F322B23905813FAED87A96162ABA</code> <code>0D7A7D8CE5F46BB5B99FB16932F2558A</code> <code>EE499B8B66C0C8176583139D279BEBBF</code> <code>F40238DC124D4380E060EDEB449D5C7C</code> <code>04A975EA334B26B0E5871A89F0FEC564</code> <code>F42CFD6159AEE5FAE5FFC9147495F69E</code> <code>0EBE6E70E290E73B1FEDFBA9AA91BA35</code> <code>4A97454C999D2F43ADF058DDC87756C9</code> <code>CD2CE06D225AF0D362295B40126358A6</code> <code>BBD8B83BA7F4A8D312B81FAF0D035E93</code> <code>E0CEA19BCD82AEBD527EBD993D964DEE</code> <code>9295039968E7C22CC922B89803AB79E8</code> <code>F2672C3AA1F35817CB301A270E783359</code> <code>317F244641901CF9AEA5854D10DC5E74</code><br> <code>146D2C9C</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>7A5A9966</code> (1721326202 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 7F05A4B15B741C1834C735E6B52AB5443DED56A3D19D706672BA26E7F73A50FC735AF8E1DA3DD8274C2C690B667C38B5E202DBE5DF792E81D2D2931C41ADECECA65DE1621485E91FA42E57D3E97D421488EACEC1EE30B23F00EB65F6A582DA051CC9CD9A842171E471BD8528147D03251E24664667CCEE3B8041DDBA989F301CAAB532654263175053D75BF90551B82F3D8FDADE12628F54B79B171E50417B5F334F66394C8A252961C69004851E49933DF6D46D82CC1DD0F9A3E0F7CEEC8219729EEB7A4BC5F333989D1C60D4498E2C73C98B640555C09A376BC94B70FFAE8EC00E131E1D598A6999386E4EAFB22A5EC1D0B9349D8C365C559669A4C559AC0E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 830BF0AF2872BCAC62E7F6841937C7A2135D5988388BE5009309EA76974A290AFE797EC420AC562B972A1ECB110C8A475352C8EC1ADD022BE5612E9405541E2EED8FDF1296BB9EB31E8ADCBB81413D61D6CD8308D97D73718289BBFFBEE77305D3B8675FEF2676F003A71A0B112EB5776521DF16AC27025C73DBA12F1E91E713C650C9F905181E549BB1551BDAA84F2051D079FED5D81CEAA1DCA4A34DAF6E5D1477C4A88B727C1780C918AA5172A92EE417500D568DF1F00CF16223713C5F72FE7A9C534AD83AD331B6468A97030CAA344310C955128F950055FB7A10434F1ED310BD9422236595467B50A6B3E5DA33A1F2E859C2273657739CA8CCE70C3C1C</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 66 1D B0 4F 07 59 BA 01 12 AF 0F 39
0010 | 23 A2 49 6C 48 E1 4C F6 49 34 95 00 BF 9F 7D B9
0020 | A9 72 79 46 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 83 0B F0 AF 28 72 BC AC 62 E7 F6 84 19 37 C7 A2
0040 | 13 5D 59 88 38 8B E5 00 93 09 EA 76 97 4A 29 0A
0050 | FE 79 7E C4 20 AC 56 2B 97 2A 1E CB 11 0C 8A 47
0060 | 53 52 C8 EC 1A DD 02 2B E5 61 2E 94 05 54 1E 2E
0070 | ED 8F DF 12 96 BB 9E B3 1E 8A DC BB 81 41 3D 61
0080 | D6 CD 83 08 D9 7D 73 71 82 89 BB FF BE E7 73 05
0090 | D3 B8 67 5F EF 26 76 F0 03 A7 1A 0B 11 2E B5 77
00A0 | 65 21 DF 16 AC 27 02 5C 73 DB A1 2F 1E 91 E7 13
00B0 | C6 50 C9 F9 05 18 1E 54 9B B1 55 1B DA A8 4F 20
00C0 | 51 D0 79 FE D5 D8 1C EA A1 DC A4 A3 4D AF 6E 5D
00D0 | 14 77 C4 A8 8B 72 7C 17 80 C9 18 AA 51 72 A9 2E
00E0 | E4 17 50 0D 56 8D F1 F0 0C F1 62 23 71 3C 5F 72
00F0 | FE 7A 9C 53 4A D8 3A D3 31 B6 46 8A 97 03 0C AA
0100 | 34 43 10 C9 55 12 8F 95 00 55 FB 7A 10 43 4F 1E
0110 | D3 10 BD 94 22 23 65 95 46 7B 50 A6 B3 E5 DA 33
0120 | A1 F2 E8 59 C2 27 36 57 73 9C A8 CC E7 0C 3C 1C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100830BF0AF2872BCAC62E7F684</code> <code>1937C7A2135D5988388BE5009309EA76</code> <code>974A290AFE797EC420AC562B972A1ECB</code> <code>110C8A475352C8EC1ADD022BE5612E94</code> <code>05541E2EED8FDF1296BB9EB31E8ADCBB</code> <code>81413D61D6CD8308D97D73718289BBFF</code> <code>BEE77305D3B8675FEF2676F003A71A0B</code> <code>112EB5776521DF16AC27025C73DBA12F</code> <code>1E91E713C650C9F905181E549BB1551B</code> <code>DAA84F2051D079FED5D81CEAA1DCA4A3</code> <code>4DAF6E5D1477C4A88B727C1780C918AA</code> <code>5172A92EE417500D568DF1F00CF16223</code> <code>713C5F72FE7A9C534AD83AD331B6468A</code> <code>97030CAA344310C955128F950055FB7A</code> <code>10434F1ED310BD9422236595467B50A6</code> <code>B3E5DA33A1F2E859C2273657739CA8CC</code><br> <code>E70C3C1C</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366661DB04F0759BA0112AF0F3923A2496C48E14CF649349500BF9F7DB9A97279460000000000000000FE000100830BF0AF2872BCAC62E7F6841937C7A2135D5988388BE5009309EA76974A290AFE797EC420AC562B972A1ECB110C8A475352C8EC1ADD022BE5612E9405541E2EED8FDF1296BB9EB31E8ADCBB81413D61D6CD8308D97D73718289BBFFBEE77305D3B8675FEF2676F003A71A0B112EB5776521DF16AC27025C73DBA12F1E91E713C650C9F905181E549BB1551BDAA84F2051D079FED5D81CEAA1DCA4A34DAF6E5D1477C4A88B727C1780C918AA5172A92EE417500D568DF1F00CF16223713C5F72FE7A9C534AD83AD331B6468A97030CAA344310C955128F950055FB7A10434F1ED310BD9422236595467B50A6B3E5DA33A1F2E859C2273657739CA8CCE70C3C1C
padding = 0495A2AED26D20B4D93D7617
tmp_aes_key = C0AE07F359E603AE019348325A3FE140E375F720C5C6D2C10AEB06CA0E4D9D57
tmp_aes_iv = 451C92CCB113C91BD2488002975E2504B0186EE1450111840D5906603E94B4C7</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 43C6120427A24C91E43219FA479DBAB2625C8596B1C755CF095E0F6A48D18802E9192F0BB52788450D683F4336F6D6017C75A25EB43AE02F3DE269AB40E31CDFE1C3C026DE3F84B2B27DA4F5DE644E63BF98F6301522090F5F3514F767AFD0445AA94C46479C63466BEAD9E3B11F61A0A288C76F62332A64FB5774C3D0BD5859D23E7CD26F698500FEF7BDCC8C98FC95C4F4184EC603801F2B80C4D43B8701DCF9ECA5ABA1781F8210E6A0D4709E1185C02139620AFA985C416A31EE30D3A7119B3195FB45141920943D04339F624FD05E9240AF4247D8322D90A64F5A4331D735F83521A4A0FCB526D5294AFAF1F5517C278DB6EEACCE0D5CE510324F3F6E6943E17D45C35738E27955B7CAD246326B6E4AFB459FB843459CACEFFEBCA7F9F81E59BB5F06B4EE9FAA96B3588A7BE029DE0C750668DDCAA53D95A23F12A09A376F52F7F7216A4D811728A68DE2E3DB23</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 E9 06 00 7A 5A 99 66
0010 | 78 01 00 00 1F 5F 04 F5 66 1D B0 4F 07 59 BA 01
0020 | 12 AF 0F 39 23 A2 49 6C 48 E1 4C F6 49 34 95 00
0030 | BF 9F 7D B9 A9 72 79 46 FE 50 01 00 43 C6 12 04
0040 | 27 A2 4C 91 E4 32 19 FA 47 9D BA B2 62 5C 85 96
0050 | B1 C7 55 CF 09 5E 0F 6A 48 D1 88 02 E9 19 2F 0B
0060 | B5 27 88 45 0D 68 3F 43 36 F6 D6 01 7C 75 A2 5E
0070 | B4 3A E0 2F 3D E2 69 AB 40 E3 1C DF E1 C3 C0 26
0080 | DE 3F 84 B2 B2 7D A4 F5 DE 64 4E 63 BF 98 F6 30
0090 | 15 22 09 0F 5F 35 14 F7 67 AF D0 44 5A A9 4C 46
00A0 | 47 9C 63 46 6B EA D9 E3 B1 1F 61 A0 A2 88 C7 6F
00B0 | 62 33 2A 64 FB 57 74 C3 D0 BD 58 59 D2 3E 7C D2
00C0 | 6F 69 85 00 FE F7 BD CC 8C 98 FC 95 C4 F4 18 4E
00D0 | C6 03 80 1F 2B 80 C4 D4 3B 87 01 DC F9 EC A5 AB
00E0 | A1 78 1F 82 10 E6 A0 D4 70 9E 11 85 C0 21 39 62
00F0 | 0A FA 98 5C 41 6A 31 EE 30 D3 A7 11 9B 31 95 FB
0100 | 45 14 19 20 94 3D 04 33 9F 62 4F D0 5E 92 40 AF
0110 | 42 47 D8 32 2D 90 A6 4F 5A 43 31 D7 35 F8 35 21
0120 | A4 A0 FC B5 26 D5 29 4A FA F1 F5 51 7C 27 8D B6
0130 | EE AC CE 0D 5C E5 10 32 4F 3F 6E 69 43 E1 7D 45
0140 | C3 57 38 E2 79 55 B7 CA D2 46 32 6B 6E 4A FB 45
0150 | 9F B8 43 45 9C AC EF FE BC A7 F9 F8 1E 59 BB 5F
0160 | 06 B4 EE 9F AA 96 B3 58 8A 7B E0 29 DE 0C 75 06
0170 | 68 DD CA A5 3D 95 A2 3F 12 A0 9A 37 6F 52 F7 F7
0180 | 21 6A 4D 81 17 28 A6 8D E2 E3 DB 23</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>08E906007A5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010043C6120427A24C91E43219FA</code> <code>479DBAB2625C8596B1C755CF095E0F6A</code> <code>48D18802E9192F0BB52788450D683F43</code> <code>36F6D6017C75A25EB43AE02F3DE269AB</code> <code>40E31CDFE1C3C026DE3F84B2B27DA4F5</code> <code>DE644E63BF98F6301522090F5F3514F7</code> <code>67AFD0445AA94C46479C63466BEAD9E3</code> <code>B11F61A0A288C76F62332A64FB5774C3</code> <code>D0BD5859D23E7CD26F698500FEF7BDCC</code> <code>8C98FC95C4F4184EC603801F2B80C4D4</code> <code>3B8701DCF9ECA5ABA1781F8210E6A0D4</code> <code>709E1185C02139620AFA985C416A31EE</code> <code>30D3A7119B3195FB45141920943D0433</code> <code>9F624FD05E9240AF4247D8322D90A64F</code> <code>5A4331D735F83521A4A0FCB526D5294A</code> <code>FAF1F5517C278DB6EEACCE0D5CE51032</code> <code>4F3F6E6943E17D45C35738E27955B7CA</code> <code>D246326B6E4AFB459FB843459CACEFFE</code> <code>BCA7F9F81E59BB5F06B4EE9FAA96B358</code> <code>8A7BE029DE0C750668DDCAA53D95A23F</code> <code>12A09A376F52F7F7216A4D811728A68D</code><br> <code>E2E3DB23</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = B9837DDE70F14154F5365D8F1BA15272D77A62EC2249D1A87CD6C98FCC6464D4912437D4F93FD0170C291BD9ECF7DDB6028C1BDBECA0A8D817980D7FC868346FB88F5062B89DD6CF2B05D78A3CFE77C56F81D6F056C3ECFC6047042A0583F39200D51D9662105A744B12C7E7A1ABD2C40353C9E12527B14B4184175E6CA014264F46932B7637A8B1AF03C1368BA5685114F574D74A1C5FF97631E8087F3DF3A995AFAFB86DBE5D9DE8EA1F2A1FDBF4EF36EEB23A8F436FB4F4A72B942EECD1B648AA311CD2B0840C2EFB06B8B2024E148FF501ED61BD04774EA4E59EC1B458A4CA59520A806EAA7FE49ACE8058C174BDCD6D064E2F55D79BD64891A38AFCB594</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 14 C7 29 7B 5A 99 66
0010 | 64 00 00 00 34 F7 CB 3B 66 1D B0 4F 07 59 BA 01
0020 | 12 AF 0F 39 23 A2 49 6C 48 E1 4C F6 49 34 95 00
0030 | BF 9F 7D B9 A9 72 79 46 95 AB 21 37 B1 76 91 42
0040 | 7D A0 66 B8 06 E6 BD EF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0114C7297B5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>64000000</code> (100 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>661DB04F0759BA0112AF0F3923A2496C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>48E14CF649349500BF9F7DB9A9727946</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>95AB2137B17691427DA066B806E6BDEF</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

