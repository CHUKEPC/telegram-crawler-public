<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B8 BE 04 00 B6 3D 9D 66
0010 | 14 00 00 00 F1 8E 7E BE 40 80 21 19 68 68 1D 6D
0020 | 1F DE 74 E0 B0 4F 71 6C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B8BE0400B63D9D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 8C 1A 5D B6 3D 9D 66
0010 | B8 00 00 00 63 24 16 05 40 80 21 19 68 68 1D 6D
0020 | 1F DE 74 E0 B0 4F 71 6C B3 67 26 72 28 78 35 1C
0030 | 62 90 B0 C8 9A C5 42 4A 08 1A BF 15 42 72 62 52
0040 | 5D 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018C1A5DB63D9D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B8000000</code> (184 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081ABF15427262525D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1927282540668932701</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1927282540668932701</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1927282540668932701 = 1378271773 * 1398332737</code></p>
<pre><code>p = 1378271773
q = 1398332737</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1A BF 15 42 72 62 52 5D 00 00 00
0010 | 04 52 26 C2 1D 00 00 00 04 53 58 DD 41 00 00 00
0020 | 40 80 21 19 68 68 1D 6D 1F DE 74 E0 B0 4F 71 6C
0030 | B3 67 26 72 28 78 35 1C 62 90 B0 C8 9A C5 42 4A
0040 | 82 C1 B9 BB 22 20 B4 18 75 C3 99 43 07 E3 9C 38
0050 | 18 6D 22 DE CA 59 44 DB 8F 23 89 0F 1B C7 FC 26
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081ABF15427262525D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1927282540668932701</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045226C21D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1378271773</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045358DD41000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1398332737</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>82C1B9BB2220B41875C3994307E39C38</code> <code>186D22DECA5944DB8F23890F1BC7FC26</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081ABF15427262525D000000045226C21D000000045358DD410000004080211968681D6D1FDE74E0B04F716CB36726722878351C6290B0C89AC5424A82C1B9BB2220B41875C3994307E39C38186D22DECA5944DB8F23890F1BC7FC2602000000
random_padding_bytes = AD0C622C4B21B55F1940C5E07619EA37E6B0118545D4EA9FD389A5EA6D7508621F5EABCA8E4DEE7EF43F52B7446354BB27E00E64684B729BA4446A77BD5CB2A1FF4564EB8553A38D18644B4C090DDDDDD2E0C32CC0905C43FE3C039F</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 3B91E3BC3E7A74527048A69839689AAFCBC7A11540B58F028DAEC6E3EEB382C41B8FF1B5E286AF027B2033A3F03553C12697C26A02B116229231ED7309FDF4AA4516F563EC3E484294A9B1B1AEBDF7AA9873B0C5576868B5DF0CCE357C2D51A9B7664AB65EE9A703CC2B0890C5F67622A606EA3B8D4EE08D0A975140691A6EF96BF56E6634716D76A081F5BDE71010DB05A7812A4905CE1E1585B4D083097FF2F26500260D2CFFEC332B3307D56E099DB44DEC8B110543CBC14113EE546AF6E5DB8A2BDCE9799BA49CBABCAFEF0EBC46C9F1F5308449D1F48EBD39BE918966AEBB9E7F51D15415EF40B174F270C3FE332F63A2889835FEE28D719631BFD884BB</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 79 0D 00 B6 3D 9D 66
0010 | 40 01 00 00 BE E4 12 D7 40 80 21 19 68 68 1D 6D
0020 | 1F DE 74 E0 B0 4F 71 6C B3 67 26 72 28 78 35 1C
0030 | 62 90 B0 C8 9A C5 42 4A 04 52 26 C2 1D 00 00 00
0040 | 04 53 58 DD 41 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 3B 91 E3 BC 3E 7A 74 52 70 48 A6 98
0060 | 39 68 9A AF CB C7 A1 15 40 B5 8F 02 8D AE C6 E3
0070 | EE B3 82 C4 1B 8F F1 B5 E2 86 AF 02 7B 20 33 A3
0080 | F0 35 53 C1 26 97 C2 6A 02 B1 16 22 92 31 ED 73
0090 | 09 FD F4 AA 45 16 F5 63 EC 3E 48 42 94 A9 B1 B1
00A0 | AE BD F7 AA 98 73 B0 C5 57 68 68 B5 DF 0C CE 35
00B0 | 7C 2D 51 A9 B7 66 4A B6 5E E9 A7 03 CC 2B 08 90
00C0 | C5 F6 76 22 A6 06 EA 3B 8D 4E E0 8D 0A 97 51 40
00D0 | 69 1A 6E F9 6B F5 6E 66 34 71 6D 76 A0 81 F5 BD
00E0 | E7 10 10 DB 05 A7 81 2A 49 05 CE 1E 15 85 B4 D0
00F0 | 83 09 7F F2 F2 65 00 26 0D 2C FF EC 33 2B 33 07
0100 | D5 6E 09 9D B4 4D EC 8B 11 05 43 CB C1 41 13 EE
0110 | 54 6A F6 E5 DB 8A 2B DC E9 79 9B A4 9C BA BC AF
0120 | EF 0E BC 46 C9 F1 F5 30 84 49 D1 F4 8E BD 39 BE
0130 | 91 89 66 AE BB 9E 7F 51 D1 54 15 EF 40 B1 74 F2
0140 | 70 C3 FE 33 2F 63 A2 88 98 35 FE E2 8D 71 96 31
0150 | BF D8 84 BB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0790D00B63D9D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045226C21D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1378271773</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045358DD41000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1398332737</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001003B91E3BC3E7A74527048A698</code> <code>39689AAFCBC7A11540B58F028DAEC6E3</code> <code>EEB382C41B8FF1B5E286AF027B2033A3</code> <code>F03553C12697C26A02B116229231ED73</code> <code>09FDF4AA4516F563EC3E484294A9B1B1</code> <code>AEBDF7AA9873B0C5576868B5DF0CCE35</code> <code>7C2D51A9B7664AB65EE9A703CC2B0890</code> <code>C5F67622A606EA3B8D4EE08D0A975140</code> <code>691A6EF96BF56E6634716D76A081F5BD</code> <code>E71010DB05A7812A4905CE1E1585B4D0</code> <code>83097FF2F26500260D2CFFEC332B3307</code> <code>D56E099DB44DEC8B110543CBC14113EE</code> <code>546AF6E5DB8A2BDCE9799BA49CBABCAF</code> <code>EF0EBC46C9F1F5308449D1F48EBD39BE</code> <code>918966AEBB9E7F51D15415EF40B174F2</code> <code>70C3FE332F63A2889835FEE28D719631</code><br> <code>BFD884BB</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A4 D8 29 B7 3D 9D 66
0010 | AC 02 00 00 5C 07 E8 D0 40 80 21 19 68 68 1D 6D
0020 | 1F DE 74 E0 B0 4F 71 6C B3 67 26 72 28 78 35 1C
0030 | 62 90 B0 C8 9A C5 42 4A FE 50 02 00 70 FE 0D 16
0040 | F2 3A 36 FD 82 B1 3F 67 00 FD CA 7D 0B 30 F9 76
0050 | 71 B3 D4 92 79 66 0D 45 9F 40 6E A3 DF 4C CA 6C
0060 | CB 2B 46 EF 18 1A C2 7A 28 41 01 D4 8B 64 EE 55
0070 | F9 72 C5 58 33 2B 82 0E E0 01 13 F1 6B C1 1A 6B
0080 | 14 75 A4 38 A7 3C B8 1E 8B 99 58 98 E6 30 7B 46
0090 | A4 BB CC D1 EF 77 1D 40 03 61 13 F2 39 BF B8 37
00A0 | 38 A9 00 94 4E A9 C9 F4 79 0D FA DD 71 43 F1 DF
00B0 | 1C A7 77 89 E3 43 5D 7A 5B 28 A1 30 1E 11 CF CC
00C0 | 2D 59 D1 79 13 2C DF C3 98 AB 31 19 7F DE F8 A0
00D0 | E5 B0 38 7D 9F D5 64 38 EB 7A 5E 74 B9 89 F8 06
00E0 | EC CB 14 B9 BC DD E1 A2 5F 7B 18 0D 0A B8 1A B3
00F0 | 74 CB 06 61 B1 8E 7C 8A 14 06 D3 C9 6A 92 26 F4
0100 | 91 06 18 48 7A 69 F5 AD FE EE 14 53 B2 7A 1D F9
0110 | CB E1 62 81 45 1C 59 18 38 6F E7 93 44 9E B7 3E
0120 | D7 DD FC 65 DB 6F F7 85 1B 2B 63 06 85 66 54 02
0130 | 12 08 F2 90 D2 00 A9 F4 52 4B E5 48 71 63 0F 0D
0140 | 4E 9E 23 87 A6 DB 01 5B 6B 82 65 31 82 29 64 4D
0150 | BD F0 72 12 DA C2 0A 41 4E CE E3 2E C3 50 57 47
0160 | C3 C8 62 8D B9 97 23 D3 BD FB D4 9B 0A BE 5C 85
0170 | 84 30 9B 6A 8F 77 B8 7D 09 3B 3E 85 3C 7D 8A F5
0180 | 89 6E B0 D1 AD F8 A2 19 1F AC 7F 92 51 F8 0E 2A
0190 | 48 58 8B 4C 58 CE 9F 93 15 EE C6 34 C8 3C 0F 8D
01A0 | A2 B3 02 3A 8C BA 91 C3 50 C6 1A 19 CC AB 32 FF
01B0 | 85 70 55 C6 E0 DF 9B D3 99 A7 34 9A FF 20 C5 32
01C0 | 20 B5 86 0E D5 76 70 C6 17 78 48 8F BC FD D1 14
01D0 | 96 BD A6 95 3E A4 F5 0F 57 D1 BC 25 57 B2 07 A7
01E0 | B9 E3 7D 3D 5B 20 03 99 28 A9 6D 07 17 36 32 0C
01F0 | F0 D6 97 B2 00 50 D6 7A 96 87 F6 F8 03 94 9A 68
0200 | 53 35 AF 1A E0 8F EC F3 FF C5 F3 53 77 C5 37 63
0210 | C5 94 4A 3C 14 86 1D F2 43 7C 1B B1 3B D4 E1 86
0220 | FF 1B CD C0 27 1F F1 58 A5 A4 F7 00 8A D4 DF D3
0230 | AB 6E F1 FF 8D B0 40 20 1D B4 09 0C 5B D6 E9 AA
0240 | 30 C5 6C ED 46 26 08 DA 6F 87 87 70 F2 B9 87 88
0250 | 68 64 70 33 1E 8F 5D 1C A0 83 AA 2C 21 B4 09 18
0260 | AB E8 3E 73 52 AA EE 46 57 D7 84 69 E9 36 6D 35
0270 | 08 6E 07 DB 05 72 F4 67 66 9D 54 34 2A 17 C2 78
0280 | E3 10 2D 99 0C 08 48 E2 41 29 41 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A4D829B73D9D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>AC020000</code> (684 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020070FE0D16F23A36FD82B13F67</code> <code>00FDCA7D0B30F97671B3D49279660D45</code> <code>9F406EA3DF4CCA6CCB2B46EF181AC27A</code> <code>284101D48B64EE55F972C558332B820E</code> <code>E00113F16BC11A6B1475A438A73CB81E</code> <code>8B995898E6307B46A4BBCCD1EF771D40</code> <code>036113F239BFB83738A900944EA9C9F4</code> <code>790DFADD7143F1DF1CA77789E3435D7A</code> <code>5B28A1301E11CFCC2D59D179132CDFC3</code> <code>98AB31197FDEF8A0E5B0387D9FD56438</code> <code>EB7A5E74B989F806ECCB14B9BCDDE1A2</code> <code>5F7B180D0AB81AB374CB0661B18E7C8A</code> <code>1406D3C96A9226F4910618487A69F5AD</code> <code>FEEE1453B27A1DF9CBE16281451C5918</code> <code>386FE793449EB73ED7DDFC65DB6FF785</code> <code>1B2B6306856654021208F290D200A9F4</code> <code>524BE54871630F0D4E9E2387A6DB015B</code> <code>6B8265318229644DBDF07212DAC20A41</code> <code>4ECEE32EC3505747C3C8628DB99723D3</code> <code>BDFBD49B0ABE5C8584309B6A8F77B87D</code> <code>093B3E853C7D8AF5896EB0D1ADF8A219</code> <code>1FAC7F9251F80E2A48588B4C58CE9F93</code> <code>15EEC634C83C0F8DA2B3023A8CBA91C3</code> <code>50C61A19CCAB32FF857055C6E0DF9BD3</code> <code>99A7349AFF20C53220B5860ED57670C6</code> <code>1778488FBCFDD11496BDA6953EA4F50F</code> <code>57D1BC2557B207A7B9E37D3D5B200399</code> <code>28A96D071736320CF0D697B20050D67A</code> <code>9687F6F803949A685335AF1AE08FECF3</code> <code>FFC5F35377C53763C5944A3C14861DF2</code> <code>437C1BB13BD4E186FF1BCDC0271FF158</code> <code>A5A4F7008AD4DFD3AB6EF1FF8DB04020</code> <code>1DB4090C5BD6E9AA30C56CED462608DA</code> <code>6F878770F2B98788686470331E8F5D1C</code> <code>A083AA2C21B40918ABE83E7352AAEE46</code> <code>57D78469E9366D35086E07DB0572F467</code> <code>669D54342A17C278E3102D990C0848E2</code><br> <code>4129411E</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 70FE0D16F23A36FD82B13F6700FDCA7D0B30F97671B3D49279660D459F406EA3DF4CCA6CCB2B46EF181AC27A284101D48B64EE55F972C558332B820EE00113F16BC11A6B1475A438A73CB81E8B995898E6307B46A4BBCCD1EF771D40036113F239BFB83738A900944EA9C9F4790DFADD7143F1DF1CA77789E3435D7A5B28A1301E11CFCC2D59D179132CDFC398AB31197FDEF8A0E5B0387D9FD56438EB7A5E74B989F806ECCB14B9BCDDE1A25F7B180D0AB81AB374CB0661B18E7C8A1406D3C96A9226F4910618487A69F5ADFEEE1453B27A1DF9CBE16281451C5918386FE793449EB73ED7DDFC65DB6FF7851B2B6306856654021208F290D200A9F4524BE54871630F0D4E9E2387A6DB015B6B8265318229644DBDF07212DAC20A414ECEE32EC3505747C3C8628DB99723D3BDFBD49B0ABE5C8584309B6A8F77B87D093B3E853C7D8AF5896EB0D1ADF8A2191FAC7F9251F80E2A48588B4C58CE9F9315EEC634C83C0F8DA2B3023A8CBA91C350C61A19CCAB32FF857055C6E0DF9BD399A7349AFF20C53220B5860ED57670C61778488FBCFDD11496BDA6953EA4F50F57D1BC2557B207A7B9E37D3D5B20039928A96D071736320CF0D697B20050D67A9687F6F803949A685335AF1AE08FECF3FFC5F35377C53763C5944A3C14861DF2437C1BB13BD4E186FF1BCDC0271FF158A5A4F7008AD4DFD3AB6EF1FF8DB040201DB4090C5BD6E9AA30C56CED462608DA6F878770F2B98788686470331E8F5D1CA083AA2C21B40918ABE83E7352AAEE4657D78469E9366D35086E07DB0572F467669D54342A17C278E3102D990C0848E24129411E
tmp_aes_key = B36D932E42F5E244DAA33A16E2BD3B22482D1AE60775B15BE6CA246AF4D24021
tmp_aes_iv = 537E15CDCCCA06155D814EA3BD1EF74908A51D32AF9E6843F03E831182C1B9BB</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = B822E491A4576421382D9D810AC3A1D891FF6A02BA0D89B54080211968681D6D1FDE74E0B04F716CB36726722878351C6290B0C89AC5424A03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010090A3D58D4655046BE5C2C3E7758B039F6BED52EDC3EC8739FF95D69D33F3EDD091B8A1D96FC112ED3999D64ECB413217192BFDDA6F9882E22ACA4AE0621617DE17E99C4D168C822E779EB93DCBBA1A690036A13649A7C4666D93EF091BE707560C08687FCFC42653FB64250FFBBDAE04E385DA515FE857F32386EFD89438C04634E8EEF20966E9AC3216EB5C259E866F9265064F2025657B797918EE4279EDFD0CEA4773E6579585C3398AC360C06102AD88188DF99E678490A0BE81B51027E67BCCB8526B8CE9A042505B9920167E65A4F81D440DA8404181B727055D7CED1AF31933CF3DF2887939C1EDFF9CF4DF091A40B7CA9ECC51A3BDD00A14EA015AB9B73D9D6687AB7782D62EBD8E
answer = BA0D89B54080211968681D6D1FDE74E0B04F716CB36726722878351C6290B0C89AC5424A03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010090A3D58D4655046BE5C2C3E7758B039F6BED52EDC3EC8739FF95D69D33F3EDD091B8A1D96FC112ED3999D64ECB413217192BFDDA6F9882E22ACA4AE0621617DE17E99C4D168C822E779EB93DCBBA1A690036A13649A7C4666D93EF091BE707560C08687FCFC42653FB64250FFBBDAE04E385DA515FE857F32386EFD89438C04634E8EEF20966E9AC3216EB5C259E866F9265064F2025657B797918EE4279EDFD0CEA4773E6579585C3398AC360C06102AD88188DF99E678490A0BE81B51027E67BCCB8526B8CE9A042505B9920167E65A4F81D440DA8404181B727055D7CED1AF31933CF3DF2887939C1EDFF9CF4DF091A40B7CA9ECC51A3BDD00A14EA015AB9B73D9D6687AB7782D62EBD8E</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 40 80 21 19 68 68 1D 6D 1F DE 74 E0
0010 | B0 4F 71 6C B3 67 26 72 28 78 35 1C 62 90 B0 C8
0020 | 9A C5 42 4A 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 90 A3 D5 8D 46 55 04 6B E5 C2 C3 E7 75 8B 03 9F
0140 | 6B ED 52 ED C3 EC 87 39 FF 95 D6 9D 33 F3 ED D0
0150 | 91 B8 A1 D9 6F C1 12 ED 39 99 D6 4E CB 41 32 17
0160 | 19 2B FD DA 6F 98 82 E2 2A CA 4A E0 62 16 17 DE
0170 | 17 E9 9C 4D 16 8C 82 2E 77 9E B9 3D CB BA 1A 69
0180 | 00 36 A1 36 49 A7 C4 66 6D 93 EF 09 1B E7 07 56
0190 | 0C 08 68 7F CF C4 26 53 FB 64 25 0F FB BD AE 04
01A0 | E3 85 DA 51 5F E8 57 F3 23 86 EF D8 94 38 C0 46
01B0 | 34 E8 EE F2 09 66 E9 AC 32 16 EB 5C 25 9E 86 6F
01C0 | 92 65 06 4F 20 25 65 7B 79 79 18 EE 42 79 ED FD
01D0 | 0C EA 47 73 E6 57 95 85 C3 39 8A C3 60 C0 61 02
01E0 | AD 88 18 8D F9 9E 67 84 90 A0 BE 81 B5 10 27 E6
01F0 | 7B CC B8 52 6B 8C E9 A0 42 50 5B 99 20 16 7E 65
0200 | A4 F8 1D 44 0D A8 40 41 81 B7 27 05 5D 7C ED 1A
0210 | F3 19 33 CF 3D F2 88 79 39 C1 ED FF 9C F4 DF 09
0220 | 1A 40 B7 CA 9E CC 51 A3 BD D0 0A 14 EA 01 5A B9
0230 | B7 3D 9D 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010090A3D58D4655046BE5C2C3E7</code> <code>758B039F6BED52EDC3EC8739FF95D69D</code> <code>33F3EDD091B8A1D96FC112ED3999D64E</code> <code>CB413217192BFDDA6F9882E22ACA4AE0</code> <code>621617DE17E99C4D168C822E779EB93D</code> <code>CBBA1A690036A13649A7C4666D93EF09</code> <code>1BE707560C08687FCFC42653FB64250F</code> <code>FBBDAE04E385DA515FE857F32386EFD8</code> <code>9438C04634E8EEF20966E9AC3216EB5C</code> <code>259E866F9265064F2025657B797918EE</code> <code>4279EDFD0CEA4773E6579585C3398AC3</code> <code>60C06102AD88188DF99E678490A0BE81</code> <code>B51027E67BCCB8526B8CE9A042505B99</code> <code>20167E65A4F81D440DA8404181B72705</code> <code>5D7CED1AF31933CF3DF2887939C1EDFF</code> <code>9CF4DF091A40B7CA9ECC51A3BDD00A14</code><br> <code>EA015AB9</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B73D9D66</code> (1721580983 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 92A04574AB3B69E15EB541CB070985EC83012B66E74A4243B6495A4E4F954D7622D41E971AC9E16A99DEF44D77A2A32711BF948206DE2C6C261AB05373D3791AEFB544D609F510ED17821ABBB462059D5F859B47B022F53E36D943A97E03F1FE34302781A6230FDBFE6483AE0E01D269530954412A7DFD49695C2FFD0D2D09D0A15F306D6510E64D04E29034569D6EDE2AB1A21A14167307B4780E3BA9B5EB9D7D829A4153177E74F83666F88F7B8E6E744A01C6345BB53234882D441FE06115286036400C90F3AC0E4D2501C03BCA62A29220DB3510FE2AA0D2D8DFE4CEE2A0C45AFBC9F46037F0FFA7C1AFD9E2D83EF41E543AB077B4033111F1F3D59FDE63</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 0DF78FB9EBC8FE4EB147AEFD5F27896EC8E69C442C505BE2B6B5903735D6E7CC6E767D358A2E1FFA93C2B5D23C68B116205E86BD6862B9CED8D2499F053B33CCCA81AE287C8869D8EDB388E585643331E014A64FC203E851147F40F6C42E518DB1D783A60CDB1B29ECEEBBD3D03313D2AE20A80E6C566C65F18BA014655204F35C6539E82DDBB01322704CB6893C1BA51ADDAB6759D612B81171F2BFF8B959678EE1D33CFB73DFBC9B7ADEB11A6D562BDAE46DBB4F7A7DCE845B733FDF1AA62C3FEF99D29457AFE95AAA3E8270D230AD5946E8211821C21B6D2A88E373811A0017F2F08CFBB04D0DC3BE18BEE80C80661FC37FFE05962CDA14D6CD3A1547495B</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 40 80 21 19 68 68 1D 6D 1F DE 74 E0
0010 | B0 4F 71 6C B3 67 26 72 28 78 35 1C 62 90 B0 C8
0020 | 9A C5 42 4A 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 0D F7 8F B9 EB C8 FE 4E B1 47 AE FD 5F 27 89 6E
0040 | C8 E6 9C 44 2C 50 5B E2 B6 B5 90 37 35 D6 E7 CC
0050 | 6E 76 7D 35 8A 2E 1F FA 93 C2 B5 D2 3C 68 B1 16
0060 | 20 5E 86 BD 68 62 B9 CE D8 D2 49 9F 05 3B 33 CC
0070 | CA 81 AE 28 7C 88 69 D8 ED B3 88 E5 85 64 33 31
0080 | E0 14 A6 4F C2 03 E8 51 14 7F 40 F6 C4 2E 51 8D
0090 | B1 D7 83 A6 0C DB 1B 29 EC EE BB D3 D0 33 13 D2
00A0 | AE 20 A8 0E 6C 56 6C 65 F1 8B A0 14 65 52 04 F3
00B0 | 5C 65 39 E8 2D DB B0 13 22 70 4C B6 89 3C 1B A5
00C0 | 1A DD AB 67 59 D6 12 B8 11 71 F2 BF F8 B9 59 67
00D0 | 8E E1 D3 3C FB 73 DF BC 9B 7A DE B1 1A 6D 56 2B
00E0 | DA E4 6D BB 4F 7A 7D CE 84 5B 73 3F DF 1A A6 2C
00F0 | 3F EF 99 D2 94 57 AF E9 5A AA 3E 82 70 D2 30 AD
0100 | 59 46 E8 21 18 21 C2 1B 6D 2A 88 E3 73 81 1A 00
0110 | 17 F2 F0 8C FB B0 4D 0D C3 BE 18 BE E8 0C 80 66
0120 | 1F C3 7F FE 05 96 2C DA 14 D6 CD 3A 15 47 49 5B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001000DF78FB9EBC8FE4EB147AEFD</code> <code>5F27896EC8E69C442C505BE2B6B59037</code> <code>35D6E7CC6E767D358A2E1FFA93C2B5D2</code> <code>3C68B116205E86BD6862B9CED8D2499F</code> <code>053B33CCCA81AE287C8869D8EDB388E5</code> <code>85643331E014A64FC203E851147F40F6</code> <code>C42E518DB1D783A60CDB1B29ECEEBBD3</code> <code>D03313D2AE20A80E6C566C65F18BA014</code> <code>655204F35C6539E82DDBB01322704CB6</code> <code>893C1BA51ADDAB6759D612B81171F2BF</code> <code>F8B959678EE1D33CFB73DFBC9B7ADEB1</code> <code>1A6D562BDAE46DBB4F7A7DCE845B733F</code> <code>DF1AA62C3FEF99D29457AFE95AAA3E82</code> <code>70D230AD5946E8211821C21B6D2A88E3</code> <code>73811A0017F2F08CFBB04D0DC3BE18BE</code> <code>E80C80661FC37FFE05962CDA14D6CD3A</code><br> <code>1547495B</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643664080211968681D6D1FDE74E0B04F716CB36726722878351C6290B0C89AC5424A0000000000000000FE0001000DF78FB9EBC8FE4EB147AEFD5F27896EC8E69C442C505BE2B6B5903735D6E7CC6E767D358A2E1FFA93C2B5D23C68B116205E86BD6862B9CED8D2499F053B33CCCA81AE287C8869D8EDB388E585643331E014A64FC203E851147F40F6C42E518DB1D783A60CDB1B29ECEEBBD3D03313D2AE20A80E6C566C65F18BA014655204F35C6539E82DDBB01322704CB6893C1BA51ADDAB6759D612B81171F2BFF8B959678EE1D33CFB73DFBC9B7ADEB11A6D562BDAE46DBB4F7A7DCE845B733FDF1AA62C3FEF99D29457AFE95AAA3E8270D230AD5946E8211821C21B6D2A88E373811A0017F2F08CFBB04D0DC3BE18BEE80C80661FC37FFE05962CDA14D6CD3A1547495B
padding = A83123E23232A1AA7936200A
tmp_aes_key = B36D932E42F5E244DAA33A16E2BD3B22482D1AE60775B15BE6CA246AF4D24021
tmp_aes_iv = 537E15CDCCCA06155D814EA3BD1EF74908A51D32AF9E6843F03E831182C1B9BB</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C55D1DA12CA2083457C3193E67A146D3FD4BD67938CB1322F12CAEB1D91E68676E6FC929D3CA4AAE470218F9FBD5268BD8AF21DF05A512D07FB052D4A84E78376F0B8A305E1937082919ABE129A05271337FCEE4EAEB4AA52EAEEBA3FC4907DFEBD8B4904E8D990269DEFEC569FED4283975A340AFDD9F0BEB8BADD4B058765AFAEFCBFA25D630570FB02EC1453CDB98DC5D4A534691DF1C1279187E1F199E4CDE7AC61D94CAD1A2CDADB934800E1538594B4A5FCC77010533D672C6FCEF274D909E80BC78D1C559AEA84710572A732882DCCAE9CCCA79EE3238899D3228D7A56E68D47085C74586C05EA0388216F126A479542551E7DB80E604212B797106D6D50B4E35F818F53638DAE2249B0B9A2794270604ADC8AB9CBD3C9AF939A75D698BE69281E1854F858EC9F38E89841E53F185888F843D9D71549526231AD5A4F4C664F48397388816DB8A1FF6D9FF2B41</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 8C 72 0C 00 B7 3D 9D 66
0010 | 78 01 00 00 1F 5F 04 F5 40 80 21 19 68 68 1D 6D
0020 | 1F DE 74 E0 B0 4F 71 6C B3 67 26 72 28 78 35 1C
0030 | 62 90 B0 C8 9A C5 42 4A FE 50 01 00 C5 5D 1D A1
0040 | 2C A2 08 34 57 C3 19 3E 67 A1 46 D3 FD 4B D6 79
0050 | 38 CB 13 22 F1 2C AE B1 D9 1E 68 67 6E 6F C9 29
0060 | D3 CA 4A AE 47 02 18 F9 FB D5 26 8B D8 AF 21 DF
0070 | 05 A5 12 D0 7F B0 52 D4 A8 4E 78 37 6F 0B 8A 30
0080 | 5E 19 37 08 29 19 AB E1 29 A0 52 71 33 7F CE E4
0090 | EA EB 4A A5 2E AE EB A3 FC 49 07 DF EB D8 B4 90
00A0 | 4E 8D 99 02 69 DE FE C5 69 FE D4 28 39 75 A3 40
00B0 | AF DD 9F 0B EB 8B AD D4 B0 58 76 5A FA EF CB FA
00C0 | 25 D6 30 57 0F B0 2E C1 45 3C DB 98 DC 5D 4A 53
00D0 | 46 91 DF 1C 12 79 18 7E 1F 19 9E 4C DE 7A C6 1D
00E0 | 94 CA D1 A2 CD AD B9 34 80 0E 15 38 59 4B 4A 5F
00F0 | CC 77 01 05 33 D6 72 C6 FC EF 27 4D 90 9E 80 BC
0100 | 78 D1 C5 59 AE A8 47 10 57 2A 73 28 82 DC CA E9
0110 | CC CA 79 EE 32 38 89 9D 32 28 D7 A5 6E 68 D4 70
0120 | 85 C7 45 86 C0 5E A0 38 82 16 F1 26 A4 79 54 25
0130 | 51 E7 DB 80 E6 04 21 2B 79 71 06 D6 D5 0B 4E 35
0140 | F8 18 F5 36 38 DA E2 24 9B 0B 9A 27 94 27 06 04
0150 | AD C8 AB 9C BD 3C 9A F9 39 A7 5D 69 8B E6 92 81
0160 | E1 85 4F 85 8E C9 F3 8E 89 84 1E 53 F1 85 88 8F
0170 | 84 3D 9D 71 54 95 26 23 1A D5 A4 F4 C6 64 F4 83
0180 | 97 38 88 16 DB 8A 1F F6 D9 FF 2B 41</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>8C720C00B73D9D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C55D1DA12CA2083457C3193E</code> <code>67A146D3FD4BD67938CB1322F12CAEB1</code> <code>D91E68676E6FC929D3CA4AAE470218F9</code> <code>FBD5268BD8AF21DF05A512D07FB052D4</code> <code>A84E78376F0B8A305E1937082919ABE1</code> <code>29A05271337FCEE4EAEB4AA52EAEEBA3</code> <code>FC4907DFEBD8B4904E8D990269DEFEC5</code> <code>69FED4283975A340AFDD9F0BEB8BADD4</code> <code>B058765AFAEFCBFA25D630570FB02EC1</code> <code>453CDB98DC5D4A534691DF1C1279187E</code> <code>1F199E4CDE7AC61D94CAD1A2CDADB934</code> <code>800E1538594B4A5FCC77010533D672C6</code> <code>FCEF274D909E80BC78D1C559AEA84710</code> <code>572A732882DCCAE9CCCA79EE3238899D</code> <code>3228D7A56E68D47085C74586C05EA038</code> <code>8216F126A479542551E7DB80E604212B</code> <code>797106D6D50B4E35F818F53638DAE224</code> <code>9B0B9A2794270604ADC8AB9CBD3C9AF9</code> <code>39A75D698BE69281E1854F858EC9F38E</code> <code>89841E53F185888F843D9D7154952623</code> <code>1AD5A4F4C664F48397388816DB8A1FF6</code><br> <code>D9FF2B41</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 765D837CCE3CE170B79A8DA86BE1EC90AC363D4B810DC597668AC02769B9FC4A13856E1E9E40C1E3D33883360A3CB7592D32598776E3365E334611B35E3C6EACC7D4AAC7C2F84C6D3A10EAC8FA3459F10E331EF9032700307A6AAFD0C2EB7FC5D035C9E0502DA4373FC6D0B409465421B84EAE427ACBF98980C46B90A6F69A2D7F927A7C5EBE71EE96D89F0E7945FC301716A7418882803AEEA508DF4DDF0E4698D076219018CD9702378E69117A510AA493B81F65A66AFB8DF25E8EF1438A6FA0856385018FF89D4D888993E0CF661256C3C7F21D200F23B86D82D4EB05597F67B70CD7E8C6C1D32BFBFDB80CF13359E37AD61B2DE109588685B7B342F23572</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 4C EE E9 B7 3D 9D 66
0010 | 94 00 00 00 34 F7 CB 3B 40 80 21 19 68 68 1D 6D
0020 | 1F DE 74 E0 B0 4F 71 6C B3 67 26 72 28 78 35 1C
0030 | 62 90 B0 C8 9A C5 42 4A 99 6C 72 3F 1F EB 67 06
0040 | 05 EE 31 AA 99 DB 40 FE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014CEEE9B73D9D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>94000000</code> (148 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4080211968681D6D1FDE74E0B04F716C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B36726722878351C6290B0C89AC5424A</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>996C723F1FEB670605EE31AA99DB40FE</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

