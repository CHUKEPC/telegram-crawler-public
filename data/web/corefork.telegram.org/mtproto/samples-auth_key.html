<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?237" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 F5 04 00 C6 B6 79 66
0010 | 14 00 00 00 F1 8E 7E BE FF 94 B2 49 02 3B A8 8D
0020 | A0 2F D6 95 79 D7 C4 03</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>78F50400C6B67966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C EB C6 C6 B6 79 66
0010 | B0 00 00 00 63 24 16 05 FF 94 B2 49 02 3B A8 8D
0020 | A0 2F D6 95 79 D7 C4 03 C7 A1 D4 5C 25 AF 92 79
0030 | BD 9C 96 D7 14 48 D3 D3 08 32 01 38 70 1C 37 8F
0040 | E7 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019CEBC6C6B67966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0000000</code> (176 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08320138701C378FE7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3603223231034003431</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3603223231034003431</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3603223231034003431 = 1836149899 * 1962379669</code></p>
<pre><code>p = 1836149899
q = 1962379669</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 32 01 38 70 1C 37 8F E7 00 00 00
0010 | 04 6D 71 6C 8B 00 00 00 04 74 F7 89 95 00 00 00
0020 | FF 94 B2 49 02 3B A8 8D A0 2F D6 95 79 D7 C4 03
0030 | C7 A1 D4 5C 25 AF 92 79 BD 9C 96 D7 14 48 D3 D3
0040 | 6B C1 60 F4 87 3A 17 B4 41 99 86 B0 8B B5 CF 9D
0050 | 8E 2B FD 9B BC B6 B0 BB BA 79 63 4F 14 4B AA 69
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08320138701C378FE7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3603223231034003431</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>046D716C8B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1836149899</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0474F78995000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1962379669</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>6BC160F4873A17B4419986B08BB5CF9D</code> <code>8E2BFD9BBCB6B0BBBA79634F144BAA69</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908320138701C378FE7000000046D716C8B0000000474F78995000000FF94B249023BA88DA02FD69579D7C403C7A1D45C25AF9279BD9C96D71448D3D36BC160F4873A17B4419986B08BB5CF9D8E2BFD9BBCB6B0BBBA79634F144BAA6902000000
random_padding_bytes = 16AFBBFE92AA5DAD2952669F45527DAEE2CDB5B7DDFCD25E96D30906E70C51606BEF23B8BEE2982D39C5B3E0AA6DCFB66490C8202EE3DC2B7EA96890477C73354A52C01844D5DE73921F1927ED5904B08504BE82A584A790D9EC89A5</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 31C92146F1B94380574226D5EC6C1BCBC4910E59555579617F895839C7098547752E8CF5ACDBC06FBA43164ACD9C359E17508F7C290C13E53FE3B4DD709BBEED1B48566CDE6D35D34A13B2270FFF7B98E89FF02935E034B6734EC3ACDD74550ADD68B26FC919A738E56A200D5E844C5E365931056FCD04758423124DA67EC19C826D07E6C7559F02C2D2E342E990B1237F1D38ECAAAF048100EEC0CFAC2D0E67B04D3F66FB5D4D0ABF2440E57EEA03FC670311E411ED344B99DC8A9CC06278B994B30FA30A50675E0AEE1BD47D0C3C75862C82781E27D15C29EC342B37AD07F9BF362CC538AD3513C7DF8FD77E828820E924A16EA081C3F5AFB1B79C7E58EE60</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F8 52 0D 00 C6 B6 79 66
0010 | 40 01 00 00 BE E4 12 D7 FF 94 B2 49 02 3B A8 8D
0020 | A0 2F D6 95 79 D7 C4 03 C7 A1 D4 5C 25 AF 92 79
0030 | BD 9C 96 D7 14 48 D3 D3 04 6D 71 6C 8B 00 00 00
0040 | 04 74 F7 89 95 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 31 C9 21 46 F1 B9 43 80 57 42 26 D5
0060 | EC 6C 1B CB C4 91 0E 59 55 55 79 61 7F 89 58 39
0070 | C7 09 85 47 75 2E 8C F5 AC DB C0 6F BA 43 16 4A
0080 | CD 9C 35 9E 17 50 8F 7C 29 0C 13 E5 3F E3 B4 DD
0090 | 70 9B BE ED 1B 48 56 6C DE 6D 35 D3 4A 13 B2 27
00A0 | 0F FF 7B 98 E8 9F F0 29 35 E0 34 B6 73 4E C3 AC
00B0 | DD 74 55 0A DD 68 B2 6F C9 19 A7 38 E5 6A 20 0D
00C0 | 5E 84 4C 5E 36 59 31 05 6F CD 04 75 84 23 12 4D
00D0 | A6 7E C1 9C 82 6D 07 E6 C7 55 9F 02 C2 D2 E3 42
00E0 | E9 90 B1 23 7F 1D 38 EC AA AF 04 81 00 EE C0 CF
00F0 | AC 2D 0E 67 B0 4D 3F 66 FB 5D 4D 0A BF 24 40 E5
0100 | 7E EA 03 FC 67 03 11 E4 11 ED 34 4B 99 DC 8A 9C
0110 | C0 62 78 B9 94 B3 0F A3 0A 50 67 5E 0A EE 1B D4
0120 | 7D 0C 3C 75 86 2C 82 78 1E 27 D1 5C 29 EC 34 2B
0130 | 37 AD 07 F9 BF 36 2C C5 38 AD 35 13 C7 DF 8F D7
0140 | 7E 82 88 20 E9 24 A1 6E A0 81 C3 F5 AF B1 B7 9C
0150 | 7E 58 EE 60</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F8520D00C6B67966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>046D716C8B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1836149899</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0474F78995000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1962379669</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010031C92146F1B94380574226D5</code> <code>EC6C1BCBC4910E59555579617F895839</code> <code>C7098547752E8CF5ACDBC06FBA43164A</code> <code>CD9C359E17508F7C290C13E53FE3B4DD</code> <code>709BBEED1B48566CDE6D35D34A13B227</code> <code>0FFF7B98E89FF02935E034B6734EC3AC</code> <code>DD74550ADD68B26FC919A738E56A200D</code> <code>5E844C5E365931056FCD04758423124D</code> <code>A67EC19C826D07E6C7559F02C2D2E342</code> <code>E990B1237F1D38ECAAAF048100EEC0CF</code> <code>AC2D0E67B04D3F66FB5D4D0ABF2440E5</code> <code>7EEA03FC670311E411ED344B99DC8A9C</code> <code>C06278B994B30FA30A50675E0AEE1BD4</code> <code>7D0C3C75862C82781E27D15C29EC342B</code> <code>37AD07F9BF362CC538AD3513C7DF8FD7</code> <code>7E828820E924A16EA081C3F5AFB1B79C</code><br> <code>7E58EE60</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 7C 85 C7 B6 79 66
0010 | 9C 02 00 00 5C 07 E8 D0 FF 94 B2 49 02 3B A8 8D
0020 | A0 2F D6 95 79 D7 C4 03 C7 A1 D4 5C 25 AF 92 79
0030 | BD 9C 96 D7 14 48 D3 D3 FE 50 02 00 AC 77 CB FE
0040 | 83 8D E1 17 44 AE 4F 4F 6A 58 07 51 2D 70 3C 94
0050 | 47 33 A3 2E 97 2A AB 59 60 CA F2 63 73 97 09 AA
0060 | D4 16 E5 5D FF B2 FB CF 33 BC 68 B4 63 33 12 C4
0070 | C7 82 85 04 70 C2 3B 0B 9A 26 B5 13 BA 0D B0 B0
0080 | 96 DB 4F 81 0B E9 02 F5 7D 82 44 8E 55 C5 A2 7B
0090 | FC B1 94 70 9B D9 31 C8 9D 8C 33 69 8C A5 16 1E
00A0 | 56 24 69 45 55 8E 0A C4 59 B4 FD 34 20 13 51 8D
00B0 | A2 F8 4B B7 FC E7 30 CD 9E A9 8C 97 9C E4 00 01
00C0 | 0E 1B 40 99 08 E7 DD 8A 98 B7 50 53 69 F7 22 1A
00D0 | 58 4E 83 15 E7 68 68 44 5C 4B CB 80 4C E8 DE D7
00E0 | DE CF 1F 73 4D 51 F1 96 C9 06 15 DF 6E 28 15 88
00F0 | 48 20 32 A7 39 8B 58 AB 2B 84 3A E2 E1 54 83 AF
0100 | 15 FB 46 16 ED A7 79 21 B1 32 51 91 42 33 10 51
0110 | 11 F3 CE 13 2E AA D7 1A 41 CE F2 F2 BC 46 2F CB
0120 | EC 2E 91 60 FB 7B E0 88 FF 3E 82 17 24 94 21 B7
0130 | 8B 22 4A A8 4D 73 28 3F 0E 0A 6D F7 65 A6 13 C7
0140 | 9D 5C 2B 74 EB 48 D0 DA B5 75 B0 DA 6A 8C EC FC
0150 | 04 6B 74 56 73 98 58 E1 40 87 6D 6D 64 C8 13 46
0160 | BE 8C 62 1A D8 32 C5 79 0B 44 82 AA 99 F9 EC D6
0170 | 39 F2 E1 19 F8 E9 0B 2C FE 3F 25 59 C4 48 90 16
0180 | A7 DC 50 4F 10 90 10 53 E9 EA F8 A7 1E 37 5F 22
0190 | A2 76 2A 17 CA CA 64 7C 5A AE 72 4D EF C7 43 10
01A0 | 30 19 66 4A 26 6B 9C 4B D6 BE D9 D2 9E 8C CC 41
01B0 | BF EC 4E 91 63 9F 12 82 3A 5B 70 9B 1C 94 1A DE
01C0 | BF 2B 07 DB 33 E5 9F E5 17 8B F1 11 DA 78 C3 84
01D0 | 89 C9 F2 1B BF 0B 30 DA C3 9E 34 A0 60 38 8C DC
01E0 | F8 BF A4 02 39 DC A5 1D 4E B4 AD AB 45 E8 93 F9
01F0 | 1B 9B F4 F5 A2 82 39 8F 63 D1 AA DD A7 03 43 19
0200 | EA 83 9A 94 86 A2 77 B1 6C FB CC EB 20 F7 D5 12
0210 | 32 1B 03 C3 32 92 9E 42 2D EF C6 FF 5A 9D 57 62
0220 | 8B 61 D8 F4 11 2F 42 B5 7C 83 8B 64 03 EE 21 4F
0230 | 77 87 6D 85 5D FC 81 F9 4F C4 F7 64 A7 55 86 32
0240 | FA A3 20 DA 1A 66 97 D9 41 C9 D8 3A 06 19 0E 76
0250 | 79 E6 A9 90 6B C2 13 E3 59 6F 14 15 46 71 CD 71
0260 | DE FA BA 89 18 23 55 56 3C 44 38 60 83 D1 8E 90
0270 | F0 AA D2 DD 05 E9 04 A0 E6 0A 2E 0E 6C 5C 88 E6
0280 | CA 48 0E B0 6C 2D 4B 90 05 9B E2 ED</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C47C85C7B67966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>9C020000</code> (668 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200AC77CBFE838DE11744AE4F4F</code> <code>6A5807512D703C944733A32E972AAB59</code> <code>60CAF263739709AAD416E55DFFB2FBCF</code> <code>33BC68B4633312C4C782850470C23B0B</code> <code>9A26B513BA0DB0B096DB4F810BE902F5</code> <code>7D82448E55C5A27BFCB194709BD931C8</code> <code>9D8C33698CA5161E56246945558E0AC4</code> <code>59B4FD342013518DA2F84BB7FCE730CD</code> <code>9EA98C979CE400010E1B409908E7DD8A</code> <code>98B7505369F7221A584E8315E7686844</code> <code>5C4BCB804CE8DED7DECF1F734D51F196</code> <code>C90615DF6E281588482032A7398B58AB</code> <code>2B843AE2E15483AF15FB4616EDA77921</code> <code>B13251914233105111F3CE132EAAD71A</code> <code>41CEF2F2BC462FCBEC2E9160FB7BE088</code> <code>FF3E8217249421B78B224AA84D73283F</code> <code>0E0A6DF765A613C79D5C2B74EB48D0DA</code> <code>B575B0DA6A8CECFC046B7456739858E1</code> <code>40876D6D64C81346BE8C621AD832C579</code> <code>0B4482AA99F9ECD639F2E119F8E90B2C</code> <code>FE3F2559C4489016A7DC504F10901053</code> <code>E9EAF8A71E375F22A2762A17CACA647C</code> <code>5AAE724DEFC743103019664A266B9C4B</code> <code>D6BED9D29E8CCC41BFEC4E91639F1282</code> <code>3A5B709B1C941ADEBF2B07DB33E59FE5</code> <code>178BF111DA78C38489C9F21BBF0B30DA</code> <code>C39E34A060388CDCF8BFA40239DCA51D</code> <code>4EB4ADAB45E893F91B9BF4F5A282398F</code> <code>63D1AADDA7034319EA839A9486A277B1</code> <code>6CFBCCEB20F7D512321B03C332929E42</code> <code>2DEFC6FF5A9D57628B61D8F4112F42B5</code> <code>7C838B6403EE214F77876D855DFC81F9</code> <code>4FC4F764A7558632FAA320DA1A6697D9</code> <code>41C9D83A06190E7679E6A9906BC213E3</code> <code>596F14154671CD71DEFABA8918235556</code> <code>3C44386083D18E90F0AAD2DD05E904A0</code> <code>E60A2E0E6C5C88E6CA480EB06C2D4B90</code><br> <code>059BE2ED</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = AC77CBFE838DE11744AE4F4F6A5807512D703C944733A32E972AAB5960CAF263739709AAD416E55DFFB2FBCF33BC68B4633312C4C782850470C23B0B9A26B513BA0DB0B096DB4F810BE902F57D82448E55C5A27BFCB194709BD931C89D8C33698CA5161E56246945558E0AC459B4FD342013518DA2F84BB7FCE730CD9EA98C979CE400010E1B409908E7DD8A98B7505369F7221A584E8315E76868445C4BCB804CE8DED7DECF1F734D51F196C90615DF6E281588482032A7398B58AB2B843AE2E15483AF15FB4616EDA77921B13251914233105111F3CE132EAAD71A41CEF2F2BC462FCBEC2E9160FB7BE088FF3E8217249421B78B224AA84D73283F0E0A6DF765A613C79D5C2B74EB48D0DAB575B0DA6A8CECFC046B7456739858E140876D6D64C81346BE8C621AD832C5790B4482AA99F9ECD639F2E119F8E90B2CFE3F2559C4489016A7DC504F10901053E9EAF8A71E375F22A2762A17CACA647C5AAE724DEFC743103019664A266B9C4BD6BED9D29E8CCC41BFEC4E91639F12823A5B709B1C941ADEBF2B07DB33E59FE5178BF111DA78C38489C9F21BBF0B30DAC39E34A060388CDCF8BFA40239DCA51D4EB4ADAB45E893F91B9BF4F5A282398F63D1AADDA7034319EA839A9486A277B16CFBCCEB20F7D512321B03C332929E422DEFC6FF5A9D57628B61D8F4112F42B57C838B6403EE214F77876D855DFC81F94FC4F764A7558632FAA320DA1A6697D941C9D83A06190E7679E6A9906BC213E3596F14154671CD71DEFABA89182355563C44386083D18E90F0AAD2DD05E904A0E60A2E0E6C5C88E6CA480EB06C2D4B90059BE2ED
tmp_aes_key = B92981189223E79306ED28A79803166CB9955A23AB1278C4F2C911449BCBA10B
tmp_aes_iv = 72CF3E363A1C6658B900F9427A230DC6EA595327438D5C28EB9287336BC160F4</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 122F0BCC970E84F81E1B0E7877EFED5B71E1AF95BA0D89B5FF94B249023BA88DA02FD69579D7C403C7A1D45C25AF9279BD9C96D71448D3D303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010062F2AE811E0E1B9DCF3FA2499A356EEC8E942B61E888519CC6309519FA871E75439A28E33CAA3F3E4D8AC20818A5C76633F121D98EFA3BD8250F2D926F310D7E88C205E6092180504C8C4B9027D61492F208B0CF197E4B56067D8FE9F1222D0E3C3C04BE92189932A0AA3A2C910CBBD0C6645FB1972C807D66E012B5FA5EB4A4D8B60E3E59B5F03EB757C5CC4C54ED4E0AD5F07214D70DA97A62A7403B7A32E62B3732501F9B1359230BDF120E4DCF18AB339EE8883E2D800355B0E5F351EAE23FD44B60F649CC293C0039D673ABD9B0708AE9028230BED69DD51DA75C1B8801F597324F3A7CB4683BD609B9BD40DE9D52E0868547C0A9D9F579B6128A62F14EC7B67966AB8328A1388D04BA
answer = BA0D89B5FF94B249023BA88DA02FD69579D7C403C7A1D45C25AF9279BD9C96D71448D3D303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010062F2AE811E0E1B9DCF3FA2499A356EEC8E942B61E888519CC6309519FA871E75439A28E33CAA3F3E4D8AC20818A5C76633F121D98EFA3BD8250F2D926F310D7E88C205E6092180504C8C4B9027D61492F208B0CF197E4B56067D8FE9F1222D0E3C3C04BE92189932A0AA3A2C910CBBD0C6645FB1972C807D66E012B5FA5EB4A4D8B60E3E59B5F03EB757C5CC4C54ED4E0AD5F07214D70DA97A62A7403B7A32E62B3732501F9B1359230BDF120E4DCF18AB339EE8883E2D800355B0E5F351EAE23FD44B60F649CC293C0039D673ABD9B0708AE9028230BED69DD51DA75C1B8801F597324F3A7CB4683BD609B9BD40DE9D52E0868547C0A9D9F579B6128A62F14EC7B67966AB8328A1388D04BA</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 FF 94 B2 49 02 3B A8 8D A0 2F D6 95
0010 | 79 D7 C4 03 C7 A1 D4 5C 25 AF 92 79 BD 9C 96 D7
0020 | 14 48 D3 D3 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 62 F2 AE 81 1E 0E 1B 9D CF 3F A2 49 9A 35 6E EC
0140 | 8E 94 2B 61 E8 88 51 9C C6 30 95 19 FA 87 1E 75
0150 | 43 9A 28 E3 3C AA 3F 3E 4D 8A C2 08 18 A5 C7 66
0160 | 33 F1 21 D9 8E FA 3B D8 25 0F 2D 92 6F 31 0D 7E
0170 | 88 C2 05 E6 09 21 80 50 4C 8C 4B 90 27 D6 14 92
0180 | F2 08 B0 CF 19 7E 4B 56 06 7D 8F E9 F1 22 2D 0E
0190 | 3C 3C 04 BE 92 18 99 32 A0 AA 3A 2C 91 0C BB D0
01A0 | C6 64 5F B1 97 2C 80 7D 66 E0 12 B5 FA 5E B4 A4
01B0 | D8 B6 0E 3E 59 B5 F0 3E B7 57 C5 CC 4C 54 ED 4E
01C0 | 0A D5 F0 72 14 D7 0D A9 7A 62 A7 40 3B 7A 32 E6
01D0 | 2B 37 32 50 1F 9B 13 59 23 0B DF 12 0E 4D CF 18
01E0 | AB 33 9E E8 88 3E 2D 80 03 55 B0 E5 F3 51 EA E2
01F0 | 3F D4 4B 60 F6 49 CC 29 3C 00 39 D6 73 AB D9 B0
0200 | 70 8A E9 02 82 30 BE D6 9D D5 1D A7 5C 1B 88 01
0210 | F5 97 32 4F 3A 7C B4 68 3B D6 09 B9 BD 40 DE 9D
0220 | 52 E0 86 85 47 C0 A9 D9 F5 79 B6 12 8A 62 F1 4E
0230 | C7 B6 79 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010062F2AE811E0E1B9DCF3FA249</code> <code>9A356EEC8E942B61E888519CC6309519</code> <code>FA871E75439A28E33CAA3F3E4D8AC208</code> <code>18A5C76633F121D98EFA3BD8250F2D92</code> <code>6F310D7E88C205E6092180504C8C4B90</code> <code>27D61492F208B0CF197E4B56067D8FE9</code> <code>F1222D0E3C3C04BE92189932A0AA3A2C</code> <code>910CBBD0C6645FB1972C807D66E012B5</code> <code>FA5EB4A4D8B60E3E59B5F03EB757C5CC</code> <code>4C54ED4E0AD5F07214D70DA97A62A740</code> <code>3B7A32E62B3732501F9B1359230BDF12</code> <code>0E4DCF18AB339EE8883E2D800355B0E5</code> <code>F351EAE23FD44B60F649CC293C0039D6</code> <code>73ABD9B0708AE9028230BED69DD51DA7</code> <code>5C1B8801F597324F3A7CB4683BD609B9</code> <code>BD40DE9D52E0868547C0A9D9F579B612</code><br> <code>8A62F14E</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>C7B67966</code> (1719252679 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A54F266C33E710D2AE04BD6E09C07FD1AD4C8EABF98BD4E7F0A48BB3889E563ABF2CE4AE130E1C7BCAD117D743F4F7618B27E9922C8F23207AFFD4A4E1E1D9253CDBB6DEBEA5C674FE95FD55097B14276BC46C90FCCB8DEC0273CCC45BD5FA3B204E8CA52FCDCABC7810FDD4AEB4796F60876FDC4F82F1C08C8A54788440206B4D8638001A47F0BA57576DAA500B7954CA488F97E65C7A4F68B423357F7E1F55C8E5B10C130F074E68117313C62B31468F21C952B2DC519BB5C06CD5970C0EB4EC9F52984EF0E40854F3D0039AD8B33B17920F2F3423DC8CCD3D3076D6CA1DD135E5461A490C3FF437CA4EB537629205BF38A11C84255CFD05098500F15AA9CD</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 2812EBAAD2502B9846CA086240815E5CDAAC50FD49CB4A1ACE8D15849913D414068A6EF361A19D94F8758A818F967CCEC13BF05A494EAA2291F8A928592060F0D73A84A29BB66EDD9F734BEEF6F750AD14E4BED67832CDC670022EC1B7C6984E0963CE8252CC73064B8BF1D407CAD64BDDABDC313ED3C349A45992386B9E87C46CDC5257D7E2935DF0F4B10E3A30159EAC7FE6AF6561DCD33AF6F733B2E3EF36CD00C35F907E19334A80954B08F330ACD9684A6561240A785A8C8774FE6078738DB8D6776D6CCAC2BA68EC519C6EBCC8C39ED5B9474B43E7F547320F57F27C33ADF296C48107E64847AEBACB8E69C76CE003C1D6D373DDE80389C79706E8A260</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 FF 94 B2 49 02 3B A8 8D A0 2F D6 95
0010 | 79 D7 C4 03 C7 A1 D4 5C 25 AF 92 79 BD 9C 96 D7
0020 | 14 48 D3 D3 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 28 12 EB AA D2 50 2B 98 46 CA 08 62 40 81 5E 5C
0040 | DA AC 50 FD 49 CB 4A 1A CE 8D 15 84 99 13 D4 14
0050 | 06 8A 6E F3 61 A1 9D 94 F8 75 8A 81 8F 96 7C CE
0060 | C1 3B F0 5A 49 4E AA 22 91 F8 A9 28 59 20 60 F0
0070 | D7 3A 84 A2 9B B6 6E DD 9F 73 4B EE F6 F7 50 AD
0080 | 14 E4 BE D6 78 32 CD C6 70 02 2E C1 B7 C6 98 4E
0090 | 09 63 CE 82 52 CC 73 06 4B 8B F1 D4 07 CA D6 4B
00A0 | DD AB DC 31 3E D3 C3 49 A4 59 92 38 6B 9E 87 C4
00B0 | 6C DC 52 57 D7 E2 93 5D F0 F4 B1 0E 3A 30 15 9E
00C0 | AC 7F E6 AF 65 61 DC D3 3A F6 F7 33 B2 E3 EF 36
00D0 | CD 00 C3 5F 90 7E 19 33 4A 80 95 4B 08 F3 30 AC
00E0 | D9 68 4A 65 61 24 0A 78 5A 8C 87 74 FE 60 78 73
00F0 | 8D B8 D6 77 6D 6C CA C2 BA 68 EC 51 9C 6E BC C8
0100 | C3 9E D5 B9 47 4B 43 E7 F5 47 32 0F 57 F2 7C 33
0110 | AD F2 96 C4 81 07 E6 48 47 AE BA CB 8E 69 C7 6C
0120 | E0 03 C1 D6 D3 73 DD E8 03 89 C7 97 06 E8 A2 60</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001002812EBAAD2502B9846CA0862</code> <code>40815E5CDAAC50FD49CB4A1ACE8D1584</code> <code>9913D414068A6EF361A19D94F8758A81</code> <code>8F967CCEC13BF05A494EAA2291F8A928</code> <code>592060F0D73A84A29BB66EDD9F734BEE</code> <code>F6F750AD14E4BED67832CDC670022EC1</code> <code>B7C6984E0963CE8252CC73064B8BF1D4</code> <code>07CAD64BDDABDC313ED3C349A4599238</code> <code>6B9E87C46CDC5257D7E2935DF0F4B10E</code> <code>3A30159EAC7FE6AF6561DCD33AF6F733</code> <code>B2E3EF36CD00C35F907E19334A80954B</code> <code>08F330ACD9684A6561240A785A8C8774</code> <code>FE6078738DB8D6776D6CCAC2BA68EC51</code> <code>9C6EBCC8C39ED5B9474B43E7F547320F</code> <code>57F27C33ADF296C48107E64847AEBACB</code> <code>8E69C76CE003C1D6D373DDE80389C797</code><br> <code>06E8A260</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366FF94B249023BA88DA02FD69579D7C403C7A1D45C25AF9279BD9C96D71448D3D30000000000000000FE0001002812EBAAD2502B9846CA086240815E5CDAAC50FD49CB4A1ACE8D15849913D414068A6EF361A19D94F8758A818F967CCEC13BF05A494EAA2291F8A928592060F0D73A84A29BB66EDD9F734BEEF6F750AD14E4BED67832CDC670022EC1B7C6984E0963CE8252CC73064B8BF1D407CAD64BDDABDC313ED3C349A45992386B9E87C46CDC5257D7E2935DF0F4B10E3A30159EAC7FE6AF6561DCD33AF6F733B2E3EF36CD00C35F907E19334A80954B08F330ACD9684A6561240A785A8C8774FE6078738DB8D6776D6CCAC2BA68EC519C6EBCC8C39ED5B9474B43E7F547320F57F27C33ADF296C48107E64847AEBACB8E69C76CE003C1D6D373DDE80389C79706E8A260
padding = 0FA99B2C4A0BCBC2F585926D
tmp_aes_key = B92981189223E79306ED28A79803166CB9955A23AB1278C4F2C911449BCBA10B
tmp_aes_iv = 72CF3E363A1C6658B900F9427A230DC6EA595327438D5C28EB9287336BC160F4</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 92F33178E8FD0B2503164E4958B30642017D6B3ED097E631790E1A91918986FDC7EEA2375114CE417AFF2BBD1508949A9C516982DA4262E6B3020961D6D2348B1F31B0C04742D8360C14E17289CCE08EC6CDE27BDAB946958AF0CA145431094F6560DDC3C05C03135E11EBFCA46D9D4C925B52905C9DBB6E8331B2EF04A3044BF0E304BA153269246E59C769F047C25D87D3EF13FA9F404F0647B5C3B2D815318C4C07BCBB40A2144DEF9498E28B797EE84F2EA06D261E6294826D16343903D64DE50041EA0C806C120D5F3C9DF63276AD2BB80F96CF96A0B42924F6A0BCF61B2BD107197F253A31E7154C5E15301015A407AB433910F5F6CBC746B620577CA92F1A77B49B17F47A262CE97EBBFDC367E6015FB32AA0D51C21A1640DCA7A3D75443D5D7706FCE4BF755799E5FC1982E7A05D97E594529E31CBCA24DC32B98BBFDB3C6B2C5D87C3C7D5E90423FDAAE254</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A0 47 0A 00 C7 B6 79 66
0010 | 78 01 00 00 1F 5F 04 F5 FF 94 B2 49 02 3B A8 8D
0020 | A0 2F D6 95 79 D7 C4 03 C7 A1 D4 5C 25 AF 92 79
0030 | BD 9C 96 D7 14 48 D3 D3 FE 50 01 00 92 F3 31 78
0040 | E8 FD 0B 25 03 16 4E 49 58 B3 06 42 01 7D 6B 3E
0050 | D0 97 E6 31 79 0E 1A 91 91 89 86 FD C7 EE A2 37
0060 | 51 14 CE 41 7A FF 2B BD 15 08 94 9A 9C 51 69 82
0070 | DA 42 62 E6 B3 02 09 61 D6 D2 34 8B 1F 31 B0 C0
0080 | 47 42 D8 36 0C 14 E1 72 89 CC E0 8E C6 CD E2 7B
0090 | DA B9 46 95 8A F0 CA 14 54 31 09 4F 65 60 DD C3
00A0 | C0 5C 03 13 5E 11 EB FC A4 6D 9D 4C 92 5B 52 90
00B0 | 5C 9D BB 6E 83 31 B2 EF 04 A3 04 4B F0 E3 04 BA
00C0 | 15 32 69 24 6E 59 C7 69 F0 47 C2 5D 87 D3 EF 13
00D0 | FA 9F 40 4F 06 47 B5 C3 B2 D8 15 31 8C 4C 07 BC
00E0 | BB 40 A2 14 4D EF 94 98 E2 8B 79 7E E8 4F 2E A0
00F0 | 6D 26 1E 62 94 82 6D 16 34 39 03 D6 4D E5 00 41
0100 | EA 0C 80 6C 12 0D 5F 3C 9D F6 32 76 AD 2B B8 0F
0110 | 96 CF 96 A0 B4 29 24 F6 A0 BC F6 1B 2B D1 07 19
0120 | 7F 25 3A 31 E7 15 4C 5E 15 30 10 15 A4 07 AB 43
0130 | 39 10 F5 F6 CB C7 46 B6 20 57 7C A9 2F 1A 77 B4
0140 | 9B 17 F4 7A 26 2C E9 7E BB FD C3 67 E6 01 5F B3
0150 | 2A A0 D5 1C 21 A1 64 0D CA 7A 3D 75 44 3D 5D 77
0160 | 06 FC E4 BF 75 57 99 E5 FC 19 82 E7 A0 5D 97 E5
0170 | 94 52 9E 31 CB CA 24 DC 32 B9 8B BF DB 3C 6B 2C
0180 | 5D 87 C3 C7 D5 E9 04 23 FD AA E2 54</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A0470A00C7B67966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010092F33178E8FD0B2503164E49</code> <code>58B30642017D6B3ED097E631790E1A91</code> <code>918986FDC7EEA2375114CE417AFF2BBD</code> <code>1508949A9C516982DA4262E6B3020961</code> <code>D6D2348B1F31B0C04742D8360C14E172</code> <code>89CCE08EC6CDE27BDAB946958AF0CA14</code> <code>5431094F6560DDC3C05C03135E11EBFC</code> <code>A46D9D4C925B52905C9DBB6E8331B2EF</code> <code>04A3044BF0E304BA153269246E59C769</code> <code>F047C25D87D3EF13FA9F404F0647B5C3</code> <code>B2D815318C4C07BCBB40A2144DEF9498</code> <code>E28B797EE84F2EA06D261E6294826D16</code> <code>343903D64DE50041EA0C806C120D5F3C</code> <code>9DF63276AD2BB80F96CF96A0B42924F6</code> <code>A0BCF61B2BD107197F253A31E7154C5E</code> <code>15301015A407AB433910F5F6CBC746B6</code> <code>20577CA92F1A77B49B17F47A262CE97E</code> <code>BBFDC367E6015FB32AA0D51C21A1640D</code> <code>CA7A3D75443D5D7706FCE4BF755799E5</code> <code>FC1982E7A05D97E594529E31CBCA24DC</code> <code>32B98BBFDB3C6B2C5D87C3C7D5E90423</code><br> <code>FDAAE254</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 8904B87CFFDED98818B2927ABDF5869D8CA8E3F6DBE8B33CAB82916448C5FADB045CD67CDAFF9B9FF02E0516F9AA76A250AB2ACCDDB0EB7ACC6524CB9775BA0CD241F367CD15F914778F0B8CF31DB96A02665047C1CB12D256391C865753B4F4DF36F66F0CAF67F9055D926C8081AE913CE6DC83769525887D28314D63A9F299819F2E7169AE7FD6F0A54D87F7CC75718FC12A7648C8C8AD57B65F0782AF30A506DF4A7659A862CE0F488D9F3949D1389242861C0854E58CE790BAC3DDE9CA070FB6542069A6B5430747A16D28A14512A8FF07B4F7B3D7D35EDFE62EBC58E70C02355B9AEA42D35B85C89745F4DA13D45F97FCBB27FADAB03E3175F300E19530</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 A2 13 C8 B6 79 66
0010 | 64 00 00 00 34 F7 CB 3B FF 94 B2 49 02 3B A8 8D
0020 | A0 2F D6 95 79 D7 C4 03 C7 A1 D4 5C 25 AF 92 79
0030 | BD 9C 96 D7 14 48 D3 D3 69 A3 12 8D CE F2 30 8A
0040 | 1F 7F 3B 8A 3D 5C 7E 37</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E0A213C8B67966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>64000000</code> (100 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FF94B249023BA88DA02FD69579D7C403</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C7A1D45C25AF9279BD9C96D71448D3D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>69A3128DCEF2308A1F7F3B8A3D5C7E37</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

