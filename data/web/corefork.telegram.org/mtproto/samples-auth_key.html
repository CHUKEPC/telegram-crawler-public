<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?245" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 BC 82 06 00 9C 49 8A 68
0010 | 14 00 00 00 F1 8E 7E BE 64 EC F1 32 61 E9 43 C7
0020 | 3D 63 26 01 10 68 10 C1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>BC8206009C498A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 AC BB AA 9C 49 8A 68
0010 | 50 00 00 00 63 24 16 05 64 EC F1 32 61 E9 43 C7
0020 | 3D 63 26 01 10 68 10 C1 F4 EF E4 F5 A6 81 F5 2A
0030 | 4D F9 3A 91 BE 27 10 DB 08 13 A3 6F D8 2A ED CE
0040 | 55 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01ACBBAA9C498A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0813A36FD82AEDCE55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1415097682148314709</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1415097682148314709</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1415097682148314709 = 1003180813 * 1410610793</code></p>
<pre><code>p = 1003180813
q = 1410610793</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 13 A3 6F D8 2A ED CE 55 00 00 00
0010 | 04 3B CB 53 0D 00 00 00 04 54 14 36 69 00 00 00
0020 | 64 EC F1 32 61 E9 43 C7 3D 63 26 01 10 68 10 C1
0030 | F4 EF E4 F5 A6 81 F5 2A 4D F9 3A 91 BE 27 10 DB
0040 | 08 40 E6 BD 96 67 79 3E BF 63 D9 06 BF 20 01 6C
0050 | C3 73 8E A5 07 86 EA 54 C8 E8 78 AC A6 C3 17 DC
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0813A36FD82AEDCE55000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1415097682148314709</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043BCB530D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1003180813</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0454143669000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1410610793</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>0840E6BD9667793EBF63D906BF20016C</code> <code>C3738EA50786EA54C8E878ACA6C317DC</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90813A36FD82AEDCE55000000043BCB530D000000045414366900000064ECF13261E943C73D632601106810C1F4EFE4F5A681F52A4DF93A91BE2710DB0840E6BD9667793EBF63D906BF20016CC3738EA50786EA54C8E878ACA6C317DC02000000
random_padding_bytes = 54F3EB3EA825703627AEF5673BF134209EB1EC839C3B7D7128872A1613336B496D3DCB94A2BC1DE0E54140B308DB491E212D4805299EE9676A6F0B374C54C150C75EB78A55132C4FA3D9D648A461F6988D2F6951CFCC2187907BA840</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B9D29315F6A05585FC5A48C0B7D51DB9221729E2DB3DCEEA636F528C87A505617E9BE1140E3BC0DB1627B3641C09E5B92B4BFCF01A04EBC08B1CCFD00D90A243C60CDD7A1945B437B659FDACF410014AAFF6A44C4A18A0EA5363C36F6E6050402F54E2E31D9347FFB2E05315E5498444B3CDAFFCB39A8E9E2A4019ADDA60EDAB6023F4D33DCA7644A33007242A18F3DEAD968A3D06E1E3D2DF4C7856493A35CFE7FFC90D9B81D4F17BF3E109BAA1896ABA23412C8BE10CFF58B9C376DD631AA1FF24115F1A9151D9B8EBCCF304BFBC18F2E0A0C48BFF42D7171EEE89A43D8D039C0EDCE08695E48AC8A6AFA21652D9F3E5821183BE5819AC7D21362FB7912B04</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 82 06 00 9C 49 8A 68
0010 | 40 01 00 00 BE E4 12 D7 64 EC F1 32 61 E9 43 C7
0020 | 3D 63 26 01 10 68 10 C1 F4 EF E4 F5 A6 81 F5 2A
0030 | 4D F9 3A 91 BE 27 10 DB 04 3B CB 53 0D 00 00 00
0040 | 04 54 14 36 69 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B9 D2 93 15 F6 A0 55 85 FC 5A 48 C0
0060 | B7 D5 1D B9 22 17 29 E2 DB 3D CE EA 63 6F 52 8C
0070 | 87 A5 05 61 7E 9B E1 14 0E 3B C0 DB 16 27 B3 64
0080 | 1C 09 E5 B9 2B 4B FC F0 1A 04 EB C0 8B 1C CF D0
0090 | 0D 90 A2 43 C6 0C DD 7A 19 45 B4 37 B6 59 FD AC
00A0 | F4 10 01 4A AF F6 A4 4C 4A 18 A0 EA 53 63 C3 6F
00B0 | 6E 60 50 40 2F 54 E2 E3 1D 93 47 FF B2 E0 53 15
00C0 | E5 49 84 44 B3 CD AF FC B3 9A 8E 9E 2A 40 19 AD
00D0 | DA 60 ED AB 60 23 F4 D3 3D CA 76 44 A3 30 07 24
00E0 | 2A 18 F3 DE AD 96 8A 3D 06 E1 E3 D2 DF 4C 78 56
00F0 | 49 3A 35 CF E7 FF C9 0D 9B 81 D4 F1 7B F3 E1 09
0100 | BA A1 89 6A BA 23 41 2C 8B E1 0C FF 58 B9 C3 76
0110 | DD 63 1A A1 FF 24 11 5F 1A 91 51 D9 B8 EB CC F3
0120 | 04 BF BC 18 F2 E0 A0 C4 8B FF 42 D7 17 1E EE 89
0130 | A4 3D 8D 03 9C 0E DC E0 86 95 E4 8A C8 A6 AF A2
0140 | 16 52 D9 F3 E5 82 11 83 BE 58 19 AC 7D 21 36 2F
0150 | B7 91 2B 04</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C08206009C498A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043BCB530D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1003180813</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0454143669000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1410610793</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B9D29315F6A05585FC5A48C0</code> <code>B7D51DB9221729E2DB3DCEEA636F528C</code> <code>87A505617E9BE1140E3BC0DB1627B364</code> <code>1C09E5B92B4BFCF01A04EBC08B1CCFD0</code> <code>0D90A243C60CDD7A1945B437B659FDAC</code> <code>F410014AAFF6A44C4A18A0EA5363C36F</code> <code>6E6050402F54E2E31D9347FFB2E05315</code> <code>E5498444B3CDAFFCB39A8E9E2A4019AD</code> <code>DA60EDAB6023F4D33DCA7644A3300724</code> <code>2A18F3DEAD968A3D06E1E3D2DF4C7856</code> <code>493A35CFE7FFC90D9B81D4F17BF3E109</code> <code>BAA1896ABA23412C8BE10CFF58B9C376</code> <code>DD631AA1FF24115F1A9151D9B8EBCCF3</code> <code>04BFBC18F2E0A0C48BFF42D7171EEE89</code> <code>A43D8D039C0EDCE08695E48AC8A6AFA2</code> <code>1652D9F3E5821183BE5819AC7D21362F</code><br> <code>B7912B04</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 64 E5 DC 9C 49 8A 68
0010 | 78 02 00 00 5C 07 E8 D0 64 EC F1 32 61 E9 43 C7
0020 | 3D 63 26 01 10 68 10 C1 F4 EF E4 F5 A6 81 F5 2A
0030 | 4D F9 3A 91 BE 27 10 DB FE 50 02 00 F3 B7 0B FC
0040 | C7 6A 6A 94 8A 48 7E A0 FB E4 F1 79 35 6D 6A 8A
0050 | CB D2 B3 89 29 EA 96 63 F2 E4 D7 28 82 38 CD 3F
0060 | 8D B6 98 DF 24 E9 4A 33 81 45 25 91 2D 6D 5E 51
0070 | FE 3A 83 74 76 81 35 7B A8 BB 50 BB AB 29 19 3F
0080 | 59 E0 AA 18 7B F4 EB 5B D6 AC DC 4A 66 DF 87 89
0090 | EB 73 86 15 1A 11 13 74 61 C5 2F F2 BB AB C7 37
00A0 | 30 A1 9F 4F DB 21 88 C4 C4 DE 11 EF 68 40 2D 7B
00B0 | 24 F6 83 74 17 E3 88 82 AF 48 4D 2E 28 23 41 5B
00C0 | 38 CF 45 51 E4 88 52 21 1E 7A 6A 05 A1 2D E9 C0
00D0 | A1 C1 EC D9 DC E1 38 75 42 F6 7D 02 30 08 D6 CE
00E0 | 48 81 90 47 82 4B 1A DB 88 8F FD 3F F2 6A 61 78
00F0 | 64 BD 5C 84 A7 05 C1 23 F4 25 E9 A4 32 28 D0 1A
0100 | AF 61 6C 72 65 09 B6 6A 48 53 0A 2C F9 2E 41 F5
0110 | 8F CF 95 FA 83 5E 1F 95 71 6B 28 AA 07 FB D0 72
0120 | 97 FF 2B 38 66 CC 06 89 9B BF 24 33 AC EB 7A CB
0130 | 04 64 BF BE 18 CC 5A 3A C8 4B 82 4C C0 5B F5 41
0140 | 6F 22 DB F5 3E E5 90 23 B9 E6 C7 43 9F 58 84 DA
0150 | 51 92 1F 87 A1 DA FD FE FE C9 53 4D DD C5 60 BA
0160 | 74 F7 63 C7 1E 2D D2 33 1D 8A 4B 07 B8 FD 0D 68
0170 | 20 7F E0 11 05 86 C1 C5 ED 0F 55 7F 0F 03 33 69
0180 | D7 BA 85 5C 67 5E 31 CA 0E FB 16 86 CC 4F 67 F2
0190 | 49 B6 45 37 76 E2 35 03 10 EC 80 B0 40 A4 6C F2
01A0 | D4 BD F2 41 68 A3 AB E4 D3 48 49 2C E8 8E B0 46
01B0 | 7D 86 98 04 AA 43 B9 FA C4 B6 10 10 3D C3 D5 6A
01C0 | C8 92 42 8C 24 3D 75 7B 55 60 4C 5E 26 0B 90 36
01D0 | F5 16 83 EF D1 0D 3A 39 86 64 CA 08 EB 5A 0F CE
01E0 | 88 7C AD E8 CA 38 5C 40 6E DB 94 F3 BE 44 C0 78
01F0 | 19 A3 B2 89 6B 42 30 E8 CB 59 96 FD A0 A6 E6 A0
0200 | 59 79 CF F2 CC DE 72 9D B0 D2 16 D3 41 8D FF 28
0210 | F0 E1 36 58 4F 4F F3 F7 D8 E4 6A 24 08 FB 82 21
0220 | 95 F8 CC F4 54 0D 86 83 09 2A C5 ED CB 07 DF 4B
0230 | 44 AD C2 BE 50 BC EB 12 B6 20 63 F3 79 10 5A D6
0240 | F9 89 08 61 B3 0F 0C 5E BB 2C D0 9E FD 38 DD 3B
0250 | 31 61 BA A7 BA 16 41 09 CA E7 DE 69 72 FF F3 21
0260 | 81 3D 1A A3 FD CC 9E C5 6A 3F 1D 0B C3 42 83 C8
0270 | 51 DB 3D 03 47 DC 39 B7 6D 1D D7 05 EA 4D 54 53
0280 | A4 9B E6 48 12 DC AF 80 BB 82 38 88</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0164E5DC9C498A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200F3B70BFCC76A6A948A487EA0</code> <code>FBE4F179356D6A8ACBD2B38929EA9663</code> <code>F2E4D7288238CD3F8DB698DF24E94A33</code> <code>814525912D6D5E51FE3A83747681357B</code> <code>A8BB50BBAB29193F59E0AA187BF4EB5B</code> <code>D6ACDC4A66DF8789EB7386151A111374</code> <code>61C52FF2BBABC73730A19F4FDB2188C4</code> <code>C4DE11EF68402D7B24F6837417E38882</code> <code>AF484D2E2823415B38CF4551E4885221</code> <code>1E7A6A05A12DE9C0A1C1ECD9DCE13875</code> <code>42F67D023008D6CE48819047824B1ADB</code> <code>888FFD3FF26A617864BD5C84A705C123</code> <code>F425E9A43228D01AAF616C726509B66A</code> <code>48530A2CF92E41F58FCF95FA835E1F95</code> <code>716B28AA07FBD07297FF2B3866CC0689</code> <code>9BBF2433ACEB7ACB0464BFBE18CC5A3A</code> <code>C84B824CC05BF5416F22DBF53EE59023</code> <code>B9E6C7439F5884DA51921F87A1DAFDFE</code> <code>FEC9534DDDC560BA74F763C71E2DD233</code> <code>1D8A4B07B8FD0D68207FE0110586C1C5</code> <code>ED0F557F0F033369D7BA855C675E31CA</code> <code>0EFB1686CC4F67F249B6453776E23503</code> <code>10EC80B040A46CF2D4BDF24168A3ABE4</code> <code>D348492CE88EB0467D869804AA43B9FA</code> <code>C4B610103DC3D56AC892428C243D757B</code> <code>55604C5E260B9036F51683EFD10D3A39</code> <code>8664CA08EB5A0FCE887CADE8CA385C40</code> <code>6EDB94F3BE44C07819A3B2896B4230E8</code> <code>CB5996FDA0A6E6A05979CFF2CCDE729D</code> <code>B0D216D3418DFF28F0E136584F4FF3F7</code> <code>D8E46A2408FB822195F8CCF4540D8683</code> <code>092AC5EDCB07DF4B44ADC2BE50BCEB12</code> <code>B62063F379105AD6F9890861B30F0C5E</code> <code>BB2CD09EFD38DD3B3161BAA7BA164109</code> <code>CAE7DE6972FFF321813D1AA3FDCC9EC5</code> <code>6A3F1D0BC34283C851DB3D0347DC39B7</code> <code>6D1DD705EA4D5453A49BE64812DCAF80</code><br> <code>BB823888</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = F3B70BFCC76A6A948A487EA0FBE4F179356D6A8ACBD2B38929EA9663F2E4D7288238CD3F8DB698DF24E94A33814525912D6D5E51FE3A83747681357BA8BB50BBAB29193F59E0AA187BF4EB5BD6ACDC4A66DF8789EB7386151A11137461C52FF2BBABC73730A19F4FDB2188C4C4DE11EF68402D7B24F6837417E38882AF484D2E2823415B38CF4551E48852211E7A6A05A12DE9C0A1C1ECD9DCE1387542F67D023008D6CE48819047824B1ADB888FFD3FF26A617864BD5C84A705C123F425E9A43228D01AAF616C726509B66A48530A2CF92E41F58FCF95FA835E1F95716B28AA07FBD07297FF2B3866CC06899BBF2433ACEB7ACB0464BFBE18CC5A3AC84B824CC05BF5416F22DBF53EE59023B9E6C7439F5884DA51921F87A1DAFDFEFEC9534DDDC560BA74F763C71E2DD2331D8A4B07B8FD0D68207FE0110586C1C5ED0F557F0F033369D7BA855C675E31CA0EFB1686CC4F67F249B6453776E2350310EC80B040A46CF2D4BDF24168A3ABE4D348492CE88EB0467D869804AA43B9FAC4B610103DC3D56AC892428C243D757B55604C5E260B9036F51683EFD10D3A398664CA08EB5A0FCE887CADE8CA385C406EDB94F3BE44C07819A3B2896B4230E8CB5996FDA0A6E6A05979CFF2CCDE729DB0D216D3418DFF28F0E136584F4FF3F7D8E46A2408FB822195F8CCF4540D8683092AC5EDCB07DF4B44ADC2BE50BCEB12B62063F379105AD6F9890861B30F0C5EBB2CD09EFD38DD3B3161BAA7BA164109CAE7DE6972FFF321813D1AA3FDCC9EC56A3F1D0BC34283C851DB3D0347DC39B76D1DD705EA4D5453A49BE64812DCAF80BB823888
tmp_aes_key = 128C9760A3A4B028C12CE7FB31A6038DC1C32BC9570E1612B65C6887D2802F4E
tmp_aes_iv = 25A98BEA5389BA4D8D0AD3C9B24F6AC6337E6EC5C665385CBB8E02E30840E6BD</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 83B1B23F55E8C078A2CAF09F1A37B03708A62DF4BA0D89B564ECF13261E943C73D632601106810C1F4EFE4F5A681F52A4DF93A91BE2710DB03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001A08D9857555BE332B12E35F25155FD0D9BCEEF065FA71EE755676EFF6255A5A1A50E9C2F5699533102F3B076566D79E0D813DF353B25F44062FBD4D8A28B14F58DA0586BFB14103214DE2F4C6ED94B5C86E3D0E3C379EB7B5F00C92D6B9FFC5D4C6F10C75F0734ACD086DA3DDAF51C4BBB6DC76D3867CFAAC33D28B6FDFF42E1F620316296F931A0E60812D7EDB4530C13A3EA63702C58BE7EFEE076F8DC741B1EC217B608E5779692F5E18397D16510794C37853A3F332909DCC46A1340462243E2107A269508719939E4810F66EE330F43FBBE06AB8FE23BCE303BA6B04A42ED6704ACB086766433D28DB7F8528744FF5A738B51EE2E7FE2E395F0DD323C39C498A6858A488C0B7BF33EA
answer = BA0D89B564ECF13261E943C73D632601106810C1F4EFE4F5A681F52A4DF93A91BE2710DB03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001A08D9857555BE332B12E35F25155FD0D9BCEEF065FA71EE755676EFF6255A5A1A50E9C2F5699533102F3B076566D79E0D813DF353B25F44062FBD4D8A28B14F58DA0586BFB14103214DE2F4C6ED94B5C86E3D0E3C379EB7B5F00C92D6B9FFC5D4C6F10C75F0734ACD086DA3DDAF51C4BBB6DC76D3867CFAAC33D28B6FDFF42E1F620316296F931A0E60812D7EDB4530C13A3EA63702C58BE7EFEE076F8DC741B1EC217B608E5779692F5E18397D16510794C37853A3F332909DCC46A1340462243E2107A269508719939E4810F66EE330F43FBBE06AB8FE23BCE303BA6B04A42ED6704ACB086766433D28DB7F8528744FF5A738B51EE2E7FE2E395F0DD323C39C498A6858A488C0B7BF33EA</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 64 EC F1 32 61 E9 43 C7 3D 63 26 01
0010 | 10 68 10 C1 F4 EF E4 F5 A6 81 F5 2A 4D F9 3A 91
0020 | BE 27 10 DB 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 1A 08 D9 85 75 55 BE 33 2B 12 E3 5F 25 15 5F D0
0140 | D9 BC EE F0 65 FA 71 EE 75 56 76 EF F6 25 5A 5A
0150 | 1A 50 E9 C2 F5 69 95 33 10 2F 3B 07 65 66 D7 9E
0160 | 0D 81 3D F3 53 B2 5F 44 06 2F BD 4D 8A 28 B1 4F
0170 | 58 DA 05 86 BF B1 41 03 21 4D E2 F4 C6 ED 94 B5
0180 | C8 6E 3D 0E 3C 37 9E B7 B5 F0 0C 92 D6 B9 FF C5
0190 | D4 C6 F1 0C 75 F0 73 4A CD 08 6D A3 DD AF 51 C4
01A0 | BB B6 DC 76 D3 86 7C FA AC 33 D2 8B 6F DF F4 2E
01B0 | 1F 62 03 16 29 6F 93 1A 0E 60 81 2D 7E DB 45 30
01C0 | C1 3A 3E A6 37 02 C5 8B E7 EF EE 07 6F 8D C7 41
01D0 | B1 EC 21 7B 60 8E 57 79 69 2F 5E 18 39 7D 16 51
01E0 | 07 94 C3 78 53 A3 F3 32 90 9D CC 46 A1 34 04 62
01F0 | 24 3E 21 07 A2 69 50 87 19 93 9E 48 10 F6 6E E3
0200 | 30 F4 3F BB E0 6A B8 FE 23 BC E3 03 BA 6B 04 A4
0210 | 2E D6 70 4A CB 08 67 66 43 3D 28 DB 7F 85 28 74
0220 | 4F F5 A7 38 B5 1E E2 E7 FE 2E 39 5F 0D D3 23 C3
0230 | 9C 49 8A 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001001A08D9857555BE332B12E35F</code> <code>25155FD0D9BCEEF065FA71EE755676EF</code> <code>F6255A5A1A50E9C2F5699533102F3B07</code> <code>6566D79E0D813DF353B25F44062FBD4D</code> <code>8A28B14F58DA0586BFB14103214DE2F4</code> <code>C6ED94B5C86E3D0E3C379EB7B5F00C92</code> <code>D6B9FFC5D4C6F10C75F0734ACD086DA3</code> <code>DDAF51C4BBB6DC76D3867CFAAC33D28B</code> <code>6FDFF42E1F620316296F931A0E60812D</code> <code>7EDB4530C13A3EA63702C58BE7EFEE07</code> <code>6F8DC741B1EC217B608E5779692F5E18</code> <code>397D16510794C37853A3F332909DCC46</code> <code>A1340462243E2107A269508719939E48</code> <code>10F66EE330F43FBBE06AB8FE23BCE303</code> <code>BA6B04A42ED6704ACB086766433D28DB</code> <code>7F8528744FF5A738B51EE2E7FE2E395F</code><br> <code>0DD323C3</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>9C498A68</code> (1753893276 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 48D00C4D023EBD87CEBF15359997009C42877903F4AABCDE03BBDBE0E14C31D62853157EB31740BE0E4A7D8C19363673FB00497AF7593AED2FEC9FA0A10939CF6B5D2C80ADF79F0869509C7884DD6BB8DEAABD01868CB7F517899A9B533688C253CB72E8C5FF1B08A5FFB5E9D3F95E11B1AAFCFF5130F355FF07469561270C78ACCBB853CBD9CE2293B2A4916D898D11DE6AB6BC87B62E2E1260D089E029D6927F6FC6F8CF16BCAE22A1A9AF5F2BA80BA15DC7A5B1136153CBA07B3A4C86F89F97C681DE83652B92812DBFC3DAE188B45536513B31221BB99429CC79345538A11BF2621B35BE056DA13945C910578B4DC69A9E805F906A9E9AA1C864C9EC800F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 3E22778D0E9848BA661A3C140AD66B1AC21D6A36EACD723EC9185535D15101A4D66707AF1AF66FF478E6EC11C6C7AC4BFE3C897BACD3544C458221A6B88054C97E1C6079850F750805F1A565EFE1CEC7CCF3EF80B3BEF91AC7BC82B0071D8CBF53623DA627DA341ACAF6AB03356A487BA37D0B2A2794FF33A022A9FF2C1BA080EE61320F1403F89A7FE70D9D78288E704C8243724AAC16FC220F1AB2BA5A2025F41BB6504759F2FAFADF6F1C3C1AD89781E6ECA8E81AD697DF9394CC2504603BFF74DA2D29852866F21B4A4A97538909CAEB9585326FE54AA33414D974A5EA16E17AC867AFE28F88036570967C1C6240D7A43A635CD04F268FA5BE4171955809</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 64 EC F1 32 61 E9 43 C7 3D 63 26 01
0010 | 10 68 10 C1 F4 EF E4 F5 A6 81 F5 2A 4D F9 3A 91
0020 | BE 27 10 DB 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 3E 22 77 8D 0E 98 48 BA 66 1A 3C 14 0A D6 6B 1A
0040 | C2 1D 6A 36 EA CD 72 3E C9 18 55 35 D1 51 01 A4
0050 | D6 67 07 AF 1A F6 6F F4 78 E6 EC 11 C6 C7 AC 4B
0060 | FE 3C 89 7B AC D3 54 4C 45 82 21 A6 B8 80 54 C9
0070 | 7E 1C 60 79 85 0F 75 08 05 F1 A5 65 EF E1 CE C7
0080 | CC F3 EF 80 B3 BE F9 1A C7 BC 82 B0 07 1D 8C BF
0090 | 53 62 3D A6 27 DA 34 1A CA F6 AB 03 35 6A 48 7B
00A0 | A3 7D 0B 2A 27 94 FF 33 A0 22 A9 FF 2C 1B A0 80
00B0 | EE 61 32 0F 14 03 F8 9A 7F E7 0D 9D 78 28 8E 70
00C0 | 4C 82 43 72 4A AC 16 FC 22 0F 1A B2 BA 5A 20 25
00D0 | F4 1B B6 50 47 59 F2 FA FA DF 6F 1C 3C 1A D8 97
00E0 | 81 E6 EC A8 E8 1A D6 97 DF 93 94 CC 25 04 60 3B
00F0 | FF 74 DA 2D 29 85 28 66 F2 1B 4A 4A 97 53 89 09
0100 | CA EB 95 85 32 6F E5 4A A3 34 14 D9 74 A5 EA 16
0110 | E1 7A C8 67 AF E2 8F 88 03 65 70 96 7C 1C 62 40
0120 | D7 A4 3A 63 5C D0 4F 26 8F A5 BE 41 71 95 58 09</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001003E22778D0E9848BA661A3C14</code> <code>0AD66B1AC21D6A36EACD723EC9185535</code> <code>D15101A4D66707AF1AF66FF478E6EC11</code> <code>C6C7AC4BFE3C897BACD3544C458221A6</code> <code>B88054C97E1C6079850F750805F1A565</code> <code>EFE1CEC7CCF3EF80B3BEF91AC7BC82B0</code> <code>071D8CBF53623DA627DA341ACAF6AB03</code> <code>356A487BA37D0B2A2794FF33A022A9FF</code> <code>2C1BA080EE61320F1403F89A7FE70D9D</code> <code>78288E704C8243724AAC16FC220F1AB2</code> <code>BA5A2025F41BB6504759F2FAFADF6F1C</code> <code>3C1AD89781E6ECA8E81AD697DF9394CC</code> <code>2504603BFF74DA2D29852866F21B4A4A</code> <code>97538909CAEB9585326FE54AA33414D9</code> <code>74A5EA16E17AC867AFE28F8803657096</code> <code>7C1C6240D7A43A635CD04F268FA5BE41</code><br> <code>71955809</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436664ECF13261E943C73D632601106810C1F4EFE4F5A681F52A4DF93A91BE2710DB0000000000000000FE0001003E22778D0E9848BA661A3C140AD66B1AC21D6A36EACD723EC9185535D15101A4D66707AF1AF66FF478E6EC11C6C7AC4BFE3C897BACD3544C458221A6B88054C97E1C6079850F750805F1A565EFE1CEC7CCF3EF80B3BEF91AC7BC82B0071D8CBF53623DA627DA341ACAF6AB03356A487BA37D0B2A2794FF33A022A9FF2C1BA080EE61320F1403F89A7FE70D9D78288E704C8243724AAC16FC220F1AB2BA5A2025F41BB6504759F2FAFADF6F1C3C1AD89781E6ECA8E81AD697DF9394CC2504603BFF74DA2D29852866F21B4A4A97538909CAEB9585326FE54AA33414D974A5EA16E17AC867AFE28F88036570967C1C6240D7A43A635CD04F268FA5BE4171955809
padding = 635B0DD0B64510963684DCEF
tmp_aes_key = 128C9760A3A4B028C12CE7FB31A6038DC1C32BC9570E1612B65C6887D2802F4E
tmp_aes_iv = 25A98BEA5389BA4D8D0AD3C9B24F6AC6337E6EC5C665385CBB8E02E30840E6BD</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 987BDC93741970B8A69850760147271ECCA7CE3D05795DCF5A5D8FEABCA0784EEB1948F0D1D7AF669D1C21F6BA7337E39B240AFA3B24FD89BDB712C93358E39670C668DCFDAADF4CF4AB46E9D5EC8921F0F69657B9841AA4F49D4C6B715631F3A08CD730EC132E34C2525A6F1832B8A6F5B7B70F79348C3CAA8BB4D4DF0BCCEA67A6737CA10BE41F4CA33A8E408903EF4294FCAFF7DB6A173DB27770301E7BE29D2834C8F21981968C2CF45F136888DE971132C482B6436808FF2DF8B7FF9FC8BDF74299A9DB249724462D9E1E7E840DFBA083D7A28DD2D2B46F95E57EC5F31E0379175BFD71496EF03EC100BD6CC86BA0EC1F84CB0C4A8702CA484A88362388D42727E83F649612CC9BC3A5B944AE095CEB9FC3C2CB0104023FDB023D602EAE81B303971B40497C88A6022EA4E92B4F128604BA9699C5947C64987EB4203D841ED57341A9367D8280052CDCA0B98926</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C4 82 06 00 9C 49 8A 68
0010 | 78 01 00 00 1F 5F 04 F5 64 EC F1 32 61 E9 43 C7
0020 | 3D 63 26 01 10 68 10 C1 F4 EF E4 F5 A6 81 F5 2A
0030 | 4D F9 3A 91 BE 27 10 DB FE 50 01 00 98 7B DC 93
0040 | 74 19 70 B8 A6 98 50 76 01 47 27 1E CC A7 CE 3D
0050 | 05 79 5D CF 5A 5D 8F EA BC A0 78 4E EB 19 48 F0
0060 | D1 D7 AF 66 9D 1C 21 F6 BA 73 37 E3 9B 24 0A FA
0070 | 3B 24 FD 89 BD B7 12 C9 33 58 E3 96 70 C6 68 DC
0080 | FD AA DF 4C F4 AB 46 E9 D5 EC 89 21 F0 F6 96 57
0090 | B9 84 1A A4 F4 9D 4C 6B 71 56 31 F3 A0 8C D7 30
00A0 | EC 13 2E 34 C2 52 5A 6F 18 32 B8 A6 F5 B7 B7 0F
00B0 | 79 34 8C 3C AA 8B B4 D4 DF 0B CC EA 67 A6 73 7C
00C0 | A1 0B E4 1F 4C A3 3A 8E 40 89 03 EF 42 94 FC AF
00D0 | F7 DB 6A 17 3D B2 77 70 30 1E 7B E2 9D 28 34 C8
00E0 | F2 19 81 96 8C 2C F4 5F 13 68 88 DE 97 11 32 C4
00F0 | 82 B6 43 68 08 FF 2D F8 B7 FF 9F C8 BD F7 42 99
0100 | A9 DB 24 97 24 46 2D 9E 1E 7E 84 0D FB A0 83 D7
0110 | A2 8D D2 D2 B4 6F 95 E5 7E C5 F3 1E 03 79 17 5B
0120 | FD 71 49 6E F0 3E C1 00 BD 6C C8 6B A0 EC 1F 84
0130 | CB 0C 4A 87 02 CA 48 4A 88 36 23 88 D4 27 27 E8
0140 | 3F 64 96 12 CC 9B C3 A5 B9 44 AE 09 5C EB 9F C3
0150 | C2 CB 01 04 02 3F DB 02 3D 60 2E AE 81 B3 03 97
0160 | 1B 40 49 7C 88 A6 02 2E A4 E9 2B 4F 12 86 04 BA
0170 | 96 99 C5 94 7C 64 98 7E B4 20 3D 84 1E D5 73 41
0180 | A9 36 7D 82 80 05 2C DC A0 B9 89 26</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C48206009C498A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100987BDC93741970B8A6985076</code> <code>0147271ECCA7CE3D05795DCF5A5D8FEA</code> <code>BCA0784EEB1948F0D1D7AF669D1C21F6</code> <code>BA7337E39B240AFA3B24FD89BDB712C9</code> <code>3358E39670C668DCFDAADF4CF4AB46E9</code> <code>D5EC8921F0F69657B9841AA4F49D4C6B</code> <code>715631F3A08CD730EC132E34C2525A6F</code> <code>1832B8A6F5B7B70F79348C3CAA8BB4D4</code> <code>DF0BCCEA67A6737CA10BE41F4CA33A8E</code> <code>408903EF4294FCAFF7DB6A173DB27770</code> <code>301E7BE29D2834C8F21981968C2CF45F</code> <code>136888DE971132C482B6436808FF2DF8</code> <code>B7FF9FC8BDF74299A9DB249724462D9E</code> <code>1E7E840DFBA083D7A28DD2D2B46F95E5</code> <code>7EC5F31E0379175BFD71496EF03EC100</code> <code>BD6CC86BA0EC1F84CB0C4A8702CA484A</code> <code>88362388D42727E83F649612CC9BC3A5</code> <code>B944AE095CEB9FC3C2CB0104023FDB02</code> <code>3D602EAE81B303971B40497C88A6022E</code> <code>A4E92B4F128604BA9699C5947C64987E</code> <code>B4203D841ED57341A9367D8280052CDC</code><br> <code>A0B98926</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 530E46F6B16638FF22EBAC10C1146F033CC8C349F80C41B736046915D2D40B4379A5F43864E0E7A11AD9A8B2DA93D1271B05CF018D1A3F122030AFEC936A2758FE421FCB185157AD63BABDA54501C22D55737D7F2F83098EC9EF55B5D2EEAB8D3DA4345CDDBAD10A8183B974A7B0DEE5D99F5A369B0BCB8A5B9271E8B7F92EE2B63472D7717B86447F6F011333805032911B4B8CD723D90C41F259544765C0754073CD9B0911C410834FD57CFDF685460FAF942CE15EA610B65DCAAA39D55C810D1BE66E9DAF8FF9D8CAE70F9DA5F388120FF75CB9EDB4BF4F52EB45791718C3516BC59DD7647C8602595156EAEF095A940552BDE8E7B7AB46CB184672D1133C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 28 38 03 9E 49 8A 68
0010 | 34 00 00 00 34 F7 CB 3B 64 EC F1 32 61 E9 43 C7
0020 | 3D 63 26 01 10 68 10 C1 F4 EF E4 F5 A6 81 F5 2A
0030 | 4D F9 3A 91 BE 27 10 DB 54 F5 F2 29 45 1F 00 03
0040 | 0C 23 1A 8F A4 7C 9D 77</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>012838039E498A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>64ECF13261E943C73D632601106810C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F4EFE4F5A681F52A4DF93A91BE2710DB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>54F5F229451F00030C231A8FA47C9D77</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

