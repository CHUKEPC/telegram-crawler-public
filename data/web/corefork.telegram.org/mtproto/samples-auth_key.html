<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 37 03 00 A3 E9 6E 67
0010 | 14 00 00 00 F1 8E 7E BE 43 92 31 4A C7 7D 7D FB
0020 | 16 F0 E6 BE 52 13 FF E4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A8370300A3E96E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 88 AD E6 A3 E9 6E 67
0010 | 50 00 00 00 63 24 16 05 43 92 31 4A C7 7D 7D FB
0020 | 16 F0 E6 BE 52 13 FF E4 EA 2E 5B D2 98 D0 0D 7E
0030 | 80 FF 33 48 88 6B 83 19 08 19 1F F8 8B 0B 78 3D
0040 | DD 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0188ADE6A3E96E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08191FF88B0B783DDD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1810438851302800861</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1810438851302800861</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1810438851302800861 = 1084931779 * 1668712159</code></p>
<pre><code>p = 1084931779
q = 1668712159</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 1F F8 8B 0B 78 3D DD 00 00 00
0010 | 04 40 AA BE C3 00 00 00 04 63 76 86 DF 00 00 00
0020 | 43 92 31 4A C7 7D 7D FB 16 F0 E6 BE 52 13 FF E4
0030 | EA 2E 5B D2 98 D0 0D 7E 80 FF 33 48 88 6B 83 19
0040 | B7 A4 75 37 62 36 A5 74 19 65 8E A7 99 01 9A 5C
0050 | 66 48 17 BC 07 D8 60 AA 95 31 1A 68 11 44 C6 EA
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08191FF88B0B783DDD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1810438851302800861</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0440AABEC3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1084931779</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04637686DF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1668712159</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>B7A475376236A57419658EA799019A5C</code> <code>664817BC07D860AA95311A681144C6EA</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908191FF88B0B783DDD0000000440AABEC300000004637686DF0000004392314AC77D7DFB16F0E6BE5213FFE4EA2E5BD298D00D7E80FF3348886B8319B7A475376236A57419658EA799019A5C664817BC07D860AA95311A681144C6EA02000000
random_padding_bytes = 3662BE276AF08C8A5BE769B6AE17792A79F255121D733D36D375B75C5D1F6C65CAE75A6564264F82E3EBA26697F7CCE349E19662BF1D8D6C2034D7C389A45FB9B70785D8CD643C7E8E2E3D50120D8802A049BE72ACC9A9A8FF971467</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A77E0B9A96FF3F9EA55D6AE5ED4C2BCA4737A40D15CA51EDFC2C6D8E34F16F1C709F77370F02B485244089FB582233708CC06B304909D1D7240A23842A1A732C6FE87018B4BD74523A355D2BB9126CB43FA7CED27650E66C242D068B66D029F3DD32AAF4834240EF21F8820F5BAA17100EAB9622B57AA0AF2D59A949C1E56583558A05DFF2199EC00F625FCE288C3481E195772DAD64CE1E13FF0A36CAE4B77990EEB715000BA4C067FA1141149AE9CD559C963A233CA7BD611EDC042879184752C797FC944DCC84588ED990F66579D50618D2C229BC776F7E13ACBF5D662C1AA9030DC7481F7AA34A16C83B0254DA88BA88FA647C80E22B9B3A572A05E52E18</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 24 D7 02 00 A4 E9 6E 67
0010 | 40 01 00 00 BE E4 12 D7 43 92 31 4A C7 7D 7D FB
0020 | 16 F0 E6 BE 52 13 FF E4 EA 2E 5B D2 98 D0 0D 7E
0030 | 80 FF 33 48 88 6B 83 19 04 40 AA BE C3 00 00 00
0040 | 04 63 76 86 DF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A7 7E 0B 9A 96 FF 3F 9E A5 5D 6A E5
0060 | ED 4C 2B CA 47 37 A4 0D 15 CA 51 ED FC 2C 6D 8E
0070 | 34 F1 6F 1C 70 9F 77 37 0F 02 B4 85 24 40 89 FB
0080 | 58 22 33 70 8C C0 6B 30 49 09 D1 D7 24 0A 23 84
0090 | 2A 1A 73 2C 6F E8 70 18 B4 BD 74 52 3A 35 5D 2B
00A0 | B9 12 6C B4 3F A7 CE D2 76 50 E6 6C 24 2D 06 8B
00B0 | 66 D0 29 F3 DD 32 AA F4 83 42 40 EF 21 F8 82 0F
00C0 | 5B AA 17 10 0E AB 96 22 B5 7A A0 AF 2D 59 A9 49
00D0 | C1 E5 65 83 55 8A 05 DF F2 19 9E C0 0F 62 5F CE
00E0 | 28 8C 34 81 E1 95 77 2D AD 64 CE 1E 13 FF 0A 36
00F0 | CA E4 B7 79 90 EE B7 15 00 0B A4 C0 67 FA 11 41
0100 | 14 9A E9 CD 55 9C 96 3A 23 3C A7 BD 61 1E DC 04
0110 | 28 79 18 47 52 C7 97 FC 94 4D CC 84 58 8E D9 90
0120 | F6 65 79 D5 06 18 D2 C2 29 BC 77 6F 7E 13 AC BF
0130 | 5D 66 2C 1A A9 03 0D C7 48 1F 7A A3 4A 16 C8 3B
0140 | 02 54 DA 88 BA 88 FA 64 7C 80 E2 2B 9B 3A 57 2A
0150 | 05 E5 2E 18</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>24D70200A4E96E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0440AABEC3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1084931779</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04637686DF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1668712159</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A77E0B9A96FF3F9EA55D6AE5</code> <code>ED4C2BCA4737A40D15CA51EDFC2C6D8E</code> <code>34F16F1C709F77370F02B485244089FB</code> <code>582233708CC06B304909D1D7240A2384</code> <code>2A1A732C6FE87018B4BD74523A355D2B</code> <code>B9126CB43FA7CED27650E66C242D068B</code> <code>66D029F3DD32AAF4834240EF21F8820F</code> <code>5BAA17100EAB9622B57AA0AF2D59A949</code> <code>C1E56583558A05DFF2199EC00F625FCE</code> <code>288C3481E195772DAD64CE1E13FF0A36</code> <code>CAE4B77990EEB715000BA4C067FA1141</code> <code>149AE9CD559C963A233CA7BD611EDC04</code> <code>2879184752C797FC944DCC84588ED990</code> <code>F66579D50618D2C229BC776F7E13ACBF</code> <code>5D662C1AA9030DC7481F7AA34A16C83B</code> <code>0254DA88BA88FA647C80E22B9B3A572A</code><br> <code>05E52E18</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 6C 0B 05 A4 E9 6E 67
0010 | 78 02 00 00 5C 07 E8 D0 43 92 31 4A C7 7D 7D FB
0020 | 16 F0 E6 BE 52 13 FF E4 EA 2E 5B D2 98 D0 0D 7E
0030 | 80 FF 33 48 88 6B 83 19 FE 50 02 00 E6 3D E9 41
0040 | 70 17 09 84 6B 23 23 55 AC 2D 7B 6F AD E6 23 48
0050 | 2D A9 9E CD EE ED 96 FC B2 AC 81 C8 C2 12 40 F3
0060 | 1B BC 2D BE 67 A1 14 19 2E FF 77 E8 F1 4C 07 3A
0070 | BB 39 C4 F4 06 A7 9F 7B E1 37 63 7D 06 47 19 A6
0080 | F4 88 4E 0F 07 20 79 22 AE 64 27 BD 11 A1 20 B5
0090 | 5D 61 39 C5 10 4F D9 38 6B 3C AF 43 94 77 8E E7
00A0 | A7 2E 35 72 46 7C 8C FF 5D AF 60 8C 19 F8 B8 D2
00B0 | FD 88 71 63 90 43 E7 9B 20 F4 34 44 22 7C 68 82
00C0 | FF 80 A7 C8 C5 16 22 1B 9F 6B F4 F3 F8 4F 4F FC
00D0 | 59 5F 43 F9 13 C3 89 AF 29 81 2D 49 4A 8A 43 81
00E0 | 9D 51 C3 3C E5 C1 F2 E8 C5 17 14 78 EF 90 F6 C5
00F0 | 59 50 24 CB 10 19 40 C5 BD 1D DF 4C 2F FA 64 17
0100 | 62 AB FD 54 8B 11 BC 3E 21 30 CD B5 CC 0C A9 93
0110 | D7 86 F3 3C F3 01 EC 6F 47 23 A2 CF CC B3 2B 52
0120 | D7 14 59 5A 17 F9 DF D4 64 9A CF A0 AB 08 51 A9
0130 | E9 A3 2C 00 3A 72 ED 51 E6 ED 02 CA 9E 23 99 99
0140 | B6 53 C2 A3 3D D5 70 0C 41 7E 47 D8 2C 9A 5E 40
0150 | A3 25 CB 04 40 69 50 2E 41 5B 1A 60 D5 D2 87 68
0160 | 02 38 1F A9 34 DD 77 3D 0C D4 80 83 60 96 63 21
0170 | C0 CE A2 DE 44 60 1C 34 A7 C0 B0 7D BD 4D 5E F1
0180 | F9 39 CE AA DE F7 1B A5 7C A2 23 2A FF C1 67 80
0190 | 41 00 F7 7F 8D EB F7 40 D0 53 32 42 3E 7C 77 2B
01A0 | 32 C6 B6 3C 24 74 CC D8 EB C1 99 33 19 F6 C7 E3
01B0 | 16 E7 21 D1 06 6A 16 CD BB 5B CF 83 5D 16 68 A0
01C0 | 2D 42 8F 8C 2D D0 02 2C F8 68 38 8F B5 03 BD C2
01D0 | E3 5A DA F6 4D 6E 48 EA 03 6A 6E 78 99 B7 53 A9
01E0 | 86 EE 0E EE CC AC 88 17 A9 4A D4 82 70 E8 D6 3A
01F0 | AA 26 D4 34 72 5F 3D E2 DF 1F 67 AA AC 9D 10 D9
0200 | AB EA 73 A6 0B 9A 3E A2 C4 5E BB EE 86 EF A2 8D
0210 | 2D 26 86 EB 5E 63 A3 24 CE 3E 2D C4 58 A5 9A 2A
0220 | B1 5C C1 A1 DD 40 08 7C 4E 33 96 09 C2 A5 63 34
0230 | F7 8A 40 3E F4 58 45 40 51 D2 5A 0C 75 FD 5F A0
0240 | EB 46 25 DC 70 04 12 55 A7 5A 19 F2 A7 BE 4E 7B
0250 | A7 3B 15 37 24 8F C9 6B 40 A3 3A 54 AC 3F 2E 37
0260 | 87 0B 7B EB 9E 79 29 B0 0E DC 81 48 97 44 38 B8
0270 | 7B 03 5B 4F 21 B2 29 1B 22 93 A7 B7 16 DC 1B 4A
0280 | 2E 3E AE 9A 5B 31 4C 5E 53 80 BE 16</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>016C0B05A4E96E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200E63DE941701709846B232355</code> <code>AC2D7B6FADE623482DA99ECDEEED96FC</code> <code>B2AC81C8C21240F31BBC2DBE67A11419</code> <code>2EFF77E8F14C073ABB39C4F406A79F7B</code> <code>E137637D064719A6F4884E0F07207922</code> <code>AE6427BD11A120B55D6139C5104FD938</code> <code>6B3CAF4394778EE7A72E3572467C8CFF</code> <code>5DAF608C19F8B8D2FD8871639043E79B</code> <code>20F43444227C6882FF80A7C8C516221B</code> <code>9F6BF4F3F84F4FFC595F43F913C389AF</code> <code>29812D494A8A43819D51C33CE5C1F2E8</code> <code>C5171478EF90F6C5595024CB101940C5</code> <code>BD1DDF4C2FFA641762ABFD548B11BC3E</code> <code>2130CDB5CC0CA993D786F33CF301EC6F</code> <code>4723A2CFCCB32B52D714595A17F9DFD4</code> <code>649ACFA0AB0851A9E9A32C003A72ED51</code> <code>E6ED02CA9E239999B653C2A33DD5700C</code> <code>417E47D82C9A5E40A325CB044069502E</code> <code>415B1A60D5D2876802381FA934DD773D</code> <code>0CD4808360966321C0CEA2DE44601C34</code> <code>A7C0B07DBD4D5EF1F939CEAADEF71BA5</code> <code>7CA2232AFFC167804100F77F8DEBF740</code> <code>D05332423E7C772B32C6B63C2474CCD8</code> <code>EBC1993319F6C7E316E721D1066A16CD</code> <code>BB5BCF835D1668A02D428F8C2DD0022C</code> <code>F868388FB503BDC2E35ADAF64D6E48EA</code> <code>036A6E7899B753A986EE0EEECCAC8817</code> <code>A94AD48270E8D63AAA26D434725F3DE2</code> <code>DF1F67AAAC9D10D9ABEA73A60B9A3EA2</code> <code>C45EBBEE86EFA28D2D2686EB5E63A324</code> <code>CE3E2DC458A59A2AB15CC1A1DD40087C</code> <code>4E339609C2A56334F78A403EF4584540</code> <code>51D25A0C75FD5FA0EB4625DC70041255</code> <code>A75A19F2A7BE4E7BA73B1537248FC96B</code> <code>40A33A54AC3F2E37870B7BEB9E7929B0</code> <code>0EDC8148974438B87B035B4F21B2291B</code> <code>2293A7B716DC1B4A2E3EAE9A5B314C5E</code><br> <code>5380BE16</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = E63DE941701709846B232355AC2D7B6FADE623482DA99ECDEEED96FCB2AC81C8C21240F31BBC2DBE67A114192EFF77E8F14C073ABB39C4F406A79F7BE137637D064719A6F4884E0F07207922AE6427BD11A120B55D6139C5104FD9386B3CAF4394778EE7A72E3572467C8CFF5DAF608C19F8B8D2FD8871639043E79B20F43444227C6882FF80A7C8C516221B9F6BF4F3F84F4FFC595F43F913C389AF29812D494A8A43819D51C33CE5C1F2E8C5171478EF90F6C5595024CB101940C5BD1DDF4C2FFA641762ABFD548B11BC3E2130CDB5CC0CA993D786F33CF301EC6F4723A2CFCCB32B52D714595A17F9DFD4649ACFA0AB0851A9E9A32C003A72ED51E6ED02CA9E239999B653C2A33DD5700C417E47D82C9A5E40A325CB044069502E415B1A60D5D2876802381FA934DD773D0CD4808360966321C0CEA2DE44601C34A7C0B07DBD4D5EF1F939CEAADEF71BA57CA2232AFFC167804100F77F8DEBF740D05332423E7C772B32C6B63C2474CCD8EBC1993319F6C7E316E721D1066A16CDBB5BCF835D1668A02D428F8C2DD0022CF868388FB503BDC2E35ADAF64D6E48EA036A6E7899B753A986EE0EEECCAC8817A94AD48270E8D63AAA26D434725F3DE2DF1F67AAAC9D10D9ABEA73A60B9A3EA2C45EBBEE86EFA28D2D2686EB5E63A324CE3E2DC458A59A2AB15CC1A1DD40087C4E339609C2A56334F78A403EF458454051D25A0C75FD5FA0EB4625DC70041255A75A19F2A7BE4E7BA73B1537248FC96B40A33A54AC3F2E37870B7BEB9E7929B00EDC8148974438B87B035B4F21B2291B2293A7B716DC1B4A2E3EAE9A5B314C5E5380BE16
tmp_aes_key = 1D6AC74AFCE3B62C06B3E793DAEA17830B4E404D492A366D69DC0AD37059FB67
tmp_aes_iv = A4091D89D1BE6DBE6E3A5EA96C1393B1CBCA24B0F559217CBB564AB5B7A47537</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1ACB4E3B53C00F39BA2B977EF4B99F17B28D4361BA0D89B54392314AC77D7DFB16F0E6BE5213FFE4EA2E5BD298D00D7E80FF3348886B831903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100178B00FDB9C7AE2CBAC6A956F488AAF312ACA80788D07A69763A9BE8368A74AA8E687332CC57B94DEA534E87E0EF21930FF96F1984195EC5CA70B7E50C6F2B21F6EAC4EB585D63E7DC236BFE4CD714D743C42F3ABF3CDB7D9BBA25BB6924609A7023B2E93649A188F46DDB4974CD9089C31A3AC9ED45F0D98D1BBBF903256B4765CFD8139F99D82517667D2F820C72E44D369C8390F5F8E43B41BE61FA1A4E7319230A3AA4A9585FC9E6856EA6112F2C932DD7CEBB39591F8C3E4E3BB89189C18F59B6BDDD6E9C28E2558F12C7902B40DC4AC4BEBB4166FF02CFBD365CD41F31A8E94D565086D89A5DB415EF570D8D196EA66A0878F4EB303DD6B01A24485799A4E96E674400CCB598E69C4F
answer = BA0D89B54392314AC77D7DFB16F0E6BE5213FFE4EA2E5BD298D00D7E80FF3348886B831903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100178B00FDB9C7AE2CBAC6A956F488AAF312ACA80788D07A69763A9BE8368A74AA8E687332CC57B94DEA534E87E0EF21930FF96F1984195EC5CA70B7E50C6F2B21F6EAC4EB585D63E7DC236BFE4CD714D743C42F3ABF3CDB7D9BBA25BB6924609A7023B2E93649A188F46DDB4974CD9089C31A3AC9ED45F0D98D1BBBF903256B4765CFD8139F99D82517667D2F820C72E44D369C8390F5F8E43B41BE61FA1A4E7319230A3AA4A9585FC9E6856EA6112F2C932DD7CEBB39591F8C3E4E3BB89189C18F59B6BDDD6E9C28E2558F12C7902B40DC4AC4BEBB4166FF02CFBD365CD41F31A8E94D565086D89A5DB415EF570D8D196EA66A0878F4EB303DD6B01A24485799A4E96E674400CCB598E69C4F</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 43 92 31 4A C7 7D 7D FB 16 F0 E6 BE
0010 | 52 13 FF E4 EA 2E 5B D2 98 D0 0D 7E 80 FF 33 48
0020 | 88 6B 83 19 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 17 8B 00 FD B9 C7 AE 2C BA C6 A9 56 F4 88 AA F3
0140 | 12 AC A8 07 88 D0 7A 69 76 3A 9B E8 36 8A 74 AA
0150 | 8E 68 73 32 CC 57 B9 4D EA 53 4E 87 E0 EF 21 93
0160 | 0F F9 6F 19 84 19 5E C5 CA 70 B7 E5 0C 6F 2B 21
0170 | F6 EA C4 EB 58 5D 63 E7 DC 23 6B FE 4C D7 14 D7
0180 | 43 C4 2F 3A BF 3C DB 7D 9B BA 25 BB 69 24 60 9A
0190 | 70 23 B2 E9 36 49 A1 88 F4 6D DB 49 74 CD 90 89
01A0 | C3 1A 3A C9 ED 45 F0 D9 8D 1B BB F9 03 25 6B 47
01B0 | 65 CF D8 13 9F 99 D8 25 17 66 7D 2F 82 0C 72 E4
01C0 | 4D 36 9C 83 90 F5 F8 E4 3B 41 BE 61 FA 1A 4E 73
01D0 | 19 23 0A 3A A4 A9 58 5F C9 E6 85 6E A6 11 2F 2C
01E0 | 93 2D D7 CE BB 39 59 1F 8C 3E 4E 3B B8 91 89 C1
01F0 | 8F 59 B6 BD DD 6E 9C 28 E2 55 8F 12 C7 90 2B 40
0200 | DC 4A C4 BE BB 41 66 FF 02 CF BD 36 5C D4 1F 31
0210 | A8 E9 4D 56 50 86 D8 9A 5D B4 15 EF 57 0D 8D 19
0220 | 6E A6 6A 08 78 F4 EB 30 3D D6 B0 1A 24 48 57 99
0230 | A4 E9 6E 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100178B00FDB9C7AE2CBAC6A956</code> <code>F488AAF312ACA80788D07A69763A9BE8</code> <code>368A74AA8E687332CC57B94DEA534E87</code> <code>E0EF21930FF96F1984195EC5CA70B7E5</code> <code>0C6F2B21F6EAC4EB585D63E7DC236BFE</code> <code>4CD714D743C42F3ABF3CDB7D9BBA25BB</code> <code>6924609A7023B2E93649A188F46DDB49</code> <code>74CD9089C31A3AC9ED45F0D98D1BBBF9</code> <code>03256B4765CFD8139F99D82517667D2F</code> <code>820C72E44D369C8390F5F8E43B41BE61</code> <code>FA1A4E7319230A3AA4A9585FC9E6856E</code> <code>A6112F2C932DD7CEBB39591F8C3E4E3B</code> <code>B89189C18F59B6BDDD6E9C28E2558F12</code> <code>C7902B40DC4AC4BEBB4166FF02CFBD36</code> <code>5CD41F31A8E94D565086D89A5DB415EF</code> <code>570D8D196EA66A0878F4EB303DD6B01A</code><br> <code>24485799</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>A4E96E67</code> (1735322020 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = F15C365C2C062B111D40550D95F0E5FBA2F8B294585D2A0606CE7AE8CD71642FD1BD447B19F024EF9CCFD681014AE26307D60083EBB6CDC091657A6EF66ADB305264B06FF972ACB3AC9538D1A01C217633327C40FD8AA850874CFFB92E32E39A0E2BA17766A097ABB487852341520670AC8764A000AB851D99BC2BD362FA418A9E74C2E68A4BB65BA652C6DC8A9FDCAF3827E3B4934139AA104ACC95C66B5ABD8865FAD1CE1DE87B410642FF32C7F6AFE339143FDCFF360E11408070749FF215A0816BB777B480342A7F62160CD54275B2067246DB6E5A84F45316D40F032DFEC2A8E8BD93622818F8480EBEB827D007EF37A97FF202352C75FF71F9FEC049AA</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = C24827E48B678A9F88B82E5FBCE3AF7193427DBA652888DF3B4D4AF677B546F0336D6DE08C3461263379396350012AB9A6D3461C5AC1ADADD9CEA49A8FB65409C1E1C0D7870AD4C11A9BBA2CF9BB7030497683A1FB6DD3DD378C6D62BE812BAA83BCB6BAF84C561C5909BFAE897C6F45CD362EC8392EF7FA762962C5EA3FD4547828A0C3C86F76122E449AC2B3BAD04DA4FFB88BDC8D746C80F653A70A13A31179BF71242B8FBB10086E5E202917C47131F0478B8F48B9CA28CC2D6353A3DFBA06BE4A11276A98BCF18976A0EA591E63E3952D332C6F27FB0DF8C3E7E2EF5D2F8514261FF04D46F8F98CF0A3F9D0BA7AC07301D6DD84B5AA84EA36E09ABF0E8C</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 43 92 31 4A C7 7D 7D FB 16 F0 E6 BE
0010 | 52 13 FF E4 EA 2E 5B D2 98 D0 0D 7E 80 FF 33 48
0020 | 88 6B 83 19 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | C2 48 27 E4 8B 67 8A 9F 88 B8 2E 5F BC E3 AF 71
0040 | 93 42 7D BA 65 28 88 DF 3B 4D 4A F6 77 B5 46 F0
0050 | 33 6D 6D E0 8C 34 61 26 33 79 39 63 50 01 2A B9
0060 | A6 D3 46 1C 5A C1 AD AD D9 CE A4 9A 8F B6 54 09
0070 | C1 E1 C0 D7 87 0A D4 C1 1A 9B BA 2C F9 BB 70 30
0080 | 49 76 83 A1 FB 6D D3 DD 37 8C 6D 62 BE 81 2B AA
0090 | 83 BC B6 BA F8 4C 56 1C 59 09 BF AE 89 7C 6F 45
00A0 | CD 36 2E C8 39 2E F7 FA 76 29 62 C5 EA 3F D4 54
00B0 | 78 28 A0 C3 C8 6F 76 12 2E 44 9A C2 B3 BA D0 4D
00C0 | A4 FF B8 8B DC 8D 74 6C 80 F6 53 A7 0A 13 A3 11
00D0 | 79 BF 71 24 2B 8F BB 10 08 6E 5E 20 29 17 C4 71
00E0 | 31 F0 47 8B 8F 48 B9 CA 28 CC 2D 63 53 A3 DF BA
00F0 | 06 BE 4A 11 27 6A 98 BC F1 89 76 A0 EA 59 1E 63
0100 | E3 95 2D 33 2C 6F 27 FB 0D F8 C3 E7 E2 EF 5D 2F
0110 | 85 14 26 1F F0 4D 46 F8 F9 8C F0 A3 F9 D0 BA 7A
0120 | C0 73 01 D6 DD 84 B5 AA 84 EA 36 E0 9A BF 0E 8C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100C24827E48B678A9F88B82E5F</code> <code>BCE3AF7193427DBA652888DF3B4D4AF6</code> <code>77B546F0336D6DE08C34612633793963</code> <code>50012AB9A6D3461C5AC1ADADD9CEA49A</code> <code>8FB65409C1E1C0D7870AD4C11A9BBA2C</code> <code>F9BB7030497683A1FB6DD3DD378C6D62</code> <code>BE812BAA83BCB6BAF84C561C5909BFAE</code> <code>897C6F45CD362EC8392EF7FA762962C5</code> <code>EA3FD4547828A0C3C86F76122E449AC2</code> <code>B3BAD04DA4FFB88BDC8D746C80F653A7</code> <code>0A13A31179BF71242B8FBB10086E5E20</code> <code>2917C47131F0478B8F48B9CA28CC2D63</code> <code>53A3DFBA06BE4A11276A98BCF18976A0</code> <code>EA591E63E3952D332C6F27FB0DF8C3E7</code> <code>E2EF5D2F8514261FF04D46F8F98CF0A3</code> <code>F9D0BA7AC07301D6DD84B5AA84EA36E0</code><br> <code>9ABF0E8C</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643664392314AC77D7DFB16F0E6BE5213FFE4EA2E5BD298D00D7E80FF3348886B83190000000000000000FE000100C24827E48B678A9F88B82E5FBCE3AF7193427DBA652888DF3B4D4AF677B546F0336D6DE08C3461263379396350012AB9A6D3461C5AC1ADADD9CEA49A8FB65409C1E1C0D7870AD4C11A9BBA2CF9BB7030497683A1FB6DD3DD378C6D62BE812BAA83BCB6BAF84C561C5909BFAE897C6F45CD362EC8392EF7FA762962C5EA3FD4547828A0C3C86F76122E449AC2B3BAD04DA4FFB88BDC8D746C80F653A70A13A31179BF71242B8FBB10086E5E202917C47131F0478B8F48B9CA28CC2D6353A3DFBA06BE4A11276A98BCF18976A0EA591E63E3952D332C6F27FB0DF8C3E7E2EF5D2F8514261FF04D46F8F98CF0A3F9D0BA7AC07301D6DD84B5AA84EA36E09ABF0E8C
padding = 684EB8878CC46F07F0BD4CF2
tmp_aes_key = 1D6AC74AFCE3B62C06B3E793DAEA17830B4E404D492A366D69DC0AD37059FB67
tmp_aes_iv = A4091D89D1BE6DBE6E3A5EA96C1393B1CBCA24B0F559217CBB564AB5B7A47537</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 0805FB04665387EC3A50E52ABB557F0CBE5AAECDEDFAD488554C34FD59E4F5507955581EB394CAD2E063E35BAAB95430B03B71887C3596182A21F55E6F31532D9F1A737DFF9F02634AB078C92B05A3140110820C76895745CB61434BA5CE2A69D35500C46C3FDC7C7785F90E118BA149EE28504A670B93FF3CA4D49675DA298B8729B39BA88D7D2EE2202AF1630A67AE9A56A4EC6ED654EC9E525429E9DBF1D6E0DF6F468FF545F4B95DC16366AD8760CE9D1D59A14CFDD3143CB88D8E0D02BF11C81B7C4E7BA2CECE4540D9331EE0EC54B92167C703F7CFA14DCA6613A5E16C3118F5EE816BEADBDCF5D7DABD4845EF78ECF19B999E08EA093186056540279A7F36EAC891F23DC9CB7DB24E4C35010E8E217EF4847B8DEC283A764A17461745F4A70CA2739EB85BEFF6937AAB4944D178682B9DD8CC53E41DF01F6482CB82DF1C72C6B21F3876AD5459636AA2A96ED0</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 20 60 00 00 A5 E9 6E 67
0010 | 78 01 00 00 1F 5F 04 F5 43 92 31 4A C7 7D 7D FB
0020 | 16 F0 E6 BE 52 13 FF E4 EA 2E 5B D2 98 D0 0D 7E
0030 | 80 FF 33 48 88 6B 83 19 FE 50 01 00 08 05 FB 04
0040 | 66 53 87 EC 3A 50 E5 2A BB 55 7F 0C BE 5A AE CD
0050 | ED FA D4 88 55 4C 34 FD 59 E4 F5 50 79 55 58 1E
0060 | B3 94 CA D2 E0 63 E3 5B AA B9 54 30 B0 3B 71 88
0070 | 7C 35 96 18 2A 21 F5 5E 6F 31 53 2D 9F 1A 73 7D
0080 | FF 9F 02 63 4A B0 78 C9 2B 05 A3 14 01 10 82 0C
0090 | 76 89 57 45 CB 61 43 4B A5 CE 2A 69 D3 55 00 C4
00A0 | 6C 3F DC 7C 77 85 F9 0E 11 8B A1 49 EE 28 50 4A
00B0 | 67 0B 93 FF 3C A4 D4 96 75 DA 29 8B 87 29 B3 9B
00C0 | A8 8D 7D 2E E2 20 2A F1 63 0A 67 AE 9A 56 A4 EC
00D0 | 6E D6 54 EC 9E 52 54 29 E9 DB F1 D6 E0 DF 6F 46
00E0 | 8F F5 45 F4 B9 5D C1 63 66 AD 87 60 CE 9D 1D 59
00F0 | A1 4C FD D3 14 3C B8 8D 8E 0D 02 BF 11 C8 1B 7C
0100 | 4E 7B A2 CE CE 45 40 D9 33 1E E0 EC 54 B9 21 67
0110 | C7 03 F7 CF A1 4D CA 66 13 A5 E1 6C 31 18 F5 EE
0120 | 81 6B EA DB DC F5 D7 DA BD 48 45 EF 78 EC F1 9B
0130 | 99 9E 08 EA 09 31 86 05 65 40 27 9A 7F 36 EA C8
0140 | 91 F2 3D C9 CB 7D B2 4E 4C 35 01 0E 8E 21 7E F4
0150 | 84 7B 8D EC 28 3A 76 4A 17 46 17 45 F4 A7 0C A2
0160 | 73 9E B8 5B EF F6 93 7A AB 49 44 D1 78 68 2B 9D
0170 | D8 CC 53 E4 1D F0 1F 64 82 CB 82 DF 1C 72 C6 B2
0180 | 1F 38 76 AD 54 59 63 6A A2 A9 6E D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>20600000A5E96E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001000805FB04665387EC3A50E52A</code> <code>BB557F0CBE5AAECDEDFAD488554C34FD</code> <code>59E4F5507955581EB394CAD2E063E35B</code> <code>AAB95430B03B71887C3596182A21F55E</code> <code>6F31532D9F1A737DFF9F02634AB078C9</code> <code>2B05A3140110820C76895745CB61434B</code> <code>A5CE2A69D35500C46C3FDC7C7785F90E</code> <code>118BA149EE28504A670B93FF3CA4D496</code> <code>75DA298B8729B39BA88D7D2EE2202AF1</code> <code>630A67AE9A56A4EC6ED654EC9E525429</code> <code>E9DBF1D6E0DF6F468FF545F4B95DC163</code> <code>66AD8760CE9D1D59A14CFDD3143CB88D</code> <code>8E0D02BF11C81B7C4E7BA2CECE4540D9</code> <code>331EE0EC54B92167C703F7CFA14DCA66</code> <code>13A5E16C3118F5EE816BEADBDCF5D7DA</code> <code>BD4845EF78ECF19B999E08EA09318605</code> <code>6540279A7F36EAC891F23DC9CB7DB24E</code> <code>4C35010E8E217EF4847B8DEC283A764A</code> <code>17461745F4A70CA2739EB85BEFF6937A</code> <code>AB4944D178682B9DD8CC53E41DF01F64</code> <code>82CB82DF1C72C6B21F3876AD5459636A</code><br> <code>A2A96ED0</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = B76BA2377F0F64DF7737EFE4EFF807C26EC6BFE27EA122CEC90A4E11C8CF48FE9A496D66E510D28C5B5A30B006D8590A323D5A9FFFB101354672BD2225B483962B0FB3D583E461F0197940BB3D50446BED7AC14973B8154E08F7E9A65A96B2E4609312F508878FB15A0054FCB07B303D92BDC01CFC8D917BFA08E271AC4DF77B6F403F6F1AC5E649494F59C769B1749DF4478733CFFF340FF9629DCE54A333644EAD0227BEB2F3008570D33DD6B44D8C352E64F07BA12A383F73469C6CBB1BDCDC95F764A024373B4620C9C6D4DFD3DC0A3A3671A8CC00DCCC1846FAB01CA106752A36A09E560F59D70E6E0FD8F1670E57B09DCFC60341FECB40C0F08A007E93</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 50 12 B5 A5 E9 6E 67
0010 | 34 00 00 00 34 F7 CB 3B 43 92 31 4A C7 7D 7D FB
0020 | 16 F0 E6 BE 52 13 FF E4 EA 2E 5B D2 98 D0 0D 7E
0030 | 80 FF 33 48 88 6B 83 19 DF 73 B7 96 E6 48 98 62
0040 | D8 C6 76 05 21 5F 9B 4E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015012B5A5E96E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4392314AC77D7DFB16F0E6BE5213FFE4</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EA2E5BD298D00D7E80FF3348886B8319</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>DF73B796E6489862D8C67605215F9B4E</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

