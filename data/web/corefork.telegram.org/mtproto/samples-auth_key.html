<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 10 4E 01 00 9D D7 D6 68
0010 | 14 00 00 00 F1 8E 7E BE 91 99 73 2C 27 B3 79 0D
0020 | 4B 08 52 40 1B EB 08 50</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>104E01009DD7D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 DF 9A 9D D7 D6 68
0010 | 50 00 00 00 63 24 16 05 91 99 73 2C 27 B3 79 0D
0020 | 4B 08 52 40 1B EB 08 50 0D 3E D4 D2 44 75 56 70
0030 | 9A D3 39 F5 31 43 2F 9C 08 18 D4 DE E8 0D 69 7E
0040 | 85 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130DF9A9DD7D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0818D4DEE80D697E85000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1789300040211725957</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1789300040211725957</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1789300040211725957 = 1158550453 * 1544429969</code></p>
<pre><code>p = 1158550453
q = 1544429969</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 18 D4 DE E8 0D 69 7E 85 00 00 00
0010 | 04 45 0E 13 B5 00 00 00 04 5C 0E 21 91 00 00 00
0020 | 91 99 73 2C 27 B3 79 0D 4B 08 52 40 1B EB 08 50
0030 | 0D 3E D4 D2 44 75 56 70 9A D3 39 F5 31 43 2F 9C
0040 | 19 37 59 43 46 9B F8 FF C7 37 98 F5 69 83 86 4F
0050 | 7C 24 BE 74 69 DE BC 87 58 C4 44 D4 A5 3B 74 7D
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0818D4DEE80D697E85000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1789300040211725957</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04450E13B5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1158550453</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045C0E2191000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1544429969</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>19375943469BF8FFC73798F56983864F</code> <code>7C24BE7469DEBC8758C444D4A53B747D</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90818D4DEE80D697E8500000004450E13B5000000045C0E21910000009199732C27B3790D4B0852401BEB08500D3ED4D2447556709AD339F531432F9C19375943469BF8FFC73798F56983864F7C24BE7469DEBC8758C444D4A53B747D02000000
random_padding_bytes = 6F901603127F77BCD4F2E5D33C0706B907867E4989F3F46B12DB693C65A3D44729A703A6EE6FB172F0A850F20E4376ED93E847F3C2EF7E202B49A46C4DA552372B7EF9538634B1B4A4093A2BB64FA404EE3FFFC48B87A0334BF98720</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 56E5943417656FD5EDA2F2B899542DCAD51953063F8AC25EEED6C3273FD095E916395DA7907F5A45B7C6AB064CBB8CC8295A792DCE733C0EC5F4724D4F1B1B69387B3BA7ECA9C00CD166671C4A450B0A945D804FDB4C71990A0E37CA3541543A16A1C2C5DC8D1E73B595A9F31AF1932C7A1FAAE1515B18C35E7D31B82F8C74D893C0152DB508D845EE632F4A8A98034FD136CCDB0EBADF79567A9A7E64D2A7AC65861DB2F8719CE347DEAC69F4D15F434CF72E0F48D06FF9949E3F5B3FB8D561C51FFE72132E502D5AE1AC8FAE6DCCC7EE84C1EC08C3F47017305858D359DF9BEA54EF98FA87A08E9A7A246EB4042EA3CBC5EE5852B01ED675BDBD243F5C4633</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D4 F3 05 00 9D D7 D6 68
0010 | 40 01 00 00 BE E4 12 D7 91 99 73 2C 27 B3 79 0D
0020 | 4B 08 52 40 1B EB 08 50 0D 3E D4 D2 44 75 56 70
0030 | 9A D3 39 F5 31 43 2F 9C 04 45 0E 13 B5 00 00 00
0040 | 04 5C 0E 21 91 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 56 E5 94 34 17 65 6F D5 ED A2 F2 B8
0060 | 99 54 2D CA D5 19 53 06 3F 8A C2 5E EE D6 C3 27
0070 | 3F D0 95 E9 16 39 5D A7 90 7F 5A 45 B7 C6 AB 06
0080 | 4C BB 8C C8 29 5A 79 2D CE 73 3C 0E C5 F4 72 4D
0090 | 4F 1B 1B 69 38 7B 3B A7 EC A9 C0 0C D1 66 67 1C
00A0 | 4A 45 0B 0A 94 5D 80 4F DB 4C 71 99 0A 0E 37 CA
00B0 | 35 41 54 3A 16 A1 C2 C5 DC 8D 1E 73 B5 95 A9 F3
00C0 | 1A F1 93 2C 7A 1F AA E1 51 5B 18 C3 5E 7D 31 B8
00D0 | 2F 8C 74 D8 93 C0 15 2D B5 08 D8 45 EE 63 2F 4A
00E0 | 8A 98 03 4F D1 36 CC DB 0E BA DF 79 56 7A 9A 7E
00F0 | 64 D2 A7 AC 65 86 1D B2 F8 71 9C E3 47 DE AC 69
0100 | F4 D1 5F 43 4C F7 2E 0F 48 D0 6F F9 94 9E 3F 5B
0110 | 3F B8 D5 61 C5 1F FE 72 13 2E 50 2D 5A E1 AC 8F
0120 | AE 6D CC C7 EE 84 C1 EC 08 C3 F4 70 17 30 58 58
0130 | D3 59 DF 9B EA 54 EF 98 FA 87 A0 8E 9A 7A 24 6E
0140 | B4 04 2E A3 CB C5 EE 58 52 B0 1E D6 75 BD BD 24
0150 | 3F 5C 46 33</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D4F305009DD7D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04450E13B5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1158550453</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045C0E2191000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1544429969</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010056E5943417656FD5EDA2F2B8</code> <code>99542DCAD51953063F8AC25EEED6C327</code> <code>3FD095E916395DA7907F5A45B7C6AB06</code> <code>4CBB8CC8295A792DCE733C0EC5F4724D</code> <code>4F1B1B69387B3BA7ECA9C00CD166671C</code> <code>4A450B0A945D804FDB4C71990A0E37CA</code> <code>3541543A16A1C2C5DC8D1E73B595A9F3</code> <code>1AF1932C7A1FAAE1515B18C35E7D31B8</code> <code>2F8C74D893C0152DB508D845EE632F4A</code> <code>8A98034FD136CCDB0EBADF79567A9A7E</code> <code>64D2A7AC65861DB2F8719CE347DEAC69</code> <code>F4D15F434CF72E0F48D06FF9949E3F5B</code> <code>3FB8D561C51FFE72132E502D5AE1AC8F</code> <code>AE6DCCC7EE84C1EC08C3F47017305858</code> <code>D359DF9BEA54EF98FA87A08E9A7A246E</code> <code>B4042EA3CBC5EE5852B01ED675BDBD24</code><br> <code>3F5C4633</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B0 30 C7 9D D7 D6 68
0010 | 78 02 00 00 5C 07 E8 D0 91 99 73 2C 27 B3 79 0D
0020 | 4B 08 52 40 1B EB 08 50 0D 3E D4 D2 44 75 56 70
0030 | 9A D3 39 F5 31 43 2F 9C FE 50 02 00 1C 76 BE 26
0040 | D5 8F B4 9A 57 70 EE 08 F8 F9 FE 3B 41 73 82 1F
0050 | 6A 87 9A 9C 4C F8 6B E9 AF 64 60 9C 47 E2 6D 2F
0060 | C7 30 B9 49 CB 79 BA 36 59 0A 6E E5 AF 9E 42 B3
0070 | 06 99 0D D3 42 F7 56 44 24 46 4A C6 B3 3A 70 F4
0080 | 50 8F D0 15 48 1E 33 A6 80 E3 E3 3E 04 3D C8 FA
0090 | 96 8F AB 5E 7F 22 72 40 74 C1 E1 09 5A 59 22 6D
00A0 | 05 C0 6F 40 BA C6 79 67 24 1D D3 8C 9A 50 79 63
00B0 | 3B 74 ED 5C 8D 87 69 48 57 0F CA 36 EC 45 54 DC
00C0 | 52 5E 28 CB 99 F8 27 85 70 FA 17 24 B6 1A 05 C2
00D0 | 4D FA 12 24 D6 E2 75 97 A0 1A C4 27 41 E5 ED 69
00E0 | 5E BD 8B 5F 54 97 2C DC 4D 21 5A 1D 9E C8 E5 DF
00F0 | 2B FC 6D DF 50 D1 E5 3C 14 74 35 83 D4 F4 83 7A
0100 | 34 FA B5 36 1D AD E1 82 C0 A1 47 27 57 9E 09 AF
0110 | 4B B7 06 0C 31 1C 32 AE 4A 86 ED A5 D5 34 E7 B3
0120 | F3 1A 9C 43 8A 12 0E 64 16 7C 29 D1 0A 2A 36 66
0130 | CA 6E 20 AB E3 1D 06 9F B4 DD 5C 17 40 03 47 50
0140 | 9C 34 9D 8B A3 3E D0 AA DF 97 F4 7B 1B AD AB FE
0150 | 9A 76 F9 50 13 F8 8B 42 E5 9C 9A 36 D3 3B DC 74
0160 | FA 19 B1 4D E8 10 D1 D2 FD 37 A1 00 DE 41 D8 ED
0170 | 01 93 97 30 08 A5 19 86 94 8D D3 39 5D 4B 5F FB
0180 | 58 09 53 A3 84 91 0F 62 5D B1 1B 1E 3F 5C CC 4E
0190 | 5E B2 B9 5F 95 99 E2 05 BF 38 90 D3 9D 21 DA DC
01A0 | 50 9E 99 EA 29 BB 9A D8 62 31 D5 27 B4 20 3E AB
01B0 | A0 E7 7E 8D BC D5 6D 21 2C C4 8D FE 64 D0 67 CE
01C0 | 9F DF C2 6B 53 9E 39 7C 1B CD 9A BC 03 92 0E 9F
01D0 | A3 F6 F3 7E 11 31 DC 8E 21 37 DA C0 41 4B 00 EE
01E0 | E0 D5 CC 91 63 23 CA A6 90 2E 88 93 67 D4 4A 42
01F0 | C5 19 20 21 5E E3 53 91 96 B2 EC 05 AB 30 88 F7
0200 | 91 D9 79 0E EE B3 5B 78 CF D3 40 E5 C1 80 E1 08
0210 | EE 96 AA C9 E5 06 3F 25 42 48 BA DF B1 CB FA BA
0220 | 8A FE 9F AE DB 34 BF 9E 69 D7 29 8E DD 33 D1 58
0230 | 9A 2C 92 8B F9 D8 C0 9A 4E 74 56 87 51 46 55 75
0240 | CF 99 A1 BE 04 A8 16 53 D3 3B 2C 6E 1E 9A D6 9E
0250 | DE 3C 2F 54 23 75 E3 9F 96 1E CA 25 44 7C 4D D8
0260 | 4C 03 EB F8 84 D0 1B DE 09 FE E4 EF 31 FF 3D 18
0270 | 5E 11 BC 85 56 0A 47 19 A5 1C 0E C1 19 D7 EE 13
0280 | B7 F3 D1 37 00 A1 F2 07 7F 25 70 94</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B030C79DD7D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002001C76BE26D58FB49A5770EE08</code> <code>F8F9FE3B4173821F6A879A9C4CF86BE9</code> <code>AF64609C47E26D2FC730B949CB79BA36</code> <code>590A6EE5AF9E42B306990DD342F75644</code> <code>24464AC6B33A70F4508FD015481E33A6</code> <code>80E3E33E043DC8FA968FAB5E7F227240</code> <code>74C1E1095A59226D05C06F40BAC67967</code> <code>241DD38C9A5079633B74ED5C8D876948</code> <code>570FCA36EC4554DC525E28CB99F82785</code> <code>70FA1724B61A05C24DFA1224D6E27597</code> <code>A01AC42741E5ED695EBD8B5F54972CDC</code> <code>4D215A1D9EC8E5DF2BFC6DDF50D1E53C</code> <code>14743583D4F4837A34FAB5361DADE182</code> <code>C0A14727579E09AF4BB7060C311C32AE</code> <code>4A86EDA5D534E7B3F31A9C438A120E64</code> <code>167C29D10A2A3666CA6E20ABE31D069F</code> <code>B4DD5C17400347509C349D8BA33ED0AA</code> <code>DF97F47B1BADABFE9A76F95013F88B42</code> <code>E59C9A36D33BDC74FA19B14DE810D1D2</code> <code>FD37A100DE41D8ED0193973008A51986</code> <code>948DD3395D4B5FFB580953A384910F62</code> <code>5DB11B1E3F5CCC4E5EB2B95F9599E205</code> <code>BF3890D39D21DADC509E99EA29BB9AD8</code> <code>6231D527B4203EABA0E77E8DBCD56D21</code> <code>2CC48DFE64D067CE9FDFC26B539E397C</code> <code>1BCD9ABC03920E9FA3F6F37E1131DC8E</code> <code>2137DAC0414B00EEE0D5CC916323CAA6</code> <code>902E889367D44A42C51920215EE35391</code> <code>96B2EC05AB3088F791D9790EEEB35B78</code> <code>CFD340E5C180E108EE96AAC9E5063F25</code> <code>4248BADFB1CBFABA8AFE9FAEDB34BF9E</code> <code>69D7298EDD33D1589A2C928BF9D8C09A</code> <code>4E74568751465575CF99A1BE04A81653</code> <code>D33B2C6E1E9AD69EDE3C2F542375E39F</code> <code>961ECA25447C4DD84C03EBF884D01BDE</code> <code>09FEE4EF31FF3D185E11BC85560A4719</code> <code>A51C0EC119D7EE13B7F3D13700A1F207</code><br> <code>7F257094</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 1C76BE26D58FB49A5770EE08F8F9FE3B4173821F6A879A9C4CF86BE9AF64609C47E26D2FC730B949CB79BA36590A6EE5AF9E42B306990DD342F7564424464AC6B33A70F4508FD015481E33A680E3E33E043DC8FA968FAB5E7F22724074C1E1095A59226D05C06F40BAC67967241DD38C9A5079633B74ED5C8D876948570FCA36EC4554DC525E28CB99F8278570FA1724B61A05C24DFA1224D6E27597A01AC42741E5ED695EBD8B5F54972CDC4D215A1D9EC8E5DF2BFC6DDF50D1E53C14743583D4F4837A34FAB5361DADE182C0A14727579E09AF4BB7060C311C32AE4A86EDA5D534E7B3F31A9C438A120E64167C29D10A2A3666CA6E20ABE31D069FB4DD5C17400347509C349D8BA33ED0AADF97F47B1BADABFE9A76F95013F88B42E59C9A36D33BDC74FA19B14DE810D1D2FD37A100DE41D8ED0193973008A51986948DD3395D4B5FFB580953A384910F625DB11B1E3F5CCC4E5EB2B95F9599E205BF3890D39D21DADC509E99EA29BB9AD86231D527B4203EABA0E77E8DBCD56D212CC48DFE64D067CE9FDFC26B539E397C1BCD9ABC03920E9FA3F6F37E1131DC8E2137DAC0414B00EEE0D5CC916323CAA6902E889367D44A42C51920215EE3539196B2EC05AB3088F791D9790EEEB35B78CFD340E5C180E108EE96AAC9E5063F254248BADFB1CBFABA8AFE9FAEDB34BF9E69D7298EDD33D1589A2C928BF9D8C09A4E74568751465575CF99A1BE04A81653D33B2C6E1E9AD69EDE3C2F542375E39F961ECA25447C4DD84C03EBF884D01BDE09FEE4EF31FF3D185E11BC85560A4719A51C0EC119D7EE13B7F3D13700A1F2077F257094
tmp_aes_key = 18C8F212766E6688124CFBE089558AD1943FDBF008083FE6F5412D3CCFD408B1
tmp_aes_iv = 7EAD20DAE26140635E5E210A0B3113925A7F90A3CD183F3EB3A85FCA19375943</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 471B40DC9A45482B136CAA90940440900436B3BFBA0D89B59199732C27B3790D4B0852401BEB08500D3ED4D2447556709AD339F531432F9C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005C621E3955406564BDECEEFA24A1DDA0D5E0DA9ED1BC1AA879843FF95CC236547513CD494C22B9FE389FD49BA53C40470EDC689D610A9630A9C6228D7E9F47883E06903AB8C81D1DD6CD5594ECD02A0F926CC3B62C3298AB7AA1524CE17A8E0A9B67E84D07FD73FE755871253C5B12D300FB99B310C4A41BFE28135DE0D260B6AAA0436A3788AF6C5EFA5043F65C7E5B74CD7498AD24E7B93A11688F0AE9CF9D793DEF39C8F1E10FFDD1EB176EB43F7CEC670D44CB54405346BA042CDE598B6975CD3820673BB9B19D7C8236121E0999242170531E118D8D03FC219CEA5095127EF6C708C8DBCFE3B912E91CDF6DDD1BE75642EE2D614DC2C0EB339FDE046D589DD7D668160D0315F2CED2B3
answer = BA0D89B59199732C27B3790D4B0852401BEB08500D3ED4D2447556709AD339F531432F9C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005C621E3955406564BDECEEFA24A1DDA0D5E0DA9ED1BC1AA879843FF95CC236547513CD494C22B9FE389FD49BA53C40470EDC689D610A9630A9C6228D7E9F47883E06903AB8C81D1DD6CD5594ECD02A0F926CC3B62C3298AB7AA1524CE17A8E0A9B67E84D07FD73FE755871253C5B12D300FB99B310C4A41BFE28135DE0D260B6AAA0436A3788AF6C5EFA5043F65C7E5B74CD7498AD24E7B93A11688F0AE9CF9D793DEF39C8F1E10FFDD1EB176EB43F7CEC670D44CB54405346BA042CDE598B6975CD3820673BB9B19D7C8236121E0999242170531E118D8D03FC219CEA5095127EF6C708C8DBCFE3B912E91CDF6DDD1BE75642EE2D614DC2C0EB339FDE046D589DD7D668160D0315F2CED2B3</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 91 99 73 2C 27 B3 79 0D 4B 08 52 40
0010 | 1B EB 08 50 0D 3E D4 D2 44 75 56 70 9A D3 39 F5
0020 | 31 43 2F 9C 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 5C 62 1E 39 55 40 65 64 BD EC EE FA 24 A1 DD A0
0140 | D5 E0 DA 9E D1 BC 1A A8 79 84 3F F9 5C C2 36 54
0150 | 75 13 CD 49 4C 22 B9 FE 38 9F D4 9B A5 3C 40 47
0160 | 0E DC 68 9D 61 0A 96 30 A9 C6 22 8D 7E 9F 47 88
0170 | 3E 06 90 3A B8 C8 1D 1D D6 CD 55 94 EC D0 2A 0F
0180 | 92 6C C3 B6 2C 32 98 AB 7A A1 52 4C E1 7A 8E 0A
0190 | 9B 67 E8 4D 07 FD 73 FE 75 58 71 25 3C 5B 12 D3
01A0 | 00 FB 99 B3 10 C4 A4 1B FE 28 13 5D E0 D2 60 B6
01B0 | AA A0 43 6A 37 88 AF 6C 5E FA 50 43 F6 5C 7E 5B
01C0 | 74 CD 74 98 AD 24 E7 B9 3A 11 68 8F 0A E9 CF 9D
01D0 | 79 3D EF 39 C8 F1 E1 0F FD D1 EB 17 6E B4 3F 7C
01E0 | EC 67 0D 44 CB 54 40 53 46 BA 04 2C DE 59 8B 69
01F0 | 75 CD 38 20 67 3B B9 B1 9D 7C 82 36 12 1E 09 99
0200 | 24 21 70 53 1E 11 8D 8D 03 FC 21 9C EA 50 95 12
0210 | 7E F6 C7 08 C8 DB CF E3 B9 12 E9 1C DF 6D DD 1B
0220 | E7 56 42 EE 2D 61 4D C2 C0 EB 33 9F DE 04 6D 58
0230 | 9D D7 D6 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001005C621E3955406564BDECEEFA</code> <code>24A1DDA0D5E0DA9ED1BC1AA879843FF9</code> <code>5CC236547513CD494C22B9FE389FD49B</code> <code>A53C40470EDC689D610A9630A9C6228D</code> <code>7E9F47883E06903AB8C81D1DD6CD5594</code> <code>ECD02A0F926CC3B62C3298AB7AA1524C</code> <code>E17A8E0A9B67E84D07FD73FE75587125</code> <code>3C5B12D300FB99B310C4A41BFE28135D</code> <code>E0D260B6AAA0436A3788AF6C5EFA5043</code> <code>F65C7E5B74CD7498AD24E7B93A11688F</code> <code>0AE9CF9D793DEF39C8F1E10FFDD1EB17</code> <code>6EB43F7CEC670D44CB54405346BA042C</code> <code>DE598B6975CD3820673BB9B19D7C8236</code> <code>121E0999242170531E118D8D03FC219C</code> <code>EA5095127EF6C708C8DBCFE3B912E91C</code> <code>DF6DDD1BE75642EE2D614DC2C0EB339F</code><br> <code>DE046D58</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>9DD7D668</code> (1758910365 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = FEC3FF6709CFDBF19C785F8128A358489E29FA61ED772592351D3E3B39E7708E947DCEDE44F8EAFBCD51F2992E4510B21E9DE35C02C3A85ECC4F4D9EE7F035A9E7D0514E8B8D6B3703A188076E929186ED3AFFFD3F276794BFE8FC667C044D34F9BAD3C4447A163509CD22BCBF18604C43BD7B29D506B3861FD16D8C7C99B40516B0E0E939D74F3615F55AD9CB886D6DFA594826F6D13B7CCD9E1067EAD05F6E19CFAEBBE7C4AAF33F8F50CAE4F3CFF411007DD4C46D7A5EC776171CF06A055CD1B678992D7555F448CCD7C7633861B00ABBB3BCD59B7B84F1EAB49E99BBC19BDEAF9207456BA0C02465A10B851F665A7E0359B131008036B7B4AB2F89848EE5</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 1C1D00EF717B307308D9887693C979D07A503D18F3E702B057AAA826C3C9EC5CBCFD0C2F49ACE6421D59E25B9886963DAF7E8C7875F01ED91B2C25A4A3B2671FD783CC37AC950D60AE6A2EFA526252815A17B5AAD4B64D49A02A95844329B3AE43231EA00D70F684EB943FBB0E6596ED4C3AD41356B31999B0BA48FD573F8694AF89D4F23B40B47E0C1A4AD8A2CCF937F3BAD3CAA68EC71892CD638DD5083B4E759FA7B368F78F5B4D17B226290A30B6A00921AA89B59E6C2A7DD21BFF5E3C341DFA0C1429C07B5AEA6012840EDEA5D9BC69030043ED310EB9C57555AB10423F6CBEEE1B73321D6F9C6A15161FFDE254E243F19C9DBD09AD7BBE17A2038298BD</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 91 99 73 2C 27 B3 79 0D 4B 08 52 40
0010 | 1B EB 08 50 0D 3E D4 D2 44 75 56 70 9A D3 39 F5
0020 | 31 43 2F 9C 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 1C 1D 00 EF 71 7B 30 73 08 D9 88 76 93 C9 79 D0
0040 | 7A 50 3D 18 F3 E7 02 B0 57 AA A8 26 C3 C9 EC 5C
0050 | BC FD 0C 2F 49 AC E6 42 1D 59 E2 5B 98 86 96 3D
0060 | AF 7E 8C 78 75 F0 1E D9 1B 2C 25 A4 A3 B2 67 1F
0070 | D7 83 CC 37 AC 95 0D 60 AE 6A 2E FA 52 62 52 81
0080 | 5A 17 B5 AA D4 B6 4D 49 A0 2A 95 84 43 29 B3 AE
0090 | 43 23 1E A0 0D 70 F6 84 EB 94 3F BB 0E 65 96 ED
00A0 | 4C 3A D4 13 56 B3 19 99 B0 BA 48 FD 57 3F 86 94
00B0 | AF 89 D4 F2 3B 40 B4 7E 0C 1A 4A D8 A2 CC F9 37
00C0 | F3 BA D3 CA A6 8E C7 18 92 CD 63 8D D5 08 3B 4E
00D0 | 75 9F A7 B3 68 F7 8F 5B 4D 17 B2 26 29 0A 30 B6
00E0 | A0 09 21 AA 89 B5 9E 6C 2A 7D D2 1B FF 5E 3C 34
00F0 | 1D FA 0C 14 29 C0 7B 5A EA 60 12 84 0E DE A5 D9
0100 | BC 69 03 00 43 ED 31 0E B9 C5 75 55 AB 10 42 3F
0110 | 6C BE EE 1B 73 32 1D 6F 9C 6A 15 16 1F FD E2 54
0120 | E2 43 F1 9C 9D BD 09 AD 7B BE 17 A2 03 82 98 BD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001001C1D00EF717B307308D98876</code> <code>93C979D07A503D18F3E702B057AAA826</code> <code>C3C9EC5CBCFD0C2F49ACE6421D59E25B</code> <code>9886963DAF7E8C7875F01ED91B2C25A4</code> <code>A3B2671FD783CC37AC950D60AE6A2EFA</code> <code>526252815A17B5AAD4B64D49A02A9584</code> <code>4329B3AE43231EA00D70F684EB943FBB</code> <code>0E6596ED4C3AD41356B31999B0BA48FD</code> <code>573F8694AF89D4F23B40B47E0C1A4AD8</code> <code>A2CCF937F3BAD3CAA68EC71892CD638D</code> <code>D5083B4E759FA7B368F78F5B4D17B226</code> <code>290A30B6A00921AA89B59E6C2A7DD21B</code> <code>FF5E3C341DFA0C1429C07B5AEA601284</code> <code>0EDEA5D9BC69030043ED310EB9C57555</code> <code>AB10423F6CBEEE1B73321D6F9C6A1516</code> <code>1FFDE254E243F19C9DBD09AD7BBE17A2</code><br> <code>038298BD</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643669199732C27B3790D4B0852401BEB08500D3ED4D2447556709AD339F531432F9C0000000000000000FE0001001C1D00EF717B307308D9887693C979D07A503D18F3E702B057AAA826C3C9EC5CBCFD0C2F49ACE6421D59E25B9886963DAF7E8C7875F01ED91B2C25A4A3B2671FD783CC37AC950D60AE6A2EFA526252815A17B5AAD4B64D49A02A95844329B3AE43231EA00D70F684EB943FBB0E6596ED4C3AD41356B31999B0BA48FD573F8694AF89D4F23B40B47E0C1A4AD8A2CCF937F3BAD3CAA68EC71892CD638DD5083B4E759FA7B368F78F5B4D17B226290A30B6A00921AA89B59E6C2A7DD21BFF5E3C341DFA0C1429C07B5AEA6012840EDEA5D9BC69030043ED310EB9C57555AB10423F6CBEEE1B73321D6F9C6A15161FFDE254E243F19C9DBD09AD7BBE17A2038298BD
padding = CBD139937EA55433F18DD027
tmp_aes_key = 18C8F212766E6688124CFBE089558AD1943FDBF008083FE6F5412D3CCFD408B1
tmp_aes_iv = 7EAD20DAE26140635E5E210A0B3113925A7F90A3CD183F3EB3A85FCA19375943</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 97E7A12AD29BD1E3A304CFD611A37C765035661CF7ECC4655C0F8CB2D333EFC37EB163BD07800174F7A29379B849A33A8EE4DFDA11D47DA26D99AA349FED4073AFBB48506D225BF182D28E48150A3134CA210844B823B6D5613979D6408E32C3D3D691A8870F1FFF2B4BD75A3DC7680B365DFEFD20035CDFBC7E5F2006F74EEE24BB0C3045CFFD756AF0F9564BB9DA757465BE13131111BCD41802293AFDD69794413A1D4F153F916E2FA54BE3BA032B13B2A3A30F1836F47514BDDF6CD18122770EEF7127C36D20E4D98B8D64979D29D68A497000F54BF0CF5BFE02E51D268552C14E62CA5037CEF0FC748ECF085EB33DB510C670E94B991C17E296E23CF677899FD481F4D9189C87F1D695F8266089EA705569E5B2BDC19670ED0EE3F75B118CE82FF5118BC462D99E9C624694C92DA129FAECFCAED6AECCF2E43BF6F0BCA671A61511F2C0456F4A97EBD31BBFAC74</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 D8 07 00 9D D7 D6 68
0010 | 78 01 00 00 1F 5F 04 F5 91 99 73 2C 27 B3 79 0D
0020 | 4B 08 52 40 1B EB 08 50 0D 3E D4 D2 44 75 56 70
0030 | 9A D3 39 F5 31 43 2F 9C FE 50 01 00 97 E7 A1 2A
0040 | D2 9B D1 E3 A3 04 CF D6 11 A3 7C 76 50 35 66 1C
0050 | F7 EC C4 65 5C 0F 8C B2 D3 33 EF C3 7E B1 63 BD
0060 | 07 80 01 74 F7 A2 93 79 B8 49 A3 3A 8E E4 DF DA
0070 | 11 D4 7D A2 6D 99 AA 34 9F ED 40 73 AF BB 48 50
0080 | 6D 22 5B F1 82 D2 8E 48 15 0A 31 34 CA 21 08 44
0090 | B8 23 B6 D5 61 39 79 D6 40 8E 32 C3 D3 D6 91 A8
00A0 | 87 0F 1F FF 2B 4B D7 5A 3D C7 68 0B 36 5D FE FD
00B0 | 20 03 5C DF BC 7E 5F 20 06 F7 4E EE 24 BB 0C 30
00C0 | 45 CF FD 75 6A F0 F9 56 4B B9 DA 75 74 65 BE 13
00D0 | 13 11 11 BC D4 18 02 29 3A FD D6 97 94 41 3A 1D
00E0 | 4F 15 3F 91 6E 2F A5 4B E3 BA 03 2B 13 B2 A3 A3
00F0 | 0F 18 36 F4 75 14 BD DF 6C D1 81 22 77 0E EF 71
0100 | 27 C3 6D 20 E4 D9 8B 8D 64 97 9D 29 D6 8A 49 70
0110 | 00 F5 4B F0 CF 5B FE 02 E5 1D 26 85 52 C1 4E 62
0120 | CA 50 37 CE F0 FC 74 8E CF 08 5E B3 3D B5 10 C6
0130 | 70 E9 4B 99 1C 17 E2 96 E2 3C F6 77 89 9F D4 81
0140 | F4 D9 18 9C 87 F1 D6 95 F8 26 60 89 EA 70 55 69
0150 | E5 B2 BD C1 96 70 ED 0E E3 F7 5B 11 8C E8 2F F5
0160 | 11 8B C4 62 D9 9E 9C 62 46 94 C9 2D A1 29 FA EC
0170 | FC AE D6 AE CC F2 E4 3B F6 F0 BC A6 71 A6 15 11
0180 | F2 C0 45 6F 4A 97 EB D3 1B BF AC 74</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0D807009DD7D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010097E7A12AD29BD1E3A304CFD6</code> <code>11A37C765035661CF7ECC4655C0F8CB2</code> <code>D333EFC37EB163BD07800174F7A29379</code> <code>B849A33A8EE4DFDA11D47DA26D99AA34</code> <code>9FED4073AFBB48506D225BF182D28E48</code> <code>150A3134CA210844B823B6D5613979D6</code> <code>408E32C3D3D691A8870F1FFF2B4BD75A</code> <code>3DC7680B365DFEFD20035CDFBC7E5F20</code> <code>06F74EEE24BB0C3045CFFD756AF0F956</code> <code>4BB9DA757465BE13131111BCD4180229</code> <code>3AFDD69794413A1D4F153F916E2FA54B</code> <code>E3BA032B13B2A3A30F1836F47514BDDF</code> <code>6CD18122770EEF7127C36D20E4D98B8D</code> <code>64979D29D68A497000F54BF0CF5BFE02</code> <code>E51D268552C14E62CA5037CEF0FC748E</code> <code>CF085EB33DB510C670E94B991C17E296</code> <code>E23CF677899FD481F4D9189C87F1D695</code> <code>F8266089EA705569E5B2BDC19670ED0E</code> <code>E3F75B118CE82FF5118BC462D99E9C62</code> <code>4694C92DA129FAECFCAED6AECCF2E43B</code> <code>F6F0BCA671A61511F2C0456F4A97EBD3</code><br> <code>1BBFAC74</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 3E7A82F4545A92F3AAF65A2BFA0C3081123716D8C6AC03CFB88AD53EF71B3BEA35CB0ADB212642F556709BC67B8E0DEF9680D50447C5C08D0EE38156E1759AC22B8BE63C16810DC5C7DE6A3C2DED0EF60924FED46CBB2D00FCC0744458B02E4659B2A8E8F0E2F0AB380D529D7C09FB9BCA846749C8B111CE317915479B946FFA3354E31494E1876F6EBD0A756E49A80DDA844754999ECF44B43835AB465C3012E75C62DC81F3BF1C980F4F7746015FD25997D1F4610BB153212FF7F6ACDE27215D10BE0F1BCD30120205C9418B451553DF4EEF005FFD6C7210DC67FBD53497C2E428527AD0E759EB65C9E41A44DFA91FBD4697413B40D8808F108DB2887E9869</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 C2 13 A0 D7 D6 68
0010 | 34 00 00 00 34 F7 CB 3B 91 99 73 2C 27 B3 79 0D
0020 | 4B 08 52 40 1B EB 08 50 0D 3E D4 D2 44 75 56 70
0030 | 9A D3 39 F5 31 43 2F 9C A3 10 F5 55 BC 6D 7C 76
0040 | 91 36 69 50 03 46 29 BA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E0C213A0D7D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>9199732C27B3790D4B0852401BEB0850</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0D3ED4D2447556709AD339F531432F9C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>A310F555BC6D7C7691366950034629BA</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

