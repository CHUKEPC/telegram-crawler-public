<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 AC 90 0D 00 61 1B CB 68
0010 | 14 00 00 00 F1 8E 7E BE 70 9A 1A 9B 9D C2 C3 C8
0020 | 4F E4 18 E6 B8 29 F4 47</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>AC900D00611BCB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 B4 A8 61 1B CB 68
0010 | 50 00 00 00 63 24 16 05 70 9A 1A 9B 9D C2 C3 C8
0020 | 4F E4 18 E6 B8 29 F4 47 61 02 C5 54 F1 56 E9 D7
0030 | 3B 33 63 E5 7D D1 ED FE 08 2B D3 5E E4 99 42 87
0040 | 13 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E0B4A8611BCB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082BD35EE499428713000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3157972099633678099</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3157972099633678099</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3157972099633678099 = 1760328991 * 1793966989</code></p>
<pre><code>p = 1760328991
q = 1793966989</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2B D3 5E E4 99 42 87 13 00 00 00
0010 | 04 68 EC 7D 1F 00 00 00 04 6A ED C3 8D 00 00 00
0020 | 70 9A 1A 9B 9D C2 C3 C8 4F E4 18 E6 B8 29 F4 47
0030 | 61 02 C5 54 F1 56 E9 D7 3B 33 63 E5 7D D1 ED FE
0040 | 7A 42 6E 4A 34 3B 19 5A 13 0B 53 8A F4 92 3B 25
0050 | 2A 11 76 92 79 28 B4 31 79 82 8F 41 93 1C FD F7
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082BD35EE499428713000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3157972099633678099</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0468EC7D1F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1760328991</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046AEDC38D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1793966989</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>7A426E4A343B195A130B538AF4923B25</code> <code>2A1176927928B43179828F41931CFDF7</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082BD35EE4994287130000000468EC7D1F000000046AEDC38D000000709A1A9B9DC2C3C84FE418E6B829F4476102C554F156E9D73B3363E57DD1EDFE7A426E4A343B195A130B538AF4923B252A1176927928B43179828F41931CFDF702000000
random_padding_bytes = F1B4AE512078AA6A7282991CF96E5F248C552DB0C7981816BA198562E176B0BE34F98D3909A49F6CDB833DAD6A80FFA3AE986A5035BDFA340C7469DBF1B69FC56A6D449B42DED6B6FCAE76BDDD4879BE94E153CE2A87E9DF9DDFC048</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A2B7BAF4A99931E4E184AA5692CC274289943DB5C7C41430E529357508042DA49CDFDF806C6D0C064FCBE7890550BC6B3B724B0C28F3FA1EB560A703DA571A2B8500BC0252737305027C17F81C930EEC37E13213BA8B9B4849709947046C2E1EB533720BE5FB3A8831019CCC938B469C3E6F4D95B9FD26BD3E997C340D805984CC5E91C3BABF313802F9488D89575BFA7E142B73D31A1E0EAB9885A7B77828A386E783F34A86F2C13960EB43FDC615EF4923A59CE165215B71AE45B1E071AFF521DB75FCC737C3822901BD04A942F94C2ABED3FC4BE0EAB54C82D1EA41E1EA231951180D95C357059BC6E9F3E14F045C7F20ADAFFDE5D6E940AD1BF499F536A0</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 90 0D 00 61 1B CB 68
0010 | 40 01 00 00 BE E4 12 D7 70 9A 1A 9B 9D C2 C3 C8
0020 | 4F E4 18 E6 B8 29 F4 47 61 02 C5 54 F1 56 E9 D7
0030 | 3B 33 63 E5 7D D1 ED FE 04 68 EC 7D 1F 00 00 00
0040 | 04 6A ED C3 8D 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A2 B7 BA F4 A9 99 31 E4 E1 84 AA 56
0060 | 92 CC 27 42 89 94 3D B5 C7 C4 14 30 E5 29 35 75
0070 | 08 04 2D A4 9C DF DF 80 6C 6D 0C 06 4F CB E7 89
0080 | 05 50 BC 6B 3B 72 4B 0C 28 F3 FA 1E B5 60 A7 03
0090 | DA 57 1A 2B 85 00 BC 02 52 73 73 05 02 7C 17 F8
00A0 | 1C 93 0E EC 37 E1 32 13 BA 8B 9B 48 49 70 99 47
00B0 | 04 6C 2E 1E B5 33 72 0B E5 FB 3A 88 31 01 9C CC
00C0 | 93 8B 46 9C 3E 6F 4D 95 B9 FD 26 BD 3E 99 7C 34
00D0 | 0D 80 59 84 CC 5E 91 C3 BA BF 31 38 02 F9 48 8D
00E0 | 89 57 5B FA 7E 14 2B 73 D3 1A 1E 0E AB 98 85 A7
00F0 | B7 78 28 A3 86 E7 83 F3 4A 86 F2 C1 39 60 EB 43
0100 | FD C6 15 EF 49 23 A5 9C E1 65 21 5B 71 AE 45 B1
0110 | E0 71 AF F5 21 DB 75 FC C7 37 C3 82 29 01 BD 04
0120 | A9 42 F9 4C 2A BE D3 FC 4B E0 EA B5 4C 82 D1 EA
0130 | 41 E1 EA 23 19 51 18 0D 95 C3 57 05 9B C6 E9 F3
0140 | E1 4F 04 5C 7F 20 AD AF FD E5 D6 E9 40 AD 1B F4
0150 | 99 F5 36 A0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B0900D00611BCB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0468EC7D1F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1760328991</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046AEDC38D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1793966989</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A2B7BAF4A99931E4E184AA56</code> <code>92CC274289943DB5C7C41430E5293575</code> <code>08042DA49CDFDF806C6D0C064FCBE789</code> <code>0550BC6B3B724B0C28F3FA1EB560A703</code> <code>DA571A2B8500BC0252737305027C17F8</code> <code>1C930EEC37E13213BA8B9B4849709947</code> <code>046C2E1EB533720BE5FB3A8831019CCC</code> <code>938B469C3E6F4D95B9FD26BD3E997C34</code> <code>0D805984CC5E91C3BABF313802F9488D</code> <code>89575BFA7E142B73D31A1E0EAB9885A7</code> <code>B77828A386E783F34A86F2C13960EB43</code> <code>FDC615EF4923A59CE165215B71AE45B1</code> <code>E071AFF521DB75FCC737C3822901BD04</code> <code>A942F94C2ABED3FC4BE0EAB54C82D1EA</code> <code>41E1EA231951180D95C357059BC6E9F3</code> <code>E14F045C7F20ADAFFDE5D6E940AD1BF4</code><br> <code>99F536A0</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 DC 50 E0 61 1B CB 68
0010 | 78 02 00 00 5C 07 E8 D0 70 9A 1A 9B 9D C2 C3 C8
0020 | 4F E4 18 E6 B8 29 F4 47 61 02 C5 54 F1 56 E9 D7
0030 | 3B 33 63 E5 7D D1 ED FE FE 50 02 00 6E C5 C2 DF
0040 | 79 39 A9 33 14 97 FC 37 58 7E 5C 3D E0 16 90 0E
0050 | 1D 9E 05 D5 C7 FF 2D 74 C1 F3 95 77 38 56 10 CA
0060 | 7A FF 17 BF EF F3 E1 64 88 A1 E4 D0 59 46 84 5B
0070 | 07 C8 37 3A 89 B6 3C C9 50 B3 EA 14 7A 83 C3 F2
0080 | 45 FF 97 51 5B F2 5D 82 7D 99 3C 46 4A DF 3A 3F
0090 | E8 BC B6 B8 7D 96 A3 A2 1E 6A 23 6D A8 F0 0C 34
00A0 | 3E 4C BF 1C 5D 77 9A A1 A2 7C 0E BB DD 76 10 65
00B0 | A2 DE D8 DF A3 73 8D D3 50 A8 9A 25 A0 3C B7 A1
00C0 | 44 16 67 95 4A F4 18 25 72 01 D2 92 B9 49 66 06
00D0 | 12 C1 9B F7 FF 3D 23 FF AA E6 4A 10 FC 84 8C E7
00E0 | E9 99 12 40 D0 7B EC E0 7D 19 1B 8D 56 5A 47 B1
00F0 | 5D E1 50 C5 49 3A 64 86 9A 1C 10 1C D0 8A D3 46
0100 | 20 3C 96 15 34 7A 48 8D 89 3D 8D D7 91 FA 22 E6
0110 | 6E 61 EA 1B 61 27 91 56 E6 F4 D2 33 1D FB 9F 44
0120 | E7 9E 0A 53 A3 37 EF 06 EE 6E 49 DC 92 1F E5 2D
0130 | 75 20 7B 43 76 23 94 C1 FD 5A DF 80 18 E6 E9 20
0140 | 9F 5C 72 2E 5C 1E 31 12 62 49 FE 46 09 36 54 01
0150 | BD C3 16 B5 B2 C2 4A 37 72 00 12 0C C2 F2 4D 0C
0160 | 12 F0 45 31 6B 4F E4 2D AC A7 EC E1 20 30 8B 4C
0170 | 96 2B 89 D5 54 76 FA AF 30 9D 54 33 31 FC 8F A7
0180 | 98 9D 3A 39 00 CB 4D 93 F9 24 22 53 75 0A B2 9F
0190 | 90 AF C3 0D 0E 74 5A 55 3F 46 B8 CE BD C7 D5 DB
01A0 | F3 26 AA EA C1 BC F5 F9 3D 70 46 19 2B 34 32 07
01B0 | D2 80 82 CD A4 5F 49 20 DD CD 43 75 13 17 61 AE
01C0 | 26 67 6C 66 2F 35 05 84 70 6B E5 73 B9 A6 75 F7
01D0 | DC 7A 18 B1 37 C6 EE 28 95 E8 7F E3 72 BF 7D 99
01E0 | 6A 9F 0D FF 2C 3C BC 73 C7 51 68 2D A7 8D 07 B3
01F0 | CA CF 8C E5 19 EC 77 A1 57 66 F0 9C DE D9 F1 E3
0200 | 6D CD 00 CB 50 6C 81 4C B6 B5 02 15 5C CA 5D 61
0210 | E4 6A 1C 49 52 FC F9 F9 AA CA 84 17 14 33 62 77
0220 | D2 18 49 98 A7 EC BD F7 2D 7D 4F 1C B7 1A A5 32
0230 | CC 5E A4 97 57 C7 E7 8F DD 20 2A A9 46 C0 6B 9D
0240 | 40 7E 81 D7 76 9C 55 58 CA 3C 99 95 F1 70 BA 56
0250 | 7B F6 EF A2 7C F1 67 74 3C 83 30 76 B6 CB 1A D6
0260 | 88 06 37 6C F3 7D 76 52 0A DC C4 D8 56 A5 96 8C
0270 | FB 1D 78 BD 28 70 8A 0F D2 EB D6 CD 01 FC 4B 94
0280 | 55 D6 38 D6 7F 38 EB AF 06 A2 65 BF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01DC50E0611BCB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002006EC5C2DF7939A9331497FC37</code> <code>587E5C3DE016900E1D9E05D5C7FF2D74</code> <code>C1F39577385610CA7AFF17BFEFF3E164</code> <code>88A1E4D05946845B07C8373A89B63CC9</code> <code>50B3EA147A83C3F245FF97515BF25D82</code> <code>7D993C464ADF3A3FE8BCB6B87D96A3A2</code> <code>1E6A236DA8F00C343E4CBF1C5D779AA1</code> <code>A27C0EBBDD761065A2DED8DFA3738DD3</code> <code>50A89A25A03CB7A1441667954AF41825</code> <code>7201D292B949660612C19BF7FF3D23FF</code> <code>AAE64A10FC848CE7E9991240D07BECE0</code> <code>7D191B8D565A47B15DE150C5493A6486</code> <code>9A1C101CD08AD346203C9615347A488D</code> <code>893D8DD791FA22E66E61EA1B61279156</code> <code>E6F4D2331DFB9F44E79E0A53A337EF06</code> <code>EE6E49DC921FE52D75207B43762394C1</code> <code>FD5ADF8018E6E9209F5C722E5C1E3112</code> <code>6249FE4609365401BDC316B5B2C24A37</code> <code>7200120CC2F24D0C12F045316B4FE42D</code> <code>ACA7ECE120308B4C962B89D55476FAAF</code> <code>309D543331FC8FA7989D3A3900CB4D93</code> <code>F9242253750AB29F90AFC30D0E745A55</code> <code>3F46B8CEBDC7D5DBF326AAEAC1BCF5F9</code> <code>3D7046192B343207D28082CDA45F4920</code> <code>DDCD4375131761AE26676C662F350584</code> <code>706BE573B9A675F7DC7A18B137C6EE28</code> <code>95E87FE372BF7D996A9F0DFF2C3CBC73</code> <code>C751682DA78D07B3CACF8CE519EC77A1</code> <code>5766F09CDED9F1E36DCD00CB506C814C</code> <code>B6B502155CCA5D61E46A1C4952FCF9F9</code> <code>AACA841714336277D2184998A7ECBDF7</code> <code>2D7D4F1CB71AA532CC5EA49757C7E78F</code> <code>DD202AA946C06B9D407E81D7769C5558</code> <code>CA3C9995F170BA567BF6EFA27CF16774</code> <code>3C833076B6CB1AD68806376CF37D7652</code> <code>0ADCC4D856A5968CFB1D78BD28708A0F</code> <code>D2EBD6CD01FC4B9455D638D67F38EBAF</code><br> <code>06A265BF</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 6EC5C2DF7939A9331497FC37587E5C3DE016900E1D9E05D5C7FF2D74C1F39577385610CA7AFF17BFEFF3E16488A1E4D05946845B07C8373A89B63CC950B3EA147A83C3F245FF97515BF25D827D993C464ADF3A3FE8BCB6B87D96A3A21E6A236DA8F00C343E4CBF1C5D779AA1A27C0EBBDD761065A2DED8DFA3738DD350A89A25A03CB7A1441667954AF418257201D292B949660612C19BF7FF3D23FFAAE64A10FC848CE7E9991240D07BECE07D191B8D565A47B15DE150C5493A64869A1C101CD08AD346203C9615347A488D893D8DD791FA22E66E61EA1B61279156E6F4D2331DFB9F44E79E0A53A337EF06EE6E49DC921FE52D75207B43762394C1FD5ADF8018E6E9209F5C722E5C1E31126249FE4609365401BDC316B5B2C24A377200120CC2F24D0C12F045316B4FE42DACA7ECE120308B4C962B89D55476FAAF309D543331FC8FA7989D3A3900CB4D93F9242253750AB29F90AFC30D0E745A553F46B8CEBDC7D5DBF326AAEAC1BCF5F93D7046192B343207D28082CDA45F4920DDCD4375131761AE26676C662F350584706BE573B9A675F7DC7A18B137C6EE2895E87FE372BF7D996A9F0DFF2C3CBC73C751682DA78D07B3CACF8CE519EC77A15766F09CDED9F1E36DCD00CB506C814CB6B502155CCA5D61E46A1C4952FCF9F9AACA841714336277D2184998A7ECBDF72D7D4F1CB71AA532CC5EA49757C7E78FDD202AA946C06B9D407E81D7769C5558CA3C9995F170BA567BF6EFA27CF167743C833076B6CB1AD68806376CF37D76520ADCC4D856A5968CFB1D78BD28708A0FD2EBD6CD01FC4B9455D638D67F38EBAF06A265BF
tmp_aes_key = A71994F8A32D22172AB845A27C2194A780E5A80613B95E6543EF29DD09C59E66
tmp_aes_iv = 67F6235CFA4355863A44B9008288F0EB12A20FC692DAC44AF9951F727A426E4A</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = AC9106F39C988E32572C5F8FA47DD2F92E774B9BBA0D89B5709A1A9B9DC2C3C84FE418E6B829F4476102C554F156E9D73B3363E57DD1EDFE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100A15211D7A3F980776BFAB8D79F9547CF09418BFB351AEAD98011234A3B8C1042CEF9962087B2BCDF4AB39A89A012518A1D5C763545E228F48117A3DB222D584EB1AA549E116513730158BF6AF9D499C6E6AD61C2D81F1207B91953326D1F4487E406EAA2351F2A1F7C86101C45BDED97B9FA25F44FF5B56585BC5C080BF281B2E6F96838DDB9F7364E92E4B2C555C2EBE7AB240DD5CA2601C99699037C2612311692F7E8AF4F408246E42F1DE2F3BF2AF451016BF8A0C63A31C5140A78CBEC5C2E84B241E938BCBE299B5534CCEFF3E787A8D733DB9757B500A8E152DFDF86C3FAF9ED693EA38B7ACE7C6D7FA4E6867C11C847945F361DD15BC59256D4544FF4611BCB68DC7BF088E3C723C9
answer = BA0D89B5709A1A9B9DC2C3C84FE418E6B829F4476102C554F156E9D73B3363E57DD1EDFE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100A15211D7A3F980776BFAB8D79F9547CF09418BFB351AEAD98011234A3B8C1042CEF9962087B2BCDF4AB39A89A012518A1D5C763545E228F48117A3DB222D584EB1AA549E116513730158BF6AF9D499C6E6AD61C2D81F1207B91953326D1F4487E406EAA2351F2A1F7C86101C45BDED97B9FA25F44FF5B56585BC5C080BF281B2E6F96838DDB9F7364E92E4B2C555C2EBE7AB240DD5CA2601C99699037C2612311692F7E8AF4F408246E42F1DE2F3BF2AF451016BF8A0C63A31C5140A78CBEC5C2E84B241E938BCBE299B5534CCEFF3E787A8D733DB9757B500A8E152DFDF86C3FAF9ED693EA38B7ACE7C6D7FA4E6867C11C847945F361DD15BC59256D4544FF4611BCB68DC7BF088E3C723C9</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 70 9A 1A 9B 9D C2 C3 C8 4F E4 18 E6
0010 | B8 29 F4 47 61 02 C5 54 F1 56 E9 D7 3B 33 63 E5
0020 | 7D D1 ED FE 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | A1 52 11 D7 A3 F9 80 77 6B FA B8 D7 9F 95 47 CF
0140 | 09 41 8B FB 35 1A EA D9 80 11 23 4A 3B 8C 10 42
0150 | CE F9 96 20 87 B2 BC DF 4A B3 9A 89 A0 12 51 8A
0160 | 1D 5C 76 35 45 E2 28 F4 81 17 A3 DB 22 2D 58 4E
0170 | B1 AA 54 9E 11 65 13 73 01 58 BF 6A F9 D4 99 C6
0180 | E6 AD 61 C2 D8 1F 12 07 B9 19 53 32 6D 1F 44 87
0190 | E4 06 EA A2 35 1F 2A 1F 7C 86 10 1C 45 BD ED 97
01A0 | B9 FA 25 F4 4F F5 B5 65 85 BC 5C 08 0B F2 81 B2
01B0 | E6 F9 68 38 DD B9 F7 36 4E 92 E4 B2 C5 55 C2 EB
01C0 | E7 AB 24 0D D5 CA 26 01 C9 96 99 03 7C 26 12 31
01D0 | 16 92 F7 E8 AF 4F 40 82 46 E4 2F 1D E2 F3 BF 2A
01E0 | F4 51 01 6B F8 A0 C6 3A 31 C5 14 0A 78 CB EC 5C
01F0 | 2E 84 B2 41 E9 38 BC BE 29 9B 55 34 CC EF F3 E7
0200 | 87 A8 D7 33 DB 97 57 B5 00 A8 E1 52 DF DF 86 C3
0210 | FA F9 ED 69 3E A3 8B 7A CE 7C 6D 7F A4 E6 86 7C
0220 | 11 C8 47 94 5F 36 1D D1 5B C5 92 56 D4 54 4F F4
0230 | 61 1B CB 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100A15211D7A3F980776BFAB8D7</code> <code>9F9547CF09418BFB351AEAD98011234A</code> <code>3B8C1042CEF9962087B2BCDF4AB39A89</code> <code>A012518A1D5C763545E228F48117A3DB</code> <code>222D584EB1AA549E116513730158BF6A</code> <code>F9D499C6E6AD61C2D81F1207B9195332</code> <code>6D1F4487E406EAA2351F2A1F7C86101C</code> <code>45BDED97B9FA25F44FF5B56585BC5C08</code> <code>0BF281B2E6F96838DDB9F7364E92E4B2</code> <code>C555C2EBE7AB240DD5CA2601C9969903</code> <code>7C2612311692F7E8AF4F408246E42F1D</code> <code>E2F3BF2AF451016BF8A0C63A31C5140A</code> <code>78CBEC5C2E84B241E938BCBE299B5534</code> <code>CCEFF3E787A8D733DB9757B500A8E152</code> <code>DFDF86C3FAF9ED693EA38B7ACE7C6D7F</code> <code>A4E6867C11C847945F361DD15BC59256</code><br> <code>D4544FF4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>611BCB68</code> (1758141281 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 83C57E2451BA39AB92DB9CCB11EA26630F1C4C082D603B571FE3904D6A4503DA89C340FCF80F8D921D0CA14ABEBA874FC90A8C2871FD56E276DB0089DD3A2D1B03F2B5EE1052B19787D1A18E6C1D740CC749497F6ADC60A3BAD3BFE9BC32E01F01F7001BE0BB6689887F41E16474AF2D3187C1B8629511C4143A9D8B59324AD75EA99B889DA24324225A9A082F456DD9B13CDC0177BD9E300215A339ABA1908CDA04415B0F808F665839A7F139DFBAD867ED38C885DD11E45D0ECF2B03D6F3BBCFF49CA35D7641FE9D03075EB690188EB808B3AE6A690BED3D3A5808A4AB706318AE1FFED483113FDC16D0437A51FC7FE040F332F5337728ABFC335DF0815B11</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 27BADC788F69688FC8EEE0D86C05A0173FD5FFE703F73C1FA63E10B707129C7DC6D08B6B82823ECCC0FF7D490331E9897C324EF481BFF2E85BA5CD5A57BA89F4459373CE828AF4344AB660A97B2B3EE288EB0EFB59006750F67E3AF881959A2CC4AAD4E9407D59CB858EBB992AD7691E7DF3B4901A02D30B98EB3C295FA3EC6ECD54DBB4906DB4F0E5FC95B8E43DAF4F2DF21BDC4782280DA2B851F7C81C4086E3DE58052906B7315BF46050C7AB2516FAD4CDCB35309E8B04E89974A0D81D87B8DD7DACCB7D3C26C7634B516D16BC19E54CB10F4EF0B89ADFA81C88B09DE2124A0347796707ECD806FDAF2F45C01B768C6F6D75DF2B5301ED2BA47D4CA77403</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 70 9A 1A 9B 9D C2 C3 C8 4F E4 18 E6
0010 | B8 29 F4 47 61 02 C5 54 F1 56 E9 D7 3B 33 63 E5
0020 | 7D D1 ED FE 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 27 BA DC 78 8F 69 68 8F C8 EE E0 D8 6C 05 A0 17
0040 | 3F D5 FF E7 03 F7 3C 1F A6 3E 10 B7 07 12 9C 7D
0050 | C6 D0 8B 6B 82 82 3E CC C0 FF 7D 49 03 31 E9 89
0060 | 7C 32 4E F4 81 BF F2 E8 5B A5 CD 5A 57 BA 89 F4
0070 | 45 93 73 CE 82 8A F4 34 4A B6 60 A9 7B 2B 3E E2
0080 | 88 EB 0E FB 59 00 67 50 F6 7E 3A F8 81 95 9A 2C
0090 | C4 AA D4 E9 40 7D 59 CB 85 8E BB 99 2A D7 69 1E
00A0 | 7D F3 B4 90 1A 02 D3 0B 98 EB 3C 29 5F A3 EC 6E
00B0 | CD 54 DB B4 90 6D B4 F0 E5 FC 95 B8 E4 3D AF 4F
00C0 | 2D F2 1B DC 47 82 28 0D A2 B8 51 F7 C8 1C 40 86
00D0 | E3 DE 58 05 29 06 B7 31 5B F4 60 50 C7 AB 25 16
00E0 | FA D4 CD CB 35 30 9E 8B 04 E8 99 74 A0 D8 1D 87
00F0 | B8 DD 7D AC CB 7D 3C 26 C7 63 4B 51 6D 16 BC 19
0100 | E5 4C B1 0F 4E F0 B8 9A DF A8 1C 88 B0 9D E2 12
0110 | 4A 03 47 79 67 07 EC D8 06 FD AF 2F 45 C0 1B 76
0120 | 8C 6F 6D 75 DF 2B 53 01 ED 2B A4 7D 4C A7 74 03</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010027BADC788F69688FC8EEE0D8</code> <code>6C05A0173FD5FFE703F73C1FA63E10B7</code> <code>07129C7DC6D08B6B82823ECCC0FF7D49</code> <code>0331E9897C324EF481BFF2E85BA5CD5A</code> <code>57BA89F4459373CE828AF4344AB660A9</code> <code>7B2B3EE288EB0EFB59006750F67E3AF8</code> <code>81959A2CC4AAD4E9407D59CB858EBB99</code> <code>2AD7691E7DF3B4901A02D30B98EB3C29</code> <code>5FA3EC6ECD54DBB4906DB4F0E5FC95B8</code> <code>E43DAF4F2DF21BDC4782280DA2B851F7</code> <code>C81C4086E3DE58052906B7315BF46050</code> <code>C7AB2516FAD4CDCB35309E8B04E89974</code> <code>A0D81D87B8DD7DACCB7D3C26C7634B51</code> <code>6D16BC19E54CB10F4EF0B89ADFA81C88</code> <code>B09DE2124A0347796707ECD806FDAF2F</code> <code>45C01B768C6F6D75DF2B5301ED2BA47D</code><br> <code>4CA77403</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366709A1A9B9DC2C3C84FE418E6B829F4476102C554F156E9D73B3363E57DD1EDFE0000000000000000FE00010027BADC788F69688FC8EEE0D86C05A0173FD5FFE703F73C1FA63E10B707129C7DC6D08B6B82823ECCC0FF7D490331E9897C324EF481BFF2E85BA5CD5A57BA89F4459373CE828AF4344AB660A97B2B3EE288EB0EFB59006750F67E3AF881959A2CC4AAD4E9407D59CB858EBB992AD7691E7DF3B4901A02D30B98EB3C295FA3EC6ECD54DBB4906DB4F0E5FC95B8E43DAF4F2DF21BDC4782280DA2B851F7C81C4086E3DE58052906B7315BF46050C7AB2516FAD4CDCB35309E8B04E89974A0D81D87B8DD7DACCB7D3C26C7634B516D16BC19E54CB10F4EF0B89ADFA81C88B09DE2124A0347796707ECD806FDAF2F45C01B768C6F6D75DF2B5301ED2BA47D4CA77403
padding = 04D1764CBA12FB98C3F9A8D1
tmp_aes_key = A71994F8A32D22172AB845A27C2194A780E5A80613B95E6543EF29DD09C59E66
tmp_aes_iv = 67F6235CFA4355863A44B9008288F0EB12A20FC692DAC44AF9951F727A426E4A</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 36877023A6BA8DAE2EF37BF19984819F895484F661D7D59D44A883791B141F040F860E0CC9D81437C3B81CBDE1E2B69A42DC38F1C8C9491E1551F538905027EEA01736E2B29D1FA092428AA67065F6BC8ADEBAC519D01B2563E1EFA9A3FF327824B008668E4F93350AA0CF3F10E529CE36FB479F55BBBA5FBB9C2B8D54C043C830CFB0645C2C7A41C8D8AD4A2B229B255E318CA422D35091CB60B859DA2812E29752AFAA759DCC301486E490F0940CA9223D2DF425B385EF2181657C81C5528AFB09EAA6CCAC7632621E13A6A90C666ACE83B178D05BB27F137DE13A1FB80365EBBCFC9A04547DA1109C34F1CEA621FB1C7BCC09482679E293D67E84AE5045F717FECF1C12C10F98CA9BF2CCA1C736F1F145EB41EACEF0064713469DA2BE75779FD4CB0472BB881D55CCD87BAB83C27BE3B05392713A5FDAE1F19AE2EF4367020DBA1F5EBA384D90445882D0FC11F076</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B4 90 0D 00 61 1B CB 68
0010 | 78 01 00 00 1F 5F 04 F5 70 9A 1A 9B 9D C2 C3 C8
0020 | 4F E4 18 E6 B8 29 F4 47 61 02 C5 54 F1 56 E9 D7
0030 | 3B 33 63 E5 7D D1 ED FE FE 50 01 00 36 87 70 23
0040 | A6 BA 8D AE 2E F3 7B F1 99 84 81 9F 89 54 84 F6
0050 | 61 D7 D5 9D 44 A8 83 79 1B 14 1F 04 0F 86 0E 0C
0060 | C9 D8 14 37 C3 B8 1C BD E1 E2 B6 9A 42 DC 38 F1
0070 | C8 C9 49 1E 15 51 F5 38 90 50 27 EE A0 17 36 E2
0080 | B2 9D 1F A0 92 42 8A A6 70 65 F6 BC 8A DE BA C5
0090 | 19 D0 1B 25 63 E1 EF A9 A3 FF 32 78 24 B0 08 66
00A0 | 8E 4F 93 35 0A A0 CF 3F 10 E5 29 CE 36 FB 47 9F
00B0 | 55 BB BA 5F BB 9C 2B 8D 54 C0 43 C8 30 CF B0 64
00C0 | 5C 2C 7A 41 C8 D8 AD 4A 2B 22 9B 25 5E 31 8C A4
00D0 | 22 D3 50 91 CB 60 B8 59 DA 28 12 E2 97 52 AF AA
00E0 | 75 9D CC 30 14 86 E4 90 F0 94 0C A9 22 3D 2D F4
00F0 | 25 B3 85 EF 21 81 65 7C 81 C5 52 8A FB 09 EA A6
0100 | CC AC 76 32 62 1E 13 A6 A9 0C 66 6A CE 83 B1 78
0110 | D0 5B B2 7F 13 7D E1 3A 1F B8 03 65 EB BC FC 9A
0120 | 04 54 7D A1 10 9C 34 F1 CE A6 21 FB 1C 7B CC 09
0130 | 48 26 79 E2 93 D6 7E 84 AE 50 45 F7 17 FE CF 1C
0140 | 12 C1 0F 98 CA 9B F2 CC A1 C7 36 F1 F1 45 EB 41
0150 | EA CE F0 06 47 13 46 9D A2 BE 75 77 9F D4 CB 04
0160 | 72 BB 88 1D 55 CC D8 7B AB 83 C2 7B E3 B0 53 92
0170 | 71 3A 5F DA E1 F1 9A E2 EF 43 67 02 0D BA 1F 5E
0180 | BA 38 4D 90 44 58 82 D0 FC 11 F0 76</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B4900D00611BCB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010036877023A6BA8DAE2EF37BF1</code> <code>9984819F895484F661D7D59D44A88379</code> <code>1B141F040F860E0CC9D81437C3B81CBD</code> <code>E1E2B69A42DC38F1C8C9491E1551F538</code> <code>905027EEA01736E2B29D1FA092428AA6</code> <code>7065F6BC8ADEBAC519D01B2563E1EFA9</code> <code>A3FF327824B008668E4F93350AA0CF3F</code> <code>10E529CE36FB479F55BBBA5FBB9C2B8D</code> <code>54C043C830CFB0645C2C7A41C8D8AD4A</code> <code>2B229B255E318CA422D35091CB60B859</code> <code>DA2812E29752AFAA759DCC301486E490</code> <code>F0940CA9223D2DF425B385EF2181657C</code> <code>81C5528AFB09EAA6CCAC7632621E13A6</code> <code>A90C666ACE83B178D05BB27F137DE13A</code> <code>1FB80365EBBCFC9A04547DA1109C34F1</code> <code>CEA621FB1C7BCC09482679E293D67E84</code> <code>AE5045F717FECF1C12C10F98CA9BF2CC</code> <code>A1C736F1F145EB41EACEF0064713469D</code> <code>A2BE75779FD4CB0472BB881D55CCD87B</code> <code>AB83C27BE3B05392713A5FDAE1F19AE2</code> <code>EF4367020DBA1F5EBA384D90445882D0</code><br> <code>FC11F076</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2765B1E27C8484CBF753E11C1AFC944A8B2F6B2216FE4748FACD3C92A22CC5EE9757FA63CD4B5B05AA0B43E8F6657CA79B8F2BCA84631AC624DA52E3EA20872D20D560C23BB251BF6ECD414B07A847EFDD6CDE05DC5FCB129B6C2737C5EF726C73B5CDFB9FAABA218478EDEFDC5422B0560F17AF1A46DA4B9F96D8C1EB239B1CB6A4C28C8730F10A47A827FCE89D976AEB6F54F5B53DA1F5B3E0DC1BB1D4E54BB6B08602A98DA0F179FF2F51B8D52C88CB2FDB277E3715E644359E666A88ED1482C746BCDBCC006DDE6E3E3F9E41D409F79B4CB33A5A0B26C4B760FED3AD0DE38B1FD80AA3CDD2F90F4F85817AC1BA3571A538B2B663350666375193FC19B01D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C0 95 01 63 1B CB 68
0010 | 34 00 00 00 34 F7 CB 3B 70 9A 1A 9B 9D C2 C3 C8
0020 | 4F E4 18 E6 B8 29 F4 47 61 02 C5 54 F1 56 E9 D7
0030 | 3B 33 63 E5 7D D1 ED FE 49 2D 77 73 31 FB 2E 84
0040 | 59 8A B0 DF 33 18 90 B2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C09501631BCB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>709A1A9B9DC2C3C84FE418E6B829F447</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6102C554F156E9D73B3363E57DD1EDFE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>492D777331FB2E84598AB0DF331890B2</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

