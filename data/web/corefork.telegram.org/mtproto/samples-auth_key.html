<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D8 F9 06 00 F1 20 A9 66
0010 | 14 00 00 00 F1 8E 7E BE D9 43 A3 CF F0 5D DE D8
0020 | 4C BD B5 C9 73 00 93 EE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D8F90600F120A966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 B9 0B F2 20 A9 66
0010 | 88 00 00 00 63 24 16 05 D9 43 A3 CF F0 5D DE D8
0020 | 4C BD B5 C9 73 00 93 EE DB A2 9F C9 E2 11 06 92
0030 | 56 1C 3C 74 94 8F E1 DE 08 16 1E 19 75 2C 86 19
0040 | BB 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C4B90BF220A966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>88000000</code> (136 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08161E19752C8619BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1593739309184588219</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1593739309184588219</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1593739309184588219 = 1129690483 * 1410775193</code></p>
<pre><code>p = 1129690483
q = 1410775193</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 1E 19 75 2C 86 19 BB 00 00 00
0010 | 04 43 55 B5 73 00 00 00 04 54 16 B8 99 00 00 00
0020 | D9 43 A3 CF F0 5D DE D8 4C BD B5 C9 73 00 93 EE
0030 | DB A2 9F C9 E2 11 06 92 56 1C 3C 74 94 8F E1 DE
0040 | 46 66 D8 D8 4F EB E4 2B 37 AA CD C4 C3 75 21 78
0050 | 00 E5 E6 61 A2 7A 63 6C 0E 6A 20 6D 03 52 1B BC
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08161E19752C8619BB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1593739309184588219</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044355B573000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1129690483</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045416B899000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1410775193</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>4666D8D84FEBE42B37AACDC4C3752178</code> <code>00E5E661A27A636C0E6A206D03521BBC</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908161E19752C8619BB000000044355B573000000045416B899000000D943A3CFF05DDED84CBDB5C9730093EEDBA29FC9E2110692561C3C74948FE1DE4666D8D84FEBE42B37AACDC4C375217800E5E661A27A636C0E6A206D03521BBC02000000
random_padding_bytes = 198E72F87D664F2C97FF68422E35D0D39EB0DD8BE6A89351F03E56965EAFD1B699B8B87591B1F6AFF9E97068279ADD9EAC7ED4080056CC347932E4F5B5D0EFAED2D21223A8197BE51B54092FA0E64032BA5C59F22BD2D4BF6FA2E6F4</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = C2332A84B37FB811AF9CA4C116FCFBE6CBEC858DBFAF84C8A6669C1E61F152294037B625BD1A06C1FF6BA810EEA3BDB7C64125040325E0D60D0069AB884F897953926C2772DE423637C883ACF410AF8A7D76DA497ECA305DC996833EC9862E40F57C83A71ED055F15BD36AD5E82702B6350D493C6AA61A64279A29873D66F13476CBA45FCD5DFACAB76367E30C75DF99B0B3E2BDC7CBD8F18E3356821746FB9300FFA3A9AC744EA104EEF0ACF83C3691576A1A1B4FAE6EFDD07154249062D47A246D703A225EF47C2B483D20341B9960A3193D86EF433674A9663C910B24DCBC425ECF4E07E07B57D060944E4627C65B59A086E08AB635A86AB8D95CF5A6B8E7</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 B5 0A 00 F2 20 A9 66
0010 | 40 01 00 00 BE E4 12 D7 D9 43 A3 CF F0 5D DE D8
0020 | 4C BD B5 C9 73 00 93 EE DB A2 9F C9 E2 11 06 92
0030 | 56 1C 3C 74 94 8F E1 DE 04 43 55 B5 73 00 00 00
0040 | 04 54 16 B8 99 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 C2 33 2A 84 B3 7F B8 11 AF 9C A4 C1
0060 | 16 FC FB E6 CB EC 85 8D BF AF 84 C8 A6 66 9C 1E
0070 | 61 F1 52 29 40 37 B6 25 BD 1A 06 C1 FF 6B A8 10
0080 | EE A3 BD B7 C6 41 25 04 03 25 E0 D6 0D 00 69 AB
0090 | 88 4F 89 79 53 92 6C 27 72 DE 42 36 37 C8 83 AC
00A0 | F4 10 AF 8A 7D 76 DA 49 7E CA 30 5D C9 96 83 3E
00B0 | C9 86 2E 40 F5 7C 83 A7 1E D0 55 F1 5B D3 6A D5
00C0 | E8 27 02 B6 35 0D 49 3C 6A A6 1A 64 27 9A 29 87
00D0 | 3D 66 F1 34 76 CB A4 5F CD 5D FA CA B7 63 67 E3
00E0 | 0C 75 DF 99 B0 B3 E2 BD C7 CB D8 F1 8E 33 56 82
00F0 | 17 46 FB 93 00 FF A3 A9 AC 74 4E A1 04 EE F0 AC
0100 | F8 3C 36 91 57 6A 1A 1B 4F AE 6E FD D0 71 54 24
0110 | 90 62 D4 7A 24 6D 70 3A 22 5E F4 7C 2B 48 3D 20
0120 | 34 1B 99 60 A3 19 3D 86 EF 43 36 74 A9 66 3C 91
0130 | 0B 24 DC BC 42 5E CF 4E 07 E0 7B 57 D0 60 94 4E
0140 | 46 27 C6 5B 59 A0 86 E0 8A B6 35 A8 6A B8 D9 5C
0150 | F5 A6 B8 E7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C8B50A00F220A966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044355B573000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1129690483</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045416B899000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1410775193</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100C2332A84B37FB811AF9CA4C1</code> <code>16FCFBE6CBEC858DBFAF84C8A6669C1E</code> <code>61F152294037B625BD1A06C1FF6BA810</code> <code>EEA3BDB7C64125040325E0D60D0069AB</code> <code>884F897953926C2772DE423637C883AC</code> <code>F410AF8A7D76DA497ECA305DC996833E</code> <code>C9862E40F57C83A71ED055F15BD36AD5</code> <code>E82702B6350D493C6AA61A64279A2987</code> <code>3D66F13476CBA45FCD5DFACAB76367E3</code> <code>0C75DF99B0B3E2BDC7CBD8F18E335682</code> <code>1746FB9300FFA3A9AC744EA104EEF0AC</code> <code>F83C3691576A1A1B4FAE6EFDD0715424</code> <code>9062D47A246D703A225EF47C2B483D20</code> <code>341B9960A3193D86EF433674A9663C91</code> <code>0B24DCBC425ECF4E07E07B57D060944E</code> <code>4627C65B59A086E08AB635A86AB8D95C</code><br> <code>F5A6B8E7</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 90 20 EF F2 20 A9 66
0010 | 90 02 00 00 5C 07 E8 D0 D9 43 A3 CF F0 5D DE D8
0020 | 4C BD B5 C9 73 00 93 EE DB A2 9F C9 E2 11 06 92
0030 | 56 1C 3C 74 94 8F E1 DE FE 50 02 00 CC 1E 6E BC
0040 | 1B F2 E8 A2 2E 39 7E 40 95 66 35 06 FC 09 C7 21
0050 | 29 12 A6 F9 A2 37 85 CE FF 97 71 9D 5A 1A B5 CF
0060 | 19 13 6D C4 8C D1 4A 30 93 F8 3C 44 87 F7 23 25
0070 | 31 92 07 DB 5E 14 72 B9 36 B3 B1 92 9A F4 2B D2
0080 | 9F A1 FD 4C 90 73 23 C9 3B 36 5F 0A 0A 81 41 4F
0090 | C1 FB BD 12 49 BF 60 8C FD CC 78 6D 52 BD FD D7
00A0 | B3 3E 53 8E EA 34 92 2E FA D1 E7 FA E9 1F 49 50
00B0 | FA 28 DA 16 10 AD F2 48 E9 2E 60 8E 0A 31 9F CC
00C0 | 77 62 72 5E D1 65 3C 06 67 58 20 C3 D8 04 B7 60
00D0 | 1B 97 0D 8B BF 8D 3D FA AC 58 7B 5C D8 F7 AB 23
00E0 | D1 9D 11 55 6C 19 39 F2 7C 55 08 87 36 01 B4 42
00F0 | 1D AB 53 44 19 79 7B 57 82 A6 B0 D4 72 8D 46 C5
0100 | FD 38 A7 A2 BE 02 26 A2 58 44 F3 0A 4D 87 80 FA
0110 | 83 7A F3 74 15 4C F9 F3 3E 70 18 83 7E DD 5D 16
0120 | 30 3B 87 67 D4 A7 6D 57 E6 1F 08 E0 EE 02 AA 29
0130 | C7 3D 73 F1 AF B4 09 50 65 F6 1E 74 42 9A D2 23
0140 | DD 08 E0 42 12 1E 06 2C E8 52 25 F1 95 BC 8C 65
0150 | 50 B2 01 B7 55 55 D6 8B AF 71 D4 4A 49 51 67 F9
0160 | 47 A4 89 37 19 8D 87 F7 F6 2B 2F A2 95 A3 78 43
0170 | 9A 8B 82 A5 87 EC C8 50 78 53 55 4B 0C 53 87 2C
0180 | 78 01 91 00 75 DE DE FD AF 13 4E 6F D4 D4 12 52
0190 | A7 F6 08 99 9F A7 7E E9 B0 B7 FB EF 3B 15 BF 3C
01A0 | 43 CE 57 AA 05 A2 63 42 D5 63 AF DC D1 E4 01 FA
01B0 | F9 83 98 C2 D2 12 E4 E5 07 96 7E E0 FA 68 FA B5
01C0 | AD 25 68 1B 89 F5 6F 76 4E 98 D3 44 AD 2D 84 CF
01D0 | 42 38 43 B1 A3 9B 7A A9 0F 52 DA 7E 2A 7D 74 88
01E0 | AB 50 28 19 00 EC 61 18 60 96 76 44 2B 90 B6 33
01F0 | D4 9D C8 FD 6E DE 16 61 5B CD 0F A1 FE DC 47 AC
0200 | AE 22 92 7E 21 9C 4D 1A BC 21 3E 20 00 5A B8 9F
0210 | 35 58 A0 43 76 82 6E DD 8F 49 A9 0A FA 66 A0 AA
0220 | 99 66 C4 DA 74 B9 4B 5E 7F DB 10 DD D2 CB E2 8D
0230 | 5D 4F 7E 74 EC 5E 8B 14 52 6A 7B 44 74 5E 5D 75
0240 | E6 7D B2 CB 01 3C A4 F1 79 DA E0 B6 8F 64 1D 09
0250 | 7A 7C 1E 79 29 1E 8B 9C B2 85 7E 8B CD 5C 47 B6
0260 | A9 C9 25 4A DB 72 A0 AE DB FB CD E6 29 4A 3E 8F
0270 | FB 4C 42 EE BD 83 36 AE 9B 9E 7D F7 E5 22 5D E4
0280 | 9F 9D 84 82 6F DA A5 B2 A9 35 D4 8A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019020EFF220A966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90020000</code> (656 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200CC1E6EBC1BF2E8A22E397E40</code> <code>95663506FC09C7212912A6F9A23785CE</code> <code>FF97719D5A1AB5CF19136DC48CD14A30</code> <code>93F83C4487F72325319207DB5E1472B9</code> <code>36B3B1929AF42BD29FA1FD4C907323C9</code> <code>3B365F0A0A81414FC1FBBD1249BF608C</code> <code>FDCC786D52BDFDD7B33E538EEA34922E</code> <code>FAD1E7FAE91F4950FA28DA1610ADF248</code> <code>E92E608E0A319FCC7762725ED1653C06</code> <code>675820C3D804B7601B970D8BBF8D3DFA</code> <code>AC587B5CD8F7AB23D19D11556C1939F2</code> <code>7C5508873601B4421DAB534419797B57</code> <code>82A6B0D4728D46C5FD38A7A2BE0226A2</code> <code>5844F30A4D8780FA837AF374154CF9F3</code> <code>3E7018837EDD5D16303B8767D4A76D57</code> <code>E61F08E0EE02AA29C73D73F1AFB40950</code> <code>65F61E74429AD223DD08E042121E062C</code> <code>E85225F195BC8C6550B201B75555D68B</code> <code>AF71D44A495167F947A48937198D87F7</code> <code>F62B2FA295A378439A8B82A587ECC850</code> <code>7853554B0C53872C7801910075DEDEFD</code> <code>AF134E6FD4D41252A7F608999FA77EE9</code> <code>B0B7FBEF3B15BF3C43CE57AA05A26342</code> <code>D563AFDCD1E401FAF98398C2D212E4E5</code> <code>07967EE0FA68FAB5AD25681B89F56F76</code> <code>4E98D344AD2D84CF423843B1A39B7AA9</code> <code>0F52DA7E2A7D7488AB50281900EC6118</code> <code>609676442B90B633D49DC8FD6EDE1661</code> <code>5BCD0FA1FEDC47ACAE22927E219C4D1A</code> <code>BC213E20005AB89F3558A04376826EDD</code> <code>8F49A90AFA66A0AA9966C4DA74B94B5E</code> <code>7FDB10DDD2CBE28D5D4F7E74EC5E8B14</code> <code>526A7B44745E5D75E67DB2CB013CA4F1</code> <code>79DAE0B68F641D097A7C1E79291E8B9C</code> <code>B2857E8BCD5C47B6A9C9254ADB72A0AE</code> <code>DBFBCDE6294A3E8FFB4C42EEBD8336AE</code> <code>9B9E7DF7E5225DE49F9D84826FDAA5B2</code><br> <code>A935D48A</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = CC1E6EBC1BF2E8A22E397E4095663506FC09C7212912A6F9A23785CEFF97719D5A1AB5CF19136DC48CD14A3093F83C4487F72325319207DB5E1472B936B3B1929AF42BD29FA1FD4C907323C93B365F0A0A81414FC1FBBD1249BF608CFDCC786D52BDFDD7B33E538EEA34922EFAD1E7FAE91F4950FA28DA1610ADF248E92E608E0A319FCC7762725ED1653C06675820C3D804B7601B970D8BBF8D3DFAAC587B5CD8F7AB23D19D11556C1939F27C5508873601B4421DAB534419797B5782A6B0D4728D46C5FD38A7A2BE0226A25844F30A4D8780FA837AF374154CF9F33E7018837EDD5D16303B8767D4A76D57E61F08E0EE02AA29C73D73F1AFB4095065F61E74429AD223DD08E042121E062CE85225F195BC8C6550B201B75555D68BAF71D44A495167F947A48937198D87F7F62B2FA295A378439A8B82A587ECC8507853554B0C53872C7801910075DEDEFDAF134E6FD4D41252A7F608999FA77EE9B0B7FBEF3B15BF3C43CE57AA05A26342D563AFDCD1E401FAF98398C2D212E4E507967EE0FA68FAB5AD25681B89F56F764E98D344AD2D84CF423843B1A39B7AA90F52DA7E2A7D7488AB50281900EC6118609676442B90B633D49DC8FD6EDE16615BCD0FA1FEDC47ACAE22927E219C4D1ABC213E20005AB89F3558A04376826EDD8F49A90AFA66A0AA9966C4DA74B94B5E7FDB10DDD2CBE28D5D4F7E74EC5E8B14526A7B44745E5D75E67DB2CB013CA4F179DAE0B68F641D097A7C1E79291E8B9CB2857E8BCD5C47B6A9C9254ADB72A0AEDBFBCDE6294A3E8FFB4C42EEBD8336AE9B9E7DF7E5225DE49F9D84826FDAA5B2A935D48A
tmp_aes_key = 2FFA7A8B9C004E2428EDF3C965734A2180488F7E392040057C4EB60FE2805C61
tmp_aes_iv = 038D0785056EC5DBBCC8FB4CE5CC75F6DF508A3F20C99FD90C106AAF4666D8D8</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = EA5FB80C2C6D3157C6F494F7C6D26A9A1705F989BA0D89B5D943A3CFF05DDED84CBDB5C9730093EEDBA29FC9E2110692561C3C74948FE1DE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100469E938124EDC32D8D55E1BE2F9CBF54122C87D19ABA6011B3B8096567986F42E75F0F1877A659AB6A5A6740D2F6B4B136A3F7115CEA0934FF6629018B971FC4B1FF9AA2FB97841DE5D7D78F3F1574C96EB7153236679C6326869C5193DCAE3A0F0F6904367DD7EEC451AFE69F5950B6FF3BD804108437913B98F4C15055B0D18ECC68CA69A1D4D110857C3E3C150CB504A3DA16ECFDFD88E382E07D6EC66D8F37ED408E5E78321196A9F104703778FE715DC50E2ABBF59B3241AFD02AD26AFA83A0F8DE35B810D8691F0DE0183055186E175E00A21076CA59C870F225332082C4DD6C7D755D7111440D58A6A4E4DAAD6A4B57EBEED1FBA14A8F24400AA369E1F220A966B6913D4661220FED
answer = BA0D89B5D943A3CFF05DDED84CBDB5C9730093EEDBA29FC9E2110692561C3C74948FE1DE03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100469E938124EDC32D8D55E1BE2F9CBF54122C87D19ABA6011B3B8096567986F42E75F0F1877A659AB6A5A6740D2F6B4B136A3F7115CEA0934FF6629018B971FC4B1FF9AA2FB97841DE5D7D78F3F1574C96EB7153236679C6326869C5193DCAE3A0F0F6904367DD7EEC451AFE69F5950B6FF3BD804108437913B98F4C15055B0D18ECC68CA69A1D4D110857C3E3C150CB504A3DA16ECFDFD88E382E07D6EC66D8F37ED408E5E78321196A9F104703778FE715DC50E2ABBF59B3241AFD02AD26AFA83A0F8DE35B810D8691F0DE0183055186E175E00A21076CA59C870F225332082C4DD6C7D755D7111440D58A6A4E4DAAD6A4B57EBEED1FBA14A8F24400AA369E1F220A966B6913D4661220FED</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 D9 43 A3 CF F0 5D DE D8 4C BD B5 C9
0010 | 73 00 93 EE DB A2 9F C9 E2 11 06 92 56 1C 3C 74
0020 | 94 8F E1 DE 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 46 9E 93 81 24 ED C3 2D 8D 55 E1 BE 2F 9C BF 54
0140 | 12 2C 87 D1 9A BA 60 11 B3 B8 09 65 67 98 6F 42
0150 | E7 5F 0F 18 77 A6 59 AB 6A 5A 67 40 D2 F6 B4 B1
0160 | 36 A3 F7 11 5C EA 09 34 FF 66 29 01 8B 97 1F C4
0170 | B1 FF 9A A2 FB 97 84 1D E5 D7 D7 8F 3F 15 74 C9
0180 | 6E B7 15 32 36 67 9C 63 26 86 9C 51 93 DC AE 3A
0190 | 0F 0F 69 04 36 7D D7 EE C4 51 AF E6 9F 59 50 B6
01A0 | FF 3B D8 04 10 84 37 91 3B 98 F4 C1 50 55 B0 D1
01B0 | 8E CC 68 CA 69 A1 D4 D1 10 85 7C 3E 3C 15 0C B5
01C0 | 04 A3 DA 16 EC FD FD 88 E3 82 E0 7D 6E C6 6D 8F
01D0 | 37 ED 40 8E 5E 78 32 11 96 A9 F1 04 70 37 78 FE
01E0 | 71 5D C5 0E 2A BB F5 9B 32 41 AF D0 2A D2 6A FA
01F0 | 83 A0 F8 DE 35 B8 10 D8 69 1F 0D E0 18 30 55 18
0200 | 6E 17 5E 00 A2 10 76 CA 59 C8 70 F2 25 33 20 82
0210 | C4 DD 6C 7D 75 5D 71 11 44 0D 58 A6 A4 E4 DA AD
0220 | 6A 4B 57 EB EE D1 FB A1 4A 8F 24 40 0A A3 69 E1
0230 | F2 20 A9 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100469E938124EDC32D8D55E1BE</code> <code>2F9CBF54122C87D19ABA6011B3B80965</code> <code>67986F42E75F0F1877A659AB6A5A6740</code> <code>D2F6B4B136A3F7115CEA0934FF662901</code> <code>8B971FC4B1FF9AA2FB97841DE5D7D78F</code> <code>3F1574C96EB7153236679C6326869C51</code> <code>93DCAE3A0F0F6904367DD7EEC451AFE6</code> <code>9F5950B6FF3BD804108437913B98F4C1</code> <code>5055B0D18ECC68CA69A1D4D110857C3E</code> <code>3C150CB504A3DA16ECFDFD88E382E07D</code> <code>6EC66D8F37ED408E5E78321196A9F104</code> <code>703778FE715DC50E2ABBF59B3241AFD0</code> <code>2AD26AFA83A0F8DE35B810D8691F0DE0</code> <code>183055186E175E00A21076CA59C870F2</code> <code>25332082C4DD6C7D755D7111440D58A6</code> <code>A4E4DAAD6A4B57EBEED1FBA14A8F2440</code><br> <code>0AA369E1</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>F220A966</code> (1722360050 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 1CFBD607ECFB4A8A92411D4E252229A9A432ADEC8D0EB3FF9A24083E96902B4550ADE629A03F927F7A011F9DDC1230B7A5AB933CF256AA44E9EC51BD0E95F8047458F9D11C67F23ECCBAADD26EF34EA58FDB0243C7FE74A8F88DFC90122975F0E19DE08924055FE28F2D49E941369240122D711F93801D47FC02885B6F82C6B40448AB13E965891C890880900AF883067EFAAD00B6F8E67AB6DA195B5D0499E8ED63A92B543A91C6D9E2BC8522F762EB4D3A993151476C169B22A92AAB0C40271D97F21AAC7BAB6CF1AEBBDF72567C645546FE18844049285051EAD74E4AE7D2C35A77D7797822F4F98E8A3B89A85E10177AFE9BBBE2F03FDA6A9462CA4EC094</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 08E0814CCDE4FE2783C33149BFFDD430C60F74AA250418313773D4212DFAE2737B4F7AA9D78BCBBC303B4218E190598B828B243B02D3F844CF0EF247837DB200DAF0A310103681803FD60DFEEE2BCD9E211CFB396C70CC5A4FAD1C15B8E1986BC3268CACF094EF02CC36D13806BAFED2A6E1E92923E8166761078F8048F0B05407CA73CA57FCF2C387C7D6A9D04F091615E6D316A4CA2327D5291676B9D337F245089DEF67A765794945C3D6A1D4340C0F75A456B6E3D2BE45AC0EB9AF7360270FB3332C6AA0C15F4515A2C7E7115F69659A3CC09309D717F94F95BF2A533F8C0F9A0F82197487D322CCF68B96C7D3815CCE8D3E57AE93AB4E8F46DF5483A082</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 D9 43 A3 CF F0 5D DE D8 4C BD B5 C9
0010 | 73 00 93 EE DB A2 9F C9 E2 11 06 92 56 1C 3C 74
0020 | 94 8F E1 DE 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 08 E0 81 4C CD E4 FE 27 83 C3 31 49 BF FD D4 30
0040 | C6 0F 74 AA 25 04 18 31 37 73 D4 21 2D FA E2 73
0050 | 7B 4F 7A A9 D7 8B CB BC 30 3B 42 18 E1 90 59 8B
0060 | 82 8B 24 3B 02 D3 F8 44 CF 0E F2 47 83 7D B2 00
0070 | DA F0 A3 10 10 36 81 80 3F D6 0D FE EE 2B CD 9E
0080 | 21 1C FB 39 6C 70 CC 5A 4F AD 1C 15 B8 E1 98 6B
0090 | C3 26 8C AC F0 94 EF 02 CC 36 D1 38 06 BA FE D2
00A0 | A6 E1 E9 29 23 E8 16 67 61 07 8F 80 48 F0 B0 54
00B0 | 07 CA 73 CA 57 FC F2 C3 87 C7 D6 A9 D0 4F 09 16
00C0 | 15 E6 D3 16 A4 CA 23 27 D5 29 16 76 B9 D3 37 F2
00D0 | 45 08 9D EF 67 A7 65 79 49 45 C3 D6 A1 D4 34 0C
00E0 | 0F 75 A4 56 B6 E3 D2 BE 45 AC 0E B9 AF 73 60 27
00F0 | 0F B3 33 2C 6A A0 C1 5F 45 15 A2 C7 E7 11 5F 69
0100 | 65 9A 3C C0 93 09 D7 17 F9 4F 95 BF 2A 53 3F 8C
0110 | 0F 9A 0F 82 19 74 87 D3 22 CC F6 8B 96 C7 D3 81
0120 | 5C CE 8D 3E 57 AE 93 AB 4E 8F 46 DF 54 83 A0 82</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010008E0814CCDE4FE2783C33149</code> <code>BFFDD430C60F74AA250418313773D421</code> <code>2DFAE2737B4F7AA9D78BCBBC303B4218</code> <code>E190598B828B243B02D3F844CF0EF247</code> <code>837DB200DAF0A310103681803FD60DFE</code> <code>EE2BCD9E211CFB396C70CC5A4FAD1C15</code> <code>B8E1986BC3268CACF094EF02CC36D138</code> <code>06BAFED2A6E1E92923E8166761078F80</code> <code>48F0B05407CA73CA57FCF2C387C7D6A9</code> <code>D04F091615E6D316A4CA2327D5291676</code> <code>B9D337F245089DEF67A765794945C3D6</code> <code>A1D4340C0F75A456B6E3D2BE45AC0EB9</code> <code>AF7360270FB3332C6AA0C15F4515A2C7</code> <code>E7115F69659A3CC09309D717F94F95BF</code> <code>2A533F8C0F9A0F82197487D322CCF68B</code> <code>96C7D3815CCE8D3E57AE93AB4E8F46DF</code><br> <code>5483A082</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366D943A3CFF05DDED84CBDB5C9730093EEDBA29FC9E2110692561C3C74948FE1DE0000000000000000FE00010008E0814CCDE4FE2783C33149BFFDD430C60F74AA250418313773D4212DFAE2737B4F7AA9D78BCBBC303B4218E190598B828B243B02D3F844CF0EF247837DB200DAF0A310103681803FD60DFEEE2BCD9E211CFB396C70CC5A4FAD1C15B8E1986BC3268CACF094EF02CC36D13806BAFED2A6E1E92923E8166761078F8048F0B05407CA73CA57FCF2C387C7D6A9D04F091615E6D316A4CA2327D5291676B9D337F245089DEF67A765794945C3D6A1D4340C0F75A456B6E3D2BE45AC0EB9AF7360270FB3332C6AA0C15F4515A2C7E7115F69659A3CC09309D717F94F95BF2A533F8C0F9A0F82197487D322CCF68B96C7D3815CCE8D3E57AE93AB4E8F46DF5483A082
padding = 50F9935FE93EF34881CD7273
tmp_aes_key = 2FFA7A8B9C004E2428EDF3C965734A2180488F7E392040057C4EB60FE2805C61
tmp_aes_iv = 038D0785056EC5DBBCC8FB4CE5CC75F6DF508A3F20C99FD90C106AAF4666D8D8</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 15C289970C2C7C0FC0B6569A788D5061C96891158EBFDE11CE28A0A90DAD574D113EBBEC68BBCF549EC8E9FBA992238903D1F3F57338491AEEBC98C0C8902863F89FD96A83F551BC54D2985E79BE7232415E516D5DC7368FFA5BC882ABDA8610109BCDACCC0674BA519B11DA151E7C23823B3C5B55ECD3EE5E8FB53B4E3624F56991C8F66F52BB0420B356AE65EA8B17A33C98DE2DA9B272B766CEDD559FBAB202873F5750E4F2498FB120B1A4E95D6460FD7A475A74EA2843133F8F27D959A5947352D25437A44EF396D31CCA7B4BA5CF1977743F7A636A80A4CF4D8047D2335B2FC41CDA4B856FA020C77A53C3FC6E392CDE6976E2879966E27C21D338493568D300CAEAC3024A879388ADFA6EE8B0E090FC2A19C1E609B7584BC9062EA2E8AC386C067AE33DDE568601067B33A6D776D2E6E7C7A1E12FC2D9FD5198337EBC17C2B6EC27A672E1E18D13BDE5D4D654</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 8C 27 0D 00 F2 20 A9 66
0010 | 78 01 00 00 1F 5F 04 F5 D9 43 A3 CF F0 5D DE D8
0020 | 4C BD B5 C9 73 00 93 EE DB A2 9F C9 E2 11 06 92
0030 | 56 1C 3C 74 94 8F E1 DE FE 50 01 00 15 C2 89 97
0040 | 0C 2C 7C 0F C0 B6 56 9A 78 8D 50 61 C9 68 91 15
0050 | 8E BF DE 11 CE 28 A0 A9 0D AD 57 4D 11 3E BB EC
0060 | 68 BB CF 54 9E C8 E9 FB A9 92 23 89 03 D1 F3 F5
0070 | 73 38 49 1A EE BC 98 C0 C8 90 28 63 F8 9F D9 6A
0080 | 83 F5 51 BC 54 D2 98 5E 79 BE 72 32 41 5E 51 6D
0090 | 5D C7 36 8F FA 5B C8 82 AB DA 86 10 10 9B CD AC
00A0 | CC 06 74 BA 51 9B 11 DA 15 1E 7C 23 82 3B 3C 5B
00B0 | 55 EC D3 EE 5E 8F B5 3B 4E 36 24 F5 69 91 C8 F6
00C0 | 6F 52 BB 04 20 B3 56 AE 65 EA 8B 17 A3 3C 98 DE
00D0 | 2D A9 B2 72 B7 66 CE DD 55 9F BA B2 02 87 3F 57
00E0 | 50 E4 F2 49 8F B1 20 B1 A4 E9 5D 64 60 FD 7A 47
00F0 | 5A 74 EA 28 43 13 3F 8F 27 D9 59 A5 94 73 52 D2
0100 | 54 37 A4 4E F3 96 D3 1C CA 7B 4B A5 CF 19 77 74
0110 | 3F 7A 63 6A 80 A4 CF 4D 80 47 D2 33 5B 2F C4 1C
0120 | DA 4B 85 6F A0 20 C7 7A 53 C3 FC 6E 39 2C DE 69
0130 | 76 E2 87 99 66 E2 7C 21 D3 38 49 35 68 D3 00 CA
0140 | EA C3 02 4A 87 93 88 AD FA 6E E8 B0 E0 90 FC 2A
0150 | 19 C1 E6 09 B7 58 4B C9 06 2E A2 E8 AC 38 6C 06
0160 | 7A E3 3D DE 56 86 01 06 7B 33 A6 D7 76 D2 E6 E7
0170 | C7 A1 E1 2F C2 D9 FD 51 98 33 7E BC 17 C2 B6 EC
0180 | 27 A6 72 E1 E1 8D 13 BD E5 D4 D6 54</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>8C270D00F220A966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010015C289970C2C7C0FC0B6569A</code> <code>788D5061C96891158EBFDE11CE28A0A9</code> <code>0DAD574D113EBBEC68BBCF549EC8E9FB</code> <code>A992238903D1F3F57338491AEEBC98C0</code> <code>C8902863F89FD96A83F551BC54D2985E</code> <code>79BE7232415E516D5DC7368FFA5BC882</code> <code>ABDA8610109BCDACCC0674BA519B11DA</code> <code>151E7C23823B3C5B55ECD3EE5E8FB53B</code> <code>4E3624F56991C8F66F52BB0420B356AE</code> <code>65EA8B17A33C98DE2DA9B272B766CEDD</code> <code>559FBAB202873F5750E4F2498FB120B1</code> <code>A4E95D6460FD7A475A74EA2843133F8F</code> <code>27D959A5947352D25437A44EF396D31C</code> <code>CA7B4BA5CF1977743F7A636A80A4CF4D</code> <code>8047D2335B2FC41CDA4B856FA020C77A</code> <code>53C3FC6E392CDE6976E2879966E27C21</code> <code>D338493568D300CAEAC3024A879388AD</code> <code>FA6EE8B0E090FC2A19C1E609B7584BC9</code> <code>062EA2E8AC386C067AE33DDE56860106</code> <code>7B33A6D776D2E6E7C7A1E12FC2D9FD51</code> <code>98337EBC17C2B6EC27A672E1E18D13BD</code><br> <code>E5D4D654</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = B49B8DB57B5F89BBFF49A1396D27B4093716EAECC0969D0ABF7F8B430A10DE773CDFD9F2D3B80DF78B52A0750A25A7CF1C35EED3D93BEBC6327F716B9918AA07F3CD5A135AD95CF280783362AEC18A85CF537BCE4A4AE6869D5422DC0EEDDE854778125D7FFAA77296D25F467E987E72E84F1F14CFA13241FB86D89660BB23E6657FE85216F1012BEBE153ED321A3549863204F5059D5E3393C37E76C5AA602A6A7585E42C92E474D80A51CA5C0E89DB7F1C4CEC933C0294451B9EF962BB07F59128D3F6BC718CA4BF76E96D5A0C814756A3249B546A104619C63B6D7D5730DF4F7DF6EE1143B6B29ED0ABFA26CE0FDA5418852988E968864B903B7C91F56904</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 9C 06 FF F3 20 A9 66
0010 | A4 00 00 00 34 F7 CB 3B D9 43 A3 CF F0 5D DE D8
0020 | 4C BD B5 C9 73 00 93 EE DB A2 9F C9 E2 11 06 92
0030 | 56 1C 3C 74 94 8F E1 DE F5 FD F3 E3 EA 95 15 FD
0040 | 71 F1 06 28 13 46 38 05</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019C06FFF320A966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A4000000</code> (164 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D943A3CFF05DDED84CBDB5C9730093EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DBA29FC9E2110692561C3C74948FE1DE</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>F5FDF3E3EA9515FD71F1062813463805</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

