<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 20 7D 03 00 4C 9F C1 68
0010 | 14 00 00 00 F1 8E 7E BE 10 81 E2 53 9C 54 7C 0D
0020 | E6 9F B8 7B 55 06 C0 18</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>207D03004C9FC168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 44 ED AF 4C 9F C1 68
0010 | 50 00 00 00 63 24 16 05 10 81 E2 53 9C 54 7C 0D
0020 | E6 9F B8 7B 55 06 C0 18 8E 48 15 07 7E 54 B2 6D
0030 | AE 02 00 A2 8B 0C DA A7 08 1B 14 4D 84 04 D8 FD
0040 | 17 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0144EDAF4C9FC168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081B144D8404D8FD17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1951269767970618647</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1951269767970618647</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1951269767970618647 = 1189389323 * 1640564389</code></p>
<pre><code>p = 1189389323
q = 1640564389</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1B 14 4D 84 04 D8 FD 17 00 00 00
0010 | 04 46 E4 A4 0B 00 00 00 04 61 C9 06 A5 00 00 00
0020 | 10 81 E2 53 9C 54 7C 0D E6 9F B8 7B 55 06 C0 18
0030 | 8E 48 15 07 7E 54 B2 6D AE 02 00 A2 8B 0C DA A7
0040 | AC A4 E2 CA 36 6B BF 7D 4A CC 49 1C 6B 1A 7D A4
0050 | CC 4E 22 2A 68 C4 77 70 91 5F 87 06 23 84 0D 5C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081B144D8404D8FD17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1951269767970618647</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0446E4A40B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1189389323</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0461C906A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1640564389</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>ACA4E2CA366BBF7D4ACC491C6B1A7DA4</code> <code>CC4E222A68C47770915F870623840D5C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081B144D8404D8FD170000000446E4A40B0000000461C906A50000001081E2539C547C0DE69FB87B5506C0188E4815077E54B26DAE0200A28B0CDAA7ACA4E2CA366BBF7D4ACC491C6B1A7DA4CC4E222A68C47770915F870623840D5C02000000
random_padding_bytes = 017D29F2C98B1F09AE61BF2B26381C22580B5270F70596B8DB8A0C80221216C0F26EE24D4C6AFF6507E443D9480129D22638F8B4DA11672D09D665AC64C4768B0F7197C808C8A3EBD2DC9759281BBBB6AE709EF9E2848B08EB39B9FC</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = C67FDCA50D99CC70D4CD81363DC38C7E51044A790B770029C8F33BE49052597A8911C73336F36B31D495DCB05761B44E32833E74A83AD015514FF265486B68EAA2B704F8829B252EF96D041DC247D60D157D3D66AEE5547CC6F9984BDEED0851BA6A5D6E3BF9998E8B89069631400C2E51F594D7C67F3AB9F9E0B632F8B09D8E084A6CA2BE05391803782994D6E2E455C93AC3AC5460CA11EE6AEBD29B9D1977D977D612C3A9A4215B9307D593E301D8F73DADB93FE0AB1F2F0D3CBED10398D8675815F4FFE12F5489E6AA3246BBA0D6C933C6E0A93BA8AFE31014F2C484416C7E6CC82473277B65F8FB611A0EC1F34BEB77ACC742ADD1AAA548129B7160EC7B</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 2C 0C 00 4C 9F C1 68
0010 | 40 01 00 00 BE E4 12 D7 10 81 E2 53 9C 54 7C 0D
0020 | E6 9F B8 7B 55 06 C0 18 8E 48 15 07 7E 54 B2 6D
0030 | AE 02 00 A2 8B 0C DA A7 04 46 E4 A4 0B 00 00 00
0040 | 04 61 C9 06 A5 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 C6 7F DC A5 0D 99 CC 70 D4 CD 81 36
0060 | 3D C3 8C 7E 51 04 4A 79 0B 77 00 29 C8 F3 3B E4
0070 | 90 52 59 7A 89 11 C7 33 36 F3 6B 31 D4 95 DC B0
0080 | 57 61 B4 4E 32 83 3E 74 A8 3A D0 15 51 4F F2 65
0090 | 48 6B 68 EA A2 B7 04 F8 82 9B 25 2E F9 6D 04 1D
00A0 | C2 47 D6 0D 15 7D 3D 66 AE E5 54 7C C6 F9 98 4B
00B0 | DE ED 08 51 BA 6A 5D 6E 3B F9 99 8E 8B 89 06 96
00C0 | 31 40 0C 2E 51 F5 94 D7 C6 7F 3A B9 F9 E0 B6 32
00D0 | F8 B0 9D 8E 08 4A 6C A2 BE 05 39 18 03 78 29 94
00E0 | D6 E2 E4 55 C9 3A C3 AC 54 60 CA 11 EE 6A EB D2
00F0 | 9B 9D 19 77 D9 77 D6 12 C3 A9 A4 21 5B 93 07 D5
0100 | 93 E3 01 D8 F7 3D AD B9 3F E0 AB 1F 2F 0D 3C BE
0110 | D1 03 98 D8 67 58 15 F4 FF E1 2F 54 89 E6 AA 32
0120 | 46 BB A0 D6 C9 33 C6 E0 A9 3B A8 AF E3 10 14 F2
0130 | C4 84 41 6C 7E 6C C8 24 73 27 7B 65 F8 FB 61 1A
0140 | 0E C1 F3 4B EB 77 AC C7 42 AD D1 AA A5 48 12 9B
0150 | 71 60 EC 7B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F02C0C004C9FC168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0446E4A40B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1189389323</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0461C906A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1640564389</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100C67FDCA50D99CC70D4CD8136</code> <code>3DC38C7E51044A790B770029C8F33BE4</code> <code>9052597A8911C73336F36B31D495DCB0</code> <code>5761B44E32833E74A83AD015514FF265</code> <code>486B68EAA2B704F8829B252EF96D041D</code> <code>C247D60D157D3D66AEE5547CC6F9984B</code> <code>DEED0851BA6A5D6E3BF9998E8B890696</code> <code>31400C2E51F594D7C67F3AB9F9E0B632</code> <code>F8B09D8E084A6CA2BE05391803782994</code> <code>D6E2E455C93AC3AC5460CA11EE6AEBD2</code> <code>9B9D1977D977D612C3A9A4215B9307D5</code> <code>93E301D8F73DADB93FE0AB1F2F0D3CBE</code> <code>D10398D8675815F4FFE12F5489E6AA32</code> <code>46BBA0D6C933C6E0A93BA8AFE31014F2</code> <code>C484416C7E6CC82473277B65F8FB611A</code> <code>0EC1F34BEB77ACC742ADD1AAA548129B</code><br> <code>7160EC7B</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 FE D7 4C 9F C1 68
0010 | 78 02 00 00 5C 07 E8 D0 10 81 E2 53 9C 54 7C 0D
0020 | E6 9F B8 7B 55 06 C0 18 8E 48 15 07 7E 54 B2 6D
0030 | AE 02 00 A2 8B 0C DA A7 FE 50 02 00 D1 3B 07 71
0040 | EC A1 08 61 4F 7B DC 97 5D EA 81 79 0F C1 01 0D
0050 | EE 89 08 EA 41 FE 96 EE 1D 01 2B 2F 58 9E 69 70
0060 | DF AF 10 03 65 7C 22 A5 E2 8B E2 85 CF 94 53 87
0070 | F7 E2 74 EC 96 0B 17 92 D8 63 8E 72 8F 82 2E CB
0080 | E7 F1 A0 87 B5 74 A9 B6 C6 1B 3D 10 58 0F 24 6A
0090 | FC 0E 78 33 E6 C4 F3 28 0F FF 4E 51 2B 24 15 63
00A0 | 0E 6F 45 19 4A FC 14 4F 20 75 F3 1C 7E 32 19 33
00B0 | 3B 03 BB 80 1F C7 34 84 97 4E 42 58 59 E5 B2 6B
00C0 | 07 4F F2 83 65 6B FF 88 C8 89 72 F9 BF 74 1E FB
00D0 | 0C 93 57 8E B7 CA 30 1D E2 3D FA 6E AD B4 FB E6
00E0 | 59 6E 77 82 8A 03 41 57 C8 1A 08 EA 75 B6 8A A4
00F0 | 95 BF 46 8F 96 B4 84 C3 F1 3F E4 28 8F FD F7 73
0100 | 57 21 69 E7 68 45 E5 A3 AC 5A FA 44 2B 0F 8E 21
0110 | 0D CC 1A 83 E3 AB 29 D9 9A EA A7 63 98 E9 01 DD
0120 | D0 E7 C8 CF 5A 78 79 DE 9C 8A 2E AC 3C CF 38 37
0130 | 2A 28 D0 2B 80 65 1D 63 8D 93 97 AF E1 B9 5E 9C
0140 | B8 E5 74 F9 4D 5E 42 EC 52 FD 3E DB 4F 44 62 FD
0150 | 66 8E 1C 19 1B AB 6A 18 98 5E 42 5B D9 14 04 A9
0160 | 83 4F 02 14 2F BD 11 21 12 42 61 DF 13 B0 A6 67
0170 | E5 0B 56 D1 D2 50 E1 6F 9A DC 6A BD A2 46 61 BE
0180 | C9 1B 42 29 C5 C2 1D 4E EA 5F 7A F2 22 D0 58 2A
0190 | C2 CA 99 62 9A 53 B2 8D 87 C7 87 E9 37 AB 74 FC
01A0 | B9 F0 AD D5 8A 44 97 A9 2C 26 B3 84 08 E7 A9 4D
01B0 | 94 F5 B9 33 5A C9 3B 29 4A FE 97 83 C6 4D 53 C5
01C0 | 68 B8 2D 41 CC 65 AB 1F 9C 93 54 3D C1 55 98 31
01D0 | 1F D8 E1 6C 0A 42 7C 25 40 C1 47 5E E1 16 19 6F
01E0 | 78 85 51 26 2D 43 B9 45 3B 27 23 EB 39 F0 D6 66
01F0 | 7B 43 28 EE 48 15 CA 4D 43 82 7F AA 4A 26 34 2B
0200 | 01 39 D1 1E 30 94 B7 30 07 92 60 CB CA 39 E8 B9
0210 | 92 C7 45 42 28 C9 78 4A F8 66 17 FC 29 6D 16 78
0220 | 4F 15 9F D6 77 DB EC D0 33 AA C6 A3 E9 2B 3D 01
0230 | E8 35 4F 3A 3B 2A 5E 28 ED E3 42 0B BF FC 6D 3D
0240 | 96 B3 04 6E FE 69 25 E8 FE 31 4F 08 5B 17 67 4C
0250 | BC 8E 67 C1 B0 B4 17 9D C2 D9 4C 76 86 7A E8 3B
0260 | F2 C3 CF 3C 3B EB ED 5C 9F 22 E7 BB FA 5F 9E 77
0270 | 9F EC 99 B0 57 76 93 1A 2F 79 2E D1 48 28 74 01
0280 | 45 C3 D0 0B 83 6B 93 BC 06 34 7C 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E8FED74C9FC168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200D13B0771ECA108614F7BDC97</code> <code>5DEA81790FC1010DEE8908EA41FE96EE</code> <code>1D012B2F589E6970DFAF1003657C22A5</code> <code>E28BE285CF945387F7E274EC960B1792</code> <code>D8638E728F822ECBE7F1A087B574A9B6</code> <code>C61B3D10580F246AFC0E7833E6C4F328</code> <code>0FFF4E512B2415630E6F45194AFC144F</code> <code>2075F31C7E3219333B03BB801FC73484</code> <code>974E425859E5B26B074FF283656BFF88</code> <code>C88972F9BF741EFB0C93578EB7CA301D</code> <code>E23DFA6EADB4FBE6596E77828A034157</code> <code>C81A08EA75B68AA495BF468F96B484C3</code> <code>F13FE4288FFDF773572169E76845E5A3</code> <code>AC5AFA442B0F8E210DCC1A83E3AB29D9</code> <code>9AEAA76398E901DDD0E7C8CF5A7879DE</code> <code>9C8A2EAC3CCF38372A28D02B80651D63</code> <code>8D9397AFE1B95E9CB8E574F94D5E42EC</code> <code>52FD3EDB4F4462FD668E1C191BAB6A18</code> <code>985E425BD91404A9834F02142FBD1121</code> <code>124261DF13B0A667E50B56D1D250E16F</code> <code>9ADC6ABDA24661BEC91B4229C5C21D4E</code> <code>EA5F7AF222D0582AC2CA99629A53B28D</code> <code>87C787E937AB74FCB9F0ADD58A4497A9</code> <code>2C26B38408E7A94D94F5B9335AC93B29</code> <code>4AFE9783C64D53C568B82D41CC65AB1F</code> <code>9C93543DC15598311FD8E16C0A427C25</code> <code>40C1475EE116196F788551262D43B945</code> <code>3B2723EB39F0D6667B4328EE4815CA4D</code> <code>43827FAA4A26342B0139D11E3094B730</code> <code>079260CBCA39E8B992C7454228C9784A</code> <code>F86617FC296D16784F159FD677DBECD0</code> <code>33AAC6A3E92B3D01E8354F3A3B2A5E28</code> <code>EDE3420BBFFC6D3D96B3046EFE6925E8</code> <code>FE314F085B17674CBC8E67C1B0B4179D</code> <code>C2D94C76867AE83BF2C3CF3C3BEBED5C</code> <code>9F22E7BBFA5F9E779FEC99B05776931A</code> <code>2F792ED14828740145C3D00B836B93BC</code><br> <code>06347C45</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = D13B0771ECA108614F7BDC975DEA81790FC1010DEE8908EA41FE96EE1D012B2F589E6970DFAF1003657C22A5E28BE285CF945387F7E274EC960B1792D8638E728F822ECBE7F1A087B574A9B6C61B3D10580F246AFC0E7833E6C4F3280FFF4E512B2415630E6F45194AFC144F2075F31C7E3219333B03BB801FC73484974E425859E5B26B074FF283656BFF88C88972F9BF741EFB0C93578EB7CA301DE23DFA6EADB4FBE6596E77828A034157C81A08EA75B68AA495BF468F96B484C3F13FE4288FFDF773572169E76845E5A3AC5AFA442B0F8E210DCC1A83E3AB29D99AEAA76398E901DDD0E7C8CF5A7879DE9C8A2EAC3CCF38372A28D02B80651D638D9397AFE1B95E9CB8E574F94D5E42EC52FD3EDB4F4462FD668E1C191BAB6A18985E425BD91404A9834F02142FBD1121124261DF13B0A667E50B56D1D250E16F9ADC6ABDA24661BEC91B4229C5C21D4EEA5F7AF222D0582AC2CA99629A53B28D87C787E937AB74FCB9F0ADD58A4497A92C26B38408E7A94D94F5B9335AC93B294AFE9783C64D53C568B82D41CC65AB1F9C93543DC15598311FD8E16C0A427C2540C1475EE116196F788551262D43B9453B2723EB39F0D6667B4328EE4815CA4D43827FAA4A26342B0139D11E3094B730079260CBCA39E8B992C7454228C9784AF86617FC296D16784F159FD677DBECD033AAC6A3E92B3D01E8354F3A3B2A5E28EDE3420BBFFC6D3D96B3046EFE6925E8FE314F085B17674CBC8E67C1B0B4179DC2D94C76867AE83BF2C3CF3C3BEBED5C9F22E7BBFA5F9E779FEC99B05776931A2F792ED14828740145C3D00B836B93BC06347C45
tmp_aes_key = EAD68191C418055464F2592F2798890C43E8298F3637E38843E161239B5CFF63
tmp_aes_iv = 8B310AE1104667E81CC742B69840F7F4C6AE8994CAAE7EE7096E9BDDACA4E2CA</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = CC5CFCCC7483EFBDB7CFBAD24BA42230850EEC3ABA0D89B51081E2539C547C0DE69FB87B5506C0188E4815077E54B26DAE0200A28B0CDAA703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009E69020CB234320156C55C6E01A245C1699CB473568BE0FC7CCAD4F253BB8A9ED34262F01B2DF44F7DA89031F654A09F5CF3B9D4CC06A52367BAFDC39274AECD180878B65A841A0B68C2011CC915E6737C123E0E39B3CA91ADCFE9AEA351F82EDFF626F16A353AE691FE2B4635EB94C67BEA1CC938C52FBC943F98CDC03FD2258D4250B2AA5C750097F15E2E2255787350F910442A62442B09998DD827E811C971528D1B89022157627B819687CED17EC3ABFD9D5FEAB6A80A7E4E3FA740FB2F40CEABA6ED2B44AD04E313154C4E470151C8DFFE3A43CF06E9D8DA3084455CCF9054A8C4F082FCFE584B595F0E1488247A54E3D1C53782A33B71909283209C794C9FC16874BFC210CF5E168F
answer = BA0D89B51081E2539C547C0DE69FB87B5506C0188E4815077E54B26DAE0200A28B0CDAA703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009E69020CB234320156C55C6E01A245C1699CB473568BE0FC7CCAD4F253BB8A9ED34262F01B2DF44F7DA89031F654A09F5CF3B9D4CC06A52367BAFDC39274AECD180878B65A841A0B68C2011CC915E6737C123E0E39B3CA91ADCFE9AEA351F82EDFF626F16A353AE691FE2B4635EB94C67BEA1CC938C52FBC943F98CDC03FD2258D4250B2AA5C750097F15E2E2255787350F910442A62442B09998DD827E811C971528D1B89022157627B819687CED17EC3ABFD9D5FEAB6A80A7E4E3FA740FB2F40CEABA6ED2B44AD04E313154C4E470151C8DFFE3A43CF06E9D8DA3084455CCF9054A8C4F082FCFE584B595F0E1488247A54E3D1C53782A33B71909283209C794C9FC16874BFC210CF5E168F</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 10 81 E2 53 9C 54 7C 0D E6 9F B8 7B
0010 | 55 06 C0 18 8E 48 15 07 7E 54 B2 6D AE 02 00 A2
0020 | 8B 0C DA A7 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 9E 69 02 0C B2 34 32 01 56 C5 5C 6E 01 A2 45 C1
0140 | 69 9C B4 73 56 8B E0 FC 7C CA D4 F2 53 BB 8A 9E
0150 | D3 42 62 F0 1B 2D F4 4F 7D A8 90 31 F6 54 A0 9F
0160 | 5C F3 B9 D4 CC 06 A5 23 67 BA FD C3 92 74 AE CD
0170 | 18 08 78 B6 5A 84 1A 0B 68 C2 01 1C C9 15 E6 73
0180 | 7C 12 3E 0E 39 B3 CA 91 AD CF E9 AE A3 51 F8 2E
0190 | DF F6 26 F1 6A 35 3A E6 91 FE 2B 46 35 EB 94 C6
01A0 | 7B EA 1C C9 38 C5 2F BC 94 3F 98 CD C0 3F D2 25
01B0 | 8D 42 50 B2 AA 5C 75 00 97 F1 5E 2E 22 55 78 73
01C0 | 50 F9 10 44 2A 62 44 2B 09 99 8D D8 27 E8 11 C9
01D0 | 71 52 8D 1B 89 02 21 57 62 7B 81 96 87 CE D1 7E
01E0 | C3 AB FD 9D 5F EA B6 A8 0A 7E 4E 3F A7 40 FB 2F
01F0 | 40 CE AB A6 ED 2B 44 AD 04 E3 13 15 4C 4E 47 01
0200 | 51 C8 DF FE 3A 43 CF 06 E9 D8 DA 30 84 45 5C CF
0210 | 90 54 A8 C4 F0 82 FC FE 58 4B 59 5F 0E 14 88 24
0220 | 7A 54 E3 D1 C5 37 82 A3 3B 71 90 92 83 20 9C 79
0230 | 4C 9F C1 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001009E69020CB234320156C55C6E</code> <code>01A245C1699CB473568BE0FC7CCAD4F2</code> <code>53BB8A9ED34262F01B2DF44F7DA89031</code> <code>F654A09F5CF3B9D4CC06A52367BAFDC3</code> <code>9274AECD180878B65A841A0B68C2011C</code> <code>C915E6737C123E0E39B3CA91ADCFE9AE</code> <code>A351F82EDFF626F16A353AE691FE2B46</code> <code>35EB94C67BEA1CC938C52FBC943F98CD</code> <code>C03FD2258D4250B2AA5C750097F15E2E</code> <code>2255787350F910442A62442B09998DD8</code> <code>27E811C971528D1B89022157627B8196</code> <code>87CED17EC3ABFD9D5FEAB6A80A7E4E3F</code> <code>A740FB2F40CEABA6ED2B44AD04E31315</code> <code>4C4E470151C8DFFE3A43CF06E9D8DA30</code> <code>84455CCF9054A8C4F082FCFE584B595F</code> <code>0E1488247A54E3D1C53782A33B719092</code><br> <code>83209C79</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>4C9FC168</code> (1757519692 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 799178CC9D5DB6DE687465F42A21087860587F3A77222EC60C4C62BA59FE09DD69231771B880D75B5126927D9B79E211168DF79BE6EDF0D4BB377A8C29826DED2BCEC8DD5A24A555C22C7BD372F86B2F986EBAD794E23728554DBD5478AC07698620CB5672756A2964EECEC757A1ECC2BB6198C3ED798839156CF07C7BB116D2BFFAC2C7E05D9F22386391648DE7D84771FDC1D33F5411F42971F0FB166FFEABBBFD88969CA20194018DAF3AE1FF6E63998749EF03172D24F77C5D44BE4E44D8A3C3FEF795773F99513622319E6B8DA69DEE24FAB4732A5E48E420C8AB3FB27EEE75E22DE6A64EC64EDD89EA2A2D9E06FDE998AC36BFF1006E579A6CDA99B44B</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 2E0AD3E117FEB8474C8939E8F6C12375D00941B0066271D1DED08A79490F64B9A9DF21E9F6F617808A72335D97629B70C8E81E41BE183B7EDAE7C500B995545F29B5FB769D41BE78CBB099D4C7BFC93992AC2D6F6534B76DF51DC738B350B71FCE31D5BCB26121490F130C498BEF6800BA14043A1E0A46DBAD367B4CC4C12E38237B79F567CD434EB8448ED94BDF5E8812B69FF4793AE69309617F2D5EC7ACC3CA780A23F8E92A1150CA2F69D5E49AA00AB413330069FFF0E92F8184D5C3B2DAD46626329875D4C0066E0A164A8DB9C417F7C9CF5959D51D5872B0F8EA81B8326CDE7D225C853D0E66B4F862F963DA0D959129C34310EA0C8FFFBCAE191CFF29</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 10 81 E2 53 9C 54 7C 0D E6 9F B8 7B
0010 | 55 06 C0 18 8E 48 15 07 7E 54 B2 6D AE 02 00 A2
0020 | 8B 0C DA A7 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 2E 0A D3 E1 17 FE B8 47 4C 89 39 E8 F6 C1 23 75
0040 | D0 09 41 B0 06 62 71 D1 DE D0 8A 79 49 0F 64 B9
0050 | A9 DF 21 E9 F6 F6 17 80 8A 72 33 5D 97 62 9B 70
0060 | C8 E8 1E 41 BE 18 3B 7E DA E7 C5 00 B9 95 54 5F
0070 | 29 B5 FB 76 9D 41 BE 78 CB B0 99 D4 C7 BF C9 39
0080 | 92 AC 2D 6F 65 34 B7 6D F5 1D C7 38 B3 50 B7 1F
0090 | CE 31 D5 BC B2 61 21 49 0F 13 0C 49 8B EF 68 00
00A0 | BA 14 04 3A 1E 0A 46 DB AD 36 7B 4C C4 C1 2E 38
00B0 | 23 7B 79 F5 67 CD 43 4E B8 44 8E D9 4B DF 5E 88
00C0 | 12 B6 9F F4 79 3A E6 93 09 61 7F 2D 5E C7 AC C3
00D0 | CA 78 0A 23 F8 E9 2A 11 50 CA 2F 69 D5 E4 9A A0
00E0 | 0A B4 13 33 00 69 FF F0 E9 2F 81 84 D5 C3 B2 DA
00F0 | D4 66 26 32 98 75 D4 C0 06 6E 0A 16 4A 8D B9 C4
0100 | 17 F7 C9 CF 59 59 D5 1D 58 72 B0 F8 EA 81 B8 32
0110 | 6C DE 7D 22 5C 85 3D 0E 66 B4 F8 62 F9 63 DA 0D
0120 | 95 91 29 C3 43 10 EA 0C 8F FF BC AE 19 1C FF 29</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001002E0AD3E117FEB8474C8939E8</code> <code>F6C12375D00941B0066271D1DED08A79</code> <code>490F64B9A9DF21E9F6F617808A72335D</code> <code>97629B70C8E81E41BE183B7EDAE7C500</code> <code>B995545F29B5FB769D41BE78CBB099D4</code> <code>C7BFC93992AC2D6F6534B76DF51DC738</code> <code>B350B71FCE31D5BCB26121490F130C49</code> <code>8BEF6800BA14043A1E0A46DBAD367B4C</code> <code>C4C12E38237B79F567CD434EB8448ED9</code> <code>4BDF5E8812B69FF4793AE69309617F2D</code> <code>5EC7ACC3CA780A23F8E92A1150CA2F69</code> <code>D5E49AA00AB413330069FFF0E92F8184</code> <code>D5C3B2DAD46626329875D4C0066E0A16</code> <code>4A8DB9C417F7C9CF5959D51D5872B0F8</code> <code>EA81B8326CDE7D225C853D0E66B4F862</code> <code>F963DA0D959129C34310EA0C8FFFBCAE</code><br> <code>191CFF29</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643661081E2539C547C0DE69FB87B5506C0188E4815077E54B26DAE0200A28B0CDAA70000000000000000FE0001002E0AD3E117FEB8474C8939E8F6C12375D00941B0066271D1DED08A79490F64B9A9DF21E9F6F617808A72335D97629B70C8E81E41BE183B7EDAE7C500B995545F29B5FB769D41BE78CBB099D4C7BFC93992AC2D6F6534B76DF51DC738B350B71FCE31D5BCB26121490F130C498BEF6800BA14043A1E0A46DBAD367B4CC4C12E38237B79F567CD434EB8448ED94BDF5E8812B69FF4793AE69309617F2D5EC7ACC3CA780A23F8E92A1150CA2F69D5E49AA00AB413330069FFF0E92F8184D5C3B2DAD46626329875D4C0066E0A164A8DB9C417F7C9CF5959D51D5872B0F8EA81B8326CDE7D225C853D0E66B4F862F963DA0D959129C34310EA0C8FFFBCAE191CFF29
padding = 5660B05E453AC4A6121D42CB
tmp_aes_key = EAD68191C418055464F2592F2798890C43E8298F3637E38843E161239B5CFF63
tmp_aes_iv = 8B310AE1104667E81CC742B69840F7F4C6AE8994CAAE7EE7096E9BDDACA4E2CA</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 08835DDB4E14EFB2AB4166506CCD05C184C911092C8FBDE9A543226C69ED371D819FDBC4A14F056A7890A86BB2363F52D599D8535357050C9E14914EF39F5766A07259169C40C44B31B3602DD3C759FF16E0110B51650CE91375BE22DBE4C9A732111D6C37E816AF97C22AD2BF4AD4E8437EB59FBF4ABE8DE03C086D3D86BA899863DAC5CF139E2548CBF3B314F074F6BAAB8C4321FE4D27D036750229549E6850A15D55A93E2CC3F1BAFCFC8D14CD2B76E1E534F4B3DECBFEBB9CEFF00AE2E7B1DC549DDE2AD6122D9450CC4E1A6FC40C048A28DA7BD750FF55310053286119E629A969901FC1411F78E1F866BFC8C46D882093D812C4D36496AE4551839CD434F2A1B9FC7156D3D1456B30051AAC7DEB2C5E608B2AB7788961158F9F70718DB83287368C8BC23D0536153AA0031DC80BE1039F8DCD0BBC0394D5B256A3A3023D13E8EEA9BE062A292CFC573A62080E</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F4 2C 0C 00 4C 9F C1 68
0010 | 78 01 00 00 1F 5F 04 F5 10 81 E2 53 9C 54 7C 0D
0020 | E6 9F B8 7B 55 06 C0 18 8E 48 15 07 7E 54 B2 6D
0030 | AE 02 00 A2 8B 0C DA A7 FE 50 01 00 08 83 5D DB
0040 | 4E 14 EF B2 AB 41 66 50 6C CD 05 C1 84 C9 11 09
0050 | 2C 8F BD E9 A5 43 22 6C 69 ED 37 1D 81 9F DB C4
0060 | A1 4F 05 6A 78 90 A8 6B B2 36 3F 52 D5 99 D8 53
0070 | 53 57 05 0C 9E 14 91 4E F3 9F 57 66 A0 72 59 16
0080 | 9C 40 C4 4B 31 B3 60 2D D3 C7 59 FF 16 E0 11 0B
0090 | 51 65 0C E9 13 75 BE 22 DB E4 C9 A7 32 11 1D 6C
00A0 | 37 E8 16 AF 97 C2 2A D2 BF 4A D4 E8 43 7E B5 9F
00B0 | BF 4A BE 8D E0 3C 08 6D 3D 86 BA 89 98 63 DA C5
00C0 | CF 13 9E 25 48 CB F3 B3 14 F0 74 F6 BA AB 8C 43
00D0 | 21 FE 4D 27 D0 36 75 02 29 54 9E 68 50 A1 5D 55
00E0 | A9 3E 2C C3 F1 BA FC FC 8D 14 CD 2B 76 E1 E5 34
00F0 | F4 B3 DE CB FE BB 9C EF F0 0A E2 E7 B1 DC 54 9D
0100 | DE 2A D6 12 2D 94 50 CC 4E 1A 6F C4 0C 04 8A 28
0110 | DA 7B D7 50 FF 55 31 00 53 28 61 19 E6 29 A9 69
0120 | 90 1F C1 41 1F 78 E1 F8 66 BF C8 C4 6D 88 20 93
0130 | D8 12 C4 D3 64 96 AE 45 51 83 9C D4 34 F2 A1 B9
0140 | FC 71 56 D3 D1 45 6B 30 05 1A AC 7D EB 2C 5E 60
0150 | 8B 2A B7 78 89 61 15 8F 9F 70 71 8D B8 32 87 36
0160 | 8C 8B C2 3D 05 36 15 3A A0 03 1D C8 0B E1 03 9F
0170 | 8D CD 0B BC 03 94 D5 B2 56 A3 A3 02 3D 13 E8 EE
0180 | A9 BE 06 2A 29 2C FC 57 3A 62 08 0E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F42C0C004C9FC168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010008835DDB4E14EFB2AB416650</code> <code>6CCD05C184C911092C8FBDE9A543226C</code> <code>69ED371D819FDBC4A14F056A7890A86B</code> <code>B2363F52D599D8535357050C9E14914E</code> <code>F39F5766A07259169C40C44B31B3602D</code> <code>D3C759FF16E0110B51650CE91375BE22</code> <code>DBE4C9A732111D6C37E816AF97C22AD2</code> <code>BF4AD4E8437EB59FBF4ABE8DE03C086D</code> <code>3D86BA899863DAC5CF139E2548CBF3B3</code> <code>14F074F6BAAB8C4321FE4D27D0367502</code> <code>29549E6850A15D55A93E2CC3F1BAFCFC</code> <code>8D14CD2B76E1E534F4B3DECBFEBB9CEF</code> <code>F00AE2E7B1DC549DDE2AD6122D9450CC</code> <code>4E1A6FC40C048A28DA7BD750FF553100</code> <code>53286119E629A969901FC1411F78E1F8</code> <code>66BFC8C46D882093D812C4D36496AE45</code> <code>51839CD434F2A1B9FC7156D3D1456B30</code> <code>051AAC7DEB2C5E608B2AB7788961158F</code> <code>9F70718DB83287368C8BC23D0536153A</code> <code>A0031DC80BE1039F8DCD0BBC0394D5B2</code> <code>56A3A3023D13E8EEA9BE062A292CFC57</code><br> <code>3A62080E</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = A54488452DC5CBB0F949BBAAAAF3DDD338802B1121D57189686FD283B32B8087E582F277BD3ADB9BA792CE6EA99CDE9E0EEE07292440C562973CB7F20DA83F9895E52ACF271B84B8EDF44703665D8467ACD49C6CC4992D81BF7B87606FDF2C4AB911F67817285DFB03810FE1964CA6ED46E18ED37284F4356DED90031DEFAAE1A8811A3730AAA45255B1FD560D725068D2C045D743FB400E9FA79B1FA687E5AE3C90D81CDDF050D93C18B8FBF2FCF9114B6691A9F16A6406AD627B3711399395953AAE8A1FD4E0E760BDA68263A2A25DA51751E011B14CAD0EF528AB70FA2D0D707CAB79A916E623E32009FB519D374A53EF9CC18AD9C3DA1DC1588403CC0236</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 84 AA 12 4E 9F C1 68
0010 | 34 00 00 00 34 F7 CB 3B 10 81 E2 53 9C 54 7C 0D
0020 | E6 9F B8 7B 55 06 C0 18 8E 48 15 07 7E 54 B2 6D
0030 | AE 02 00 A2 8B 0C DA A7 E4 39 44 72 3A 41 DE 10
0040 | E8 DF 66 D4 76 20 A4 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0184AA124E9FC168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1081E2539C547C0DE69FB87B5506C018</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8E4815077E54B26DAE0200A28B0CDAA7</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>E43944723A41DE10E8DF66D47620A465</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

