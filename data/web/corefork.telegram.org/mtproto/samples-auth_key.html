<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 28 1E 0B 00 6F 7E A2 66
0010 | 14 00 00 00 F1 8E 7E BE 92 63 8E CF 53 C6 21 AC
0020 | 5A 56 9F A7 D8 24 8D D2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>281E0B006F7EA266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 04 D5 D9 6F 7E A2 66
0010 | BC 00 00 00 63 24 16 05 92 63 8E CF 53 C6 21 AC
0020 | 5A 56 9F A7 D8 24 8D D2 81 32 9E 3B 6E D3 C9 C1
0030 | 4C F7 5A 8A 5D 4F 9E 5C 08 10 69 D1 E8 78 0E 37
0040 | 25 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0104D5D96F7EA266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC000000</code> (188 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081069D1E8780E3725000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1182707173538281253</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1182707173538281253</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1182707173538281253 = 1078298003 * 1096827751</code></p>
<pre><code>p = 1078298003
q = 1096827751</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 10 69 D1 E8 78 0E 37 25 00 00 00
0010 | 04 40 45 85 93 00 00 00 04 41 60 43 67 00 00 00
0020 | 92 63 8E CF 53 C6 21 AC 5A 56 9F A7 D8 24 8D D2
0030 | 81 32 9E 3B 6E D3 C9 C1 4C F7 5A 8A 5D 4F 9E 5C
0040 | 38 DD 22 3E CA ED DA E7 C5 BB FA 37 3B 0E BB 43
0050 | 1E 09 F4 94 D6 DF BC DC DF 42 A4 B7 9A E8 53 5D
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081069D1E8780E3725000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1182707173538281253</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0440458593000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1078298003</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0441604367000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1096827751</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>38DD223ECAEDDAE7C5BBFA373B0EBB43</code> <code>1E09F494D6DFBCDCDF42A4B79AE8535D</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081069D1E8780E37250000000440458593000000044160436700000092638ECF53C621AC5A569FA7D8248DD281329E3B6ED3C9C14CF75A8A5D4F9E5C38DD223ECAEDDAE7C5BBFA373B0EBB431E09F494D6DFBCDCDF42A4B79AE8535D02000000
random_padding_bytes = 36BC32FCFD16542DAA475870C8D2B5F292D1528FA6DCA73533C04201A88255BD4D45DA41CA3C1649B54EB3856D8378D6F98DE38562C5EBEC143F2D64B558D2476578B8F406DB632774296B96CF0B518F3E7BAF90336BF6DF6184EE92</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 3F5C01340DB35237AAAD2C0BAEF9EA263633CB2CE3B6138BB2E90BA40A9D1604ED43BA2B309F74CD9487FB0FD2288211651B6F3E10A04164E3D24F964832F83CAB5D43BDFC5D3C3F6F21B517B3ED63307A2087BA057FF0A15BC110781D6DB73F17DA58D47373A3BB24D3946D126B78D0166423EDF10E39B51228C8EDB6F8B68CFD92D66A3696C9F3FF6ECAFA2F1E8BA4EC0F7E38715B77BBC9F38D231D1BEF3529E1698922C9332877BC42C929D4BFDD492108953E805EF55E44CEE939D8F759BA673FED970382500672EC7B0D5DCDD9D42BE029C20B05C248775DF37CF2EA86E3CCC1A0968C93F4CE3418A3490118411EA877EA2E8B0BE7FB3144FFEFC4F003</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 2C 1E 0B 00 6F 7E A2 66
0010 | 40 01 00 00 BE E4 12 D7 92 63 8E CF 53 C6 21 AC
0020 | 5A 56 9F A7 D8 24 8D D2 81 32 9E 3B 6E D3 C9 C1
0030 | 4C F7 5A 8A 5D 4F 9E 5C 04 40 45 85 93 00 00 00
0040 | 04 41 60 43 67 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 3F 5C 01 34 0D B3 52 37 AA AD 2C 0B
0060 | AE F9 EA 26 36 33 CB 2C E3 B6 13 8B B2 E9 0B A4
0070 | 0A 9D 16 04 ED 43 BA 2B 30 9F 74 CD 94 87 FB 0F
0080 | D2 28 82 11 65 1B 6F 3E 10 A0 41 64 E3 D2 4F 96
0090 | 48 32 F8 3C AB 5D 43 BD FC 5D 3C 3F 6F 21 B5 17
00A0 | B3 ED 63 30 7A 20 87 BA 05 7F F0 A1 5B C1 10 78
00B0 | 1D 6D B7 3F 17 DA 58 D4 73 73 A3 BB 24 D3 94 6D
00C0 | 12 6B 78 D0 16 64 23 ED F1 0E 39 B5 12 28 C8 ED
00D0 | B6 F8 B6 8C FD 92 D6 6A 36 96 C9 F3 FF 6E CA FA
00E0 | 2F 1E 8B A4 EC 0F 7E 38 71 5B 77 BB C9 F3 8D 23
00F0 | 1D 1B EF 35 29 E1 69 89 22 C9 33 28 77 BC 42 C9
0100 | 29 D4 BF DD 49 21 08 95 3E 80 5E F5 5E 44 CE E9
0110 | 39 D8 F7 59 BA 67 3F ED 97 03 82 50 06 72 EC 7B
0120 | 0D 5D CD D9 D4 2B E0 29 C2 0B 05 C2 48 77 5D F3
0130 | 7C F2 EA 86 E3 CC C1 A0 96 8C 93 F4 CE 34 18 A3
0140 | 49 01 18 41 1E A8 77 EA 2E 8B 0B E7 FB 31 44 FF
0150 | EF C4 F0 03</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>2C1E0B006F7EA266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0440458593000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1078298003</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0441604367000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1096827751</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001003F5C01340DB35237AAAD2C0B</code> <code>AEF9EA263633CB2CE3B6138BB2E90BA4</code> <code>0A9D1604ED43BA2B309F74CD9487FB0F</code> <code>D2288211651B6F3E10A04164E3D24F96</code> <code>4832F83CAB5D43BDFC5D3C3F6F21B517</code> <code>B3ED63307A2087BA057FF0A15BC11078</code> <code>1D6DB73F17DA58D47373A3BB24D3946D</code> <code>126B78D0166423EDF10E39B51228C8ED</code> <code>B6F8B68CFD92D66A3696C9F3FF6ECAFA</code> <code>2F1E8BA4EC0F7E38715B77BBC9F38D23</code> <code>1D1BEF3529E1698922C9332877BC42C9</code> <code>29D4BFDD492108953E805EF55E44CEE9</code> <code>39D8F759BA673FED970382500672EC7B</code> <code>0D5DCDD9D42BE029C20B05C248775DF3</code> <code>7CF2EA86E3CCC1A0968C93F4CE3418A3</code> <code>490118411EA877EA2E8B0BE7FB3144FF</code><br> <code>EFC4F003</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 CA 95 70 7E A2 66
0010 | A8 02 00 00 5C 07 E8 D0 92 63 8E CF 53 C6 21 AC
0020 | 5A 56 9F A7 D8 24 8D D2 81 32 9E 3B 6E D3 C9 C1
0030 | 4C F7 5A 8A 5D 4F 9E 5C FE 50 02 00 4A 6A 11 FB
0040 | 97 0A C5 BB 6D 54 76 57 BF 18 6B CF 62 9E EA 5C
0050 | 2E 48 93 F2 62 79 D6 26 75 C1 CB FB 1F 45 67 73
0060 | 3F 41 4A D6 61 A9 C5 73 1B A9 CD E1 F9 95 79 F3
0070 | 1E 3B 0F E9 69 A8 40 15 C5 93 8E 51 C0 6E E5 32
0080 | 9A E9 3E 5A E3 30 3B D9 85 02 91 86 C3 C5 4E 80
0090 | AE 84 25 5F 1A E2 88 15 02 41 87 D2 4E 72 10 1F
00A0 | 33 2C 42 94 68 4D 5E 10 DB E4 1B 51 EE CD 54 CF
00B0 | DC 71 C2 94 AF F3 76 E4 B7 8D D8 89 E6 A2 E8 5B
00C0 | 02 9B EE 34 EC 99 20 28 74 74 70 AD 85 28 E4 73
00D0 | F0 4B 6D BE 47 BF 58 0C 65 5A CA 44 A6 30 A2 95
00E0 | 61 03 42 7B F3 3D 34 39 D8 70 F8 86 65 73 6E 65
00F0 | 04 B8 A2 14 A6 BE 1C F6 72 57 4D B1 98 02 68 BC
0100 | 78 3F 22 B8 34 39 48 8B 33 52 F3 F9 EA 90 CD A2
0110 | 2A B2 00 47 BE 70 3E 3F 2F 42 10 39 A2 28 53 74
0120 | 06 19 C1 91 9B FE 77 D3 BA 43 CC 55 10 05 E5 0E
0130 | 21 8B 9C 5E C9 9E 8B EE B1 FD D5 02 74 95 E9 2D
0140 | 49 8A AF 0A 46 32 5B BD D9 52 BB A8 4E CF 87 58
0150 | 42 F2 A5 98 08 25 69 4E 5C 41 F3 A5 CB E6 F6 06
0160 | DA 68 19 99 53 F2 36 E3 66 B1 B0 5C FE 33 80 E6
0170 | E4 0B 3F 78 26 02 D6 B1 65 FE EA 28 E8 9A D2 BA
0180 | 4B B1 43 BA 9C E8 92 2C 6F 97 0C 99 4D 7F 8F 89
0190 | 97 65 00 D5 41 FF 1B BB 2B CD 7D 3C AE 73 FC 9E
01A0 | AE 6E 40 F6 79 10 11 5F BD 7D 36 98 34 D1 31 BD
01B0 | 91 53 FC 82 36 CD 6C E1 E3 2E 65 B9 FA 4F 2C 15
01C0 | E2 79 63 57 6E 29 8F 4F D9 64 25 2F 4B E3 D5 80
01D0 | 89 88 6C 28 1C 8E F9 F6 53 CB D5 7F 75 07 6E 57
01E0 | E0 1D 79 23 6E A4 BE 9A E9 9F 16 86 A1 7F A7 EF
01F0 | 83 84 47 F9 C6 C5 22 89 6C A1 CD 52 04 88 BA 05
0200 | 4D 1E D2 BF 9C 28 37 AD F2 37 D4 44 D4 AD EF A3
0210 | 97 90 D5 60 4E C9 20 E1 BD C3 86 2B A1 D6 C7 BC
0220 | AE 8C E1 CA 78 9C 03 97 98 16 E3 63 39 A3 13 D2
0230 | 10 18 0F 8C 9B DC E0 9A 17 7C 46 9D A9 13 30 18
0240 | AF 50 20 43 10 72 E3 38 C7 FC E7 77 E7 6F BF E5
0250 | 9E 01 40 F8 6E 13 E7 8A FF 7D 82 76 DB 16 79 40
0260 | 4F 04 94 30 B1 A8 85 8B CA 07 E0 68 12 4F 2F AA
0270 | 32 36 A7 66 07 B6 8A 86 28 40 59 23 8B 9A CE B6
0280 | 97 9B 9C 1F 17 9E EF 5A 62 B8 4C C6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130CA95707EA266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8020000</code> (680 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002004A6A11FB970AC5BB6D547657</code> <code>BF186BCF629EEA5C2E4893F26279D626</code> <code>75C1CBFB1F4567733F414AD661A9C573</code> <code>1BA9CDE1F99579F31E3B0FE969A84015</code> <code>C5938E51C06EE5329AE93E5AE3303BD9</code> <code>85029186C3C54E80AE84255F1AE28815</code> <code>024187D24E72101F332C4294684D5E10</code> <code>DBE41B51EECD54CFDC71C294AFF376E4</code> <code>B78DD889E6A2E85B029BEE34EC992028</code> <code>747470AD8528E473F04B6DBE47BF580C</code> <code>655ACA44A630A2956103427BF33D3439</code> <code>D870F88665736E6504B8A214A6BE1CF6</code> <code>72574DB1980268BC783F22B83439488B</code> <code>3352F3F9EA90CDA22AB20047BE703E3F</code> <code>2F421039A22853740619C1919BFE77D3</code> <code>BA43CC551005E50E218B9C5EC99E8BEE</code> <code>B1FDD5027495E92D498AAF0A46325BBD</code> <code>D952BBA84ECF875842F2A5980825694E</code> <code>5C41F3A5CBE6F606DA68199953F236E3</code> <code>66B1B05CFE3380E6E40B3F782602D6B1</code> <code>65FEEA28E89AD2BA4BB143BA9CE8922C</code> <code>6F970C994D7F8F89976500D541FF1BBB</code> <code>2BCD7D3CAE73FC9EAE6E40F67910115F</code> <code>BD7D369834D131BD9153FC8236CD6CE1</code> <code>E32E65B9FA4F2C15E27963576E298F4F</code> <code>D964252F4BE3D58089886C281C8EF9F6</code> <code>53CBD57F75076E57E01D79236EA4BE9A</code> <code>E99F1686A17FA7EF838447F9C6C52289</code> <code>6CA1CD520488BA054D1ED2BF9C2837AD</code> <code>F237D444D4ADEFA39790D5604EC920E1</code> <code>BDC3862BA1D6C7BCAE8CE1CA789C0397</code> <code>9816E36339A313D210180F8C9BDCE09A</code> <code>177C469DA9133018AF5020431072E338</code> <code>C7FCE777E76FBFE59E0140F86E13E78A</code> <code>FF7D8276DB1679404F049430B1A8858B</code> <code>CA07E068124F2FAA3236A76607B68A86</code> <code>284059238B9ACEB6979B9C1F179EEF5A</code><br> <code>62B84CC6</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 4A6A11FB970AC5BB6D547657BF186BCF629EEA5C2E4893F26279D62675C1CBFB1F4567733F414AD661A9C5731BA9CDE1F99579F31E3B0FE969A84015C5938E51C06EE5329AE93E5AE3303BD985029186C3C54E80AE84255F1AE28815024187D24E72101F332C4294684D5E10DBE41B51EECD54CFDC71C294AFF376E4B78DD889E6A2E85B029BEE34EC992028747470AD8528E473F04B6DBE47BF580C655ACA44A630A2956103427BF33D3439D870F88665736E6504B8A214A6BE1CF672574DB1980268BC783F22B83439488B3352F3F9EA90CDA22AB20047BE703E3F2F421039A22853740619C1919BFE77D3BA43CC551005E50E218B9C5EC99E8BEEB1FDD5027495E92D498AAF0A46325BBDD952BBA84ECF875842F2A5980825694E5C41F3A5CBE6F606DA68199953F236E366B1B05CFE3380E6E40B3F782602D6B165FEEA28E89AD2BA4BB143BA9CE8922C6F970C994D7F8F89976500D541FF1BBB2BCD7D3CAE73FC9EAE6E40F67910115FBD7D369834D131BD9153FC8236CD6CE1E32E65B9FA4F2C15E27963576E298F4FD964252F4BE3D58089886C281C8EF9F653CBD57F75076E57E01D79236EA4BE9AE99F1686A17FA7EF838447F9C6C522896CA1CD520488BA054D1ED2BF9C2837ADF237D444D4ADEFA39790D5604EC920E1BDC3862BA1D6C7BCAE8CE1CA789C03979816E36339A313D210180F8C9BDCE09A177C469DA9133018AF5020431072E338C7FCE777E76FBFE59E0140F86E13E78AFF7D8276DB1679404F049430B1A8858BCA07E068124F2FAA3236A76607B68A86284059238B9ACEB6979B9C1F179EEF5A62B84CC6
tmp_aes_key = 9B2DB3607E4868AB72C98C0FAA723450C93F5D03DC01F3FD919CF5E015C70210
tmp_aes_iv = 717BECED312445E965C2A534DFA9A07681B16D91A159E96CF2CB727F38DD223E</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 275BF3A03306402F7DFA72ED4E2D817BB3DD2960BA0D89B592638ECF53C621AC5A569FA7D8248DD281329E3B6ED3C9C14CF75A8A5D4F9E5C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000C68334471841DEA570C80A4FAA55311D859A67D0F084D40648AFEA0A5121BE22E28CF3EFB6D160C52A13B31BB5B69A915FF598DBD7255E75AD0E0B15A9EA208AFCC1E8E7008575E71EBBFB2FCF3700D2269107D3DF02D82B7545A691ECC58098ECDBA37B2A0BE6374F3B3B09A52FF1871CA9CB08B1B64D49BFEA518BEE2CFD2FF755529DEAE5E300238D88754DD192E0F4055B3E6E5690B91F9912A8B727446221461CE12AB102A4D6644FCA2B7590D053C152E812F1317E7609226EE5D880E1F57F353EDB29D8F175B0E424E88E51B53BD278FBD733EA738AB1B31A0D943C32AEC019131364488C78FC1A481151A2626299A8BA60EE1B93C7ED8300D83D4A4707EA26688B738ADE93C2AE0
answer = BA0D89B592638ECF53C621AC5A569FA7D8248DD281329E3B6ED3C9C14CF75A8A5D4F9E5C03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001000C68334471841DEA570C80A4FAA55311D859A67D0F084D40648AFEA0A5121BE22E28CF3EFB6D160C52A13B31BB5B69A915FF598DBD7255E75AD0E0B15A9EA208AFCC1E8E7008575E71EBBFB2FCF3700D2269107D3DF02D82B7545A691ECC58098ECDBA37B2A0BE6374F3B3B09A52FF1871CA9CB08B1B64D49BFEA518BEE2CFD2FF755529DEAE5E300238D88754DD192E0F4055B3E6E5690B91F9912A8B727446221461CE12AB102A4D6644FCA2B7590D053C152E812F1317E7609226EE5D880E1F57F353EDB29D8F175B0E424E88E51B53BD278FBD733EA738AB1B31A0D943C32AEC019131364488C78FC1A481151A2626299A8BA60EE1B93C7ED8300D83D4A4707EA26688B738ADE93C2AE0</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 92 63 8E CF 53 C6 21 AC 5A 56 9F A7
0010 | D8 24 8D D2 81 32 9E 3B 6E D3 C9 C1 4C F7 5A 8A
0020 | 5D 4F 9E 5C 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 0C 68 33 44 71 84 1D EA 57 0C 80 A4 FA A5 53 11
0140 | D8 59 A6 7D 0F 08 4D 40 64 8A FE A0 A5 12 1B E2
0150 | 2E 28 CF 3E FB 6D 16 0C 52 A1 3B 31 BB 5B 69 A9
0160 | 15 FF 59 8D BD 72 55 E7 5A D0 E0 B1 5A 9E A2 08
0170 | AF CC 1E 8E 70 08 57 5E 71 EB BF B2 FC F3 70 0D
0180 | 22 69 10 7D 3D F0 2D 82 B7 54 5A 69 1E CC 58 09
0190 | 8E CD BA 37 B2 A0 BE 63 74 F3 B3 B0 9A 52 FF 18
01A0 | 71 CA 9C B0 8B 1B 64 D4 9B FE A5 18 BE E2 CF D2
01B0 | FF 75 55 29 DE AE 5E 30 02 38 D8 87 54 DD 19 2E
01C0 | 0F 40 55 B3 E6 E5 69 0B 91 F9 91 2A 8B 72 74 46
01D0 | 22 14 61 CE 12 AB 10 2A 4D 66 44 FC A2 B7 59 0D
01E0 | 05 3C 15 2E 81 2F 13 17 E7 60 92 26 EE 5D 88 0E
01F0 | 1F 57 F3 53 ED B2 9D 8F 17 5B 0E 42 4E 88 E5 1B
0200 | 53 BD 27 8F BD 73 3E A7 38 AB 1B 31 A0 D9 43 C3
0210 | 2A EC 01 91 31 36 44 88 C7 8F C1 A4 81 15 1A 26
0220 | 26 29 9A 8B A6 0E E1 B9 3C 7E D8 30 0D 83 D4 A4
0230 | 70 7E A2 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001000C68334471841DEA570C80A4</code> <code>FAA55311D859A67D0F084D40648AFEA0</code> <code>A5121BE22E28CF3EFB6D160C52A13B31</code> <code>BB5B69A915FF598DBD7255E75AD0E0B1</code> <code>5A9EA208AFCC1E8E7008575E71EBBFB2</code> <code>FCF3700D2269107D3DF02D82B7545A69</code> <code>1ECC58098ECDBA37B2A0BE6374F3B3B0</code> <code>9A52FF1871CA9CB08B1B64D49BFEA518</code> <code>BEE2CFD2FF755529DEAE5E300238D887</code> <code>54DD192E0F4055B3E6E5690B91F9912A</code> <code>8B727446221461CE12AB102A4D6644FC</code> <code>A2B7590D053C152E812F1317E7609226</code> <code>EE5D880E1F57F353EDB29D8F175B0E42</code> <code>4E88E51B53BD278FBD733EA738AB1B31</code> <code>A0D943C32AEC019131364488C78FC1A4</code> <code>81151A2626299A8BA60EE1B93C7ED830</code><br> <code>0D83D4A4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>707EA266</code> (1721925232 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 1840B50088DA0DC4578C07F6EB06641EF319E5E2D020EAB4EC8751AAE39667B4D657CFB741A2A2B54A3FFA5FF91134BE2035C31855E3FCA3279852E0797C7D0B1CA1DD904D15B82E26C220276DBBF9FCC701EF6F995B5719C9AE7DB57BCE98FA4B7E3D60F6D432F4AC844A43554181998D259A61DE4EB2F523AA6DAD34A9AB0F8648F109F111F0BC617CEE7D538C7B8A36258A2F5C372D58D25A42DF7B8CB0C8D7C07955FAEAAA126F16D97BBEDF961839E52F2D4273D7AAF2A1B285922EA87FC0ECF136FBA0C8AD99318BCFED07E58590F67016B4E8B3CC8A99EA7C01EF72FCF907E5D7A73E066B65E93ECDEB53D552386BB007F2ED31070F2F041946227E3C</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 6891C7A59696CDB5942FD0A8B5FAA47FE78B5B0EA12ED2FB72907BE893C82CBD079C15FB57D2E8AA2FA9137CADE959E8D33788335F9C47724E1A4E69D6847BC801BEFB9E4B76A5576EC51C0F03CA867FBDE38B968B794C3AC46E8778B62DCCAC92765FB26D60EFB3B744E39E61576AA9DC0005B67ED889B38215CE6D2465EFA4F5D61D79960E7A4AA148CFCE9034425149D35AEEE5810E959A570EA8BEBF211EEC7F209F4780FC480D0C0F0047572B4F589A25F3C388F46AA4C3919F1F027DA968BDF28EACE21F53F51861CDCC4174B761A6FF9B4BC90A614C3722EB6953E6E11A3368F20BBD05A286BDB71E8F95C3A6080BBB8A6737095B7E7B63B14D14AF16</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 92 63 8E CF 53 C6 21 AC 5A 56 9F A7
0010 | D8 24 8D D2 81 32 9E 3B 6E D3 C9 C1 4C F7 5A 8A
0020 | 5D 4F 9E 5C 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 68 91 C7 A5 96 96 CD B5 94 2F D0 A8 B5 FA A4 7F
0040 | E7 8B 5B 0E A1 2E D2 FB 72 90 7B E8 93 C8 2C BD
0050 | 07 9C 15 FB 57 D2 E8 AA 2F A9 13 7C AD E9 59 E8
0060 | D3 37 88 33 5F 9C 47 72 4E 1A 4E 69 D6 84 7B C8
0070 | 01 BE FB 9E 4B 76 A5 57 6E C5 1C 0F 03 CA 86 7F
0080 | BD E3 8B 96 8B 79 4C 3A C4 6E 87 78 B6 2D CC AC
0090 | 92 76 5F B2 6D 60 EF B3 B7 44 E3 9E 61 57 6A A9
00A0 | DC 00 05 B6 7E D8 89 B3 82 15 CE 6D 24 65 EF A4
00B0 | F5 D6 1D 79 96 0E 7A 4A A1 48 CF CE 90 34 42 51
00C0 | 49 D3 5A EE E5 81 0E 95 9A 57 0E A8 BE BF 21 1E
00D0 | EC 7F 20 9F 47 80 FC 48 0D 0C 0F 00 47 57 2B 4F
00E0 | 58 9A 25 F3 C3 88 F4 6A A4 C3 91 9F 1F 02 7D A9
00F0 | 68 BD F2 8E AC E2 1F 53 F5 18 61 CD CC 41 74 B7
0100 | 61 A6 FF 9B 4B C9 0A 61 4C 37 22 EB 69 53 E6 E1
0110 | 1A 33 68 F2 0B BD 05 A2 86 BD B7 1E 8F 95 C3 A6
0120 | 08 0B BB 8A 67 37 09 5B 7E 7B 63 B1 4D 14 AF 16</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001006891C7A59696CDB5942FD0A8</code> <code>B5FAA47FE78B5B0EA12ED2FB72907BE8</code> <code>93C82CBD079C15FB57D2E8AA2FA9137C</code> <code>ADE959E8D33788335F9C47724E1A4E69</code> <code>D6847BC801BEFB9E4B76A5576EC51C0F</code> <code>03CA867FBDE38B968B794C3AC46E8778</code> <code>B62DCCAC92765FB26D60EFB3B744E39E</code> <code>61576AA9DC0005B67ED889B38215CE6D</code> <code>2465EFA4F5D61D79960E7A4AA148CFCE</code> <code>9034425149D35AEEE5810E959A570EA8</code> <code>BEBF211EEC7F209F4780FC480D0C0F00</code> <code>47572B4F589A25F3C388F46AA4C3919F</code> <code>1F027DA968BDF28EACE21F53F51861CD</code> <code>CC4174B761A6FF9B4BC90A614C3722EB</code> <code>6953E6E11A3368F20BBD05A286BDB71E</code> <code>8F95C3A6080BBB8A6737095B7E7B63B1</code><br> <code>4D14AF16</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436692638ECF53C621AC5A569FA7D8248DD281329E3B6ED3C9C14CF75A8A5D4F9E5C0000000000000000FE0001006891C7A59696CDB5942FD0A8B5FAA47FE78B5B0EA12ED2FB72907BE893C82CBD079C15FB57D2E8AA2FA9137CADE959E8D33788335F9C47724E1A4E69D6847BC801BEFB9E4B76A5576EC51C0F03CA867FBDE38B968B794C3AC46E8778B62DCCAC92765FB26D60EFB3B744E39E61576AA9DC0005B67ED889B38215CE6D2465EFA4F5D61D79960E7A4AA148CFCE9034425149D35AEEE5810E959A570EA8BEBF211EEC7F209F4780FC480D0C0F0047572B4F589A25F3C388F46AA4C3919F1F027DA968BDF28EACE21F53F51861CDCC4174B761A6FF9B4BC90A614C3722EB6953E6E11A3368F20BBD05A286BDB71E8F95C3A6080BBB8A6737095B7E7B63B14D14AF16
padding = 13EB1DB04EB9EDDD42C44712
tmp_aes_key = 9B2DB3607E4868AB72C98C0FAA723450C93F5D03DC01F3FD919CF5E015C70210
tmp_aes_iv = 717BECED312445E965C2A534DFA9A07681B16D91A159E96CF2CB727F38DD223E</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 57FB7D62F641FB4AC199BED27A3C1231DF85D99079CB4EE37A289F5C3367409FBF957C33F98259512A879321EFAA6A9AC948B905E02E50675F026C2951EBF7BE5C8F919C7DDA0E65EF616F2E458DC5776CF61EA4D56EC6BCB249C4485CAE4C3E0132E4EDF4507F8C261C9A702EDB7358A0A9DA3327A8AE722E617E28A59BC3CE85F565D443C7CE753C51C6D8D0D334DFDA0082A647CE51B351A8F21D8C20FEFE83B6C5DD7B832024285DC9A8D2388DB4D28A5EC5C89E883B6C7D8128AE5F9384D4D69E563F0D3E2CE696F84D8F3E3634AB290C58C44226EBDD966D9F6119E1AA3B712BFFDF7865E9B335634DFF768B8D71AA37FBB223A7DEEF5E8BAD8FCB25768573BF66BE741D7A204912C9C6AF77409F7036D8D4C990AE0B366516A8330370EDB22F363EFB37727F42C2933255E221F13C9E21F8F4666741F46850A3975317BA74671356AA736581FA0DD241309D41</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 1C 07 05 00 70 7E A2 66
0010 | 78 01 00 00 1F 5F 04 F5 92 63 8E CF 53 C6 21 AC
0020 | 5A 56 9F A7 D8 24 8D D2 81 32 9E 3B 6E D3 C9 C1
0030 | 4C F7 5A 8A 5D 4F 9E 5C FE 50 01 00 57 FB 7D 62
0040 | F6 41 FB 4A C1 99 BE D2 7A 3C 12 31 DF 85 D9 90
0050 | 79 CB 4E E3 7A 28 9F 5C 33 67 40 9F BF 95 7C 33
0060 | F9 82 59 51 2A 87 93 21 EF AA 6A 9A C9 48 B9 05
0070 | E0 2E 50 67 5F 02 6C 29 51 EB F7 BE 5C 8F 91 9C
0080 | 7D DA 0E 65 EF 61 6F 2E 45 8D C5 77 6C F6 1E A4
0090 | D5 6E C6 BC B2 49 C4 48 5C AE 4C 3E 01 32 E4 ED
00A0 | F4 50 7F 8C 26 1C 9A 70 2E DB 73 58 A0 A9 DA 33
00B0 | 27 A8 AE 72 2E 61 7E 28 A5 9B C3 CE 85 F5 65 D4
00C0 | 43 C7 CE 75 3C 51 C6 D8 D0 D3 34 DF DA 00 82 A6
00D0 | 47 CE 51 B3 51 A8 F2 1D 8C 20 FE FE 83 B6 C5 DD
00E0 | 7B 83 20 24 28 5D C9 A8 D2 38 8D B4 D2 8A 5E C5
00F0 | C8 9E 88 3B 6C 7D 81 28 AE 5F 93 84 D4 D6 9E 56
0100 | 3F 0D 3E 2C E6 96 F8 4D 8F 3E 36 34 AB 29 0C 58
0110 | C4 42 26 EB DD 96 6D 9F 61 19 E1 AA 3B 71 2B FF
0120 | DF 78 65 E9 B3 35 63 4D FF 76 8B 8D 71 AA 37 FB
0130 | B2 23 A7 DE EF 5E 8B AD 8F CB 25 76 85 73 BF 66
0140 | BE 74 1D 7A 20 49 12 C9 C6 AF 77 40 9F 70 36 D8
0150 | D4 C9 90 AE 0B 36 65 16 A8 33 03 70 ED B2 2F 36
0160 | 3E FB 37 72 7F 42 C2 93 32 55 E2 21 F1 3C 9E 21
0170 | F8 F4 66 67 41 F4 68 50 A3 97 53 17 BA 74 67 13
0180 | 56 AA 73 65 81 FA 0D D2 41 30 9D 41</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>1C070500707EA266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010057FB7D62F641FB4AC199BED2</code> <code>7A3C1231DF85D99079CB4EE37A289F5C</code> <code>3367409FBF957C33F98259512A879321</code> <code>EFAA6A9AC948B905E02E50675F026C29</code> <code>51EBF7BE5C8F919C7DDA0E65EF616F2E</code> <code>458DC5776CF61EA4D56EC6BCB249C448</code> <code>5CAE4C3E0132E4EDF4507F8C261C9A70</code> <code>2EDB7358A0A9DA3327A8AE722E617E28</code> <code>A59BC3CE85F565D443C7CE753C51C6D8</code> <code>D0D334DFDA0082A647CE51B351A8F21D</code> <code>8C20FEFE83B6C5DD7B832024285DC9A8</code> <code>D2388DB4D28A5EC5C89E883B6C7D8128</code> <code>AE5F9384D4D69E563F0D3E2CE696F84D</code> <code>8F3E3634AB290C58C44226EBDD966D9F</code> <code>6119E1AA3B712BFFDF7865E9B335634D</code> <code>FF768B8D71AA37FBB223A7DEEF5E8BAD</code> <code>8FCB25768573BF66BE741D7A204912C9</code> <code>C6AF77409F7036D8D4C990AE0B366516</code> <code>A8330370EDB22F363EFB37727F42C293</code> <code>3255E221F13C9E21F8F4666741F46850</code> <code>A3975317BA74671356AA736581FA0DD2</code><br> <code>41309D41</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2EDAB8AA240CECA596ED70730B81372D914A08B43581358B3AFAB5F35D59334C00CFD1716655045A595310552C162496C67CD53CC2C3724A666D89B3BE30E95B314281DD39C9BEB1BC2BCCC6D26696532019BCDF2CCE825A58392F288FE979E1AD55FBE4A37E3A4CF121CC7EDF525442EDB8A71A11D36097F82E1E181B5251B65B91D300898C59AA4FB471CC50052D8692DB527BF4E5D0B3C73106FE1AF6143CA57CCA3D281EAEB624B456C4A15646976FEF93E2A2DECE0C8909FEF3E98443AC9DE79153934423125C4A121275471F6F785A793B0E45A92687FB2897D82480825606FA38F0C68D4A1A6F67507E9731778CDEE9B2119A789CB4DAF9D1A5EF41D1</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 15 0E 71 7E A2 66
0010 | A0 00 00 00 34 F7 CB 3B 92 63 8E CF 53 C6 21 AC
0020 | 5A 56 9F A7 D8 24 8D D2 81 32 9E 3B 6E D3 C9 C1
0030 | 4C F7 5A 8A 5D 4F 9E 5C 23 0B 1D 76 15 E4 CF 65
0040 | A1 99 33 B0 1D 8C 24 6D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C4150E717EA266</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A0000000</code> (160 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>92638ECF53C621AC5A569FA7D8248DD2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>81329E3B6ED3C9C14CF75A8A5D4F9E5C</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>230B1D7615E4CF65A19933B01D8C246D</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

