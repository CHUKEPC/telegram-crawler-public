<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 DC 1B 0E 00 38 04 D8 68
0010 | 14 00 00 00 F1 8E 7E BE 28 88 4E 4D 29 E2 70 29
0020 | 6E 35 B4 9C A9 29 F1 7C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>DC1B0E003804D868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 88 AF DB 38 04 D8 68
0010 | 50 00 00 00 63 24 16 05 28 88 4E 4D 29 E2 70 29
0020 | 6E 35 B4 9C A9 29 F1 7C D4 4B 2C 39 F8 D5 B8 E4
0030 | 07 2D A9 6D 99 B2 58 90 08 1B 3B 72 EB 8A AB AC
0040 | 51 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0188AFDB3804D868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081B3B72EB8AABAC51000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1962288418619370577</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1962288418619370577</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1962288418619370577 = 1340442347 * 1463911091</code></p>
<pre><code>p = 1340442347
q = 1463911091</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1B 3B 72 EB 8A AB AC 51 00 00 00
0010 | 04 4F E5 86 EB 00 00 00 04 57 41 82 B3 00 00 00
0020 | 28 88 4E 4D 29 E2 70 29 6E 35 B4 9C A9 29 F1 7C
0030 | D4 4B 2C 39 F8 D5 B8 E4 07 2D A9 6D 99 B2 58 90
0040 | BF 5F 7A 2C 23 2F C8 33 C0 36 15 6A 9F FD BB 80
0050 | B4 63 BC 54 68 E7 F6 9D 3D BA F5 69 F8 F3 F8 02
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081B3B72EB8AABAC51000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1962288418619370577</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044FE586EB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1340442347</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04574182B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1463911091</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>BF5F7A2C232FC833C036156A9FFDBB80</code> <code>B463BC5468E7F69D3DBAF569F8F3F802</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081B3B72EB8AABAC51000000044FE586EB00000004574182B300000028884E4D29E270296E35B49CA929F17CD44B2C39F8D5B8E4072DA96D99B25890BF5F7A2C232FC833C036156A9FFDBB80B463BC5468E7F69D3DBAF569F8F3F80202000000
random_padding_bytes = B299647F6A7298DA1A7F1A6FBAE26B5AA0E2D946830C8EFFA8F5853FD4B7EC0AC3A619801911D168774BC70C73B644F5FA226E697AF26F15B5258104D827318E1237140766C2B3369293E700101A9C1D62577E4BEA1D567F52B97630</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 0D23F93710182EEC32F6720954A0635D27EEE68F2A1E537AE8F5624F2853B5A2BB7DE238BF1FEFA8D7EF07E5CE36ADF412ED81E3401C6A2327970916F1E8A5BDF01BF9BFCC999FBE3F2DEA64207460704CC95F36602E5B956CDBE80C83F435E942BBB5695C7BCE5EE8937716200327C4FB51F1885514563B589699B6868EBBC5125A40F249F30A180FBA1C617B9EB53A1E7C89CC524C649B57D0DCA3B93EE5D364DF62ADE0C5A6CB8307556B17498D718DB5093C19DB74181CBA018E58FAAA39337FC12CBD259842344078F78941B061606C8F82EBE3DC8F5B980F87CED9EA1E7BF2699A66701FB9458DF0808F375E85F5F57AE8071E4218BFC6C68BCE99C7C2</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E0 1B 0E 00 38 04 D8 68
0010 | 40 01 00 00 BE E4 12 D7 28 88 4E 4D 29 E2 70 29
0020 | 6E 35 B4 9C A9 29 F1 7C D4 4B 2C 39 F8 D5 B8 E4
0030 | 07 2D A9 6D 99 B2 58 90 04 4F E5 86 EB 00 00 00
0040 | 04 57 41 82 B3 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 0D 23 F9 37 10 18 2E EC 32 F6 72 09
0060 | 54 A0 63 5D 27 EE E6 8F 2A 1E 53 7A E8 F5 62 4F
0070 | 28 53 B5 A2 BB 7D E2 38 BF 1F EF A8 D7 EF 07 E5
0080 | CE 36 AD F4 12 ED 81 E3 40 1C 6A 23 27 97 09 16
0090 | F1 E8 A5 BD F0 1B F9 BF CC 99 9F BE 3F 2D EA 64
00A0 | 20 74 60 70 4C C9 5F 36 60 2E 5B 95 6C DB E8 0C
00B0 | 83 F4 35 E9 42 BB B5 69 5C 7B CE 5E E8 93 77 16
00C0 | 20 03 27 C4 FB 51 F1 88 55 14 56 3B 58 96 99 B6
00D0 | 86 8E BB C5 12 5A 40 F2 49 F3 0A 18 0F BA 1C 61
00E0 | 7B 9E B5 3A 1E 7C 89 CC 52 4C 64 9B 57 D0 DC A3
00F0 | B9 3E E5 D3 64 DF 62 AD E0 C5 A6 CB 83 07 55 6B
0100 | 17 49 8D 71 8D B5 09 3C 19 DB 74 18 1C BA 01 8E
0110 | 58 FA AA 39 33 7F C1 2C BD 25 98 42 34 40 78 F7
0120 | 89 41 B0 61 60 6C 8F 82 EB E3 DC 8F 5B 98 0F 87
0130 | CE D9 EA 1E 7B F2 69 9A 66 70 1F B9 45 8D F0 80
0140 | 8F 37 5E 85 F5 F5 7A E8 07 1E 42 18 BF C6 C6 8B
0150 | CE 99 C7 C2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E01B0E003804D868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044FE586EB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1340442347</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04574182B3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1463911091</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001000D23F93710182EEC32F67209</code> <code>54A0635D27EEE68F2A1E537AE8F5624F</code> <code>2853B5A2BB7DE238BF1FEFA8D7EF07E5</code> <code>CE36ADF412ED81E3401C6A2327970916</code> <code>F1E8A5BDF01BF9BFCC999FBE3F2DEA64</code> <code>207460704CC95F36602E5B956CDBE80C</code> <code>83F435E942BBB5695C7BCE5EE8937716</code> <code>200327C4FB51F1885514563B589699B6</code> <code>868EBBC5125A40F249F30A180FBA1C61</code> <code>7B9EB53A1E7C89CC524C649B57D0DCA3</code> <code>B93EE5D364DF62ADE0C5A6CB8307556B</code> <code>17498D718DB5093C19DB74181CBA018E</code> <code>58FAAA39337FC12CBD259842344078F7</code> <code>8941B061606C8F82EBE3DC8F5B980F87</code> <code>CED9EA1E7BF2699A66701FB9458DF080</code> <code>8F375E85F5F57AE8071E4218BFC6C68B</code><br> <code>CE99C7C2</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A8 BD 02 39 04 D8 68
0010 | 78 02 00 00 5C 07 E8 D0 28 88 4E 4D 29 E2 70 29
0020 | 6E 35 B4 9C A9 29 F1 7C D4 4B 2C 39 F8 D5 B8 E4
0030 | 07 2D A9 6D 99 B2 58 90 FE 50 02 00 3F 00 11 2F
0040 | 7F C0 64 2A D0 F6 F0 40 10 26 B1 D9 59 9D 8B 8D
0050 | 84 2C 92 E8 93 09 56 C2 B2 CB 41 8B B5 8C 66 93
0060 | 71 95 8C 31 69 12 AC 86 8E F9 47 C2 7D D7 5C DE
0070 | ED 20 6B 67 52 FF F1 7D 83 E8 9E B6 A1 7E 91 6F
0080 | 64 B5 19 70 E9 1A F2 53 8C 82 8E 4B 5E F1 07 B2
0090 | 66 7A 90 E3 31 5E B1 14 C0 DD 65 77 BC 6D BE 38
00A0 | BA 6D 8C 20 AC F9 E3 61 E2 A3 A1 C1 E0 5C 94 F8
00B0 | D5 F5 BC F0 38 8D 53 F1 D3 6F D6 DA 5A 03 22 FF
00C0 | C5 81 01 4C 29 B3 AD 77 90 59 24 4E 99 05 92 F8
00D0 | CB 8E B8 A5 B1 54 7D D6 3C 2B 0E CA 8F DA 7D E2
00E0 | 7D 56 6B 73 95 D5 98 38 A9 40 2B C8 2D 81 F5 B3
00F0 | D7 7F E3 8B CB 8F 2B 52 17 58 65 EE 40 5A 06 95
0100 | F5 71 52 F4 65 07 C7 48 F7 20 F6 0A 32 C5 66 ED
0110 | 43 90 A5 2C E5 50 FF 0E B0 86 4E 1F 7B 68 68 A7
0120 | 28 88 43 D9 59 94 AB 8B 82 66 35 B5 07 65 03 86
0130 | F1 71 D3 19 9A BB 0D 5F 5B 09 72 A0 B5 F0 C7 42
0140 | 7F 14 4C A5 FA 8C 02 07 07 C6 9A 24 0F F8 A6 8B
0150 | 37 E7 CD 16 65 75 1D 1B F4 F5 82 57 20 00 04 B8
0160 | 69 AC 3A DC 27 8D DD 1E 15 71 E8 F9 DA 47 F7 94
0170 | BB DC 1B 72 E9 85 35 F9 FC 1F A3 08 FD 88 D6 FA
0180 | B5 BD 5C A7 F4 AC D7 6B 61 41 F9 0E 7B C9 C1 C4
0190 | 01 21 88 68 6B 2E 6E FE 47 CF 95 1C 77 BB 56 0D
01A0 | 7D 3E B0 B7 08 E4 6F B6 5B D4 28 C7 B4 8B CB 4D
01B0 | 3D FA 06 9E 51 ED 4C C7 CA 41 9F AE 29 F2 71 B6
01C0 | 52 CC 7E 74 6C AD AB 44 25 CE C4 1B D6 E9 7E B5
01D0 | A9 3B D1 7B 62 6F FE 92 C9 9D FA 6E 48 33 12 10
01E0 | 81 43 28 8C E7 B2 F8 57 05 3D 8A 90 60 B1 45 47
01F0 | C8 B9 20 66 67 C9 26 2E 27 D7 5B A2 82 E1 01 13
0200 | 7E 3C CE 95 5A 82 E0 09 03 82 7A 1C 0F D1 A3 0C
0210 | CF 96 24 0C 08 A2 A3 A8 AE 76 94 C3 7B F0 EB A4
0220 | C8 60 D5 EE E9 FE FD B0 8A 0C 98 4C 54 01 34 44
0230 | F6 4B 66 47 1C 4E 38 7B C4 1C BA 53 54 31 C0 2E
0240 | 53 5D 0E 77 6B 06 8B 2E 2E 82 4C 49 0E C9 CB 51
0250 | A8 B2 7A 66 F0 10 8F D5 CA 75 C8 CD 28 90 5E AF
0260 | 14 A2 15 A0 C3 A5 C9 D2 5E 38 C3 04 57 81 51 DD
0270 | BB 18 76 2C D1 FE 1D 6F F6 CE 82 11 FF E6 A6 34
0280 | 90 56 73 49 14 99 A4 00 10 4A 65 37</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A8BD023904D868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002003F00112F7FC0642AD0F6F040</code> <code>1026B1D9599D8B8D842C92E8930956C2</code> <code>B2CB418BB58C669371958C316912AC86</code> <code>8EF947C27DD75CDEED206B6752FFF17D</code> <code>83E89EB6A17E916F64B51970E91AF253</code> <code>8C828E4B5EF107B2667A90E3315EB114</code> <code>C0DD6577BC6DBE38BA6D8C20ACF9E361</code> <code>E2A3A1C1E05C94F8D5F5BCF0388D53F1</code> <code>D36FD6DA5A0322FFC581014C29B3AD77</code> <code>9059244E990592F8CB8EB8A5B1547DD6</code> <code>3C2B0ECA8FDA7DE27D566B7395D59838</code> <code>A9402BC82D81F5B3D77FE38BCB8F2B52</code> <code>175865EE405A0695F57152F46507C748</code> <code>F720F60A32C566ED4390A52CE550FF0E</code> <code>B0864E1F7B6868A7288843D95994AB8B</code> <code>826635B507650386F171D3199ABB0D5F</code> <code>5B0972A0B5F0C7427F144CA5FA8C0207</code> <code>07C69A240FF8A68B37E7CD1665751D1B</code> <code>F4F58257200004B869AC3ADC278DDD1E</code> <code>1571E8F9DA47F794BBDC1B72E98535F9</code> <code>FC1FA308FD88D6FAB5BD5CA7F4ACD76B</code> <code>6141F90E7BC9C1C4012188686B2E6EFE</code> <code>47CF951C77BB560D7D3EB0B708E46FB6</code> <code>5BD428C7B48BCB4D3DFA069E51ED4CC7</code> <code>CA419FAE29F271B652CC7E746CADAB44</code> <code>25CEC41BD6E97EB5A93BD17B626FFE92</code> <code>C99DFA6E483312108143288CE7B2F857</code> <code>053D8A9060B14547C8B9206667C9262E</code> <code>27D75BA282E101137E3CCE955A82E009</code> <code>03827A1C0FD1A30CCF96240C08A2A3A8</code> <code>AE7694C37BF0EBA4C860D5EEE9FEFDB0</code> <code>8A0C984C54013444F64B66471C4E387B</code> <code>C41CBA535431C02E535D0E776B068B2E</code> <code>2E824C490EC9CB51A8B27A66F0108FD5</code> <code>CA75C8CD28905EAF14A215A0C3A5C9D2</code> <code>5E38C304578151DDBB18762CD1FE1D6F</code> <code>F6CE8211FFE6A634905673491499A400</code><br> <code>104A6537</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 3F00112F7FC0642AD0F6F0401026B1D9599D8B8D842C92E8930956C2B2CB418BB58C669371958C316912AC868EF947C27DD75CDEED206B6752FFF17D83E89EB6A17E916F64B51970E91AF2538C828E4B5EF107B2667A90E3315EB114C0DD6577BC6DBE38BA6D8C20ACF9E361E2A3A1C1E05C94F8D5F5BCF0388D53F1D36FD6DA5A0322FFC581014C29B3AD779059244E990592F8CB8EB8A5B1547DD63C2B0ECA8FDA7DE27D566B7395D59838A9402BC82D81F5B3D77FE38BCB8F2B52175865EE405A0695F57152F46507C748F720F60A32C566ED4390A52CE550FF0EB0864E1F7B6868A7288843D95994AB8B826635B507650386F171D3199ABB0D5F5B0972A0B5F0C7427F144CA5FA8C020707C69A240FF8A68B37E7CD1665751D1BF4F58257200004B869AC3ADC278DDD1E1571E8F9DA47F794BBDC1B72E98535F9FC1FA308FD88D6FAB5BD5CA7F4ACD76B6141F90E7BC9C1C4012188686B2E6EFE47CF951C77BB560D7D3EB0B708E46FB65BD428C7B48BCB4D3DFA069E51ED4CC7CA419FAE29F271B652CC7E746CADAB4425CEC41BD6E97EB5A93BD17B626FFE92C99DFA6E483312108143288CE7B2F857053D8A9060B14547C8B9206667C9262E27D75BA282E101137E3CCE955A82E00903827A1C0FD1A30CCF96240C08A2A3A8AE7694C37BF0EBA4C860D5EEE9FEFDB08A0C984C54013444F64B66471C4E387BC41CBA535431C02E535D0E776B068B2E2E824C490EC9CB51A8B27A66F0108FD5CA75C8CD28905EAF14A215A0C3A5C9D25E38C304578151DDBB18762CD1FE1D6FF6CE8211FFE6A634905673491499A400104A6537
tmp_aes_key = 638EF0B1EC3F78C7B5D19E081BA70DDE45AF088BA07AE51244FAF4DD26DFD20C
tmp_aes_iv = BFEA2A1852DC4D151339EC7C3C4CB02B4D62BCE99C205DECEAFF70E7BF5F7A2C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 9EE0742B29C48874CF0FDCA21FD988DCCF837463BA0D89B528884E4D29E270296E35B49CA929F17CD44B2C39F8D5B8E4072DA96D99B2589003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003B2E7295F805FBCDDEF7CB51D63B80E5877BFB37C361F805F85B41D9B1B65E71B7EE3F7D0DA48EB0476048F58592A1B3B4C491DF80953F214EA940F64F257CE59B6C3CC5E81B0C8BE0D638ADA47C6161031D57288A0D2B0BD8EDE671ACC2A34B97C420EEE9D9A7FFFFCACFE11009FA4CD17F7AA9E2F5820B767A03422174DB490FF88B4550249BA23FDD18114B80FC66AFAC67E99B1A2E6AE48EFE256537D6AE058347242727D12B8E5277AD157CAC042325E518BF00E2C239A2F878964D0A03F81A92BA946F623815623B14DA9D615F87C8CBD71795C82B1AF0C8160E7E541FE11707E02D6CC867FE645E5725907A1DA4DEF8928F9E025739D2B3E1D1FC9ECE3804D868F09EB9953A2402FE
answer = BA0D89B528884E4D29E270296E35B49CA929F17CD44B2C39F8D5B8E4072DA96D99B2589003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003B2E7295F805FBCDDEF7CB51D63B80E5877BFB37C361F805F85B41D9B1B65E71B7EE3F7D0DA48EB0476048F58592A1B3B4C491DF80953F214EA940F64F257CE59B6C3CC5E81B0C8BE0D638ADA47C6161031D57288A0D2B0BD8EDE671ACC2A34B97C420EEE9D9A7FFFFCACFE11009FA4CD17F7AA9E2F5820B767A03422174DB490FF88B4550249BA23FDD18114B80FC66AFAC67E99B1A2E6AE48EFE256537D6AE058347242727D12B8E5277AD157CAC042325E518BF00E2C239A2F878964D0A03F81A92BA946F623815623B14DA9D615F87C8CBD71795C82B1AF0C8160E7E541FE11707E02D6CC867FE645E5725907A1DA4DEF8928F9E025739D2B3E1D1FC9ECE3804D868F09EB9953A2402FE</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 28 88 4E 4D 29 E2 70 29 6E 35 B4 9C
0010 | A9 29 F1 7C D4 4B 2C 39 F8 D5 B8 E4 07 2D A9 6D
0020 | 99 B2 58 90 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 3B 2E 72 95 F8 05 FB CD DE F7 CB 51 D6 3B 80 E5
0140 | 87 7B FB 37 C3 61 F8 05 F8 5B 41 D9 B1 B6 5E 71
0150 | B7 EE 3F 7D 0D A4 8E B0 47 60 48 F5 85 92 A1 B3
0160 | B4 C4 91 DF 80 95 3F 21 4E A9 40 F6 4F 25 7C E5
0170 | 9B 6C 3C C5 E8 1B 0C 8B E0 D6 38 AD A4 7C 61 61
0180 | 03 1D 57 28 8A 0D 2B 0B D8 ED E6 71 AC C2 A3 4B
0190 | 97 C4 20 EE E9 D9 A7 FF FF CA CF E1 10 09 FA 4C
01A0 | D1 7F 7A A9 E2 F5 82 0B 76 7A 03 42 21 74 DB 49
01B0 | 0F F8 8B 45 50 24 9B A2 3F DD 18 11 4B 80 FC 66
01C0 | AF AC 67 E9 9B 1A 2E 6A E4 8E FE 25 65 37 D6 AE
01D0 | 05 83 47 24 27 27 D1 2B 8E 52 77 AD 15 7C AC 04
01E0 | 23 25 E5 18 BF 00 E2 C2 39 A2 F8 78 96 4D 0A 03
01F0 | F8 1A 92 BA 94 6F 62 38 15 62 3B 14 DA 9D 61 5F
0200 | 87 C8 CB D7 17 95 C8 2B 1A F0 C8 16 0E 7E 54 1F
0210 | E1 17 07 E0 2D 6C C8 67 FE 64 5E 57 25 90 7A 1D
0220 | A4 DE F8 92 8F 9E 02 57 39 D2 B3 E1 D1 FC 9E CE
0230 | 38 04 D8 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001003B2E7295F805FBCDDEF7CB51</code> <code>D63B80E5877BFB37C361F805F85B41D9</code> <code>B1B65E71B7EE3F7D0DA48EB0476048F5</code> <code>8592A1B3B4C491DF80953F214EA940F6</code> <code>4F257CE59B6C3CC5E81B0C8BE0D638AD</code> <code>A47C6161031D57288A0D2B0BD8EDE671</code> <code>ACC2A34B97C420EEE9D9A7FFFFCACFE1</code> <code>1009FA4CD17F7AA9E2F5820B767A0342</code> <code>2174DB490FF88B4550249BA23FDD1811</code> <code>4B80FC66AFAC67E99B1A2E6AE48EFE25</code> <code>6537D6AE058347242727D12B8E5277AD</code> <code>157CAC042325E518BF00E2C239A2F878</code> <code>964D0A03F81A92BA946F623815623B14</code> <code>DA9D615F87C8CBD71795C82B1AF0C816</code> <code>0E7E541FE11707E02D6CC867FE645E57</code> <code>25907A1DA4DEF8928F9E025739D2B3E1</code><br> <code>D1FC9ECE</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>3804D868</code> (1758987320 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = CA7C950A7B13539C1B15D7C925B633E09443816EEB405D6D7CDE839DACDAF36D46F5E55C10B4641E1C6A6DB6C978A56C3E5AC1D0A0F2F7B362C1BFD389DAAE0B9850221F0409803F127576933D41024CC136D13E600FA8E66898FB275257516C64B7CBD38F05B135ED1BB3E914107C801FC2D06FE66D9EB4C27F4A3B43C70D968A3C1D32C1545B3F24769C8D56DA5E0952B8F7B80C39F714A86D6351C6683102569572E334BECC49C39A9DFD944D16C904403EB0D5AFDEE8591C325E0D458B4EFE928B2451C63D61CFFDAA5F1FE3F9E0FEC5B7AC4FE20BB52113900B6797E9816924AE2E03C955CB2861D86A28B106DA118EE6DB7F35375648C999656AEE8B81</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 281CDAAE6557D5E257D98E5D1485E5070589BF2D9E1E3CDE744143802B6A1D61A8F837C961B99FF4C5DE220CC3A7AEC148231F4627AA4D6567B2677D16ACF20F76E11D8D6F3857BC4B58BE3EE65779C8F772D277278A9D949B45940576F48F36E85B50ED478E8C84A824A557FBF489E426FDA2DD4E2C8276C841CB611997D99A292387F179F06BD01C64503D9069BFFCAF3AB41E87CF53F5225995F242994079C7E904301A2EA62CC7CB2351B79AF4A8591382FEA9DECB055DA795F63391E952FBB038B5744FBB77BF16109498A0576B9820580A8936C034E993B6F1FE9E609F2E7EB1A1770ADF0DE0367C22CEDE66157ABF18094CFF33FFD51901D0C28C4519</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 28 88 4E 4D 29 E2 70 29 6E 35 B4 9C
0010 | A9 29 F1 7C D4 4B 2C 39 F8 D5 B8 E4 07 2D A9 6D
0020 | 99 B2 58 90 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 28 1C DA AE 65 57 D5 E2 57 D9 8E 5D 14 85 E5 07
0040 | 05 89 BF 2D 9E 1E 3C DE 74 41 43 80 2B 6A 1D 61
0050 | A8 F8 37 C9 61 B9 9F F4 C5 DE 22 0C C3 A7 AE C1
0060 | 48 23 1F 46 27 AA 4D 65 67 B2 67 7D 16 AC F2 0F
0070 | 76 E1 1D 8D 6F 38 57 BC 4B 58 BE 3E E6 57 79 C8
0080 | F7 72 D2 77 27 8A 9D 94 9B 45 94 05 76 F4 8F 36
0090 | E8 5B 50 ED 47 8E 8C 84 A8 24 A5 57 FB F4 89 E4
00A0 | 26 FD A2 DD 4E 2C 82 76 C8 41 CB 61 19 97 D9 9A
00B0 | 29 23 87 F1 79 F0 6B D0 1C 64 50 3D 90 69 BF FC
00C0 | AF 3A B4 1E 87 CF 53 F5 22 59 95 F2 42 99 40 79
00D0 | C7 E9 04 30 1A 2E A6 2C C7 CB 23 51 B7 9A F4 A8
00E0 | 59 13 82 FE A9 DE CB 05 5D A7 95 F6 33 91 E9 52
00F0 | FB B0 38 B5 74 4F BB 77 BF 16 10 94 98 A0 57 6B
0100 | 98 20 58 0A 89 36 C0 34 E9 93 B6 F1 FE 9E 60 9F
0110 | 2E 7E B1 A1 77 0A DF 0D E0 36 7C 22 CE DE 66 15
0120 | 7A BF 18 09 4C FF 33 FF D5 19 01 D0 C2 8C 45 19</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100281CDAAE6557D5E257D98E5D</code> <code>1485E5070589BF2D9E1E3CDE74414380</code> <code>2B6A1D61A8F837C961B99FF4C5DE220C</code> <code>C3A7AEC148231F4627AA4D6567B2677D</code> <code>16ACF20F76E11D8D6F3857BC4B58BE3E</code> <code>E65779C8F772D277278A9D949B459405</code> <code>76F48F36E85B50ED478E8C84A824A557</code> <code>FBF489E426FDA2DD4E2C8276C841CB61</code> <code>1997D99A292387F179F06BD01C64503D</code> <code>9069BFFCAF3AB41E87CF53F5225995F2</code> <code>42994079C7E904301A2EA62CC7CB2351</code> <code>B79AF4A8591382FEA9DECB055DA795F6</code> <code>3391E952FBB038B5744FBB77BF161094</code> <code>98A0576B9820580A8936C034E993B6F1</code> <code>FE9E609F2E7EB1A1770ADF0DE0367C22</code> <code>CEDE66157ABF18094CFF33FFD51901D0</code><br> <code>C28C4519</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436628884E4D29E270296E35B49CA929F17CD44B2C39F8D5B8E4072DA96D99B258900000000000000000FE000100281CDAAE6557D5E257D98E5D1485E5070589BF2D9E1E3CDE744143802B6A1D61A8F837C961B99FF4C5DE220CC3A7AEC148231F4627AA4D6567B2677D16ACF20F76E11D8D6F3857BC4B58BE3EE65779C8F772D277278A9D949B45940576F48F36E85B50ED478E8C84A824A557FBF489E426FDA2DD4E2C8276C841CB611997D99A292387F179F06BD01C64503D9069BFFCAF3AB41E87CF53F5225995F242994079C7E904301A2EA62CC7CB2351B79AF4A8591382FEA9DECB055DA795F63391E952FBB038B5744FBB77BF16109498A0576B9820580A8936C034E993B6F1FE9E609F2E7EB1A1770ADF0DE0367C22CEDE66157ABF18094CFF33FFD51901D0C28C4519
padding = 169EDB284B2E73659A876D36
tmp_aes_key = 638EF0B1EC3F78C7B5D19E081BA70DDE45AF088BA07AE51244FAF4DD26DFD20C
tmp_aes_iv = BFEA2A1852DC4D151339EC7C3C4CB02B4D62BCE99C205DECEAFF70E7BF5F7A2C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = DB7FA31BEAAB684033E51D43D2304601F4C301A2737DE41519C73CCCD4213E93985CE3444BAB8FDF668CF191977CC91FA4D68B98949118E9BF81D2FDA3989A6B7927DF1D86D3554D4A8178AE2D9E10A2D06F006B0BCBC8BC0579EC9D603B962DE5AB2EF27E2AF356C302E3A0A6CFC76BC26E352F789E12E1575C35D5C3C9C858491ABA6B2141C1E0CA9AC6B51D7FF6D9EF9BDC89CE66203B41EA5F2751396B8B4EFF6F7B8E6132FED468C0856618D25190B72C37DBADF8BEDF3442C3B04DB2449E738B5D7EF5CEDE206F20EA0E0FA3A0EAE0DF414F2F8C53B9E6BEA828B0552F92DFB2BF671120D2DA1499F39CFE9CF9D3A1BEA1DDA9BBCB655CF67C3AA9E88A2CCA5BB4E605D46B96C00F71E44E26DB788A1DD13B10530DD6380B1C23C8E3F05A16A9D3761C606ABB420A30A62D95450083C34F9A6EFD35E2D7360DD609A0C958C97DF046AE24FA7DAE2088481F2891</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 1B 0E 00 38 04 D8 68
0010 | 78 01 00 00 1F 5F 04 F5 28 88 4E 4D 29 E2 70 29
0020 | 6E 35 B4 9C A9 29 F1 7C D4 4B 2C 39 F8 D5 B8 E4
0030 | 07 2D A9 6D 99 B2 58 90 FE 50 01 00 DB 7F A3 1B
0040 | EA AB 68 40 33 E5 1D 43 D2 30 46 01 F4 C3 01 A2
0050 | 73 7D E4 15 19 C7 3C CC D4 21 3E 93 98 5C E3 44
0060 | 4B AB 8F DF 66 8C F1 91 97 7C C9 1F A4 D6 8B 98
0070 | 94 91 18 E9 BF 81 D2 FD A3 98 9A 6B 79 27 DF 1D
0080 | 86 D3 55 4D 4A 81 78 AE 2D 9E 10 A2 D0 6F 00 6B
0090 | 0B CB C8 BC 05 79 EC 9D 60 3B 96 2D E5 AB 2E F2
00A0 | 7E 2A F3 56 C3 02 E3 A0 A6 CF C7 6B C2 6E 35 2F
00B0 | 78 9E 12 E1 57 5C 35 D5 C3 C9 C8 58 49 1A BA 6B
00C0 | 21 41 C1 E0 CA 9A C6 B5 1D 7F F6 D9 EF 9B DC 89
00D0 | CE 66 20 3B 41 EA 5F 27 51 39 6B 8B 4E FF 6F 7B
00E0 | 8E 61 32 FE D4 68 C0 85 66 18 D2 51 90 B7 2C 37
00F0 | DB AD F8 BE DF 34 42 C3 B0 4D B2 44 9E 73 8B 5D
0100 | 7E F5 CE DE 20 6F 20 EA 0E 0F A3 A0 EA E0 DF 41
0110 | 4F 2F 8C 53 B9 E6 BE A8 28 B0 55 2F 92 DF B2 BF
0120 | 67 11 20 D2 DA 14 99 F3 9C FE 9C F9 D3 A1 BE A1
0130 | DD A9 BB CB 65 5C F6 7C 3A A9 E8 8A 2C CA 5B B4
0140 | E6 05 D4 6B 96 C0 0F 71 E4 4E 26 DB 78 8A 1D D1
0150 | 3B 10 53 0D D6 38 0B 1C 23 C8 E3 F0 5A 16 A9 D3
0160 | 76 1C 60 6A BB 42 0A 30 A6 2D 95 45 00 83 C3 4F
0170 | 9A 6E FD 35 E2 D7 36 0D D6 09 A0 C9 58 C9 7D F0
0180 | 46 AE 24 FA 7D AE 20 88 48 1F 28 91</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E41B0E003804D868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100DB7FA31BEAAB684033E51D43</code> <code>D2304601F4C301A2737DE41519C73CCC</code> <code>D4213E93985CE3444BAB8FDF668CF191</code> <code>977CC91FA4D68B98949118E9BF81D2FD</code> <code>A3989A6B7927DF1D86D3554D4A8178AE</code> <code>2D9E10A2D06F006B0BCBC8BC0579EC9D</code> <code>603B962DE5AB2EF27E2AF356C302E3A0</code> <code>A6CFC76BC26E352F789E12E1575C35D5</code> <code>C3C9C858491ABA6B2141C1E0CA9AC6B5</code> <code>1D7FF6D9EF9BDC89CE66203B41EA5F27</code> <code>51396B8B4EFF6F7B8E6132FED468C085</code> <code>6618D25190B72C37DBADF8BEDF3442C3</code> <code>B04DB2449E738B5D7EF5CEDE206F20EA</code> <code>0E0FA3A0EAE0DF414F2F8C53B9E6BEA8</code> <code>28B0552F92DFB2BF671120D2DA1499F3</code> <code>9CFE9CF9D3A1BEA1DDA9BBCB655CF67C</code> <code>3AA9E88A2CCA5BB4E605D46B96C00F71</code> <code>E44E26DB788A1DD13B10530DD6380B1C</code> <code>23C8E3F05A16A9D3761C606ABB420A30</code> <code>A62D95450083C34F9A6EFD35E2D7360D</code> <code>D609A0C958C97DF046AE24FA7DAE2088</code><br> <code>481F2891</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 5F2F7ACC7C64D6436C1E2A24DB60E8FC7D2C318EA9E0E23F0C636288F2F9689BBEEC6C04BD561428B2F450B63893BF80ED1F2DB62D027D61FAA2C34D2C92D4FE443A28FEBF5C8977B4D627D323CE699773F09C74B32FAC5934BEA30A9A53EBF58531ECB5000B90845AC9D4D2B2190FAD3E2531D1AAFE5EE551D26713667FF859449527B44729B9917DBD8B8A0EDBC426EA0EA6F0430EE3A2CB893D54F2264961CF91019BA61DA8992541AB0CA83F5812E6929A8D5BFF2469E369FE5993BA1F935156A0C9EF34AB355880CD0ED41269D97E111F3FC7623058089C8A5F6ABB0F580EA7E014C74AFBD7F5ACCDA0B877A7690BC0532413F2E77FF191D5C5AC42FD6D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 24 69 80 3A 04 D8 68
0010 | 34 00 00 00 34 F7 CB 3B 28 88 4E 4D 29 E2 70 29
0020 | 6E 35 B4 9C A9 29 F1 7C D4 4B 2C 39 F8 D5 B8 E4
0030 | 07 2D A9 6D 99 B2 58 90 05 F0 E2 B9 25 B8 B3 77
0040 | E9 33 A0 DA A1 5E 19 9F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>012469803A04D868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28884E4D29E270296E35B49CA929F17C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D44B2C39F8D5B8E4072DA96D99B25890</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>05F0E2B925B8B377E933A0DAA15E199F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

