<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E8 C8 09 00 54 C6 38 67
0010 | 14 00 00 00 F1 8E 7E BE D0 EA B0 A3 DD 8B 65 05
0020 | 20 F1 6A 47 11 72 C2 18</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E8C8090054C63867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 00 BF 54 C6 38 67
0010 | 50 00 00 00 63 24 16 05 D0 EA B0 A3 DD 8B 65 05
0020 | 20 F1 6A 47 11 72 C2 18 C0 92 69 C7 22 14 AE DD
0030 | E8 96 CA 82 5F 21 C7 3B 08 20 1D 4F 3A FE F4 5B
0040 | E7 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019400BF54C63867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08201D4F3AFEF45BE7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2314092898342427623</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2314092898342427623</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2314092898342427623 = 1188071597 * 1947772259</code></p>
<pre><code>p = 1188071597
q = 1947772259</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 1D 4F 3A FE F4 5B E7 00 00 00
0010 | 04 46 D0 88 AD 00 00 00 04 74 18 A5 63 00 00 00
0020 | D0 EA B0 A3 DD 8B 65 05 20 F1 6A 47 11 72 C2 18
0030 | C0 92 69 C7 22 14 AE DD E8 96 CA 82 5F 21 C7 3B
0040 | B2 CA 4D 77 45 C4 A3 34 E3 D5 D1 9A FA 62 30 B6
0050 | F7 87 FE 4B C0 FD 61 34 9D 1C A3 0B 30 28 26 61
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08201D4F3AFEF45BE7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2314092898342427623</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0446D088AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1188071597</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047418A563000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1947772259</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>B2CA4D7745C4A334E3D5D19AFA6230B6</code> <code>F787FE4BC0FD61349D1CA30B30282661</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908201D4F3AFEF45BE70000000446D088AD000000047418A563000000D0EAB0A3DD8B650520F16A471172C218C09269C72214AEDDE896CA825F21C73BB2CA4D7745C4A334E3D5D19AFA6230B6F787FE4BC0FD61349D1CA30B3028266102000000
random_padding_bytes = C5E87EBF5506A6686F2E82264FA171E50FE4FB4E2D02950EE5AF742425812DBF348FA2F4E069B4AF859B232D3791547FAE228003EC51FECAEF67C81C662181BE00D05A33056E7D65004C201557C9B53F33412E384EDA3A52D7F7FD60</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = AE78994C63A6468CCB77EF2AA90C3737395D6889544148F030B59841832FFDBCFA88B64408169C67FEE880042CAF2A1A6055756451472982A467D87F462F179C68760A3D746574881838ABFC14D20A9DE5DB97AA78629F13646B86D5AEDC344187858C0BD610218181007E75645CD2EC5F0EA93F1CA377CA0E0D23AC484E158C5BD779946A9A81ADDF01A3A58F022C805FE7FBA61504EE9E3FC29051D15D96925FE4908DC212A7F8B48B4359410DB6C71EEB6FE6C21EAAD5982C704490AFA8BC1AEF22DCB414E9374213164AACABB17CE3C05BABEBC47078641134B7D45C1991018E96197883FDEF4F65326A78C77C52662C45346591D94E8E3494AF747D1A55</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC C8 09 00 54 C6 38 67
0010 | 40 01 00 00 BE E4 12 D7 D0 EA B0 A3 DD 8B 65 05
0020 | 20 F1 6A 47 11 72 C2 18 C0 92 69 C7 22 14 AE DD
0030 | E8 96 CA 82 5F 21 C7 3B 04 46 D0 88 AD 00 00 00
0040 | 04 74 18 A5 63 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 AE 78 99 4C 63 A6 46 8C CB 77 EF 2A
0060 | A9 0C 37 37 39 5D 68 89 54 41 48 F0 30 B5 98 41
0070 | 83 2F FD BC FA 88 B6 44 08 16 9C 67 FE E8 80 04
0080 | 2C AF 2A 1A 60 55 75 64 51 47 29 82 A4 67 D8 7F
0090 | 46 2F 17 9C 68 76 0A 3D 74 65 74 88 18 38 AB FC
00A0 | 14 D2 0A 9D E5 DB 97 AA 78 62 9F 13 64 6B 86 D5
00B0 | AE DC 34 41 87 85 8C 0B D6 10 21 81 81 00 7E 75
00C0 | 64 5C D2 EC 5F 0E A9 3F 1C A3 77 CA 0E 0D 23 AC
00D0 | 48 4E 15 8C 5B D7 79 94 6A 9A 81 AD DF 01 A3 A5
00E0 | 8F 02 2C 80 5F E7 FB A6 15 04 EE 9E 3F C2 90 51
00F0 | D1 5D 96 92 5F E4 90 8D C2 12 A7 F8 B4 8B 43 59
0100 | 41 0D B6 C7 1E EB 6F E6 C2 1E AA D5 98 2C 70 44
0110 | 90 AF A8 BC 1A EF 22 DC B4 14 E9 37 42 13 16 4A
0120 | AC AB B1 7C E3 C0 5B AB EB C4 70 78 64 11 34 B7
0130 | D4 5C 19 91 01 8E 96 19 78 83 FD EF 4F 65 32 6A
0140 | 78 C7 7C 52 66 2C 45 34 65 91 D9 4E 8E 34 94 AF
0150 | 74 7D 1A 55</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>ECC8090054C63867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0446D088AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1188071597</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047418A563000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1947772259</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100AE78994C63A6468CCB77EF2A</code> <code>A90C3737395D6889544148F030B59841</code> <code>832FFDBCFA88B64408169C67FEE88004</code> <code>2CAF2A1A6055756451472982A467D87F</code> <code>462F179C68760A3D746574881838ABFC</code> <code>14D20A9DE5DB97AA78629F13646B86D5</code> <code>AEDC344187858C0BD610218181007E75</code> <code>645CD2EC5F0EA93F1CA377CA0E0D23AC</code> <code>484E158C5BD779946A9A81ADDF01A3A5</code> <code>8F022C805FE7FBA61504EE9E3FC29051</code> <code>D15D96925FE4908DC212A7F8B48B4359</code> <code>410DB6C71EEB6FE6C21EAAD5982C7044</code> <code>90AFA8BC1AEF22DCB414E9374213164A</code> <code>ACABB17CE3C05BABEBC47078641134B7</code> <code>D45C1991018E96197883FDEF4F65326A</code> <code>78C77C52662C45346591D94E8E3494AF</code><br> <code>747D1A55</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 34 61 DB 54 C6 38 67
0010 | 78 02 00 00 5C 07 E8 D0 D0 EA B0 A3 DD 8B 65 05
0020 | 20 F1 6A 47 11 72 C2 18 C0 92 69 C7 22 14 AE DD
0030 | E8 96 CA 82 5F 21 C7 3B FE 50 02 00 E2 81 79 2B
0040 | CD 6A 41 60 25 9D 11 31 C7 54 4C CF B5 64 6A AB
0050 | BE 8C 04 86 DF FD 11 F4 6E 8D 3F 09 CC 6A 72 63
0060 | FB 11 B8 5E 07 63 44 BE 2D 65 14 B7 00 E6 20 8C
0070 | 5F 52 27 75 29 50 A0 9C C5 2B 03 01 F7 13 71 C4
0080 | BF BC C8 90 99 29 42 A7 0D A9 B2 BD 81 01 37 6D
0090 | 5C 58 11 B6 03 BB 3D A5 FB A0 75 55 57 30 A2 B5
00A0 | EF 6C 5F 2F 50 26 10 25 26 52 0C 65 D7 CB 1B 01
00B0 | 88 3E BC E0 18 31 3C 49 49 01 95 D7 7B B1 53 79
00C0 | C8 C2 97 AB 55 17 54 39 96 C1 D5 9F 4E 98 D7 F4
00D0 | CA A4 68 59 D9 05 5A CA 8C 2F C6 77 B5 FC D4 52
00E0 | 90 24 96 64 FD F2 63 F8 2D F2 2C FF CF 6B FB 0C
00F0 | 5B 55 7C 03 BB 43 46 24 04 4D 65 4F 88 C8 6F B1
0100 | FB 7A 46 CA AF 33 41 12 01 35 7E F9 36 D8 1F C9
0110 | 03 BE CF 23 DF 13 74 FE 3C 8E EB C3 DA 01 B4 4D
0120 | 05 47 70 7F 44 54 D4 24 CC 76 A2 D0 82 57 38 2B
0130 | 95 AD CC 6E A6 3C F1 5F 36 50 84 D4 2A 64 F2 6E
0140 | 0A 0B 62 3E F4 F9 9A CE B1 33 22 CF 24 79 5C 50
0150 | B0 1C D9 40 37 DE 1A DD 31 76 6C 18 E9 7A FA BA
0160 | 5D 62 BC 9F C6 D0 F2 90 84 31 6D 7F 25 55 60 97
0170 | 3D D1 5D 08 4B 6B D8 D1 D5 65 F5 D0 0A 93 74 DF
0180 | 40 4A 28 DB CB F1 4F 95 4D C9 35 05 B4 68 3B D6
0190 | BF AF 79 7F 8B E5 E6 E6 09 A7 B4 FB F1 C3 6E A7
01A0 | 5F FF 8F 33 30 F5 61 6F 6D 72 7C CA 6A B8 40 A8
01B0 | 53 30 92 F2 12 92 91 3F B0 45 C0 1E A6 FB 0F 86
01C0 | 79 2E C4 50 D2 4F 1A 12 F4 21 B6 41 C8 35 1F DA
01D0 | E2 B3 A7 B2 E2 C0 D4 9C 93 5A 96 1E 8F 99 5B C8
01E0 | AB 14 B3 C4 06 50 20 95 8E FE 4F 2D C4 08 80 C7
01F0 | 68 A7 A9 5B 3D 61 5A D7 74 83 F6 DB E6 21 FE 58
0200 | 51 DD 21 5C C2 89 B4 23 8C 92 C9 C7 3B 3C F6 E8
0210 | 63 82 C2 F6 71 66 EE 1B BD E8 D9 A3 6B 6F D9 72
0220 | DD 4D E6 72 7A 9B 4F F4 79 C6 46 98 86 BA 70 1D
0230 | 85 15 6E D9 8D 62 4B 8B 09 60 0C 7F 64 69 C4 4D
0240 | 9C 8D F8 99 08 B9 7C 79 8F E0 A7 E7 A8 0A 15 80
0250 | 38 F5 0A 6C F0 3E 9F 93 4A 88 14 57 28 F1 4F 77
0260 | C8 39 FA 66 5E 42 B4 D3 68 FB A8 EE B9 FE 82 9D
0270 | 9D 2D 2D 2E 16 C8 FB 3F 17 AF 0B 02 00 1E 7B 19
0280 | EA EF 27 88 27 EA 54 2A 6F 62 D5 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013461DB54C63867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200E281792BCD6A4160259D1131</code> <code>C7544CCFB5646AABBE8C0486DFFD11F4</code> <code>6E8D3F09CC6A7263FB11B85E076344BE</code> <code>2D6514B700E6208C5F5227752950A09C</code> <code>C52B0301F71371C4BFBCC890992942A7</code> <code>0DA9B2BD8101376D5C5811B603BB3DA5</code> <code>FBA075555730A2B5EF6C5F2F50261025</code> <code>26520C65D7CB1B01883EBCE018313C49</code> <code>490195D77BB15379C8C297AB55175439</code> <code>96C1D59F4E98D7F4CAA46859D9055ACA</code> <code>8C2FC677B5FCD45290249664FDF263F8</code> <code>2DF22CFFCF6BFB0C5B557C03BB434624</code> <code>044D654F88C86FB1FB7A46CAAF334112</code> <code>01357EF936D81FC903BECF23DF1374FE</code> <code>3C8EEBC3DA01B44D0547707F4454D424</code> <code>CC76A2D08257382B95ADCC6EA63CF15F</code> <code>365084D42A64F26E0A0B623EF4F99ACE</code> <code>B13322CF24795C50B01CD94037DE1ADD</code> <code>31766C18E97AFABA5D62BC9FC6D0F290</code> <code>84316D7F255560973DD15D084B6BD8D1</code> <code>D565F5D00A9374DF404A28DBCBF14F95</code> <code>4DC93505B4683BD6BFAF797F8BE5E6E6</code> <code>09A7B4FBF1C36EA75FFF8F3330F5616F</code> <code>6D727CCA6AB840A8533092F21292913F</code> <code>B045C01EA6FB0F86792EC450D24F1A12</code> <code>F421B641C8351FDAE2B3A7B2E2C0D49C</code> <code>935A961E8F995BC8AB14B3C406502095</code> <code>8EFE4F2DC40880C768A7A95B3D615AD7</code> <code>7483F6DBE621FE5851DD215CC289B423</code> <code>8C92C9C73B3CF6E86382C2F67166EE1B</code> <code>BDE8D9A36B6FD972DD4DE6727A9B4FF4</code> <code>79C6469886BA701D85156ED98D624B8B</code> <code>09600C7F6469C44D9C8DF89908B97C79</code> <code>8FE0A7E7A80A158038F50A6CF03E9F93</code> <code>4A88145728F14F77C839FA665E42B4D3</code> <code>68FBA8EEB9FE829D9D2D2D2E16C8FB3F</code> <code>17AF0B02001E7B19EAEF278827EA542A</code><br> <code>6F62D500</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = E281792BCD6A4160259D1131C7544CCFB5646AABBE8C0486DFFD11F46E8D3F09CC6A7263FB11B85E076344BE2D6514B700E6208C5F5227752950A09CC52B0301F71371C4BFBCC890992942A70DA9B2BD8101376D5C5811B603BB3DA5FBA075555730A2B5EF6C5F2F5026102526520C65D7CB1B01883EBCE018313C49490195D77BB15379C8C297AB5517543996C1D59F4E98D7F4CAA46859D9055ACA8C2FC677B5FCD45290249664FDF263F82DF22CFFCF6BFB0C5B557C03BB434624044D654F88C86FB1FB7A46CAAF33411201357EF936D81FC903BECF23DF1374FE3C8EEBC3DA01B44D0547707F4454D424CC76A2D08257382B95ADCC6EA63CF15F365084D42A64F26E0A0B623EF4F99ACEB13322CF24795C50B01CD94037DE1ADD31766C18E97AFABA5D62BC9FC6D0F29084316D7F255560973DD15D084B6BD8D1D565F5D00A9374DF404A28DBCBF14F954DC93505B4683BD6BFAF797F8BE5E6E609A7B4FBF1C36EA75FFF8F3330F5616F6D727CCA6AB840A8533092F21292913FB045C01EA6FB0F86792EC450D24F1A12F421B641C8351FDAE2B3A7B2E2C0D49C935A961E8F995BC8AB14B3C4065020958EFE4F2DC40880C768A7A95B3D615AD77483F6DBE621FE5851DD215CC289B4238C92C9C73B3CF6E86382C2F67166EE1BBDE8D9A36B6FD972DD4DE6727A9B4FF479C6469886BA701D85156ED98D624B8B09600C7F6469C44D9C8DF89908B97C798FE0A7E7A80A158038F50A6CF03E9F934A88145728F14F77C839FA665E42B4D368FBA8EEB9FE829D9D2D2D2E16C8FB3F17AF0B02001E7B19EAEF278827EA542A6F62D500
tmp_aes_key = 500A86A5C1A48EEC49A928D5A837894717D878F8DFD428AC0E1EAA0EA3BD6B7A
tmp_aes_iv = 8EB36DA465A02A0D27F18BEE711126529DC69B0284C784311B96AD1DB2CA4D77</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 4A53BA2E1CBA9F048BE7276F81F46EBF076CA782BA0D89B5D0EAB0A3DD8B650520F16A471172C218C09269C72214AEDDE896CA825F21C73B03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010074F465AF8A0A99C0B7A81E2E0049B0CFE4D6B9CE06F3D1874C7B11450CF8A756295506E52A55333DE8C730599FC24AD8A6D6D4300C361BF630993B1B07B03C24A18BFFE28CBCD486C4BDC7C6C457973884DB08581ABEAB4B35AF9734F25864E32CB12808ABBCBA839808DB177FF99108BE90A12D0B18D1675D1879D18B7591443A7AA724CD424AE70D7CAB61A09F9158C2ED3F2D5A8111B34CB2D35152B8079B6545919A970D188A07723F620DB7B039C7CAF59966C9018EDB4BF985A50F9D0F9A9E8ABE2E7E05EE6069CCB7FE20769ABC376355C73B3A67236AE23FF1AC2906EDAFFB58AB48D5FBE5903EED3723EF0EAEDFB7CC6FA2781052D654D4D38BEA5F54C6386712B103F824EADAAA
answer = BA0D89B5D0EAB0A3DD8B650520F16A471172C218C09269C72214AEDDE896CA825F21C73B03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010074F465AF8A0A99C0B7A81E2E0049B0CFE4D6B9CE06F3D1874C7B11450CF8A756295506E52A55333DE8C730599FC24AD8A6D6D4300C361BF630993B1B07B03C24A18BFFE28CBCD486C4BDC7C6C457973884DB08581ABEAB4B35AF9734F25864E32CB12808ABBCBA839808DB177FF99108BE90A12D0B18D1675D1879D18B7591443A7AA724CD424AE70D7CAB61A09F9158C2ED3F2D5A8111B34CB2D35152B8079B6545919A970D188A07723F620DB7B039C7CAF59966C9018EDB4BF985A50F9D0F9A9E8ABE2E7E05EE6069CCB7FE20769ABC376355C73B3A67236AE23FF1AC2906EDAFFB58AB48D5FBE5903EED3723EF0EAEDFB7CC6FA2781052D654D4D38BEA5F54C6386712B103F824EADAAA</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 D0 EA B0 A3 DD 8B 65 05 20 F1 6A 47
0010 | 11 72 C2 18 C0 92 69 C7 22 14 AE DD E8 96 CA 82
0020 | 5F 21 C7 3B 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 74 F4 65 AF 8A 0A 99 C0 B7 A8 1E 2E 00 49 B0 CF
0140 | E4 D6 B9 CE 06 F3 D1 87 4C 7B 11 45 0C F8 A7 56
0150 | 29 55 06 E5 2A 55 33 3D E8 C7 30 59 9F C2 4A D8
0160 | A6 D6 D4 30 0C 36 1B F6 30 99 3B 1B 07 B0 3C 24
0170 | A1 8B FF E2 8C BC D4 86 C4 BD C7 C6 C4 57 97 38
0180 | 84 DB 08 58 1A BE AB 4B 35 AF 97 34 F2 58 64 E3
0190 | 2C B1 28 08 AB BC BA 83 98 08 DB 17 7F F9 91 08
01A0 | BE 90 A1 2D 0B 18 D1 67 5D 18 79 D1 8B 75 91 44
01B0 | 3A 7A A7 24 CD 42 4A E7 0D 7C AB 61 A0 9F 91 58
01C0 | C2 ED 3F 2D 5A 81 11 B3 4C B2 D3 51 52 B8 07 9B
01D0 | 65 45 91 9A 97 0D 18 8A 07 72 3F 62 0D B7 B0 39
01E0 | C7 CA F5 99 66 C9 01 8E DB 4B F9 85 A5 0F 9D 0F
01F0 | 9A 9E 8A BE 2E 7E 05 EE 60 69 CC B7 FE 20 76 9A
0200 | BC 37 63 55 C7 3B 3A 67 23 6A E2 3F F1 AC 29 06
0210 | ED AF FB 58 AB 48 D5 FB E5 90 3E ED 37 23 EF 0E
0220 | AE DF B7 CC 6F A2 78 10 52 D6 54 D4 D3 8B EA 5F
0230 | 54 C6 38 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010074F465AF8A0A99C0B7A81E2E</code> <code>0049B0CFE4D6B9CE06F3D1874C7B1145</code> <code>0CF8A756295506E52A55333DE8C73059</code> <code>9FC24AD8A6D6D4300C361BF630993B1B</code> <code>07B03C24A18BFFE28CBCD486C4BDC7C6</code> <code>C457973884DB08581ABEAB4B35AF9734</code> <code>F25864E32CB12808ABBCBA839808DB17</code> <code>7FF99108BE90A12D0B18D1675D1879D1</code> <code>8B7591443A7AA724CD424AE70D7CAB61</code> <code>A09F9158C2ED3F2D5A8111B34CB2D351</code> <code>52B8079B6545919A970D188A07723F62</code> <code>0DB7B039C7CAF59966C9018EDB4BF985</code> <code>A50F9D0F9A9E8ABE2E7E05EE6069CCB7</code> <code>FE20769ABC376355C73B3A67236AE23F</code> <code>F1AC2906EDAFFB58AB48D5FBE5903EED</code> <code>3723EF0EAEDFB7CC6FA2781052D654D4</code><br> <code>D38BEA5F</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>54C63867</code> (1731774036 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A6ABCBD417FA6C159FFB432FBB05DD071B682017A8ABAF34E147C7077B20B02180874DD787665AB2E39FAF96768F7546FC772DFC798D795A5D8EED4EB10B5A52E945E21C7EEA23C955B08B69FE8263F4726391DDC10D9BC7CC86CBF60E295EAE23C8D20564F192980B40E814FC23E4680244D7B42177CE5269B07E027E630D3F5D1B7173459D83BE1BDF9A8994D0CE622A5B6A697C67F0182D6433373EE0429F981D66F58FC5A6C3FB2202994DF5E2674AF29EE33D5758E6450D10EE404AC5464FEF64F198028227A7D47F3337AEE6FD89391435A7F0A8E6207EC168BB9D1AA63701F1C9676E7326D8931AA0FABF7952E74A3E743DD8EA17F7181DA97AAE607F</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 3F605D936EFF386D9C76675E7FB4C11BB7AD14B6DAEF74F08307983308C7D60C9672A47322ECDF49A11D7E898694017245D5FE5558DE4EBDD536D4CEBC7EE0DEF85DAC6CA59701F211ABBB86039432D6F3858F0388E26621631C305A4E674631D28A2C8E31499DE7A1F510E10F80D2CF03DE486699E641640A9CBFF22E3CDAFF048F360E878E4D906721A1FFF6B6089DD96C5761090814BBD4F9293388ED3AB6C88ED10462F957DB51E702846E7A5967BFDE86C28D1E3624A92A65E7879CC216F54807DEC6AF6E261DB0CEA9AF6DD654108ADB690ECAB6FE2E4D667F5CFF456A66DD007F62D1BBE7BF3DD18D5CAE1EDF0D48FB51ECA0E7DF2302218612B28DB1</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 D0 EA B0 A3 DD 8B 65 05 20 F1 6A 47
0010 | 11 72 C2 18 C0 92 69 C7 22 14 AE DD E8 96 CA 82
0020 | 5F 21 C7 3B 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 3F 60 5D 93 6E FF 38 6D 9C 76 67 5E 7F B4 C1 1B
0040 | B7 AD 14 B6 DA EF 74 F0 83 07 98 33 08 C7 D6 0C
0050 | 96 72 A4 73 22 EC DF 49 A1 1D 7E 89 86 94 01 72
0060 | 45 D5 FE 55 58 DE 4E BD D5 36 D4 CE BC 7E E0 DE
0070 | F8 5D AC 6C A5 97 01 F2 11 AB BB 86 03 94 32 D6
0080 | F3 85 8F 03 88 E2 66 21 63 1C 30 5A 4E 67 46 31
0090 | D2 8A 2C 8E 31 49 9D E7 A1 F5 10 E1 0F 80 D2 CF
00A0 | 03 DE 48 66 99 E6 41 64 0A 9C BF F2 2E 3C DA FF
00B0 | 04 8F 36 0E 87 8E 4D 90 67 21 A1 FF F6 B6 08 9D
00C0 | D9 6C 57 61 09 08 14 BB D4 F9 29 33 88 ED 3A B6
00D0 | C8 8E D1 04 62 F9 57 DB 51 E7 02 84 6E 7A 59 67
00E0 | BF DE 86 C2 8D 1E 36 24 A9 2A 65 E7 87 9C C2 16
00F0 | F5 48 07 DE C6 AF 6E 26 1D B0 CE A9 AF 6D D6 54
0100 | 10 8A DB 69 0E CA B6 FE 2E 4D 66 7F 5C FF 45 6A
0110 | 66 DD 00 7F 62 D1 BB E7 BF 3D D1 8D 5C AE 1E DF
0120 | 0D 48 FB 51 EC A0 E7 DF 23 02 21 86 12 B2 8D B1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001003F605D936EFF386D9C76675E</code> <code>7FB4C11BB7AD14B6DAEF74F083079833</code> <code>08C7D60C9672A47322ECDF49A11D7E89</code> <code>8694017245D5FE5558DE4EBDD536D4CE</code> <code>BC7EE0DEF85DAC6CA59701F211ABBB86</code> <code>039432D6F3858F0388E26621631C305A</code> <code>4E674631D28A2C8E31499DE7A1F510E1</code> <code>0F80D2CF03DE486699E641640A9CBFF2</code> <code>2E3CDAFF048F360E878E4D906721A1FF</code> <code>F6B6089DD96C5761090814BBD4F92933</code> <code>88ED3AB6C88ED10462F957DB51E70284</code> <code>6E7A5967BFDE86C28D1E3624A92A65E7</code> <code>879CC216F54807DEC6AF6E261DB0CEA9</code> <code>AF6DD654108ADB690ECAB6FE2E4D667F</code> <code>5CFF456A66DD007F62D1BBE7BF3DD18D</code> <code>5CAE1EDF0D48FB51ECA0E7DF23022186</code><br> <code>12B28DB1</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366D0EAB0A3DD8B650520F16A471172C218C09269C72214AEDDE896CA825F21C73B0000000000000000FE0001003F605D936EFF386D9C76675E7FB4C11BB7AD14B6DAEF74F08307983308C7D60C9672A47322ECDF49A11D7E898694017245D5FE5558DE4EBDD536D4CEBC7EE0DEF85DAC6CA59701F211ABBB86039432D6F3858F0388E26621631C305A4E674631D28A2C8E31499DE7A1F510E10F80D2CF03DE486699E641640A9CBFF22E3CDAFF048F360E878E4D906721A1FFF6B6089DD96C5761090814BBD4F9293388ED3AB6C88ED10462F957DB51E702846E7A5967BFDE86C28D1E3624A92A65E7879CC216F54807DEC6AF6E261DB0CEA9AF6DD654108ADB690ECAB6FE2E4D667F5CFF456A66DD007F62D1BBE7BF3DD18D5CAE1EDF0D48FB51ECA0E7DF2302218612B28DB1
padding = F5F54C8514CD77126DDC1E4C
tmp_aes_key = 500A86A5C1A48EEC49A928D5A837894717D878F8DFD428AC0E1EAA0EA3BD6B7A
tmp_aes_iv = 8EB36DA465A02A0D27F18BEE711126529DC69B0284C784311B96AD1DB2CA4D77</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = A1F4A83C8780B80101ABDA0E06C2E2932D1415FE92FC7CF3F25D497874AD7A02ED8829D800EF7EAB113E82D10770011869B10E1F8B9EDF7FF68E4F5E504E04C70C371D413F46B6FC836483040A4425E496437EFBC696D95533EE4F2EFD0C1DCFA47191BA84C5FE9BBB280D2198DE3E88D3273649569624A227AA6071751168B624EAAA3CE806173DD7CF21D1BF3901FEBB1F860F6B58DA71D68A1E8508587398CCE741D01208EA694B50E43C06482953D06A438049D7BCC3D2ED085CB82DCFF4B6989710022C8E8E4F9D85FFF86FDD0EC2C9C1264E886B822FA3B948243AEE937B2EECDF4A3E76A809604A2C1C24C70BD489B357E1588DEEE15BB1432677EFD417635A2CFBAB57BAD640E78FFA6C404B3C7426A77DC9B237808A3A65457C317B98C242B8A801289B68EC67577F883932AA29C170A138A3F9369FFCABFE770874D034BDC98073FB0EAF48520FA8964E67</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 C8 09 00 54 C6 38 67
0010 | 78 01 00 00 1F 5F 04 F5 D0 EA B0 A3 DD 8B 65 05
0020 | 20 F1 6A 47 11 72 C2 18 C0 92 69 C7 22 14 AE DD
0030 | E8 96 CA 82 5F 21 C7 3B FE 50 01 00 A1 F4 A8 3C
0040 | 87 80 B8 01 01 AB DA 0E 06 C2 E2 93 2D 14 15 FE
0050 | 92 FC 7C F3 F2 5D 49 78 74 AD 7A 02 ED 88 29 D8
0060 | 00 EF 7E AB 11 3E 82 D1 07 70 01 18 69 B1 0E 1F
0070 | 8B 9E DF 7F F6 8E 4F 5E 50 4E 04 C7 0C 37 1D 41
0080 | 3F 46 B6 FC 83 64 83 04 0A 44 25 E4 96 43 7E FB
0090 | C6 96 D9 55 33 EE 4F 2E FD 0C 1D CF A4 71 91 BA
00A0 | 84 C5 FE 9B BB 28 0D 21 98 DE 3E 88 D3 27 36 49
00B0 | 56 96 24 A2 27 AA 60 71 75 11 68 B6 24 EA AA 3C
00C0 | E8 06 17 3D D7 CF 21 D1 BF 39 01 FE BB 1F 86 0F
00D0 | 6B 58 DA 71 D6 8A 1E 85 08 58 73 98 CC E7 41 D0
00E0 | 12 08 EA 69 4B 50 E4 3C 06 48 29 53 D0 6A 43 80
00F0 | 49 D7 BC C3 D2 ED 08 5C B8 2D CF F4 B6 98 97 10
0100 | 02 2C 8E 8E 4F 9D 85 FF F8 6F DD 0E C2 C9 C1 26
0110 | 4E 88 6B 82 2F A3 B9 48 24 3A EE 93 7B 2E EC DF
0120 | 4A 3E 76 A8 09 60 4A 2C 1C 24 C7 0B D4 89 B3 57
0130 | E1 58 8D EE E1 5B B1 43 26 77 EF D4 17 63 5A 2C
0140 | FB AB 57 BA D6 40 E7 8F FA 6C 40 4B 3C 74 26 A7
0150 | 7D C9 B2 37 80 8A 3A 65 45 7C 31 7B 98 C2 42 B8
0160 | A8 01 28 9B 68 EC 67 57 7F 88 39 32 AA 29 C1 70
0170 | A1 38 A3 F9 36 9F FC AB FE 77 08 74 D0 34 BD C9
0180 | 80 73 FB 0E AF 48 52 0F A8 96 4E 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0C8090054C63867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100A1F4A83C8780B80101ABDA0E</code> <code>06C2E2932D1415FE92FC7CF3F25D4978</code> <code>74AD7A02ED8829D800EF7EAB113E82D1</code> <code>0770011869B10E1F8B9EDF7FF68E4F5E</code> <code>504E04C70C371D413F46B6FC83648304</code> <code>0A4425E496437EFBC696D95533EE4F2E</code> <code>FD0C1DCFA47191BA84C5FE9BBB280D21</code> <code>98DE3E88D3273649569624A227AA6071</code> <code>751168B624EAAA3CE806173DD7CF21D1</code> <code>BF3901FEBB1F860F6B58DA71D68A1E85</code> <code>08587398CCE741D01208EA694B50E43C</code> <code>06482953D06A438049D7BCC3D2ED085C</code> <code>B82DCFF4B6989710022C8E8E4F9D85FF</code> <code>F86FDD0EC2C9C1264E886B822FA3B948</code> <code>243AEE937B2EECDF4A3E76A809604A2C</code> <code>1C24C70BD489B357E1588DEEE15BB143</code> <code>2677EFD417635A2CFBAB57BAD640E78F</code> <code>FA6C404B3C7426A77DC9B237808A3A65</code> <code>457C317B98C242B8A801289B68EC6757</code> <code>7F883932AA29C170A138A3F9369FFCAB</code> <code>FE770874D034BDC98073FB0EAF48520F</code><br> <code>A8964E67</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7FFA424A0AE8CA013E1B7E2262787C0B74E3FE5DAEEEA186CE7C41D0A30A8CFFDA573647EBB3E9D68A8721C9B27827F526E4947A615FAB99942021FF064AF40640F457CCE7ADC563627C18C208B6456236ABF860A1A183C1459912CE3F50E7A7CE66702D579B522434E84201FCD40920E681717ECDADD7ADB99BE04414C55F9D5D1CAC8DC1CEF71FE297FB5CE2088D3B9A2EDEE8CA245305F79C6FEDEB75A69894EB704484BDD16F9ECCF2E13C234AD18EB7B4B1B31CA70B154E89D2DAB2EEDF526AB4581CD5F855E2E00FD6948EA6874C77E765C2F2380FCFFCECDDA456E073CC20CEFDA42B07172F7E1DE433DE0A8D17D5F4BDBDCBC57CDA1892538026F2B0</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 04 44 ED 55 C6 38 67
0010 | 34 00 00 00 34 F7 CB 3B D0 EA B0 A3 DD 8B 65 05
0020 | 20 F1 6A 47 11 72 C2 18 C0 92 69 C7 22 14 AE DD
0030 | E8 96 CA 82 5F 21 C7 3B 3B 1F 8E B5 FD 3E F1 D7
0040 | 3F D8 D5 4B DC 95 12 EA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>010444ED55C63867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D0EAB0A3DD8B650520F16A471172C218</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C09269C72214AEDDE896CA825F21C73B</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>3B1F8EB5FD3EF1D73FD8D54BDC9512EA</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

