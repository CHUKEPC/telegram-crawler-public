<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B4 77 06 00 20 AD D6 68
0010 | 14 00 00 00 F1 8E 7E BE 91 CF 35 69 18 22 E1 CE
0020 | 62 93 C5 C2 81 B2 7B 39</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B477060020ADD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 AC 8B DD 20 AD D6 68
0010 | 50 00 00 00 63 24 16 05 91 CF 35 69 18 22 E1 CE
0020 | 62 93 C5 C2 81 B2 7B 39 C5 BA DE 56 99 67 4B 3C
0030 | 54 08 73 75 E2 32 1A DF 08 1A 23 E2 AB D1 D8 98
0040 | 6B 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01AC8BDD20ADD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081A23E2ABD1D8986B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1883598296758917227</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1883598296758917227</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1883598296758917227 = 1357711217 * 1387333531</code></p>
<pre><code>p = 1357711217
q = 1387333531</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1A 23 E2 AB D1 D8 98 6B 00 00 00
0010 | 04 50 ED 07 71 00 00 00 04 52 B1 07 9B 00 00 00
0020 | 91 CF 35 69 18 22 E1 CE 62 93 C5 C2 81 B2 7B 39
0030 | C5 BA DE 56 99 67 4B 3C 54 08 73 75 E2 32 1A DF
0040 | 9B D1 A3 18 11 A9 70 9D 62 E9 62 5C 07 5A B1 09
0050 | B5 7F DC 70 77 71 A7 04 C5 9C A5 01 BC 93 63 74
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081A23E2ABD1D8986B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1883598296758917227</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0450ED0771000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1357711217</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0452B1079B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1387333531</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>9BD1A31811A9709D62E9625C075AB109</code> <code>B57FDC707771A704C59CA501BC936374</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081A23E2ABD1D8986B0000000450ED07710000000452B1079B00000091CF35691822E1CE6293C5C281B27B39C5BADE5699674B3C54087375E2321ADF9BD1A31811A9709D62E9625C075AB109B57FDC707771A704C59CA501BC93637402000000
random_padding_bytes = BA3D82B6536C977FE8FD5DF71B90FB44A062C913F4B65C6ED7711CA801FCADB2F9FE610A5F0325007AED491D69FFCD709F891CFC51CEBE8122C8BEB61AF6379E8081D78B39AC9C52946EDF5D285A601FF47461A3E1785E24D085C4A5</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 3D6D988CD184EDADB57291666D970C4761B2DE5AAD7A324445E68B2E45CAF103CFCE53FE6E8D7BBC91D35EE2ABE0426ECF7430CC71F7EBD502FE8087C980CB4F3CBB68A1A1F420F668AC6F7C840C90954574200E89A259128D0B0ED689567A070BE9FAA6A8DDE6AAF8C5B8978BE656F6B71FEAD452E9DC5704B1E1F13AA0DD4FC238D6E7FF7050E206F5AEDC366F2AA4FF7E7D0685C1ABFFAFA71F3AF231F35674DE52C45BDF10AF76344137A3FF6F741BA7DCDAE6D96A411B029EB51310A557A66EB5D673CEC2B3AD244449FE29F00E9DCFAE80C5902D04B39BC58BFC4EC94EE11E5D4713DAC89C0502CCBD5886E8EFF6ADA7C3F0FD6106F55AAD713B1C2BA8</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 4C 10 0B 00 20 AD D6 68
0010 | 40 01 00 00 BE E4 12 D7 91 CF 35 69 18 22 E1 CE
0020 | 62 93 C5 C2 81 B2 7B 39 C5 BA DE 56 99 67 4B 3C
0030 | 54 08 73 75 E2 32 1A DF 04 50 ED 07 71 00 00 00
0040 | 04 52 B1 07 9B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 3D 6D 98 8C D1 84 ED AD B5 72 91 66
0060 | 6D 97 0C 47 61 B2 DE 5A AD 7A 32 44 45 E6 8B 2E
0070 | 45 CA F1 03 CF CE 53 FE 6E 8D 7B BC 91 D3 5E E2
0080 | AB E0 42 6E CF 74 30 CC 71 F7 EB D5 02 FE 80 87
0090 | C9 80 CB 4F 3C BB 68 A1 A1 F4 20 F6 68 AC 6F 7C
00A0 | 84 0C 90 95 45 74 20 0E 89 A2 59 12 8D 0B 0E D6
00B0 | 89 56 7A 07 0B E9 FA A6 A8 DD E6 AA F8 C5 B8 97
00C0 | 8B E6 56 F6 B7 1F EA D4 52 E9 DC 57 04 B1 E1 F1
00D0 | 3A A0 DD 4F C2 38 D6 E7 FF 70 50 E2 06 F5 AE DC
00E0 | 36 6F 2A A4 FF 7E 7D 06 85 C1 AB FF AF A7 1F 3A
00F0 | F2 31 F3 56 74 DE 52 C4 5B DF 10 AF 76 34 41 37
0100 | A3 FF 6F 74 1B A7 DC DA E6 D9 6A 41 1B 02 9E B5
0110 | 13 10 A5 57 A6 6E B5 D6 73 CE C2 B3 AD 24 44 49
0120 | FE 29 F0 0E 9D CF AE 80 C5 90 2D 04 B3 9B C5 8B
0130 | FC 4E C9 4E E1 1E 5D 47 13 DA C8 9C 05 02 CC BD
0140 | 58 86 E8 EF F6 AD A7 C3 F0 FD 61 06 F5 5A AD 71
0150 | 3B 1C 2B A8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>4C100B0020ADD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0450ED0771000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1357711217</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0452B1079B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1387333531</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001003D6D988CD184EDADB5729166</code> <code>6D970C4761B2DE5AAD7A324445E68B2E</code> <code>45CAF103CFCE53FE6E8D7BBC91D35EE2</code> <code>ABE0426ECF7430CC71F7EBD502FE8087</code> <code>C980CB4F3CBB68A1A1F420F668AC6F7C</code> <code>840C90954574200E89A259128D0B0ED6</code> <code>89567A070BE9FAA6A8DDE6AAF8C5B897</code> <code>8BE656F6B71FEAD452E9DC5704B1E1F1</code> <code>3AA0DD4FC238D6E7FF7050E206F5AEDC</code> <code>366F2AA4FF7E7D0685C1ABFFAFA71F3A</code> <code>F231F35674DE52C45BDF10AF76344137</code> <code>A3FF6F741BA7DCDAE6D96A411B029EB5</code> <code>1310A557A66EB5D673CEC2B3AD244449</code> <code>FE29F00E9DCFAE80C5902D04B39BC58B</code> <code>FC4EC94EE11E5D4713DAC89C0502CCBD</code> <code>5886E8EFF6ADA7C3F0FD6106F55AAD71</code><br> <code>3B1C2BA8</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 28 29 10 21 AD D6 68
0010 | 78 02 00 00 5C 07 E8 D0 91 CF 35 69 18 22 E1 CE
0020 | 62 93 C5 C2 81 B2 7B 39 C5 BA DE 56 99 67 4B 3C
0030 | 54 08 73 75 E2 32 1A DF FE 50 02 00 88 91 67 D4
0040 | 81 FE 3C 8D 85 B3 C4 CC 44 CD 3D CF 2B 46 BF B3
0050 | 0C 0C 7F A5 77 99 FC 5A 6F D9 BE 29 A1 A6 F6 02
0060 | BD DB B1 63 9F 1E E0 5A 96 C8 B0 CB E9 BA 97 1F
0070 | CC 4C 3A 38 FB 13 14 1B 30 D9 B0 B9 C5 21 E9 85
0080 | 08 41 4B C7 CF B0 BB 30 B3 51 BD 3B 0A CD 08 22
0090 | DB 1F 98 BC 8A DE FE 95 F9 82 94 67 2D 64 28 61
00A0 | 3B 85 02 F7 20 E8 18 F3 A9 5A 44 AE 8E 4F 33 3C
00B0 | EA 0B EC 26 B0 8A CC 17 C0 04 16 B4 11 6B 26 39
00C0 | 4B 87 D8 2B 6C 70 FA 83 4C F4 A2 D8 CF 0D 1B 43
00D0 | 44 21 58 7E CB 22 32 B4 3E FC B4 15 CA 46 36 49
00E0 | A3 0E E8 54 E4 5D 7B 45 25 76 A9 63 31 DD 2E 8D
00F0 | 11 20 86 58 5E 9B BF 07 EB 54 FD F0 DA 6D CB 38
0100 | 38 7F 56 2C 76 AB E8 ED F0 80 02 3B E4 15 C5 2C
0110 | DF 18 D0 9F D4 AF BF 51 42 9D 1D CA FF D0 C2 11
0120 | 00 0E 84 8C B1 67 50 5E F5 7B A6 10 3C B3 14 4A
0130 | 92 EB BD C0 5D 57 07 07 C6 3E 8D 28 AF A0 DC AF
0140 | 51 12 A0 4D 2C D6 8E 24 D6 93 C0 31 CF BD CF CA
0150 | 55 F7 FC AF B0 0E F6 14 0E 9D 89 C8 42 3B 5D 9A
0160 | 23 8C C9 D0 65 56 A4 F3 45 83 4F 74 F6 11 99 D6
0170 | 7B E9 52 B2 86 57 7B A7 27 02 22 BD 17 15 70 E9
0180 | A4 7C FD 12 F4 C9 E5 3F 2B 93 1C BA A6 43 D8 8C
0190 | DF E9 1C 9C EA 50 D6 A7 3E 13 77 13 43 24 8F F5
01A0 | 81 D2 08 FA F2 9F 5B F5 4D 7B 81 D1 B9 4E 0D B6
01B0 | BD 71 73 B7 4D B8 F9 D9 EB 9E 73 7E 85 09 B6 CB
01C0 | 59 08 63 82 73 39 C2 D3 C2 FE CD 7C 3F 68 CB 90
01D0 | A2 67 77 9A 1C 6C 54 17 48 BC 87 DD 47 F7 4B 02
01E0 | 78 F0 C8 DE 0A 2E 7A 8D C5 29 84 83 5C 51 80 35
01F0 | 7A E2 59 4B D5 60 E2 DF 79 43 BC 0B 14 60 84 DA
0200 | 20 50 6E D4 3E F8 22 BC F1 A0 57 C5 41 08 73 DD
0210 | A6 C4 DD 7F 2A BA E3 2D 6B DA 4B C3 DA 0C C7 22
0220 | A8 41 9E B8 C8 1F AB 61 A8 3C B2 5C 26 99 9A 7D
0230 | 26 6A 70 AC 5D E3 E5 A6 9D 99 6C 9A 65 F1 22 5D
0240 | 20 BF F3 CC ED E3 F4 E0 39 7B 5D B3 CE 3F E1 CF
0250 | 2C 0D 5D 45 45 87 12 F8 65 1F DC 7E 5C 2C 62 42
0260 | FE D5 2F 03 BD E9 DA 9D 0D CB 29 63 08 9C 21 98
0270 | D0 72 66 D9 BB 48 79 9F 0A 35 5F B3 6D C4 B6 D4
0280 | EF 98 D6 F7 77 27 A6 6A 8B 23 CA 9B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0128291021ADD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200889167D481FE3C8D85B3C4CC</code> <code>44CD3DCF2B46BFB30C0C7FA57799FC5A</code> <code>6FD9BE29A1A6F602BDDBB1639F1EE05A</code> <code>96C8B0CBE9BA971FCC4C3A38FB13141B</code> <code>30D9B0B9C521E98508414BC7CFB0BB30</code> <code>B351BD3B0ACD0822DB1F98BC8ADEFE95</code> <code>F98294672D6428613B8502F720E818F3</code> <code>A95A44AE8E4F333CEA0BEC26B08ACC17</code> <code>C00416B4116B26394B87D82B6C70FA83</code> <code>4CF4A2D8CF0D1B434421587ECB2232B4</code> <code>3EFCB415CA463649A30EE854E45D7B45</code> <code>2576A96331DD2E8D112086585E9BBF07</code> <code>EB54FDF0DA6DCB38387F562C76ABE8ED</code> <code>F080023BE415C52CDF18D09FD4AFBF51</code> <code>429D1DCAFFD0C211000E848CB167505E</code> <code>F57BA6103CB3144A92EBBDC05D570707</code> <code>C63E8D28AFA0DCAF5112A04D2CD68E24</code> <code>D693C031CFBDCFCA55F7FCAFB00EF614</code> <code>0E9D89C8423B5D9A238CC9D06556A4F3</code> <code>45834F74F61199D67BE952B286577BA7</code> <code>270222BD171570E9A47CFD12F4C9E53F</code> <code>2B931CBAA643D88CDFE91C9CEA50D6A7</code> <code>3E13771343248FF581D208FAF29F5BF5</code> <code>4D7B81D1B94E0DB6BD7173B74DB8F9D9</code> <code>EB9E737E8509B6CB590863827339C2D3</code> <code>C2FECD7C3F68CB90A267779A1C6C5417</code> <code>48BC87DD47F74B0278F0C8DE0A2E7A8D</code> <code>C52984835C5180357AE2594BD560E2DF</code> <code>7943BC0B146084DA20506ED43EF822BC</code> <code>F1A057C5410873DDA6C4DD7F2ABAE32D</code> <code>6BDA4BC3DA0CC722A8419EB8C81FAB61</code> <code>A83CB25C26999A7D266A70AC5DE3E5A6</code> <code>9D996C9A65F1225D20BFF3CCEDE3F4E0</code> <code>397B5DB3CE3FE1CF2C0D5D45458712F8</code> <code>651FDC7E5C2C6242FED52F03BDE9DA9D</code> <code>0DCB2963089C2198D07266D9BB48799F</code> <code>0A355FB36DC4B6D4EF98D6F77727A66A</code><br> <code>8B23CA9B</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 889167D481FE3C8D85B3C4CC44CD3DCF2B46BFB30C0C7FA57799FC5A6FD9BE29A1A6F602BDDBB1639F1EE05A96C8B0CBE9BA971FCC4C3A38FB13141B30D9B0B9C521E98508414BC7CFB0BB30B351BD3B0ACD0822DB1F98BC8ADEFE95F98294672D6428613B8502F720E818F3A95A44AE8E4F333CEA0BEC26B08ACC17C00416B4116B26394B87D82B6C70FA834CF4A2D8CF0D1B434421587ECB2232B43EFCB415CA463649A30EE854E45D7B452576A96331DD2E8D112086585E9BBF07EB54FDF0DA6DCB38387F562C76ABE8EDF080023BE415C52CDF18D09FD4AFBF51429D1DCAFFD0C211000E848CB167505EF57BA6103CB3144A92EBBDC05D570707C63E8D28AFA0DCAF5112A04D2CD68E24D693C031CFBDCFCA55F7FCAFB00EF6140E9D89C8423B5D9A238CC9D06556A4F345834F74F61199D67BE952B286577BA7270222BD171570E9A47CFD12F4C9E53F2B931CBAA643D88CDFE91C9CEA50D6A73E13771343248FF581D208FAF29F5BF54D7B81D1B94E0DB6BD7173B74DB8F9D9EB9E737E8509B6CB590863827339C2D3C2FECD7C3F68CB90A267779A1C6C541748BC87DD47F74B0278F0C8DE0A2E7A8DC52984835C5180357AE2594BD560E2DF7943BC0B146084DA20506ED43EF822BCF1A057C5410873DDA6C4DD7F2ABAE32D6BDA4BC3DA0CC722A8419EB8C81FAB61A83CB25C26999A7D266A70AC5DE3E5A69D996C9A65F1225D20BFF3CCEDE3F4E0397B5DB3CE3FE1CF2C0D5D45458712F8651FDC7E5C2C6242FED52F03BDE9DA9D0DCB2963089C2198D07266D9BB48799F0A355FB36DC4B6D4EF98D6F77727A66A8B23CA9B
tmp_aes_key = DD7279CD68BCA8CA463C908AEEFB46A753C98E2F1C3FFEB0F5BEB14863446880
tmp_aes_iv = 8091BFF941D1AA0847960F733717330C80139CB4AF9724FC324A47249BD1A318</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 0A6E736D17133D08A888F2558A9D71C8795C053CBA0D89B591CF35691822E1CE6293C5C281B27B39C5BADE5699674B3C54087375E2321ADF03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100561E4A0941FBDF42A86701892713242B9C779C976C3412CFF01A87B2FE5F220914359EEF451EFF43371C45778E5A8C9B34C704D06B2FF92BF21621F765DBB2B0717B679D6EE5D0D6FEA4C9CE06083BBE424A893D7F1A0206C5B630A2F507A889980FA5D3EBFD503E9F7E3DB4325B39B1D3F170A8397E462EE678F202E39D79955662291B41718ADCCA0080397AA04B1942AB0BF2A08888DFA0C4F6251F047680CEF2A1BA60A5180BB28D35FF374B5D036B30B77E503828B74E7603781BD57C20BDCAF50344A5541B2A6574F611A6F024F3DF1C79880D741E4E09258C7B7AB517B79B73AA7AE7B8D262811F990189CB45100F750DB7C65F0244AB5B860326C57C21ADD668DD89D39370A2286B
answer = BA0D89B591CF35691822E1CE6293C5C281B27B39C5BADE5699674B3C54087375E2321ADF03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100561E4A0941FBDF42A86701892713242B9C779C976C3412CFF01A87B2FE5F220914359EEF451EFF43371C45778E5A8C9B34C704D06B2FF92BF21621F765DBB2B0717B679D6EE5D0D6FEA4C9CE06083BBE424A893D7F1A0206C5B630A2F507A889980FA5D3EBFD503E9F7E3DB4325B39B1D3F170A8397E462EE678F202E39D79955662291B41718ADCCA0080397AA04B1942AB0BF2A08888DFA0C4F6251F047680CEF2A1BA60A5180BB28D35FF374B5D036B30B77E503828B74E7603781BD57C20BDCAF50344A5541B2A6574F611A6F024F3DF1C79880D741E4E09258C7B7AB517B79B73AA7AE7B8D262811F990189CB45100F750DB7C65F0244AB5B860326C57C21ADD668DD89D39370A2286B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 91 CF 35 69 18 22 E1 CE 62 93 C5 C2
0010 | 81 B2 7B 39 C5 BA DE 56 99 67 4B 3C 54 08 73 75
0020 | E2 32 1A DF 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 56 1E 4A 09 41 FB DF 42 A8 67 01 89 27 13 24 2B
0140 | 9C 77 9C 97 6C 34 12 CF F0 1A 87 B2 FE 5F 22 09
0150 | 14 35 9E EF 45 1E FF 43 37 1C 45 77 8E 5A 8C 9B
0160 | 34 C7 04 D0 6B 2F F9 2B F2 16 21 F7 65 DB B2 B0
0170 | 71 7B 67 9D 6E E5 D0 D6 FE A4 C9 CE 06 08 3B BE
0180 | 42 4A 89 3D 7F 1A 02 06 C5 B6 30 A2 F5 07 A8 89
0190 | 98 0F A5 D3 EB FD 50 3E 9F 7E 3D B4 32 5B 39 B1
01A0 | D3 F1 70 A8 39 7E 46 2E E6 78 F2 02 E3 9D 79 95
01B0 | 56 62 29 1B 41 71 8A DC CA 00 80 39 7A A0 4B 19
01C0 | 42 AB 0B F2 A0 88 88 DF A0 C4 F6 25 1F 04 76 80
01D0 | CE F2 A1 BA 60 A5 18 0B B2 8D 35 FF 37 4B 5D 03
01E0 | 6B 30 B7 7E 50 38 28 B7 4E 76 03 78 1B D5 7C 20
01F0 | BD CA F5 03 44 A5 54 1B 2A 65 74 F6 11 A6 F0 24
0200 | F3 DF 1C 79 88 0D 74 1E 4E 09 25 8C 7B 7A B5 17
0210 | B7 9B 73 AA 7A E7 B8 D2 62 81 1F 99 01 89 CB 45
0220 | 10 0F 75 0D B7 C6 5F 02 44 AB 5B 86 03 26 C5 7C
0230 | 21 AD D6 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100561E4A0941FBDF42A8670189</code> <code>2713242B9C779C976C3412CFF01A87B2</code> <code>FE5F220914359EEF451EFF43371C4577</code> <code>8E5A8C9B34C704D06B2FF92BF21621F7</code> <code>65DBB2B0717B679D6EE5D0D6FEA4C9CE</code> <code>06083BBE424A893D7F1A0206C5B630A2</code> <code>F507A889980FA5D3EBFD503E9F7E3DB4</code> <code>325B39B1D3F170A8397E462EE678F202</code> <code>E39D79955662291B41718ADCCA008039</code> <code>7AA04B1942AB0BF2A08888DFA0C4F625</code> <code>1F047680CEF2A1BA60A5180BB28D35FF</code> <code>374B5D036B30B77E503828B74E760378</code> <code>1BD57C20BDCAF50344A5541B2A6574F6</code> <code>11A6F024F3DF1C79880D741E4E09258C</code> <code>7B7AB517B79B73AA7AE7B8D262811F99</code> <code>0189CB45100F750DB7C65F0244AB5B86</code><br> <code>0326C57C</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>21ADD668</code> (1758899489 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 3C4481148FDA7F093A681B2EA532AF1C90D9FA751FFBA02908568044938EF20D53CD25C7B1161219A6F8A9A03BB650812975EA4E0FF732441D66336F6B7A0DCC22E739A828EFF8A48AEEEC677A8A766F6B6B6DE300E5DAD2AD60F17099E60740BC277C86E5CE0BBE6EB2C0D92ABDD68EC119A7ED826FF1978F125F7B9E7BA82AE0F167E33F38CAFC2B248E5AF0CAB8687E924B504F4866A261B66140BD1C87D10365B7E60EAA05CB5C3CB3B83A70DE73BDE3563901C7D0BCB11D60086025FE7AC1012EC620755EC3209D2F751B2AA60AAD2366817574CF4E1D78B0ED2DE72485729C5345650B7661BF9074585F87F32D3C34945DB3921FE6537F4B4F95AC8739</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 2C7BD96EDC7008C449B478E65DBB11EEE7A24B8A3BCF86DBAEDACD78EFCDDF0D46AB8E2E82C096F323A76221E871D814B0BB2E4CE8820FA0F0B40725C1C754516A7967822C5D27E5598B2ED00A3AE766350B27F3A508CB0D1E876A636D124E5816094CF0E4DF8533AE9F3A637C74B31803BC6C60FAF7800192708E63314064310CBEB4117030FB5E1117C662C758CA9B061159BD06162F390CDFD70DE525E965ED8E180615DC6E281357840824C4B5FBA797805EF34275AA3899EC89E2CCB729FA1DAC297084601339030B2E83F07EB812154E4B8E064C35FA9E3698438C763CDE8B3DBF0B53EF9ABDB6433C031FC88052539E75D39FEBC4401231BA4260C496</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 91 CF 35 69 18 22 E1 CE 62 93 C5 C2
0010 | 81 B2 7B 39 C5 BA DE 56 99 67 4B 3C 54 08 73 75
0020 | E2 32 1A DF 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 2C 7B D9 6E DC 70 08 C4 49 B4 78 E6 5D BB 11 EE
0040 | E7 A2 4B 8A 3B CF 86 DB AE DA CD 78 EF CD DF 0D
0050 | 46 AB 8E 2E 82 C0 96 F3 23 A7 62 21 E8 71 D8 14
0060 | B0 BB 2E 4C E8 82 0F A0 F0 B4 07 25 C1 C7 54 51
0070 | 6A 79 67 82 2C 5D 27 E5 59 8B 2E D0 0A 3A E7 66
0080 | 35 0B 27 F3 A5 08 CB 0D 1E 87 6A 63 6D 12 4E 58
0090 | 16 09 4C F0 E4 DF 85 33 AE 9F 3A 63 7C 74 B3 18
00A0 | 03 BC 6C 60 FA F7 80 01 92 70 8E 63 31 40 64 31
00B0 | 0C BE B4 11 70 30 FB 5E 11 17 C6 62 C7 58 CA 9B
00C0 | 06 11 59 BD 06 16 2F 39 0C DF D7 0D E5 25 E9 65
00D0 | ED 8E 18 06 15 DC 6E 28 13 57 84 08 24 C4 B5 FB
00E0 | A7 97 80 5E F3 42 75 AA 38 99 EC 89 E2 CC B7 29
00F0 | FA 1D AC 29 70 84 60 13 39 03 0B 2E 83 F0 7E B8
0100 | 12 15 4E 4B 8E 06 4C 35 FA 9E 36 98 43 8C 76 3C
0110 | DE 8B 3D BF 0B 53 EF 9A BD B6 43 3C 03 1F C8 80
0120 | 52 53 9E 75 D3 9F EB C4 40 12 31 BA 42 60 C4 96</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001002C7BD96EDC7008C449B478E6</code> <code>5DBB11EEE7A24B8A3BCF86DBAEDACD78</code> <code>EFCDDF0D46AB8E2E82C096F323A76221</code> <code>E871D814B0BB2E4CE8820FA0F0B40725</code> <code>C1C754516A7967822C5D27E5598B2ED0</code> <code>0A3AE766350B27F3A508CB0D1E876A63</code> <code>6D124E5816094CF0E4DF8533AE9F3A63</code> <code>7C74B31803BC6C60FAF7800192708E63</code> <code>314064310CBEB4117030FB5E1117C662</code> <code>C758CA9B061159BD06162F390CDFD70D</code> <code>E525E965ED8E180615DC6E2813578408</code> <code>24C4B5FBA797805EF34275AA3899EC89</code> <code>E2CCB729FA1DAC297084601339030B2E</code> <code>83F07EB812154E4B8E064C35FA9E3698</code> <code>438C763CDE8B3DBF0B53EF9ABDB6433C</code> <code>031FC88052539E75D39FEBC4401231BA</code><br> <code>4260C496</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436691CF35691822E1CE6293C5C281B27B39C5BADE5699674B3C54087375E2321ADF0000000000000000FE0001002C7BD96EDC7008C449B478E65DBB11EEE7A24B8A3BCF86DBAEDACD78EFCDDF0D46AB8E2E82C096F323A76221E871D814B0BB2E4CE8820FA0F0B40725C1C754516A7967822C5D27E5598B2ED00A3AE766350B27F3A508CB0D1E876A636D124E5816094CF0E4DF8533AE9F3A637C74B31803BC6C60FAF7800192708E63314064310CBEB4117030FB5E1117C662C758CA9B061159BD06162F390CDFD70DE525E965ED8E180615DC6E281357840824C4B5FBA797805EF34275AA3899EC89E2CCB729FA1DAC297084601339030B2E83F07EB812154E4B8E064C35FA9E3698438C763CDE8B3DBF0B53EF9ABDB6433C031FC88052539E75D39FEBC4401231BA4260C496
padding = 9CEB8ADEE335BFDC6B13E16F
tmp_aes_key = DD7279CD68BCA8CA463C908AEEFB46A753C98E2F1C3FFEB0F5BEB14863446880
tmp_aes_iv = 8091BFF941D1AA0847960F733717330C80139CB4AF9724FC324A47249BD1A318</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 2E4EDADDCC95DA68CB238421FE7F884051757C44A5ABF44AF13149BAEC0A7F38909CFA1978D957DBC0A4C9C536C202CAA7E5B32A26DBEC24DED76FDE9B292F5F8E149E41184E7B033C06F07698F146A6E6D87B3FB29B394F6561E95FDC4B68275A02FA39C9DD5363F635C19E93D7485BA5F38764C08655488BACA4C4D3B597C47DD3E1BA020FCA92D3B5AE7C33FC7EDA7995FC509745AD2A7D7EC0A9A4F4ACDA6A5AD53AD07A565588C12E33ED8EFCFD1E22BCE615EF3E707673BBCE4F00D9921F8B8696A4A6CBDBEFD223F4070DD793F83ECDE63B613FC7ED73A4BE07F6DCA791F69C6AB0406EEC7FF81E6B9622AA8B174BA3AD446999E4C562E75B316203A2D76604623AC62C9F72277FF2D226EA01CB5D2396406CBF6538CFA3DB79F01296EE92F902897F5414065D53C7FE34D9482002B580359FF12FD4FF673FC8C4297B48CCE0D9E8C4107A5EEB7CF90D705313</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 88 E8 04 00 21 AD D6 68
0010 | 78 01 00 00 1F 5F 04 F5 91 CF 35 69 18 22 E1 CE
0020 | 62 93 C5 C2 81 B2 7B 39 C5 BA DE 56 99 67 4B 3C
0030 | 54 08 73 75 E2 32 1A DF FE 50 01 00 2E 4E DA DD
0040 | CC 95 DA 68 CB 23 84 21 FE 7F 88 40 51 75 7C 44
0050 | A5 AB F4 4A F1 31 49 BA EC 0A 7F 38 90 9C FA 19
0060 | 78 D9 57 DB C0 A4 C9 C5 36 C2 02 CA A7 E5 B3 2A
0070 | 26 DB EC 24 DE D7 6F DE 9B 29 2F 5F 8E 14 9E 41
0080 | 18 4E 7B 03 3C 06 F0 76 98 F1 46 A6 E6 D8 7B 3F
0090 | B2 9B 39 4F 65 61 E9 5F DC 4B 68 27 5A 02 FA 39
00A0 | C9 DD 53 63 F6 35 C1 9E 93 D7 48 5B A5 F3 87 64
00B0 | C0 86 55 48 8B AC A4 C4 D3 B5 97 C4 7D D3 E1 BA
00C0 | 02 0F CA 92 D3 B5 AE 7C 33 FC 7E DA 79 95 FC 50
00D0 | 97 45 AD 2A 7D 7E C0 A9 A4 F4 AC DA 6A 5A D5 3A
00E0 | D0 7A 56 55 88 C1 2E 33 ED 8E FC FD 1E 22 BC E6
00F0 | 15 EF 3E 70 76 73 BB CE 4F 00 D9 92 1F 8B 86 96
0100 | A4 A6 CB DB EF D2 23 F4 07 0D D7 93 F8 3E CD E6
0110 | 3B 61 3F C7 ED 73 A4 BE 07 F6 DC A7 91 F6 9C 6A
0120 | B0 40 6E EC 7F F8 1E 6B 96 22 AA 8B 17 4B A3 AD
0130 | 44 69 99 E4 C5 62 E7 5B 31 62 03 A2 D7 66 04 62
0140 | 3A C6 2C 9F 72 27 7F F2 D2 26 EA 01 CB 5D 23 96
0150 | 40 6C BF 65 38 CF A3 DB 79 F0 12 96 EE 92 F9 02
0160 | 89 7F 54 14 06 5D 53 C7 FE 34 D9 48 20 02 B5 80
0170 | 35 9F F1 2F D4 FF 67 3F C8 C4 29 7B 48 CC E0 D9
0180 | E8 C4 10 7A 5E EB 7C F9 0D 70 53 13</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>88E8040021ADD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001002E4EDADDCC95DA68CB238421</code> <code>FE7F884051757C44A5ABF44AF13149BA</code> <code>EC0A7F38909CFA1978D957DBC0A4C9C5</code> <code>36C202CAA7E5B32A26DBEC24DED76FDE</code> <code>9B292F5F8E149E41184E7B033C06F076</code> <code>98F146A6E6D87B3FB29B394F6561E95F</code> <code>DC4B68275A02FA39C9DD5363F635C19E</code> <code>93D7485BA5F38764C08655488BACA4C4</code> <code>D3B597C47DD3E1BA020FCA92D3B5AE7C</code> <code>33FC7EDA7995FC509745AD2A7D7EC0A9</code> <code>A4F4ACDA6A5AD53AD07A565588C12E33</code> <code>ED8EFCFD1E22BCE615EF3E707673BBCE</code> <code>4F00D9921F8B8696A4A6CBDBEFD223F4</code> <code>070DD793F83ECDE63B613FC7ED73A4BE</code> <code>07F6DCA791F69C6AB0406EEC7FF81E6B</code> <code>9622AA8B174BA3AD446999E4C562E75B</code> <code>316203A2D76604623AC62C9F72277FF2</code> <code>D226EA01CB5D2396406CBF6538CFA3DB</code> <code>79F01296EE92F902897F5414065D53C7</code> <code>FE34D9482002B580359FF12FD4FF673F</code> <code>C8C4297B48CCE0D9E8C4107A5EEB7CF9</code><br> <code>0D705313</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 38A270EC1CA737225530466AE9D80A10F03286D52E31191C86E6620C0BC1A997EC242898E0D234809665BF9E1D56FAE3C07AF66D1E0C032BA67EAF58E0CC605C88A60389F0182E63FC8ECA2FC80157DCD5679CB725803160EAC271EA86A84BD82407D09D38BAAD8104996D6A21E3FBFEA4AFAB94F6A863DF622F6622891652022133A3DF2124ECD9657BEA075CF17052169EA58C7BF4FC72C8203F5E9092657629552258A0415C806598358DDBC79076B8FB4842EB512BABC1782CA37458DE7957CA5B342AC5ED90153712DC8C1548B15D55839243A2115F086B6482958BAA43FA58BD55DEC35ED15FB8E42607BF9093DDC0642D6687735730D20CF3C30E5B37</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D8 89 F2 22 AD D6 68
0010 | 34 00 00 00 34 F7 CB 3B 91 CF 35 69 18 22 E1 CE
0020 | 62 93 C5 C2 81 B2 7B 39 C5 BA DE 56 99 67 4B 3C
0030 | 54 08 73 75 E2 32 1A DF A8 09 91 57 40 2D AD EF
0040 | DD 2D A4 EB B6 17 F0 FC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D889F222ADD668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>91CF35691822E1CE6293C5C281B27B39</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>C5BADE5699674B3C54087375E2321ADF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>A8099157402DADEFDD2DA4EBB617F0FC</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

