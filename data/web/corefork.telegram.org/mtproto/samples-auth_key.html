<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A0 4C 02 00 44 29 B8 68
0010 | 14 00 00 00 F1 8E 7E BE D9 5F 60 F4 1F 1E 81 70
0020 | D5 CA A7 50 10 29 AC 54</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A04C02004429B868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 2C 6F 44 29 B8 68
0010 | 50 00 00 00 63 24 16 05 D9 5F 60 F4 1F 1E 81 70
0020 | D5 CA A7 50 10 29 AC 54 96 D6 38 8C 3A 07 FE 64
0030 | D4 2D F8 79 71 4B B4 18 08 24 68 6A F9 10 54 06
0040 | 19 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01982C6F4429B868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0824686AF910540619000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2623464400896656921</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2623464400896656921</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2623464400896656921 = 1334400233 * 1966025137</code></p>
<pre><code>p = 1334400233
q = 1966025137</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 24 68 6A F9 10 54 06 19 00 00 00
0010 | 04 4F 89 54 E9 00 00 00 04 75 2F 29 B1 00 00 00
0020 | D9 5F 60 F4 1F 1E 81 70 D5 CA A7 50 10 29 AC 54
0030 | 96 D6 38 8C 3A 07 FE 64 D4 2D F8 79 71 4B B4 18
0040 | D3 0B 81 94 A5 50 F8 5C E1 02 50 BC ED 84 A3 86
0050 | 39 D5 98 39 30 5B 37 88 E6 AE BC FC 37 53 A2 27
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0824686AF910540619000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2623464400896656921</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044F8954E9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1334400233</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04752F29B1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1966025137</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>D30B8194A550F85CE10250BCED84A386</code> <code>39D59839305B3788E6AEBCFC3753A227</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90824686AF910540619000000044F8954E900000004752F29B1000000D95F60F41F1E8170D5CAA7501029AC5496D6388C3A07FE64D42DF879714BB418D30B8194A550F85CE10250BCED84A38639D59839305B3788E6AEBCFC3753A22702000000
random_padding_bytes = CDD0905941FA55B97B7200FBD9D0044B12B76E67390EFFF6C9DF6B52DA5F601664FE846D793EAA36F988FE449ADCDBD5EF1F8B919C329AE782C076C97804945BBE1B8938ECD6E0AE26742B20DF392BFEE4A99A033B220E5BC8A06AD1</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D0E1ECF04ED0EF16E8B3DE3F1FB4CF519D105FC5DDD58B9096B4AC93F7FB03CBA30EFEA6A4093C6964AC7517F714A06D5F0503E44BF9314811714BE49DF57DCA590AB39A08A8081E7A784D3605EC9D32B9146B4641FA31381E044B95F21A30E46AE23A5A8F867739E108A671ABE91BF9B5BE52ED1864C6CED83AD7E545E5142D067A29E047B38FA8E12798A188C39ED736D7B7A8FC44017AED6A6903A4E4CB6DB8D80322BBDE87C1CACF15A0C503BDE76F2CB1F1E37FDD5098810D915C30249CA2AAE93689C322DBBB7D275911458F36CF2281F76C9755E58D291F5A6E24F69D405DC95D2AF3762396462ADE00EB35B49706A681D5C4D91488159702F74B1D78</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 68 00 0B 00 44 29 B8 68
0010 | 40 01 00 00 BE E4 12 D7 D9 5F 60 F4 1F 1E 81 70
0020 | D5 CA A7 50 10 29 AC 54 96 D6 38 8C 3A 07 FE 64
0030 | D4 2D F8 79 71 4B B4 18 04 4F 89 54 E9 00 00 00
0040 | 04 75 2F 29 B1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D0 E1 EC F0 4E D0 EF 16 E8 B3 DE 3F
0060 | 1F B4 CF 51 9D 10 5F C5 DD D5 8B 90 96 B4 AC 93
0070 | F7 FB 03 CB A3 0E FE A6 A4 09 3C 69 64 AC 75 17
0080 | F7 14 A0 6D 5F 05 03 E4 4B F9 31 48 11 71 4B E4
0090 | 9D F5 7D CA 59 0A B3 9A 08 A8 08 1E 7A 78 4D 36
00A0 | 05 EC 9D 32 B9 14 6B 46 41 FA 31 38 1E 04 4B 95
00B0 | F2 1A 30 E4 6A E2 3A 5A 8F 86 77 39 E1 08 A6 71
00C0 | AB E9 1B F9 B5 BE 52 ED 18 64 C6 CE D8 3A D7 E5
00D0 | 45 E5 14 2D 06 7A 29 E0 47 B3 8F A8 E1 27 98 A1
00E0 | 88 C3 9E D7 36 D7 B7 A8 FC 44 01 7A ED 6A 69 03
00F0 | A4 E4 CB 6D B8 D8 03 22 BB DE 87 C1 CA CF 15 A0
0100 | C5 03 BD E7 6F 2C B1 F1 E3 7F DD 50 98 81 0D 91
0110 | 5C 30 24 9C A2 AA E9 36 89 C3 22 DB BB 7D 27 59
0120 | 11 45 8F 36 CF 22 81 F7 6C 97 55 E5 8D 29 1F 5A
0130 | 6E 24 F6 9D 40 5D C9 5D 2A F3 76 23 96 46 2A DE
0140 | 00 EB 35 B4 97 06 A6 81 D5 C4 D9 14 88 15 97 02
0150 | F7 4B 1D 78</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>68000B004429B868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044F8954E9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1334400233</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04752F29B1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1966025137</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D0E1ECF04ED0EF16E8B3DE3F</code> <code>1FB4CF519D105FC5DDD58B9096B4AC93</code> <code>F7FB03CBA30EFEA6A4093C6964AC7517</code> <code>F714A06D5F0503E44BF9314811714BE4</code> <code>9DF57DCA590AB39A08A8081E7A784D36</code> <code>05EC9D32B9146B4641FA31381E044B95</code> <code>F21A30E46AE23A5A8F867739E108A671</code> <code>ABE91BF9B5BE52ED1864C6CED83AD7E5</code> <code>45E5142D067A29E047B38FA8E12798A1</code> <code>88C39ED736D7B7A8FC44017AED6A6903</code> <code>A4E4CB6DB8D80322BBDE87C1CACF15A0</code> <code>C503BDE76F2CB1F1E37FDD5098810D91</code> <code>5C30249CA2AAE93689C322DBBB7D2759</code> <code>11458F36CF2281F76C9755E58D291F5A</code> <code>6E24F69D405DC95D2AF3762396462ADE</code> <code>00EB35B49706A681D5C4D91488159702</code><br> <code>F74B1D78</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 80 91 A0 44 29 B8 68
0010 | 78 02 00 00 5C 07 E8 D0 D9 5F 60 F4 1F 1E 81 70
0020 | D5 CA A7 50 10 29 AC 54 96 D6 38 8C 3A 07 FE 64
0030 | D4 2D F8 79 71 4B B4 18 FE 50 02 00 D9 4E 2A 7C
0040 | 55 DA 67 D6 05 75 D5 49 5D B3 3F CA 74 01 29 A4
0050 | CA EE F8 AA 1E 27 7D 21 3D AE 9F 61 12 76 9A 4C
0060 | A5 D1 A1 3F 6D C3 30 FC 84 49 DC 06 39 04 E7 71
0070 | 80 1D 1A 83 5D A0 74 C8 DB A8 59 28 42 1B 10 1E
0080 | 7D 73 8B 2A CB 9A 60 DD 10 EF DB E2 60 E8 29 6E
0090 | 5E 3A 85 ED A4 C4 8A 81 F9 2F F3 28 44 D6 45 93
00A0 | C7 78 98 ED 2B 0E 60 98 20 5A AE 7E A4 B0 68 F7
00B0 | 66 DE D2 15 E4 64 E4 F0 77 CD 9E 2C AD E8 B6 CE
00C0 | FE 49 5D 85 7A 84 A2 BE F5 A9 E5 2E 65 A9 9F 67
00D0 | 2E DB A4 C4 92 80 9A 89 2E 34 99 B1 D1 0B CE 60
00E0 | 01 DB 58 8E 5E 85 E7 8C 76 43 69 5B 3D 46 07 C3
00F0 | 0B 44 B1 8B 84 10 83 E5 77 2F 10 1F FC D3 7C 09
0100 | AD 00 DE 54 46 EB EF 62 6F B7 59 55 F2 C3 3C 8D
0110 | 0A B4 A1 A0 1B 75 C3 B2 E9 E0 EA 22 E9 3A 7E 6D
0120 | 69 23 18 BE B4 2C 27 F4 31 15 87 14 76 18 B5 90
0130 | 5A 9B 2E 9E 43 A5 89 88 5A 6C 50 FD 0E 3F 4D 69
0140 | 88 D8 A0 FB FF B8 9F E2 17 69 43 D5 55 99 F1 13
0150 | AC D7 15 74 D2 06 57 BB 1D 30 DA 7A 20 74 C9 37
0160 | 18 78 03 4D 1B 30 74 93 9F 4E 09 4E C9 6B 3F DD
0170 | BE 2A 91 75 32 2B C1 13 96 1E A5 C9 C1 67 84 5A
0180 | F1 77 A5 D9 CA 62 08 71 C5 7B 57 51 8C 95 8F 05
0190 | 1C 9A D1 E8 8C AC 69 4D 9F DB EF 61 D3 BD 5F 71
01A0 | 36 F8 7D 7D 6D A3 4E A1 70 CF CB 0F 7D 7B 97 01
01B0 | 8F E8 F1 A6 DE 17 44 18 7E 77 23 98 6D DF DF 5F
01C0 | 6B E9 B0 47 E9 B0 C6 34 58 5B 6D B0 5C 59 44 B1
01D0 | CC FD F9 F2 51 ED CF 16 7C E6 E7 05 B3 EE CC FC
01E0 | 06 9F 3D 99 83 9A E9 E7 84 C2 03 02 C4 0B 6C CD
01F0 | C4 FD DE 6A 12 C6 DE 89 1F 29 47 20 DB 04 4E 57
0200 | 02 83 02 4A AD CD 69 41 30 11 CB BB 6C 2F C8 12
0210 | 89 33 11 69 A9 6C C7 36 0C C7 DA DE 5B CC BB 57
0220 | 51 6E 49 A4 E8 14 02 23 9B C6 91 EC 5B 2D 58 49
0230 | 56 64 B9 B2 30 26 5B E2 B6 D2 69 33 45 3F B9 1F
0240 | 15 08 96 EF CE 92 06 BC 53 E0 7B 28 3B 67 32 D6
0250 | E3 00 B4 87 8A E6 82 D0 BA 4D DF 46 17 E9 CD CF
0260 | E9 70 77 00 EC FE 11 9F 4F A2 9E 44 E0 72 AC 47
0270 | 60 A9 B8 42 A0 2C 80 D7 F9 E7 1A 5C 54 1C EA 17
0280 | 0F 3F 42 35 7B B7 93 35 23 6E 4F F1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018091A04429B868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200D94E2A7C55DA67D60575D549</code> <code>5DB33FCA740129A4CAEEF8AA1E277D21</code> <code>3DAE9F6112769A4CA5D1A13F6DC330FC</code> <code>8449DC063904E771801D1A835DA074C8</code> <code>DBA85928421B101E7D738B2ACB9A60DD</code> <code>10EFDBE260E8296E5E3A85EDA4C48A81</code> <code>F92FF32844D64593C77898ED2B0E6098</code> <code>205AAE7EA4B068F766DED215E464E4F0</code> <code>77CD9E2CADE8B6CEFE495D857A84A2BE</code> <code>F5A9E52E65A99F672EDBA4C492809A89</code> <code>2E3499B1D10BCE6001DB588E5E85E78C</code> <code>7643695B3D4607C30B44B18B841083E5</code> <code>772F101FFCD37C09AD00DE5446EBEF62</code> <code>6FB75955F2C33C8D0AB4A1A01B75C3B2</code> <code>E9E0EA22E93A7E6D692318BEB42C27F4</code> <code>311587147618B5905A9B2E9E43A58988</code> <code>5A6C50FD0E3F4D6988D8A0FBFFB89FE2</code> <code>176943D55599F113ACD71574D20657BB</code> <code>1D30DA7A2074C9371878034D1B307493</code> <code>9F4E094EC96B3FDDBE2A9175322BC113</code> <code>961EA5C9C167845AF177A5D9CA620871</code> <code>C57B57518C958F051C9AD1E88CAC694D</code> <code>9FDBEF61D3BD5F7136F87D7D6DA34EA1</code> <code>70CFCB0F7D7B97018FE8F1A6DE174418</code> <code>7E7723986DDFDF5F6BE9B047E9B0C634</code> <code>585B6DB05C5944B1CCFDF9F251EDCF16</code> <code>7CE6E705B3EECCFC069F3D99839AE9E7</code> <code>84C20302C40B6CCDC4FDDE6A12C6DE89</code> <code>1F294720DB044E570283024AADCD6941</code> <code>3011CBBB6C2FC81289331169A96CC736</code> <code>0CC7DADE5BCCBB57516E49A4E8140223</code> <code>9BC691EC5B2D58495664B9B230265BE2</code> <code>B6D26933453FB91F150896EFCE9206BC</code> <code>53E07B283B6732D6E300B4878AE682D0</code> <code>BA4DDF4617E9CDCFE9707700ECFE119F</code> <code>4FA29E44E072AC4760A9B842A02C80D7</code> <code>F9E71A5C541CEA170F3F42357BB79335</code><br> <code>236E4FF1</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = D94E2A7C55DA67D60575D5495DB33FCA740129A4CAEEF8AA1E277D213DAE9F6112769A4CA5D1A13F6DC330FC8449DC063904E771801D1A835DA074C8DBA85928421B101E7D738B2ACB9A60DD10EFDBE260E8296E5E3A85EDA4C48A81F92FF32844D64593C77898ED2B0E6098205AAE7EA4B068F766DED215E464E4F077CD9E2CADE8B6CEFE495D857A84A2BEF5A9E52E65A99F672EDBA4C492809A892E3499B1D10BCE6001DB588E5E85E78C7643695B3D4607C30B44B18B841083E5772F101FFCD37C09AD00DE5446EBEF626FB75955F2C33C8D0AB4A1A01B75C3B2E9E0EA22E93A7E6D692318BEB42C27F4311587147618B5905A9B2E9E43A589885A6C50FD0E3F4D6988D8A0FBFFB89FE2176943D55599F113ACD71574D20657BB1D30DA7A2074C9371878034D1B3074939F4E094EC96B3FDDBE2A9175322BC113961EA5C9C167845AF177A5D9CA620871C57B57518C958F051C9AD1E88CAC694D9FDBEF61D3BD5F7136F87D7D6DA34EA170CFCB0F7D7B97018FE8F1A6DE1744187E7723986DDFDF5F6BE9B047E9B0C634585B6DB05C5944B1CCFDF9F251EDCF167CE6E705B3EECCFC069F3D99839AE9E784C20302C40B6CCDC4FDDE6A12C6DE891F294720DB044E570283024AADCD69413011CBBB6C2FC81289331169A96CC7360CC7DADE5BCCBB57516E49A4E81402239BC691EC5B2D58495664B9B230265BE2B6D26933453FB91F150896EFCE9206BC53E07B283B6732D6E300B4878AE682D0BA4DDF4617E9CDCFE9707700ECFE119F4FA29E44E072AC4760A9B842A02C80D7F9E71A5C541CEA170F3F42357BB79335236E4FF1
tmp_aes_key = 590C80EE3B0E31CF2CBC2A08B4EB1DE0DC7D876B536A0B7C4D606D59F143A4E1
tmp_aes_iv = B27A8D184DD061BF98454AAB7297BCD96B18206BFC90064278AF4CC4D30B8194</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 6DE0E87A980EFB23CFD4E8E3D93CEAE3F789DD08BA0D89B5D95F60F41F1E8170D5CAA7501029AC5496D6388C3A07FE64D42DF879714BB41803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100108F020A7DA00B53312C7B3F6C2C9221CED5B546B2B8CC7A648CF846EE616AA945BDA4470810506C14A5F90644868F23051C09F1A03392465FCBBA994DE135BC6924CFF48ED28B849A03815D995CF496954D23D93F7931DF386DB2EB96705759351AAA2483042D01827297BDC0C4AACB0F32E6B262C7D1028A9DB8F06D7F58DC0AE3F581928CCFBF03B08E1A09BE421726FCC9B591AA0A68312F2D23BFB81F15CCCF0753EC76A69FEA0236F3F780054BB8D86647EBA0BC3C4BFDFA9B49B7208BDB80B1ED8CFEC2C522EAB7F34BD0888CEBB3B462180C237A5F2A55830C643722B4FB22696BC089D73E28D382620AD6171774780B75FC7F5966D5D04F83666F6B4429B868C322F0248DB30AC8
answer = BA0D89B5D95F60F41F1E8170D5CAA7501029AC5496D6388C3A07FE64D42DF879714BB41803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100108F020A7DA00B53312C7B3F6C2C9221CED5B546B2B8CC7A648CF846EE616AA945BDA4470810506C14A5F90644868F23051C09F1A03392465FCBBA994DE135BC6924CFF48ED28B849A03815D995CF496954D23D93F7931DF386DB2EB96705759351AAA2483042D01827297BDC0C4AACB0F32E6B262C7D1028A9DB8F06D7F58DC0AE3F581928CCFBF03B08E1A09BE421726FCC9B591AA0A68312F2D23BFB81F15CCCF0753EC76A69FEA0236F3F780054BB8D86647EBA0BC3C4BFDFA9B49B7208BDB80B1ED8CFEC2C522EAB7F34BD0888CEBB3B462180C237A5F2A55830C643722B4FB22696BC089D73E28D382620AD6171774780B75FC7F5966D5D04F83666F6B4429B868C322F0248DB30AC8</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 D9 5F 60 F4 1F 1E 81 70 D5 CA A7 50
0010 | 10 29 AC 54 96 D6 38 8C 3A 07 FE 64 D4 2D F8 79
0020 | 71 4B B4 18 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 10 8F 02 0A 7D A0 0B 53 31 2C 7B 3F 6C 2C 92 21
0140 | CE D5 B5 46 B2 B8 CC 7A 64 8C F8 46 EE 61 6A A9
0150 | 45 BD A4 47 08 10 50 6C 14 A5 F9 06 44 86 8F 23
0160 | 05 1C 09 F1 A0 33 92 46 5F CB BA 99 4D E1 35 BC
0170 | 69 24 CF F4 8E D2 8B 84 9A 03 81 5D 99 5C F4 96
0180 | 95 4D 23 D9 3F 79 31 DF 38 6D B2 EB 96 70 57 59
0190 | 35 1A AA 24 83 04 2D 01 82 72 97 BD C0 C4 AA CB
01A0 | 0F 32 E6 B2 62 C7 D1 02 8A 9D B8 F0 6D 7F 58 DC
01B0 | 0A E3 F5 81 92 8C CF BF 03 B0 8E 1A 09 BE 42 17
01C0 | 26 FC C9 B5 91 AA 0A 68 31 2F 2D 23 BF B8 1F 15
01D0 | CC CF 07 53 EC 76 A6 9F EA 02 36 F3 F7 80 05 4B
01E0 | B8 D8 66 47 EB A0 BC 3C 4B FD FA 9B 49 B7 20 8B
01F0 | DB 80 B1 ED 8C FE C2 C5 22 EA B7 F3 4B D0 88 8C
0200 | EB B3 B4 62 18 0C 23 7A 5F 2A 55 83 0C 64 37 22
0210 | B4 FB 22 69 6B C0 89 D7 3E 28 D3 82 62 0A D6 17
0220 | 17 74 78 0B 75 FC 7F 59 66 D5 D0 4F 83 66 6F 6B
0230 | 44 29 B8 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100108F020A7DA00B53312C7B3F</code> <code>6C2C9221CED5B546B2B8CC7A648CF846</code> <code>EE616AA945BDA4470810506C14A5F906</code> <code>44868F23051C09F1A03392465FCBBA99</code> <code>4DE135BC6924CFF48ED28B849A03815D</code> <code>995CF496954D23D93F7931DF386DB2EB</code> <code>96705759351AAA2483042D01827297BD</code> <code>C0C4AACB0F32E6B262C7D1028A9DB8F0</code> <code>6D7F58DC0AE3F581928CCFBF03B08E1A</code> <code>09BE421726FCC9B591AA0A68312F2D23</code> <code>BFB81F15CCCF0753EC76A69FEA0236F3</code> <code>F780054BB8D86647EBA0BC3C4BFDFA9B</code> <code>49B7208BDB80B1ED8CFEC2C522EAB7F3</code> <code>4BD0888CEBB3B462180C237A5F2A5583</code> <code>0C643722B4FB22696BC089D73E28D382</code> <code>620AD6171774780B75FC7F5966D5D04F</code><br> <code>83666F6B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>4429B868</code> (1756899652 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 6ED6631FAD010299E04DDFB41346617FE79EBA09D79125F14841BC14E7B36337DE7AC11AE7F5132D50913FD27270CB1E9940CF2E8E89A491AE7B117B3BAA5425BA8C196C9B21E5F36D0B9BFEADA79A37767BF8C14F949F235B9356E711C86036E20908AF95D00D5285E7415238ED59B12FE4CC9B0029F6BA0BB47D4196BDD27E38CF965526286B14885283E760D4EE288940B4832CC0122063C5A8C50C54199A366F1404409FF50D42A7F69CB28F0CA396A79F7371A3B2009123297470AA4E5C536F57FEEB89BA4E4CC93B088C0AA13F53E12A0C6DDC46F138151830D7B8397C7B6DB56C73A81EE288A6DA8008FD0FC86B98774C0B4F54DEA9F1307E9A065E2A</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 591C6A7A3C60B290B8D0FA4C3C353CA447E55B1955C65EDE2598AE0B6F24FFB1EFF83EEB8DDA742943F0797915C02D7105C66A15AB5E68A7CD79F7DEF29B5B01BE29A60E5B5BF858F731F47FDC227F4CDF3837D714D1F7B89594457E04BF4FAECF8089F025B4B17228567E1F33170C401BCB6469201157794A7CAAD769D617C03BC8AA6CA90402E67F15A99BEA6267C1C709F0256DA39D06A833D489166A5BDBB6562F9F036FC995BD255E6355527AA2210D2E7A819EFAF7C8E4908F8EBC85594CCD52957B52FC3DE1868665D7584012617FE66FC8CBC8C5E268D79041F8D14947B3AFC09DD7799DF3ED7439D4A4C09D2DED567088ED9EC579E8606E62F99EF9</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 D9 5F 60 F4 1F 1E 81 70 D5 CA A7 50
0010 | 10 29 AC 54 96 D6 38 8C 3A 07 FE 64 D4 2D F8 79
0020 | 71 4B B4 18 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 59 1C 6A 7A 3C 60 B2 90 B8 D0 FA 4C 3C 35 3C A4
0040 | 47 E5 5B 19 55 C6 5E DE 25 98 AE 0B 6F 24 FF B1
0050 | EF F8 3E EB 8D DA 74 29 43 F0 79 79 15 C0 2D 71
0060 | 05 C6 6A 15 AB 5E 68 A7 CD 79 F7 DE F2 9B 5B 01
0070 | BE 29 A6 0E 5B 5B F8 58 F7 31 F4 7F DC 22 7F 4C
0080 | DF 38 37 D7 14 D1 F7 B8 95 94 45 7E 04 BF 4F AE
0090 | CF 80 89 F0 25 B4 B1 72 28 56 7E 1F 33 17 0C 40
00A0 | 1B CB 64 69 20 11 57 79 4A 7C AA D7 69 D6 17 C0
00B0 | 3B C8 AA 6C A9 04 02 E6 7F 15 A9 9B EA 62 67 C1
00C0 | C7 09 F0 25 6D A3 9D 06 A8 33 D4 89 16 6A 5B DB
00D0 | B6 56 2F 9F 03 6F C9 95 BD 25 5E 63 55 52 7A A2
00E0 | 21 0D 2E 7A 81 9E FA F7 C8 E4 90 8F 8E BC 85 59
00F0 | 4C CD 52 95 7B 52 FC 3D E1 86 86 65 D7 58 40 12
0100 | 61 7F E6 6F C8 CB C8 C5 E2 68 D7 90 41 F8 D1 49
0110 | 47 B3 AF C0 9D D7 79 9D F3 ED 74 39 D4 A4 C0 9D
0120 | 2D ED 56 70 88 ED 9E C5 79 E8 60 6E 62 F9 9E F9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100591C6A7A3C60B290B8D0FA4C</code> <code>3C353CA447E55B1955C65EDE2598AE0B</code> <code>6F24FFB1EFF83EEB8DDA742943F07979</code> <code>15C02D7105C66A15AB5E68A7CD79F7DE</code> <code>F29B5B01BE29A60E5B5BF858F731F47F</code> <code>DC227F4CDF3837D714D1F7B89594457E</code> <code>04BF4FAECF8089F025B4B17228567E1F</code> <code>33170C401BCB6469201157794A7CAAD7</code> <code>69D617C03BC8AA6CA90402E67F15A99B</code> <code>EA6267C1C709F0256DA39D06A833D489</code> <code>166A5BDBB6562F9F036FC995BD255E63</code> <code>55527AA2210D2E7A819EFAF7C8E4908F</code> <code>8EBC85594CCD52957B52FC3DE1868665</code> <code>D7584012617FE66FC8CBC8C5E268D790</code> <code>41F8D14947B3AFC09DD7799DF3ED7439</code> <code>D4A4C09D2DED567088ED9EC579E8606E</code><br> <code>62F99EF9</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366D95F60F41F1E8170D5CAA7501029AC5496D6388C3A07FE64D42DF879714BB4180000000000000000FE000100591C6A7A3C60B290B8D0FA4C3C353CA447E55B1955C65EDE2598AE0B6F24FFB1EFF83EEB8DDA742943F0797915C02D7105C66A15AB5E68A7CD79F7DEF29B5B01BE29A60E5B5BF858F731F47FDC227F4CDF3837D714D1F7B89594457E04BF4FAECF8089F025B4B17228567E1F33170C401BCB6469201157794A7CAAD769D617C03BC8AA6CA90402E67F15A99BEA6267C1C709F0256DA39D06A833D489166A5BDBB6562F9F036FC995BD255E6355527AA2210D2E7A819EFAF7C8E4908F8EBC85594CCD52957B52FC3DE1868665D7584012617FE66FC8CBC8C5E268D79041F8D14947B3AFC09DD7799DF3ED7439D4A4C09D2DED567088ED9EC579E8606E62F99EF9
padding = 0BC5709EBF61194844D004B1
tmp_aes_key = 590C80EE3B0E31CF2CBC2A08B4EB1DE0DC7D876B536A0B7C4D606D59F143A4E1
tmp_aes_iv = B27A8D184DD061BF98454AAB7297BCD96B18206BFC90064278AF4CC4D30B8194</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 2B9B45EB3B217E0D059C0B8AEFCA9001D8818AD54C9B628A26F13B8874D997ED54E5591849BE1191A5DB702BE8C649C86E29D3F7C010522801A07B8F388C2A06EE4CC0EF473E2F04A9AB55E989C4CDEDBF014D3EECAB732744DD867811DCA3F7E5DE3CB9621E6DD30A1B61BFE8E8520D7D0502E505EE4A358672F8087FFE30D132AEBCB71DA47A08BCF45044B7165CB71293808936E4BF81B2474F4AF865BC92B0F47CFA6613A5D10AF68A083915C8349CCF7664358DF82F49D77DD3736960EF7D0C8F80B529E31A88F30E799F8896699923C92E2D2A049CBCC313A02A785D7E4A14F8D65FCF7BBDDF66CCB42DA0B65ABCFCABA40DE43B87191FD9F3EEF6CC0492AC0ED3FBABD746E0894311656DEB6EEEE3FC39AE980430904B0B2526269261267B8FAB41367225B5EABF88A9DA73FD70920B39092CFDC8DC2911C838F8DC51FA936CC0411E343B385EF67B6008107C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C 00 0B 00 44 29 B8 68
0010 | 78 01 00 00 1F 5F 04 F5 D9 5F 60 F4 1F 1E 81 70
0020 | D5 CA A7 50 10 29 AC 54 96 D6 38 8C 3A 07 FE 64
0030 | D4 2D F8 79 71 4B B4 18 FE 50 01 00 2B 9B 45 EB
0040 | 3B 21 7E 0D 05 9C 0B 8A EF CA 90 01 D8 81 8A D5
0050 | 4C 9B 62 8A 26 F1 3B 88 74 D9 97 ED 54 E5 59 18
0060 | 49 BE 11 91 A5 DB 70 2B E8 C6 49 C8 6E 29 D3 F7
0070 | C0 10 52 28 01 A0 7B 8F 38 8C 2A 06 EE 4C C0 EF
0080 | 47 3E 2F 04 A9 AB 55 E9 89 C4 CD ED BF 01 4D 3E
0090 | EC AB 73 27 44 DD 86 78 11 DC A3 F7 E5 DE 3C B9
00A0 | 62 1E 6D D3 0A 1B 61 BF E8 E8 52 0D 7D 05 02 E5
00B0 | 05 EE 4A 35 86 72 F8 08 7F FE 30 D1 32 AE BC B7
00C0 | 1D A4 7A 08 BC F4 50 44 B7 16 5C B7 12 93 80 89
00D0 | 36 E4 BF 81 B2 47 4F 4A F8 65 BC 92 B0 F4 7C FA
00E0 | 66 13 A5 D1 0A F6 8A 08 39 15 C8 34 9C CF 76 64
00F0 | 35 8D F8 2F 49 D7 7D D3 73 69 60 EF 7D 0C 8F 80
0100 | B5 29 E3 1A 88 F3 0E 79 9F 88 96 69 99 23 C9 2E
0110 | 2D 2A 04 9C BC C3 13 A0 2A 78 5D 7E 4A 14 F8 D6
0120 | 5F CF 7B BD DF 66 CC B4 2D A0 B6 5A BC FC AB A4
0130 | 0D E4 3B 87 19 1F D9 F3 EE F6 CC 04 92 AC 0E D3
0140 | FB AB D7 46 E0 89 43 11 65 6D EB 6E EE E3 FC 39
0150 | AE 98 04 30 90 4B 0B 25 26 26 92 61 26 7B 8F AB
0160 | 41 36 72 25 B5 EA BF 88 A9 DA 73 FD 70 92 0B 39
0170 | 09 2C FD C8 DC 29 11 C8 38 F8 DC 51 FA 93 6C C0
0180 | 41 1E 34 3B 38 5E F6 7B 60 08 10 7C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6C000B004429B868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001002B9B45EB3B217E0D059C0B8A</code> <code>EFCA9001D8818AD54C9B628A26F13B88</code> <code>74D997ED54E5591849BE1191A5DB702B</code> <code>E8C649C86E29D3F7C010522801A07B8F</code> <code>388C2A06EE4CC0EF473E2F04A9AB55E9</code> <code>89C4CDEDBF014D3EECAB732744DD8678</code> <code>11DCA3F7E5DE3CB9621E6DD30A1B61BF</code> <code>E8E8520D7D0502E505EE4A358672F808</code> <code>7FFE30D132AEBCB71DA47A08BCF45044</code> <code>B7165CB71293808936E4BF81B2474F4A</code> <code>F865BC92B0F47CFA6613A5D10AF68A08</code> <code>3915C8349CCF7664358DF82F49D77DD3</code> <code>736960EF7D0C8F80B529E31A88F30E79</code> <code>9F8896699923C92E2D2A049CBCC313A0</code> <code>2A785D7E4A14F8D65FCF7BBDDF66CCB4</code> <code>2DA0B65ABCFCABA40DE43B87191FD9F3</code> <code>EEF6CC0492AC0ED3FBABD746E0894311</code> <code>656DEB6EEEE3FC39AE980430904B0B25</code> <code>26269261267B8FAB41367225B5EABF88</code> <code>A9DA73FD70920B39092CFDC8DC2911C8</code> <code>38F8DC51FA936CC0411E343B385EF67B</code><br> <code>6008107C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 28E3EEE84B3BC9010F82B31B16059D52E126A8AE91BBB0CCCC8FB36716152B301AEB55E15ABE19650B31FB4C438528EE7B552D969B5ED5ADAAAF1465C9B434A7BDEA3385B4F012D3F040F2F45B0F9C8B329452661DC601129B866B4D2E36FDC01932FDD7BB7C364C07649C0DF1F6167DB1161CC22D9F6E4B4BF308570E434ED6E5D454DACCE8D5A4F4DE02C32EBF3860B61890C89549A8574FDB2A61738C024ADF62DE87760C304AD7059D5AB25CADD720EA9953E26FEA7143D585A957960216C4D4B39B2B5AD062A3037F113A40E151C21431A766B4F0CF1CA1DC5589220E89FF851F231C06B4BDC01E5357DDE80382DAA098E133F59C1CCB9CF9EF73088D2E</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 08 C8 45 29 B8 68
0010 | 34 00 00 00 34 F7 CB 3B D9 5F 60 F4 1F 1E 81 70
0020 | D5 CA A7 50 10 29 AC 54 96 D6 38 8C 3A 07 FE 64
0030 | D4 2D F8 79 71 4B B4 18 0D 12 5C A0 C7 19 EF 7E
0040 | 03 41 CF 5D F7 98 D7 D8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013008C84529B868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D95F60F41F1E8170D5CAA7501029AC54</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>96D6388C3A07FE64D42DF879714BB418</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>0D125CA0C719EF7E0341CF5DF798D7D8</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

