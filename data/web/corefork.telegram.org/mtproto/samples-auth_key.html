<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?237" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 90 4B 0D 00 A6 8A 6D 66
0010 | 14 00 00 00 F1 8E 7E BE 20 FD E6 08 42 30 CC 5C
0020 | 8D CC F8 96 31 94 64 97</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>904B0D00A68A6D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 3E 25 A6 8A 6D 66
0010 | 78 00 00 00 63 24 16 05 20 FD E6 08 42 30 CC 5C
0020 | 8D CC F8 96 31 94 64 97 93 28 4F B9 DD C4 95 D2
0030 | EA CD BD 8F 12 81 EC 50 08 24 4A BF 37 7B D7 6F
0040 | B7 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01983E25A68A6D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78000000</code> (120 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08244ABF377BD76FB7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2615112778663817143</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2615112778663817143</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2615112778663817143 = 1398490957 * 1869953299</code></p>
<pre><code>p = 1398490957
q = 1869953299</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 24 4A BF 37 7B D7 6F B7 00 00 00
0010 | 04 53 5B 47 4D 00 00 00 04 6F 75 39 13 00 00 00
0020 | 20 FD E6 08 42 30 CC 5C 8D CC F8 96 31 94 64 97
0030 | 93 28 4F B9 DD C4 95 D2 EA CD BD 8F 12 81 EC 50
0040 | 01 DA CD 54 1E 00 A2 2D 9D B3 14 2E AE 22 3F 26
0050 | B5 E5 B3 97 2A 6F 33 D7 28 90 49 FB C0 6F 6F 88
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08244ABF377BD76FB7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2615112778663817143</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04535B474D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1398490957</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046F753913000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1869953299</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>01DACD541E00A22D9DB3142EAE223F26</code> <code>B5E5B3972A6F33D7289049FBC06F6F88</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908244ABF377BD76FB700000004535B474D000000046F75391300000020FDE6084230CC5C8DCCF8963194649793284FB9DDC495D2EACDBD8F1281EC5001DACD541E00A22D9DB3142EAE223F26B5E5B3972A6F33D7289049FBC06F6F8802000000
random_padding_bytes = 87C5B101B966A5B388D8655526C71CE63DE32D6763F768ACDA886064A529C6E2399941070B8CDBF89106E386CC21B7E3B4BD2F4769E8C1D565FF3EE5E0BA82BCA3E765FDB28938F19B128A1752A335F0A7A54208274685C1B448BE9A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 52C399C4765B45332A99BFE685994E189789F5F7C01242B1CD8AE7D5279DBFBD3705D11EFB0E983FBB66C4CBA6AA3B18622D1638BD6AF10AA7609D89B879E483E2231E6EB8922A58A26C8AFB787B3A7FF64C45EFFE0C1A3902DFA9846F9E71EEC42D39002524B899C01AD2EFBBAE95483E868901164D60AD5EC3FD33643CD5CD41929CC28C4849399FC9CE55CFBBF9C6D1AA9DF1D942F7B3152EE236FE3B66AEAC8A0BF7AE03B84B7E2D5DE50F2B2958C7344189EB9F8752A4839FFA50823AA116CD4D1B6F2FB2DE35A3F505FA09990614FB0D6E1CC9326436423E5FE85741679782AD8C8248CE92AC4ED5BFF9D525A3C58099534BC1CD71C78D4EF9C83A3AB9</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 94 4B 0D 00 A6 8A 6D 66
0010 | 40 01 00 00 BE E4 12 D7 20 FD E6 08 42 30 CC 5C
0020 | 8D CC F8 96 31 94 64 97 93 28 4F B9 DD C4 95 D2
0030 | EA CD BD 8F 12 81 EC 50 04 53 5B 47 4D 00 00 00
0040 | 04 6F 75 39 13 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 52 C3 99 C4 76 5B 45 33 2A 99 BF E6
0060 | 85 99 4E 18 97 89 F5 F7 C0 12 42 B1 CD 8A E7 D5
0070 | 27 9D BF BD 37 05 D1 1E FB 0E 98 3F BB 66 C4 CB
0080 | A6 AA 3B 18 62 2D 16 38 BD 6A F1 0A A7 60 9D 89
0090 | B8 79 E4 83 E2 23 1E 6E B8 92 2A 58 A2 6C 8A FB
00A0 | 78 7B 3A 7F F6 4C 45 EF FE 0C 1A 39 02 DF A9 84
00B0 | 6F 9E 71 EE C4 2D 39 00 25 24 B8 99 C0 1A D2 EF
00C0 | BB AE 95 48 3E 86 89 01 16 4D 60 AD 5E C3 FD 33
00D0 | 64 3C D5 CD 41 92 9C C2 8C 48 49 39 9F C9 CE 55
00E0 | CF BB F9 C6 D1 AA 9D F1 D9 42 F7 B3 15 2E E2 36
00F0 | FE 3B 66 AE AC 8A 0B F7 AE 03 B8 4B 7E 2D 5D E5
0100 | 0F 2B 29 58 C7 34 41 89 EB 9F 87 52 A4 83 9F FA
0110 | 50 82 3A A1 16 CD 4D 1B 6F 2F B2 DE 35 A3 F5 05
0120 | FA 09 99 06 14 FB 0D 6E 1C C9 32 64 36 42 3E 5F
0130 | E8 57 41 67 97 82 AD 8C 82 48 CE 92 AC 4E D5 BF
0140 | F9 D5 25 A3 C5 80 99 53 4B C1 CD 71 C7 8D 4E F9
0150 | C8 3A 3A B9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>944B0D00A68A6D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04535B474D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1398490957</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046F753913000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1869953299</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010052C399C4765B45332A99BFE6</code> <code>85994E189789F5F7C01242B1CD8AE7D5</code> <code>279DBFBD3705D11EFB0E983FBB66C4CB</code> <code>A6AA3B18622D1638BD6AF10AA7609D89</code> <code>B879E483E2231E6EB8922A58A26C8AFB</code> <code>787B3A7FF64C45EFFE0C1A3902DFA984</code> <code>6F9E71EEC42D39002524B899C01AD2EF</code> <code>BBAE95483E868901164D60AD5EC3FD33</code> <code>643CD5CD41929CC28C4849399FC9CE55</code> <code>CFBBF9C6D1AA9DF1D942F7B3152EE236</code> <code>FE3B66AEAC8A0BF7AE03B84B7E2D5DE5</code> <code>0F2B2958C7344189EB9F8752A4839FFA</code> <code>50823AA116CD4D1B6F2FB2DE35A3F505</code> <code>FA09990614FB0D6E1CC9326436423E5F</code> <code>E85741679782AD8C8248CE92AC4ED5BF</code> <code>F9D525A3C58099534BC1CD71C78D4EF9</code><br> <code>C83A3AB9</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 81 E0 A6 8A 6D 66
0010 | C4 02 00 00 5C 07 E8 D0 20 FD E6 08 42 30 CC 5C
0020 | 8D CC F8 96 31 94 64 97 93 28 4F B9 DD C4 95 D2
0030 | EA CD BD 8F 12 81 EC 50 FE 50 02 00 C2 F0 09 F2
0040 | 34 3E F7 E5 17 DA 94 B2 3D D1 2C 3C 0B 25 A1 DA
0050 | BE 97 2E 96 21 E2 8B D6 2D F7 46 0E 1E 3C DB 02
0060 | A2 76 64 86 DC 9F B6 CD 01 D5 64 49 AA 85 5E A1
0070 | EC 8D AB 9F A7 47 83 2E CA 34 25 D9 EC FC 7E DE
0080 | FA 9E 17 AC 8F D9 A2 8E CD 18 DB 92 C4 42 A7 4A
0090 | 2A 8F E5 2F F3 88 E5 77 37 08 6F E3 24 77 3E 73
00A0 | E6 A5 B3 60 2D BB A1 C6 89 54 29 96 C2 72 DF F3
00B0 | E5 70 48 C6 46 49 2E 82 F7 54 6A F8 CE 7C 71 42
00C0 | 19 C2 33 35 55 93 F3 50 3C E7 E2 8D 13 D1 87 FE
00D0 | 0C E0 7D 90 B2 E9 00 B2 D0 16 45 46 A2 99 B6 1A
00E0 | F4 37 91 1F 1E 3A 68 92 45 F1 77 47 71 08 81 D8
00F0 | 7A D5 FB 2E 9F F8 52 DE 02 7B 8D 3B A6 3E 4D 3B
0100 | 16 7B B3 3C DD 88 56 3C 20 DF 47 39 47 0F 5F 14
0110 | 9F 7C 5B FD 6E CE 07 B7 59 C7 D3 07 B8 56 7F A5
0120 | 50 7D 6C 32 6B 0D 82 A8 90 E3 4B 30 9B B4 34 55
0130 | 2A A5 E6 78 50 83 98 C1 B0 0C C6 53 AB 4C 04 BE
0140 | 80 63 77 E1 F6 58 19 10 5B D0 6B D2 71 03 07 82
0150 | 52 A9 1B 10 63 B4 A2 9B 01 15 81 47 E5 44 A9 C7
0160 | C2 38 27 75 A1 99 AE F1 75 CF 05 6B 57 7E 21 59
0170 | F0 A7 5D 0A 2B 12 14 CB 94 2B 67 BD 82 EE DA 8C
0180 | 64 C1 6C 08 0E 49 C5 39 88 B4 7A F6 95 CB 94 51
0190 | 94 72 E3 72 D7 B9 30 71 67 C2 F2 A7 F8 3D F5 32
01A0 | 01 9D BD 55 AB A4 AB 09 21 A2 D4 45 A1 32 77 E4
01B0 | C9 76 37 C2 21 87 DA E7 51 DB 74 AF CF 59 78 C2
01C0 | C8 64 D3 0F 2B 6F 09 C5 5C 6A A0 CF 5F 53 8C F6
01D0 | 71 C3 A8 18 5A 26 EE BA B9 DC D2 73 32 39 A4 0C
01E0 | 30 D2 28 F9 4F 97 11 8A 67 1C 09 1D 05 F8 CB 81
01F0 | 78 9D 8B 0C 79 AF 38 E9 2E 89 72 97 64 74 89 14
0200 | 74 54 87 AC 8E 2A 7B 0C CE 91 7F 12 F9 BD 2A F4
0210 | F4 C3 84 92 2A 16 1E 8A 01 AD 18 10 AC 96 F9 9D
0220 | 20 17 3E 30 6C AC 4D F2 49 B1 43 6F 4F F6 54 E5
0230 | 02 E1 24 88 51 28 AE EE 23 63 9F D6 BD CA BD A8
0240 | C2 4E F4 61 72 FE 56 38 32 AA B0 F9 BF F0 D2 B6
0250 | DA 29 25 98 0D 22 FD A4 8F 4C FC BA 77 A1 E0 4E
0260 | E5 0D CE DB 4D 8B 5C 0C 1A 3F A7 43 AA 22 89 02
0270 | A6 C4 ED 47 24 F6 92 72 F9 A1 91 ED BF D1 CF E9
0280 | 17 77 83 23 59 D6 94 CB DB 90 74 7F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>019881E0A68A6D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C4020000</code> (708 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200C2F009F2343EF7E517DA94B2</code> <code>3DD12C3C0B25A1DABE972E9621E28BD6</code> <code>2DF7460E1E3CDB02A2766486DC9FB6CD</code> <code>01D56449AA855EA1EC8DAB9FA747832E</code> <code>CA3425D9ECFC7EDEFA9E17AC8FD9A28E</code> <code>CD18DB92C442A74A2A8FE52FF388E577</code> <code>37086FE324773E73E6A5B3602DBBA1C6</code> <code>89542996C272DFF3E57048C646492E82</code> <code>F7546AF8CE7C714219C233355593F350</code> <code>3CE7E28D13D187FE0CE07D90B2E900B2</code> <code>D0164546A299B61AF437911F1E3A6892</code> <code>45F17747710881D87AD5FB2E9FF852DE</code> <code>027B8D3BA63E4D3B167BB33CDD88563C</code> <code>20DF4739470F5F149F7C5BFD6ECE07B7</code> <code>59C7D307B8567FA5507D6C326B0D82A8</code> <code>90E34B309BB434552AA5E678508398C1</code> <code>B00CC653AB4C04BE806377E1F6581910</code> <code>5BD06BD27103078252A91B1063B4A29B</code> <code>01158147E544A9C7C2382775A199AEF1</code> <code>75CF056B577E2159F0A75D0A2B1214CB</code> <code>942B67BD82EEDA8C64C16C080E49C539</code> <code>88B47AF695CB94519472E372D7B93071</code> <code>67C2F2A7F83DF532019DBD55ABA4AB09</code> <code>21A2D445A13277E4C97637C22187DAE7</code> <code>51DB74AFCF5978C2C864D30F2B6F09C5</code> <code>5C6AA0CF5F538CF671C3A8185A26EEBA</code> <code>B9DCD2733239A40C30D228F94F97118A</code> <code>671C091D05F8CB81789D8B0C79AF38E9</code> <code>2E89729764748914745487AC8E2A7B0C</code> <code>CE917F12F9BD2AF4F4C384922A161E8A</code> <code>01AD1810AC96F99D20173E306CAC4DF2</code> <code>49B1436F4FF654E502E124885128AEEE</code> <code>23639FD6BDCABDA8C24EF46172FE5638</code> <code>32AAB0F9BFF0D2B6DA2925980D22FDA4</code> <code>8F4CFCBA77A1E04EE50DCEDB4D8B5C0C</code> <code>1A3FA743AA228902A6C4ED4724F69272</code> <code>F9A191EDBFD1CFE91777832359D694CB</code><br> <code>DB90747F</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = C2F009F2343EF7E517DA94B23DD12C3C0B25A1DABE972E9621E28BD62DF7460E1E3CDB02A2766486DC9FB6CD01D56449AA855EA1EC8DAB9FA747832ECA3425D9ECFC7EDEFA9E17AC8FD9A28ECD18DB92C442A74A2A8FE52FF388E57737086FE324773E73E6A5B3602DBBA1C689542996C272DFF3E57048C646492E82F7546AF8CE7C714219C233355593F3503CE7E28D13D187FE0CE07D90B2E900B2D0164546A299B61AF437911F1E3A689245F17747710881D87AD5FB2E9FF852DE027B8D3BA63E4D3B167BB33CDD88563C20DF4739470F5F149F7C5BFD6ECE07B759C7D307B8567FA5507D6C326B0D82A890E34B309BB434552AA5E678508398C1B00CC653AB4C04BE806377E1F65819105BD06BD27103078252A91B1063B4A29B01158147E544A9C7C2382775A199AEF175CF056B577E2159F0A75D0A2B1214CB942B67BD82EEDA8C64C16C080E49C53988B47AF695CB94519472E372D7B9307167C2F2A7F83DF532019DBD55ABA4AB0921A2D445A13277E4C97637C22187DAE751DB74AFCF5978C2C864D30F2B6F09C55C6AA0CF5F538CF671C3A8185A26EEBAB9DCD2733239A40C30D228F94F97118A671C091D05F8CB81789D8B0C79AF38E92E89729764748914745487AC8E2A7B0CCE917F12F9BD2AF4F4C384922A161E8A01AD1810AC96F99D20173E306CAC4DF249B1436F4FF654E502E124885128AEEE23639FD6BDCABDA8C24EF46172FE563832AAB0F9BFF0D2B6DA2925980D22FDA48F4CFCBA77A1E04EE50DCEDB4D8B5C0C1A3FA743AA228902A6C4ED4724F69272F9A191EDBFD1CFE91777832359D694CBDB90747F
tmp_aes_key = 358F471A5799CC4CBBDB0023F56911461E3DDD66CFEAB574F9E1B75AFD04946D
tmp_aes_iv = 3FFB9DE3C15F2B4582416182773D16B6334D71764B280C60397C27C001DACD54</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 7D492F541C905100ABD15A23FB64B89ECB37F4A0BA0D89B520FDE6084230CC5C8DCCF8963194649793284FB9DDC495D2EACDBD8F1281EC5003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100978C9B946ECCBCDE68F79884E374F5C269AA8122B96E6CC06D378D513A80859E1E65AABCAF3CFB79ED191CD21EB18886E7A34D893CAB4219BE46B24A10F05D001C777B6D03AB082F826ADC76B32647B671A2EFAA9B53A55E88449CAA768FE51D8507D122F616FFDA204F5BBDB72ED6EE504624BD4F0D7A7DA9D966241933653AC22257C8F7FEEC5CF00CF898EA948C29246CBC819C577083C6C2D4014A6AF9FCE42858989D22F8E4E6783A76DB63B527C41B0E3A14649E817008922C5244F27FC704A76AAC0FAE235FDE71D74A32D673ABAE57C45822E55196E70675738BD419307B70271A625BB4683C734117706CE616054B5F651224894403969051F2BDE4A68A6D66951A03E5B239AC55
answer = BA0D89B520FDE6084230CC5C8DCCF8963194649793284FB9DDC495D2EACDBD8F1281EC5003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100978C9B946ECCBCDE68F79884E374F5C269AA8122B96E6CC06D378D513A80859E1E65AABCAF3CFB79ED191CD21EB18886E7A34D893CAB4219BE46B24A10F05D001C777B6D03AB082F826ADC76B32647B671A2EFAA9B53A55E88449CAA768FE51D8507D122F616FFDA204F5BBDB72ED6EE504624BD4F0D7A7DA9D966241933653AC22257C8F7FEEC5CF00CF898EA948C29246CBC819C577083C6C2D4014A6AF9FCE42858989D22F8E4E6783A76DB63B527C41B0E3A14649E817008922C5244F27FC704A76AAC0FAE235FDE71D74A32D673ABAE57C45822E55196E70675738BD419307B70271A625BB4683C734117706CE616054B5F651224894403969051F2BDE4A68A6D66951A03E5B239AC55</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 20 FD E6 08 42 30 CC 5C 8D CC F8 96
0010 | 31 94 64 97 93 28 4F B9 DD C4 95 D2 EA CD BD 8F
0020 | 12 81 EC 50 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 97 8C 9B 94 6E CC BC DE 68 F7 98 84 E3 74 F5 C2
0140 | 69 AA 81 22 B9 6E 6C C0 6D 37 8D 51 3A 80 85 9E
0150 | 1E 65 AA BC AF 3C FB 79 ED 19 1C D2 1E B1 88 86
0160 | E7 A3 4D 89 3C AB 42 19 BE 46 B2 4A 10 F0 5D 00
0170 | 1C 77 7B 6D 03 AB 08 2F 82 6A DC 76 B3 26 47 B6
0180 | 71 A2 EF AA 9B 53 A5 5E 88 44 9C AA 76 8F E5 1D
0190 | 85 07 D1 22 F6 16 FF DA 20 4F 5B BD B7 2E D6 EE
01A0 | 50 46 24 BD 4F 0D 7A 7D A9 D9 66 24 19 33 65 3A
01B0 | C2 22 57 C8 F7 FE EC 5C F0 0C F8 98 EA 94 8C 29
01C0 | 24 6C BC 81 9C 57 70 83 C6 C2 D4 01 4A 6A F9 FC
01D0 | E4 28 58 98 9D 22 F8 E4 E6 78 3A 76 DB 63 B5 27
01E0 | C4 1B 0E 3A 14 64 9E 81 70 08 92 2C 52 44 F2 7F
01F0 | C7 04 A7 6A AC 0F AE 23 5F DE 71 D7 4A 32 D6 73
0200 | AB AE 57 C4 58 22 E5 51 96 E7 06 75 73 8B D4 19
0210 | 30 7B 70 27 1A 62 5B B4 68 3C 73 41 17 70 6C E6
0220 | 16 05 4B 5F 65 12 24 89 44 03 96 90 51 F2 BD E4
0230 | A6 8A 6D 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100978C9B946ECCBCDE68F79884</code> <code>E374F5C269AA8122B96E6CC06D378D51</code> <code>3A80859E1E65AABCAF3CFB79ED191CD2</code> <code>1EB18886E7A34D893CAB4219BE46B24A</code> <code>10F05D001C777B6D03AB082F826ADC76</code> <code>B32647B671A2EFAA9B53A55E88449CAA</code> <code>768FE51D8507D122F616FFDA204F5BBD</code> <code>B72ED6EE504624BD4F0D7A7DA9D96624</code> <code>1933653AC22257C8F7FEEC5CF00CF898</code> <code>EA948C29246CBC819C577083C6C2D401</code> <code>4A6AF9FCE42858989D22F8E4E6783A76</code> <code>DB63B527C41B0E3A14649E817008922C</code> <code>5244F27FC704A76AAC0FAE235FDE71D7</code> <code>4A32D673ABAE57C45822E55196E70675</code> <code>738BD419307B70271A625BB4683C7341</code> <code>17706CE616054B5F6512248944039690</code><br> <code>51F2BDE4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>A68A6D66</code> (1718454950 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = EBCDB3228FAFFE7F27D38AB0A00E79E6D5BACEB96B5307DE5C5F5C196A6378F49FF94727CBB6E7FE9823E6C621C5BC6C70D6A68288D3F2419831B1DC2AB77A5D9A11551732EF80E0B6CC1954072535CACC548B5EC8BD4058E57CF24BF9180B6E3190C0F7E7E3729336861A42FBDDFC05944330D1E0019CFAE5F55F3723EF90F07E49E8908F37B263B3C7FF2BB7BB0248243B6B2AE815341746A9CB63A5CE8173D9A02D653977022378444ECB8C6322C735DA836774D000E385332371916A1F8FDD1BFF7EEEC61984641B6A46D56AF3209029A9A50AAD06238C3A970A4460823BFBA41EA6573FE0729A129508D6D4A99974A0FD0A10F6B58765037ECC4E5864DB</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 015F7858F4D68C37FEF92CDE649044BBC08F451F321EE35999163DFA05B235B1B44EB0D48FF5948970577BD3A666FAC86FD428DEDAF2802EDCC4447F87889F87370A53D502CD739BC9BA8F1C1EA4697E29DB5665D20516ED40AB69F0A5CA44529A757DDAF25492D8DA349C84C5F5CBE283F53FA15F33BE98BAC101EAB52849B967FF4E483B7D22DC701EDBAFAA09BA4557B278F524CE3A78E3D983D4983B37EA9DA1C6BFA903612B82071D115ADF6CC684864AF3BC4E23987A63B803944392EDC01614DA0F21B8474312F776A568ECDBAE2F809E3540D6E1EBAB3AAFDFBE3A813085584F91845EBEA59F80A46CDACC71A3E15BCC338D2CB62B5817B89EA6CB2F</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 20 FD E6 08 42 30 CC 5C 8D CC F8 96
0010 | 31 94 64 97 93 28 4F B9 DD C4 95 D2 EA CD BD 8F
0020 | 12 81 EC 50 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 01 5F 78 58 F4 D6 8C 37 FE F9 2C DE 64 90 44 BB
0040 | C0 8F 45 1F 32 1E E3 59 99 16 3D FA 05 B2 35 B1
0050 | B4 4E B0 D4 8F F5 94 89 70 57 7B D3 A6 66 FA C8
0060 | 6F D4 28 DE DA F2 80 2E DC C4 44 7F 87 88 9F 87
0070 | 37 0A 53 D5 02 CD 73 9B C9 BA 8F 1C 1E A4 69 7E
0080 | 29 DB 56 65 D2 05 16 ED 40 AB 69 F0 A5 CA 44 52
0090 | 9A 75 7D DA F2 54 92 D8 DA 34 9C 84 C5 F5 CB E2
00A0 | 83 F5 3F A1 5F 33 BE 98 BA C1 01 EA B5 28 49 B9
00B0 | 67 FF 4E 48 3B 7D 22 DC 70 1E DB AF AA 09 BA 45
00C0 | 57 B2 78 F5 24 CE 3A 78 E3 D9 83 D4 98 3B 37 EA
00D0 | 9D A1 C6 BF A9 03 61 2B 82 07 1D 11 5A DF 6C C6
00E0 | 84 86 4A F3 BC 4E 23 98 7A 63 B8 03 94 43 92 ED
00F0 | C0 16 14 DA 0F 21 B8 47 43 12 F7 76 A5 68 EC DB
0100 | AE 2F 80 9E 35 40 D6 E1 EB AB 3A AF DF BE 3A 81
0110 | 30 85 58 4F 91 84 5E BE A5 9F 80 A4 6C DA CC 71
0120 | A3 E1 5B CC 33 8D 2C B6 2B 58 17 B8 9E A6 CB 2F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100015F7858F4D68C37FEF92CDE</code> <code>649044BBC08F451F321EE35999163DFA</code> <code>05B235B1B44EB0D48FF5948970577BD3</code> <code>A666FAC86FD428DEDAF2802EDCC4447F</code> <code>87889F87370A53D502CD739BC9BA8F1C</code> <code>1EA4697E29DB5665D20516ED40AB69F0</code> <code>A5CA44529A757DDAF25492D8DA349C84</code> <code>C5F5CBE283F53FA15F33BE98BAC101EA</code> <code>B52849B967FF4E483B7D22DC701EDBAF</code> <code>AA09BA4557B278F524CE3A78E3D983D4</code> <code>983B37EA9DA1C6BFA903612B82071D11</code> <code>5ADF6CC684864AF3BC4E23987A63B803</code> <code>944392EDC01614DA0F21B8474312F776</code> <code>A568ECDBAE2F809E3540D6E1EBAB3AAF</code> <code>DFBE3A813085584F91845EBEA59F80A4</code> <code>6CDACC71A3E15BCC338D2CB62B5817B8</code><br> <code>9EA6CB2F</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436620FDE6084230CC5C8DCCF8963194649793284FB9DDC495D2EACDBD8F1281EC500000000000000000FE000100015F7858F4D68C37FEF92CDE649044BBC08F451F321EE35999163DFA05B235B1B44EB0D48FF5948970577BD3A666FAC86FD428DEDAF2802EDCC4447F87889F87370A53D502CD739BC9BA8F1C1EA4697E29DB5665D20516ED40AB69F0A5CA44529A757DDAF25492D8DA349C84C5F5CBE283F53FA15F33BE98BAC101EAB52849B967FF4E483B7D22DC701EDBAFAA09BA4557B278F524CE3A78E3D983D4983B37EA9DA1C6BFA903612B82071D115ADF6CC684864AF3BC4E23987A63B803944392EDC01614DA0F21B8474312F776A568ECDBAE2F809E3540D6E1EBAB3AAFDFBE3A813085584F91845EBEA59F80A46CDACC71A3E15BCC338D2CB62B5817B89EA6CB2F
padding = 19B6836E091AEA989B31ED7C
tmp_aes_key = 358F471A5799CC4CBBDB0023F56911461E3DDD66CFEAB574F9E1B75AFD04946D
tmp_aes_iv = 3FFB9DE3C15F2B4582416182773D16B6334D71764B280C60397C27C001DACD54</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 2ECCA417B66B66313398CD5E88DE30ABA18C51884446658AAB84C29603A173D23FEC9EAB938E6EA4FE3C2D9ADF22A1109C0C8C4700CDE663005E5727324E769406AA6CB7C2A73E36E30934F3A6168F18B3E6362B97418FCE0A757BEBB32D31DCC8AB2034BF5075DDABDFD8145C8EE62D196D1C28C4AA61519322BB4582F8E5FF7E9016B59926AC4DE2C216588571D03BAFADD19BACDBA35CC4AA0B534B6EF304F5EDAED54740C93691FC4907CFAB26D684966EB0EB62195BA4267B9E447107A684F461A8D047F54C9709B7D3F4FAC1387ACD97036B58F7F9D755BB367D6C9B134A431EFF6D0C1E2C747A8C846C02BBF65871C31DDC8239B77F090CF73D5ABBC2771A8CD86DF0769ECDE8ECE42D3BA68662D89E8DFEBC8D1CC18A00632F9CA2B11932AA44AD82F8CBE7F953CCF049ABF3585E920BB20FAEA9A8F0A28810D5FE9EC711574A4714922220AE980E1A538A0D</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 80 89 01 00 A7 8A 6D 66
0010 | 78 01 00 00 1F 5F 04 F5 20 FD E6 08 42 30 CC 5C
0020 | 8D CC F8 96 31 94 64 97 93 28 4F B9 DD C4 95 D2
0030 | EA CD BD 8F 12 81 EC 50 FE 50 01 00 2E CC A4 17
0040 | B6 6B 66 31 33 98 CD 5E 88 DE 30 AB A1 8C 51 88
0050 | 44 46 65 8A AB 84 C2 96 03 A1 73 D2 3F EC 9E AB
0060 | 93 8E 6E A4 FE 3C 2D 9A DF 22 A1 10 9C 0C 8C 47
0070 | 00 CD E6 63 00 5E 57 27 32 4E 76 94 06 AA 6C B7
0080 | C2 A7 3E 36 E3 09 34 F3 A6 16 8F 18 B3 E6 36 2B
0090 | 97 41 8F CE 0A 75 7B EB B3 2D 31 DC C8 AB 20 34
00A0 | BF 50 75 DD AB DF D8 14 5C 8E E6 2D 19 6D 1C 28
00B0 | C4 AA 61 51 93 22 BB 45 82 F8 E5 FF 7E 90 16 B5
00C0 | 99 26 AC 4D E2 C2 16 58 85 71 D0 3B AF AD D1 9B
00D0 | AC DB A3 5C C4 AA 0B 53 4B 6E F3 04 F5 ED AE D5
00E0 | 47 40 C9 36 91 FC 49 07 CF AB 26 D6 84 96 6E B0
00F0 | EB 62 19 5B A4 26 7B 9E 44 71 07 A6 84 F4 61 A8
0100 | D0 47 F5 4C 97 09 B7 D3 F4 FA C1 38 7A CD 97 03
0110 | 6B 58 F7 F9 D7 55 BB 36 7D 6C 9B 13 4A 43 1E FF
0120 | 6D 0C 1E 2C 74 7A 8C 84 6C 02 BB F6 58 71 C3 1D
0130 | DC 82 39 B7 7F 09 0C F7 3D 5A BB C2 77 1A 8C D8
0140 | 6D F0 76 9E CD E8 EC E4 2D 3B A6 86 62 D8 9E 8D
0150 | FE BC 8D 1C C1 8A 00 63 2F 9C A2 B1 19 32 AA 44
0160 | AD 82 F8 CB E7 F9 53 CC F0 49 AB F3 58 5E 92 0B
0170 | B2 0F AE A9 A8 F0 A2 88 10 D5 FE 9E C7 11 57 4A
0180 | 47 14 92 22 20 AE 98 0E 1A 53 8A 0D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>80890100A78A6D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001002ECCA417B66B66313398CD5E</code> <code>88DE30ABA18C51884446658AAB84C296</code> <code>03A173D23FEC9EAB938E6EA4FE3C2D9A</code> <code>DF22A1109C0C8C4700CDE663005E5727</code> <code>324E769406AA6CB7C2A73E36E30934F3</code> <code>A6168F18B3E6362B97418FCE0A757BEB</code> <code>B32D31DCC8AB2034BF5075DDABDFD814</code> <code>5C8EE62D196D1C28C4AA61519322BB45</code> <code>82F8E5FF7E9016B59926AC4DE2C21658</code> <code>8571D03BAFADD19BACDBA35CC4AA0B53</code> <code>4B6EF304F5EDAED54740C93691FC4907</code> <code>CFAB26D684966EB0EB62195BA4267B9E</code> <code>447107A684F461A8D047F54C9709B7D3</code> <code>F4FAC1387ACD97036B58F7F9D755BB36</code> <code>7D6C9B134A431EFF6D0C1E2C747A8C84</code> <code>6C02BBF65871C31DDC8239B77F090CF7</code> <code>3D5ABBC2771A8CD86DF0769ECDE8ECE4</code> <code>2D3BA68662D89E8DFEBC8D1CC18A0063</code> <code>2F9CA2B11932AA44AD82F8CBE7F953CC</code> <code>F049ABF3585E920BB20FAEA9A8F0A288</code> <code>10D5FE9EC711574A4714922220AE980E</code><br> <code>1A538A0D</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 81CE06F4E091A1EA220DB809260DA84049B2034BCF0FF9419D6CB00AB3A2387BFEC36DB566BA8D525943E3F1C5F84C0299ED8036BC81714BEE1EC04A4D8CDDAB38F82F9E7F86B902CBFC57D34123FA0A1B0B4429AA753FF082A31D1C51721E6F01321D41539EB17558E47E7C30B7E18B8812150438255D5E5A341008D265140EB9E27508FFC94FEDB7C424148EE2288406BA88BFFA0083AA3095D18132206CE8C9105E2D8385EBAD2F684166C732B4717E1747FDB7695E39EF7170CA012A8996A6C361B33B9A3D02A690AA42376B9A0854F64D425AF6E591307E511191F91868DACF4121A37617652512794A557FE86655AAF4433014E0B68D0E877A9A2D6FC9</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B0 D5 D1 A7 8A 6D 66
0010 | 44 00 00 00 34 F7 CB 3B 20 FD E6 08 42 30 CC 5C
0020 | 8D CC F8 96 31 94 64 97 93 28 4F B9 DD C4 95 D2
0030 | EA CD BD 8F 12 81 EC 50 64 8A 71 79 9D AD 64 5F
0040 | E2 8F 6D F3 CA 84 51 AE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B0D5D1A78A6D66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>44000000</code> (68 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>20FDE6084230CC5C8DCCF89631946497</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93284FB9DDC495D2EACDBD8F1281EC50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>648A71799DAD645FE28F6DF3CA8451AE</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

