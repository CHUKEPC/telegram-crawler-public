<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 18 87 0E 00 04 B7 AF 66
0010 | 14 00 00 00 F1 8E 7E BE A4 3A FF 1B 9E 83 A6 AD
0020 | 77 D3 9B D7 71 9C 47 2B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>18870E0004B7AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 B5 C8 04 B7 AF 66
0010 | 60 00 00 00 63 24 16 05 A4 3A FF 1B 9E 83 A6 AD
0020 | 77 D3 9B D7 71 9C 47 2B 06 88 68 83 56 65 87 5F
0030 | AD 81 E7 F4 04 B1 34 49 08 19 67 68 F7 04 AA 5B
0040 | 3B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0194B5C804B7AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>60000000</code> (96 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08196768F704AA5B3B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1830547183693880123</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1830547183693880123</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1830547183693880123 = 1209263557 * 1513770239</code></p>
<pre><code>p = 1209263557
q = 1513770239</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 67 68 F7 04 AA 5B 3B 00 00 00
0010 | 04 48 13 E5 C5 00 00 00 04 5A 3A 4C FF 00 00 00
0020 | A4 3A FF 1B 9E 83 A6 AD 77 D3 9B D7 71 9C 47 2B
0030 | 06 88 68 83 56 65 87 5F AD 81 E7 F4 04 B1 34 49
0040 | 8F 7A F9 FA D9 65 33 11 7F 1B E0 90 4A F5 77 B7
0050 | 86 B7 1F 65 29 44 1B 61 45 9F E3 8E 15 A9 05 0D
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08196768F704AA5B3B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1830547183693880123</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044813E5C5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1209263557</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045A3A4CFF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1513770239</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>8F7AF9FAD96533117F1BE0904AF577B7</code> <code>86B71F6529441B61459FE38E15A9050D</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908196768F704AA5B3B000000044813E5C5000000045A3A4CFF000000A43AFF1B9E83A6AD77D39BD7719C472B068868835665875FAD81E7F404B134498F7AF9FAD96533117F1BE0904AF577B786B71F6529441B61459FE38E15A9050D02000000
random_padding_bytes = 12C744246DB1B024B109325CF2435DF3D3D31CA468726A81E9728DC78911876DA57A16A025932B003B377B61A8AB3CFF1F6F2AE5D7099E90FD4B7A581CC6A704731C256DF87E390E824289C5317D28B24CC010A002975CC125DC49F3</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 8CD25F4DD74619242B35C416C5A3AD500CB5EE17D812B972DB20D18FD89E696723422CAE29EBA4A5CAFA45F9DD48BD526C25CBA107C454AB8AB943A165121C212B892EA9775D21A8940E2E055C8FB7D4252DEFB311B5956F1063E78FCA8142A5113DA55DCCACDB1EC8F8DBA8FE31C197632FE11EBD84827EF4604D48DAF60DE1C68F3ABC0AAC4C8EC55AAA25EB33DAEC19EB9DE9E44E2899D5703A8520E1928BD7FBA0DB43F055899873FA5E3603A1C04EEFDE48BCE107E72A2A168FA4456F4E62029CD6140C7574E0CBD9082EE394EE2CB28CB7C3F388291FCE1E54E08766E3FCFB7737D789B8D88C0B1BF09F47C33329334F0544895BDFC8E28F3D5484D9EC</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 1C 87 0E 00 04 B7 AF 66
0010 | 40 01 00 00 BE E4 12 D7 A4 3A FF 1B 9E 83 A6 AD
0020 | 77 D3 9B D7 71 9C 47 2B 06 88 68 83 56 65 87 5F
0030 | AD 81 E7 F4 04 B1 34 49 04 48 13 E5 C5 00 00 00
0040 | 04 5A 3A 4C FF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 8C D2 5F 4D D7 46 19 24 2B 35 C4 16
0060 | C5 A3 AD 50 0C B5 EE 17 D8 12 B9 72 DB 20 D1 8F
0070 | D8 9E 69 67 23 42 2C AE 29 EB A4 A5 CA FA 45 F9
0080 | DD 48 BD 52 6C 25 CB A1 07 C4 54 AB 8A B9 43 A1
0090 | 65 12 1C 21 2B 89 2E A9 77 5D 21 A8 94 0E 2E 05
00A0 | 5C 8F B7 D4 25 2D EF B3 11 B5 95 6F 10 63 E7 8F
00B0 | CA 81 42 A5 11 3D A5 5D CC AC DB 1E C8 F8 DB A8
00C0 | FE 31 C1 97 63 2F E1 1E BD 84 82 7E F4 60 4D 48
00D0 | DA F6 0D E1 C6 8F 3A BC 0A AC 4C 8E C5 5A AA 25
00E0 | EB 33 DA EC 19 EB 9D E9 E4 4E 28 99 D5 70 3A 85
00F0 | 20 E1 92 8B D7 FB A0 DB 43 F0 55 89 98 73 FA 5E
0100 | 36 03 A1 C0 4E EF DE 48 BC E1 07 E7 2A 2A 16 8F
0110 | A4 45 6F 4E 62 02 9C D6 14 0C 75 74 E0 CB D9 08
0120 | 2E E3 94 EE 2C B2 8C B7 C3 F3 88 29 1F CE 1E 54
0130 | E0 87 66 E3 FC FB 77 37 D7 89 B8 D8 8C 0B 1B F0
0140 | 9F 47 C3 33 29 33 4F 05 44 89 5B DF C8 E2 8F 3D
0150 | 54 84 D9 EC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>1C870E0004B7AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044813E5C5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1209263557</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045A3A4CFF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1513770239</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001008CD25F4DD74619242B35C416</code> <code>C5A3AD500CB5EE17D812B972DB20D18F</code> <code>D89E696723422CAE29EBA4A5CAFA45F9</code> <code>DD48BD526C25CBA107C454AB8AB943A1</code> <code>65121C212B892EA9775D21A8940E2E05</code> <code>5C8FB7D4252DEFB311B5956F1063E78F</code> <code>CA8142A5113DA55DCCACDB1EC8F8DBA8</code> <code>FE31C197632FE11EBD84827EF4604D48</code> <code>DAF60DE1C68F3ABC0AAC4C8EC55AAA25</code> <code>EB33DAEC19EB9DE9E44E2899D5703A85</code> <code>20E1928BD7FBA0DB43F055899873FA5E</code> <code>3603A1C04EEFDE48BCE107E72A2A168F</code> <code>A4456F4E62029CD6140C7574E0CBD908</code> <code>2EE394EE2CB28CB7C3F388291FCE1E54</code> <code>E08766E3FCFB7737D789B8D88C0B1BF0</code> <code>9F47C33329334F0544895BDFC8E28F3D</code><br> <code>5484D9EC</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 87 6A 05 B7 AF 66
0010 | A4 02 00 00 5C 07 E8 D0 A4 3A FF 1B 9E 83 A6 AD
0020 | 77 D3 9B D7 71 9C 47 2B 06 88 68 83 56 65 87 5F
0030 | AD 81 E7 F4 04 B1 34 49 FE 50 02 00 25 1F FB F5
0040 | 00 9F E9 70 75 2B 5D 65 85 05 D8 97 61 31 75 C4
0050 | 1B ED 03 95 21 EC 40 0D 27 10 B4 BE 97 CF A2 60
0060 | AF C7 80 EB 04 97 00 B4 D6 63 EC F5 84 15 88 6A
0070 | 96 64 38 10 E6 3C 89 51 59 53 99 9C AD FC 5B EC
0080 | A2 EF E9 D8 E7 5E 3F BE EF E4 29 DF FE 5A 5A 9A
0090 | 47 3E 18 35 64 A6 F9 04 5A FE EB 30 42 03 12 B8
00A0 | EE D7 51 4E C9 FB F3 D0 60 D8 2D F0 AA DB CA F1
00B0 | B6 26 58 F8 82 8D 0B CE 4D 08 6D 5F 2A 17 62 30
00C0 | E3 6C 3A 47 F0 27 7B 06 B1 13 AA 03 51 3F 90 64
00D0 | 5F F5 9C 24 6C A7 93 28 C9 94 7E AD BF 12 A8 2E
00E0 | 54 D3 D9 EB E8 ED A2 E8 DF 19 B3 BF 86 F5 27 03
00F0 | ED 4E 21 8A 06 06 9F F6 51 4B 83 11 68 6A 4D 8A
0100 | 45 81 B5 21 11 93 9A C8 72 79 2F C1 B1 AA 71 D9
0110 | 4F 4C FA 6D 32 A4 39 4E 8A 78 2B 09 6A D1 BC E9
0120 | 40 EF 77 35 22 44 65 1E 0A C7 1C AD 34 9C FD 56
0130 | EC 29 59 2F 78 04 AC 8E 1C 14 6B 22 F4 C8 81 55
0140 | F0 E0 B0 3B 2D 01 5F 32 9A B7 DF C1 05 47 FE C9
0150 | A9 0E F0 CD A9 BF 6D 26 B6 46 3A 73 B0 84 2B 5F
0160 | 46 DC 99 93 59 DA 38 C4 62 F8 46 5F A7 F4 E2 B2
0170 | 8F C4 2F 04 F9 3B 01 BF 67 74 F8 34 EA 9E 96 D8
0180 | 55 24 87 21 E1 2C E6 F5 1B 63 EB 19 14 73 4E 65
0190 | 17 37 15 23 AB 82 66 D0 FA DC E2 9F EF BD CE 17
01A0 | 64 82 26 7F D5 6A 4C C7 9A 00 5D D9 7D 0C 04 E7
01B0 | CF DF D3 1B AC 03 0E 19 72 54 00 6A F9 EE 7B 57
01C0 | A4 B1 6F C6 8F CC 26 B5 7F A1 4C A7 CB 9D 8B 7A
01D0 | A8 B5 5B 10 38 31 1B D7 40 A9 7A 18 2D 3B 75 57
01E0 | CF 17 00 B7 4A 98 92 7E 72 01 61 AD 78 A3 65 2D
01F0 | 95 E9 CE 07 AE 73 EC 9B D1 B6 EB 7A EA B2 88 63
0200 | 84 8A FC 16 4D A1 D6 E6 00 16 FB BC F4 0B 3A 38
0210 | 41 B8 C1 4D 98 88 BE F2 81 B8 25 E9 51 D4 93 E7
0220 | EF 09 BA 8E E7 DB 65 B6 D2 5A AC A2 75 19 86 0B
0230 | B7 F1 4E 63 77 A6 1C 14 96 88 22 59 2E BF 89 61
0240 | 84 5E 06 16 98 25 34 96 0E C8 FE 42 A3 BE 67 94
0250 | B4 CC 13 16 C6 48 8C A7 68 7E 04 2B 81 C5 14 E0
0260 | F6 7B 07 41 F7 CF 10 0F D1 A4 7F F8 7F 8C 2B E0
0270 | 25 4C A2 4C 70 95 FD 6D 26 78 F2 FB CB EF 49 D1
0280 | 43 12 18 95 B1 A5 FD 08 51 26 A2 E8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B4876A05B7AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A4020000</code> (676 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200251FFBF5009FE970752B5D65</code> <code>8505D897613175C41BED039521EC400D</code> <code>2710B4BE97CFA260AFC780EB049700B4</code> <code>D663ECF58415886A96643810E63C8951</code> <code>5953999CADFC5BECA2EFE9D8E75E3FBE</code> <code>EFE429DFFE5A5A9A473E183564A6F904</code> <code>5AFEEB30420312B8EED7514EC9FBF3D0</code> <code>60D82DF0AADBCAF1B62658F8828D0BCE</code> <code>4D086D5F2A176230E36C3A47F0277B06</code> <code>B113AA03513F90645FF59C246CA79328</code> <code>C9947EADBF12A82E54D3D9EBE8EDA2E8</code> <code>DF19B3BF86F52703ED4E218A06069FF6</code> <code>514B8311686A4D8A4581B52111939AC8</code> <code>72792FC1B1AA71D94F4CFA6D32A4394E</code> <code>8A782B096AD1BCE940EF77352244651E</code> <code>0AC71CAD349CFD56EC29592F7804AC8E</code> <code>1C146B22F4C88155F0E0B03B2D015F32</code> <code>9AB7DFC10547FEC9A90EF0CDA9BF6D26</code> <code>B6463A73B0842B5F46DC999359DA38C4</code> <code>62F8465FA7F4E2B28FC42F04F93B01BF</code> <code>6774F834EA9E96D855248721E12CE6F5</code> <code>1B63EB1914734E6517371523AB8266D0</code> <code>FADCE29FEFBDCE176482267FD56A4CC7</code> <code>9A005DD97D0C04E7CFDFD31BAC030E19</code> <code>7254006AF9EE7B57A4B16FC68FCC26B5</code> <code>7FA14CA7CB9D8B7AA8B55B1038311BD7</code> <code>40A97A182D3B7557CF1700B74A98927E</code> <code>720161AD78A3652D95E9CE07AE73EC9B</code> <code>D1B6EB7AEAB28863848AFC164DA1D6E6</code> <code>0016FBBCF40B3A3841B8C14D9888BEF2</code> <code>81B825E951D493E7EF09BA8EE7DB65B6</code> <code>D25AACA27519860BB7F14E6377A61C14</code> <code>968822592EBF8961845E061698253496</code> <code>0EC8FE42A3BE6794B4CC1316C6488CA7</code> <code>687E042B81C514E0F67B0741F7CF100F</code> <code>D1A47FF87F8C2BE0254CA24C7095FD6D</code> <code>2678F2FBCBEF49D143121895B1A5FD08</code><br> <code>5126A2E8</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 251FFBF5009FE970752B5D658505D897613175C41BED039521EC400D2710B4BE97CFA260AFC780EB049700B4D663ECF58415886A96643810E63C89515953999CADFC5BECA2EFE9D8E75E3FBEEFE429DFFE5A5A9A473E183564A6F9045AFEEB30420312B8EED7514EC9FBF3D060D82DF0AADBCAF1B62658F8828D0BCE4D086D5F2A176230E36C3A47F0277B06B113AA03513F90645FF59C246CA79328C9947EADBF12A82E54D3D9EBE8EDA2E8DF19B3BF86F52703ED4E218A06069FF6514B8311686A4D8A4581B52111939AC872792FC1B1AA71D94F4CFA6D32A4394E8A782B096AD1BCE940EF77352244651E0AC71CAD349CFD56EC29592F7804AC8E1C146B22F4C88155F0E0B03B2D015F329AB7DFC10547FEC9A90EF0CDA9BF6D26B6463A73B0842B5F46DC999359DA38C462F8465FA7F4E2B28FC42F04F93B01BF6774F834EA9E96D855248721E12CE6F51B63EB1914734E6517371523AB8266D0FADCE29FEFBDCE176482267FD56A4CC79A005DD97D0C04E7CFDFD31BAC030E197254006AF9EE7B57A4B16FC68FCC26B57FA14CA7CB9D8B7AA8B55B1038311BD740A97A182D3B7557CF1700B74A98927E720161AD78A3652D95E9CE07AE73EC9BD1B6EB7AEAB28863848AFC164DA1D6E60016FBBCF40B3A3841B8C14D9888BEF281B825E951D493E7EF09BA8EE7DB65B6D25AACA27519860BB7F14E6377A61C14968822592EBF8961845E0616982534960EC8FE42A3BE6794B4CC1316C6488CA7687E042B81C514E0F67B0741F7CF100FD1A47FF87F8C2BE0254CA24C7095FD6D2678F2FBCBEF49D143121895B1A5FD085126A2E8
tmp_aes_key = EC4E12DCF054836B8BB7329AF7FF3962E001AD7C6C1A4B8F78FE7445AFE4DCB7
tmp_aes_iv = 7DAA180F4D9898201C4C4B2D6950ABDB7A100B485939BB757BAA364A8F7AF9FA</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 76A39DD764F19825531613C998AE0BEE0D2D4D0FBA0D89B5A43AFF1B9E83A6AD77D39BD7719C472B068868835665875FAD81E7F404B1344903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010015337FDEC8BE9D39D4A29944AFAE4E5DB213FF7941568835420B0944FEF4A64628FDB2E3D517CBDC78FE01543D279FDC8188384725503CE07A1B0CB5A59CA6F212B4214C234692CEEBF98E1A2B9BE30CE09B08298078C0740608D06C5CB07A6CBBE380011908ED935A37C8387F607C1085AF307523CE08ACC162A616C5370CA9429708261BA5992B27F3CC9E535A4745FA046B4924EFD25817C18866EBDDF2CB0D71479B46694A4155F3F5E5403251457CEB0FF793FAB4F252E4FEAEBC095C449277640C53CC6CC331EFA004E00F86144B26A062B361EC7DC28049186F48F093CE86036E2991E8BD07684595423717D2CC70D59F678116555F5C4459D24A1C6205B7AF663297B50D06E99A0A
answer = BA0D89B5A43AFF1B9E83A6AD77D39BD7719C472B068868835665875FAD81E7F404B1344903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010015337FDEC8BE9D39D4A29944AFAE4E5DB213FF7941568835420B0944FEF4A64628FDB2E3D517CBDC78FE01543D279FDC8188384725503CE07A1B0CB5A59CA6F212B4214C234692CEEBF98E1A2B9BE30CE09B08298078C0740608D06C5CB07A6CBBE380011908ED935A37C8387F607C1085AF307523CE08ACC162A616C5370CA9429708261BA5992B27F3CC9E535A4745FA046B4924EFD25817C18866EBDDF2CB0D71479B46694A4155F3F5E5403251457CEB0FF793FAB4F252E4FEAEBC095C449277640C53CC6CC331EFA004E00F86144B26A062B361EC7DC28049186F48F093CE86036E2991E8BD07684595423717D2CC70D59F678116555F5C4459D24A1C6205B7AF663297B50D06E99A0A</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 A4 3A FF 1B 9E 83 A6 AD 77 D3 9B D7
0010 | 71 9C 47 2B 06 88 68 83 56 65 87 5F AD 81 E7 F4
0020 | 04 B1 34 49 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 15 33 7F DE C8 BE 9D 39 D4 A2 99 44 AF AE 4E 5D
0140 | B2 13 FF 79 41 56 88 35 42 0B 09 44 FE F4 A6 46
0150 | 28 FD B2 E3 D5 17 CB DC 78 FE 01 54 3D 27 9F DC
0160 | 81 88 38 47 25 50 3C E0 7A 1B 0C B5 A5 9C A6 F2
0170 | 12 B4 21 4C 23 46 92 CE EB F9 8E 1A 2B 9B E3 0C
0180 | E0 9B 08 29 80 78 C0 74 06 08 D0 6C 5C B0 7A 6C
0190 | BB E3 80 01 19 08 ED 93 5A 37 C8 38 7F 60 7C 10
01A0 | 85 AF 30 75 23 CE 08 AC C1 62 A6 16 C5 37 0C A9
01B0 | 42 97 08 26 1B A5 99 2B 27 F3 CC 9E 53 5A 47 45
01C0 | FA 04 6B 49 24 EF D2 58 17 C1 88 66 EB DD F2 CB
01D0 | 0D 71 47 9B 46 69 4A 41 55 F3 F5 E5 40 32 51 45
01E0 | 7C EB 0F F7 93 FA B4 F2 52 E4 FE AE BC 09 5C 44
01F0 | 92 77 64 0C 53 CC 6C C3 31 EF A0 04 E0 0F 86 14
0200 | 4B 26 A0 62 B3 61 EC 7D C2 80 49 18 6F 48 F0 93
0210 | CE 86 03 6E 29 91 E8 BD 07 68 45 95 42 37 17 D2
0220 | CC 70 D5 9F 67 81 16 55 5F 5C 44 59 D2 4A 1C 62
0230 | 05 B7 AF 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010015337FDEC8BE9D39D4A29944</code> <code>AFAE4E5DB213FF7941568835420B0944</code> <code>FEF4A64628FDB2E3D517CBDC78FE0154</code> <code>3D279FDC8188384725503CE07A1B0CB5</code> <code>A59CA6F212B4214C234692CEEBF98E1A</code> <code>2B9BE30CE09B08298078C0740608D06C</code> <code>5CB07A6CBBE380011908ED935A37C838</code> <code>7F607C1085AF307523CE08ACC162A616</code> <code>C5370CA9429708261BA5992B27F3CC9E</code> <code>535A4745FA046B4924EFD25817C18866</code> <code>EBDDF2CB0D71479B46694A4155F3F5E5</code> <code>403251457CEB0FF793FAB4F252E4FEAE</code> <code>BC095C449277640C53CC6CC331EFA004</code> <code>E00F86144B26A062B361EC7DC2804918</code> <code>6F48F093CE86036E2991E8BD07684595</code> <code>423717D2CC70D59F678116555F5C4459</code><br> <code>D24A1C62</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>05B7AF66</code> (1722791685 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 372FF6CC59083F34C934EE5CC3060E32A7EA4A681661FF905290A4C768E8BCA7A45F741BFA32A30D1315583D6BA8559D61AFC022EEFB9B535983E86CFF8D3DE1C2EAC6AA4D890C059B503D412C53D7119F9998735A0270DAE4908836CF90F1CCBFC4AE17F67CA39D00CE52D50AA86CD3DB8E7833F70D090ACFBBC7F57234CACEF23288326BAA2E2A25A650B2F5E1D8E80BC44DE80B7CDC8E81C04E46D395C3F0F1E9F69439AE1FDF404693141C6B39118B73B2754BA4286A39930D97311EB9A0545C928B09EB3688F5811C2CAF1D51240A602FD206B25B8D20302CFB1CF3762E2F1C0527553A1503EF410B84DEF237078E1E199A915A2418AB8ED0432D5387F8</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B5FC4DEFF51E8FBD6F96E8419F9BDD1D9A4BE8FF1D743AA75A4DDC4E507CBAC01C922E0FAB1D64B499418323D43B0C59337AC7DF54F6B4A684D799369C7A7DBE576E953CA03232BE34D697A07A26ED4E8D1EE2FAA18E7344FD7880839576A7E2036378F1C10E83E1EB4674D1BC2ED35F0C3CBB2D9341044EDCF9512946CC1453C0A0870B75FD0F129C6AA87C1D8AC4FA0E9652300368C6D9BF9B0376E2D613656E274AD02B516F40D66B6698C4EF10C1A0BFD328838CB73EA37EBF065E45F4656D710212F26209282E7881227774DFAFDCACEE9B40BC8BA6BD28B67206B4BDD2A911900E4B25F897CFABE6FB3C32D7AC3C46047F40760ED42F44C17393A10E33</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 A4 3A FF 1B 9E 83 A6 AD 77 D3 9B D7
0010 | 71 9C 47 2B 06 88 68 83 56 65 87 5F AD 81 E7 F4
0020 | 04 B1 34 49 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B5 FC 4D EF F5 1E 8F BD 6F 96 E8 41 9F 9B DD 1D
0040 | 9A 4B E8 FF 1D 74 3A A7 5A 4D DC 4E 50 7C BA C0
0050 | 1C 92 2E 0F AB 1D 64 B4 99 41 83 23 D4 3B 0C 59
0060 | 33 7A C7 DF 54 F6 B4 A6 84 D7 99 36 9C 7A 7D BE
0070 | 57 6E 95 3C A0 32 32 BE 34 D6 97 A0 7A 26 ED 4E
0080 | 8D 1E E2 FA A1 8E 73 44 FD 78 80 83 95 76 A7 E2
0090 | 03 63 78 F1 C1 0E 83 E1 EB 46 74 D1 BC 2E D3 5F
00A0 | 0C 3C BB 2D 93 41 04 4E DC F9 51 29 46 CC 14 53
00B0 | C0 A0 87 0B 75 FD 0F 12 9C 6A A8 7C 1D 8A C4 FA
00C0 | 0E 96 52 30 03 68 C6 D9 BF 9B 03 76 E2 D6 13 65
00D0 | 6E 27 4A D0 2B 51 6F 40 D6 6B 66 98 C4 EF 10 C1
00E0 | A0 BF D3 28 83 8C B7 3E A3 7E BF 06 5E 45 F4 65
00F0 | 6D 71 02 12 F2 62 09 28 2E 78 81 22 77 74 DF AF
0100 | DC AC EE 9B 40 BC 8B A6 BD 28 B6 72 06 B4 BD D2
0110 | A9 11 90 0E 4B 25 F8 97 CF AB E6 FB 3C 32 D7 AC
0120 | 3C 46 04 7F 40 76 0E D4 2F 44 C1 73 93 A1 0E 33</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B5FC4DEFF51E8FBD6F96E841</code> <code>9F9BDD1D9A4BE8FF1D743AA75A4DDC4E</code> <code>507CBAC01C922E0FAB1D64B499418323</code> <code>D43B0C59337AC7DF54F6B4A684D79936</code> <code>9C7A7DBE576E953CA03232BE34D697A0</code> <code>7A26ED4E8D1EE2FAA18E7344FD788083</code> <code>9576A7E2036378F1C10E83E1EB4674D1</code> <code>BC2ED35F0C3CBB2D9341044EDCF95129</code> <code>46CC1453C0A0870B75FD0F129C6AA87C</code> <code>1D8AC4FA0E9652300368C6D9BF9B0376</code> <code>E2D613656E274AD02B516F40D66B6698</code> <code>C4EF10C1A0BFD328838CB73EA37EBF06</code> <code>5E45F4656D710212F26209282E788122</code> <code>7774DFAFDCACEE9B40BC8BA6BD28B672</code> <code>06B4BDD2A911900E4B25F897CFABE6FB</code> <code>3C32D7AC3C46047F40760ED42F44C173</code><br> <code>93A10E33</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366A43AFF1B9E83A6AD77D39BD7719C472B068868835665875FAD81E7F404B134490000000000000000FE000100B5FC4DEFF51E8FBD6F96E8419F9BDD1D9A4BE8FF1D743AA75A4DDC4E507CBAC01C922E0FAB1D64B499418323D43B0C59337AC7DF54F6B4A684D799369C7A7DBE576E953CA03232BE34D697A07A26ED4E8D1EE2FAA18E7344FD7880839576A7E2036378F1C10E83E1EB4674D1BC2ED35F0C3CBB2D9341044EDCF9512946CC1453C0A0870B75FD0F129C6AA87C1D8AC4FA0E9652300368C6D9BF9B0376E2D613656E274AD02B516F40D66B6698C4EF10C1A0BFD328838CB73EA37EBF065E45F4656D710212F26209282E7881227774DFAFDCACEE9B40BC8BA6BD28B67206B4BDD2A911900E4B25F897CFABE6FB3C32D7AC3C46047F40760ED42F44C17393A10E33
padding = 599F61580D6D95D0338CA2D6
tmp_aes_key = EC4E12DCF054836B8BB7329AF7FF3962E001AD7C6C1A4B8F78FE7445AFE4DCB7
tmp_aes_iv = 7DAA180F4D9898201C4C4B2D6950ABDB7A100B485939BB757BAA364A8F7AF9FA</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = AF5BCCB6310F4BF0DCA7091B014254CE3234FEEC5D368E414C6835C0D754A71426A88F5A4702CAECE62783EB2AB6B5639612A98D9E7EE1FA2E1162AC79682C7B5648E45EC592A6B7FF7AF6D153D41F678B8DFE2AF9AE5A705C3640C5D4751AD94400B5FE46E4149136A0DDA34863A8F37D705483FD72A499C82FC6B6F469D7BD0941907F035802DDFA1A50904A63F3506E4C8BF7BCD886DCBC812FDF1F12ABCBE3827EDEEB051C278ABC4443B781F51FCC6EE4B395FD6F70E0B714B8561C0D405D7FCBE6227B5BCB7DE08DFE1A4C5DD0B362AD8E79A48145BF4BE1D65090C4965727C658E35DF7AA8D24F1621D3F6DEF8F044BDACF6121E65048D950235B8FACB4AAE5505FA664E7F3308F402F0F54AC2774B2D12D067C71437D3DDDF74073E92473FB1FE6562BCEB90B0BF2ECE8C01DE54C887EEA93F10A25B7970E67682713A4D566EEC59493A17BC96C447EF0EA27</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 4C 38 05 00 05 B7 AF 66
0010 | 78 01 00 00 1F 5F 04 F5 A4 3A FF 1B 9E 83 A6 AD
0020 | 77 D3 9B D7 71 9C 47 2B 06 88 68 83 56 65 87 5F
0030 | AD 81 E7 F4 04 B1 34 49 FE 50 01 00 AF 5B CC B6
0040 | 31 0F 4B F0 DC A7 09 1B 01 42 54 CE 32 34 FE EC
0050 | 5D 36 8E 41 4C 68 35 C0 D7 54 A7 14 26 A8 8F 5A
0060 | 47 02 CA EC E6 27 83 EB 2A B6 B5 63 96 12 A9 8D
0070 | 9E 7E E1 FA 2E 11 62 AC 79 68 2C 7B 56 48 E4 5E
0080 | C5 92 A6 B7 FF 7A F6 D1 53 D4 1F 67 8B 8D FE 2A
0090 | F9 AE 5A 70 5C 36 40 C5 D4 75 1A D9 44 00 B5 FE
00A0 | 46 E4 14 91 36 A0 DD A3 48 63 A8 F3 7D 70 54 83
00B0 | FD 72 A4 99 C8 2F C6 B6 F4 69 D7 BD 09 41 90 7F
00C0 | 03 58 02 DD FA 1A 50 90 4A 63 F3 50 6E 4C 8B F7
00D0 | BC D8 86 DC BC 81 2F DF 1F 12 AB CB E3 82 7E DE
00E0 | EB 05 1C 27 8A BC 44 43 B7 81 F5 1F CC 6E E4 B3
00F0 | 95 FD 6F 70 E0 B7 14 B8 56 1C 0D 40 5D 7F CB E6
0100 | 22 7B 5B CB 7D E0 8D FE 1A 4C 5D D0 B3 62 AD 8E
0110 | 79 A4 81 45 BF 4B E1 D6 50 90 C4 96 57 27 C6 58
0120 | E3 5D F7 AA 8D 24 F1 62 1D 3F 6D EF 8F 04 4B DA
0130 | CF 61 21 E6 50 48 D9 50 23 5B 8F AC B4 AA E5 50
0140 | 5F A6 64 E7 F3 30 8F 40 2F 0F 54 AC 27 74 B2 D1
0150 | 2D 06 7C 71 43 7D 3D DD F7 40 73 E9 24 73 FB 1F
0160 | E6 56 2B CE B9 0B 0B F2 EC E8 C0 1D E5 4C 88 7E
0170 | EA 93 F1 0A 25 B7 97 0E 67 68 27 13 A4 D5 66 EE
0180 | C5 94 93 A1 7B C9 6C 44 7E F0 EA 27</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>4C38050005B7AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100AF5BCCB6310F4BF0DCA7091B</code> <code>014254CE3234FEEC5D368E414C6835C0</code> <code>D754A71426A88F5A4702CAECE62783EB</code> <code>2AB6B5639612A98D9E7EE1FA2E1162AC</code> <code>79682C7B5648E45EC592A6B7FF7AF6D1</code> <code>53D41F678B8DFE2AF9AE5A705C3640C5</code> <code>D4751AD94400B5FE46E4149136A0DDA3</code> <code>4863A8F37D705483FD72A499C82FC6B6</code> <code>F469D7BD0941907F035802DDFA1A5090</code> <code>4A63F3506E4C8BF7BCD886DCBC812FDF</code> <code>1F12ABCBE3827EDEEB051C278ABC4443</code> <code>B781F51FCC6EE4B395FD6F70E0B714B8</code> <code>561C0D405D7FCBE6227B5BCB7DE08DFE</code> <code>1A4C5DD0B362AD8E79A48145BF4BE1D6</code> <code>5090C4965727C658E35DF7AA8D24F162</code> <code>1D3F6DEF8F044BDACF6121E65048D950</code> <code>235B8FACB4AAE5505FA664E7F3308F40</code> <code>2F0F54AC2774B2D12D067C71437D3DDD</code> <code>F74073E92473FB1FE6562BCEB90B0BF2</code> <code>ECE8C01DE54C887EEA93F10A25B7970E</code> <code>67682713A4D566EEC59493A17BC96C44</code><br> <code>7EF0EA27</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 1B7EBC1B3727D12612FB22B4869318F6F564A07E4087BB7E319438504A4C421823117700974A88E4AB09B941E61936C90FFB921F5676114859A5A293B81CF7618EF5AE26C3939DC3405566350098CE930EB24264FC89C114DF50EDDDE2955851D68130784CBA21F3E2D9745B382F3B829F29AC13A302209D4EA28DD6215836748BBC2EDC766FD3A0149A89D923223B97E90AE4405017565B9093169BFDA1AAF805731808BCDDA2ED7A687DC20888BEFD30F0B78F6FB4F2BDB2321F75FD65DF2D9CA706368DE25C72860668E82F903DA9AE474CDD1C24B8222BDF0BCC4958F8A853BA540183BF156BDF046057F586C610597D0E99D09E8A0BC7013696A054E6C4</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 FC 72 62 06 B7 AF 66
0010 | 98 00 00 00 34 F7 CB 3B A4 3A FF 1B 9E 83 A6 AD
0020 | 77 D3 9B D7 71 9C 47 2B 06 88 68 83 56 65 87 5F
0030 | AD 81 E7 F4 04 B1 34 49 B6 2E 31 EC 36 CB 92 BD
0040 | AC 4C F5 85 75 2B 0E 9C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01FC726206B7AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>98000000</code> (152 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A43AFF1B9E83A6AD77D39BD7719C472B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>068868835665875FAD81E7F404B13449</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>B62E31EC36CB92BDAC4CF585752B0E9C</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

