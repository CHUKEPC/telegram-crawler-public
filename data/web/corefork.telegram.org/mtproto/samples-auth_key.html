<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 54 51 01 00 D7 BD B0 66
0010 | 14 00 00 00 F1 8E 7E BE 64 36 30 8B B0 C8 AE 58
0020 | 73 36 04 FC 48 D0 A0 BA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>54510100D7BDB066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 44 3C 26 D7 BD B0 66
0010 | 8C 00 00 00 63 24 16 05 64 36 30 8B B0 C8 AE 58
0020 | 73 36 04 FC 48 D0 A0 BA ED 2B 40 DA 18 15 5C E2
0030 | 44 25 40 39 D7 91 9B 2E 08 25 9E B4 69 B0 C8 C8
0040 | D3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01443C26D7BDB066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>8C000000</code> (140 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08259EB469B0C8C8D3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2710802391754131667</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2710802391754131667</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2710802391754131667 = 1425481901 * 1901674367</code></p>
<pre><code>p = 1425481901
q = 1901674367</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 25 9E B4 69 B0 C8 C8 D3 00 00 00
0010 | 04 54 F7 20 AD 00 00 00 04 71 59 3F 7F 00 00 00
0020 | 64 36 30 8B B0 C8 AE 58 73 36 04 FC 48 D0 A0 BA
0030 | ED 2B 40 DA 18 15 5C E2 44 25 40 39 D7 91 9B 2E
0040 | 5D 74 3D 5D 77 D9 0C F0 7F B4 DC 23 BE 68 AA CC
0050 | EF 9C 9A 65 9A 08 2E 19 A4 25 CF 2F E5 D9 D3 42
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08259EB469B0C8C8D3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2710802391754131667</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0454F720AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1425481901</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0471593F7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1901674367</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>5D743D5D77D90CF07FB4DC23BE68AACC</code> <code>EF9C9A659A082E19A425CF2FE5D9D342</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908259EB469B0C8C8D30000000454F720AD0000000471593F7F0000006436308BB0C8AE58733604FC48D0A0BAED2B40DA18155CE244254039D7919B2E5D743D5D77D90CF07FB4DC23BE68AACCEF9C9A659A082E19A425CF2FE5D9D34202000000
random_padding_bytes = 53E5E19EAE74E5E5675F9D9FC5C719B2AF04E5D9048BBB029A0DA1F04A5D0FA81E1DB54C3AFDA9341677BCE54F386130E95799BFD9503C85CD8FF1CBDE4DD15022BF58CC32BF46E674E12C4119AB09B4BE0D939AC7E344763E801366</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 067DC65EE22FF766C73BB612CCD0453F9D1871F52984D681A3D04726FD32548D3C2E58C0931A628C47E51DF547A022A5780123785F15E20723EBBF398DEAADEE1A7E4270CC29C0C0BD4BC7EE8283C6D49681B7AB00E83DA68D72C70B812BF8A004864C73EECD24CDE96DC912EA50CB5A30CDB2E1A98758E4AEEA03F586F38AFC4EDC0292085F1C5251F3F56A6D6B57D79FFA1C1E61B334EECEF30BA819110F6D89801EED7DDD0ECDCD0535E305776512EF7321B630DBE7EC8350107A500E708C9E2027C5B731632014532FB17E5C3217C2EF7D46D71EB366AE925AA0C725EA7E0FDB2D362F5F916D9C8514B9EF72A6FF233683D8F9459AE9B2D56F62331363B7</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E8 D0 0C 00 D7 BD B0 66
0010 | 40 01 00 00 BE E4 12 D7 64 36 30 8B B0 C8 AE 58
0020 | 73 36 04 FC 48 D0 A0 BA ED 2B 40 DA 18 15 5C E2
0030 | 44 25 40 39 D7 91 9B 2E 04 54 F7 20 AD 00 00 00
0040 | 04 71 59 3F 7F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 06 7D C6 5E E2 2F F7 66 C7 3B B6 12
0060 | CC D0 45 3F 9D 18 71 F5 29 84 D6 81 A3 D0 47 26
0070 | FD 32 54 8D 3C 2E 58 C0 93 1A 62 8C 47 E5 1D F5
0080 | 47 A0 22 A5 78 01 23 78 5F 15 E2 07 23 EB BF 39
0090 | 8D EA AD EE 1A 7E 42 70 CC 29 C0 C0 BD 4B C7 EE
00A0 | 82 83 C6 D4 96 81 B7 AB 00 E8 3D A6 8D 72 C7 0B
00B0 | 81 2B F8 A0 04 86 4C 73 EE CD 24 CD E9 6D C9 12
00C0 | EA 50 CB 5A 30 CD B2 E1 A9 87 58 E4 AE EA 03 F5
00D0 | 86 F3 8A FC 4E DC 02 92 08 5F 1C 52 51 F3 F5 6A
00E0 | 6D 6B 57 D7 9F FA 1C 1E 61 B3 34 EE CE F3 0B A8
00F0 | 19 11 0F 6D 89 80 1E ED 7D DD 0E CD CD 05 35 E3
0100 | 05 77 65 12 EF 73 21 B6 30 DB E7 EC 83 50 10 7A
0110 | 50 0E 70 8C 9E 20 27 C5 B7 31 63 20 14 53 2F B1
0120 | 7E 5C 32 17 C2 EF 7D 46 D7 1E B3 66 AE 92 5A A0
0130 | C7 25 EA 7E 0F DB 2D 36 2F 5F 91 6D 9C 85 14 B9
0140 | EF 72 A6 FF 23 36 83 D8 F9 45 9A E9 B2 D5 6F 62
0150 | 33 13 63 B7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E8D00C00D7BDB066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0454F720AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1425481901</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0471593F7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1901674367</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100067DC65EE22FF766C73BB612</code> <code>CCD0453F9D1871F52984D681A3D04726</code> <code>FD32548D3C2E58C0931A628C47E51DF5</code> <code>47A022A5780123785F15E20723EBBF39</code> <code>8DEAADEE1A7E4270CC29C0C0BD4BC7EE</code> <code>8283C6D49681B7AB00E83DA68D72C70B</code> <code>812BF8A004864C73EECD24CDE96DC912</code> <code>EA50CB5A30CDB2E1A98758E4AEEA03F5</code> <code>86F38AFC4EDC0292085F1C5251F3F56A</code> <code>6D6B57D79FFA1C1E61B334EECEF30BA8</code> <code>19110F6D89801EED7DDD0ECDCD0535E3</code> <code>05776512EF7321B630DBE7EC8350107A</code> <code>500E708C9E2027C5B731632014532FB1</code> <code>7E5C3217C2EF7D46D71EB366AE925AA0</code> <code>C725EA7E0FDB2D362F5F916D9C8514B9</code> <code>EF72A6FF233683D8F9459AE9B2D56F62</code><br> <code>331363B7</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 BC DD E5 D7 BD B0 66
0010 | C4 02 00 00 5C 07 E8 D0 64 36 30 8B B0 C8 AE 58
0020 | 73 36 04 FC 48 D0 A0 BA ED 2B 40 DA 18 15 5C E2
0030 | 44 25 40 39 D7 91 9B 2E FE 50 02 00 DF BE 8A 18
0040 | 6D A7 31 F8 3E 7E 6C 3D 28 3F A6 E5 A1 E7 DF 06
0050 | A9 82 E2 95 4D 0C 09 6C 48 80 3B 68 5F 5F C1 84
0060 | F7 79 EA 05 37 2F D7 CE 65 13 24 55 CE 84 33 F5
0070 | 74 EF C8 7D DF E4 4A F1 81 69 A6 A0 3C AE 6F 81
0080 | A3 02 7C 8A AC 4A 7E 8B F6 8D 07 41 88 EB 27 45
0090 | 32 77 B4 23 1E 3C B3 08 AB BD 95 01 3D A8 5A 77
00A0 | A4 BA B4 45 51 D7 6D 74 C4 58 40 F2 9A BA F9 0B
00B0 | 62 53 C3 14 13 74 31 3E 3F 18 31 6C 56 94 B3 53
00C0 | 8F E7 AE 4D 4F E3 2B 53 3F 24 8C 91 E7 60 36 45
00D0 | A6 6D 79 55 43 4A 4F 1B A1 D9 D4 95 F1 EC 9C 57
00E0 | AB 6D 73 36 7B DD 81 9F 65 C6 04 18 D6 44 2D FA
00F0 | 75 FF B1 E3 92 BA 85 A4 DE 36 97 DE 79 52 A2 4E
0100 | 84 6F 77 E4 FA 2D 65 F2 C4 8D C6 9F 12 8B E3 90
0110 | 7D 2A 45 1B 4A 7D 52 C4 AC 5A 6B 1B 12 36 B4 85
0120 | E0 44 77 AD CD A4 93 B0 C9 54 AF A4 BB E0 01 64
0130 | 5E 13 9D FA D4 52 61 B2 89 04 FB 4C 17 63 DB F0
0140 | 4E 6F C3 6B 39 D9 8A 0C 4A 06 91 96 2A 93 02 63
0150 | C0 2B 3B CE 77 23 BF 30 E0 E3 32 47 27 DB BC 6E
0160 | 87 3A 27 3C 8C 8D 8E 6A EA 6E 1F 1E 21 9A 89 F2
0170 | 3F 82 BE 68 56 72 B4 A5 20 06 D5 39 A2 31 C6 BD
0180 | 5E 7F ED FC 2A 07 DB 7A 16 3E 2D 51 28 16 F1 31
0190 | 0E C4 DC 19 D4 A1 89 D5 3D E9 6D 0B EA 80 72 BA
01A0 | 12 2E E7 47 36 E3 C1 36 91 02 1B 0E B3 42 E8 6D
01B0 | 53 81 8A BC 29 E5 C8 F3 4D CA 80 97 0A 1F 6C 3E
01C0 | 17 1E 4F 14 1B EF D2 0C A2 86 1F 3A BF 34 93 0E
01D0 | 7F 03 C6 BD 6E EC 5A 7A 72 48 1E 7A 59 85 34 BB
01E0 | 0C D9 D8 B9 D4 01 EF 78 FD B1 EF 11 E5 91 3C 98
01F0 | FE C5 BD 63 59 83 D2 40 14 E0 D0 D0 83 B9 A7 EB
0200 | D0 D3 29 0F D9 CF 9D 51 DA C3 F8 18 C2 D2 8D CA
0210 | 55 4D F9 30 D5 62 7C 6F 4F D8 B6 1D 4E AF D0 0C
0220 | 79 53 CF 14 F7 B5 66 A5 EC 68 E6 00 38 E2 6F C9
0230 | C9 05 32 0D C9 9A 65 2B 76 0F F8 6D 62 86 E4 60
0240 | B4 97 0D C6 7E 1F 47 64 52 B5 77 58 4C F7 B6 16
0250 | 39 41 0F 5A 81 F4 7F 87 D6 DB 63 06 A4 36 57 19
0260 | A5 B7 94 A3 22 75 67 4E BB AC 2C 5A F1 4F 16 E8
0270 | 6E 9B 8B 94 39 DA 14 09 FF E9 89 19 00 FD B9 6D
0280 | C7 F1 5F 56 CD 60 56 49 D4 8A 6C 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01BCDDE5D7BDB066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C4020000</code> (708 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200DFBE8A186DA731F83E7E6C3D</code> <code>283FA6E5A1E7DF06A982E2954D0C096C</code> <code>48803B685F5FC184F779EA05372FD7CE</code> <code>65132455CE8433F574EFC87DDFE44AF1</code> <code>8169A6A03CAE6F81A3027C8AAC4A7E8B</code> <code>F68D074188EB27453277B4231E3CB308</code> <code>ABBD95013DA85A77A4BAB44551D76D74</code> <code>C45840F29ABAF90B6253C3141374313E</code> <code>3F18316C5694B3538FE7AE4D4FE32B53</code> <code>3F248C91E7603645A66D7955434A4F1B</code> <code>A1D9D495F1EC9C57AB6D73367BDD819F</code> <code>65C60418D6442DFA75FFB1E392BA85A4</code> <code>DE3697DE7952A24E846F77E4FA2D65F2</code> <code>C48DC69F128BE3907D2A451B4A7D52C4</code> <code>AC5A6B1B1236B485E04477ADCDA493B0</code> <code>C954AFA4BBE001645E139DFAD45261B2</code> <code>8904FB4C1763DBF04E6FC36B39D98A0C</code> <code>4A0691962A930263C02B3BCE7723BF30</code> <code>E0E3324727DBBC6E873A273C8C8D8E6A</code> <code>EA6E1F1E219A89F23F82BE685672B4A5</code> <code>2006D539A231C6BD5E7FEDFC2A07DB7A</code> <code>163E2D512816F1310EC4DC19D4A189D5</code> <code>3DE96D0BEA8072BA122EE74736E3C136</code> <code>91021B0EB342E86D53818ABC29E5C8F3</code> <code>4DCA80970A1F6C3E171E4F141BEFD20C</code> <code>A2861F3ABF34930E7F03C6BD6EEC5A7A</code> <code>72481E7A598534BB0CD9D8B9D401EF78</code> <code>FDB1EF11E5913C98FEC5BD635983D240</code> <code>14E0D0D083B9A7EBD0D3290FD9CF9D51</code> <code>DAC3F818C2D28DCA554DF930D5627C6F</code> <code>4FD8B61D4EAFD00C7953CF14F7B566A5</code> <code>EC68E60038E26FC9C905320DC99A652B</code> <code>760FF86D6286E460B4970DC67E1F4764</code> <code>52B577584CF7B61639410F5A81F47F87</code> <code>D6DB6306A4365719A5B794A32275674E</code> <code>BBAC2C5AF14F16E86E9B8B9439DA1409</code> <code>FFE9891900FDB96DC7F15F56CD605649</code><br> <code>D48A6C1E</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = DFBE8A186DA731F83E7E6C3D283FA6E5A1E7DF06A982E2954D0C096C48803B685F5FC184F779EA05372FD7CE65132455CE8433F574EFC87DDFE44AF18169A6A03CAE6F81A3027C8AAC4A7E8BF68D074188EB27453277B4231E3CB308ABBD95013DA85A77A4BAB44551D76D74C45840F29ABAF90B6253C3141374313E3F18316C5694B3538FE7AE4D4FE32B533F248C91E7603645A66D7955434A4F1BA1D9D495F1EC9C57AB6D73367BDD819F65C60418D6442DFA75FFB1E392BA85A4DE3697DE7952A24E846F77E4FA2D65F2C48DC69F128BE3907D2A451B4A7D52C4AC5A6B1B1236B485E04477ADCDA493B0C954AFA4BBE001645E139DFAD45261B28904FB4C1763DBF04E6FC36B39D98A0C4A0691962A930263C02B3BCE7723BF30E0E3324727DBBC6E873A273C8C8D8E6AEA6E1F1E219A89F23F82BE685672B4A52006D539A231C6BD5E7FEDFC2A07DB7A163E2D512816F1310EC4DC19D4A189D53DE96D0BEA8072BA122EE74736E3C13691021B0EB342E86D53818ABC29E5C8F34DCA80970A1F6C3E171E4F141BEFD20CA2861F3ABF34930E7F03C6BD6EEC5A7A72481E7A598534BB0CD9D8B9D401EF78FDB1EF11E5913C98FEC5BD635983D24014E0D0D083B9A7EBD0D3290FD9CF9D51DAC3F818C2D28DCA554DF930D5627C6F4FD8B61D4EAFD00C7953CF14F7B566A5EC68E60038E26FC9C905320DC99A652B760FF86D6286E460B4970DC67E1F476452B577584CF7B61639410F5A81F47F87D6DB6306A4365719A5B794A32275674EBBAC2C5AF14F16E86E9B8B9439DA1409FFE9891900FDB96DC7F15F56CD605649D48A6C1E
tmp_aes_key = 03A51C1208C2965474261CFEAC6EDD6E079FF78249AF9751278EA1CB2C481B6A
tmp_aes_iv = 9781C3B0387027BE778491F24180DB6DAA5DCB15815BD673DE585CD05D743D5D</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 2A1F1B8D6E127687705F67F02AFFA1186DD0C3C5BA0D89B56436308BB0C8AE58733604FC48D0A0BAED2B40DA18155CE244254039D7919B2E03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B964C4EDE476745F625B69D15CCA0FD827E0AF126BB65536600EBE1D31949935D63BC07C00B324A7F01A7AA69AF8707322226B5EAC51CBD2DC4CBFE038454416BCE7F9C35A6999BA3EB0B5CED2D31E8ED90E555C22DB770423DA3BC42A75E6E7173FA90F9ABC7FA771FB6C57D0DA16F0FD1FD56617D3C556DDB1512BC1808CB44FF63D302CD26F4EEA199A7A7AA049945514DFCC236309DCE6C6B40BE2F272A29339054AD17C0CB45A18C9D41622D44C2309DFB9784BD221D8041C49AEBE05E44161BFE5FADF1930E34E53737597E3251E6064A305636593D7D30998E2E433F46A4CD770B663ACBBAC0D13D358041B561B77FFF23CFBC3959DEEB11891B3FC43D7BDB0667DE8BDDB24652807
answer = BA0D89B56436308BB0C8AE58733604FC48D0A0BAED2B40DA18155CE244254039D7919B2E03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100B964C4EDE476745F625B69D15CCA0FD827E0AF126BB65536600EBE1D31949935D63BC07C00B324A7F01A7AA69AF8707322226B5EAC51CBD2DC4CBFE038454416BCE7F9C35A6999BA3EB0B5CED2D31E8ED90E555C22DB770423DA3BC42A75E6E7173FA90F9ABC7FA771FB6C57D0DA16F0FD1FD56617D3C556DDB1512BC1808CB44FF63D302CD26F4EEA199A7A7AA049945514DFCC236309DCE6C6B40BE2F272A29339054AD17C0CB45A18C9D41622D44C2309DFB9784BD221D8041C49AEBE05E44161BFE5FADF1930E34E53737597E3251E6064A305636593D7D30998E2E433F46A4CD770B663ACBBAC0D13D358041B561B77FFF23CFBC3959DEEB11891B3FC43D7BDB0667DE8BDDB24652807</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 64 36 30 8B B0 C8 AE 58 73 36 04 FC
0010 | 48 D0 A0 BA ED 2B 40 DA 18 15 5C E2 44 25 40 39
0020 | D7 91 9B 2E 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | B9 64 C4 ED E4 76 74 5F 62 5B 69 D1 5C CA 0F D8
0140 | 27 E0 AF 12 6B B6 55 36 60 0E BE 1D 31 94 99 35
0150 | D6 3B C0 7C 00 B3 24 A7 F0 1A 7A A6 9A F8 70 73
0160 | 22 22 6B 5E AC 51 CB D2 DC 4C BF E0 38 45 44 16
0170 | BC E7 F9 C3 5A 69 99 BA 3E B0 B5 CE D2 D3 1E 8E
0180 | D9 0E 55 5C 22 DB 77 04 23 DA 3B C4 2A 75 E6 E7
0190 | 17 3F A9 0F 9A BC 7F A7 71 FB 6C 57 D0 DA 16 F0
01A0 | FD 1F D5 66 17 D3 C5 56 DD B1 51 2B C1 80 8C B4
01B0 | 4F F6 3D 30 2C D2 6F 4E EA 19 9A 7A 7A A0 49 94
01C0 | 55 14 DF CC 23 63 09 DC E6 C6 B4 0B E2 F2 72 A2
01D0 | 93 39 05 4A D1 7C 0C B4 5A 18 C9 D4 16 22 D4 4C
01E0 | 23 09 DF B9 78 4B D2 21 D8 04 1C 49 AE BE 05 E4
01F0 | 41 61 BF E5 FA DF 19 30 E3 4E 53 73 75 97 E3 25
0200 | 1E 60 64 A3 05 63 65 93 D7 D3 09 98 E2 E4 33 F4
0210 | 6A 4C D7 70 B6 63 AC BB AC 0D 13 D3 58 04 1B 56
0220 | 1B 77 FF F2 3C FB C3 95 9D EE B1 18 91 B3 FC 43
0230 | D7 BD B0 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100B964C4EDE476745F625B69D1</code> <code>5CCA0FD827E0AF126BB65536600EBE1D</code> <code>31949935D63BC07C00B324A7F01A7AA6</code> <code>9AF8707322226B5EAC51CBD2DC4CBFE0</code> <code>38454416BCE7F9C35A6999BA3EB0B5CE</code> <code>D2D31E8ED90E555C22DB770423DA3BC4</code> <code>2A75E6E7173FA90F9ABC7FA771FB6C57</code> <code>D0DA16F0FD1FD56617D3C556DDB1512B</code> <code>C1808CB44FF63D302CD26F4EEA199A7A</code> <code>7AA049945514DFCC236309DCE6C6B40B</code> <code>E2F272A29339054AD17C0CB45A18C9D4</code> <code>1622D44C2309DFB9784BD221D8041C49</code> <code>AEBE05E44161BFE5FADF1930E34E5373</code> <code>7597E3251E6064A305636593D7D30998</code> <code>E2E433F46A4CD770B663ACBBAC0D13D3</code> <code>58041B561B77FFF23CFBC3959DEEB118</code><br> <code>91B3FC43</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>D7BDB066</code> (1722858967 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = D854AC6C95D1625563B247B94A88773790020A7E2A16B1BC0ABBB57A672FEF830620B3820114B7D2EC1410AD85C9B654D362407CE8C75613084A76C80569150E5CF75CCA5D6E60AD693CDAF760E183C92BB0343304E0E62AECF4ECCA7373A66F952EA9EDBFE325CC47760736C3C0C60197B98B3A55099D04254CD5BB96A1F16587FCEB55AFC73034E481FCF598A49F95ED145E442FBB3960AB0F53FBBB1A98935C84670FC604460E59DE6905389214399EB5DBFCA523ED696456445A9ABC83F08251F793BBDFA77A15BA604FE320AA167C78D960995777F0D12E1604E03C664CE5129D997456091B435C91A6F2F5D300798910676C92763A8F30810176A261B0</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B6D4BB172A706C233B64C7EDB24531D8FA3BF3A082AD7B1B8A5F1F825CE228A8E0C55533379B32F25AE1AF88E52BE3463C58550024D6CD3349B6645BE2262574C1C7155AF21FDC69D04E8F096C873FF12B35207AFE2FA533A057848869206F3BB0AEAB4EF7767455177A55F0EB28853E3D7A6D50106B6258307F55F5D1A3AEFF85487E73839EDFF5D1775E3D28239C6627F36233C1F701A8878F5EE52D91D46F878EAAE219EC54F5E913B4527B643CBFF643E16FAD38BD896EDAC9794DAF1EB95FB8CA1133FDA1821B17F163E92DC4A82380886AF4C5BFDCDDC1B5966A8EA03DDBA02FBAF27ECB21184A150F6BFA52DFB0D58CD798C7FFCEDE0F42AC64D4BE7F</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 64 36 30 8B B0 C8 AE 58 73 36 04 FC
0010 | 48 D0 A0 BA ED 2B 40 DA 18 15 5C E2 44 25 40 39
0020 | D7 91 9B 2E 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B6 D4 BB 17 2A 70 6C 23 3B 64 C7 ED B2 45 31 D8
0040 | FA 3B F3 A0 82 AD 7B 1B 8A 5F 1F 82 5C E2 28 A8
0050 | E0 C5 55 33 37 9B 32 F2 5A E1 AF 88 E5 2B E3 46
0060 | 3C 58 55 00 24 D6 CD 33 49 B6 64 5B E2 26 25 74
0070 | C1 C7 15 5A F2 1F DC 69 D0 4E 8F 09 6C 87 3F F1
0080 | 2B 35 20 7A FE 2F A5 33 A0 57 84 88 69 20 6F 3B
0090 | B0 AE AB 4E F7 76 74 55 17 7A 55 F0 EB 28 85 3E
00A0 | 3D 7A 6D 50 10 6B 62 58 30 7F 55 F5 D1 A3 AE FF
00B0 | 85 48 7E 73 83 9E DF F5 D1 77 5E 3D 28 23 9C 66
00C0 | 27 F3 62 33 C1 F7 01 A8 87 8F 5E E5 2D 91 D4 6F
00D0 | 87 8E AA E2 19 EC 54 F5 E9 13 B4 52 7B 64 3C BF
00E0 | F6 43 E1 6F AD 38 BD 89 6E DA C9 79 4D AF 1E B9
00F0 | 5F B8 CA 11 33 FD A1 82 1B 17 F1 63 E9 2D C4 A8
0100 | 23 80 88 6A F4 C5 BF DC DD C1 B5 96 6A 8E A0 3D
0110 | DB A0 2F BA F2 7E CB 21 18 4A 15 0F 6B FA 52 DF
0120 | B0 D5 8C D7 98 C7 FF CE DE 0F 42 AC 64 D4 BE 7F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B6D4BB172A706C233B64C7ED</code> <code>B24531D8FA3BF3A082AD7B1B8A5F1F82</code> <code>5CE228A8E0C55533379B32F25AE1AF88</code> <code>E52BE3463C58550024D6CD3349B6645B</code> <code>E2262574C1C7155AF21FDC69D04E8F09</code> <code>6C873FF12B35207AFE2FA533A0578488</code> <code>69206F3BB0AEAB4EF7767455177A55F0</code> <code>EB28853E3D7A6D50106B6258307F55F5</code> <code>D1A3AEFF85487E73839EDFF5D1775E3D</code> <code>28239C6627F36233C1F701A8878F5EE5</code> <code>2D91D46F878EAAE219EC54F5E913B452</code> <code>7B643CBFF643E16FAD38BD896EDAC979</code> <code>4DAF1EB95FB8CA1133FDA1821B17F163</code> <code>E92DC4A82380886AF4C5BFDCDDC1B596</code> <code>6A8EA03DDBA02FBAF27ECB21184A150F</code> <code>6BFA52DFB0D58CD798C7FFCEDE0F42AC</code><br> <code>64D4BE7F</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643666436308BB0C8AE58733604FC48D0A0BAED2B40DA18155CE244254039D7919B2E0000000000000000FE000100B6D4BB172A706C233B64C7EDB24531D8FA3BF3A082AD7B1B8A5F1F825CE228A8E0C55533379B32F25AE1AF88E52BE3463C58550024D6CD3349B6645BE2262574C1C7155AF21FDC69D04E8F096C873FF12B35207AFE2FA533A057848869206F3BB0AEAB4EF7767455177A55F0EB28853E3D7A6D50106B6258307F55F5D1A3AEFF85487E73839EDFF5D1775E3D28239C6627F36233C1F701A8878F5EE52D91D46F878EAAE219EC54F5E913B4527B643CBFF643E16FAD38BD896EDAC9794DAF1EB95FB8CA1133FDA1821B17F163E92DC4A82380886AF4C5BFDCDDC1B5966A8EA03DDBA02FBAF27ECB21184A150F6BFA52DFB0D58CD798C7FFCEDE0F42AC64D4BE7F
padding = CBF50C1AA24F2F9BE4EF5E14
tmp_aes_key = 03A51C1208C2965474261CFEAC6EDD6E079FF78249AF9751278EA1CB2C481B6A
tmp_aes_iv = 9781C3B0387027BE778491F24180DB6DAA5DCB15815BD673DE585CD05D743D5D</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 60D6E6FFA47DF5A111DF2A563F2C275223F33AFD5B9A5C5695AA94F3C84F38909E60FF40546716A5940F0EB620B0E8A1B23A45E5E9E304B51DA151350C8659C86355093CD60305C73934516C4AE741BB620EC2F18E5AA0D74055323B81FFFE389FF06E172A4D88106F81FE1EFF3CE57D3EF86CC1FDF9E18F3EA1B6BFA3B5164906A1F554FF12E8411C349218443CAD0E4D34304DA8FE2B706E144F00A750BB9560A2A4640C3275F69BCE26759AE30F2DE5213D40BE0B7AA342721531A07AF9A70B1DF68E7CF206535C6D0FA4562C3EC2396460D630978E5311BD075A027B58161BC2723F1AEC06D41F0BE06C7213A2EF6AA8E7CCED9FA70696ED5FF9BBBA821252FB1CAD8B00AED6EDFA89E61623B644FB2CCA6FF8B539CE1C022E5E2938B62F29794FB6EB37BC56F1A6E721FF80791DB84B98F6417A3FCEDC84A101BF51B665D05D9E0FB31599D0D8826A87DAB218E8</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B4 20 0D 00 D8 BD B0 66
0010 | 78 01 00 00 1F 5F 04 F5 64 36 30 8B B0 C8 AE 58
0020 | 73 36 04 FC 48 D0 A0 BA ED 2B 40 DA 18 15 5C E2
0030 | 44 25 40 39 D7 91 9B 2E FE 50 01 00 60 D6 E6 FF
0040 | A4 7D F5 A1 11 DF 2A 56 3F 2C 27 52 23 F3 3A FD
0050 | 5B 9A 5C 56 95 AA 94 F3 C8 4F 38 90 9E 60 FF 40
0060 | 54 67 16 A5 94 0F 0E B6 20 B0 E8 A1 B2 3A 45 E5
0070 | E9 E3 04 B5 1D A1 51 35 0C 86 59 C8 63 55 09 3C
0080 | D6 03 05 C7 39 34 51 6C 4A E7 41 BB 62 0E C2 F1
0090 | 8E 5A A0 D7 40 55 32 3B 81 FF FE 38 9F F0 6E 17
00A0 | 2A 4D 88 10 6F 81 FE 1E FF 3C E5 7D 3E F8 6C C1
00B0 | FD F9 E1 8F 3E A1 B6 BF A3 B5 16 49 06 A1 F5 54
00C0 | FF 12 E8 41 1C 34 92 18 44 3C AD 0E 4D 34 30 4D
00D0 | A8 FE 2B 70 6E 14 4F 00 A7 50 BB 95 60 A2 A4 64
00E0 | 0C 32 75 F6 9B CE 26 75 9A E3 0F 2D E5 21 3D 40
00F0 | BE 0B 7A A3 42 72 15 31 A0 7A F9 A7 0B 1D F6 8E
0100 | 7C F2 06 53 5C 6D 0F A4 56 2C 3E C2 39 64 60 D6
0110 | 30 97 8E 53 11 BD 07 5A 02 7B 58 16 1B C2 72 3F
0120 | 1A EC 06 D4 1F 0B E0 6C 72 13 A2 EF 6A A8 E7 CC
0130 | ED 9F A7 06 96 ED 5F F9 BB BA 82 12 52 FB 1C AD
0140 | 8B 00 AE D6 ED FA 89 E6 16 23 B6 44 FB 2C CA 6F
0150 | F8 B5 39 CE 1C 02 2E 5E 29 38 B6 2F 29 79 4F B6
0160 | EB 37 BC 56 F1 A6 E7 21 FF 80 79 1D B8 4B 98 F6
0170 | 41 7A 3F CE DC 84 A1 01 BF 51 B6 65 D0 5D 9E 0F
0180 | B3 15 99 D0 D8 82 6A 87 DA B2 18 E8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B4200D00D8BDB066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010060D6E6FFA47DF5A111DF2A56</code> <code>3F2C275223F33AFD5B9A5C5695AA94F3</code> <code>C84F38909E60FF40546716A5940F0EB6</code> <code>20B0E8A1B23A45E5E9E304B51DA15135</code> <code>0C8659C86355093CD60305C73934516C</code> <code>4AE741BB620EC2F18E5AA0D74055323B</code> <code>81FFFE389FF06E172A4D88106F81FE1E</code> <code>FF3CE57D3EF86CC1FDF9E18F3EA1B6BF</code> <code>A3B5164906A1F554FF12E8411C349218</code> <code>443CAD0E4D34304DA8FE2B706E144F00</code> <code>A750BB9560A2A4640C3275F69BCE2675</code> <code>9AE30F2DE5213D40BE0B7AA342721531</code> <code>A07AF9A70B1DF68E7CF206535C6D0FA4</code> <code>562C3EC2396460D630978E5311BD075A</code> <code>027B58161BC2723F1AEC06D41F0BE06C</code> <code>7213A2EF6AA8E7CCED9FA70696ED5FF9</code> <code>BBBA821252FB1CAD8B00AED6EDFA89E6</code> <code>1623B644FB2CCA6FF8B539CE1C022E5E</code> <code>2938B62F29794FB6EB37BC56F1A6E721</code> <code>FF80791DB84B98F6417A3FCEDC84A101</code> <code>BF51B665D05D9E0FB31599D0D8826A87</code><br> <code>DAB218E8</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 664FDEFF27B2EA281B654E335FAD98CA741B291EAC2147D46A33E13854187C47D1FCA5EFDF00E578EBF8ED7B56AF06092A434513C7E6864AE3170EB0E9B645FCBF20721D51E2802E5C141C136A49EFD871C8B32C9A4C4DCA889CB786C207B1ECE4D49437B41664093425E15E07DB8BABF1E9921F50992A3D42BDC6EF524F01115F07A8597BFCB3ED003FDF19FFC897C89089B5D3505692385F677A7E460A98709FBF92999C0C0253B529AD7105266768616D1EF89A4738B6821DF07F1D3405DA563F1B87198CBA1E9A8693AA78F4299C6E2720DF8A929989A27A778E354AA37ACFD70A04BD706121FBF3537FB36174ABFF39C6ABEEF0163973275DC30ADFAEC1</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 B4 E1 D8 BD B0 66
0010 | 64 00 00 00 34 F7 CB 3B 64 36 30 8B B0 C8 AE 58
0020 | 73 36 04 FC 48 D0 A0 BA ED 2B 40 DA 18 15 5C E2
0030 | 44 25 40 39 D7 91 9B 2E 55 A0 04 E7 96 59 42 6F
0040 | B4 84 D9 96 13 27 CC E8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0158B4E1D8BDB066</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>64000000</code> (100 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6436308BB0C8AE58733604FC48D0A0BA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ED2B40DA18155CE244254039D7919B2E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>55A004E79659426FB484D9961327CCE8</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

