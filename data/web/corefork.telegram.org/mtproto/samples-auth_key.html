<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 1B 08 00 8C 18 DC 68
0010 | 14 00 00 00 F1 8E 7E BE F1 BD 06 BD E8 45 38 1A
0020 | FF 72 3C 12 BD 63 AB CD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A81B08008C18DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 10 DB EA 8C 18 DC 68
0010 | 50 00 00 00 63 24 16 05 F1 BD 06 BD E8 45 38 1A
0020 | FF 72 3C 12 BD 63 AB CD 1D 0A 66 47 6B F2 BF 8C
0030 | AD 88 EC B0 99 0A 7A 82 08 11 70 89 FC E6 9D B6
0040 | 4F 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0110DBEA8C18DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08117089FCE69DB64F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1256656015330227791</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1256656015330227791</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1256656015330227791 = 1089628453 * 1153288547</code></p>
<pre><code>p = 1089628453
q = 1153288547</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 11 70 89 FC E6 9D B6 4F 00 00 00
0010 | 04 40 F2 69 25 00 00 00 04 44 BD C9 63 00 00 00
0020 | F1 BD 06 BD E8 45 38 1A FF 72 3C 12 BD 63 AB CD
0030 | 1D 0A 66 47 6B F2 BF 8C AD 88 EC B0 99 0A 7A 82
0040 | D1 07 07 AC EB C7 98 51 F9 A9 AA 42 C4 2F 07 0B
0050 | 76 97 A0 34 1F 68 12 BF 47 C1 81 CC E4 8A FD EA
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08117089FCE69DB64F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1256656015330227791</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0440F26925000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1089628453</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0444BDC963000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1153288547</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>D10707ACEBC79851F9A9AA42C42F070B</code> <code>7697A0341F6812BF47C181CCE48AFDEA</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908117089FCE69DB64F0000000440F269250000000444BDC963000000F1BD06BDE845381AFF723C12BD63ABCD1D0A66476BF2BF8CAD88ECB0990A7A82D10707ACEBC79851F9A9AA42C42F070B7697A0341F6812BF47C181CCE48AFDEA02000000
random_padding_bytes = D2C590C3653F85C9E362DE8A8AF26D4D1DD25E4A38A600BDF50C2D0DD68C31D02444E1C96219D14250E76A43EC22834809AC24D48D44A03BA8BE2A268A207CBAE76CF6A5DAEFB39FD78C6347DCCAF4B5BD4E67E8BE6457B9ACEDD6EB</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = C3C1C43FA4E43C2961422E158B2996D328F3AF68F4C13D31534DC1AF17A3B368F7AA1C932123B634E7803D23A93D73CB783491A2B0C210AA21221168E61E4209D7316C71976166CABECB3068F2F608386781D8DE094FEBAF851E2173287BD3A26203603BCCCDDADE377BDC13F057F4118692F2FC9EA5F3F7EAA6D3F14BAE159A50A49C3A6E00F4AA7AA97B1AA05B774A01D69E874A600DCC1C5038C30C6F642F817BBC3A51406EC25EDEFCA4506686FA281CD336904F97E426FCA5A3F7C11F13EB3615AEFFC7EE2BEEDA8F4EC0BEF933DCB117492D3F2D749B9E8BF532A7F2F18D6A20E4B43173057E3FF4215C2F83FF123FB39BC7CF4470A87CB15C9CF1EC4B</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 FC 04 02 00 8D 18 DC 68
0010 | 40 01 00 00 BE E4 12 D7 F1 BD 06 BD E8 45 38 1A
0020 | FF 72 3C 12 BD 63 AB CD 1D 0A 66 47 6B F2 BF 8C
0030 | AD 88 EC B0 99 0A 7A 82 04 40 F2 69 25 00 00 00
0040 | 04 44 BD C9 63 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 C3 C1 C4 3F A4 E4 3C 29 61 42 2E 15
0060 | 8B 29 96 D3 28 F3 AF 68 F4 C1 3D 31 53 4D C1 AF
0070 | 17 A3 B3 68 F7 AA 1C 93 21 23 B6 34 E7 80 3D 23
0080 | A9 3D 73 CB 78 34 91 A2 B0 C2 10 AA 21 22 11 68
0090 | E6 1E 42 09 D7 31 6C 71 97 61 66 CA BE CB 30 68
00A0 | F2 F6 08 38 67 81 D8 DE 09 4F EB AF 85 1E 21 73
00B0 | 28 7B D3 A2 62 03 60 3B CC CD DA DE 37 7B DC 13
00C0 | F0 57 F4 11 86 92 F2 FC 9E A5 F3 F7 EA A6 D3 F1
00D0 | 4B AE 15 9A 50 A4 9C 3A 6E 00 F4 AA 7A A9 7B 1A
00E0 | A0 5B 77 4A 01 D6 9E 87 4A 60 0D CC 1C 50 38 C3
00F0 | 0C 6F 64 2F 81 7B BC 3A 51 40 6E C2 5E DE FC A4
0100 | 50 66 86 FA 28 1C D3 36 90 4F 97 E4 26 FC A5 A3
0110 | F7 C1 1F 13 EB 36 15 AE FF C7 EE 2B EE DA 8F 4E
0120 | C0 BE F9 33 DC B1 17 49 2D 3F 2D 74 9B 9E 8B F5
0130 | 32 A7 F2 F1 8D 6A 20 E4 B4 31 73 05 7E 3F F4 21
0140 | 5C 2F 83 FF 12 3F B3 9B C7 CF 44 70 A8 7C B1 5C
0150 | 9C F1 EC 4B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>FC0402008D18DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0440F26925000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1089628453</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0444BDC963000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1153288547</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100C3C1C43FA4E43C2961422E15</code> <code>8B2996D328F3AF68F4C13D31534DC1AF</code> <code>17A3B368F7AA1C932123B634E7803D23</code> <code>A93D73CB783491A2B0C210AA21221168</code> <code>E61E4209D7316C71976166CABECB3068</code> <code>F2F608386781D8DE094FEBAF851E2173</code> <code>287BD3A26203603BCCCDDADE377BDC13</code> <code>F057F4118692F2FC9EA5F3F7EAA6D3F1</code> <code>4BAE159A50A49C3A6E00F4AA7AA97B1A</code> <code>A05B774A01D69E874A600DCC1C5038C3</code> <code>0C6F642F817BBC3A51406EC25EDEFCA4</code> <code>506686FA281CD336904F97E426FCA5A3</code> <code>F7C11F13EB3615AEFFC7EE2BEEDA8F4E</code> <code>C0BEF933DCB117492D3F2D749B9E8BF5</code> <code>32A7F2F18D6A20E4B43173057E3FF421</code> <code>5C2F83FF123FB39BC7CF4470A87CB15C</code><br> <code>9CF1EC4B</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 DC 27 23 8D 18 DC 68
0010 | 78 02 00 00 5C 07 E8 D0 F1 BD 06 BD E8 45 38 1A
0020 | FF 72 3C 12 BD 63 AB CD 1D 0A 66 47 6B F2 BF 8C
0030 | AD 88 EC B0 99 0A 7A 82 FE 50 02 00 15 D7 03 23
0040 | 40 85 CD 0A 5F CE 6C 10 7C 41 BC 0C 40 10 27 88
0050 | A2 EF E0 B1 D6 ED 84 7C 46 71 AE FE 5E 96 7B 6D
0060 | A4 34 48 6F 51 EC B6 50 2B 70 77 9A D9 1F A3 F5
0070 | D3 2A 8C 25 48 70 54 80 59 81 A6 4D D3 FE 36 A0
0080 | 9B 00 2E FE 0A BF 03 A9 32 9D 30 21 B0 A7 0E FC
0090 | AA 95 99 6D 86 15 2A 7B 3E 67 47 B1 B5 43 83 A4
00A0 | 69 A8 2B AD D4 83 9A 07 8F 9A 0D 91 1A 43 AD 46
00B0 | E3 14 36 5D 8C 6A 0A 89 70 B8 41 75 6F 87 66 62
00C0 | C7 35 99 DF 76 5D 84 64 B0 EA F9 4E 09 BE C1 DC
00D0 | BE 17 F9 D2 0A C1 61 1C 92 F5 AE BF B6 76 E1 87
00E0 | 6E A7 25 72 A6 F8 AD 97 66 11 1A FB 40 21 FB 3D
00F0 | A9 84 76 BE 70 40 B6 47 04 1F DB A6 14 7C 90 28
0100 | F1 F6 39 20 C5 F2 F7 B4 A5 A2 DE BE D8 13 93 5F
0110 | 4C 00 92 B8 E7 58 8C CB 31 81 EE 6E A2 A6 89 2D
0120 | 22 E3 2E 74 DB 67 A0 5E FF 71 59 D0 9A 63 A0 86
0130 | 10 03 CC 15 C7 98 F7 59 C8 56 10 7C A3 B3 42 29
0140 | 14 33 D4 C7 CE 46 69 A7 F9 0E D4 3A FA 67 50 6C
0150 | 3C 49 8E 78 9B 63 94 7C 03 E9 AF 0E 1D 1C 72 72
0160 | 49 43 E8 2D 30 75 76 58 D0 67 40 6F 17 30 57 E7
0170 | C3 AE D9 E3 A7 A2 3C 61 58 16 73 CA 65 26 A0 B6
0180 | C4 6D 85 98 B3 FB FE DA F8 DC F0 81 75 01 D6 B9
0190 | 56 CB E6 43 B7 18 F8 31 37 5B 00 66 2C 82 60 EA
01A0 | 54 3A 3F 3F 51 A4 75 1B 6D 45 E9 C1 7C D6 C7 C6
01B0 | 31 EE C4 FB 9C 30 95 7B 21 80 12 C3 83 06 C0 0C
01C0 | 42 F5 3D A7 51 6D D0 4D 89 DB 69 D0 AE 2F D2 7F
01D0 | E7 29 A6 F6 7A DD 22 9E 81 1D 31 79 61 A7 62 C1
01E0 | 70 6B 7F 5E 55 95 5F FB B4 27 7F 5B 05 A1 A1 A0
01F0 | 2D 98 FC 91 BC 20 A1 7F C7 01 45 58 44 A7 B4 34
0200 | FB 6E 5A 31 36 B9 96 40 70 C6 03 D3 2C 0F DB 56
0210 | 7F 41 2B 8D 52 D4 6D D8 B7 7E 32 30 3B 76 78 F8
0220 | 1A BC 49 CC DB 1C E5 43 4D 2F C1 79 FD 73 FE C6
0230 | D3 9A 4A D5 36 26 3B 7D 7B 3B 16 86 3A 2B D6 D0
0240 | A5 0D 64 EA FF FB 66 AB B0 43 F4 76 10 05 CE 97
0250 | 8C 9D B9 A0 26 F3 7E 03 04 0E 4D C6 46 60 7F F5
0260 | 75 21 51 E5 F1 05 EF F3 E1 DD 1E 04 91 E3 E0 1F
0270 | E4 3F 5B 16 FD 51 13 F4 23 94 15 16 64 8B 26 39
0280 | BE 11 A4 FA 5D CD 1D 48 01 E1 A0 80</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01DC27238D18DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020015D703234085CD0A5FCE6C10</code> <code>7C41BC0C40102788A2EFE0B1D6ED847C</code> <code>4671AEFE5E967B6DA434486F51ECB650</code> <code>2B70779AD91FA3F5D32A8C2548705480</code> <code>5981A64DD3FE36A09B002EFE0ABF03A9</code> <code>329D3021B0A70EFCAA95996D86152A7B</code> <code>3E6747B1B54383A469A82BADD4839A07</code> <code>8F9A0D911A43AD46E314365D8C6A0A89</code> <code>70B841756F876662C73599DF765D8464</code> <code>B0EAF94E09BEC1DCBE17F9D20AC1611C</code> <code>92F5AEBFB676E1876EA72572A6F8AD97</code> <code>66111AFB4021FB3DA98476BE7040B647</code> <code>041FDBA6147C9028F1F63920C5F2F7B4</code> <code>A5A2DEBED813935F4C0092B8E7588CCB</code> <code>3181EE6EA2A6892D22E32E74DB67A05E</code> <code>FF7159D09A63A0861003CC15C798F759</code> <code>C856107CA3B342291433D4C7CE4669A7</code> <code>F90ED43AFA67506C3C498E789B63947C</code> <code>03E9AF0E1D1C72724943E82D30757658</code> <code>D067406F173057E7C3AED9E3A7A23C61</code> <code>581673CA6526A0B6C46D8598B3FBFEDA</code> <code>F8DCF0817501D6B956CBE643B718F831</code> <code>375B00662C8260EA543A3F3F51A4751B</code> <code>6D45E9C17CD6C7C631EEC4FB9C30957B</code> <code>218012C38306C00C42F53DA7516DD04D</code> <code>89DB69D0AE2FD27FE729A6F67ADD229E</code> <code>811D317961A762C1706B7F5E55955FFB</code> <code>B4277F5B05A1A1A02D98FC91BC20A17F</code> <code>C701455844A7B434FB6E5A3136B99640</code> <code>70C603D32C0FDB567F412B8D52D46DD8</code> <code>B77E32303B7678F81ABC49CCDB1CE543</code> <code>4D2FC179FD73FEC6D39A4AD536263B7D</code> <code>7B3B16863A2BD6D0A50D64EAFFFB66AB</code> <code>B043F4761005CE978C9DB9A026F37E03</code> <code>040E4DC646607FF5752151E5F105EFF3</code> <code>E1DD1E0491E3E01FE43F5B16FD5113F4</code> <code>23941516648B2639BE11A4FA5DCD1D48</code><br> <code>01E1A080</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 15D703234085CD0A5FCE6C107C41BC0C40102788A2EFE0B1D6ED847C4671AEFE5E967B6DA434486F51ECB6502B70779AD91FA3F5D32A8C25487054805981A64DD3FE36A09B002EFE0ABF03A9329D3021B0A70EFCAA95996D86152A7B3E6747B1B54383A469A82BADD4839A078F9A0D911A43AD46E314365D8C6A0A8970B841756F876662C73599DF765D8464B0EAF94E09BEC1DCBE17F9D20AC1611C92F5AEBFB676E1876EA72572A6F8AD9766111AFB4021FB3DA98476BE7040B647041FDBA6147C9028F1F63920C5F2F7B4A5A2DEBED813935F4C0092B8E7588CCB3181EE6EA2A6892D22E32E74DB67A05EFF7159D09A63A0861003CC15C798F759C856107CA3B342291433D4C7CE4669A7F90ED43AFA67506C3C498E789B63947C03E9AF0E1D1C72724943E82D30757658D067406F173057E7C3AED9E3A7A23C61581673CA6526A0B6C46D8598B3FBFEDAF8DCF0817501D6B956CBE643B718F831375B00662C8260EA543A3F3F51A4751B6D45E9C17CD6C7C631EEC4FB9C30957B218012C38306C00C42F53DA7516DD04D89DB69D0AE2FD27FE729A6F67ADD229E811D317961A762C1706B7F5E55955FFBB4277F5B05A1A1A02D98FC91BC20A17FC701455844A7B434FB6E5A3136B9964070C603D32C0FDB567F412B8D52D46DD8B77E32303B7678F81ABC49CCDB1CE5434D2FC179FD73FEC6D39A4AD536263B7D7B3B16863A2BD6D0A50D64EAFFFB66ABB043F4761005CE978C9DB9A026F37E03040E4DC646607FF5752151E5F105EFF3E1DD1E0491E3E01FE43F5B16FD5113F423941516648B2639BE11A4FA5DCD1D4801E1A080
tmp_aes_key = 50FA0D1755E63617AC9BE62359F53FD2EC8E8CF1DDAA6D49642AD380C58BC27D
tmp_aes_iv = 7AD76584391EA69DD17B026FAC59B448C30131AD99CA7CAE4CFB93EFD10707AC</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 35255AED229BE8691CC1411256165F50138B7D84BA0D89B5F1BD06BDE845381AFF723C12BD63ABCD1D0A66476BF2BF8CAD88ECB0990A7A8203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100515A04DFE88277FFB035C2DA007E49B5980FA5455800FFFC5048724F5326C97CA9E0C71AB28E074E1D5F902BBA3BA464E8D2DD5962828985940300B8268F002F2566501E00DA65C40042528F26B48CA55FC2B116AE3E02F374DEEB1A6819D194EA76CD5EC99E13FCB45A9153E0E4E71AC97DDDFBFD5C7E41245E668DCE11EABEF6F64AAC37D05118E94177D3EC0996FE8C4C5BA4CE410AC80071212CA720DA30CF354798A35915F8E3A16D95EB3DA58CB91217AFC8F633C429294AE75C69D51B2DB05240E049296FA2A2B54A6B700AB6B9C678A550B4B98C04D887AA2A608D5783D97776AD54CAF72765383054A651803411AA25B6E9E7D4EAFB956DE183CC578D18DC68E78AF600FE2ED2E9
answer = BA0D89B5F1BD06BDE845381AFF723C12BD63ABCD1D0A66476BF2BF8CAD88ECB0990A7A8203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100515A04DFE88277FFB035C2DA007E49B5980FA5455800FFFC5048724F5326C97CA9E0C71AB28E074E1D5F902BBA3BA464E8D2DD5962828985940300B8268F002F2566501E00DA65C40042528F26B48CA55FC2B116AE3E02F374DEEB1A6819D194EA76CD5EC99E13FCB45A9153E0E4E71AC97DDDFBFD5C7E41245E668DCE11EABEF6F64AAC37D05118E94177D3EC0996FE8C4C5BA4CE410AC80071212CA720DA30CF354798A35915F8E3A16D95EB3DA58CB91217AFC8F633C429294AE75C69D51B2DB05240E049296FA2A2B54A6B700AB6B9C678A550B4B98C04D887AA2A608D5783D97776AD54CAF72765383054A651803411AA25B6E9E7D4EAFB956DE183CC578D18DC68E78AF600FE2ED2E9</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 F1 BD 06 BD E8 45 38 1A FF 72 3C 12
0010 | BD 63 AB CD 1D 0A 66 47 6B F2 BF 8C AD 88 EC B0
0020 | 99 0A 7A 82 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 51 5A 04 DF E8 82 77 FF B0 35 C2 DA 00 7E 49 B5
0140 | 98 0F A5 45 58 00 FF FC 50 48 72 4F 53 26 C9 7C
0150 | A9 E0 C7 1A B2 8E 07 4E 1D 5F 90 2B BA 3B A4 64
0160 | E8 D2 DD 59 62 82 89 85 94 03 00 B8 26 8F 00 2F
0170 | 25 66 50 1E 00 DA 65 C4 00 42 52 8F 26 B4 8C A5
0180 | 5F C2 B1 16 AE 3E 02 F3 74 DE EB 1A 68 19 D1 94
0190 | EA 76 CD 5E C9 9E 13 FC B4 5A 91 53 E0 E4 E7 1A
01A0 | C9 7D DD FB FD 5C 7E 41 24 5E 66 8D CE 11 EA BE
01B0 | F6 F6 4A AC 37 D0 51 18 E9 41 77 D3 EC 09 96 FE
01C0 | 8C 4C 5B A4 CE 41 0A C8 00 71 21 2C A7 20 DA 30
01D0 | CF 35 47 98 A3 59 15 F8 E3 A1 6D 95 EB 3D A5 8C
01E0 | B9 12 17 AF C8 F6 33 C4 29 29 4A E7 5C 69 D5 1B
01F0 | 2D B0 52 40 E0 49 29 6F A2 A2 B5 4A 6B 70 0A B6
0200 | B9 C6 78 A5 50 B4 B9 8C 04 D8 87 AA 2A 60 8D 57
0210 | 83 D9 77 76 AD 54 CA F7 27 65 38 30 54 A6 51 80
0220 | 34 11 AA 25 B6 E9 E7 D4 EA FB 95 6D E1 83 CC 57
0230 | 8D 18 DC 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100515A04DFE88277FFB035C2DA</code> <code>007E49B5980FA5455800FFFC5048724F</code> <code>5326C97CA9E0C71AB28E074E1D5F902B</code> <code>BA3BA464E8D2DD5962828985940300B8</code> <code>268F002F2566501E00DA65C40042528F</code> <code>26B48CA55FC2B116AE3E02F374DEEB1A</code> <code>6819D194EA76CD5EC99E13FCB45A9153</code> <code>E0E4E71AC97DDDFBFD5C7E41245E668D</code> <code>CE11EABEF6F64AAC37D05118E94177D3</code> <code>EC0996FE8C4C5BA4CE410AC80071212C</code> <code>A720DA30CF354798A35915F8E3A16D95</code> <code>EB3DA58CB91217AFC8F633C429294AE7</code> <code>5C69D51B2DB05240E049296FA2A2B54A</code> <code>6B700AB6B9C678A550B4B98C04D887AA</code> <code>2A608D5783D97776AD54CAF727653830</code> <code>54A651803411AA25B6E9E7D4EAFB956D</code><br> <code>E183CC57</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>8D18DC68</code> (1759254669 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 7DE7700ECB4664127E388CE3B0675EC2D898B98508026579390F732861560A3DB1AE774EFEBF0E2C860303279DC2287A82392DA47D5CFB809D70D5E8D8D4D53704AEF24C1209396396FC16591AC034971B7A9D6670707F7425581B7D02FE71CF139B936544256363AB58F494548627C6FAC2B3BC0953F0B273E63F3D266EFC99B36ECFFE6703829B863884A7509BF0080437AF68E02F8B660DDDC396F753CF98D6E06A56ECF52C2A4C6E26DE864F496705527ADF01913EE5633D0B250D7A44286CB8F92A2625B9041B437DE5B0F2B1DD62B6FE644613FE38F97FD581A1214964D80009F621179FE2ECC2215DD06C37164BAB92D4874879114681A8DBF273EF52</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 3D8F438F139B9F5B134E7CCC9C4590F97A961CF2F51FB08E8F176083F9E47853E41543C12EED0DC9BB17218CA591070EF532B80E94D21FF75DED3F7E2EE492A332E9D29C94DB3D29D5C9E9B520492C79849E4C95AAC7120AE763D0F04799B4B101895E88B026C6D3465ABBDA84D52AFFB4F26CEFA4A409D883D700BD3CB8A6625E76708180C7B818194B2DD8D138F92D00317D8EF33015019FE6FB95B01FC408C49D2F0D00E5F8BACE7CA968C0C9BE687EE2F7A583EFA5C4775F1B3B06CECDA1505EA7FC1FF21736D4BCE7CB115AAD3155AC3E8B3ED9AAB6FCAAC25DB9E1448B386E8FDA9A7FAC0C01C2297F9EB462A7EDDAA522F7AE04A3FE33277E0AA64CC9</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 F1 BD 06 BD E8 45 38 1A FF 72 3C 12
0010 | BD 63 AB CD 1D 0A 66 47 6B F2 BF 8C AD 88 EC B0
0020 | 99 0A 7A 82 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 3D 8F 43 8F 13 9B 9F 5B 13 4E 7C CC 9C 45 90 F9
0040 | 7A 96 1C F2 F5 1F B0 8E 8F 17 60 83 F9 E4 78 53
0050 | E4 15 43 C1 2E ED 0D C9 BB 17 21 8C A5 91 07 0E
0060 | F5 32 B8 0E 94 D2 1F F7 5D ED 3F 7E 2E E4 92 A3
0070 | 32 E9 D2 9C 94 DB 3D 29 D5 C9 E9 B5 20 49 2C 79
0080 | 84 9E 4C 95 AA C7 12 0A E7 63 D0 F0 47 99 B4 B1
0090 | 01 89 5E 88 B0 26 C6 D3 46 5A BB DA 84 D5 2A FF
00A0 | B4 F2 6C EF A4 A4 09 D8 83 D7 00 BD 3C B8 A6 62
00B0 | 5E 76 70 81 80 C7 B8 18 19 4B 2D D8 D1 38 F9 2D
00C0 | 00 31 7D 8E F3 30 15 01 9F E6 FB 95 B0 1F C4 08
00D0 | C4 9D 2F 0D 00 E5 F8 BA CE 7C A9 68 C0 C9 BE 68
00E0 | 7E E2 F7 A5 83 EF A5 C4 77 5F 1B 3B 06 CE CD A1
00F0 | 50 5E A7 FC 1F F2 17 36 D4 BC E7 CB 11 5A AD 31
0100 | 55 AC 3E 8B 3E D9 AA B6 FC AA C2 5D B9 E1 44 8B
0110 | 38 6E 8F DA 9A 7F AC 0C 01 C2 29 7F 9E B4 62 A7
0120 | ED DA A5 22 F7 AE 04 A3 FE 33 27 7E 0A A6 4C C9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001003D8F438F139B9F5B134E7CCC</code> <code>9C4590F97A961CF2F51FB08E8F176083</code> <code>F9E47853E41543C12EED0DC9BB17218C</code> <code>A591070EF532B80E94D21FF75DED3F7E</code> <code>2EE492A332E9D29C94DB3D29D5C9E9B5</code> <code>20492C79849E4C95AAC7120AE763D0F0</code> <code>4799B4B101895E88B026C6D3465ABBDA</code> <code>84D52AFFB4F26CEFA4A409D883D700BD</code> <code>3CB8A6625E76708180C7B818194B2DD8</code> <code>D138F92D00317D8EF33015019FE6FB95</code> <code>B01FC408C49D2F0D00E5F8BACE7CA968</code> <code>C0C9BE687EE2F7A583EFA5C4775F1B3B</code> <code>06CECDA1505EA7FC1FF21736D4BCE7CB</code> <code>115AAD3155AC3E8B3ED9AAB6FCAAC25D</code> <code>B9E1448B386E8FDA9A7FAC0C01C2297F</code> <code>9EB462A7EDDAA522F7AE04A3FE33277E</code><br> <code>0AA64CC9</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366F1BD06BDE845381AFF723C12BD63ABCD1D0A66476BF2BF8CAD88ECB0990A7A820000000000000000FE0001003D8F438F139B9F5B134E7CCC9C4590F97A961CF2F51FB08E8F176083F9E47853E41543C12EED0DC9BB17218CA591070EF532B80E94D21FF75DED3F7E2EE492A332E9D29C94DB3D29D5C9E9B520492C79849E4C95AAC7120AE763D0F04799B4B101895E88B026C6D3465ABBDA84D52AFFB4F26CEFA4A409D883D700BD3CB8A6625E76708180C7B818194B2DD8D138F92D00317D8EF33015019FE6FB95B01FC408C49D2F0D00E5F8BACE7CA968C0C9BE687EE2F7A583EFA5C4775F1B3B06CECDA1505EA7FC1FF21736D4BCE7CB115AAD3155AC3E8B3ED9AAB6FCAAC25DB9E1448B386E8FDA9A7FAC0C01C2297F9EB462A7EDDAA522F7AE04A3FE33277E0AA64CC9
padding = 817CE0D0763823A06A26A1C1
tmp_aes_key = 50FA0D1755E63617AC9BE62359F53FD2EC8E8CF1DDAA6D49642AD380C58BC27D
tmp_aes_iv = 7AD76584391EA69DD17B026FAC59B448C30131AD99CA7CAE4CFB93EFD10707AC</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 2D9F3BA45A4B71F80C32D42AFBF3690AEAE3A4F154381CC126921B83F3C8EC85A8D1A5537F7C84568829C23EF38634629945432F721EF4A26B8F4AA66AF0AD717EEED3518362163BCCDC342412517A1BFB6A84B8B008C3AA65A3F1D4528514FEF0F5C791CAA502EACE10A06E58A4A6F9624B3D126DAA14F257DCFACB0BB449F320F9A9DA71BDA6A76D5520ABAA0DD4B1E79E9C39B492BAB770656C04D363B57B4ECD33EE0186C48798D8E946A0A5083F99FFAE88995E399F0CEEF2DB0C8EC2E2A784EA78EAD906D0AE7829D981983CE5F3AE511D344CAE3BFDAD2F6F544AF6FFEA8A18B95C11FD3CAE598103E49F724453AC90A9C72748C139595226C96D8EBDFB7803BA838622297F5DF6498F557CC9BA8FD55BE048CBD198D271A82A19E253C3DD7608210528A8EB148FB686F0198ACFA2E4E0DB7F808A4FE17671A6FA049BBF51B5A6EB47C7979C902341CBEA5AB3</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 88 59 08 00 8D 18 DC 68
0010 | 78 01 00 00 1F 5F 04 F5 F1 BD 06 BD E8 45 38 1A
0020 | FF 72 3C 12 BD 63 AB CD 1D 0A 66 47 6B F2 BF 8C
0030 | AD 88 EC B0 99 0A 7A 82 FE 50 01 00 2D 9F 3B A4
0040 | 5A 4B 71 F8 0C 32 D4 2A FB F3 69 0A EA E3 A4 F1
0050 | 54 38 1C C1 26 92 1B 83 F3 C8 EC 85 A8 D1 A5 53
0060 | 7F 7C 84 56 88 29 C2 3E F3 86 34 62 99 45 43 2F
0070 | 72 1E F4 A2 6B 8F 4A A6 6A F0 AD 71 7E EE D3 51
0080 | 83 62 16 3B CC DC 34 24 12 51 7A 1B FB 6A 84 B8
0090 | B0 08 C3 AA 65 A3 F1 D4 52 85 14 FE F0 F5 C7 91
00A0 | CA A5 02 EA CE 10 A0 6E 58 A4 A6 F9 62 4B 3D 12
00B0 | 6D AA 14 F2 57 DC FA CB 0B B4 49 F3 20 F9 A9 DA
00C0 | 71 BD A6 A7 6D 55 20 AB AA 0D D4 B1 E7 9E 9C 39
00D0 | B4 92 BA B7 70 65 6C 04 D3 63 B5 7B 4E CD 33 EE
00E0 | 01 86 C4 87 98 D8 E9 46 A0 A5 08 3F 99 FF AE 88
00F0 | 99 5E 39 9F 0C EE F2 DB 0C 8E C2 E2 A7 84 EA 78
0100 | EA D9 06 D0 AE 78 29 D9 81 98 3C E5 F3 AE 51 1D
0110 | 34 4C AE 3B FD AD 2F 6F 54 4A F6 FF EA 8A 18 B9
0120 | 5C 11 FD 3C AE 59 81 03 E4 9F 72 44 53 AC 90 A9
0130 | C7 27 48 C1 39 59 52 26 C9 6D 8E BD FB 78 03 BA
0140 | 83 86 22 29 7F 5D F6 49 8F 55 7C C9 BA 8F D5 5B
0150 | E0 48 CB D1 98 D2 71 A8 2A 19 E2 53 C3 DD 76 08
0160 | 21 05 28 A8 EB 14 8F B6 86 F0 19 8A CF A2 E4 E0
0170 | DB 7F 80 8A 4F E1 76 71 A6 FA 04 9B BF 51 B5 A6
0180 | EB 47 C7 97 9C 90 23 41 CB EA 5A B3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>885908008D18DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001002D9F3BA45A4B71F80C32D42A</code> <code>FBF3690AEAE3A4F154381CC126921B83</code> <code>F3C8EC85A8D1A5537F7C84568829C23E</code> <code>F38634629945432F721EF4A26B8F4AA6</code> <code>6AF0AD717EEED3518362163BCCDC3424</code> <code>12517A1BFB6A84B8B008C3AA65A3F1D4</code> <code>528514FEF0F5C791CAA502EACE10A06E</code> <code>58A4A6F9624B3D126DAA14F257DCFACB</code> <code>0BB449F320F9A9DA71BDA6A76D5520AB</code> <code>AA0DD4B1E79E9C39B492BAB770656C04</code> <code>D363B57B4ECD33EE0186C48798D8E946</code> <code>A0A5083F99FFAE88995E399F0CEEF2DB</code> <code>0C8EC2E2A784EA78EAD906D0AE7829D9</code> <code>81983CE5F3AE511D344CAE3BFDAD2F6F</code> <code>544AF6FFEA8A18B95C11FD3CAE598103</code> <code>E49F724453AC90A9C72748C139595226</code> <code>C96D8EBDFB7803BA838622297F5DF649</code> <code>8F557CC9BA8FD55BE048CBD198D271A8</code> <code>2A19E253C3DD7608210528A8EB148FB6</code> <code>86F0198ACFA2E4E0DB7F808A4FE17671</code> <code>A6FA049BBF51B5A6EB47C7979C902341</code><br> <code>CBEA5AB3</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 32E2E00DD1DAA2715869A3FBCDD312DA3FE8C55A666D86B08C4B153617AA4485934B678BE8D69308BB8099D85A94DE72C5A5CB484F98C08638DC1A16271DA830D07804D48CBE538BD65297603283B8FA1E5B8EF4FA599C8A4E798428F8CE823D474DB49E25692B702B9441EA61EAE209FD68555ABBC6A7F9D9F5DBDB5915E8C1D127DC13CB34CF89D446B4559767E82471108736C4B5F40726E63B5CAF4DA394F9614522D8B4A6CA7EE7EB464BCBF421E48575351D6E5F17DA154E16C37FFE6370B1D0DD530A795D24F266F07BF039EDF743B19DE4366E7BD53DC77276FED160D66BBC691557D8F2604AE559F57EA1DE8517E5BF5B7C5F1399303D5E531205DE</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 D7 4C 8E 18 DC 68
0010 | 34 00 00 00 34 F7 CB 3B F1 BD 06 BD E8 45 38 1A
0020 | FF 72 3C 12 BD 63 AB CD 1D 0A 66 47 6B F2 BF 8C
0030 | AD 88 EC B0 99 0A 7A 82 C2 EA 75 4C FB 5A B5 6A
0040 | 2C F8 CF 34 BC B8 85 BB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0194D74C8E18DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F1BD06BDE845381AFF723C12BD63ABCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1D0A66476BF2BF8CAD88ECB0990A7A82</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>C2EA754CFB5AB56A2CF8CF34BCB885BB</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

