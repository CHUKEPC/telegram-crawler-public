<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?245" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 32 04 00 41 52 8A 68
0010 | 14 00 00 00 F1 8E 7E BE DB AA 85 4A 1C 88 9A 30
0020 | 57 57 14 FA 90 5D F5 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A832040041528A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 70 C2 85 41 52 8A 68
0010 | 50 00 00 00 63 24 16 05 DB AA 85 4A 1C 88 9A 30
0020 | 57 57 14 FA 90 5D F5 45 15 74 8A 31 D8 BF 86 7C
0030 | 9D 23 12 B3 2C E7 52 AC 08 1E F2 BD 85 34 4F E6
0040 | F9 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0170C28541528A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081EF2BD85344FE6F9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2230053145307768569</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2230053145307768569</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2230053145307768569 = 1151938273 * 1935913753</code></p>
<pre><code>p = 1151938273
q = 1935913753</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1E F2 BD 85 34 4F E6 F9 00 00 00
0010 | 04 44 A9 2E E1 00 00 00 04 73 63 B3 19 00 00 00
0020 | DB AA 85 4A 1C 88 9A 30 57 57 14 FA 90 5D F5 45
0030 | 15 74 8A 31 D8 BF 86 7C 9D 23 12 B3 2C E7 52 AC
0040 | 36 FA 9E 83 49 A8 78 58 8A 89 31 47 7B EE 77 F3
0050 | C7 00 82 7E 14 17 11 14 D6 C8 63 30 8A 39 9B AC
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081EF2BD85344FE6F9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2230053145307768569</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0444A92EE1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1151938273</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>047363B319000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1935913753</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>36FA9E8349A878588A8931477BEE77F3</code> <code>C700827E14171114D6C863308A399BAC</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081EF2BD85344FE6F90000000444A92EE1000000047363B319000000DBAA854A1C889A30575714FA905DF54515748A31D8BF867C9D2312B32CE752AC36FA9E8349A878588A8931477BEE77F3C700827E14171114D6C863308A399BAC02000000
random_padding_bytes = 8FFE0373725F0551010E5299DB120BF4701A994B064701E11BB78F3956845B08E37C59C53F70F43D60B22A311049A26FA31F8F6916F2EDC36ED2891F20038782C8943287E660A4A01F07794AB7DD9C3E40FC687311AC45F3D55DBC64</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = DC232F85427AFA8F1689EEA36106707A766AB770E01B7173241E593D7CC5EE6ED4736F0A198E0107131C4FFBDDD0958E3FD7F9E0C2B8E150C31F42376E56AE2076F7AD45AA853F77F56CB6697DD9055DC8E075FECB638CC8974FFC3438290D706D143928339F63F21442E36ACE8140997019282910E5AD0E39F1D0204AFE831501C6FE5E1CE1D8947DC3DB85569DDBB5FA769C7272BFFA99BB94E049A245022F16C151C09C46A39B1117E0F1C95539AD7C131BBD019035205B63079E6FB017181B4E48FE97E82899D78DAD945264CC2CCF60C801AAB3FF0DF635D8BD55EADB7707AE01F192256BA2752343D292F5726A26C0E72D2888167CCF8F21E8C583EACA</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 68 F2 0D 00 41 52 8A 68
0010 | 40 01 00 00 BE E4 12 D7 DB AA 85 4A 1C 88 9A 30
0020 | 57 57 14 FA 90 5D F5 45 15 74 8A 31 D8 BF 86 7C
0030 | 9D 23 12 B3 2C E7 52 AC 04 44 A9 2E E1 00 00 00
0040 | 04 73 63 B3 19 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 DC 23 2F 85 42 7A FA 8F 16 89 EE A3
0060 | 61 06 70 7A 76 6A B7 70 E0 1B 71 73 24 1E 59 3D
0070 | 7C C5 EE 6E D4 73 6F 0A 19 8E 01 07 13 1C 4F FB
0080 | DD D0 95 8E 3F D7 F9 E0 C2 B8 E1 50 C3 1F 42 37
0090 | 6E 56 AE 20 76 F7 AD 45 AA 85 3F 77 F5 6C B6 69
00A0 | 7D D9 05 5D C8 E0 75 FE CB 63 8C C8 97 4F FC 34
00B0 | 38 29 0D 70 6D 14 39 28 33 9F 63 F2 14 42 E3 6A
00C0 | CE 81 40 99 70 19 28 29 10 E5 AD 0E 39 F1 D0 20
00D0 | 4A FE 83 15 01 C6 FE 5E 1C E1 D8 94 7D C3 DB 85
00E0 | 56 9D DB B5 FA 76 9C 72 72 BF FA 99 BB 94 E0 49
00F0 | A2 45 02 2F 16 C1 51 C0 9C 46 A3 9B 11 17 E0 F1
0100 | C9 55 39 AD 7C 13 1B BD 01 90 35 20 5B 63 07 9E
0110 | 6F B0 17 18 1B 4E 48 FE 97 E8 28 99 D7 8D AD 94
0120 | 52 64 CC 2C CF 60 C8 01 AA B3 FF 0D F6 35 D8 BD
0130 | 55 EA DB 77 07 AE 01 F1 92 25 6B A2 75 23 43 D2
0140 | 92 F5 72 6A 26 C0 E7 2D 28 88 16 7C CF 8F 21 E8
0150 | C5 83 EA CA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>68F20D0041528A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0444A92EE1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1151938273</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>047363B319000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1935913753</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100DC232F85427AFA8F1689EEA3</code> <code>6106707A766AB770E01B7173241E593D</code> <code>7CC5EE6ED4736F0A198E0107131C4FFB</code> <code>DDD0958E3FD7F9E0C2B8E150C31F4237</code> <code>6E56AE2076F7AD45AA853F77F56CB669</code> <code>7DD9055DC8E075FECB638CC8974FFC34</code> <code>38290D706D143928339F63F21442E36A</code> <code>CE8140997019282910E5AD0E39F1D020</code> <code>4AFE831501C6FE5E1CE1D8947DC3DB85</code> <code>569DDBB5FA769C7272BFFA99BB94E049</code> <code>A245022F16C151C09C46A39B1117E0F1</code> <code>C95539AD7C131BBD019035205B63079E</code> <code>6FB017181B4E48FE97E82899D78DAD94</code> <code>5264CC2CCF60C801AAB3FF0DF635D8BD</code> <code>55EADB7707AE01F192256BA2752343D2</code> <code>92F5726A26C0E72D2888167CCF8F21E8</code><br> <code>C583EACA</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 78 85 AB 41 52 8A 68
0010 | 78 02 00 00 5C 07 E8 D0 DB AA 85 4A 1C 88 9A 30
0020 | 57 57 14 FA 90 5D F5 45 15 74 8A 31 D8 BF 86 7C
0030 | 9D 23 12 B3 2C E7 52 AC FE 50 02 00 BD DD 03 37
0040 | B9 C3 6A F9 12 BF 44 4B F4 53 DB CE E8 3C 76 EC
0050 | 7E 9D 79 73 FD C5 26 82 79 D1 80 EB 85 95 4C 67
0060 | 4D 26 84 50 5A 1D 4F 87 41 AE 85 A3 C7 5C 47 95
0070 | D0 1C 61 30 F4 B4 29 5C 5D F7 25 89 72 9F 88 1C
0080 | EB D0 3A 54 C1 91 73 22 3B 5B EB D8 70 A0 3B BA
0090 | FF B7 CE DD E9 86 78 EF 19 5D B3 2C 21 42 6D 9A
00A0 | 2D F7 26 C4 A6 F5 2D 60 88 B3 BB 5E D3 45 78 FD
00B0 | A7 E8 23 8E 24 34 34 B9 3A 5E 77 BA E2 4F E3 4F
00C0 | 45 2E D3 20 15 16 63 EA D4 21 8F 70 6F 88 3B 5C
00D0 | 01 3F C8 33 0A AF DA FF 11 A6 A2 2D 1D 2D E0 26
00E0 | 6A C7 89 2D D1 8F BF C4 F5 D0 23 76 F4 91 03 E8
00F0 | 7F 5B 3D 38 7C DB BB E0 4E B6 E2 D3 4E 2B B6 DB
0100 | 70 3A 85 01 49 20 1F C9 52 79 2D 6E E7 3F AA C4
0110 | 7D 4D 55 61 44 D8 31 7C 0D A5 5A 37 7E 68 5C BD
0120 | 43 26 50 5F 1D A9 B0 7F D7 B5 31 A4 8A 0D BF 1A
0130 | 85 1C 38 2F 63 46 DF 8C 8F 60 6F 10 72 6A 02 1A
0140 | DB C7 0F C2 3D 70 D4 31 30 5A 13 B8 9E 8F FC B9
0150 | 89 D0 A0 02 29 8E 4F 8F 53 F4 93 3E CF 8B 82 97
0160 | 3F AB F0 3D 3E 31 B9 37 63 29 26 A7 15 D5 D6 56
0170 | 39 81 4D B0 88 01 B9 6C CF CC 8B 0E B1 FB 14 29
0180 | 5C C0 98 73 8E 5C 1C 3B DA 0C F7 DE D7 E5 0B 60
0190 | C8 4D 81 B1 B5 36 05 51 28 2E 55 5E C0 1B 89 4F
01A0 | 04 86 3B CD DF EB FB DC E1 4D C9 46 03 C9 1D 5A
01B0 | 9D C4 A2 6A FA 06 92 8C AE 58 FD 1E 47 05 20 65
01C0 | 01 D7 BD 2C 06 00 47 45 82 21 47 E5 E1 98 DE 03
01D0 | 2C C3 C1 77 D1 74 41 BA E9 5D 21 53 C3 64 B6 73
01E0 | 13 FC 9B 71 C5 24 FE 47 7E 06 71 65 FA C7 08 0B
01F0 | F7 E8 40 D9 0F CC 54 5D AF 3F 5A 06 AD 47 BF 60
0200 | 80 18 53 18 CC 5C 24 A8 71 E4 6E 15 E1 2B BC D1
0210 | C4 93 6C C5 AC 14 E0 1E 69 1E D0 6D 8C ED D6 24
0220 | 38 A8 C6 0A E3 F2 F3 43 5A ED 0B 04 D2 5F 0F 5D
0230 | F4 29 DE 2B C5 30 33 D3 BA 33 44 AB DB 26 16 E5
0240 | 5F F6 BC 72 AB 05 E4 13 F8 D1 9E 3B 10 B6 91 73
0250 | 5D F6 2F C7 A9 E7 91 C1 D5 96 1B 6F 26 6C 01 36
0260 | BF 04 C4 FF 6F E4 6B 15 5F 48 E3 E8 FC B9 76 76
0270 | CE C0 AE B2 C2 62 40 CA B5 A8 AE D1 15 83 AF E4
0280 | 08 08 06 93 7F AC 82 1C EF A4 F9 0E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017885AB41528A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200BDDD0337B9C36AF912BF444B</code> <code>F453DBCEE83C76EC7E9D7973FDC52682</code> <code>79D180EB85954C674D2684505A1D4F87</code> <code>41AE85A3C75C4795D01C6130F4B4295C</code> <code>5DF72589729F881CEBD03A54C1917322</code> <code>3B5BEBD870A03BBAFFB7CEDDE98678EF</code> <code>195DB32C21426D9A2DF726C4A6F52D60</code> <code>88B3BB5ED34578FDA7E8238E243434B9</code> <code>3A5E77BAE24FE34F452ED320151663EA</code> <code>D4218F706F883B5C013FC8330AAFDAFF</code> <code>11A6A22D1D2DE0266AC7892DD18FBFC4</code> <code>F5D02376F49103E87F5B3D387CDBBBE0</code> <code>4EB6E2D34E2BB6DB703A850149201FC9</code> <code>52792D6EE73FAAC47D4D556144D8317C</code> <code>0DA55A377E685CBD4326505F1DA9B07F</code> <code>D7B531A48A0DBF1A851C382F6346DF8C</code> <code>8F606F10726A021ADBC70FC23D70D431</code> <code>305A13B89E8FFCB989D0A002298E4F8F</code> <code>53F4933ECF8B82973FABF03D3E31B937</code> <code>632926A715D5D65639814DB08801B96C</code> <code>CFCC8B0EB1FB14295CC098738E5C1C3B</code> <code>DA0CF7DED7E50B60C84D81B1B5360551</code> <code>282E555EC01B894F04863BCDDFEBFBDC</code> <code>E14DC94603C91D5A9DC4A26AFA06928C</code> <code>AE58FD1E4705206501D7BD2C06004745</code> <code>822147E5E198DE032CC3C177D17441BA</code> <code>E95D2153C364B67313FC9B71C524FE47</code> <code>7E067165FAC7080BF7E840D90FCC545D</code> <code>AF3F5A06AD47BF6080185318CC5C24A8</code> <code>71E46E15E12BBCD1C4936CC5AC14E01E</code> <code>691ED06D8CEDD62438A8C60AE3F2F343</code> <code>5AED0B04D25F0F5DF429DE2BC53033D3</code> <code>BA3344ABDB2616E55FF6BC72AB05E413</code> <code>F8D19E3B10B691735DF62FC7A9E791C1</code> <code>D5961B6F266C0136BF04C4FF6FE46B15</code> <code>5F48E3E8FCB97676CEC0AEB2C26240CA</code> <code>B5A8AED11583AFE4080806937FAC821C</code><br> <code>EFA4F90E</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = BDDD0337B9C36AF912BF444BF453DBCEE83C76EC7E9D7973FDC5268279D180EB85954C674D2684505A1D4F8741AE85A3C75C4795D01C6130F4B4295C5DF72589729F881CEBD03A54C19173223B5BEBD870A03BBAFFB7CEDDE98678EF195DB32C21426D9A2DF726C4A6F52D6088B3BB5ED34578FDA7E8238E243434B93A5E77BAE24FE34F452ED320151663EAD4218F706F883B5C013FC8330AAFDAFF11A6A22D1D2DE0266AC7892DD18FBFC4F5D02376F49103E87F5B3D387CDBBBE04EB6E2D34E2BB6DB703A850149201FC952792D6EE73FAAC47D4D556144D8317C0DA55A377E685CBD4326505F1DA9B07FD7B531A48A0DBF1A851C382F6346DF8C8F606F10726A021ADBC70FC23D70D431305A13B89E8FFCB989D0A002298E4F8F53F4933ECF8B82973FABF03D3E31B937632926A715D5D65639814DB08801B96CCFCC8B0EB1FB14295CC098738E5C1C3BDA0CF7DED7E50B60C84D81B1B5360551282E555EC01B894F04863BCDDFEBFBDCE14DC94603C91D5A9DC4A26AFA06928CAE58FD1E4705206501D7BD2C06004745822147E5E198DE032CC3C177D17441BAE95D2153C364B67313FC9B71C524FE477E067165FAC7080BF7E840D90FCC545DAF3F5A06AD47BF6080185318CC5C24A871E46E15E12BBCD1C4936CC5AC14E01E691ED06D8CEDD62438A8C60AE3F2F3435AED0B04D25F0F5DF429DE2BC53033D3BA3344ABDB2616E55FF6BC72AB05E413F8D19E3B10B691735DF62FC7A9E791C1D5961B6F266C0136BF04C4FF6FE46B155F48E3E8FCB97676CEC0AEB2C26240CAB5A8AED11583AFE4080806937FAC821CEFA4F90E
tmp_aes_key = C6331CB507CABE4C5483E86C26ED00C57E4A140B134A464922BE85189DF3527C
tmp_aes_iv = 6D1919367FA19293645D607ED75074EC91211D99EB3040460F3079F436FA9E83</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 2096F40910A73F9697B327C460F87ADDF3B4FD67BA0D89B5DBAA854A1C889A30575714FA905DF54515748A31D8BF867C9D2312B32CE752AC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100473708CB5DC6CF9E8BCBE774197FF65A844BEE9733C908A1D85ABAD26BD4F69D599A34B775F391990B71AFC0C51AA3085282D951F6E6B29A4950C7FC1B54FEDAD091BE42B480DEF0C73B6320310F2F6CD987E845D8481483163B8237AAE27F8897FD0A3F2B82896EFAF43EFF182B4C6A8F29617AEA70166BB5AF5191C3F3E4EE675F708746B94D50A79F4045E138605814FFF570279FD887EAD528FA2E8A26DF424578F9271882FEE3BFF9513E4E4F6B53A886A342D8F2BD571DFA79B5E83F1F5CFE929B913311A38F47DC86EB27945E0EB38A1ADB7DD8952650F9E609B89C0BBF1D2D1F6B6F93D24305E4C9D5BA53D917BB3234155E8654E0256D11CF43CB9841528A68DC0E2571BAE8164B
answer = BA0D89B5DBAA854A1C889A30575714FA905DF54515748A31D8BF867C9D2312B32CE752AC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100473708CB5DC6CF9E8BCBE774197FF65A844BEE9733C908A1D85ABAD26BD4F69D599A34B775F391990B71AFC0C51AA3085282D951F6E6B29A4950C7FC1B54FEDAD091BE42B480DEF0C73B6320310F2F6CD987E845D8481483163B8237AAE27F8897FD0A3F2B82896EFAF43EFF182B4C6A8F29617AEA70166BB5AF5191C3F3E4EE675F708746B94D50A79F4045E138605814FFF570279FD887EAD528FA2E8A26DF424578F9271882FEE3BFF9513E4E4F6B53A886A342D8F2BD571DFA79B5E83F1F5CFE929B913311A38F47DC86EB27945E0EB38A1ADB7DD8952650F9E609B89C0BBF1D2D1F6B6F93D24305E4C9D5BA53D917BB3234155E8654E0256D11CF43CB9841528A68DC0E2571BAE8164B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 DB AA 85 4A 1C 88 9A 30 57 57 14 FA
0010 | 90 5D F5 45 15 74 8A 31 D8 BF 86 7C 9D 23 12 B3
0020 | 2C E7 52 AC 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 47 37 08 CB 5D C6 CF 9E 8B CB E7 74 19 7F F6 5A
0140 | 84 4B EE 97 33 C9 08 A1 D8 5A BA D2 6B D4 F6 9D
0150 | 59 9A 34 B7 75 F3 91 99 0B 71 AF C0 C5 1A A3 08
0160 | 52 82 D9 51 F6 E6 B2 9A 49 50 C7 FC 1B 54 FE DA
0170 | D0 91 BE 42 B4 80 DE F0 C7 3B 63 20 31 0F 2F 6C
0180 | D9 87 E8 45 D8 48 14 83 16 3B 82 37 AA E2 7F 88
0190 | 97 FD 0A 3F 2B 82 89 6E FA F4 3E FF 18 2B 4C 6A
01A0 | 8F 29 61 7A EA 70 16 6B B5 AF 51 91 C3 F3 E4 EE
01B0 | 67 5F 70 87 46 B9 4D 50 A7 9F 40 45 E1 38 60 58
01C0 | 14 FF F5 70 27 9F D8 87 EA D5 28 FA 2E 8A 26 DF
01D0 | 42 45 78 F9 27 18 82 FE E3 BF F9 51 3E 4E 4F 6B
01E0 | 53 A8 86 A3 42 D8 F2 BD 57 1D FA 79 B5 E8 3F 1F
01F0 | 5C FE 92 9B 91 33 11 A3 8F 47 DC 86 EB 27 94 5E
0200 | 0E B3 8A 1A DB 7D D8 95 26 50 F9 E6 09 B8 9C 0B
0210 | BF 1D 2D 1F 6B 6F 93 D2 43 05 E4 C9 D5 BA 53 D9
0220 | 17 BB 32 34 15 5E 86 54 E0 25 6D 11 CF 43 CB 98
0230 | 41 52 8A 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100473708CB5DC6CF9E8BCBE774</code> <code>197FF65A844BEE9733C908A1D85ABAD2</code> <code>6BD4F69D599A34B775F391990B71AFC0</code> <code>C51AA3085282D951F6E6B29A4950C7FC</code> <code>1B54FEDAD091BE42B480DEF0C73B6320</code> <code>310F2F6CD987E845D8481483163B8237</code> <code>AAE27F8897FD0A3F2B82896EFAF43EFF</code> <code>182B4C6A8F29617AEA70166BB5AF5191</code> <code>C3F3E4EE675F708746B94D50A79F4045</code> <code>E138605814FFF570279FD887EAD528FA</code> <code>2E8A26DF424578F9271882FEE3BFF951</code> <code>3E4E4F6B53A886A342D8F2BD571DFA79</code> <code>B5E83F1F5CFE929B913311A38F47DC86</code> <code>EB27945E0EB38A1ADB7DD8952650F9E6</code> <code>09B89C0BBF1D2D1F6B6F93D24305E4C9</code> <code>D5BA53D917BB3234155E8654E0256D11</code><br> <code>CF43CB98</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>41528A68</code> (1753895489 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = BCA1DECC4F291BE8F0390FD07EA292622C364571023112D090429AF618CDA867F0160415B05FA6BCACDE05FB675D7ABC9EFEBE4C1C53F1F9CD5F42562F94A59BBC4BF0CF007DB532B506CB51EC9D906F5E3DEB18DA8F0400D7D67E82750F09C253EC56EC4959A98CA8E96CC999853C27A1AD6879BA986BF24BCB9ABD38AD6225C324A31165EBD1C43D7DF951DCF730125834F97B4E1EAD86CD3B68CEB4930A576A2560389A6AA98ABD84967C84BE4E4F899C24C3760CC99AC4A548FA33AC5D02C0094DDEABB62954ACABD93F503780533E6EA49F1113E52CBFD0A875AE9E3839AC214CE51F48E6392EFC0613F64F00A86AFD6F50338E95DC3D1448F9073BCD89</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4E0C3C73E4EDD6CF1BBD41D088F0421BF63CE143C39649D459008DD1CE97E853DAFF37934FE8B937B3EB99DB4EC89BA94F4D6588EB78CC3C4EE9E3516AA200CD4454F1F6FAA5A581A8A940BD8300F4397EBD3C6A1E08245A0A4A6BFD5AD53302E3AE53BA9C6687359B7CDB90A7439E90CC8CED9067821DD261DF583619DADE5AE53DBA36ED7CD0815E261192BADE165F80D445279993FE8747059538632037EE47DE2A9AF3BF5981C43A7ACBE79CEB103A5391A91820D0F6DA000C102D9C3EBCD04844A31BBE4E187AC35D6B7EAA8FAD8904AC1FC41EEF6461D2119D72B1F07899AC2EB502270C3779D60DCF4FEAA0E2A6D475FF3A6E8247C53A9FBE821D8C5A</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 DB AA 85 4A 1C 88 9A 30 57 57 14 FA
0010 | 90 5D F5 45 15 74 8A 31 D8 BF 86 7C 9D 23 12 B3
0020 | 2C E7 52 AC 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 4E 0C 3C 73 E4 ED D6 CF 1B BD 41 D0 88 F0 42 1B
0040 | F6 3C E1 43 C3 96 49 D4 59 00 8D D1 CE 97 E8 53
0050 | DA FF 37 93 4F E8 B9 37 B3 EB 99 DB 4E C8 9B A9
0060 | 4F 4D 65 88 EB 78 CC 3C 4E E9 E3 51 6A A2 00 CD
0070 | 44 54 F1 F6 FA A5 A5 81 A8 A9 40 BD 83 00 F4 39
0080 | 7E BD 3C 6A 1E 08 24 5A 0A 4A 6B FD 5A D5 33 02
0090 | E3 AE 53 BA 9C 66 87 35 9B 7C DB 90 A7 43 9E 90
00A0 | CC 8C ED 90 67 82 1D D2 61 DF 58 36 19 DA DE 5A
00B0 | E5 3D BA 36 ED 7C D0 81 5E 26 11 92 BA DE 16 5F
00C0 | 80 D4 45 27 99 93 FE 87 47 05 95 38 63 20 37 EE
00D0 | 47 DE 2A 9A F3 BF 59 81 C4 3A 7A CB E7 9C EB 10
00E0 | 3A 53 91 A9 18 20 D0 F6 DA 00 0C 10 2D 9C 3E BC
00F0 | D0 48 44 A3 1B BE 4E 18 7A C3 5D 6B 7E AA 8F AD
0100 | 89 04 AC 1F C4 1E EF 64 61 D2 11 9D 72 B1 F0 78
0110 | 99 AC 2E B5 02 27 0C 37 79 D6 0D CF 4F EA A0 E2
0120 | A6 D4 75 FF 3A 6E 82 47 C5 3A 9F BE 82 1D 8C 5A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004E0C3C73E4EDD6CF1BBD41D0</code> <code>88F0421BF63CE143C39649D459008DD1</code> <code>CE97E853DAFF37934FE8B937B3EB99DB</code> <code>4EC89BA94F4D6588EB78CC3C4EE9E351</code> <code>6AA200CD4454F1F6FAA5A581A8A940BD</code> <code>8300F4397EBD3C6A1E08245A0A4A6BFD</code> <code>5AD53302E3AE53BA9C6687359B7CDB90</code> <code>A7439E90CC8CED9067821DD261DF5836</code> <code>19DADE5AE53DBA36ED7CD0815E261192</code> <code>BADE165F80D445279993FE8747059538</code> <code>632037EE47DE2A9AF3BF5981C43A7ACB</code> <code>E79CEB103A5391A91820D0F6DA000C10</code> <code>2D9C3EBCD04844A31BBE4E187AC35D6B</code> <code>7EAA8FAD8904AC1FC41EEF6461D2119D</code> <code>72B1F07899AC2EB502270C3779D60DCF</code> <code>4FEAA0E2A6D475FF3A6E8247C53A9FBE</code><br> <code>821D8C5A</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366DBAA854A1C889A30575714FA905DF54515748A31D8BF867C9D2312B32CE752AC0000000000000000FE0001004E0C3C73E4EDD6CF1BBD41D088F0421BF63CE143C39649D459008DD1CE97E853DAFF37934FE8B937B3EB99DB4EC89BA94F4D6588EB78CC3C4EE9E3516AA200CD4454F1F6FAA5A581A8A940BD8300F4397EBD3C6A1E08245A0A4A6BFD5AD53302E3AE53BA9C6687359B7CDB90A7439E90CC8CED9067821DD261DF583619DADE5AE53DBA36ED7CD0815E261192BADE165F80D445279993FE8747059538632037EE47DE2A9AF3BF5981C43A7ACBE79CEB103A5391A91820D0F6DA000C102D9C3EBCD04844A31BBE4E187AC35D6B7EAA8FAD8904AC1FC41EEF6461D2119D72B1F07899AC2EB502270C3779D60DCF4FEAA0E2A6D475FF3A6E8247C53A9FBE821D8C5A
padding = 8C29AF2B69B3850706F54249
tmp_aes_key = C6331CB507CABE4C5483E86C26ED00C57E4A140B134A464922BE85189DF3527C
tmp_aes_iv = 6D1919367FA19293645D607ED75074EC91211D99EB3040460F3079F436FA9E83</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = B8FA3FFC7624DCE6B3452EBFB99289BDBDF13D1AC80DC0B8273E3778FFE71F648D503C4685A1575CB7CF30DC3987BFA535AB5DC1B25901B6A7BAB1097EB81FDD83016DA48B1AE7FF22D017F3EFDEB4B5D11F6369F7E3D353B994A61280FEC3873315F74B08B3038519BBAC8960EFC0951491FA50A2698153B55EB29A2106B74EDF5C8AFC41BF9B71477DB7B737900F58DAFADC7648EB77BB8F3C9574613568D871186929A725D3F80598FEC468F7FB98DD7D14287FB21CEB84CD83A77DFEE94089E154EA546085B871CFADE7A52BEA94E22A711E8597BAE1CDD4596580D1410AF79E5ECFFF795A972CBAC9FF41468BEC1D894A0E619A6F5BFEEF096EE4EB06A844AF6E31178EC937701B3478DC7888CA2CA1F69CE800C1850331FA77A3BAC2584EBBAED6FDEBC8CB5C64281FF12EBD89835DAE2EBC798C4FED23B925669BAC449C4C2BF0E647E3D636F36DF7D3F7A427</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 6C F2 0D 00 41 52 8A 68
0010 | 78 01 00 00 1F 5F 04 F5 DB AA 85 4A 1C 88 9A 30
0020 | 57 57 14 FA 90 5D F5 45 15 74 8A 31 D8 BF 86 7C
0030 | 9D 23 12 B3 2C E7 52 AC FE 50 01 00 B8 FA 3F FC
0040 | 76 24 DC E6 B3 45 2E BF B9 92 89 BD BD F1 3D 1A
0050 | C8 0D C0 B8 27 3E 37 78 FF E7 1F 64 8D 50 3C 46
0060 | 85 A1 57 5C B7 CF 30 DC 39 87 BF A5 35 AB 5D C1
0070 | B2 59 01 B6 A7 BA B1 09 7E B8 1F DD 83 01 6D A4
0080 | 8B 1A E7 FF 22 D0 17 F3 EF DE B4 B5 D1 1F 63 69
0090 | F7 E3 D3 53 B9 94 A6 12 80 FE C3 87 33 15 F7 4B
00A0 | 08 B3 03 85 19 BB AC 89 60 EF C0 95 14 91 FA 50
00B0 | A2 69 81 53 B5 5E B2 9A 21 06 B7 4E DF 5C 8A FC
00C0 | 41 BF 9B 71 47 7D B7 B7 37 90 0F 58 DA FA DC 76
00D0 | 48 EB 77 BB 8F 3C 95 74 61 35 68 D8 71 18 69 29
00E0 | A7 25 D3 F8 05 98 FE C4 68 F7 FB 98 DD 7D 14 28
00F0 | 7F B2 1C EB 84 CD 83 A7 7D FE E9 40 89 E1 54 EA
0100 | 54 60 85 B8 71 CF AD E7 A5 2B EA 94 E2 2A 71 1E
0110 | 85 97 BA E1 CD D4 59 65 80 D1 41 0A F7 9E 5E CF
0120 | FF 79 5A 97 2C BA C9 FF 41 46 8B EC 1D 89 4A 0E
0130 | 61 9A 6F 5B FE EF 09 6E E4 EB 06 A8 44 AF 6E 31
0140 | 17 8E C9 37 70 1B 34 78 DC 78 88 CA 2C A1 F6 9C
0150 | E8 00 C1 85 03 31 FA 77 A3 BA C2 58 4E BB AE D6
0160 | FD EB C8 CB 5C 64 28 1F F1 2E BD 89 83 5D AE 2E
0170 | BC 79 8C 4F ED 23 B9 25 66 9B AC 44 9C 4C 2B F0
0180 | E6 47 E3 D6 36 F3 6D F7 D3 F7 A4 27</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>6CF20D0041528A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100B8FA3FFC7624DCE6B3452EBF</code> <code>B99289BDBDF13D1AC80DC0B8273E3778</code> <code>FFE71F648D503C4685A1575CB7CF30DC</code> <code>3987BFA535AB5DC1B25901B6A7BAB109</code> <code>7EB81FDD83016DA48B1AE7FF22D017F3</code> <code>EFDEB4B5D11F6369F7E3D353B994A612</code> <code>80FEC3873315F74B08B3038519BBAC89</code> <code>60EFC0951491FA50A2698153B55EB29A</code> <code>2106B74EDF5C8AFC41BF9B71477DB7B7</code> <code>37900F58DAFADC7648EB77BB8F3C9574</code> <code>613568D871186929A725D3F80598FEC4</code> <code>68F7FB98DD7D14287FB21CEB84CD83A7</code> <code>7DFEE94089E154EA546085B871CFADE7</code> <code>A52BEA94E22A711E8597BAE1CDD45965</code> <code>80D1410AF79E5ECFFF795A972CBAC9FF</code> <code>41468BEC1D894A0E619A6F5BFEEF096E</code> <code>E4EB06A844AF6E31178EC937701B3478</code> <code>DC7888CA2CA1F69CE800C1850331FA77</code> <code>A3BAC2584EBBAED6FDEBC8CB5C64281F</code> <code>F12EBD89835DAE2EBC798C4FED23B925</code> <code>669BAC449C4C2BF0E647E3D636F36DF7</code><br> <code>D3F7A427</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 44425F4678AC1D0254C061855F8E8AC1F8AA2CD6E4DC0A12495DF7662100D17849EF2D5A4912D7D10C5DEFA06EA77948BC02E72145CC8DCF427503E9551B065469D4CDBC35399080CE3AA790915C21EFAE6924EAF49B7C02A4BEB89FDCBFD2BDE5BB1415FD275C4A3C8A9CDF564C0210BDAA402B036D7F961E68E7BEA03557444345D5CB0143628AD4898AC97B61E5FE3898D0B297699627D216F3679A39921992A1B62AD4EC06C9CD96061CDCA7A4DDF2CF6CB8B09522C5929E4552E711487727724FABDDF4066E859C2A0BAA60B9656877FC981C648920FC85BA0F594100B03FFF7F6BD608EC27B17268491F44A2D0004302FE292A9ECF5BF65700AFEB3D1E</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 86 05 43 52 8A 68
0010 | 34 00 00 00 34 F7 CB 3B DB AA 85 4A 1C 88 9A 30
0020 | 57 57 14 FA 90 5D F5 45 15 74 8A 31 D8 BF 86 7C
0030 | 9D 23 12 B3 2C E7 52 AC C5 4C F0 FE 85 6E 4C FA
0040 | 56 43 60 27 8B 6A DB 53</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0160860543528A68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DBAA854A1C889A30575714FA905DF545</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>15748A31D8BF867C9D2312B32CE752AC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>C54CF0FE856E4CFA564360278B6ADB53</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

