<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C 81 07 00 81 68 AE 66
0010 | 14 00 00 00 F1 8E 7E BE 81 BA A8 90 1B 79 63 A6
0020 | 9A 8E 8B EB C1 05 93 FD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7C8107008168AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 68 3C 81 68 AE 66
0010 | B4 00 00 00 63 24 16 05 81 BA A8 90 1B 79 63 A6
0020 | 9A 8E 8B EB C1 05 93 FD 9C FC EE B6 10 AF F6 64
0030 | 73 95 1E A6 F9 78 4C F9 08 31 12 2C 48 EB 28 59
0040 | 5B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B4683C8168AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B4000000</code> (180 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0831122C48EB28595B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3535937349133818203</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3535937349133818203</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3535937349133818203 = 1822522799 * 1940133397</code></p>
<pre><code>p = 1822522799
q = 1940133397</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 31 12 2C 48 EB 28 59 5B 00 00 00
0010 | 04 6C A1 7D AF 00 00 00 04 73 A4 16 15 00 00 00
0020 | 81 BA A8 90 1B 79 63 A6 9A 8E 8B EB C1 05 93 FD
0030 | 9C FC EE B6 10 AF F6 64 73 95 1E A6 F9 78 4C F9
0040 | 47 00 1B 49 AE 5F 60 08 7D 38 1B 0E 1D F9 D1 8B
0050 | 0B DF 52 4F E3 50 AC ED E5 A8 A4 AB 80 CC 56 35
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0831122C48EB28595B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3535937349133818203</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>046CA17DAF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1822522799</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0473A41615000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1940133397</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>47001B49AE5F60087D381B0E1DF9D18B</code> <code>0BDF524FE350ACEDE5A8A4AB80CC5635</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90831122C48EB28595B000000046CA17DAF0000000473A4161500000081BAA8901B7963A69A8E8BEBC10593FD9CFCEEB610AFF66473951EA6F9784CF947001B49AE5F60087D381B0E1DF9D18B0BDF524FE350ACEDE5A8A4AB80CC563502000000
random_padding_bytes = 660A1A1E5EB46A6BC07D20589613E340859CDAA8CBD8091F74F11A4DF4B99F245CE6D93A067FDC8D08F3D88E3A80B1DC1FCB1B477272E0756781F371AA0427DB84E901A3820EE1737FC55C10AAF1C03B32B1EDCC026C76C8BB0C7B46</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B4AE43924D0F4888D78999BE94242A19FB0823A18FE8A5A05B682ECA77FD6FB02100059ECB4C1C25C599318929A2749DDD53EED08A219587BEDEC54495ECE760698E11D221531E2F47E9940C9EDBF428948386C46A38EE64658082795C415F3D9767C4E6F6413DDD8F783F6C3CDFFAEA5AA68CF397F5CF6D1A1BC0DBAA060FA69600C153FFD933D69156BB74175272E78A8E6127B6C584813D7F2712E92B2AE9F4268122CDE8193F42F21D40B505572870B49F78FC08750D6F66D144B0C7CC63666BD51FFAC64988DC0DEE280247F26965F893BCD3C75108DC94C7E0C1BA39A83CC79F02CFBB6AFE9E3C4159DC8173084E9AAA2B122819C0AAD95EB0DD5DCC65</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 04 95 09 00 81 68 AE 66
0010 | 40 01 00 00 BE E4 12 D7 81 BA A8 90 1B 79 63 A6
0020 | 9A 8E 8B EB C1 05 93 FD 9C FC EE B6 10 AF F6 64
0030 | 73 95 1E A6 F9 78 4C F9 04 6C A1 7D AF 00 00 00
0040 | 04 73 A4 16 15 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B4 AE 43 92 4D 0F 48 88 D7 89 99 BE
0060 | 94 24 2A 19 FB 08 23 A1 8F E8 A5 A0 5B 68 2E CA
0070 | 77 FD 6F B0 21 00 05 9E CB 4C 1C 25 C5 99 31 89
0080 | 29 A2 74 9D DD 53 EE D0 8A 21 95 87 BE DE C5 44
0090 | 95 EC E7 60 69 8E 11 D2 21 53 1E 2F 47 E9 94 0C
00A0 | 9E DB F4 28 94 83 86 C4 6A 38 EE 64 65 80 82 79
00B0 | 5C 41 5F 3D 97 67 C4 E6 F6 41 3D DD 8F 78 3F 6C
00C0 | 3C DF FA EA 5A A6 8C F3 97 F5 CF 6D 1A 1B C0 DB
00D0 | AA 06 0F A6 96 00 C1 53 FF D9 33 D6 91 56 BB 74
00E0 | 17 52 72 E7 8A 8E 61 27 B6 C5 84 81 3D 7F 27 12
00F0 | E9 2B 2A E9 F4 26 81 22 CD E8 19 3F 42 F2 1D 40
0100 | B5 05 57 28 70 B4 9F 78 FC 08 75 0D 6F 66 D1 44
0110 | B0 C7 CC 63 66 6B D5 1F FA C6 49 88 DC 0D EE 28
0120 | 02 47 F2 69 65 F8 93 BC D3 C7 51 08 DC 94 C7 E0
0130 | C1 BA 39 A8 3C C7 9F 02 CF BB 6A FE 9E 3C 41 59
0140 | DC 81 73 08 4E 9A AA 2B 12 28 19 C0 AA D9 5E B0
0150 | DD 5D CC 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>049509008168AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>046CA17DAF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1822522799</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0473A41615000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1940133397</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B4AE43924D0F4888D78999BE</code> <code>94242A19FB0823A18FE8A5A05B682ECA</code> <code>77FD6FB02100059ECB4C1C25C5993189</code> <code>29A2749DDD53EED08A219587BEDEC544</code> <code>95ECE760698E11D221531E2F47E9940C</code> <code>9EDBF428948386C46A38EE6465808279</code> <code>5C415F3D9767C4E6F6413DDD8F783F6C</code> <code>3CDFFAEA5AA68CF397F5CF6D1A1BC0DB</code> <code>AA060FA69600C153FFD933D69156BB74</code> <code>175272E78A8E6127B6C584813D7F2712</code> <code>E92B2AE9F4268122CDE8193F42F21D40</code> <code>B505572870B49F78FC08750D6F66D144</code> <code>B0C7CC63666BD51FFAC64988DC0DEE28</code> <code>0247F26965F893BCD3C75108DC94C7E0</code> <code>C1BA39A83CC79F02CFBB6AFE9E3C4159</code> <code>DC8173084E9AAA2B122819C0AAD95EB0</code><br> <code>DD5DCC65</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A4 1A 05 82 68 AE 66
0010 | B8 02 00 00 5C 07 E8 D0 81 BA A8 90 1B 79 63 A6
0020 | 9A 8E 8B EB C1 05 93 FD 9C FC EE B6 10 AF F6 64
0030 | 73 95 1E A6 F9 78 4C F9 FE 50 02 00 52 91 D8 15
0040 | 21 26 DA FF 92 59 DC F2 BD 3F 8B CC 2C 6B CB 61
0050 | 25 84 E5 C7 3C B8 3E 9E 7C 8C BA 88 6A F4 F0 EA
0060 | 93 81 B3 6C C5 5C 7A 31 37 F2 C6 D1 74 48 1B CB
0070 | EC E9 3C 7A DE 99 52 D4 FB 4E 44 15 11 A6 8B DE
0080 | B2 C5 B6 E6 37 C3 72 CF CC 2C 94 B8 41 44 A4 88
0090 | 20 BD E4 3D 57 C8 FC 9C 97 B6 D3 5B 6F 53 48 A1
00A0 | 18 06 9C 09 95 CB 86 B4 EF 48 C4 11 F3 7C 69 46
00B0 | 47 DB 10 9D B5 1C FF 21 F4 E2 C8 75 79 1C 48 FF
00C0 | 45 1D 5E 2D 1F 19 F9 A0 94 DE 35 CC EE 5C B7 51
00D0 | 33 83 58 92 D9 86 DD C5 D6 53 3A 34 BE 70 E1 28
00E0 | 16 7A E1 28 ED 47 C0 30 21 5D 73 7D C8 50 37 85
00F0 | 6B AE 74 00 9D C6 03 09 CC 74 A3 94 8E 28 8C E5
0100 | 2D 3D 20 C9 C8 C7 69 4B AE 9D DB 65 78 6A 07 FB
0110 | 31 CA 32 A1 6A 17 1D 6F B2 C3 4D BF FA DD DC 54
0120 | 8F E2 91 D7 43 B1 24 2E E6 69 DB 71 BA 2A 5A 54
0130 | 7B 72 9B 9C 4C 48 63 55 FC CB FB D3 61 C4 DF 54
0140 | AA E8 EA 9F 57 A5 09 77 E4 18 39 92 49 56 30 C4
0150 | D6 2D CE B9 80 5A 70 D2 64 FD D4 E5 35 3A AC C3
0160 | 02 36 03 65 40 95 1C 34 72 87 DC 7C B2 A8 EE 8F
0170 | 27 8E 03 08 18 37 4B 79 EF 71 42 11 F9 3B BF 36
0180 | 67 ED 7D 44 38 42 2B 83 66 8E 6B CB 79 19 8D C5
0190 | 66 62 AA C4 17 CC 3F E6 00 5D 4E C2 4C 9C E5 2F
01A0 | 71 7E E0 EB 2F C6 21 62 ED 1E 6A C4 85 F1 EC 98
01B0 | BF 76 83 28 C4 55 3B DD 67 17 2D 9B 14 EB 7B 48
01C0 | 9A 8D EF 7A 2F DB 84 D2 FA B4 0D 61 5C 32 06 4F
01D0 | E5 9A B4 FD 0B 4D 2F 5A B7 1C 1F BE 91 FC 19 78
01E0 | E6 DA 06 12 2C DC 79 DA C2 B4 43 4A A9 B1 B2 E5
01F0 | B4 5B 4B A3 EB BA EF A7 1E 1D 0B 85 27 62 F7 F8
0200 | DF 1B 9E FC E9 7E 70 A7 3D 9B 2B AA 0A 95 E1 7F
0210 | FB 94 45 05 E5 FE 17 DF AC 06 D3 1F 73 16 69 00
0220 | 53 44 81 F5 93 FD 25 C0 95 72 60 1F 8A 54 34 40
0230 | 7C 60 A8 15 B4 4D C8 32 9E 48 F5 38 F3 7C 08 D0
0240 | 05 BD 31 69 F9 95 E6 51 3C 0B 33 CB 7C 28 FA 50
0250 | 7A 04 4E B0 31 6B 2A 8A EB 93 28 5B A5 32 4E A2
0260 | EC 61 54 FC 8D 8B E2 88 EE 8F 84 57 68 41 69 B7
0270 | 70 02 49 07 AA 06 A6 26 6D 04 F5 15 A9 37 8B DC
0280 | 96 19 79 ED DC 18 F1 F0 D9 7E A9 49</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A41A058268AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B8020000</code> (696 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002005291D8152126DAFF9259DCF2</code> <code>BD3F8BCC2C6BCB612584E5C73CB83E9E</code> <code>7C8CBA886AF4F0EA9381B36CC55C7A31</code> <code>37F2C6D174481BCBECE93C7ADE9952D4</code> <code>FB4E441511A68BDEB2C5B6E637C372CF</code> <code>CC2C94B84144A48820BDE43D57C8FC9C</code> <code>97B6D35B6F5348A118069C0995CB86B4</code> <code>EF48C411F37C694647DB109DB51CFF21</code> <code>F4E2C875791C48FF451D5E2D1F19F9A0</code> <code>94DE35CCEE5CB75133835892D986DDC5</code> <code>D6533A34BE70E128167AE128ED47C030</code> <code>215D737DC85037856BAE74009DC60309</code> <code>CC74A3948E288CE52D3D20C9C8C7694B</code> <code>AE9DDB65786A07FB31CA32A16A171D6F</code> <code>B2C34DBFFADDDC548FE291D743B1242E</code> <code>E669DB71BA2A5A547B729B9C4C486355</code> <code>FCCBFBD361C4DF54AAE8EA9F57A50977</code> <code>E4183992495630C4D62DCEB9805A70D2</code> <code>64FDD4E5353AACC30236036540951C34</code> <code>7287DC7CB2A8EE8F278E030818374B79</code> <code>EF714211F93BBF3667ED7D4438422B83</code> <code>668E6BCB79198DC56662AAC417CC3FE6</code> <code>005D4EC24C9CE52F717EE0EB2FC62162</code> <code>ED1E6AC485F1EC98BF768328C4553BDD</code> <code>67172D9B14EB7B489A8DEF7A2FDB84D2</code> <code>FAB40D615C32064FE59AB4FD0B4D2F5A</code> <code>B71C1FBE91FC1978E6DA06122CDC79DA</code> <code>C2B4434AA9B1B2E5B45B4BA3EBBAEFA7</code> <code>1E1D0B852762F7F8DF1B9EFCE97E70A7</code> <code>3D9B2BAA0A95E17FFB944505E5FE17DF</code> <code>AC06D31F73166900534481F593FD25C0</code> <code>9572601F8A5434407C60A815B44DC832</code> <code>9E48F538F37C08D005BD3169F995E651</code> <code>3C0B33CB7C28FA507A044EB0316B2A8A</code> <code>EB93285BA5324EA2EC6154FC8D8BE288</code> <code>EE8F8457684169B770024907AA06A626</code> <code>6D04F515A9378BDC961979EDDC18F1F0</code><br> <code>D97EA949</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 5291D8152126DAFF9259DCF2BD3F8BCC2C6BCB612584E5C73CB83E9E7C8CBA886AF4F0EA9381B36CC55C7A3137F2C6D174481BCBECE93C7ADE9952D4FB4E441511A68BDEB2C5B6E637C372CFCC2C94B84144A48820BDE43D57C8FC9C97B6D35B6F5348A118069C0995CB86B4EF48C411F37C694647DB109DB51CFF21F4E2C875791C48FF451D5E2D1F19F9A094DE35CCEE5CB75133835892D986DDC5D6533A34BE70E128167AE128ED47C030215D737DC85037856BAE74009DC60309CC74A3948E288CE52D3D20C9C8C7694BAE9DDB65786A07FB31CA32A16A171D6FB2C34DBFFADDDC548FE291D743B1242EE669DB71BA2A5A547B729B9C4C486355FCCBFBD361C4DF54AAE8EA9F57A50977E4183992495630C4D62DCEB9805A70D264FDD4E5353AACC30236036540951C347287DC7CB2A8EE8F278E030818374B79EF714211F93BBF3667ED7D4438422B83668E6BCB79198DC56662AAC417CC3FE6005D4EC24C9CE52F717EE0EB2FC62162ED1E6AC485F1EC98BF768328C4553BDD67172D9B14EB7B489A8DEF7A2FDB84D2FAB40D615C32064FE59AB4FD0B4D2F5AB71C1FBE91FC1978E6DA06122CDC79DAC2B4434AA9B1B2E5B45B4BA3EBBAEFA71E1D0B852762F7F8DF1B9EFCE97E70A73D9B2BAA0A95E17FFB944505E5FE17DFAC06D31F73166900534481F593FD25C09572601F8A5434407C60A815B44DC8329E48F538F37C08D005BD3169F995E6513C0B33CB7C28FA507A044EB0316B2A8AEB93285BA5324EA2EC6154FC8D8BE288EE8F8457684169B770024907AA06A6266D04F515A9378BDC961979EDDC18F1F0D97EA949
tmp_aes_key = 193D433DA179C2B9BBEC2861895A71A884B707887D2CE6D60BD2E9AAAB243E91
tmp_aes_iv = 46D34D4E464337AC6C81E0E4D58B221A353C524BFE62B059B152350A47001B49</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = B7021C84DF7099D62437262D4CA612C54695F201BA0D89B581BAA8901B7963A69A8E8BEBC10593FD9CFCEEB610AFF66473951EA6F9784CF903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002F06E047C03A469913D6EEBDFE444536C11B3FBBE14B97F992B2E428C1833EB73884D48574504F78220944D8834D843FDEB7D0DE12E00F87F767F55EED24E4F2F9AA6C0D5359C7CACACFBB6917F0989ACB99503BB2F5FE9FB34F4FDAC763E173BA81F93D77A3FDF98C05ED9C1D33E7DE4016655F2E21B1EB272D245FE266B8835AEA5FA0835E643BE58D0B406EE3D3F7C2B93C8F6EF8FB4F0CE05B78CC08B21D64F6658243C6D40625394514B988DDC671222C4EAA05B37BDE9957201AF7061D9A037E4F8551C0C76A01D27D41B38B25B70C0995BF7951AD5F3053CD196C9DF4C3F95BC003718CE2DC92086935D117907E8AF0EDFFBB3C619F9CA8BF54C018928268AE665016D8AB67897248
answer = BA0D89B581BAA8901B7963A69A8E8BEBC10593FD9CFCEEB610AFF66473951EA6F9784CF903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001002F06E047C03A469913D6EEBDFE444536C11B3FBBE14B97F992B2E428C1833EB73884D48574504F78220944D8834D843FDEB7D0DE12E00F87F767F55EED24E4F2F9AA6C0D5359C7CACACFBB6917F0989ACB99503BB2F5FE9FB34F4FDAC763E173BA81F93D77A3FDF98C05ED9C1D33E7DE4016655F2E21B1EB272D245FE266B8835AEA5FA0835E643BE58D0B406EE3D3F7C2B93C8F6EF8FB4F0CE05B78CC08B21D64F6658243C6D40625394514B988DDC671222C4EAA05B37BDE9957201AF7061D9A037E4F8551C0C76A01D27D41B38B25B70C0995BF7951AD5F3053CD196C9DF4C3F95BC003718CE2DC92086935D117907E8AF0EDFFBB3C619F9CA8BF54C018928268AE665016D8AB67897248</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 81 BA A8 90 1B 79 63 A6 9A 8E 8B EB
0010 | C1 05 93 FD 9C FC EE B6 10 AF F6 64 73 95 1E A6
0020 | F9 78 4C F9 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 2F 06 E0 47 C0 3A 46 99 13 D6 EE BD FE 44 45 36
0140 | C1 1B 3F BB E1 4B 97 F9 92 B2 E4 28 C1 83 3E B7
0150 | 38 84 D4 85 74 50 4F 78 22 09 44 D8 83 4D 84 3F
0160 | DE B7 D0 DE 12 E0 0F 87 F7 67 F5 5E ED 24 E4 F2
0170 | F9 AA 6C 0D 53 59 C7 CA CA CF BB 69 17 F0 98 9A
0180 | CB 99 50 3B B2 F5 FE 9F B3 4F 4F DA C7 63 E1 73
0190 | BA 81 F9 3D 77 A3 FD F9 8C 05 ED 9C 1D 33 E7 DE
01A0 | 40 16 65 5F 2E 21 B1 EB 27 2D 24 5F E2 66 B8 83
01B0 | 5A EA 5F A0 83 5E 64 3B E5 8D 0B 40 6E E3 D3 F7
01C0 | C2 B9 3C 8F 6E F8 FB 4F 0C E0 5B 78 CC 08 B2 1D
01D0 | 64 F6 65 82 43 C6 D4 06 25 39 45 14 B9 88 DD C6
01E0 | 71 22 2C 4E AA 05 B3 7B DE 99 57 20 1A F7 06 1D
01F0 | 9A 03 7E 4F 85 51 C0 C7 6A 01 D2 7D 41 B3 8B 25
0200 | B7 0C 09 95 BF 79 51 AD 5F 30 53 CD 19 6C 9D F4
0210 | C3 F9 5B C0 03 71 8C E2 DC 92 08 69 35 D1 17 90
0220 | 7E 8A F0 ED FF BB 3C 61 9F 9C A8 BF 54 C0 18 92
0230 | 82 68 AE 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001002F06E047C03A469913D6EEBD</code> <code>FE444536C11B3FBBE14B97F992B2E428</code> <code>C1833EB73884D48574504F78220944D8</code> <code>834D843FDEB7D0DE12E00F87F767F55E</code> <code>ED24E4F2F9AA6C0D5359C7CACACFBB69</code> <code>17F0989ACB99503BB2F5FE9FB34F4FDA</code> <code>C763E173BA81F93D77A3FDF98C05ED9C</code> <code>1D33E7DE4016655F2E21B1EB272D245F</code> <code>E266B8835AEA5FA0835E643BE58D0B40</code> <code>6EE3D3F7C2B93C8F6EF8FB4F0CE05B78</code> <code>CC08B21D64F6658243C6D40625394514</code> <code>B988DDC671222C4EAA05B37BDE995720</code> <code>1AF7061D9A037E4F8551C0C76A01D27D</code> <code>41B38B25B70C0995BF7951AD5F3053CD</code> <code>196C9DF4C3F95BC003718CE2DC920869</code> <code>35D117907E8AF0EDFFBB3C619F9CA8BF</code><br> <code>54C01892</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>8268AE66</code> (1722706050 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 2D31A8A808F5E5E54A9FC59FB282245A5B7333CEF72AC877C911E9B4CA3977D7E9CD657AEA138E3FB9BA15ACEF338C049F59F9A0073EE37C95B4A8255735DF1B8C9C711851EB997E2696466D46B67715B0689EC79FC4E7D30278A75D7D29293638761171619B328348F1680960E6031FE398B3AFC70B097833173F2C4CA14EFA110A8304D9BA70801B40D9508DA1BC7CA56D0C06D31B3ADA169ED9AA42344544D1A1AD18C95A61F28987455AE7E1521A70A1E433E3B5FF832F4E273115BEB1C28686B4F69844E68B89078AA28A5B048027170CF24C71371E399DA78F20514783EC871D13E4B9CFD054A107557BCAC353FCFF0B4ABACC143EFA2EF1EB27BC437C</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = AC31D4BF09B3D713DCEF1D4D74C3591E05DC39C41BF08FED8D9FA89258E137D3E09AD57593D22616835AB9476B78E3B438B92077574DE56B2026B72CD4963E170566EBB87DBD6549EC656663D5326A7F071326470B5B2AEE70A904FD509785DF360A672CF226F92613DB090D4C56F7D77CAB1B602D468C863DA10C82D853C68AEC5CAF28F53D8F7E488093F992CC0AF0CA71D24C46F899CAEDA29B3752B0B68E4F2F529EFCACAFA2FC76DBFF2ABAC3B8E414CC1216B5E4D72AFA8F5838F133501CBA81132562FA563877C08C0FAEBE1404C27208BE21621B4046ECF68C33A469F7E8ABF7E2EAEE2187B563B58CE441A6314299C8A4A1D2AD6F6CC5C9D507FD1E</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 81 BA A8 90 1B 79 63 A6 9A 8E 8B EB
0010 | C1 05 93 FD 9C FC EE B6 10 AF F6 64 73 95 1E A6
0020 | F9 78 4C F9 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | AC 31 D4 BF 09 B3 D7 13 DC EF 1D 4D 74 C3 59 1E
0040 | 05 DC 39 C4 1B F0 8F ED 8D 9F A8 92 58 E1 37 D3
0050 | E0 9A D5 75 93 D2 26 16 83 5A B9 47 6B 78 E3 B4
0060 | 38 B9 20 77 57 4D E5 6B 20 26 B7 2C D4 96 3E 17
0070 | 05 66 EB B8 7D BD 65 49 EC 65 66 63 D5 32 6A 7F
0080 | 07 13 26 47 0B 5B 2A EE 70 A9 04 FD 50 97 85 DF
0090 | 36 0A 67 2C F2 26 F9 26 13 DB 09 0D 4C 56 F7 D7
00A0 | 7C AB 1B 60 2D 46 8C 86 3D A1 0C 82 D8 53 C6 8A
00B0 | EC 5C AF 28 F5 3D 8F 7E 48 80 93 F9 92 CC 0A F0
00C0 | CA 71 D2 4C 46 F8 99 CA ED A2 9B 37 52 B0 B6 8E
00D0 | 4F 2F 52 9E FC AC AF A2 FC 76 DB FF 2A BA C3 B8
00E0 | E4 14 CC 12 16 B5 E4 D7 2A FA 8F 58 38 F1 33 50
00F0 | 1C BA 81 13 25 62 FA 56 38 77 C0 8C 0F AE BE 14
0100 | 04 C2 72 08 BE 21 62 1B 40 46 EC F6 8C 33 A4 69
0110 | F7 E8 AB F7 E2 EA EE 21 87 B5 63 B5 8C E4 41 A6
0120 | 31 42 99 C8 A4 A1 D2 AD 6F 6C C5 C9 D5 07 FD 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100AC31D4BF09B3D713DCEF1D4D</code> <code>74C3591E05DC39C41BF08FED8D9FA892</code> <code>58E137D3E09AD57593D22616835AB947</code> <code>6B78E3B438B92077574DE56B2026B72C</code> <code>D4963E170566EBB87DBD6549EC656663</code> <code>D5326A7F071326470B5B2AEE70A904FD</code> <code>509785DF360A672CF226F92613DB090D</code> <code>4C56F7D77CAB1B602D468C863DA10C82</code> <code>D853C68AEC5CAF28F53D8F7E488093F9</code> <code>92CC0AF0CA71D24C46F899CAEDA29B37</code> <code>52B0B68E4F2F529EFCACAFA2FC76DBFF</code> <code>2ABAC3B8E414CC1216B5E4D72AFA8F58</code> <code>38F133501CBA81132562FA563877C08C</code> <code>0FAEBE1404C27208BE21621B4046ECF6</code> <code>8C33A469F7E8ABF7E2EAEE2187B563B5</code> <code>8CE441A6314299C8A4A1D2AD6F6CC5C9</code><br> <code>D507FD1E</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436681BAA8901B7963A69A8E8BEBC10593FD9CFCEEB610AFF66473951EA6F9784CF90000000000000000FE000100AC31D4BF09B3D713DCEF1D4D74C3591E05DC39C41BF08FED8D9FA89258E137D3E09AD57593D22616835AB9476B78E3B438B92077574DE56B2026B72CD4963E170566EBB87DBD6549EC656663D5326A7F071326470B5B2AEE70A904FD509785DF360A672CF226F92613DB090D4C56F7D77CAB1B602D468C863DA10C82D853C68AEC5CAF28F53D8F7E488093F992CC0AF0CA71D24C46F899CAEDA29B3752B0B68E4F2F529EFCACAFA2FC76DBFF2ABAC3B8E414CC1216B5E4D72AFA8F5838F133501CBA81132562FA563877C08C0FAEBE1404C27208BE21621B4046ECF68C33A469F7E8ABF7E2EAEE2187B563B58CE441A6314299C8A4A1D2AD6F6CC5C9D507FD1E
padding = 6BF96602E0860E13C471AFA6
tmp_aes_key = 193D433DA179C2B9BBEC2861895A71A884B707887D2CE6D60BD2E9AAAB243E91
tmp_aes_iv = 46D34D4E464337AC6C81E0E4D58B221A353C524BFE62B059B152350A47001B49</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = ED09946D9708F80E7E1EC8B8BE8681727E4D0E2C3D64E39518BD987155090D3AFAE586E728028EE2973AD2D55B9B818A5BC615925D6B2C8FAAA65DB022472FF937FD2F0ADFE06ED1297252F47AC605DDAF3472FD3141D3ED690E6E9EDB6D230A28B0C9AB38C4417F620E85357B2DEFF3E320A4AC0F11B83499FA934CD5D67A9C75138FC1DE2564E886E7055DDF27BE0F9CE8F483D6B92B8401717A4173896498393BD79D8050BC683910FE6713C520CFFE09617576F11C62B9CCAD38BF06FA5CBE3BE3D4721D69ED0343CD3FCEE9E861165FBF5089896CF320D2BF5E0ED3793856944182742BE978AFC85EA38809260C318EB4AAD260367FD5A21503EB58ECB682D08B3BAA37B90646DD6AF8FB403C336210188FD97C33BD653A30C207862C943CCC614830A28A523CE195F23C0027CB14A1894458D870B210F19CB4F30D5109B2F5B1B62D11F2F46E8704B0615489E0</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 4B 04 00 82 68 AE 66
0010 | 78 01 00 00 1F 5F 04 F5 81 BA A8 90 1B 79 63 A6
0020 | 9A 8E 8B EB C1 05 93 FD 9C FC EE B6 10 AF F6 64
0030 | 73 95 1E A6 F9 78 4C F9 FE 50 01 00 ED 09 94 6D
0040 | 97 08 F8 0E 7E 1E C8 B8 BE 86 81 72 7E 4D 0E 2C
0050 | 3D 64 E3 95 18 BD 98 71 55 09 0D 3A FA E5 86 E7
0060 | 28 02 8E E2 97 3A D2 D5 5B 9B 81 8A 5B C6 15 92
0070 | 5D 6B 2C 8F AA A6 5D B0 22 47 2F F9 37 FD 2F 0A
0080 | DF E0 6E D1 29 72 52 F4 7A C6 05 DD AF 34 72 FD
0090 | 31 41 D3 ED 69 0E 6E 9E DB 6D 23 0A 28 B0 C9 AB
00A0 | 38 C4 41 7F 62 0E 85 35 7B 2D EF F3 E3 20 A4 AC
00B0 | 0F 11 B8 34 99 FA 93 4C D5 D6 7A 9C 75 13 8F C1
00C0 | DE 25 64 E8 86 E7 05 5D DF 27 BE 0F 9C E8 F4 83
00D0 | D6 B9 2B 84 01 71 7A 41 73 89 64 98 39 3B D7 9D
00E0 | 80 50 BC 68 39 10 FE 67 13 C5 20 CF FE 09 61 75
00F0 | 76 F1 1C 62 B9 CC AD 38 BF 06 FA 5C BE 3B E3 D4
0100 | 72 1D 69 ED 03 43 CD 3F CE E9 E8 61 16 5F BF 50
0110 | 89 89 6C F3 20 D2 BF 5E 0E D3 79 38 56 94 41 82
0120 | 74 2B E9 78 AF C8 5E A3 88 09 26 0C 31 8E B4 AA
0130 | D2 60 36 7F D5 A2 15 03 EB 58 EC B6 82 D0 8B 3B
0140 | AA 37 B9 06 46 DD 6A F8 FB 40 3C 33 62 10 18 8F
0150 | D9 7C 33 BD 65 3A 30 C2 07 86 2C 94 3C CC 61 48
0160 | 30 A2 8A 52 3C E1 95 F2 3C 00 27 CB 14 A1 89 44
0170 | 58 D8 70 B2 10 F1 9C B4 F3 0D 51 09 B2 F5 B1 B6
0180 | 2D 11 F2 F4 6E 87 04 B0 61 54 89 E0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F04B04008268AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100ED09946D9708F80E7E1EC8B8</code> <code>BE8681727E4D0E2C3D64E39518BD9871</code> <code>55090D3AFAE586E728028EE2973AD2D5</code> <code>5B9B818A5BC615925D6B2C8FAAA65DB0</code> <code>22472FF937FD2F0ADFE06ED1297252F4</code> <code>7AC605DDAF3472FD3141D3ED690E6E9E</code> <code>DB6D230A28B0C9AB38C4417F620E8535</code> <code>7B2DEFF3E320A4AC0F11B83499FA934C</code> <code>D5D67A9C75138FC1DE2564E886E7055D</code> <code>DF27BE0F9CE8F483D6B92B8401717A41</code> <code>73896498393BD79D8050BC683910FE67</code> <code>13C520CFFE09617576F11C62B9CCAD38</code> <code>BF06FA5CBE3BE3D4721D69ED0343CD3F</code> <code>CEE9E861165FBF5089896CF320D2BF5E</code> <code>0ED3793856944182742BE978AFC85EA3</code> <code>8809260C318EB4AAD260367FD5A21503</code> <code>EB58ECB682D08B3BAA37B90646DD6AF8</code> <code>FB403C336210188FD97C33BD653A30C2</code> <code>07862C943CCC614830A28A523CE195F2</code> <code>3C0027CB14A1894458D870B210F19CB4</code> <code>F30D5109B2F5B1B62D11F2F46E8704B0</code><br> <code>615489E0</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 24A37A35A158CDCE75FD48B39EC25D533C05D89FC6C4E8BC63A166CAA66962FFA1CBE96115A0586C5EDA91DEE03758D258BD91F744EA591AFD0AB9356CB9D1CD7B1D00F418F23A158D3BAF8D4E0044D951E0A3A36B16B7E8AE30F838B73A8D5DFE07481724695CBE632FC70F8615774D52492236F9379278A29AB02FFA496D43BAA634D9AB297AF93BA532ACF21872DCA2206332CD5FC0711FD0AEDE548814C4A7F22EF6B54010BD4D16A395DFDCAC38626A3F93F44DD2C008DEFB7396D3FAE822F6B273EFF6F9CD53C977ED96E86281480DB1112352BAB990D8F6151905722714BA0881C60A7624BD4B6B57F7D7DF77238E9E436A248625C9F36B24A066CBE5</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 8C 9E 82 68 AE 66
0010 | 90 00 00 00 34 F7 CB 3B 81 BA A8 90 1B 79 63 A6
0020 | 9A 8E 8B EB C1 05 93 FD 9C FC EE B6 10 AF F6 64
0030 | 73 95 1E A6 F9 78 4C F9 92 E5 40 DB 4E FF B8 D9
0040 | 2F 92 4D 74 83 D5 DC EF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E08C9E8268AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90000000</code> (144 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>81BAA8901B7963A69A8E8BEBC10593FD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9CFCEEB610AFF66473951EA6F9784CF9</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>92E540DB4EFFB8D92F924D7483D5DCEF</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

