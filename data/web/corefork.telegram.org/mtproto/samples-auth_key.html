<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 74 24 08 00 92 CB 38 67
0010 | 14 00 00 00 F1 8E 7E BE 1B BA D0 0E 11 31 66 36
0020 | C1 B9 C0 4B 10 94 49 91</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7424080092CB3867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 14 B2 D4 92 CB 38 67
0010 | 50 00 00 00 63 24 16 05 1B BA D0 0E 11 31 66 36
0020 | C1 B9 C0 4B 10 94 49 91 16 A1 6B FD 31 17 CE 50
0030 | 63 59 3B 17 F8 B8 92 01 08 2E 40 64 21 C9 1C 65
0040 | 29 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0114B2D492CB3867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082E406421C91C6529000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3332773820524946729</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3332773820524946729</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3332773820524946729 = 1770870041 * 1881997969</code></p>
<pre><code>p = 1770870041
q = 1881997969</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2E 40 64 21 C9 1C 65 29 00 00 00
0010 | 04 69 8D 55 19 00 00 00 04 70 2D 02 91 00 00 00
0020 | 1B BA D0 0E 11 31 66 36 C1 B9 C0 4B 10 94 49 91
0030 | 16 A1 6B FD 31 17 CE 50 63 59 3B 17 F8 B8 92 01
0040 | 86 F3 5B 10 97 21 C8 55 E2 E8 81 55 3C EF 92 95
0050 | 0C 31 AE 54 A3 AE BB 4D 48 DC E8 4B 74 D5 DD 63
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082E406421C91C6529000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3332773820524946729</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04698D5519000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1770870041</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04702D0291000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1881997969</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>86F35B109721C855E2E881553CEF9295</code> <code>0C31AE54A3AEBB4D48DCE84B74D5DD63</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082E406421C91C652900000004698D551900000004702D02910000001BBAD00E11316636C1B9C04B1094499116A16BFD3117CE5063593B17F8B8920186F35B109721C855E2E881553CEF92950C31AE54A3AEBB4D48DCE84B74D5DD6302000000
random_padding_bytes = 3D3C5A73F7500704DB7F36ABDA9B28ADB869391B6740501DA761926239FCDE780F982B1452FC63A0FB9789FBCF33AD5762E41744BB3ACCD703640C180B9E78C55408C619A4381419CD4331D0DBE639D778183DC2924E54E004FB89B6</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 936F4E722A7FAD6B4E2CBA03A6D7DEBF69714074077E4B0BC9FA4E1D6F0633F64EB8A58895E239CB10972BB141D19290DC0F8A77CB798884DD72BAAB556522C8768A1EA223A2F980A67CF4F132BB962E8F1E8DC5BC6B6EEC6A476ABBC5115B289700BD81C2A2E143F3614269A7977C2D9B63C7B265A072C5864023DE8599D9B842321721195D547E0A7C75ED8B354918C1D02E77E9A7F28258F2C9BEB94FD5EFD739DF748228D3B3272CF1951CE392971B811C83E4ED28D59555833920270B1E028351A604C82013D3D9A731429AB78735E5E8E3E543CC5A46E3761D33E5CDB99C84949100203E84F8597CFB31C69991515053D383F6E2E2A13CB3977A551C42</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 24 08 00 92 CB 38 67
0010 | 40 01 00 00 BE E4 12 D7 1B BA D0 0E 11 31 66 36
0020 | C1 B9 C0 4B 10 94 49 91 16 A1 6B FD 31 17 CE 50
0030 | 63 59 3B 17 F8 B8 92 01 04 69 8D 55 19 00 00 00
0040 | 04 70 2D 02 91 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 93 6F 4E 72 2A 7F AD 6B 4E 2C BA 03
0060 | A6 D7 DE BF 69 71 40 74 07 7E 4B 0B C9 FA 4E 1D
0070 | 6F 06 33 F6 4E B8 A5 88 95 E2 39 CB 10 97 2B B1
0080 | 41 D1 92 90 DC 0F 8A 77 CB 79 88 84 DD 72 BA AB
0090 | 55 65 22 C8 76 8A 1E A2 23 A2 F9 80 A6 7C F4 F1
00A0 | 32 BB 96 2E 8F 1E 8D C5 BC 6B 6E EC 6A 47 6A BB
00B0 | C5 11 5B 28 97 00 BD 81 C2 A2 E1 43 F3 61 42 69
00C0 | A7 97 7C 2D 9B 63 C7 B2 65 A0 72 C5 86 40 23 DE
00D0 | 85 99 D9 B8 42 32 17 21 19 5D 54 7E 0A 7C 75 ED
00E0 | 8B 35 49 18 C1 D0 2E 77 E9 A7 F2 82 58 F2 C9 BE
00F0 | B9 4F D5 EF D7 39 DF 74 82 28 D3 B3 27 2C F1 95
0100 | 1C E3 92 97 1B 81 1C 83 E4 ED 28 D5 95 55 83 39
0110 | 20 27 0B 1E 02 83 51 A6 04 C8 20 13 D3 D9 A7 31
0120 | 42 9A B7 87 35 E5 E8 E3 E5 43 CC 5A 46 E3 76 1D
0130 | 33 E5 CD B9 9C 84 94 91 00 20 3E 84 F8 59 7C FB
0140 | 31 C6 99 91 51 50 53 D3 83 F6 E2 E2 A1 3C B3 97
0150 | 7A 55 1C 42</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7824080092CB3867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04698D5519000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1770870041</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04702D0291000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1881997969</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100936F4E722A7FAD6B4E2CBA03</code> <code>A6D7DEBF69714074077E4B0BC9FA4E1D</code> <code>6F0633F64EB8A58895E239CB10972BB1</code> <code>41D19290DC0F8A77CB798884DD72BAAB</code> <code>556522C8768A1EA223A2F980A67CF4F1</code> <code>32BB962E8F1E8DC5BC6B6EEC6A476ABB</code> <code>C5115B289700BD81C2A2E143F3614269</code> <code>A7977C2D9B63C7B265A072C5864023DE</code> <code>8599D9B842321721195D547E0A7C75ED</code> <code>8B354918C1D02E77E9A7F28258F2C9BE</code> <code>B94FD5EFD739DF748228D3B3272CF195</code> <code>1CE392971B811C83E4ED28D595558339</code> <code>20270B1E028351A604C82013D3D9A731</code> <code>429AB78735E5E8E3E543CC5A46E3761D</code> <code>33E5CDB99C84949100203E84F8597CFB</code> <code>31C69991515053D383F6E2E2A13CB397</code><br> <code>7A551C42</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 14 A5 E9 92 CB 38 67
0010 | 78 02 00 00 5C 07 E8 D0 1B BA D0 0E 11 31 66 36
0020 | C1 B9 C0 4B 10 94 49 91 16 A1 6B FD 31 17 CE 50
0030 | 63 59 3B 17 F8 B8 92 01 FE 50 02 00 8D 26 F0 C9
0040 | 96 D5 F3 CB 54 0A 5C F4 38 C8 B3 0E 75 FC 43 5B
0050 | B5 50 E3 BC ED C8 97 A0 74 D5 A9 5A EB BB 2F 1E
0060 | 51 14 99 E5 2E C4 08 9E E3 63 E4 DE 4F 46 64 1D
0070 | FA 7B BF EC B9 AA 64 23 05 2A 09 05 89 5D 0F 4D
0080 | 71 86 BE 92 F1 82 08 CD 64 81 E7 15 40 B2 30 E9
0090 | 2C 44 97 9D 07 63 5A AE A6 E8 6F CC 01 3A 85 B2
00A0 | 2F 0A 6F 24 95 E9 48 20 EE 0E 3D E2 36 80 89 D3
00B0 | E1 D3 34 CA D0 F6 74 F5 26 D0 09 E0 B2 A4 0D B3
00C0 | F1 1A F7 A9 3A 3C CA 1E 1F 72 6E 0C CD 13 0F 48
00D0 | DD 42 72 A8 74 65 3B 3C 5E DD F7 2A BD 7B FA B9
00E0 | 06 79 C1 3D 71 A8 C4 4C C1 AA 4A BC E9 A1 36 AB
00F0 | 82 6F 17 9E 8F 43 B7 FE A5 EC AC 67 E4 3B 85 F4
0100 | C2 21 3F F3 59 16 D0 2F 23 C3 C7 55 D7 BE 1D 32
0110 | 8B B0 64 C9 FF 38 4B 60 40 6E 46 19 BD 42 4E 6B
0120 | 5C 7E 8A 48 BF 95 B4 04 D9 93 AB 85 6B B3 89 8F
0130 | 74 A4 9C C4 E2 74 EA C5 21 C0 55 0F D7 9C 30 C2
0140 | 9D F8 0B D0 13 BD 1B 62 B2 80 3F 3F C1 5B 14 DF
0150 | 86 75 69 8C F3 E9 0A 05 FA 95 4A 30 9B 7A 2C AD
0160 | 84 DA 57 C2 81 1D D9 1A FA D1 75 D8 B3 07 D8 62
0170 | 7E EC E5 66 8C FF 2D FA AE 23 4B A9 FB DE 8A 2F
0180 | C1 A7 2E 9A 02 5D B0 AD 67 4F 28 90 25 E2 FC FB
0190 | 28 44 61 23 66 86 80 46 EB 47 8E 1F 62 F8 B1 DF
01A0 | 57 9F A9 53 EF C1 05 FD 74 9F E1 57 D9 19 B7 FE
01B0 | 1F A1 53 FF 1F C6 1E BB 90 CD 63 8C 62 47 F6 9C
01C0 | 28 82 2D 42 08 7A CB 53 1F B8 AA D5 27 AD 3C 1B
01D0 | 50 54 11 08 27 88 AD 7E 5F 8F AE 6E 9D B8 1B 28
01E0 | 82 7A 13 AC 8B 0A 27 07 9B A3 51 CD 24 18 77 1B
01F0 | 69 B7 99 BF E2 27 9F 90 6C 6D 74 7F 7E 76 2D E5
0200 | 5A F2 3F E4 81 8B DE 49 DA 8B 92 50 38 2C 03 8F
0210 | 75 D0 38 2B 51 F9 39 39 08 A0 6C 6C A9 7B 28 C2
0220 | 86 CA B1 74 5B AC B4 0E FF 8F F8 27 14 51 A4 BE
0230 | 9C C6 7D DC C2 4E CE 7A 18 98 04 A8 56 41 2F EF
0240 | C7 A5 DA CB 16 4C 45 3C 05 F3 DD A5 AD 23 16 CF
0250 | 9C 9E 0F 1D 25 DF EA 13 86 4A 75 6E 8B CA F6 B0
0260 | 33 5B 86 C9 76 88 41 D7 88 62 FD 66 A3 61 0B D4
0270 | D2 32 FD FE 52 5D 80 82 B4 BF DB B7 95 07 56 54
0280 | 2A 13 6D 9F E8 37 15 82 81 B2 E3 85</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0114A5E992CB3867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002008D26F0C996D5F3CB540A5CF4</code> <code>38C8B30E75FC435BB550E3BCEDC897A0</code> <code>74D5A95AEBBB2F1E511499E52EC4089E</code> <code>E363E4DE4F46641DFA7BBFECB9AA6423</code> <code>052A0905895D0F4D7186BE92F18208CD</code> <code>6481E71540B230E92C44979D07635AAE</code> <code>A6E86FCC013A85B22F0A6F2495E94820</code> <code>EE0E3DE2368089D3E1D334CAD0F674F5</code> <code>26D009E0B2A40DB3F11AF7A93A3CCA1E</code> <code>1F726E0CCD130F48DD4272A874653B3C</code> <code>5EDDF72ABD7BFAB90679C13D71A8C44C</code> <code>C1AA4ABCE9A136AB826F179E8F43B7FE</code> <code>A5ECAC67E43B85F4C2213FF35916D02F</code> <code>23C3C755D7BE1D328BB064C9FF384B60</code> <code>406E4619BD424E6B5C7E8A48BF95B404</code> <code>D993AB856BB3898F74A49CC4E274EAC5</code> <code>21C0550FD79C30C29DF80BD013BD1B62</code> <code>B2803F3FC15B14DF8675698CF3E90A05</code> <code>FA954A309B7A2CAD84DA57C2811DD91A</code> <code>FAD175D8B307D8627EECE5668CFF2DFA</code> <code>AE234BA9FBDE8A2FC1A72E9A025DB0AD</code> <code>674F289025E2FCFB2844612366868046</code> <code>EB478E1F62F8B1DF579FA953EFC105FD</code> <code>749FE157D919B7FE1FA153FF1FC61EBB</code> <code>90CD638C6247F69C28822D42087ACB53</code> <code>1FB8AAD527AD3C1B505411082788AD7E</code> <code>5F8FAE6E9DB81B28827A13AC8B0A2707</code> <code>9BA351CD2418771B69B799BFE2279F90</code> <code>6C6D747F7E762DE55AF23FE4818BDE49</code> <code>DA8B9250382C038F75D0382B51F93939</code> <code>08A06C6CA97B28C286CAB1745BACB40E</code> <code>FF8FF8271451A4BE9CC67DDCC24ECE7A</code> <code>189804A856412FEFC7A5DACB164C453C</code> <code>05F3DDA5AD2316CF9C9E0F1D25DFEA13</code> <code>864A756E8BCAF6B0335B86C9768841D7</code> <code>8862FD66A3610BD4D232FDFE525D8082</code> <code>B4BFDBB7950756542A136D9FE8371582</code><br> <code>81B2E385</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 8D26F0C996D5F3CB540A5CF438C8B30E75FC435BB550E3BCEDC897A074D5A95AEBBB2F1E511499E52EC4089EE363E4DE4F46641DFA7BBFECB9AA6423052A0905895D0F4D7186BE92F18208CD6481E71540B230E92C44979D07635AAEA6E86FCC013A85B22F0A6F2495E94820EE0E3DE2368089D3E1D334CAD0F674F526D009E0B2A40DB3F11AF7A93A3CCA1E1F726E0CCD130F48DD4272A874653B3C5EDDF72ABD7BFAB90679C13D71A8C44CC1AA4ABCE9A136AB826F179E8F43B7FEA5ECAC67E43B85F4C2213FF35916D02F23C3C755D7BE1D328BB064C9FF384B60406E4619BD424E6B5C7E8A48BF95B404D993AB856BB3898F74A49CC4E274EAC521C0550FD79C30C29DF80BD013BD1B62B2803F3FC15B14DF8675698CF3E90A05FA954A309B7A2CAD84DA57C2811DD91AFAD175D8B307D8627EECE5668CFF2DFAAE234BA9FBDE8A2FC1A72E9A025DB0AD674F289025E2FCFB2844612366868046EB478E1F62F8B1DF579FA953EFC105FD749FE157D919B7FE1FA153FF1FC61EBB90CD638C6247F69C28822D42087ACB531FB8AAD527AD3C1B505411082788AD7E5F8FAE6E9DB81B28827A13AC8B0A27079BA351CD2418771B69B799BFE2279F906C6D747F7E762DE55AF23FE4818BDE49DA8B9250382C038F75D0382B51F9393908A06C6CA97B28C286CAB1745BACB40EFF8FF8271451A4BE9CC67DDCC24ECE7A189804A856412FEFC7A5DACB164C453C05F3DDA5AD2316CF9C9E0F1D25DFEA13864A756E8BCAF6B0335B86C9768841D78862FD66A3610BD4D232FDFE525D8082B4BFDBB7950756542A136D9FE837158281B2E385
tmp_aes_key = 4298A03F609E0E3E1493BBFA37FB311E80D1DDEB1E7B88D01BF827B807D1DB5E
tmp_aes_iv = 2D165A15D4C176A7989F0620676F514FE0065D1FB2A918EA80FDDEDF86F35B10</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 57AA45D5977ABE021682E970D99A2408B6F11B24BA0D89B51BBAD00E11316636C1B9C04B1094499116A16BFD3117CE5063593B17F8B8920103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010079B54F6278D32651D98B5ECCB4B86CF581CA0C9BC52C3A91D7DBE60CCCDAC314E210C31020688D95A2E4E0EDA5FA249E666D8543F2006147AFC30C97B5DD17D132C97D73E5370E0AA307054662DACED3E31E55FE8C0DBB7A6299E20FBD3F11CDECD388916A625B7C3FA4DCA90C4EBBDC1045BA699F187998B270CA2909E9440123692C479D8B3E3634B86D16C021F12B3AD2EBE2D8AD4CBAA897A1C43DEBD72D9AE320A27A1239229760726FDF36A2CC5170096DFA792E232738183C2D0B5BF3DFA395DCD6EC5642C235C36B24667B50B70118770869189D69D90B2F6B5A55928E6FBCED52B467E739E66926285A62238B9F8484105280556367EFD4AA7FC56A92CB3867F7977AE980373BD0
answer = BA0D89B51BBAD00E11316636C1B9C04B1094499116A16BFD3117CE5063593B17F8B8920103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010079B54F6278D32651D98B5ECCB4B86CF581CA0C9BC52C3A91D7DBE60CCCDAC314E210C31020688D95A2E4E0EDA5FA249E666D8543F2006147AFC30C97B5DD17D132C97D73E5370E0AA307054662DACED3E31E55FE8C0DBB7A6299E20FBD3F11CDECD388916A625B7C3FA4DCA90C4EBBDC1045BA699F187998B270CA2909E9440123692C479D8B3E3634B86D16C021F12B3AD2EBE2D8AD4CBAA897A1C43DEBD72D9AE320A27A1239229760726FDF36A2CC5170096DFA792E232738183C2D0B5BF3DFA395DCD6EC5642C235C36B24667B50B70118770869189D69D90B2F6B5A55928E6FBCED52B467E739E66926285A62238B9F8484105280556367EFD4AA7FC56A92CB3867F7977AE980373BD0</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 1B BA D0 0E 11 31 66 36 C1 B9 C0 4B
0010 | 10 94 49 91 16 A1 6B FD 31 17 CE 50 63 59 3B 17
0020 | F8 B8 92 01 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 79 B5 4F 62 78 D3 26 51 D9 8B 5E CC B4 B8 6C F5
0140 | 81 CA 0C 9B C5 2C 3A 91 D7 DB E6 0C CC DA C3 14
0150 | E2 10 C3 10 20 68 8D 95 A2 E4 E0 ED A5 FA 24 9E
0160 | 66 6D 85 43 F2 00 61 47 AF C3 0C 97 B5 DD 17 D1
0170 | 32 C9 7D 73 E5 37 0E 0A A3 07 05 46 62 DA CE D3
0180 | E3 1E 55 FE 8C 0D BB 7A 62 99 E2 0F BD 3F 11 CD
0190 | EC D3 88 91 6A 62 5B 7C 3F A4 DC A9 0C 4E BB DC
01A0 | 10 45 BA 69 9F 18 79 98 B2 70 CA 29 09 E9 44 01
01B0 | 23 69 2C 47 9D 8B 3E 36 34 B8 6D 16 C0 21 F1 2B
01C0 | 3A D2 EB E2 D8 AD 4C BA A8 97 A1 C4 3D EB D7 2D
01D0 | 9A E3 20 A2 7A 12 39 22 97 60 72 6F DF 36 A2 CC
01E0 | 51 70 09 6D FA 79 2E 23 27 38 18 3C 2D 0B 5B F3
01F0 | DF A3 95 DC D6 EC 56 42 C2 35 C3 6B 24 66 7B 50
0200 | B7 01 18 77 08 69 18 9D 69 D9 0B 2F 6B 5A 55 92
0210 | 8E 6F BC ED 52 B4 67 E7 39 E6 69 26 28 5A 62 23
0220 | 8B 9F 84 84 10 52 80 55 63 67 EF D4 AA 7F C5 6A
0230 | 92 CB 38 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010079B54F6278D32651D98B5ECC</code> <code>B4B86CF581CA0C9BC52C3A91D7DBE60C</code> <code>CCDAC314E210C31020688D95A2E4E0ED</code> <code>A5FA249E666D8543F2006147AFC30C97</code> <code>B5DD17D132C97D73E5370E0AA3070546</code> <code>62DACED3E31E55FE8C0DBB7A6299E20F</code> <code>BD3F11CDECD388916A625B7C3FA4DCA9</code> <code>0C4EBBDC1045BA699F187998B270CA29</code> <code>09E9440123692C479D8B3E3634B86D16</code> <code>C021F12B3AD2EBE2D8AD4CBAA897A1C4</code> <code>3DEBD72D9AE320A27A1239229760726F</code> <code>DF36A2CC5170096DFA792E232738183C</code> <code>2D0B5BF3DFA395DCD6EC5642C235C36B</code> <code>24667B50B70118770869189D69D90B2F</code> <code>6B5A55928E6FBCED52B467E739E66926</code> <code>285A62238B9F8484105280556367EFD4</code><br> <code>AA7FC56A</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>92CB3867</code> (1731775378 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 958210AD1A17DD51C95AC4E7B36F56AE6B14C70D92BDA922BBC1DAA63F3DBB5933A8F292B825D8931528027AD4573A7D70654782A2D4CB8F58864C568C6F50D53C6F2FC51B7796F97B3DD487D35AFC7F00FBAC99C6D374C177CE7608C166EE147D4E84C13131AF6C20BBEBB5A7445FCEB84F5CFE21E3E796E83B1FB877CD9FF1EB60D48AC10744C216C343A2E569FA8FB18510CF07ABB3934676C910792D644ACB477364FF6B4812760BB73614E06C533592B8997F1CE138EC2E51C1C18CBD321B74A5B406937FEC0AFB5C3A32BA8173238AB57EE4749FE398843EB47FF11C0305CFDF73982BDDEE6A539B802D1FB90E576B2655CB044660922527341500A0D0</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 56E2DCC5219A8FF364A6A7EFE1FF8F57B75CA81CF4AFCB975CE4967F5DC20A88A24EB3D79EBCFD5C955B177B8FEE2A2E15B9F98DB6FB4EC3E1E809960634E8C7109B41602749C969C1185ABB51964E565E1D054FCDF359E28B76FBBC70C57F56E5BB0FFD412AA46D2C85AD35DAB9A80C85891D123A2E2092D7AD556E40CA2CF53B6D45AA44306FC174D7F8AFDEC6E7B8049C7B1192A77982997313808CBD57E0FEBF4C8B2946BC807850E8A601457E4529498F114AAB22BD525F157916515737795BAB7ADD81F349CBF9F1119A2707396183A095281F9F3B93ADE18C10513196242857EAC8B2EE9431E1DFE24D56C33F9D8C8C8DB2FA259996C05E2170A4DAAA</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 1B BA D0 0E 11 31 66 36 C1 B9 C0 4B
0010 | 10 94 49 91 16 A1 6B FD 31 17 CE 50 63 59 3B 17
0020 | F8 B8 92 01 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 56 E2 DC C5 21 9A 8F F3 64 A6 A7 EF E1 FF 8F 57
0040 | B7 5C A8 1C F4 AF CB 97 5C E4 96 7F 5D C2 0A 88
0050 | A2 4E B3 D7 9E BC FD 5C 95 5B 17 7B 8F EE 2A 2E
0060 | 15 B9 F9 8D B6 FB 4E C3 E1 E8 09 96 06 34 E8 C7
0070 | 10 9B 41 60 27 49 C9 69 C1 18 5A BB 51 96 4E 56
0080 | 5E 1D 05 4F CD F3 59 E2 8B 76 FB BC 70 C5 7F 56
0090 | E5 BB 0F FD 41 2A A4 6D 2C 85 AD 35 DA B9 A8 0C
00A0 | 85 89 1D 12 3A 2E 20 92 D7 AD 55 6E 40 CA 2C F5
00B0 | 3B 6D 45 AA 44 30 6F C1 74 D7 F8 AF DE C6 E7 B8
00C0 | 04 9C 7B 11 92 A7 79 82 99 73 13 80 8C BD 57 E0
00D0 | FE BF 4C 8B 29 46 BC 80 78 50 E8 A6 01 45 7E 45
00E0 | 29 49 8F 11 4A AB 22 BD 52 5F 15 79 16 51 57 37
00F0 | 79 5B AB 7A DD 81 F3 49 CB F9 F1 11 9A 27 07 39
0100 | 61 83 A0 95 28 1F 9F 3B 93 AD E1 8C 10 51 31 96
0110 | 24 28 57 EA C8 B2 EE 94 31 E1 DF E2 4D 56 C3 3F
0120 | 9D 8C 8C 8D B2 FA 25 99 96 C0 5E 21 70 A4 DA AA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010056E2DCC5219A8FF364A6A7EF</code> <code>E1FF8F57B75CA81CF4AFCB975CE4967F</code> <code>5DC20A88A24EB3D79EBCFD5C955B177B</code> <code>8FEE2A2E15B9F98DB6FB4EC3E1E80996</code> <code>0634E8C7109B41602749C969C1185ABB</code> <code>51964E565E1D054FCDF359E28B76FBBC</code> <code>70C57F56E5BB0FFD412AA46D2C85AD35</code> <code>DAB9A80C85891D123A2E2092D7AD556E</code> <code>40CA2CF53B6D45AA44306FC174D7F8AF</code> <code>DEC6E7B8049C7B1192A7798299731380</code> <code>8CBD57E0FEBF4C8B2946BC807850E8A6</code> <code>01457E4529498F114AAB22BD525F1579</code> <code>16515737795BAB7ADD81F349CBF9F111</code> <code>9A2707396183A095281F9F3B93ADE18C</code> <code>10513196242857EAC8B2EE9431E1DFE2</code> <code>4D56C33F9D8C8C8DB2FA259996C05E21</code><br> <code>70A4DAAA</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643661BBAD00E11316636C1B9C04B1094499116A16BFD3117CE5063593B17F8B892010000000000000000FE00010056E2DCC5219A8FF364A6A7EFE1FF8F57B75CA81CF4AFCB975CE4967F5DC20A88A24EB3D79EBCFD5C955B177B8FEE2A2E15B9F98DB6FB4EC3E1E809960634E8C7109B41602749C969C1185ABB51964E565E1D054FCDF359E28B76FBBC70C57F56E5BB0FFD412AA46D2C85AD35DAB9A80C85891D123A2E2092D7AD556E40CA2CF53B6D45AA44306FC174D7F8AFDEC6E7B8049C7B1192A77982997313808CBD57E0FEBF4C8B2946BC807850E8A601457E4529498F114AAB22BD525F157916515737795BAB7ADD81F349CBF9F1119A2707396183A095281F9F3B93ADE18C10513196242857EAC8B2EE9431E1DFE24D56C33F9D8C8C8DB2FA259996C05E2170A4DAAA
padding = CD07CAAD48CA829C47822EC0
tmp_aes_key = 4298A03F609E0E3E1493BBFA37FB311E80D1DDEB1E7B88D01BF827B807D1DB5E
tmp_aes_iv = 2D165A15D4C176A7989F0620676F514FE0065D1FB2A918EA80FDDEDF86F35B10</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 6166DD0AF2A8200A186EAF5149A3A46D9CAAF2E09B510ED5270674B5CB293B5D281201AEF52DAADFAD767E15E46C89319D84F2591C215F0A40C5EB2433069489D3D6FE02EE2D5441CAEFED4799C2E7CA294A31496937CB40326D4DD9F80EE954ED05E33EB6E295B09517740F3EB16808A21F1B0D8C401770C19B6BCB913A4E629130843EBDE3946E15053806D0E187F94404C4465E5038F2DFBCF9E8E12D51E80921560D908DE63BFC0B2F04B3C16F175D774FF3AB4FA067F806C87CE651F1A7A47D12B787D04F353E52B75890762212B7196B33B8E8FE7E6FACAF98D32E6F03095555800DB324D34470827F1012D0375CA69E559E0929D93F6D328B9A0EFBCB955C86B3B69A8631295BF394AFF2637C2BA7C63DAB3E463C4D442583BA17BA0CFE2A21CA21488AD92C83297D1F27973EAFFA1BEED3D2F49DD5A0DDD6ABE331B870236BBAFFB63EC622211377B3805506</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C 24 08 00 92 CB 38 67
0010 | 78 01 00 00 1F 5F 04 F5 1B BA D0 0E 11 31 66 36
0020 | C1 B9 C0 4B 10 94 49 91 16 A1 6B FD 31 17 CE 50
0030 | 63 59 3B 17 F8 B8 92 01 FE 50 01 00 61 66 DD 0A
0040 | F2 A8 20 0A 18 6E AF 51 49 A3 A4 6D 9C AA F2 E0
0050 | 9B 51 0E D5 27 06 74 B5 CB 29 3B 5D 28 12 01 AE
0060 | F5 2D AA DF AD 76 7E 15 E4 6C 89 31 9D 84 F2 59
0070 | 1C 21 5F 0A 40 C5 EB 24 33 06 94 89 D3 D6 FE 02
0080 | EE 2D 54 41 CA EF ED 47 99 C2 E7 CA 29 4A 31 49
0090 | 69 37 CB 40 32 6D 4D D9 F8 0E E9 54 ED 05 E3 3E
00A0 | B6 E2 95 B0 95 17 74 0F 3E B1 68 08 A2 1F 1B 0D
00B0 | 8C 40 17 70 C1 9B 6B CB 91 3A 4E 62 91 30 84 3E
00C0 | BD E3 94 6E 15 05 38 06 D0 E1 87 F9 44 04 C4 46
00D0 | 5E 50 38 F2 DF BC F9 E8 E1 2D 51 E8 09 21 56 0D
00E0 | 90 8D E6 3B FC 0B 2F 04 B3 C1 6F 17 5D 77 4F F3
00F0 | AB 4F A0 67 F8 06 C8 7C E6 51 F1 A7 A4 7D 12 B7
0100 | 87 D0 4F 35 3E 52 B7 58 90 76 22 12 B7 19 6B 33
0110 | B8 E8 FE 7E 6F AC AF 98 D3 2E 6F 03 09 55 55 80
0120 | 0D B3 24 D3 44 70 82 7F 10 12 D0 37 5C A6 9E 55
0130 | 9E 09 29 D9 3F 6D 32 8B 9A 0E FB CB 95 5C 86 B3
0140 | B6 9A 86 31 29 5B F3 94 AF F2 63 7C 2B A7 C6 3D
0150 | AB 3E 46 3C 4D 44 25 83 BA 17 BA 0C FE 2A 21 CA
0160 | 21 48 8A D9 2C 83 29 7D 1F 27 97 3E AF FA 1B EE
0170 | D3 D2 F4 9D D5 A0 DD D6 AB E3 31 B8 70 23 6B BA
0180 | FF B6 3E C6 22 21 13 77 B3 80 55 06</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7C24080092CB3867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001006166DD0AF2A8200A186EAF51</code> <code>49A3A46D9CAAF2E09B510ED5270674B5</code> <code>CB293B5D281201AEF52DAADFAD767E15</code> <code>E46C89319D84F2591C215F0A40C5EB24</code> <code>33069489D3D6FE02EE2D5441CAEFED47</code> <code>99C2E7CA294A31496937CB40326D4DD9</code> <code>F80EE954ED05E33EB6E295B09517740F</code> <code>3EB16808A21F1B0D8C401770C19B6BCB</code> <code>913A4E629130843EBDE3946E15053806</code> <code>D0E187F94404C4465E5038F2DFBCF9E8</code> <code>E12D51E80921560D908DE63BFC0B2F04</code> <code>B3C16F175D774FF3AB4FA067F806C87C</code> <code>E651F1A7A47D12B787D04F353E52B758</code> <code>90762212B7196B33B8E8FE7E6FACAF98</code> <code>D32E6F03095555800DB324D34470827F</code> <code>1012D0375CA69E559E0929D93F6D328B</code> <code>9A0EFBCB955C86B3B69A8631295BF394</code> <code>AFF2637C2BA7C63DAB3E463C4D442583</code> <code>BA17BA0CFE2A21CA21488AD92C83297D</code> <code>1F27973EAFFA1BEED3D2F49DD5A0DDD6</code> <code>ABE331B870236BBAFFB63EC622211377</code><br> <code>B3805506</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 22AE7F4DB8B3F2C01BB2D80C68E253AF27C4215C6C674DAD288838CE3C259E9ED2B2F0633A58393F79077BF4EC28A2F3ABABF2C124F6B83F1AE49F9CBB2EB0FC7174D05F82C5519FF285D9793DDD75D339F34ED02F8C68B6310969F2B380A2D0AEE2122E110C53653969EC4EA335D827A3CECEC96708AEA4B4C96D206822F81DAED8D88DD757DFF13EA0CBDA47E66FD4CAB6A29CB44FE420FFC68BB59B70FAF38E09E0D4F304EAD283CB68B9EBE6DCCF53FA471D1E4AF3926F67D49930C40BB19337696D78DB5DC627CC55F7C731B4DE31E7C4FAFF7D6B8ABF7BCDE1014C660608BA19B9FC16909C9786197E6EAB10A9983DD7E91DE23FCF2BD91739C04A1289</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 90 D5 01 94 CB 38 67
0010 | 34 00 00 00 34 F7 CB 3B 1B BA D0 0E 11 31 66 36
0020 | C1 B9 C0 4B 10 94 49 91 16 A1 6B FD 31 17 CE 50
0030 | 63 59 3B 17 F8 B8 92 01 0D 20 B4 1A 4A 21 73 5F
0040 | 72 C3 A3 AA BD 4A 92 5C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0190D50194CB3867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1BBAD00E11316636C1B9C04B10944991</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>16A16BFD3117CE5063593B17F8B89201</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>0D20B41A4A21735F72C3A3AABD4A925C</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

