<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 62 0C 00 0F 09 9E 66
0010 | 14 00 00 00 F1 8E 7E BE FE 7E E3 8C 9F B2 A0 E1
0020 | 5D 1A BB 74 C2 E1 33 D2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C0620C000F099E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 5C F7 B5 0F 09 9E 66
0010 | 54 00 00 00 63 24 16 05 FE 7E E3 8C 9F B2 A0 E1
0020 | 5D 1A BB 74 C2 E1 33 D2 B1 1B 06 86 D3 43 E5 FB
0030 | BC DC 58 F8 8E 1E 3A E8 08 21 F7 74 9A 09 EA 98
0040 | A3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015CF7B50F099E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0821F7749A09EA98A3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2447553127439308963</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2447553127439308963</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2447553127439308963 = 1284150331 * 1905970873</code></p>
<pre><code>p = 1284150331
q = 1905970873</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 21 F7 74 9A 09 EA 98 A3 00 00 00
0010 | 04 4C 8A 94 3B 00 00 00 04 71 9A CE B9 00 00 00
0020 | FE 7E E3 8C 9F B2 A0 E1 5D 1A BB 74 C2 E1 33 D2
0030 | B1 1B 06 86 D3 43 E5 FB BC DC 58 F8 8E 1E 3A E8
0040 | 2E 2D 46 44 8E CC BF CD E4 D0 55 64 EA 29 5F 70
0050 | A8 27 B4 1B 52 A7 88 64 78 21 FA 22 80 5B 01 79
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0821F7749A09EA98A3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2447553127439308963</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044C8A943B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1284150331</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04719ACEB9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1905970873</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>2E2D46448ECCBFCDE4D05564EA295F70</code> <code>A827B41B52A788647821FA22805B0179</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90821F7749A09EA98A3000000044C8A943B00000004719ACEB9000000FE7EE38C9FB2A0E15D1ABB74C2E133D2B11B0686D343E5FBBCDC58F88E1E3AE82E2D46448ECCBFCDE4D05564EA295F70A827B41B52A788647821FA22805B017902000000
random_padding_bytes = CD8C4EDA27DA91F03C9F8CF051671783BD56D31E5B19B9CFA703A84F0E9DBE62D2E45EA494E1BAF3D8D9A331D758DB115263DE35EB87D32EE526D4AB2F78169F9E6D1EDC3D5B6F16EF5976040CE69FCEF80F0E8B5E75E89419B3D7B8</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = E29368A6A56B647710525E2591AE29AE3AE8D35FB014BE046AE77F2FFB3F1123835032E4406A6C8344EF019536CA43D4ABB07809464ED1994415E0C34708C96CF35B05C8F8248AD3B3263D68E20D070B2ADB55FA160EF76A9571C841E5EB57BDEAC205C6049CFFF01C0552D5B9DFCD1A4A01CF79BAF2E42CE19927C76E38B060D7260AA263AB5309B55685AAF330E161666F25CAF03EEDF8EE77646C2B2A052B272CF7ADEDD326EB12E905A5F4AF56FA6820416E568CC476D847E3AAA5EF7EE1455F73405F28C83D81655246ED94176385DAD0B19F985E0073B4ABC6A232EBFEA03AE1B43BD662C587167668D3D5678ECBB65461D0A46E67A574933037F90109</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C4 62 0C 00 0F 09 9E 66
0010 | 40 01 00 00 BE E4 12 D7 FE 7E E3 8C 9F B2 A0 E1
0020 | 5D 1A BB 74 C2 E1 33 D2 B1 1B 06 86 D3 43 E5 FB
0030 | BC DC 58 F8 8E 1E 3A E8 04 4C 8A 94 3B 00 00 00
0040 | 04 71 9A CE B9 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 E2 93 68 A6 A5 6B 64 77 10 52 5E 25
0060 | 91 AE 29 AE 3A E8 D3 5F B0 14 BE 04 6A E7 7F 2F
0070 | FB 3F 11 23 83 50 32 E4 40 6A 6C 83 44 EF 01 95
0080 | 36 CA 43 D4 AB B0 78 09 46 4E D1 99 44 15 E0 C3
0090 | 47 08 C9 6C F3 5B 05 C8 F8 24 8A D3 B3 26 3D 68
00A0 | E2 0D 07 0B 2A DB 55 FA 16 0E F7 6A 95 71 C8 41
00B0 | E5 EB 57 BD EA C2 05 C6 04 9C FF F0 1C 05 52 D5
00C0 | B9 DF CD 1A 4A 01 CF 79 BA F2 E4 2C E1 99 27 C7
00D0 | 6E 38 B0 60 D7 26 0A A2 63 AB 53 09 B5 56 85 AA
00E0 | F3 30 E1 61 66 6F 25 CA F0 3E ED F8 EE 77 64 6C
00F0 | 2B 2A 05 2B 27 2C F7 AD ED D3 26 EB 12 E9 05 A5
0100 | F4 AF 56 FA 68 20 41 6E 56 8C C4 76 D8 47 E3 AA
0110 | A5 EF 7E E1 45 5F 73 40 5F 28 C8 3D 81 65 52 46
0120 | ED 94 17 63 85 DA D0 B1 9F 98 5E 00 73 B4 AB C6
0130 | A2 32 EB FE A0 3A E1 B4 3B D6 62 C5 87 16 76 68
0140 | D3 D5 67 8E CB B6 54 61 D0 A4 6E 67 A5 74 93 30
0150 | 37 F9 01 09</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C4620C000F099E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044C8A943B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1284150331</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04719ACEB9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1905970873</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100E29368A6A56B647710525E25</code> <code>91AE29AE3AE8D35FB014BE046AE77F2F</code> <code>FB3F1123835032E4406A6C8344EF0195</code> <code>36CA43D4ABB07809464ED1994415E0C3</code> <code>4708C96CF35B05C8F8248AD3B3263D68</code> <code>E20D070B2ADB55FA160EF76A9571C841</code> <code>E5EB57BDEAC205C6049CFFF01C0552D5</code> <code>B9DFCD1A4A01CF79BAF2E42CE19927C7</code> <code>6E38B060D7260AA263AB5309B55685AA</code> <code>F330E161666F25CAF03EEDF8EE77646C</code> <code>2B2A052B272CF7ADEDD326EB12E905A5</code> <code>F4AF56FA6820416E568CC476D847E3AA</code> <code>A5EF7EE1455F73405F28C83D81655246</code> <code>ED94176385DAD0B19F985E0073B4ABC6</code> <code>A232EBFEA03AE1B43BD662C587167668</code> <code>D3D5678ECBB65461D0A46E67A5749330</code><br> <code>37F90109</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B8 EC 79 10 09 9E 66
0010 | D4 02 00 00 5C 07 E8 D0 FE 7E E3 8C 9F B2 A0 E1
0020 | 5D 1A BB 74 C2 E1 33 D2 B1 1B 06 86 D3 43 E5 FB
0030 | BC DC 58 F8 8E 1E 3A E8 FE 50 02 00 84 40 93 D5
0040 | 80 3E 05 63 86 D8 C8 9B 88 80 04 03 45 18 3F FB
0050 | 82 DD 62 1D DA 6D 88 DA 41 A4 8D 86 E9 E3 AD F2
0060 | 48 53 5B 80 4E 72 44 A0 71 33 47 6C 01 E1 B0 00
0070 | CE C8 15 C5 F7 B8 8E 4D 0D 05 F6 C9 42 10 EA 34
0080 | D5 FC 6A DD 2D B9 87 63 0A 01 84 86 7C 7D E2 C1
0090 | EB 45 78 E5 91 F0 88 47 B8 C4 0F 82 85 D4 6C C2
00A0 | 51 37 17 75 F3 79 28 96 55 9A BF 0C 8F 16 8C 4D
00B0 | E1 D6 0B 4C AA A1 81 F8 2F ED DC 3C FB 6C BC 4A
00C0 | 7D B1 2B F8 79 8C 10 2A 83 9E 9D C5 1E 6F 7F 97
00D0 | 80 27 A3 B0 A2 47 68 5A 3C 0F 1D CB 12 CE 0D 29
00E0 | 20 37 EA 78 C7 B1 50 F3 A6 FD 31 82 9D 10 EF 21
00F0 | 22 4F 10 BE B9 A7 3D E7 2B 3B 87 E2 8E 47 78 EE
0100 | D0 DA 4C 19 31 05 D4 36 C4 E6 FD 4A C1 60 8D 01
0110 | CB D3 E7 E1 D7 8E 96 B9 D8 DC 3C 37 F1 2B 72 05
0120 | 5F 88 DA 9B EA E2 26 BA 60 1D EC FE 20 D5 D9 72
0130 | 2F E5 34 B8 45 74 5F BF A0 B2 AE 46 7F 9A 42 5A
0140 | 6F CE 0A 4E 58 B9 AA 51 6A BC C6 8B 78 C6 4E 63
0150 | 4C DE A3 53 21 C3 79 99 D4 74 DB 0B 38 02 57 5A
0160 | 08 65 69 19 9E 14 27 B7 D9 F2 D6 D4 62 4C 48 83
0170 | AC 6C 7F 37 F8 37 12 E2 3D F8 D5 67 F7 56 DC 00
0180 | 2A 59 94 E6 65 7E 63 4F CD 0F B3 29 AD B2 89 54
0190 | E5 CD EB C8 8B A8 10 19 A2 3C A9 2B 49 D1 39 2D
01A0 | A1 6B D9 81 7F 27 47 87 03 F1 65 FD 8D 1D 07 7B
01B0 | 8C 44 C9 25 AD 3A 11 95 2E A5 CC 20 F9 4B 2C C6
01C0 | 4D B6 5B 11 EC DA 51 18 69 5F 8D FD E1 F4 CA B2
01D0 | D4 4D 0E 57 07 89 D4 A1 FA E6 5C EB D4 57 3C A4
01E0 | D5 5A 5C E9 9C E3 5D 3E 2F D5 CC 60 74 A2 D7 46
01F0 | 65 69 7D D1 AB D8 9C 24 F0 39 2F 07 9E FB 4A A8
0200 | AB 93 BE C6 CE 8A 7C 1A 94 D4 15 25 18 9F 9C DC
0210 | 86 29 77 7A 8F C5 E2 A8 09 AC A8 01 F5 69 5A BC
0220 | FC A4 2C BA F4 E7 78 63 46 74 9C B8 93 7A B5 F4
0230 | 76 C7 F2 04 3C 8D F9 91 60 0F AB 01 CD A7 CC 4C
0240 | 3B AA 38 A7 56 B4 15 B6 59 2A 47 E4 10 82 76 66
0250 | 33 4C EF 01 F6 9F 68 15 24 9E 0E EA 4C DF D7 C7
0260 | A3 E0 9C B4 C0 D3 16 96 A8 0D 52 78 7B E0 B6 47
0270 | CC 71 69 12 26 55 B0 3F 72 BA A3 00 34 F8 12 62
0280 | DA 9E 2F 53 1B DE FB 57 56 C3 21 8F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B8EC7910099E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>D4020000</code> (724 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200844093D5803E056386D8C89B</code> <code>8880040345183FFB82DD621DDA6D88DA</code> <code>41A48D86E9E3ADF248535B804E7244A0</code> <code>7133476C01E1B000CEC815C5F7B88E4D</code> <code>0D05F6C94210EA34D5FC6ADD2DB98763</code> <code>0A0184867C7DE2C1EB4578E591F08847</code> <code>B8C40F8285D46CC251371775F3792896</code> <code>559ABF0C8F168C4DE1D60B4CAAA181F8</code> <code>2FEDDC3CFB6CBC4A7DB12BF8798C102A</code> <code>839E9DC51E6F7F978027A3B0A247685A</code> <code>3C0F1DCB12CE0D292037EA78C7B150F3</code> <code>A6FD31829D10EF21224F10BEB9A73DE7</code> <code>2B3B87E28E4778EED0DA4C193105D436</code> <code>C4E6FD4AC1608D01CBD3E7E1D78E96B9</code> <code>D8DC3C37F12B72055F88DA9BEAE226BA</code> <code>601DECFE20D5D9722FE534B845745FBF</code> <code>A0B2AE467F9A425A6FCE0A4E58B9AA51</code> <code>6ABCC68B78C64E634CDEA35321C37999</code> <code>D474DB0B3802575A086569199E1427B7</code> <code>D9F2D6D4624C4883AC6C7F37F83712E2</code> <code>3DF8D567F756DC002A5994E6657E634F</code> <code>CD0FB329ADB28954E5CDEBC88BA81019</code> <code>A23CA92B49D1392DA16BD9817F274787</code> <code>03F165FD8D1D077B8C44C925AD3A1195</code> <code>2EA5CC20F94B2CC64DB65B11ECDA5118</code> <code>695F8DFDE1F4CAB2D44D0E570789D4A1</code> <code>FAE65CEBD4573CA4D55A5CE99CE35D3E</code> <code>2FD5CC6074A2D74665697DD1ABD89C24</code> <code>F0392F079EFB4AA8AB93BEC6CE8A7C1A</code> <code>94D41525189F9CDC8629777A8FC5E2A8</code> <code>09ACA801F5695ABCFCA42CBAF4E77863</code> <code>46749CB8937AB5F476C7F2043C8DF991</code> <code>600FAB01CDA7CC4C3BAA38A756B415B6</code> <code>592A47E410827666334CEF01F69F6815</code> <code>249E0EEA4CDFD7C7A3E09CB4C0D31696</code> <code>A80D52787BE0B647CC7169122655B03F</code> <code>72BAA30034F81262DA9E2F531BDEFB57</code><br> <code>56C3218F</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 844093D5803E056386D8C89B8880040345183FFB82DD621DDA6D88DA41A48D86E9E3ADF248535B804E7244A07133476C01E1B000CEC815C5F7B88E4D0D05F6C94210EA34D5FC6ADD2DB987630A0184867C7DE2C1EB4578E591F08847B8C40F8285D46CC251371775F3792896559ABF0C8F168C4DE1D60B4CAAA181F82FEDDC3CFB6CBC4A7DB12BF8798C102A839E9DC51E6F7F978027A3B0A247685A3C0F1DCB12CE0D292037EA78C7B150F3A6FD31829D10EF21224F10BEB9A73DE72B3B87E28E4778EED0DA4C193105D436C4E6FD4AC1608D01CBD3E7E1D78E96B9D8DC3C37F12B72055F88DA9BEAE226BA601DECFE20D5D9722FE534B845745FBFA0B2AE467F9A425A6FCE0A4E58B9AA516ABCC68B78C64E634CDEA35321C37999D474DB0B3802575A086569199E1427B7D9F2D6D4624C4883AC6C7F37F83712E23DF8D567F756DC002A5994E6657E634FCD0FB329ADB28954E5CDEBC88BA81019A23CA92B49D1392DA16BD9817F27478703F165FD8D1D077B8C44C925AD3A11952EA5CC20F94B2CC64DB65B11ECDA5118695F8DFDE1F4CAB2D44D0E570789D4A1FAE65CEBD4573CA4D55A5CE99CE35D3E2FD5CC6074A2D74665697DD1ABD89C24F0392F079EFB4AA8AB93BEC6CE8A7C1A94D41525189F9CDC8629777A8FC5E2A809ACA801F5695ABCFCA42CBAF4E7786346749CB8937AB5F476C7F2043C8DF991600FAB01CDA7CC4C3BAA38A756B415B6592A47E410827666334CEF01F69F6815249E0EEA4CDFD7C7A3E09CB4C0D31696A80D52787BE0B647CC7169122655B03F72BAA30034F81262DA9E2F531BDEFB5756C3218F
tmp_aes_key = 3EA165C07C78DAE58DC98DCEEB5C450C0486C84A89912B7C61FC3DE69B22C462
tmp_aes_iv = 26C2647D816DD787E49CD1779D8972657E8C20954468B1B623AF61492E2D4644</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 7735F1F3FCCAA9D818D6EA08ED253E7FB917F099BA0D89B5FE7EE38C9FB2A0E15D1ABB74C2E133D2B11B0686D343E5FBBCDC58F88E1E3AE803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010046E70BFCC5BAE4B1679086DC059F413F9DD08E5CF0FA1A4983B4348D73304421E92F886B56DD9F94039383507A4F09B313647F2D425C07C3A2E27A5F48D06F26FC447A23613BB4E3D9727A7A708DA10AB432A3B840BAEBAECDA42C1E37EF15C6DB83144175D2683AF991642C0BE636C4F2E9E442FEA9C2CF5A73FAB7D0BDB15542AD7526A7380ED146B9BE36D37CA71EEE89CF3CEAF190BF2C60ED42670A8C2F330E8A2EDB3F6A066BF01C2C5C3C17AC294616E80C5DEC7DD7F5A615C01EFF233ABEFAC6D3D2DC04DB2BF72E36C2BF844C85BC74C5BDFB0F5841DC65F83AD060DF3A6941D80B05019D79FC73D761D342B172ABBD0283F56F1097B565A8AB7AD610099E66DCA7B3C9DC376E81
answer = BA0D89B5FE7EE38C9FB2A0E15D1ABB74C2E133D2B11B0686D343E5FBBCDC58F88E1E3AE803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010046E70BFCC5BAE4B1679086DC059F413F9DD08E5CF0FA1A4983B4348D73304421E92F886B56DD9F94039383507A4F09B313647F2D425C07C3A2E27A5F48D06F26FC447A23613BB4E3D9727A7A708DA10AB432A3B840BAEBAECDA42C1E37EF15C6DB83144175D2683AF991642C0BE636C4F2E9E442FEA9C2CF5A73FAB7D0BDB15542AD7526A7380ED146B9BE36D37CA71EEE89CF3CEAF190BF2C60ED42670A8C2F330E8A2EDB3F6A066BF01C2C5C3C17AC294616E80C5DEC7DD7F5A615C01EFF233ABEFAC6D3D2DC04DB2BF72E36C2BF844C85BC74C5BDFB0F5841DC65F83AD060DF3A6941D80B05019D79FC73D761D342B172ABBD0283F56F1097B565A8AB7AD610099E66DCA7B3C9DC376E81</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 FE 7E E3 8C 9F B2 A0 E1 5D 1A BB 74
0010 | C2 E1 33 D2 B1 1B 06 86 D3 43 E5 FB BC DC 58 F8
0020 | 8E 1E 3A E8 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 46 E7 0B FC C5 BA E4 B1 67 90 86 DC 05 9F 41 3F
0140 | 9D D0 8E 5C F0 FA 1A 49 83 B4 34 8D 73 30 44 21
0150 | E9 2F 88 6B 56 DD 9F 94 03 93 83 50 7A 4F 09 B3
0160 | 13 64 7F 2D 42 5C 07 C3 A2 E2 7A 5F 48 D0 6F 26
0170 | FC 44 7A 23 61 3B B4 E3 D9 72 7A 7A 70 8D A1 0A
0180 | B4 32 A3 B8 40 BA EB AE CD A4 2C 1E 37 EF 15 C6
0190 | DB 83 14 41 75 D2 68 3A F9 91 64 2C 0B E6 36 C4
01A0 | F2 E9 E4 42 FE A9 C2 CF 5A 73 FA B7 D0 BD B1 55
01B0 | 42 AD 75 26 A7 38 0E D1 46 B9 BE 36 D3 7C A7 1E
01C0 | EE 89 CF 3C EA F1 90 BF 2C 60 ED 42 67 0A 8C 2F
01D0 | 33 0E 8A 2E DB 3F 6A 06 6B F0 1C 2C 5C 3C 17 AC
01E0 | 29 46 16 E8 0C 5D EC 7D D7 F5 A6 15 C0 1E FF 23
01F0 | 3A BE FA C6 D3 D2 DC 04 DB 2B F7 2E 36 C2 BF 84
0200 | 4C 85 BC 74 C5 BD FB 0F 58 41 DC 65 F8 3A D0 60
0210 | DF 3A 69 41 D8 0B 05 01 9D 79 FC 73 D7 61 D3 42
0220 | B1 72 AB BD 02 83 F5 6F 10 97 B5 65 A8 AB 7A D6
0230 | 10 09 9E 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010046E70BFCC5BAE4B1679086DC</code> <code>059F413F9DD08E5CF0FA1A4983B4348D</code> <code>73304421E92F886B56DD9F9403938350</code> <code>7A4F09B313647F2D425C07C3A2E27A5F</code> <code>48D06F26FC447A23613BB4E3D9727A7A</code> <code>708DA10AB432A3B840BAEBAECDA42C1E</code> <code>37EF15C6DB83144175D2683AF991642C</code> <code>0BE636C4F2E9E442FEA9C2CF5A73FAB7</code> <code>D0BDB15542AD7526A7380ED146B9BE36</code> <code>D37CA71EEE89CF3CEAF190BF2C60ED42</code> <code>670A8C2F330E8A2EDB3F6A066BF01C2C</code> <code>5C3C17AC294616E80C5DEC7DD7F5A615</code> <code>C01EFF233ABEFAC6D3D2DC04DB2BF72E</code> <code>36C2BF844C85BC74C5BDFB0F5841DC65</code> <code>F83AD060DF3A6941D80B05019D79FC73</code> <code>D761D342B172ABBD0283F56F1097B565</code><br> <code>A8AB7AD6</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>10099E66</code> (1721633040 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = F88FE91EE7603AD761249BA53321D1F06CA7165D5B1356B848B8455C10F77523B3612E2030E82483C2C3AD1749751F67CF8CE5C4CF31CECB085B378660B4F3B495EB8130451A7E0F502643542AD5CF81A142A88E6AD4DA0553FAB0E92C88DDB8FF8D857CA1085C097502CF5B302C0BF972025FC3AA16BD727AA1960D99EEBC34CE36D915BA9CEFF39C979FF5DE214C9AC2DBA788B68796B406CBDCD34F15F0CA7A8D5C3BA480F818AC9D443AA0CBE1012E2CAA99369861ADFB2B117D01B091EBE08EBABAF704EECD97FBC4B64FC0A371D6A821148E8C6E62E34ADC5FDFF9998D32A0914F29635EE83E639273368EA59CC90140A52D55324B4DD092715CF23438</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 570CD13FAE7E98F38DC9F976653674A6B9D88176BFB9DDA0A044A7B6D297640AA7EC2338DA3C7934FA7615BC92E9B11F691B753327B06D245398D59C0581BEDE54D1164CE22C20626380C3BE23A9E117A347A81C6D60DFD86FEFD3FC9DF00F15D62F15A6809B6A616411A8AC950C2470ABF61FE7D5812209003D821DFD8FB75E2D90491EFD374511366C5ADF51EFB9E95148C8D0027B9D803B3471B6D9D53E7CEC3502C5D2896BB4D255C96DF2215F296E131E1EEC7EC4A12431ED6DB95097FE36BFA720CD9340866C437A312A5E8FE2BE14B7FDDB37F5891887BB054FCBC59774E805DEDA23F0DC8D17C763626922369F3646021A9A85123EB40DAE5B912465</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 FE 7E E3 8C 9F B2 A0 E1 5D 1A BB 74
0010 | C2 E1 33 D2 B1 1B 06 86 D3 43 E5 FB BC DC 58 F8
0020 | 8E 1E 3A E8 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 57 0C D1 3F AE 7E 98 F3 8D C9 F9 76 65 36 74 A6
0040 | B9 D8 81 76 BF B9 DD A0 A0 44 A7 B6 D2 97 64 0A
0050 | A7 EC 23 38 DA 3C 79 34 FA 76 15 BC 92 E9 B1 1F
0060 | 69 1B 75 33 27 B0 6D 24 53 98 D5 9C 05 81 BE DE
0070 | 54 D1 16 4C E2 2C 20 62 63 80 C3 BE 23 A9 E1 17
0080 | A3 47 A8 1C 6D 60 DF D8 6F EF D3 FC 9D F0 0F 15
0090 | D6 2F 15 A6 80 9B 6A 61 64 11 A8 AC 95 0C 24 70
00A0 | AB F6 1F E7 D5 81 22 09 00 3D 82 1D FD 8F B7 5E
00B0 | 2D 90 49 1E FD 37 45 11 36 6C 5A DF 51 EF B9 E9
00C0 | 51 48 C8 D0 02 7B 9D 80 3B 34 71 B6 D9 D5 3E 7C
00D0 | EC 35 02 C5 D2 89 6B B4 D2 55 C9 6D F2 21 5F 29
00E0 | 6E 13 1E 1E EC 7E C4 A1 24 31 ED 6D B9 50 97 FE
00F0 | 36 BF A7 20 CD 93 40 86 6C 43 7A 31 2A 5E 8F E2
0100 | BE 14 B7 FD DB 37 F5 89 18 87 BB 05 4F CB C5 97
0110 | 74 E8 05 DE DA 23 F0 DC 8D 17 C7 63 62 69 22 36
0120 | 9F 36 46 02 1A 9A 85 12 3E B4 0D AE 5B 91 24 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100570CD13FAE7E98F38DC9F976</code> <code>653674A6B9D88176BFB9DDA0A044A7B6</code> <code>D297640AA7EC2338DA3C7934FA7615BC</code> <code>92E9B11F691B753327B06D245398D59C</code> <code>0581BEDE54D1164CE22C20626380C3BE</code> <code>23A9E117A347A81C6D60DFD86FEFD3FC</code> <code>9DF00F15D62F15A6809B6A616411A8AC</code> <code>950C2470ABF61FE7D5812209003D821D</code> <code>FD8FB75E2D90491EFD374511366C5ADF</code> <code>51EFB9E95148C8D0027B9D803B3471B6</code> <code>D9D53E7CEC3502C5D2896BB4D255C96D</code> <code>F2215F296E131E1EEC7EC4A12431ED6D</code> <code>B95097FE36BFA720CD9340866C437A31</code> <code>2A5E8FE2BE14B7FDDB37F5891887BB05</code> <code>4FCBC59774E805DEDA23F0DC8D17C763</code> <code>626922369F3646021A9A85123EB40DAE</code><br> <code>5B912465</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366FE7EE38C9FB2A0E15D1ABB74C2E133D2B11B0686D343E5FBBCDC58F88E1E3AE80000000000000000FE000100570CD13FAE7E98F38DC9F976653674A6B9D88176BFB9DDA0A044A7B6D297640AA7EC2338DA3C7934FA7615BC92E9B11F691B753327B06D245398D59C0581BEDE54D1164CE22C20626380C3BE23A9E117A347A81C6D60DFD86FEFD3FC9DF00F15D62F15A6809B6A616411A8AC950C2470ABF61FE7D5812209003D821DFD8FB75E2D90491EFD374511366C5ADF51EFB9E95148C8D0027B9D803B3471B6D9D53E7CEC3502C5D2896BB4D255C96DF2215F296E131E1EEC7EC4A12431ED6DB95097FE36BFA720CD9340866C437A312A5E8FE2BE14B7FDDB37F5891887BB054FCBC59774E805DEDA23F0DC8D17C763626922369F3646021A9A85123EB40DAE5B912465
padding = 93A82B4F98CCB78C36ECC67C
tmp_aes_key = 3EA165C07C78DAE58DC98DCEEB5C450C0486C84A89912B7C61FC3DE69B22C462
tmp_aes_iv = 26C2647D816DD787E49CD1779D8972657E8C20954468B1B623AF61492E2D4644</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 0FADE83C081F2D935766DBFA33666AEF249C17339F5AE8BC952D2FD58765672E2DAE53C6885DF337B19B023CEB3BA974905EE6293D85E5061DB24DF7F8DB5A2FE7EF5CD8459AFA74C2CE1D53348073EF99F5FBCD08E3E963FB037D18832C34A0AFBE5C90E420CED585D883DD3538C93C11CB8110560964FE12C51696DDBCBD18A469FBA72B42D57CFA54F6E50D6EC476AF328E70A6213C49A9566A946845E6627EB360EBA89F1AF20E4704792A033DC09C5DDC94070B04D031BE8149A4B720AFC13868DF13144FA299882422DA45EF6B0AC7B09338CFDD4B656D27CBD20AE301D4D160233EB69A9AD6A19F2854C3E5BE0D4AC635FA1CD15540440E9B8A3CBD8E8B3A602057197E78038E988BB0671694E778F531750A5A5DE5BEF31AAB97CAD542048E2C940A1F146F1B6BF030500B6AB67A87B89F57B207A2F6B0053C6ADD8E0AD1728E5DC80280AEFACD9FC7323F2B</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 40 0F 05 00 11 09 9E 66
0010 | 78 01 00 00 1F 5F 04 F5 FE 7E E3 8C 9F B2 A0 E1
0020 | 5D 1A BB 74 C2 E1 33 D2 B1 1B 06 86 D3 43 E5 FB
0030 | BC DC 58 F8 8E 1E 3A E8 FE 50 01 00 0F AD E8 3C
0040 | 08 1F 2D 93 57 66 DB FA 33 66 6A EF 24 9C 17 33
0050 | 9F 5A E8 BC 95 2D 2F D5 87 65 67 2E 2D AE 53 C6
0060 | 88 5D F3 37 B1 9B 02 3C EB 3B A9 74 90 5E E6 29
0070 | 3D 85 E5 06 1D B2 4D F7 F8 DB 5A 2F E7 EF 5C D8
0080 | 45 9A FA 74 C2 CE 1D 53 34 80 73 EF 99 F5 FB CD
0090 | 08 E3 E9 63 FB 03 7D 18 83 2C 34 A0 AF BE 5C 90
00A0 | E4 20 CE D5 85 D8 83 DD 35 38 C9 3C 11 CB 81 10
00B0 | 56 09 64 FE 12 C5 16 96 DD BC BD 18 A4 69 FB A7
00C0 | 2B 42 D5 7C FA 54 F6 E5 0D 6E C4 76 AF 32 8E 70
00D0 | A6 21 3C 49 A9 56 6A 94 68 45 E6 62 7E B3 60 EB
00E0 | A8 9F 1A F2 0E 47 04 79 2A 03 3D C0 9C 5D DC 94
00F0 | 07 0B 04 D0 31 BE 81 49 A4 B7 20 AF C1 38 68 DF
0100 | 13 14 4F A2 99 88 24 22 DA 45 EF 6B 0A C7 B0 93
0110 | 38 CF DD 4B 65 6D 27 CB D2 0A E3 01 D4 D1 60 23
0120 | 3E B6 9A 9A D6 A1 9F 28 54 C3 E5 BE 0D 4A C6 35
0130 | FA 1C D1 55 40 44 0E 9B 8A 3C BD 8E 8B 3A 60 20
0140 | 57 19 7E 78 03 8E 98 8B B0 67 16 94 E7 78 F5 31
0150 | 75 0A 5A 5D E5 BE F3 1A AB 97 CA D5 42 04 8E 2C
0160 | 94 0A 1F 14 6F 1B 6B F0 30 50 0B 6A B6 7A 87 B8
0170 | 9F 57 B2 07 A2 F6 B0 05 3C 6A DD 8E 0A D1 72 8E
0180 | 5D C8 02 80 AE FA CD 9F C7 32 3F 2B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>400F050011099E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001000FADE83C081F2D935766DBFA</code> <code>33666AEF249C17339F5AE8BC952D2FD5</code> <code>8765672E2DAE53C6885DF337B19B023C</code> <code>EB3BA974905EE6293D85E5061DB24DF7</code> <code>F8DB5A2FE7EF5CD8459AFA74C2CE1D53</code> <code>348073EF99F5FBCD08E3E963FB037D18</code> <code>832C34A0AFBE5C90E420CED585D883DD</code> <code>3538C93C11CB8110560964FE12C51696</code> <code>DDBCBD18A469FBA72B42D57CFA54F6E5</code> <code>0D6EC476AF328E70A6213C49A9566A94</code> <code>6845E6627EB360EBA89F1AF20E470479</code> <code>2A033DC09C5DDC94070B04D031BE8149</code> <code>A4B720AFC13868DF13144FA299882422</code> <code>DA45EF6B0AC7B09338CFDD4B656D27CB</code> <code>D20AE301D4D160233EB69A9AD6A19F28</code> <code>54C3E5BE0D4AC635FA1CD15540440E9B</code> <code>8A3CBD8E8B3A602057197E78038E988B</code> <code>B0671694E778F531750A5A5DE5BEF31A</code> <code>AB97CAD542048E2C940A1F146F1B6BF0</code> <code>30500B6AB67A87B89F57B207A2F6B005</code> <code>3C6ADD8E0AD1728E5DC80280AEFACD9F</code><br> <code>C7323F2B</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 47021B73ADFFD25A3A726B4A56A8A17908D109EC0FB09A3D953460A20A9B53D6B0C3372C293DCCA0C1BBB73A3A7B00262AC3C662269CC10B85142B32A73CF9D35130A28D9839AF7A5FE159CB569F8EB41D8D101AD98A704086F5CF389DC351ED1A12A1D339F0E65955B085FE20444CDD41F9304EC13869AAA53313124079DFD5FBC72C0CF410982D8717B85D7A3709B4754F9D93BFCD125AF08331AE3980E46E0DC181BB65C533FFE79D80B2FA33406549BED2EEF887ABF034D6606271B7C508DE6E72F9F800A326FCC44192476FC6F8ACE5BC27D7B0D3FBEC3D3BF7E606B688246AD3490CB19376416DEC17DC6FEEAF732266229F6E098FF35921652F87C31C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 B9 9E 11 09 9E 66
0010 | 88 00 00 00 34 F7 CB 3B FE 7E E3 8C 9F B2 A0 E1
0020 | 5D 1A BB 74 C2 E1 33 D2 B1 1B 06 86 D3 43 E5 FB
0030 | BC DC 58 F8 8E 1E 3A E8 40 89 8F 25 3A 28 2A 6C
0040 | 52 F2 6E 65 CB CA 59 DC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130B99E11099E66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>88000000</code> (136 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>FE7EE38C9FB2A0E15D1ABB74C2E133D2</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>B11B0686D343E5FBBCDC58F88E1E3AE8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>40898F253A282A6C52F26E65CBCA59DC</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

