<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 58 18 0E 00 B4 A5 BA 68
0010 | 14 00 00 00 F1 8E 7E BE E1 E3 51 1A C4 F8 27 B1
0020 | B6 1A E8 64 57 86 36 1F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>58180E00B4A5BA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 62 97 B4 A5 BA 68
0010 | 50 00 00 00 63 24 16 05 E1 E3 51 1A C4 F8 27 B1
0020 | B6 1A E8 64 57 86 36 1F D7 E4 0A 7D B2 23 B6 98
0030 | 18 8F 5C 1D 17 2B 64 3D 08 1B EC 05 EE A3 77 A7
0040 | 93 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E86297B4A5BA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081BEC05EEA377A793000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2011989656030652307</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2011989656030652307</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2011989656030652307 = 1254552127 * 1603751341</code></p>
<pre><code>p = 1254552127
q = 1603751341</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1B EC 05 EE A3 77 A7 93 00 00 00
0010 | 04 4A C6 F2 3F 00 00 00 04 5F 97 4D AD 00 00 00
0020 | E1 E3 51 1A C4 F8 27 B1 B6 1A E8 64 57 86 36 1F
0030 | D7 E4 0A 7D B2 23 B6 98 18 8F 5C 1D 17 2B 64 3D
0040 | 81 A0 0C 91 F7 A9 03 22 9E 07 8C 13 A9 67 95 C3
0050 | 5B E9 E7 B0 1C A4 89 9A A7 AE AE D5 78 A5 FD 77
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081BEC05EEA377A793000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2011989656030652307</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044AC6F23F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1254552127</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045F974DAD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1603751341</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>81A00C91F7A903229E078C13A96795C3</code> <code>5BE9E7B01CA4899AA7AEAED578A5FD77</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081BEC05EEA377A793000000044AC6F23F000000045F974DAD000000E1E3511AC4F827B1B61AE8645786361FD7E40A7DB223B698188F5C1D172B643D81A00C91F7A903229E078C13A96795C35BE9E7B01CA4899AA7AEAED578A5FD7702000000
random_padding_bytes = 437E865F1EF4D1F643030077D13B3F3F4F1B032D30F3FC91C1135C0389F80215C661F61CC95DB960679EF5245404A74C216C025E8F1E8621A31777DA0EE9AE7AF6E1E1C0E2F326EBC496D63502287D6240FE8CCFB8CA8E03711B2E7B</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 9B51490B19FAC54BCE407C061DA251F40F8D9EBCF5CF55594C5A341BDF0521FACF3EF806169B23AB771AF432C83C91640188F82E42ABDF66D29488E2ABC291AB6D95E1B0B1A032AC3B9DD5C5043350E80D261AE217C08306DABB441BE89C4A94132247445E15B6DC45D15D008FE2EC5D8A00555BDE78E3802BF29D9B6970F30DD317B2C23045CF41E7C97A8839BEBD62D42F61E2D8F20CCE9A1581F0E50FB0F404FC898826C145E192DD898A9356971015A272AB3DF7980281410B4025AC97411436BB29B6A813060C87600878C80188570C947DF48A23C118B245E09D3BDCBB4166E7F716B1A03FF0E44EE9DC416E8E733BA18A36AB747B525D0358F90E6BDF</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 5C 18 0E 00 B4 A5 BA 68
0010 | 40 01 00 00 BE E4 12 D7 E1 E3 51 1A C4 F8 27 B1
0020 | B6 1A E8 64 57 86 36 1F D7 E4 0A 7D B2 23 B6 98
0030 | 18 8F 5C 1D 17 2B 64 3D 04 4A C6 F2 3F 00 00 00
0040 | 04 5F 97 4D AD 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 9B 51 49 0B 19 FA C5 4B CE 40 7C 06
0060 | 1D A2 51 F4 0F 8D 9E BC F5 CF 55 59 4C 5A 34 1B
0070 | DF 05 21 FA CF 3E F8 06 16 9B 23 AB 77 1A F4 32
0080 | C8 3C 91 64 01 88 F8 2E 42 AB DF 66 D2 94 88 E2
0090 | AB C2 91 AB 6D 95 E1 B0 B1 A0 32 AC 3B 9D D5 C5
00A0 | 04 33 50 E8 0D 26 1A E2 17 C0 83 06 DA BB 44 1B
00B0 | E8 9C 4A 94 13 22 47 44 5E 15 B6 DC 45 D1 5D 00
00C0 | 8F E2 EC 5D 8A 00 55 5B DE 78 E3 80 2B F2 9D 9B
00D0 | 69 70 F3 0D D3 17 B2 C2 30 45 CF 41 E7 C9 7A 88
00E0 | 39 BE BD 62 D4 2F 61 E2 D8 F2 0C CE 9A 15 81 F0
00F0 | E5 0F B0 F4 04 FC 89 88 26 C1 45 E1 92 DD 89 8A
0100 | 93 56 97 10 15 A2 72 AB 3D F7 98 02 81 41 0B 40
0110 | 25 AC 97 41 14 36 BB 29 B6 A8 13 06 0C 87 60 08
0120 | 78 C8 01 88 57 0C 94 7D F4 8A 23 C1 18 B2 45 E0
0130 | 9D 3B DC BB 41 66 E7 F7 16 B1 A0 3F F0 E4 4E E9
0140 | DC 41 6E 8E 73 3B A1 8A 36 AB 74 7B 52 5D 03 58
0150 | F9 0E 6B DF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>5C180E00B4A5BA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044AC6F23F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1254552127</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045F974DAD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1603751341</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001009B51490B19FAC54BCE407C06</code> <code>1DA251F40F8D9EBCF5CF55594C5A341B</code> <code>DF0521FACF3EF806169B23AB771AF432</code> <code>C83C91640188F82E42ABDF66D29488E2</code> <code>ABC291AB6D95E1B0B1A032AC3B9DD5C5</code> <code>043350E80D261AE217C08306DABB441B</code> <code>E89C4A94132247445E15B6DC45D15D00</code> <code>8FE2EC5D8A00555BDE78E3802BF29D9B</code> <code>6970F30DD317B2C23045CF41E7C97A88</code> <code>39BEBD62D42F61E2D8F20CCE9A1581F0</code> <code>E50FB0F404FC898826C145E192DD898A</code> <code>9356971015A272AB3DF7980281410B40</code> <code>25AC97411436BB29B6A813060C876008</code> <code>78C80188570C947DF48A23C118B245E0</code> <code>9D3BDCBB4166E7F716B1A03FF0E44EE9</code> <code>DC416E8E733BA18A36AB747B525D0358</code><br> <code>F90E6BDF</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 B5 BD B4 A5 BA 68
0010 | 78 02 00 00 5C 07 E8 D0 E1 E3 51 1A C4 F8 27 B1
0020 | B6 1A E8 64 57 86 36 1F D7 E4 0A 7D B2 23 B6 98
0030 | 18 8F 5C 1D 17 2B 64 3D FE 50 02 00 9C 28 05 64
0040 | 3C 1C 26 4F 6C A9 0D 5D 6F 0A 7E 6B DE B9 CC 60
0050 | 9C BD C4 91 4C D0 7F 68 F6 D9 BB 23 B7 89 F6 D3
0060 | 40 14 67 07 41 A3 EF 79 28 3C 3C B8 15 DE F8 E6
0070 | 0C A7 BB C3 AE 90 59 CA 90 FE 01 EE 7C 86 28 E6
0080 | 24 AF C3 AE 51 5E E1 6F 3C A8 34 DD 4F A4 C7 C9
0090 | A9 A6 C0 9E DB 13 9C C0 52 59 2B 1A BB 9A 16 E0
00A0 | D3 C7 19 4D 74 37 EF 58 DB E1 A9 D7 57 ED 8D 1E
00B0 | 5A 53 96 33 EE 28 C9 CD 72 B8 91 A7 AD 5B A6 41
00C0 | 4D 1B D5 C6 C2 A5 87 C2 03 D7 42 DD CD 00 FF 76
00D0 | 10 E9 90 61 5E FA 0E 03 9A 45 1B 00 D0 13 75 38
00E0 | 7C 88 04 7E F8 D9 F2 05 74 46 87 51 07 6E 5E 61
00F0 | 94 17 0A 6D 50 46 CA 8C F7 56 BA 8B 80 68 15 CF
0100 | 82 1B 2F 9B B1 D2 1A F8 17 C6 3B C9 B8 8C D2 E4
0110 | BA 49 54 35 73 D2 5D 19 17 FF 2D EE 6D D5 C0 91
0120 | 81 76 E3 35 EF 7F 3B 49 08 41 2C 5C 32 D5 52 33
0130 | 1A 9A 1B B2 19 EB E3 1C E9 E3 E5 C0 75 69 39 75
0140 | A7 DF 91 F9 62 27 9C F4 D0 D7 5C 8F 65 95 F0 30
0150 | 08 5B 65 71 B7 DC 68 5E 47 FE DD C5 DA 09 2F 02
0160 | 69 63 C3 DA 0C CE 86 3F 39 CB D4 28 B0 A3 DB BB
0170 | D1 54 37 AA 65 A1 FB C3 B4 2C 4F 05 2D 7F A5 57
0180 | 23 6E 81 18 21 94 DE 41 DB BC 97 D3 1B CD D1 C9
0190 | 4D E1 1F 87 C5 95 15 68 5C D9 74 82 3A 7A 2C 31
01A0 | AA 61 A6 D7 BC E6 CD 5F D5 AB C4 91 39 B8 87 45
01B0 | 7B AE E3 8A F6 2F B2 4F D5 F5 5C 09 04 6A D3 9B
01C0 | C1 FC 21 6F 73 54 F8 BB 27 39 02 BD 61 D7 13 22
01D0 | 7B 9A 96 6D 62 E7 36 4B 5C FB 70 11 95 84 6C AD
01E0 | D1 EB EE 10 BA 40 A4 A2 C5 63 EA B1 DD E9 C4 E1
01F0 | 0B 43 57 B4 C1 1E E1 D3 4F 1C 3F 38 D1 79 65 58
0200 | EA 96 E9 08 95 C8 71 50 9A E0 57 BA 0B C0 A6 DE
0210 | DC BD 9E 5A 90 A6 6C 18 B8 23 F5 C4 C2 6A EB 00
0220 | CC 0F 41 52 A5 6F 4D 21 B1 56 D7 92 01 9F 1D AD
0230 | 01 84 99 3E 45 75 86 E7 E7 A4 EC 6B FC B4 C9 7F
0240 | 43 D7 88 BA A0 70 87 E8 15 56 4F A5 3E AC AB AF
0250 | AD B9 19 20 10 F9 14 53 C4 05 D5 EA 4A 1A E9 D8
0260 | 87 03 DA E6 54 6C 08 BA 69 45 FA DB 22 68 FE 85
0270 | 11 A5 0C 99 72 B0 2A C0 2F 98 1B E5 FC BE 6D 4C
0280 | C8 9A 71 8E 4F 26 BA 98 92 41 6A 4F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0158B5BDB4A5BA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002009C2805643C1C264F6CA90D5D</code> <code>6F0A7E6BDEB9CC609CBDC4914CD07F68</code> <code>F6D9BB23B789F6D34014670741A3EF79</code> <code>283C3CB815DEF8E60CA7BBC3AE9059CA</code> <code>90FE01EE7C8628E624AFC3AE515EE16F</code> <code>3CA834DD4FA4C7C9A9A6C09EDB139CC0</code> <code>52592B1ABB9A16E0D3C7194D7437EF58</code> <code>DBE1A9D757ED8D1E5A539633EE28C9CD</code> <code>72B891A7AD5BA6414D1BD5C6C2A587C2</code> <code>03D742DDCD00FF7610E990615EFA0E03</code> <code>9A451B00D01375387C88047EF8D9F205</code> <code>74468751076E5E6194170A6D5046CA8C</code> <code>F756BA8B806815CF821B2F9BB1D21AF8</code> <code>17C63BC9B88CD2E4BA49543573D25D19</code> <code>17FF2DEE6DD5C0918176E335EF7F3B49</code> <code>08412C5C32D552331A9A1BB219EBE31C</code> <code>E9E3E5C075693975A7DF91F962279CF4</code> <code>D0D75C8F6595F030085B6571B7DC685E</code> <code>47FEDDC5DA092F026963C3DA0CCE863F</code> <code>39CBD428B0A3DBBBD15437AA65A1FBC3</code> <code>B42C4F052D7FA557236E81182194DE41</code> <code>DBBC97D31BCDD1C94DE11F87C5951568</code> <code>5CD974823A7A2C31AA61A6D7BCE6CD5F</code> <code>D5ABC49139B887457BAEE38AF62FB24F</code> <code>D5F55C09046AD39BC1FC216F7354F8BB</code> <code>273902BD61D713227B9A966D62E7364B</code> <code>5CFB701195846CADD1EBEE10BA40A4A2</code> <code>C563EAB1DDE9C4E10B4357B4C11EE1D3</code> <code>4F1C3F38D1796558EA96E90895C87150</code> <code>9AE057BA0BC0A6DEDCBD9E5A90A66C18</code> <code>B823F5C4C26AEB00CC0F4152A56F4D21</code> <code>B156D792019F1DAD0184993E457586E7</code> <code>E7A4EC6BFCB4C97F43D788BAA07087E8</code> <code>15564FA53EACABAFADB9192010F91453</code> <code>C405D5EA4A1AE9D88703DAE6546C08BA</code> <code>6945FADB2268FE8511A50C9972B02AC0</code> <code>2F981BE5FCBE6D4CC89A718E4F26BA98</code><br> <code>92416A4F</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 9C2805643C1C264F6CA90D5D6F0A7E6BDEB9CC609CBDC4914CD07F68F6D9BB23B789F6D34014670741A3EF79283C3CB815DEF8E60CA7BBC3AE9059CA90FE01EE7C8628E624AFC3AE515EE16F3CA834DD4FA4C7C9A9A6C09EDB139CC052592B1ABB9A16E0D3C7194D7437EF58DBE1A9D757ED8D1E5A539633EE28C9CD72B891A7AD5BA6414D1BD5C6C2A587C203D742DDCD00FF7610E990615EFA0E039A451B00D01375387C88047EF8D9F20574468751076E5E6194170A6D5046CA8CF756BA8B806815CF821B2F9BB1D21AF817C63BC9B88CD2E4BA49543573D25D1917FF2DEE6DD5C0918176E335EF7F3B4908412C5C32D552331A9A1BB219EBE31CE9E3E5C075693975A7DF91F962279CF4D0D75C8F6595F030085B6571B7DC685E47FEDDC5DA092F026963C3DA0CCE863F39CBD428B0A3DBBBD15437AA65A1FBC3B42C4F052D7FA557236E81182194DE41DBBC97D31BCDD1C94DE11F87C59515685CD974823A7A2C31AA61A6D7BCE6CD5FD5ABC49139B887457BAEE38AF62FB24FD5F55C09046AD39BC1FC216F7354F8BB273902BD61D713227B9A966D62E7364B5CFB701195846CADD1EBEE10BA40A4A2C563EAB1DDE9C4E10B4357B4C11EE1D34F1C3F38D1796558EA96E90895C871509AE057BA0BC0A6DEDCBD9E5A90A66C18B823F5C4C26AEB00CC0F4152A56F4D21B156D792019F1DAD0184993E457586E7E7A4EC6BFCB4C97F43D788BAA07087E815564FA53EACABAFADB9192010F91453C405D5EA4A1AE9D88703DAE6546C08BA6945FADB2268FE8511A50C9972B02AC02F981BE5FCBE6D4CC89A718E4F26BA9892416A4F
tmp_aes_key = 597227252398A0782ECD82C6B88D313D8595485952B75B891B2B8BAF56316B71
tmp_aes_iv = 0FBBE79CB98D40B8B88A0039CBBB7D2B48A4B8F4C98EAD5972C3ABBF81A00C91</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = E21F0841FD5FBE30BFB78E16C47859F976DE0982BA0D89B5E1E3511AC4F827B1B61AE8645786361FD7E40A7DB223B698188F5C1D172B643D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007B9CEAF23EB4A70B319C0C1EB5C5E4F23AF4310AE72AAF36E0854B884FD9C69A6E51F1D333A41ED0661267942344C2D136CA46FE14C8AD57B467FE74293C3678258A6574F708EE0863C0E08EA23DE19292154E787BF1BA608EAF744E88F9D3DAE52CF884282760340288150CF9C2AD4ED931D91F96BCA01D99A1481E23983B50300E613E0967CC111F3FFA2910BADB0CBF841B494367523AB512C3ABA298DFBAD4A9D56AA0D1982D93CA510EA0FB2221AB5992B12500B76A314E8062BFB71D2FAF25D269C23733C4F60C61276771F80DB58B9317B553CB0539A7545E0DA20E6549162CD72CEAF4E1AEDCB9F2A1FD16145199FD8B9FB0822C8292C7416A08DDE0B4A5BA687B6F8D1713B81778
answer = BA0D89B5E1E3511AC4F827B1B61AE8645786361FD7E40A7DB223B698188F5C1D172B643D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007B9CEAF23EB4A70B319C0C1EB5C5E4F23AF4310AE72AAF36E0854B884FD9C69A6E51F1D333A41ED0661267942344C2D136CA46FE14C8AD57B467FE74293C3678258A6574F708EE0863C0E08EA23DE19292154E787BF1BA608EAF744E88F9D3DAE52CF884282760340288150CF9C2AD4ED931D91F96BCA01D99A1481E23983B50300E613E0967CC111F3FFA2910BADB0CBF841B494367523AB512C3ABA298DFBAD4A9D56AA0D1982D93CA510EA0FB2221AB5992B12500B76A314E8062BFB71D2FAF25D269C23733C4F60C61276771F80DB58B9317B553CB0539A7545E0DA20E6549162CD72CEAF4E1AEDCB9F2A1FD16145199FD8B9FB0822C8292C7416A08DDE0B4A5BA687B6F8D1713B81778</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E1 E3 51 1A C4 F8 27 B1 B6 1A E8 64
0010 | 57 86 36 1F D7 E4 0A 7D B2 23 B6 98 18 8F 5C 1D
0020 | 17 2B 64 3D 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 7B 9C EA F2 3E B4 A7 0B 31 9C 0C 1E B5 C5 E4 F2
0140 | 3A F4 31 0A E7 2A AF 36 E0 85 4B 88 4F D9 C6 9A
0150 | 6E 51 F1 D3 33 A4 1E D0 66 12 67 94 23 44 C2 D1
0160 | 36 CA 46 FE 14 C8 AD 57 B4 67 FE 74 29 3C 36 78
0170 | 25 8A 65 74 F7 08 EE 08 63 C0 E0 8E A2 3D E1 92
0180 | 92 15 4E 78 7B F1 BA 60 8E AF 74 4E 88 F9 D3 DA
0190 | E5 2C F8 84 28 27 60 34 02 88 15 0C F9 C2 AD 4E
01A0 | D9 31 D9 1F 96 BC A0 1D 99 A1 48 1E 23 98 3B 50
01B0 | 30 0E 61 3E 09 67 CC 11 1F 3F FA 29 10 BA DB 0C
01C0 | BF 84 1B 49 43 67 52 3A B5 12 C3 AB A2 98 DF BA
01D0 | D4 A9 D5 6A A0 D1 98 2D 93 CA 51 0E A0 FB 22 21
01E0 | AB 59 92 B1 25 00 B7 6A 31 4E 80 62 BF B7 1D 2F
01F0 | AF 25 D2 69 C2 37 33 C4 F6 0C 61 27 67 71 F8 0D
0200 | B5 8B 93 17 B5 53 CB 05 39 A7 54 5E 0D A2 0E 65
0210 | 49 16 2C D7 2C EA F4 E1 AE DC B9 F2 A1 FD 16 14
0220 | 51 99 FD 8B 9F B0 82 2C 82 92 C7 41 6A 08 DD E0
0230 | B4 A5 BA 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007B9CEAF23EB4A70B319C0C1E</code> <code>B5C5E4F23AF4310AE72AAF36E0854B88</code> <code>4FD9C69A6E51F1D333A41ED066126794</code> <code>2344C2D136CA46FE14C8AD57B467FE74</code> <code>293C3678258A6574F708EE0863C0E08E</code> <code>A23DE19292154E787BF1BA608EAF744E</code> <code>88F9D3DAE52CF884282760340288150C</code> <code>F9C2AD4ED931D91F96BCA01D99A1481E</code> <code>23983B50300E613E0967CC111F3FFA29</code> <code>10BADB0CBF841B494367523AB512C3AB</code> <code>A298DFBAD4A9D56AA0D1982D93CA510E</code> <code>A0FB2221AB5992B12500B76A314E8062</code> <code>BFB71D2FAF25D269C23733C4F60C6127</code> <code>6771F80DB58B9317B553CB0539A7545E</code> <code>0DA20E6549162CD72CEAF4E1AEDCB9F2</code> <code>A1FD16145199FD8B9FB0822C8292C741</code><br> <code>6A08DDE0</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B4A5BA68</code> (1757062580 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 2AEB4A83DAA290C1B0D1DEE3D1BA272E041C83B2043EB620A907520411EAF84F852CAE21E4DEC980732F564997503F793360E6C9D7105BA8014EA0CF9987491EF7FC3CC04BC2490A598362A88D8D07BE1F442DBE4FD2FD2A56CAA0A9797591BE42D5817A4D0CB675600509ED23784DBA1DC3D97F2993D44AEDC9AA0A6FA22DB3B3A384AC0D985E1B7548F4C16B838821827E8AB604988845B51A3CBF778A6FA044406D08764A8D757D779930BB9A9839C182177B8A7C7DF1C654F5DA0221CFA8C21037EE89A4BC9961890007F7E1AF0A20BBB5E711731DDDF2D198601EA0459ED6BFBB42D97AFEC0C316522D8A6A6AE099BBEE110FEC6A8591E683A4936FCC85</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 555953F8C2B9CE7AE012D3431B96E9C314527BB1A506BCEE1626CA3E2BA2498C45CD0056581DEAD0788FA126A5F0EAB6CEF819E2DEBB938329B1892B7312F255A610DD5D1D39ADE3E34C5CB3F692D5260D9FE753C06E7E4E291D72B9D612D451D4413E80703EEEA0E72D8E56921373F1E5D90DD4306464C6ED6CFEF68B0A49088746A9C9C75DDFFAE3248807426AB33B1CB3159E3D2D203B3718137ACEB3200AE9521E9AE400C2E4CF4DB1E774DA57CD5BBEEC41B7CD4BCD89ABE800148B4FA6F7EE1926E04C096C1CBC7A2E313C59F7187E667D5F7A6F6EA64FBB6C4D72A7E91CBC12B124DCD66EB29CF60227CFB9DBC71740011CB1C34867691DD1AB1C51CC</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E1 E3 51 1A C4 F8 27 B1 B6 1A E8 64
0010 | 57 86 36 1F D7 E4 0A 7D B2 23 B6 98 18 8F 5C 1D
0020 | 17 2B 64 3D 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 55 59 53 F8 C2 B9 CE 7A E0 12 D3 43 1B 96 E9 C3
0040 | 14 52 7B B1 A5 06 BC EE 16 26 CA 3E 2B A2 49 8C
0050 | 45 CD 00 56 58 1D EA D0 78 8F A1 26 A5 F0 EA B6
0060 | CE F8 19 E2 DE BB 93 83 29 B1 89 2B 73 12 F2 55
0070 | A6 10 DD 5D 1D 39 AD E3 E3 4C 5C B3 F6 92 D5 26
0080 | 0D 9F E7 53 C0 6E 7E 4E 29 1D 72 B9 D6 12 D4 51
0090 | D4 41 3E 80 70 3E EE A0 E7 2D 8E 56 92 13 73 F1
00A0 | E5 D9 0D D4 30 64 64 C6 ED 6C FE F6 8B 0A 49 08
00B0 | 87 46 A9 C9 C7 5D DF FA E3 24 88 07 42 6A B3 3B
00C0 | 1C B3 15 9E 3D 2D 20 3B 37 18 13 7A CE B3 20 0A
00D0 | E9 52 1E 9A E4 00 C2 E4 CF 4D B1 E7 74 DA 57 CD
00E0 | 5B BE EC 41 B7 CD 4B CD 89 AB E8 00 14 8B 4F A6
00F0 | F7 EE 19 26 E0 4C 09 6C 1C BC 7A 2E 31 3C 59 F7
0100 | 18 7E 66 7D 5F 7A 6F 6E A6 4F BB 6C 4D 72 A7 E9
0110 | 1C BC 12 B1 24 DC D6 6E B2 9C F6 02 27 CF B9 DB
0120 | C7 17 40 01 1C B1 C3 48 67 69 1D D1 AB 1C 51 CC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100555953F8C2B9CE7AE012D343</code> <code>1B96E9C314527BB1A506BCEE1626CA3E</code> <code>2BA2498C45CD0056581DEAD0788FA126</code> <code>A5F0EAB6CEF819E2DEBB938329B1892B</code> <code>7312F255A610DD5D1D39ADE3E34C5CB3</code> <code>F692D5260D9FE753C06E7E4E291D72B9</code> <code>D612D451D4413E80703EEEA0E72D8E56</code> <code>921373F1E5D90DD4306464C6ED6CFEF6</code> <code>8B0A49088746A9C9C75DDFFAE3248807</code> <code>426AB33B1CB3159E3D2D203B3718137A</code> <code>CEB3200AE9521E9AE400C2E4CF4DB1E7</code> <code>74DA57CD5BBEEC41B7CD4BCD89ABE800</code> <code>148B4FA6F7EE1926E04C096C1CBC7A2E</code> <code>313C59F7187E667D5F7A6F6EA64FBB6C</code> <code>4D72A7E91CBC12B124DCD66EB29CF602</code> <code>27CFB9DBC71740011CB1C34867691DD1</code><br> <code>AB1C51CC</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E1E3511AC4F827B1B61AE8645786361FD7E40A7DB223B698188F5C1D172B643D0000000000000000FE000100555953F8C2B9CE7AE012D3431B96E9C314527BB1A506BCEE1626CA3E2BA2498C45CD0056581DEAD0788FA126A5F0EAB6CEF819E2DEBB938329B1892B7312F255A610DD5D1D39ADE3E34C5CB3F692D5260D9FE753C06E7E4E291D72B9D612D451D4413E80703EEEA0E72D8E56921373F1E5D90DD4306464C6ED6CFEF68B0A49088746A9C9C75DDFFAE3248807426AB33B1CB3159E3D2D203B3718137ACEB3200AE9521E9AE400C2E4CF4DB1E774DA57CD5BBEEC41B7CD4BCD89ABE800148B4FA6F7EE1926E04C096C1CBC7A2E313C59F7187E667D5F7A6F6EA64FBB6C4D72A7E91CBC12B124DCD66EB29CF60227CFB9DBC71740011CB1C34867691DD1AB1C51CC
padding = B4721123584D9A1DBEEDA2BB
tmp_aes_key = 597227252398A0782ECD82C6B88D313D8595485952B75B891B2B8BAF56316B71
tmp_aes_iv = 0FBBE79CB98D40B8B88A0039CBBB7D2B48A4B8F4C98EAD5972C3ABBF81A00C91</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 55397F0F73753444918C8ED817E7C806CCE94DB1099AD09058327E3553CDF5607A99816D862EAD719BD166B9FE497B46B6E697734E1E521BA3C1CA987B9CCACE83937622CFDF7B4D05956F35AB62BAAD54B1331449C553469A2ED0FF5E257DB605E282D16508CA6AACD6831D731F6D65FD6D0B9515C062D0A1C360B02B6B6623E062C84EF88110F5E43965D5D14E55DD5D2223B31A5D20F61A5917E1F8441D5D790ECFA51D3D4E2C1259D357E8D2529A1B1D7688A628FCEECF29D7FFF141DA1416455157F20EAB8ADE18AB4C5605D770D3277C97E5E0382554229CE83CA56DABA4EA4561B4E1B91B3813539CA12A887DF711AF32B1E427CF6B417DC86FF9235BDCF2263F5F013227CA5130B6AD645FF4FF4EF90FF5CD2FEAE7984E260EB46811C3DD947DCCDBCA1DE1429A7F1C0EE9D0AF593B98C4E5266E2E2A2008052E333A13C0F44E3CB91A4C2B9DA691774AAC24</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 DC EE 0E 00 B4 A5 BA 68
0010 | 78 01 00 00 1F 5F 04 F5 E1 E3 51 1A C4 F8 27 B1
0020 | B6 1A E8 64 57 86 36 1F D7 E4 0A 7D B2 23 B6 98
0030 | 18 8F 5C 1D 17 2B 64 3D FE 50 01 00 55 39 7F 0F
0040 | 73 75 34 44 91 8C 8E D8 17 E7 C8 06 CC E9 4D B1
0050 | 09 9A D0 90 58 32 7E 35 53 CD F5 60 7A 99 81 6D
0060 | 86 2E AD 71 9B D1 66 B9 FE 49 7B 46 B6 E6 97 73
0070 | 4E 1E 52 1B A3 C1 CA 98 7B 9C CA CE 83 93 76 22
0080 | CF DF 7B 4D 05 95 6F 35 AB 62 BA AD 54 B1 33 14
0090 | 49 C5 53 46 9A 2E D0 FF 5E 25 7D B6 05 E2 82 D1
00A0 | 65 08 CA 6A AC D6 83 1D 73 1F 6D 65 FD 6D 0B 95
00B0 | 15 C0 62 D0 A1 C3 60 B0 2B 6B 66 23 E0 62 C8 4E
00C0 | F8 81 10 F5 E4 39 65 D5 D1 4E 55 DD 5D 22 23 B3
00D0 | 1A 5D 20 F6 1A 59 17 E1 F8 44 1D 5D 79 0E CF A5
00E0 | 1D 3D 4E 2C 12 59 D3 57 E8 D2 52 9A 1B 1D 76 88
00F0 | A6 28 FC EE CF 29 D7 FF F1 41 DA 14 16 45 51 57
0100 | F2 0E AB 8A DE 18 AB 4C 56 05 D7 70 D3 27 7C 97
0110 | E5 E0 38 25 54 22 9C E8 3C A5 6D AB A4 EA 45 61
0120 | B4 E1 B9 1B 38 13 53 9C A1 2A 88 7D F7 11 AF 32
0130 | B1 E4 27 CF 6B 41 7D C8 6F F9 23 5B DC F2 26 3F
0140 | 5F 01 32 27 CA 51 30 B6 AD 64 5F F4 FF 4E F9 0F
0150 | F5 CD 2F EA E7 98 4E 26 0E B4 68 11 C3 DD 94 7D
0160 | CC DB CA 1D E1 42 9A 7F 1C 0E E9 D0 AF 59 3B 98
0170 | C4 E5 26 6E 2E 2A 20 08 05 2E 33 3A 13 C0 F4 4E
0180 | 3C B9 1A 4C 2B 9D A6 91 77 4A AC 24</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>DCEE0E00B4A5BA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010055397F0F73753444918C8ED8</code> <code>17E7C806CCE94DB1099AD09058327E35</code> <code>53CDF5607A99816D862EAD719BD166B9</code> <code>FE497B46B6E697734E1E521BA3C1CA98</code> <code>7B9CCACE83937622CFDF7B4D05956F35</code> <code>AB62BAAD54B1331449C553469A2ED0FF</code> <code>5E257DB605E282D16508CA6AACD6831D</code> <code>731F6D65FD6D0B9515C062D0A1C360B0</code> <code>2B6B6623E062C84EF88110F5E43965D5</code> <code>D14E55DD5D2223B31A5D20F61A5917E1</code> <code>F8441D5D790ECFA51D3D4E2C1259D357</code> <code>E8D2529A1B1D7688A628FCEECF29D7FF</code> <code>F141DA1416455157F20EAB8ADE18AB4C</code> <code>5605D770D3277C97E5E0382554229CE8</code> <code>3CA56DABA4EA4561B4E1B91B3813539C</code> <code>A12A887DF711AF32B1E427CF6B417DC8</code> <code>6FF9235BDCF2263F5F013227CA5130B6</code> <code>AD645FF4FF4EF90FF5CD2FEAE7984E26</code> <code>0EB46811C3DD947DCCDBCA1DE1429A7F</code> <code>1C0EE9D0AF593B98C4E5266E2E2A2008</code> <code>052E333A13C0F44E3CB91A4C2B9DA691</code><br> <code>774AAC24</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 02AD914CE36A20F1C5A0ADFF11B63FB71D03C6D282E6162D672E7B7DF8715CC589D12E47150196FB9C95BCD9F15043BD61C4F34AB3915DAA00AA076BB4CE1042613CD86EFF9372C380205A323AA9335432F51E77DD0A66DAB71B46DCB654EC9D01F6A55795A410EB8D61F5CB6A418D1D2D73C583B31013D0A3073B30BBEF2377B2B718FBA0C7BB4D19E2FC5DC05560F002F5E6B77CF360BD9650C8D7FA095C25EAED03E69E0EDF83E9A430036A3E14C3263E357627F96FFAFF17F7423E19B89CAD4F7EBF9316644406417D82778B5A65F2AAD31B2385561FEE8235FD31ABB9B2E48E079EBF3B87213A6F047BFE32FD235E3AB0FA0175E260E579E8E4B35B36DD</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F0 73 83 B6 A5 BA 68
0010 | 34 00 00 00 34 F7 CB 3B E1 E3 51 1A C4 F8 27 B1
0020 | B6 1A E8 64 57 86 36 1F D7 E4 0A 7D B2 23 B6 98
0030 | 18 8F 5C 1D 17 2B 64 3D 21 07 09 66 D6 5A 68 FB
0040 | 7F BC D8 A0 D1 3B 13 C8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F07383B6A5BA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E1E3511AC4F827B1B61AE8645786361F</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>D7E40A7DB223B698188F5C1D172B643D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>21070966D65A68FB7FBCD8A0D13B13C8</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

