<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 DC 3E 09 00 95 7F 3B 67
0010 | 14 00 00 00 F1 8E 7E BE 7D 9F 40 60 C1 4E E4 F4
0020 | 73 B7 9A D5 93 11 01 C1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>DC3E0900957F3B67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 08 E0 8D 95 7F 3B 67
0010 | 50 00 00 00 63 24 16 05 7D 9F 40 60 C1 4E E4 F4
0020 | 73 B7 9A D5 93 11 01 C1 BB 2C BB 15 ED 49 27 3B
0030 | 5B 87 92 41 2D 0D 14 15 08 26 F5 21 E9 AB D8 E0
0040 | ED 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0108E08D957F3B67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0826F521E9ABD8E0ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2807187230229586157</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2807187230229586157</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2807187230229586157 = 1580384321 * 1776268717</code></p>
<pre><code>p = 1580384321
q = 1776268717</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 26 F5 21 E9 AB D8 E0 ED 00 00 00
0010 | 04 5E 32 C0 41 00 00 00 04 69 DF B5 AD 00 00 00
0020 | 7D 9F 40 60 C1 4E E4 F4 73 B7 9A D5 93 11 01 C1
0030 | BB 2C BB 15 ED 49 27 3B 5B 87 92 41 2D 0D 14 15
0040 | C9 BB 70 9C 91 F9 70 18 73 47 EB F7 10 46 3D D1
0050 | 67 71 65 41 26 EE 0E 93 7E B7 23 D9 EE 2C D7 B5
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0826F521E9ABD8E0ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2807187230229586157</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045E32C041000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1580384321</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0469DFB5AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1776268717</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>C9BB709C91F970187347EBF710463DD1</code> <code>6771654126EE0E937EB723D9EE2CD7B5</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90826F521E9ABD8E0ED000000045E32C0410000000469DFB5AD0000007D9F4060C14EE4F473B79AD5931101C1BB2CBB15ED49273B5B8792412D0D1415C9BB709C91F970187347EBF710463DD16771654126EE0E937EB723D9EE2CD7B502000000
random_padding_bytes = 70A3127B2A314959F25F480EB8BEE197FE58FEC45DBE09420DD46B17BB6B728EFF101804C9BB53288F6E799A067581A5466CBE0A1DF648933AD74436A880CCB293996750706275A61CB8E1ABD7C226BAF7028760D43B4EEA38F50D85</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 393C4F2819E7084F784BF597C28BB63DE0C075BDA3024017E6D4C85C06725AD1F6532E656615D5D37C5A894E083917F274C2D37FA40F5EC34A0806EA5E4EE7E404DA49FBC5F5B194D0F2E39F5821E155C8107E1181D525E6E1619660F76D086EC0E40EF7DFE1A5B7914C6D2386E3338CABAB5C1D17D02A034256EFF21BED384F8D326FA21E97331BF010179383A479FD4493C13ACE233C31D8A57F536AAE2848597D46B2F30873BBBAC1CFF09441A064728FE1F2953885F146295507E0FAB59EDB2FA8FC2A0F5241E1E9A16F099B6F88F590BD8FCBB8CF3BDC7B76B9F6D745085DB3678023E73F5581D0D17BAE64E88B3387AF582E6A002FBB81757CB12FA29C</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E0 3E 09 00 95 7F 3B 67
0010 | 40 01 00 00 BE E4 12 D7 7D 9F 40 60 C1 4E E4 F4
0020 | 73 B7 9A D5 93 11 01 C1 BB 2C BB 15 ED 49 27 3B
0030 | 5B 87 92 41 2D 0D 14 15 04 5E 32 C0 41 00 00 00
0040 | 04 69 DF B5 AD 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 39 3C 4F 28 19 E7 08 4F 78 4B F5 97
0060 | C2 8B B6 3D E0 C0 75 BD A3 02 40 17 E6 D4 C8 5C
0070 | 06 72 5A D1 F6 53 2E 65 66 15 D5 D3 7C 5A 89 4E
0080 | 08 39 17 F2 74 C2 D3 7F A4 0F 5E C3 4A 08 06 EA
0090 | 5E 4E E7 E4 04 DA 49 FB C5 F5 B1 94 D0 F2 E3 9F
00A0 | 58 21 E1 55 C8 10 7E 11 81 D5 25 E6 E1 61 96 60
00B0 | F7 6D 08 6E C0 E4 0E F7 DF E1 A5 B7 91 4C 6D 23
00C0 | 86 E3 33 8C AB AB 5C 1D 17 D0 2A 03 42 56 EF F2
00D0 | 1B ED 38 4F 8D 32 6F A2 1E 97 33 1B F0 10 17 93
00E0 | 83 A4 79 FD 44 93 C1 3A CE 23 3C 31 D8 A5 7F 53
00F0 | 6A AE 28 48 59 7D 46 B2 F3 08 73 BB BA C1 CF F0
0100 | 94 41 A0 64 72 8F E1 F2 95 38 85 F1 46 29 55 07
0110 | E0 FA B5 9E DB 2F A8 FC 2A 0F 52 41 E1 E9 A1 6F
0120 | 09 9B 6F 88 F5 90 BD 8F CB B8 CF 3B DC 7B 76 B9
0130 | F6 D7 45 08 5D B3 67 80 23 E7 3F 55 81 D0 D1 7B
0140 | AE 64 E8 8B 33 87 AF 58 2E 6A 00 2F BB 81 75 7C
0150 | B1 2F A2 9C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E03E0900957F3B67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045E32C041000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1580384321</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0469DFB5AD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1776268717</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100393C4F2819E7084F784BF597</code> <code>C28BB63DE0C075BDA3024017E6D4C85C</code> <code>06725AD1F6532E656615D5D37C5A894E</code> <code>083917F274C2D37FA40F5EC34A0806EA</code> <code>5E4EE7E404DA49FBC5F5B194D0F2E39F</code> <code>5821E155C8107E1181D525E6E1619660</code> <code>F76D086EC0E40EF7DFE1A5B7914C6D23</code> <code>86E3338CABAB5C1D17D02A034256EFF2</code> <code>1BED384F8D326FA21E97331BF0101793</code> <code>83A479FD4493C13ACE233C31D8A57F53</code> <code>6AAE2848597D46B2F30873BBBAC1CFF0</code> <code>9441A064728FE1F2953885F146295507</code> <code>E0FAB59EDB2FA8FC2A0F5241E1E9A16F</code> <code>099B6F88F590BD8FCBB8CF3BDC7B76B9</code> <code>F6D745085DB3678023E73F5581D0D17B</code> <code>AE64E88B3387AF582E6A002FBB81757C</code><br> <code>B12FA29C</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 40 83 A2 95 7F 3B 67
0010 | 78 02 00 00 5C 07 E8 D0 7D 9F 40 60 C1 4E E4 F4
0020 | 73 B7 9A D5 93 11 01 C1 BB 2C BB 15 ED 49 27 3B
0030 | 5B 87 92 41 2D 0D 14 15 FE 50 02 00 C4 7D 30 F0
0040 | 23 0D 75 23 46 85 0F FE A4 2A 6F 2D CC A0 9A B4
0050 | 1B EA 9C 8E 7A E7 95 47 57 FF 7D FA 83 C6 D5 7F
0060 | 7A C6 D7 7C B7 09 AB 7D B2 85 34 A7 15 7F 50 A2
0070 | 9D 32 54 4F 26 25 96 C7 7A D3 6C 66 CD 98 97 01
0080 | 0F E9 6F EE 5C 22 09 18 D6 B3 B9 93 38 8C BD 22
0090 | 9C FE CC BD 37 FE CE 7E 96 30 8E EF 0D 9C E9 59
00A0 | 8A 1E 9E C3 46 A7 1F 37 8B E4 5F 84 31 88 E5 CA
00B0 | 07 F0 B0 C2 E6 9B F8 B1 B8 EE 5E 2E 4F 4B B2 CA
00C0 | 8B AA 7E 97 68 11 64 C1 08 2C 9A AA FB E3 38 FB
00D0 | 16 7B 00 A4 4D E9 A2 B2 1F 71 32 B0 66 F4 91 E3
00E0 | 18 3B 27 33 7A A0 E3 82 CD E1 E9 0F 4D 11 0A CF
00F0 | F7 98 47 A3 57 34 F3 9A 09 9E 34 B9 28 1A EC F2
0100 | B3 DF FB E8 06 13 60 BE 1B 24 09 0C CF 78 A7 88
0110 | 95 E8 25 0F 38 4F 86 EE 22 F7 77 0B 9F D4 C8 5C
0120 | A8 24 21 8F 24 A7 06 47 3C B9 FD B5 71 0F A5 E6
0130 | 2F 8C 7C DF B0 36 7B 93 81 A8 BD C3 D0 FE 7F FC
0140 | C9 85 85 37 54 86 04 70 CF 09 62 96 4D 95 72 C7
0150 | 88 3E F4 50 9F 8D A0 31 0F 37 AD 11 CF 89 9E 54
0160 | 3A 0F A1 C2 91 5A FC B1 D7 C0 EA 51 68 BB C2 21
0170 | DE EE 61 81 CB 24 F5 09 41 70 53 F8 BF D1 C5 05
0180 | 87 8C E6 58 59 5C 19 06 0C 5E 6A 52 8B E0 C1 B8
0190 | B0 15 F0 29 0B 55 EB 01 85 D2 5C B4 40 21 11 F2
01A0 | B5 9E E6 F3 C4 AC 6F 9E F6 88 51 A6 5E BF 34 AC
01B0 | BC 80 9E 7C F6 CE 88 CF FB 5A 73 9B C2 58 D2 BC
01C0 | 0B 14 F8 2F CA 3C C7 E3 99 B9 9A 71 5F 1D EF 94
01D0 | 85 5C FB 3F CE 52 39 C3 B3 70 0D 93 34 3E 76 BE
01E0 | 80 3E CB 09 9A A8 3C 12 98 8B F6 E1 75 A2 DB 01
01F0 | 47 8C 79 ED 4E 8D C8 33 22 FB 31 D5 C5 F0 95 9F
0200 | 27 C9 BF D0 E2 DD 2D D4 DE 99 10 25 C6 2C 92 41
0210 | AB FE F6 AB 63 19 F6 B0 DF 62 06 5D 55 94 55 A2
0220 | A6 14 BF 77 00 25 E1 67 1F 96 2C C4 58 7A 67 D9
0230 | DB D0 90 EB 14 DB DC 6F 0A 65 1A 1C 73 D9 84 30
0240 | 1B 48 FD DE AB 07 27 DB B2 5F B3 18 F0 5A 74 48
0250 | 31 D2 16 E8 41 63 1A C2 10 00 1D 9A 71 75 F8 37
0260 | DE 0E 9B 40 EA 77 25 7C CB 70 4F 5B 9E 5F 91 6A
0270 | 20 4F B2 5A 6C 6B D0 FF 58 0E 93 93 02 DF 3C 20
0280 | ED 85 82 EE 12 74 20 DE C8 75 DB 19</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014083A2957F3B67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200C47D30F0230D752346850FFE</code> <code>A42A6F2DCCA09AB41BEA9C8E7AE79547</code> <code>57FF7DFA83C6D57F7AC6D77CB709AB7D</code> <code>B28534A7157F50A29D32544F262596C7</code> <code>7AD36C66CD9897010FE96FEE5C220918</code> <code>D6B3B993388CBD229CFECCBD37FECE7E</code> <code>96308EEF0D9CE9598A1E9EC346A71F37</code> <code>8BE45F843188E5CA07F0B0C2E69BF8B1</code> <code>B8EE5E2E4F4BB2CA8BAA7E97681164C1</code> <code>082C9AAAFBE338FB167B00A44DE9A2B2</code> <code>1F7132B066F491E3183B27337AA0E382</code> <code>CDE1E90F4D110ACFF79847A35734F39A</code> <code>099E34B9281AECF2B3DFFBE8061360BE</code> <code>1B24090CCF78A78895E8250F384F86EE</code> <code>22F7770B9FD4C85CA824218F24A70647</code> <code>3CB9FDB5710FA5E62F8C7CDFB0367B93</code> <code>81A8BDC3D0FE7FFCC985853754860470</code> <code>CF0962964D9572C7883EF4509F8DA031</code> <code>0F37AD11CF899E543A0FA1C2915AFCB1</code> <code>D7C0EA5168BBC221DEEE6181CB24F509</code> <code>417053F8BFD1C505878CE658595C1906</code> <code>0C5E6A528BE0C1B8B015F0290B55EB01</code> <code>85D25CB4402111F2B59EE6F3C4AC6F9E</code> <code>F68851A65EBF34ACBC809E7CF6CE88CF</code> <code>FB5A739BC258D2BC0B14F82FCA3CC7E3</code> <code>99B99A715F1DEF94855CFB3FCE5239C3</code> <code>B3700D93343E76BE803ECB099AA83C12</code> <code>988BF6E175A2DB01478C79ED4E8DC833</code> <code>22FB31D5C5F0959F27C9BFD0E2DD2DD4</code> <code>DE991025C62C9241ABFEF6AB6319F6B0</code> <code>DF62065D559455A2A614BF770025E167</code> <code>1F962CC4587A67D9DBD090EB14DBDC6F</code> <code>0A651A1C73D984301B48FDDEAB0727DB</code> <code>B25FB318F05A744831D216E841631AC2</code> <code>10001D9A7175F837DE0E9B40EA77257C</code> <code>CB704F5B9E5F916A204FB25A6C6BD0FF</code> <code>580E939302DF3C20ED8582EE127420DE</code><br> <code>C875DB19</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = C47D30F0230D752346850FFEA42A6F2DCCA09AB41BEA9C8E7AE7954757FF7DFA83C6D57F7AC6D77CB709AB7DB28534A7157F50A29D32544F262596C77AD36C66CD9897010FE96FEE5C220918D6B3B993388CBD229CFECCBD37FECE7E96308EEF0D9CE9598A1E9EC346A71F378BE45F843188E5CA07F0B0C2E69BF8B1B8EE5E2E4F4BB2CA8BAA7E97681164C1082C9AAAFBE338FB167B00A44DE9A2B21F7132B066F491E3183B27337AA0E382CDE1E90F4D110ACFF79847A35734F39A099E34B9281AECF2B3DFFBE8061360BE1B24090CCF78A78895E8250F384F86EE22F7770B9FD4C85CA824218F24A706473CB9FDB5710FA5E62F8C7CDFB0367B9381A8BDC3D0FE7FFCC985853754860470CF0962964D9572C7883EF4509F8DA0310F37AD11CF899E543A0FA1C2915AFCB1D7C0EA5168BBC221DEEE6181CB24F509417053F8BFD1C505878CE658595C19060C5E6A528BE0C1B8B015F0290B55EB0185D25CB4402111F2B59EE6F3C4AC6F9EF68851A65EBF34ACBC809E7CF6CE88CFFB5A739BC258D2BC0B14F82FCA3CC7E399B99A715F1DEF94855CFB3FCE5239C3B3700D93343E76BE803ECB099AA83C12988BF6E175A2DB01478C79ED4E8DC83322FB31D5C5F0959F27C9BFD0E2DD2DD4DE991025C62C9241ABFEF6AB6319F6B0DF62065D559455A2A614BF770025E1671F962CC4587A67D9DBD090EB14DBDC6F0A651A1C73D984301B48FDDEAB0727DBB25FB318F05A744831D216E841631AC210001D9A7175F837DE0E9B40EA77257CCB704F5B9E5F916A204FB25A6C6BD0FF580E939302DF3C20ED8582EE127420DEC875DB19
tmp_aes_key = 7E01C87F254059715CE23E5A1E9187FF9167850EEDF2B3DF7BEE3914AB678ECD
tmp_aes_iv = CA96ACD664660E664254AA0156D851F17B661483933100C02A5EAA1BC9BB709C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 0BAA65684050646B11A672A31FC2D414A1236A6EBA0D89B57D9F4060C14EE4F473B79AD5931101C1BB2CBB15ED49273B5B8792412D0D141503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001008BBBB4583A11E0A94B65701F8C8D27658350EF6224E39ED6B3FDC8719EC6497A4E5C32D5207805C8AF23683404DAAEA68D7AF12359C5551CC997F4E9F95B3FBE1B4C5A3906A7EFDF5E2001F1D2374C7F42FEF22E92E8687DF69F10732CF65C2330003FEB08ADE82E5B6A07ED23F473EBD9BEC062149BD82E7B153E24C7C555A421BD68E46AAE83507E50B367A825FABCAA6598BEA04C5910DE136E504F8E8A688DA0F62761C7B9C095439D789E541F9C6726278FEF8AF5FF7709ACE0F3F6E3DDF69365214E24413D5AC14D4637A0919D8687BE8F02170849C2A03C2D8C364630BB3FF1552A0CFD30BF5531CC496162DE415C644D8491A0810E234E191A5E981E957F3B6799A0915CBB52230A
answer = BA0D89B57D9F4060C14EE4F473B79AD5931101C1BB2CBB15ED49273B5B8792412D0D141503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001008BBBB4583A11E0A94B65701F8C8D27658350EF6224E39ED6B3FDC8719EC6497A4E5C32D5207805C8AF23683404DAAEA68D7AF12359C5551CC997F4E9F95B3FBE1B4C5A3906A7EFDF5E2001F1D2374C7F42FEF22E92E8687DF69F10732CF65C2330003FEB08ADE82E5B6A07ED23F473EBD9BEC062149BD82E7B153E24C7C555A421BD68E46AAE83507E50B367A825FABCAA6598BEA04C5910DE136E504F8E8A688DA0F62761C7B9C095439D789E541F9C6726278FEF8AF5FF7709ACE0F3F6E3DDF69365214E24413D5AC14D4637A0919D8687BE8F02170849C2A03C2D8C364630BB3FF1552A0CFD30BF5531CC496162DE415C644D8491A0810E234E191A5E981E957F3B6799A0915CBB52230A</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 7D 9F 40 60 C1 4E E4 F4 73 B7 9A D5
0010 | 93 11 01 C1 BB 2C BB 15 ED 49 27 3B 5B 87 92 41
0020 | 2D 0D 14 15 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 8B BB B4 58 3A 11 E0 A9 4B 65 70 1F 8C 8D 27 65
0140 | 83 50 EF 62 24 E3 9E D6 B3 FD C8 71 9E C6 49 7A
0150 | 4E 5C 32 D5 20 78 05 C8 AF 23 68 34 04 DA AE A6
0160 | 8D 7A F1 23 59 C5 55 1C C9 97 F4 E9 F9 5B 3F BE
0170 | 1B 4C 5A 39 06 A7 EF DF 5E 20 01 F1 D2 37 4C 7F
0180 | 42 FE F2 2E 92 E8 68 7D F6 9F 10 73 2C F6 5C 23
0190 | 30 00 3F EB 08 AD E8 2E 5B 6A 07 ED 23 F4 73 EB
01A0 | D9 BE C0 62 14 9B D8 2E 7B 15 3E 24 C7 C5 55 A4
01B0 | 21 BD 68 E4 6A AE 83 50 7E 50 B3 67 A8 25 FA BC
01C0 | AA 65 98 BE A0 4C 59 10 DE 13 6E 50 4F 8E 8A 68
01D0 | 8D A0 F6 27 61 C7 B9 C0 95 43 9D 78 9E 54 1F 9C
01E0 | 67 26 27 8F EF 8A F5 FF 77 09 AC E0 F3 F6 E3 DD
01F0 | F6 93 65 21 4E 24 41 3D 5A C1 4D 46 37 A0 91 9D
0200 | 86 87 BE 8F 02 17 08 49 C2 A0 3C 2D 8C 36 46 30
0210 | BB 3F F1 55 2A 0C FD 30 BF 55 31 CC 49 61 62 DE
0220 | 41 5C 64 4D 84 91 A0 81 0E 23 4E 19 1A 5E 98 1E
0230 | 95 7F 3B 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001008BBBB4583A11E0A94B65701F</code> <code>8C8D27658350EF6224E39ED6B3FDC871</code> <code>9EC6497A4E5C32D5207805C8AF236834</code> <code>04DAAEA68D7AF12359C5551CC997F4E9</code> <code>F95B3FBE1B4C5A3906A7EFDF5E2001F1</code> <code>D2374C7F42FEF22E92E8687DF69F1073</code> <code>2CF65C2330003FEB08ADE82E5B6A07ED</code> <code>23F473EBD9BEC062149BD82E7B153E24</code> <code>C7C555A421BD68E46AAE83507E50B367</code> <code>A825FABCAA6598BEA04C5910DE136E50</code> <code>4F8E8A688DA0F62761C7B9C095439D78</code> <code>9E541F9C6726278FEF8AF5FF7709ACE0</code> <code>F3F6E3DDF69365214E24413D5AC14D46</code> <code>37A0919D8687BE8F02170849C2A03C2D</code> <code>8C364630BB3FF1552A0CFD30BF5531CC</code> <code>496162DE415C644D8491A0810E234E19</code><br> <code>1A5E981E</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>957F3B67</code> (1731952533 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 8D66BED45457928D51EEF0FAC4676380466B0D53F9C9519A81DFF70CB91AC0165DDE118EC078A16EC9889FB9B02C1EAEE84C44C1BF4C217C13C79FDD25BC0DDC16E0ADB6FCE316CE7CB75E1AFA6693386C124B32B9AAEC2BDE3633B19F142C3B95221FA1C46B0ED6B0E628CC6A081055181943243458A471858D3A307CDD028CD691E988CE99156E8FD7DBCB99FBB64507909AB7D6FED54A94F565A9EDF045494D567B05EC6C5740194D740E7CF5F789DFD340D455A3C8E34F21F2BA15DD2DADA208EA3FFEC7FD3B0C244753AFE3DFA80E481674C3CC054A29E237D936F266E86D19790BFD6164B018A8F960B51133F764A8EF406CA80FC92C724BC299A831BA</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = B39DB51E0A45C92CD1DF0ED758DECF5FFDA671A0569EDDCF5576C4911B468B3CF8031FA0A82A5FA956001951525C6200CBE8D263F54FAF69A25BF727963924628F69FB4CACF96214D1F70CAD6AB51B6F0386D858E72A543B5C6F745B4E4196BB7B4B4E1CEE87082381BC270B6AB77FD366A65276FFC35C0C93FD0DDADF15BDC429D6225029E9C01502424B7E92014441FCBD7DE22DEC8FC62DBDD0D868FC01ECB5812724D4300C76146AEF5EF7154CF04C745B704D3FC9C89DD22D8F9D8E5D1403F83A6D205F0D0C0DD938C0D48C08513226F46A036A4C5D15405F935669A5E3ADFDF6AB4EEC0A36C36CEDD8E6195EFAB9DA097C0D9E03AAF3CD10F8B6BE64DD</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 7D 9F 40 60 C1 4E E4 F4 73 B7 9A D5
0010 | 93 11 01 C1 BB 2C BB 15 ED 49 27 3B 5B 87 92 41
0020 | 2D 0D 14 15 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | B3 9D B5 1E 0A 45 C9 2C D1 DF 0E D7 58 DE CF 5F
0040 | FD A6 71 A0 56 9E DD CF 55 76 C4 91 1B 46 8B 3C
0050 | F8 03 1F A0 A8 2A 5F A9 56 00 19 51 52 5C 62 00
0060 | CB E8 D2 63 F5 4F AF 69 A2 5B F7 27 96 39 24 62
0070 | 8F 69 FB 4C AC F9 62 14 D1 F7 0C AD 6A B5 1B 6F
0080 | 03 86 D8 58 E7 2A 54 3B 5C 6F 74 5B 4E 41 96 BB
0090 | 7B 4B 4E 1C EE 87 08 23 81 BC 27 0B 6A B7 7F D3
00A0 | 66 A6 52 76 FF C3 5C 0C 93 FD 0D DA DF 15 BD C4
00B0 | 29 D6 22 50 29 E9 C0 15 02 42 4B 7E 92 01 44 41
00C0 | FC BD 7D E2 2D EC 8F C6 2D BD D0 D8 68 FC 01 EC
00D0 | B5 81 27 24 D4 30 0C 76 14 6A EF 5E F7 15 4C F0
00E0 | 4C 74 5B 70 4D 3F C9 C8 9D D2 2D 8F 9D 8E 5D 14
00F0 | 03 F8 3A 6D 20 5F 0D 0C 0D D9 38 C0 D4 8C 08 51
0100 | 32 26 F4 6A 03 6A 4C 5D 15 40 5F 93 56 69 A5 E3
0110 | AD FD F6 AB 4E EC 0A 36 C3 6C ED D8 E6 19 5E FA
0120 | B9 DA 09 7C 0D 9E 03 AA F3 CD 10 F8 B6 BE 64 DD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100B39DB51E0A45C92CD1DF0ED7</code> <code>58DECF5FFDA671A0569EDDCF5576C491</code> <code>1B468B3CF8031FA0A82A5FA956001951</code> <code>525C6200CBE8D263F54FAF69A25BF727</code> <code>963924628F69FB4CACF96214D1F70CAD</code> <code>6AB51B6F0386D858E72A543B5C6F745B</code> <code>4E4196BB7B4B4E1CEE87082381BC270B</code> <code>6AB77FD366A65276FFC35C0C93FD0DDA</code> <code>DF15BDC429D6225029E9C01502424B7E</code> <code>92014441FCBD7DE22DEC8FC62DBDD0D8</code> <code>68FC01ECB5812724D4300C76146AEF5E</code> <code>F7154CF04C745B704D3FC9C89DD22D8F</code> <code>9D8E5D1403F83A6D205F0D0C0DD938C0</code> <code>D48C08513226F46A036A4C5D15405F93</code> <code>5669A5E3ADFDF6AB4EEC0A36C36CEDD8</code> <code>E6195EFAB9DA097C0D9E03AAF3CD10F8</code><br> <code>B6BE64DD</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643667D9F4060C14EE4F473B79AD5931101C1BB2CBB15ED49273B5B8792412D0D14150000000000000000FE000100B39DB51E0A45C92CD1DF0ED758DECF5FFDA671A0569EDDCF5576C4911B468B3CF8031FA0A82A5FA956001951525C6200CBE8D263F54FAF69A25BF727963924628F69FB4CACF96214D1F70CAD6AB51B6F0386D858E72A543B5C6F745B4E4196BB7B4B4E1CEE87082381BC270B6AB77FD366A65276FFC35C0C93FD0DDADF15BDC429D6225029E9C01502424B7E92014441FCBD7DE22DEC8FC62DBDD0D868FC01ECB5812724D4300C76146AEF5EF7154CF04C745B704D3FC9C89DD22D8F9D8E5D1403F83A6D205F0D0C0DD938C0D48C08513226F46A036A4C5D15405F935669A5E3ADFDF6AB4EEC0A36C36CEDD8E6195EFAB9DA097C0D9E03AAF3CD10F8B6BE64DD
padding = E03FFF364FAA48EF8EF518F4
tmp_aes_key = 7E01C87F254059715CE23E5A1E9187FF9167850EEDF2B3DF7BEE3914AB678ECD
tmp_aes_iv = CA96ACD664660E664254AA0156D851F17B661483933100C02A5EAA1BC9BB709C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = CBB64D6F3676949579A0A59CE1BE95BFF2F3CFDB0013F6AFC73B6C7F9DA36A3B78DE0C791D9A3F5CE278C149C6A4BF98FEC12799BB07E7FBE1EBA9BC208A7EB1D0A2492A8F1636CD0D3ED4AED6B0F4ADDCDECF0B412F2058A61D0C37DD4FEAE9FA88782B73BAD331CA461A0E32683BB23DAB73743D7A744B30A697F69B2C77C3D29B71B4D1B80FA1ECF607AFD4E232874F46832AC92820968D28880753633E37E64769943CC560DA898EC4F818232E8BA3C9A0EFC08226D3FBD01A28D326CACA03F9FD98B44612F1115BADB389085FA53AC618F2584F307344487B9842098A1D5EB270E6D27F015322AF8E167C5F82455767994F1CCEB1D6B8A96A873BEC87E3A470ED2F5C6F374629992061A4C4FD6AD6AE030BBB922BCAE3DF0B87978791E087788DFF15527BC7BB955AD9BCDF8B438FE2058207464220E24080695B3FFC7998900118D6DBAB98AC7984824305DC11</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 3E 09 00 95 7F 3B 67
0010 | 78 01 00 00 1F 5F 04 F5 7D 9F 40 60 C1 4E E4 F4
0020 | 73 B7 9A D5 93 11 01 C1 BB 2C BB 15 ED 49 27 3B
0030 | 5B 87 92 41 2D 0D 14 15 FE 50 01 00 CB B6 4D 6F
0040 | 36 76 94 95 79 A0 A5 9C E1 BE 95 BF F2 F3 CF DB
0050 | 00 13 F6 AF C7 3B 6C 7F 9D A3 6A 3B 78 DE 0C 79
0060 | 1D 9A 3F 5C E2 78 C1 49 C6 A4 BF 98 FE C1 27 99
0070 | BB 07 E7 FB E1 EB A9 BC 20 8A 7E B1 D0 A2 49 2A
0080 | 8F 16 36 CD 0D 3E D4 AE D6 B0 F4 AD DC DE CF 0B
0090 | 41 2F 20 58 A6 1D 0C 37 DD 4F EA E9 FA 88 78 2B
00A0 | 73 BA D3 31 CA 46 1A 0E 32 68 3B B2 3D AB 73 74
00B0 | 3D 7A 74 4B 30 A6 97 F6 9B 2C 77 C3 D2 9B 71 B4
00C0 | D1 B8 0F A1 EC F6 07 AF D4 E2 32 87 4F 46 83 2A
00D0 | C9 28 20 96 8D 28 88 07 53 63 3E 37 E6 47 69 94
00E0 | 3C C5 60 DA 89 8E C4 F8 18 23 2E 8B A3 C9 A0 EF
00F0 | C0 82 26 D3 FB D0 1A 28 D3 26 CA CA 03 F9 FD 98
0100 | B4 46 12 F1 11 5B AD B3 89 08 5F A5 3A C6 18 F2
0110 | 58 4F 30 73 44 48 7B 98 42 09 8A 1D 5E B2 70 E6
0120 | D2 7F 01 53 22 AF 8E 16 7C 5F 82 45 57 67 99 4F
0130 | 1C CE B1 D6 B8 A9 6A 87 3B EC 87 E3 A4 70 ED 2F
0140 | 5C 6F 37 46 29 99 20 61 A4 C4 FD 6A D6 AE 03 0B
0150 | BB 92 2B CA E3 DF 0B 87 97 87 91 E0 87 78 8D FF
0160 | 15 52 7B C7 BB 95 5A D9 BC DF 8B 43 8F E2 05 82
0170 | 07 46 42 20 E2 40 80 69 5B 3F FC 79 98 90 01 18
0180 | D6 DB AB 98 AC 79 84 82 43 05 DC 11</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E43E0900957F3B67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100CBB64D6F3676949579A0A59C</code> <code>E1BE95BFF2F3CFDB0013F6AFC73B6C7F</code> <code>9DA36A3B78DE0C791D9A3F5CE278C149</code> <code>C6A4BF98FEC12799BB07E7FBE1EBA9BC</code> <code>208A7EB1D0A2492A8F1636CD0D3ED4AE</code> <code>D6B0F4ADDCDECF0B412F2058A61D0C37</code> <code>DD4FEAE9FA88782B73BAD331CA461A0E</code> <code>32683BB23DAB73743D7A744B30A697F6</code> <code>9B2C77C3D29B71B4D1B80FA1ECF607AF</code> <code>D4E232874F46832AC92820968D288807</code> <code>53633E37E64769943CC560DA898EC4F8</code> <code>18232E8BA3C9A0EFC08226D3FBD01A28</code> <code>D326CACA03F9FD98B44612F1115BADB3</code> <code>89085FA53AC618F2584F307344487B98</code> <code>42098A1D5EB270E6D27F015322AF8E16</code> <code>7C5F82455767994F1CCEB1D6B8A96A87</code> <code>3BEC87E3A470ED2F5C6F374629992061</code> <code>A4C4FD6AD6AE030BBB922BCAE3DF0B87</code> <code>978791E087788DFF15527BC7BB955AD9</code> <code>BCDF8B438FE2058207464220E2408069</code> <code>5B3FFC7998900118D6DBAB98AC798482</code><br> <code>4305DC11</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 3BAF8AC9D5233A1B6CFAE204A9FA16F059B1C1A5F5A5EC1913C2F6DE6BF9E82A0C5A48EDC428D2635A3143FE3CCB5C7620306FDE1018ED8A187902075B32009C2C8A2912B6EECCA89457D26714E686794B95EAF2226B2AFFF47F7A1ABF73BE2212DE41FD876C85659B527FA07B5BCE4A632C8350360852378AF3EE9511565E77196CD1E3A660273CC40DA2B5950DFDA033EF4D69B2AA7FB3B6A0EE2875D0D6D89F10D38F3BFB65C00D0617B32AB259D09AABD0FA4B7D7C3FAEECF2B380045746741DF23F88568FDB7E5E5386F0193BCDE53B0D5DDE1828D4FA611D3D9E70E61D44CB805217D06AF8A9095C3EAB6C4D07CA0F9408C5BA12EB56847BC98B8ED740</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 68 45 62 97 7F 3B 67
0010 | 34 00 00 00 34 F7 CB 3B 7D 9F 40 60 C1 4E E4 F4
0020 | 73 B7 9A D5 93 11 01 C1 BB 2C BB 15 ED 49 27 3B
0030 | 5B 87 92 41 2D 0D 14 15 79 89 E3 69 67 53 7C 2E
0040 | AA E3 41 4C B1 99 FA AA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01684562977F3B67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7D9F4060C14EE4F473B79AD5931101C1</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BB2CBB15ED49273B5B8792412D0D1415</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>7989E36967537C2EAAE3414CB199FAAA</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

