<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 00 EE 08 00 44 50 AE 66
0010 | 14 00 00 00 F1 8E 7E BE AF 92 71 33 BF B0 31 EB
0020 | 62 FE BB E2 C8 9D 60 7C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>00EE08004450AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 64 32 F3 44 50 AE 66
0010 | A0 00 00 00 63 24 16 05 AF 92 71 33 BF B0 31 EB
0020 | 62 FE BB E2 C8 9D 60 7C 63 96 F1 1C B0 17 84 0F
0030 | A1 06 5D D9 F3 08 DE 8F 08 20 87 1A 67 79 68 6B
0040 | FD 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>016432F34450AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A0000000</code> (160 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0820871A6779686BFD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2343871162790472701</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2343871162790472701</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2343871162790472701 = 1278686611 * 1833030191</code></p>
<pre><code>p = 1278686611
q = 1833030191</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 87 1A 67 79 68 6B FD 00 00 00
0010 | 04 4C 37 35 93 00 00 00 04 6D 41 D2 2F 00 00 00
0020 | AF 92 71 33 BF B0 31 EB 62 FE BB E2 C8 9D 60 7C
0030 | 63 96 F1 1C B0 17 84 0F A1 06 5D D9 F3 08 DE 8F
0040 | AF 07 B0 E4 A8 B3 FD A6 56 42 5F 66 08 91 11 81
0050 | 4B 52 49 AF B7 9D 3A 6C D7 94 E3 B5 1F 83 3C 85
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0820871A6779686BFD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2343871162790472701</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044C373593000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1278686611</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046D41D22F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1833030191</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>AF07B0E4A8B3FDA656425F6608911181</code> <code>4B5249AFB79D3A6CD794E3B51F833C85</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90820871A6779686BFD000000044C373593000000046D41D22F000000AF927133BFB031EB62FEBBE2C89D607C6396F11CB017840FA1065DD9F308DE8FAF07B0E4A8B3FDA656425F66089111814B5249AFB79D3A6CD794E3B51F833C8502000000
random_padding_bytes = 904ECC9704579CF9BF3BEB9D73BB49817BE0C56F1B51B2DB7FD8E1FD90C83C277AD7397B35BE0F3B607B19A7475C232F929BE03830BFD739523E074124CE0C218B1E4AB6DEF9BBF2589BD429D072E218912C6781CF779F696684FD2E</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 7A59D8E5408210928DFA3ABF7D1636575754CFACB3C3E4788EA49DF9519BBBC816F60F7ED4C294C2D72A1E8BC0259EB315DE58F068775890DCC0DA8EE79D900F8677C57EC9BB2FA04FA073BAA502B9356FAD5C8AA70BF66776E11264949853F2887385AA3387E70765C7890DE63704643AC9E4885BC50E160FF298DB7BDA1C64B5F277847BA88F5F0C4DE3E80581C47DAE49A475672D568CCE5819C91D975046816EE81FC72B95079ADCDAF4E09FC6CCF9AC6DA02A230769410F277756AB51659C271A3EB1E00A810AAE6E512DFB0F4B4FF1CAB38DDD1F64D95FC8E5674A357A12AA1BF402F58647EFDC588EC254108E9F7A4E388E98FF8C875A548A2A07E841</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 99 0C 00 45 50 AE 66
0010 | 40 01 00 00 BE E4 12 D7 AF 92 71 33 BF B0 31 EB
0020 | 62 FE BB E2 C8 9D 60 7C 63 96 F1 1C B0 17 84 0F
0030 | A1 06 5D D9 F3 08 DE 8F 04 4C 37 35 93 00 00 00
0040 | 04 6D 41 D2 2F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 7A 59 D8 E5 40 82 10 92 8D FA 3A BF
0060 | 7D 16 36 57 57 54 CF AC B3 C3 E4 78 8E A4 9D F9
0070 | 51 9B BB C8 16 F6 0F 7E D4 C2 94 C2 D7 2A 1E 8B
0080 | C0 25 9E B3 15 DE 58 F0 68 77 58 90 DC C0 DA 8E
0090 | E7 9D 90 0F 86 77 C5 7E C9 BB 2F A0 4F A0 73 BA
00A0 | A5 02 B9 35 6F AD 5C 8A A7 0B F6 67 76 E1 12 64
00B0 | 94 98 53 F2 88 73 85 AA 33 87 E7 07 65 C7 89 0D
00C0 | E6 37 04 64 3A C9 E4 88 5B C5 0E 16 0F F2 98 DB
00D0 | 7B DA 1C 64 B5 F2 77 84 7B A8 8F 5F 0C 4D E3 E8
00E0 | 05 81 C4 7D AE 49 A4 75 67 2D 56 8C CE 58 19 C9
00F0 | 1D 97 50 46 81 6E E8 1F C7 2B 95 07 9A DC DA F4
0100 | E0 9F C6 CC F9 AC 6D A0 2A 23 07 69 41 0F 27 77
0110 | 56 AB 51 65 9C 27 1A 3E B1 E0 0A 81 0A AE 6E 51
0120 | 2D FB 0F 4B 4F F1 CA B3 8D DD 1F 64 D9 5F C8 E5
0130 | 67 4A 35 7A 12 AA 1B F4 02 F5 86 47 EF DC 58 8E
0140 | C2 54 10 8E 9F 7A 4E 38 8E 98 FF 8C 87 5A 54 8A
0150 | 2A 07 E8 41</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>78990C004550AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044C373593000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1278686611</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046D41D22F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1833030191</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001007A59D8E5408210928DFA3ABF</code> <code>7D1636575754CFACB3C3E4788EA49DF9</code> <code>519BBBC816F60F7ED4C294C2D72A1E8B</code> <code>C0259EB315DE58F068775890DCC0DA8E</code> <code>E79D900F8677C57EC9BB2FA04FA073BA</code> <code>A502B9356FAD5C8AA70BF66776E11264</code> <code>949853F2887385AA3387E70765C7890D</code> <code>E63704643AC9E4885BC50E160FF298DB</code> <code>7BDA1C64B5F277847BA88F5F0C4DE3E8</code> <code>0581C47DAE49A475672D568CCE5819C9</code> <code>1D975046816EE81FC72B95079ADCDAF4</code> <code>E09FC6CCF9AC6DA02A230769410F2777</code> <code>56AB51659C271A3EB1E00A810AAE6E51</code> <code>2DFB0F4B4FF1CAB38DDD1F64D95FC8E5</code> <code>674A357A12AA1BF402F58647EFDC588E</code> <code>C254108E9F7A4E388E98FF8C875A548A</code><br> <code>2A07E841</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 AC 2B C4 45 50 AE 66
0010 | B0 02 00 00 5C 07 E8 D0 AF 92 71 33 BF B0 31 EB
0020 | 62 FE BB E2 C8 9D 60 7C 63 96 F1 1C B0 17 84 0F
0030 | A1 06 5D D9 F3 08 DE 8F FE 50 02 00 19 EC 16 F8
0040 | 80 DB 0B 8F 17 7A 38 68 C4 55 9E 6F 5E AA B5 BB
0050 | 6B 2A 02 74 45 44 F9 D7 4E DA CE 3C 51 22 2E 6B
0060 | 87 90 F1 16 00 49 82 58 B4 F3 40 45 45 E5 E5 81
0070 | 6C 29 7C 81 61 3D 22 F0 F4 36 1E 70 0D 57 4D 44
0080 | 48 78 04 C1 86 46 33 92 F5 07 32 E9 F3 03 01 A1
0090 | F9 37 9C F3 FB 6C 47 03 89 C0 BF 07 94 F1 E7 0B
00A0 | AF 34 B4 F2 0C 90 9B 2E 43 99 AF 12 46 A9 F0 C0
00B0 | BD DC E9 BF B9 8D A2 37 28 F1 DD DF C4 BC 7A 32
00C0 | C1 1F 82 E4 EB C2 21 AB 9E 7B 8A E8 DA 16 65 57
00D0 | DF 63 31 68 37 6F E5 7A 96 65 A8 4C 14 33 9B 90
00E0 | 7E DE 3C 75 C0 B8 55 98 B2 8B B4 30 DC 58 EF B5
00F0 | 06 0B A7 C9 8A F5 0F 42 E6 25 B2 4D F4 AB 65 EF
0100 | 7A D8 89 11 0D 91 47 FC 6C 8F 67 D5 BD 4C 74 00
0110 | BF 9F 99 4F 9F 77 6D 39 A4 59 99 BE 9F F3 7B 18
0120 | B7 52 59 76 C0 C6 0D 5E 1D F8 95 D5 18 09 44 AC
0130 | A9 64 8B 2E BA 57 54 44 86 86 DF A7 E6 FB FA 6F
0140 | 7B 3F 7B 50 D3 48 68 11 19 D8 99 A4 60 91 CF 5A
0150 | E8 6A 00 1D 04 BF 2C CF 61 2E 8D 43 4E C4 2B 96
0160 | 20 4B BF B4 42 C3 30 E3 21 7E D9 CE 03 80 E8 EB
0170 | 30 F2 63 F0 2F 26 1C 7C E5 AB 4B 0D 1D E1 EC DF
0180 | 1A 8B 11 17 32 D7 10 4E EF 8A 7A C6 AF 7E 46 E8
0190 | 4B E5 E2 3D FD ED DA BC E8 1E C6 98 B1 A5 76 B9
01A0 | 15 79 59 1D CD 37 33 AB AC 42 00 D2 0F AF D6 9A
01B0 | D3 50 55 18 63 54 C5 4E 57 60 7C 15 37 39 7F A6
01C0 | 11 55 B8 DF 57 FF 9F C2 F3 2E 45 7F 42 42 9B 48
01D0 | E5 8C C4 F0 07 BF 63 3A DC DE AE 69 1A 9A 89 E2
01E0 | 28 0C D3 E4 0B E0 4A 30 7D 3E 81 3D 07 A6 18 4A
01F0 | 7F 7A C6 D1 5E 9C 29 11 00 7D B4 89 78 C3 8B 6A
0200 | C7 CD CF E8 6D 7E F4 3A 91 33 07 7E 62 6D 8D 58
0210 | 76 87 2C 70 29 B6 3C 99 C2 E5 61 5D 28 4A 8F 0C
0220 | F9 7F 81 D2 BC 89 F5 26 4F ED 1C 67 58 A6 6A FA
0230 | D8 CB 6E 9A 24 58 FA A9 15 D0 C3 29 5D 6F 5C 43
0240 | 2B 2C 25 B2 4F 95 6C 7E 24 8C E5 33 54 2F A2 CA
0250 | D4 C8 F3 31 FC 35 B2 FF EE 02 69 2B 34 AD 1F 9F
0260 | 59 55 45 B3 7D C0 66 F1 16 F7 55 CA FC F8 2B DC
0270 | 2B E4 10 2C 5A 04 2C 1C 78 5B C2 C2 D3 D9 01 19
0280 | 0A A7 E9 2A 8A 8A E7 60 86 EF 43 D5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01AC2BC44550AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0020000</code> (688 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020019EC16F880DB0B8F177A3868</code> <code>C4559E6F5EAAB5BB6B2A02744544F9D7</code> <code>4EDACE3C51222E6B8790F11600498258</code> <code>B4F3404545E5E5816C297C81613D22F0</code> <code>F4361E700D574D44487804C186463392</code> <code>F50732E9F30301A1F9379CF3FB6C4703</code> <code>89C0BF0794F1E70BAF34B4F20C909B2E</code> <code>4399AF1246A9F0C0BDDCE9BFB98DA237</code> <code>28F1DDDFC4BC7A32C11F82E4EBC221AB</code> <code>9E7B8AE8DA166557DF633168376FE57A</code> <code>9665A84C14339B907EDE3C75C0B85598</code> <code>B28BB430DC58EFB5060BA7C98AF50F42</code> <code>E625B24DF4AB65EF7AD889110D9147FC</code> <code>6C8F67D5BD4C7400BF9F994F9F776D39</code> <code>A45999BE9FF37B18B7525976C0C60D5E</code> <code>1DF895D5180944ACA9648B2EBA575444</code> <code>8686DFA7E6FBFA6F7B3F7B50D3486811</code> <code>19D899A46091CF5AE86A001D04BF2CCF</code> <code>612E8D434EC42B96204BBFB442C330E3</code> <code>217ED9CE0380E8EB30F263F02F261C7C</code> <code>E5AB4B0D1DE1ECDF1A8B111732D7104E</code> <code>EF8A7AC6AF7E46E84BE5E23DFDEDDABC</code> <code>E81EC698B1A576B91579591DCD3733AB</code> <code>AC4200D20FAFD69AD35055186354C54E</code> <code>57607C1537397FA61155B8DF57FF9FC2</code> <code>F32E457F42429B48E58CC4F007BF633A</code> <code>DCDEAE691A9A89E2280CD3E40BE04A30</code> <code>7D3E813D07A6184A7F7AC6D15E9C2911</code> <code>007DB48978C38B6AC7CDCFE86D7EF43A</code> <code>9133077E626D8D5876872C7029B63C99</code> <code>C2E5615D284A8F0CF97F81D2BC89F526</code> <code>4FED1C6758A66AFAD8CB6E9A2458FAA9</code> <code>15D0C3295D6F5C432B2C25B24F956C7E</code> <code>248CE533542FA2CAD4C8F331FC35B2FF</code> <code>EE02692B34AD1F9F595545B37DC066F1</code> <code>16F755CAFCF82BDC2BE4102C5A042C1C</code> <code>785BC2C2D3D901190AA7E92A8A8AE760</code><br> <code>86EF43D5</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 19EC16F880DB0B8F177A3868C4559E6F5EAAB5BB6B2A02744544F9D74EDACE3C51222E6B8790F11600498258B4F3404545E5E5816C297C81613D22F0F4361E700D574D44487804C186463392F50732E9F30301A1F9379CF3FB6C470389C0BF0794F1E70BAF34B4F20C909B2E4399AF1246A9F0C0BDDCE9BFB98DA23728F1DDDFC4BC7A32C11F82E4EBC221AB9E7B8AE8DA166557DF633168376FE57A9665A84C14339B907EDE3C75C0B85598B28BB430DC58EFB5060BA7C98AF50F42E625B24DF4AB65EF7AD889110D9147FC6C8F67D5BD4C7400BF9F994F9F776D39A45999BE9FF37B18B7525976C0C60D5E1DF895D5180944ACA9648B2EBA5754448686DFA7E6FBFA6F7B3F7B50D348681119D899A46091CF5AE86A001D04BF2CCF612E8D434EC42B96204BBFB442C330E3217ED9CE0380E8EB30F263F02F261C7CE5AB4B0D1DE1ECDF1A8B111732D7104EEF8A7AC6AF7E46E84BE5E23DFDEDDABCE81EC698B1A576B91579591DCD3733ABAC4200D20FAFD69AD35055186354C54E57607C1537397FA61155B8DF57FF9FC2F32E457F42429B48E58CC4F007BF633ADCDEAE691A9A89E2280CD3E40BE04A307D3E813D07A6184A7F7AC6D15E9C2911007DB48978C38B6AC7CDCFE86D7EF43A9133077E626D8D5876872C7029B63C99C2E5615D284A8F0CF97F81D2BC89F5264FED1C6758A66AFAD8CB6E9A2458FAA915D0C3295D6F5C432B2C25B24F956C7E248CE533542FA2CAD4C8F331FC35B2FFEE02692B34AD1F9F595545B37DC066F116F755CAFCF82BDC2BE4102C5A042C1C785BC2C2D3D901190AA7E92A8A8AE76086EF43D5
tmp_aes_key = B95F44958D683B3A8A09C088941CCC6A5CD73B89A57E9BE072534FBA65DF05C2
tmp_aes_iv = 3AA4C62218DE342CE601730DA19A89BAE878CFB77912FF7AC45C512CAF07B0E4</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 19F30D25A28063FD4B727509378CEBF50978FBC6BA0D89B5AF927133BFB031EB62FEBBE2C89D607C6396F11CB017840FA1065DD9F308DE8F03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004F88F00B50A5BB7C2A5A99BC577C9F998C46963E3591827E8A2C60D4D4D0E475985663FE30D7593FF91121E8AB3FFC5000D1CD57766FD45AA8AA99217D915AA398947080CAF43CCF0BD856B2C0F95D4EF7E48E842B55D710483A155462CC1A40EE1915FA67246D49AA39D56F4736CE16FEE19657DFA49582FDB5871757FA89B6A35AC1126F46BA1915E156EDD78FF80914C01466F34D158A9D2CEA9E3F6A27B8369D10FFACE333D67987507CEA9EC8F9638749E14A09F9F315D20E96C1FC2158C2C16615A8FB18ED7D29F3C17C3FB8CAA09415CBAFA81D34C11761308A9DA00EF90C638A8727E1EB182BE4F0F86C0F575A2B74F78443828C905348F50DF799FE4550AE662C71D3F58C74E5FC
answer = BA0D89B5AF927133BFB031EB62FEBBE2C89D607C6396F11CB017840FA1065DD9F308DE8F03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004F88F00B50A5BB7C2A5A99BC577C9F998C46963E3591827E8A2C60D4D4D0E475985663FE30D7593FF91121E8AB3FFC5000D1CD57766FD45AA8AA99217D915AA398947080CAF43CCF0BD856B2C0F95D4EF7E48E842B55D710483A155462CC1A40EE1915FA67246D49AA39D56F4736CE16FEE19657DFA49582FDB5871757FA89B6A35AC1126F46BA1915E156EDD78FF80914C01466F34D158A9D2CEA9E3F6A27B8369D10FFACE333D67987507CEA9EC8F9638749E14A09F9F315D20E96C1FC2158C2C16615A8FB18ED7D29F3C17C3FB8CAA09415CBAFA81D34C11761308A9DA00EF90C638A8727E1EB182BE4F0F86C0F575A2B74F78443828C905348F50DF799FE4550AE662C71D3F58C74E5FC</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 AF 92 71 33 BF B0 31 EB 62 FE BB E2
0010 | C8 9D 60 7C 63 96 F1 1C B0 17 84 0F A1 06 5D D9
0020 | F3 08 DE 8F 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 4F 88 F0 0B 50 A5 BB 7C 2A 5A 99 BC 57 7C 9F 99
0140 | 8C 46 96 3E 35 91 82 7E 8A 2C 60 D4 D4 D0 E4 75
0150 | 98 56 63 FE 30 D7 59 3F F9 11 21 E8 AB 3F FC 50
0160 | 00 D1 CD 57 76 6F D4 5A A8 AA 99 21 7D 91 5A A3
0170 | 98 94 70 80 CA F4 3C CF 0B D8 56 B2 C0 F9 5D 4E
0180 | F7 E4 8E 84 2B 55 D7 10 48 3A 15 54 62 CC 1A 40
0190 | EE 19 15 FA 67 24 6D 49 AA 39 D5 6F 47 36 CE 16
01A0 | FE E1 96 57 DF A4 95 82 FD B5 87 17 57 FA 89 B6
01B0 | A3 5A C1 12 6F 46 BA 19 15 E1 56 ED D7 8F F8 09
01C0 | 14 C0 14 66 F3 4D 15 8A 9D 2C EA 9E 3F 6A 27 B8
01D0 | 36 9D 10 FF AC E3 33 D6 79 87 50 7C EA 9E C8 F9
01E0 | 63 87 49 E1 4A 09 F9 F3 15 D2 0E 96 C1 FC 21 58
01F0 | C2 C1 66 15 A8 FB 18 ED 7D 29 F3 C1 7C 3F B8 CA
0200 | A0 94 15 CB AF A8 1D 34 C1 17 61 30 8A 9D A0 0E
0210 | F9 0C 63 8A 87 27 E1 EB 18 2B E4 F0 F8 6C 0F 57
0220 | 5A 2B 74 F7 84 43 82 8C 90 53 48 F5 0D F7 99 FE
0230 | 45 50 AE 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001004F88F00B50A5BB7C2A5A99BC</code> <code>577C9F998C46963E3591827E8A2C60D4</code> <code>D4D0E475985663FE30D7593FF91121E8</code> <code>AB3FFC5000D1CD57766FD45AA8AA9921</code> <code>7D915AA398947080CAF43CCF0BD856B2</code> <code>C0F95D4EF7E48E842B55D710483A1554</code> <code>62CC1A40EE1915FA67246D49AA39D56F</code> <code>4736CE16FEE19657DFA49582FDB58717</code> <code>57FA89B6A35AC1126F46BA1915E156ED</code> <code>D78FF80914C01466F34D158A9D2CEA9E</code> <code>3F6A27B8369D10FFACE333D67987507C</code> <code>EA9EC8F9638749E14A09F9F315D20E96</code> <code>C1FC2158C2C16615A8FB18ED7D29F3C1</code> <code>7C3FB8CAA09415CBAFA81D34C1176130</code> <code>8A9DA00EF90C638A8727E1EB182BE4F0</code> <code>F86C0F575A2B74F78443828C905348F5</code><br> <code>0DF799FE</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>4550AE66</code> (1722699845 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 9E0F661F51CFCEA725204E0BC8EE07434281C45F0829057E6B54C35954FD88DCFB15191139F03D023A587E5AD19D69CCC714F3B7A45F60DD9470E0E3323ED3C7DEA460C195F2BF4658FDF65581C9252B8A7F2B18E3B5637CB280D90D233B0B898C1FA41106C99D19AA0D9E618329D167D26252BD31F67AB6955B2523242E093709116FB6559051CA49610442415D61DBCE23DA79D03222B7CDB63F6D8602C832F45EF55A910599232FBCF42E6B6CDC5B1A4EC272BC6C4AF08CEEC79E6066AD74DB5017FE805DADBB81736F9F6689A13549449C89136BFAA5E1617C0B5A3CA4BAF6D81015EC69E0FE772E1882189F82D795E7FF870D90102EB149939AB15925F0</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 6EC768DEBBCAFBBEED730BC12F128C848FFAD34D06C4D58D9649F65C797554262AFDDD09A07B03912499D8AF66CB520770DF2B64FDAB3EE527145ED356FE40609E889178EC31195A705A08A21707002B5EA34504805B4072D1165B33A9E2A4B568F922BC1D0B8CB8F4DBDC350939417AE18ADA16CF24B9C221F20BF35F50964D39524F0D73F69BAE714CAB70138C0FC5ACD587EB27049ECC6E46CDBF47AF9EA0B46F5AC839661F7BF27DA27DA24339A0F5FF97F4FC46ACFEA7A64079D6215AC5F85B5AB1F0C69FCF14DCB59E41C01757DE2999020E56143AF7BF8344C58C8F88B1DF349F6025765D6C15ED449D6ABB61E2A0B23D4A56DF1E6A1BFAA2F1337D72</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 AF 92 71 33 BF B0 31 EB 62 FE BB E2
0010 | C8 9D 60 7C 63 96 F1 1C B0 17 84 0F A1 06 5D D9
0020 | F3 08 DE 8F 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 6E C7 68 DE BB CA FB BE ED 73 0B C1 2F 12 8C 84
0040 | 8F FA D3 4D 06 C4 D5 8D 96 49 F6 5C 79 75 54 26
0050 | 2A FD DD 09 A0 7B 03 91 24 99 D8 AF 66 CB 52 07
0060 | 70 DF 2B 64 FD AB 3E E5 27 14 5E D3 56 FE 40 60
0070 | 9E 88 91 78 EC 31 19 5A 70 5A 08 A2 17 07 00 2B
0080 | 5E A3 45 04 80 5B 40 72 D1 16 5B 33 A9 E2 A4 B5
0090 | 68 F9 22 BC 1D 0B 8C B8 F4 DB DC 35 09 39 41 7A
00A0 | E1 8A DA 16 CF 24 B9 C2 21 F2 0B F3 5F 50 96 4D
00B0 | 39 52 4F 0D 73 F6 9B AE 71 4C AB 70 13 8C 0F C5
00C0 | AC D5 87 EB 27 04 9E CC 6E 46 CD BF 47 AF 9E A0
00D0 | B4 6F 5A C8 39 66 1F 7B F2 7D A2 7D A2 43 39 A0
00E0 | F5 FF 97 F4 FC 46 AC FE A7 A6 40 79 D6 21 5A C5
00F0 | F8 5B 5A B1 F0 C6 9F CF 14 DC B5 9E 41 C0 17 57
0100 | DE 29 99 02 0E 56 14 3A F7 BF 83 44 C5 8C 8F 88
0110 | B1 DF 34 9F 60 25 76 5D 6C 15 ED 44 9D 6A BB 61
0120 | E2 A0 B2 3D 4A 56 DF 1E 6A 1B FA A2 F1 33 7D 72</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001006EC768DEBBCAFBBEED730BC1</code> <code>2F128C848FFAD34D06C4D58D9649F65C</code> <code>797554262AFDDD09A07B03912499D8AF</code> <code>66CB520770DF2B64FDAB3EE527145ED3</code> <code>56FE40609E889178EC31195A705A08A2</code> <code>1707002B5EA34504805B4072D1165B33</code> <code>A9E2A4B568F922BC1D0B8CB8F4DBDC35</code> <code>0939417AE18ADA16CF24B9C221F20BF3</code> <code>5F50964D39524F0D73F69BAE714CAB70</code> <code>138C0FC5ACD587EB27049ECC6E46CDBF</code> <code>47AF9EA0B46F5AC839661F7BF27DA27D</code> <code>A24339A0F5FF97F4FC46ACFEA7A64079</code> <code>D6215AC5F85B5AB1F0C69FCF14DCB59E</code> <code>41C01757DE2999020E56143AF7BF8344</code> <code>C58C8F88B1DF349F6025765D6C15ED44</code> <code>9D6ABB61E2A0B23D4A56DF1E6A1BFAA2</code><br> <code>F1337D72</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366AF927133BFB031EB62FEBBE2C89D607C6396F11CB017840FA1065DD9F308DE8F0000000000000000FE0001006EC768DEBBCAFBBEED730BC12F128C848FFAD34D06C4D58D9649F65C797554262AFDDD09A07B03912499D8AF66CB520770DF2B64FDAB3EE527145ED356FE40609E889178EC31195A705A08A21707002B5EA34504805B4072D1165B33A9E2A4B568F922BC1D0B8CB8F4DBDC350939417AE18ADA16CF24B9C221F20BF35F50964D39524F0D73F69BAE714CAB70138C0FC5ACD587EB27049ECC6E46CDBF47AF9EA0B46F5AC839661F7BF27DA27DA24339A0F5FF97F4FC46ACFEA7A64079D6215AC5F85B5AB1F0C69FCF14DCB59E41C01757DE2999020E56143AF7BF8344C58C8F88B1DF349F6025765D6C15ED449D6ABB61E2A0B23D4A56DF1E6A1BFAA2F1337D72
padding = 180010567E76A8A7704FE13E
tmp_aes_key = B95F44958D683B3A8A09C088941CCC6A5CD73B89A57E9BE072534FBA65DF05C2
tmp_aes_iv = 3AA4C62218DE342CE601730DA19A89BAE878CFB77912FF7AC45C512CAF07B0E4</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 71FD580C86931377F1FEEC2CFFFD03D71C055AAEB74B6353BE631D25850AB07A8B5A23232E87519E91B54658F0FEEFB5D63DE1A0BEB130BE9A04B9405E5AD01F73586188BE3FD9F0EEF3A74098173E8F74E6BCCCCC7744ADB92C68704E990962E1CA2341577B1EC7DA8D60E5CDCFAE5EC957AF2DED735CA5B8DFC6507EC2F04C144FFA1CA78AE4E02591D18F322901CAE2CE029DB15FA69C8A60E32930675A93F8A2A739B7889167898B430C638B8BCD8874C9AB611EE8A3EDCED8D2714FD6DB7BA23B559A9F9F33BA7F6FDD1E2552E8EBD201F4BFEE014C1D6EF2A8F5BA439C266ADBD84990C51BBBC6077A55368D2E99249CC5A4217EC78C00C20E99510E7781B90438C8059180D6E195B3D99908A3D1443B130A92CD272E24FD7DE7AFB61807AE43E17A252D41E6E6E73B0E601DF70494742AF87588AD824E6443ED12A3C3850F69339FF5DE9A13E8DB10EBE170D0</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C 99 0C 00 45 50 AE 66
0010 | 78 01 00 00 1F 5F 04 F5 AF 92 71 33 BF B0 31 EB
0020 | 62 FE BB E2 C8 9D 60 7C 63 96 F1 1C B0 17 84 0F
0030 | A1 06 5D D9 F3 08 DE 8F FE 50 01 00 71 FD 58 0C
0040 | 86 93 13 77 F1 FE EC 2C FF FD 03 D7 1C 05 5A AE
0050 | B7 4B 63 53 BE 63 1D 25 85 0A B0 7A 8B 5A 23 23
0060 | 2E 87 51 9E 91 B5 46 58 F0 FE EF B5 D6 3D E1 A0
0070 | BE B1 30 BE 9A 04 B9 40 5E 5A D0 1F 73 58 61 88
0080 | BE 3F D9 F0 EE F3 A7 40 98 17 3E 8F 74 E6 BC CC
0090 | CC 77 44 AD B9 2C 68 70 4E 99 09 62 E1 CA 23 41
00A0 | 57 7B 1E C7 DA 8D 60 E5 CD CF AE 5E C9 57 AF 2D
00B0 | ED 73 5C A5 B8 DF C6 50 7E C2 F0 4C 14 4F FA 1C
00C0 | A7 8A E4 E0 25 91 D1 8F 32 29 01 CA E2 CE 02 9D
00D0 | B1 5F A6 9C 8A 60 E3 29 30 67 5A 93 F8 A2 A7 39
00E0 | B7 88 91 67 89 8B 43 0C 63 8B 8B CD 88 74 C9 AB
00F0 | 61 1E E8 A3 ED CE D8 D2 71 4F D6 DB 7B A2 3B 55
0100 | 9A 9F 9F 33 BA 7F 6F DD 1E 25 52 E8 EB D2 01 F4
0110 | BF EE 01 4C 1D 6E F2 A8 F5 BA 43 9C 26 6A DB D8
0120 | 49 90 C5 1B BB C6 07 7A 55 36 8D 2E 99 24 9C C5
0130 | A4 21 7E C7 8C 00 C2 0E 99 51 0E 77 81 B9 04 38
0140 | C8 05 91 80 D6 E1 95 B3 D9 99 08 A3 D1 44 3B 13
0150 | 0A 92 CD 27 2E 24 FD 7D E7 AF B6 18 07 AE 43 E1
0160 | 7A 25 2D 41 E6 E6 E7 3B 0E 60 1D F7 04 94 74 2A
0170 | F8 75 88 AD 82 4E 64 43 ED 12 A3 C3 85 0F 69 33
0180 | 9F F5 DE 9A 13 E8 DB 10 EB E1 70 D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7C990C004550AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010071FD580C86931377F1FEEC2C</code> <code>FFFD03D71C055AAEB74B6353BE631D25</code> <code>850AB07A8B5A23232E87519E91B54658</code> <code>F0FEEFB5D63DE1A0BEB130BE9A04B940</code> <code>5E5AD01F73586188BE3FD9F0EEF3A740</code> <code>98173E8F74E6BCCCCC7744ADB92C6870</code> <code>4E990962E1CA2341577B1EC7DA8D60E5</code> <code>CDCFAE5EC957AF2DED735CA5B8DFC650</code> <code>7EC2F04C144FFA1CA78AE4E02591D18F</code> <code>322901CAE2CE029DB15FA69C8A60E329</code> <code>30675A93F8A2A739B7889167898B430C</code> <code>638B8BCD8874C9AB611EE8A3EDCED8D2</code> <code>714FD6DB7BA23B559A9F9F33BA7F6FDD</code> <code>1E2552E8EBD201F4BFEE014C1D6EF2A8</code> <code>F5BA439C266ADBD84990C51BBBC6077A</code> <code>55368D2E99249CC5A4217EC78C00C20E</code> <code>99510E7781B90438C8059180D6E195B3</code> <code>D99908A3D1443B130A92CD272E24FD7D</code> <code>E7AFB61807AE43E17A252D41E6E6E73B</code> <code>0E601DF70494742AF87588AD824E6443</code> <code>ED12A3C3850F69339FF5DE9A13E8DB10</code><br> <code>EBE170D0</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 6DF3C5B8246084FC9F2C3492FD3C06910871F7FB5F27E4F826A4F832E4AD5AE313C0D2BB98B20F892EA21FB4ADB494E44A3A95F162341B3C86E47086C0C0D50F768936DF8429B55CEBC066C6D0EF5EB6D247E3018D47203DCF9A5DC0BFC7B89CAA7E05D2466088A805C54462FAFE42E8BE591954B6C267E53845E0859B8BCF84E61411B38B19A039012300192C65B0B210EDB2640D36147722D73ED208C2D2B6EE77637A78C4A739217ADBCD4BEA8869E2DA272BF12919515649DC4C19369FDC129103EA2A61B3B792F5F7DE5E3CD8655C0B96B4E54579D19E79C3EEA2F50552F7DD08F5EE39A1E890CB30E3DF4531C7267A66626472475FD5E3D928A1EA4DF8</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 10 9A 55 46 50 AE 66
0010 | 70 00 00 00 34 F7 CB 3B AF 92 71 33 BF B0 31 EB
0020 | 62 FE BB E2 C8 9D 60 7C 63 96 F1 1C B0 17 84 0F
0030 | A1 06 5D D9 F3 08 DE 8F CD B9 26 41 D5 19 38 54
0040 | 67 85 AE F3 77 86 62 EE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01109A554650AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>70000000</code> (112 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>AF927133BFB031EB62FEBBE2C89D607C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6396F11CB017840FA1065DD9F308DE8F</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>CDB92641D51938546785AEF3778662EE</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

