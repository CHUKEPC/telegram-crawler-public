<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 14 5F 0E 00 99 BD D1 68
0010 | 14 00 00 00 F1 8E 7E BE C8 77 CF 24 B1 14 5A 5C
0020 | 34 8B 48 EC 97 09 62 3D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>145F0E0099BDD168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C8 4A 13 9A BD D1 68
0010 | 50 00 00 00 63 24 16 05 C8 77 CF 24 B1 14 5A 5C
0020 | 34 8B 48 EC 97 09 62 3D F2 91 A3 A2 39 8F EC 75
0030 | 71 58 FA 8F C5 56 6B 3E 08 1F B0 D0 0B F1 EB 87
0040 | 81 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C84A139ABDD168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081FB0D00BF1EB8781000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2283553760798803841</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2283553760798803841</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2283553760798803841 = 1336234987 * 1708946243</code></p>
<pre><code>p = 1336234987
q = 1708946243</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1F B0 D0 0B F1 EB 87 81 00 00 00
0010 | 04 4F A5 53 EB 00 00 00 04 65 DC 73 43 00 00 00
0020 | C8 77 CF 24 B1 14 5A 5C 34 8B 48 EC 97 09 62 3D
0030 | F2 91 A3 A2 39 8F EC 75 71 58 FA 8F C5 56 6B 3E
0040 | 6E C5 80 C9 85 8C 79 43 BE B2 61 47 8C D3 17 97
0050 | 12 61 7E EB F2 A1 2A F7 D8 35 8C 86 C5 68 F2 F2
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081FB0D00BF1EB8781000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2283553760798803841</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044FA553EB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1336234987</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0465DC7343000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1708946243</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>6EC580C9858C7943BEB261478CD31797</code> <code>12617EEBF2A12AF7D8358C86C568F2F2</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081FB0D00BF1EB8781000000044FA553EB0000000465DC7343000000C877CF24B1145A5C348B48EC9709623DF291A3A2398FEC757158FA8FC5566B3E6EC580C9858C7943BEB261478CD3179712617EEBF2A12AF7D8358C86C568F2F202000000
random_padding_bytes = 247D4E11053ADCB07C46156915610BC1219BEE79B26231242BE9056AA8EF3640B61B0CBDBAE0B4B636F8DA11F0FA59B502594B69FC3C10F6C863F2E20427EBFF3F4ED2BD037C05D45F122C990742D422A8D929B5C915EE8EA7B3A6D7</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 8988B1C842C21B847E4508E2275B5498F0B4E035FC13000E541A2FE85127ACACA6DE9165640072D12B70489DF02801D22A8694710577BFC06546929180EA8971D55A8634E7700EBFCD68E81C829691190CC809D226CF1B4A76709C95C0602FBDF4F6EB9DF2A1C4F320684F12AB619D4685ED3F5A224EAF3916C7BC57DAD7A10B8338BD22C4DA1D7BADA876E21F8D76E4DF97B69A64E587A60F1500F1B5F63EC023ABA936885D3B24D86D70D8908D729249314CB28CEA4DF35C88429EC578260C444A5A188CF413895F71238913D98E5A2F52781565FA9FC0FBB2B5831DD952022455541D889BC9CE40A74316A5F889568587DC08E1407B2E2E4AF611CD0FE342</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 54 3F 05 00 9A BD D1 68
0010 | 40 01 00 00 BE E4 12 D7 C8 77 CF 24 B1 14 5A 5C
0020 | 34 8B 48 EC 97 09 62 3D F2 91 A3 A2 39 8F EC 75
0030 | 71 58 FA 8F C5 56 6B 3E 04 4F A5 53 EB 00 00 00
0040 | 04 65 DC 73 43 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 89 88 B1 C8 42 C2 1B 84 7E 45 08 E2
0060 | 27 5B 54 98 F0 B4 E0 35 FC 13 00 0E 54 1A 2F E8
0070 | 51 27 AC AC A6 DE 91 65 64 00 72 D1 2B 70 48 9D
0080 | F0 28 01 D2 2A 86 94 71 05 77 BF C0 65 46 92 91
0090 | 80 EA 89 71 D5 5A 86 34 E7 70 0E BF CD 68 E8 1C
00A0 | 82 96 91 19 0C C8 09 D2 26 CF 1B 4A 76 70 9C 95
00B0 | C0 60 2F BD F4 F6 EB 9D F2 A1 C4 F3 20 68 4F 12
00C0 | AB 61 9D 46 85 ED 3F 5A 22 4E AF 39 16 C7 BC 57
00D0 | DA D7 A1 0B 83 38 BD 22 C4 DA 1D 7B AD A8 76 E2
00E0 | 1F 8D 76 E4 DF 97 B6 9A 64 E5 87 A6 0F 15 00 F1
00F0 | B5 F6 3E C0 23 AB A9 36 88 5D 3B 24 D8 6D 70 D8
0100 | 90 8D 72 92 49 31 4C B2 8C EA 4D F3 5C 88 42 9E
0110 | C5 78 26 0C 44 4A 5A 18 8C F4 13 89 5F 71 23 89
0120 | 13 D9 8E 5A 2F 52 78 15 65 FA 9F C0 FB B2 B5 83
0130 | 1D D9 52 02 24 55 54 1D 88 9B C9 CE 40 A7 43 16
0140 | A5 F8 89 56 85 87 DC 08 E1 40 7B 2E 2E 4A F6 11
0150 | CD 0F E3 42</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>543F05009ABDD168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044FA553EB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1336234987</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0465DC7343000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1708946243</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001008988B1C842C21B847E4508E2</code> <code>275B5498F0B4E035FC13000E541A2FE8</code> <code>5127ACACA6DE9165640072D12B70489D</code> <code>F02801D22A8694710577BFC065469291</code> <code>80EA8971D55A8634E7700EBFCD68E81C</code> <code>829691190CC809D226CF1B4A76709C95</code> <code>C0602FBDF4F6EB9DF2A1C4F320684F12</code> <code>AB619D4685ED3F5A224EAF3916C7BC57</code> <code>DAD7A10B8338BD22C4DA1D7BADA876E2</code> <code>1F8D76E4DF97B69A64E587A60F1500F1</code> <code>B5F63EC023ABA936885D3B24D86D70D8</code> <code>908D729249314CB28CEA4DF35C88429E</code> <code>C578260C444A5A188CF413895F712389</code> <code>13D98E5A2F52781565FA9FC0FBB2B583</code> <code>1DD952022455541D889BC9CE40A74316</code> <code>A5F889568587DC08E1407B2E2E4AF611</code><br> <code>CD0FE342</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 6C 70 4A 9A BD D1 68
0010 | 78 02 00 00 5C 07 E8 D0 C8 77 CF 24 B1 14 5A 5C
0020 | 34 8B 48 EC 97 09 62 3D F2 91 A3 A2 39 8F EC 75
0030 | 71 58 FA 8F C5 56 6B 3E FE 50 02 00 12 BD B7 B4
0040 | DE 87 70 86 1A 1E DB 1D D6 A2 3A 5E 02 C1 3F 14
0050 | 45 90 7E 4A D6 2C 98 B5 43 A5 BF DD 88 92 B5 12
0060 | 37 91 14 04 B1 27 2D 39 48 D6 B6 67 26 F8 08 50
0070 | 1E 7A B8 CC 24 88 56 64 44 10 6C 02 06 12 B6 41
0080 | 3E 85 38 94 B7 4D C3 12 03 4B A7 7E 19 9C 7D 90
0090 | E8 5A EE 51 B2 47 EC FA CF 8F 33 B0 3A 3F 63 54
00A0 | 09 A8 C4 29 FA 36 E7 8C 72 CA 7D F9 A5 03 AA 1C
00B0 | C5 B1 1E 2D 0A 26 B4 42 8B 1D 89 E5 1A DC B3 0A
00C0 | 49 30 00 3D 76 18 D8 27 54 B2 3A 08 41 10 70 AF
00D0 | F1 2D 5D FE 1D 9C 34 25 E4 CA A3 31 72 71 EF 17
00E0 | ED 25 09 7C B3 D3 F0 B5 C2 EF 5D 41 8E 53 04 47
00F0 | FE 37 4E 40 53 31 69 A6 C2 64 21 BF 28 9A 69 D3
0100 | 08 FD DB 2F 31 CF FE 58 AA DE 14 F2 E5 B1 A9 B0
0110 | 23 B8 FA 21 89 D7 C4 0D C7 D2 20 1A DF B7 9A 94
0120 | 47 D7 34 DA 82 86 17 3C F9 0C 97 6E 3C 17 A3 18
0130 | A4 30 42 DC 4A A1 E2 DE 7C 0F 02 4B 11 24 DD 8A
0140 | 9F D3 55 68 E2 4D 58 2B 4F E5 11 73 B3 A3 BE 95
0150 | 83 1F B3 AA F4 8E E8 2E 6C 51 F9 36 DE EE DF 56
0160 | 13 47 E9 DC 68 FD 90 09 3F D7 9E 4C 6B 2C 7D AA
0170 | 5F 28 9B 1D ED 80 C8 FE 72 79 EC 0C 22 BF 6D 13
0180 | BB 54 9B 13 F5 D3 2F 6F 36 2B 28 FA 25 83 34 C8
0190 | 19 15 C6 B5 AB 7F 2D E6 9A 90 0C 5A C1 C0 0A 86
01A0 | CC BF 04 6E D1 9C 1F D0 E1 44 48 83 9C 2F DE C2
01B0 | 1C 57 46 C6 8B F3 30 7B 48 11 C1 2E D2 5B 88 9B
01C0 | 5D 3A 76 F1 95 BE 37 66 3C 86 4C D9 D6 7E 45 97
01D0 | EB 5A 57 D0 25 86 47 D8 2D 8C C1 5C 78 A0 BB 8B
01E0 | 1F 5F DF 6B 0E 65 B7 CE C2 50 C8 04 7D 88 11 FF
01F0 | C1 6A 4B 38 79 6D 8F 94 4D E2 57 DC 1C 9A 1F 80
0200 | F9 13 72 EC A3 20 BC FA 0E 69 6B 24 17 9C F7 0D
0210 | C3 EE A1 E9 04 CA A8 C3 7E 67 09 C3 67 2F F2 83
0220 | 6C 9B AE D3 40 01 DD 9C 53 C2 67 D7 F1 4D 8E CF
0230 | 82 A7 84 CB 40 1C 6C B5 08 34 56 27 DB 11 EA DB
0240 | 85 D0 FE BE FF 6C A4 8A F4 6A 66 43 7C 26 A8 28
0250 | 20 C9 3E CD 82 9B 3D E6 38 D1 21 81 52 7B D8 83
0260 | C7 DE 08 94 B3 7A 07 03 8B 84 DE 8F 4F 5E E9 F3
0270 | 4E 54 50 AF 44 C3 93 BF E4 54 BD 59 B8 5F 18 9D
0280 | 22 E5 B0 95 51 62 A2 81 86 EC 1B BD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>016C704A9ABDD168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020012BDB7B4DE8770861A1EDB1D</code> <code>D6A23A5E02C13F1445907E4AD62C98B5</code> <code>43A5BFDD8892B51237911404B1272D39</code> <code>48D6B66726F808501E7AB8CC24885664</code> <code>44106C020612B6413E853894B74DC312</code> <code>034BA77E199C7D90E85AEE51B247ECFA</code> <code>CF8F33B03A3F635409A8C429FA36E78C</code> <code>72CA7DF9A503AA1CC5B11E2D0A26B442</code> <code>8B1D89E51ADCB30A4930003D7618D827</code> <code>54B23A08411070AFF12D5DFE1D9C3425</code> <code>E4CAA3317271EF17ED25097CB3D3F0B5</code> <code>C2EF5D418E530447FE374E40533169A6</code> <code>C26421BF289A69D308FDDB2F31CFFE58</code> <code>AADE14F2E5B1A9B023B8FA2189D7C40D</code> <code>C7D2201ADFB79A9447D734DA8286173C</code> <code>F90C976E3C17A318A43042DC4AA1E2DE</code> <code>7C0F024B1124DD8A9FD35568E24D582B</code> <code>4FE51173B3A3BE95831FB3AAF48EE82E</code> <code>6C51F936DEEEDF561347E9DC68FD9009</code> <code>3FD79E4C6B2C7DAA5F289B1DED80C8FE</code> <code>7279EC0C22BF6D13BB549B13F5D32F6F</code> <code>362B28FA258334C81915C6B5AB7F2DE6</code> <code>9A900C5AC1C00A86CCBF046ED19C1FD0</code> <code>E14448839C2FDEC21C5746C68BF3307B</code> <code>4811C12ED25B889B5D3A76F195BE3766</code> <code>3C864CD9D67E4597EB5A57D0258647D8</code> <code>2D8CC15C78A0BB8B1F5FDF6B0E65B7CE</code> <code>C250C8047D8811FFC16A4B38796D8F94</code> <code>4DE257DC1C9A1F80F91372ECA320BCFA</code> <code>0E696B24179CF70DC3EEA1E904CAA8C3</code> <code>7E6709C3672FF2836C9BAED34001DD9C</code> <code>53C267D7F14D8ECF82A784CB401C6CB5</code> <code>08345627DB11EADB85D0FEBEFF6CA48A</code> <code>F46A66437C26A82820C93ECD829B3DE6</code> <code>38D12181527BD883C7DE0894B37A0703</code> <code>8B84DE8F4F5EE9F34E5450AF44C393BF</code> <code>E454BD59B85F189D22E5B0955162A281</code><br> <code>86EC1BBD</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 12BDB7B4DE8770861A1EDB1DD6A23A5E02C13F1445907E4AD62C98B543A5BFDD8892B51237911404B1272D3948D6B66726F808501E7AB8CC2488566444106C020612B6413E853894B74DC312034BA77E199C7D90E85AEE51B247ECFACF8F33B03A3F635409A8C429FA36E78C72CA7DF9A503AA1CC5B11E2D0A26B4428B1D89E51ADCB30A4930003D7618D82754B23A08411070AFF12D5DFE1D9C3425E4CAA3317271EF17ED25097CB3D3F0B5C2EF5D418E530447FE374E40533169A6C26421BF289A69D308FDDB2F31CFFE58AADE14F2E5B1A9B023B8FA2189D7C40DC7D2201ADFB79A9447D734DA8286173CF90C976E3C17A318A43042DC4AA1E2DE7C0F024B1124DD8A9FD35568E24D582B4FE51173B3A3BE95831FB3AAF48EE82E6C51F936DEEEDF561347E9DC68FD90093FD79E4C6B2C7DAA5F289B1DED80C8FE7279EC0C22BF6D13BB549B13F5D32F6F362B28FA258334C81915C6B5AB7F2DE69A900C5AC1C00A86CCBF046ED19C1FD0E14448839C2FDEC21C5746C68BF3307B4811C12ED25B889B5D3A76F195BE37663C864CD9D67E4597EB5A57D0258647D82D8CC15C78A0BB8B1F5FDF6B0E65B7CEC250C8047D8811FFC16A4B38796D8F944DE257DC1C9A1F80F91372ECA320BCFA0E696B24179CF70DC3EEA1E904CAA8C37E6709C3672FF2836C9BAED34001DD9C53C267D7F14D8ECF82A784CB401C6CB508345627DB11EADB85D0FEBEFF6CA48AF46A66437C26A82820C93ECD829B3DE638D12181527BD883C7DE0894B37A07038B84DE8F4F5EE9F34E5450AF44C393BFE454BD59B85F189D22E5B0955162A28186EC1BBD
tmp_aes_key = E268F9812B69759377A1667AA1011E26B5CE873F3870C56BBB5FEC961B54FF4E
tmp_aes_iv = 41ECDC4E8EDBF9C1DF0D4B6D30F0CF52401ACF44B6BDFAD52437B2F76EC580C9</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1ADF6D1946017D9B46045889106CDAD3F2791977BA0D89B5C877CF24B1145A5C348B48EC9709623DF291A3A2398FEC757158FA8FC5566B3E03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003A0589CA7C4D69588547EBA0F83A818F485E54C43FBB4B330760E51B0C0DF0E07D22E2C1E8F25A346EE4A6F8B7DDA68A44F454A5F18589CD9F5E38E9509C6061D9603681ECC4E70099DA597AB26828193FD5BD9FD6A7ECFF725FB285BE584A80FCE6F4F91C143F6E07D6311711A54CC132018E2B97E479C73F9ED86D8B6CBAFFD90812EA463C0D76100C2D1B34A07632F9A6F0C8D4E8B71E62AFCE2C4250C32CD093507FDF45AE8CA148B366123F08F6E50A1ED134466538661055534543608908009A6FFBA9D3637576FD3A00BF7BCA0DADE698C65763D056BBF0F21E8FF565F0C76EC93C4955209A76075EF66689657460BB746152BEBB0720A03CD47A92029ABDD16859190F776D8CE251
answer = BA0D89B5C877CF24B1145A5C348B48EC9709623DF291A3A2398FEC757158FA8FC5566B3E03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003A0589CA7C4D69588547EBA0F83A818F485E54C43FBB4B330760E51B0C0DF0E07D22E2C1E8F25A346EE4A6F8B7DDA68A44F454A5F18589CD9F5E38E9509C6061D9603681ECC4E70099DA597AB26828193FD5BD9FD6A7ECFF725FB285BE584A80FCE6F4F91C143F6E07D6311711A54CC132018E2B97E479C73F9ED86D8B6CBAFFD90812EA463C0D76100C2D1B34A07632F9A6F0C8D4E8B71E62AFCE2C4250C32CD093507FDF45AE8CA148B366123F08F6E50A1ED134466538661055534543608908009A6FFBA9D3637576FD3A00BF7BCA0DADE698C65763D056BBF0F21E8FF565F0C76EC93C4955209A76075EF66689657460BB746152BEBB0720A03CD47A92029ABDD16859190F776D8CE251</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 C8 77 CF 24 B1 14 5A 5C 34 8B 48 EC
0010 | 97 09 62 3D F2 91 A3 A2 39 8F EC 75 71 58 FA 8F
0020 | C5 56 6B 3E 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 3A 05 89 CA 7C 4D 69 58 85 47 EB A0 F8 3A 81 8F
0140 | 48 5E 54 C4 3F BB 4B 33 07 60 E5 1B 0C 0D F0 E0
0150 | 7D 22 E2 C1 E8 F2 5A 34 6E E4 A6 F8 B7 DD A6 8A
0160 | 44 F4 54 A5 F1 85 89 CD 9F 5E 38 E9 50 9C 60 61
0170 | D9 60 36 81 EC C4 E7 00 99 DA 59 7A B2 68 28 19
0180 | 3F D5 BD 9F D6 A7 EC FF 72 5F B2 85 BE 58 4A 80
0190 | FC E6 F4 F9 1C 14 3F 6E 07 D6 31 17 11 A5 4C C1
01A0 | 32 01 8E 2B 97 E4 79 C7 3F 9E D8 6D 8B 6C BA FF
01B0 | D9 08 12 EA 46 3C 0D 76 10 0C 2D 1B 34 A0 76 32
01C0 | F9 A6 F0 C8 D4 E8 B7 1E 62 AF CE 2C 42 50 C3 2C
01D0 | D0 93 50 7F DF 45 AE 8C A1 48 B3 66 12 3F 08 F6
01E0 | E5 0A 1E D1 34 46 65 38 66 10 55 53 45 43 60 89
01F0 | 08 00 9A 6F FB A9 D3 63 75 76 FD 3A 00 BF 7B CA
0200 | 0D AD E6 98 C6 57 63 D0 56 BB F0 F2 1E 8F F5 65
0210 | F0 C7 6E C9 3C 49 55 20 9A 76 07 5E F6 66 89 65
0220 | 74 60 BB 74 61 52 BE BB 07 20 A0 3C D4 7A 92 02
0230 | 9A BD D1 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001003A0589CA7C4D69588547EBA0</code> <code>F83A818F485E54C43FBB4B330760E51B</code> <code>0C0DF0E07D22E2C1E8F25A346EE4A6F8</code> <code>B7DDA68A44F454A5F18589CD9F5E38E9</code> <code>509C6061D9603681ECC4E70099DA597A</code> <code>B26828193FD5BD9FD6A7ECFF725FB285</code> <code>BE584A80FCE6F4F91C143F6E07D63117</code> <code>11A54CC132018E2B97E479C73F9ED86D</code> <code>8B6CBAFFD90812EA463C0D76100C2D1B</code> <code>34A07632F9A6F0C8D4E8B71E62AFCE2C</code> <code>4250C32CD093507FDF45AE8CA148B366</code> <code>123F08F6E50A1ED13446653866105553</code> <code>4543608908009A6FFBA9D3637576FD3A</code> <code>00BF7BCA0DADE698C65763D056BBF0F2</code> <code>1E8FF565F0C76EC93C4955209A76075E</code> <code>F66689657460BB746152BEBB0720A03C</code><br> <code>D47A9202</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>9ABDD168</code> (1758576026 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = BF320EEF361EA81CDDFC71A6A788AB1686DE9398A5C0F2311729B447D3F017283F229CBCE60F46A162ACC5ECB22C6BE577913B35B4CC8811F942DE585F8B584ED72DAF96E9BB84B02FCE04205CD5394AC9A139A189B1ED9CF6F086F226EF20F87551E521B0538F1690C314D8AF781B556C17B3C0C0DF30E40D193704AC3C4A29E10EF3A4AC7C987B0A837983A9F53734265F6C0BE234482C293019439904E551A5F0A3F039BFED76F95EC5E6EA392F28506CD852DA3A4A9993A24D9DB53B248865F2128FACC25770781A4B04D042074798DB6D550AC9253EB293C272F2D13FCD40123B10CE4CA6F38000714ECAB6B70D16417277130A57CA3ECA80DD9985F549</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 340386BFFF66C8F968FDCED34021C04AD2ED70B0DE4C95D15A9B4F42BB3B19E5796D55C7D0E6A569A45A2D66C7334445189BB0BFD74D32BC4F4CE1E970EED99E120B764A2298006A120710B91C42026FB4BDC2094C324A7ACC1B0C8F6BB1C13316FBD2267A58281607934681AF3DB259B6A47C5BF7CDD763CCC13AC57DFFE7A930D1BC96F0DF91BE15DA6E39DE1077DE0C2B7CC43B3EE0DF96CF507154DD903709AAD9334B91BDF455B6D5FD57F662901953E2435D8DB258C6ABB6BF48794F3B7011EBACFF8DAA18EF24602260B51553630B1D7E82043BDA0512DD8DBC9DC8FB8AC5ADCA1B67A1AC5914B99B3B15A8AE3A96AEF8D1876D0EE0CF990C8C9E9C95</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 C8 77 CF 24 B1 14 5A 5C 34 8B 48 EC
0010 | 97 09 62 3D F2 91 A3 A2 39 8F EC 75 71 58 FA 8F
0020 | C5 56 6B 3E 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 34 03 86 BF FF 66 C8 F9 68 FD CE D3 40 21 C0 4A
0040 | D2 ED 70 B0 DE 4C 95 D1 5A 9B 4F 42 BB 3B 19 E5
0050 | 79 6D 55 C7 D0 E6 A5 69 A4 5A 2D 66 C7 33 44 45
0060 | 18 9B B0 BF D7 4D 32 BC 4F 4C E1 E9 70 EE D9 9E
0070 | 12 0B 76 4A 22 98 00 6A 12 07 10 B9 1C 42 02 6F
0080 | B4 BD C2 09 4C 32 4A 7A CC 1B 0C 8F 6B B1 C1 33
0090 | 16 FB D2 26 7A 58 28 16 07 93 46 81 AF 3D B2 59
00A0 | B6 A4 7C 5B F7 CD D7 63 CC C1 3A C5 7D FF E7 A9
00B0 | 30 D1 BC 96 F0 DF 91 BE 15 DA 6E 39 DE 10 77 DE
00C0 | 0C 2B 7C C4 3B 3E E0 DF 96 CF 50 71 54 DD 90 37
00D0 | 09 AA D9 33 4B 91 BD F4 55 B6 D5 FD 57 F6 62 90
00E0 | 19 53 E2 43 5D 8D B2 58 C6 AB B6 BF 48 79 4F 3B
00F0 | 70 11 EB AC FF 8D AA 18 EF 24 60 22 60 B5 15 53
0100 | 63 0B 1D 7E 82 04 3B DA 05 12 DD 8D BC 9D C8 FB
0110 | 8A C5 AD CA 1B 67 A1 AC 59 14 B9 9B 3B 15 A8 AE
0120 | 3A 96 AE F8 D1 87 6D 0E E0 CF 99 0C 8C 9E 9C 95</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100340386BFFF66C8F968FDCED3</code> <code>4021C04AD2ED70B0DE4C95D15A9B4F42</code> <code>BB3B19E5796D55C7D0E6A569A45A2D66</code> <code>C7334445189BB0BFD74D32BC4F4CE1E9</code> <code>70EED99E120B764A2298006A120710B9</code> <code>1C42026FB4BDC2094C324A7ACC1B0C8F</code> <code>6BB1C13316FBD2267A58281607934681</code> <code>AF3DB259B6A47C5BF7CDD763CCC13AC5</code> <code>7DFFE7A930D1BC96F0DF91BE15DA6E39</code> <code>DE1077DE0C2B7CC43B3EE0DF96CF5071</code> <code>54DD903709AAD9334B91BDF455B6D5FD</code> <code>57F662901953E2435D8DB258C6ABB6BF</code> <code>48794F3B7011EBACFF8DAA18EF246022</code> <code>60B51553630B1D7E82043BDA0512DD8D</code> <code>BC9DC8FB8AC5ADCA1B67A1AC5914B99B</code> <code>3B15A8AE3A96AEF8D1876D0EE0CF990C</code><br> <code>8C9E9C95</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366C877CF24B1145A5C348B48EC9709623DF291A3A2398FEC757158FA8FC5566B3E0000000000000000FE000100340386BFFF66C8F968FDCED34021C04AD2ED70B0DE4C95D15A9B4F42BB3B19E5796D55C7D0E6A569A45A2D66C7334445189BB0BFD74D32BC4F4CE1E970EED99E120B764A2298006A120710B91C42026FB4BDC2094C324A7ACC1B0C8F6BB1C13316FBD2267A58281607934681AF3DB259B6A47C5BF7CDD763CCC13AC57DFFE7A930D1BC96F0DF91BE15DA6E39DE1077DE0C2B7CC43B3EE0DF96CF507154DD903709AAD9334B91BDF455B6D5FD57F662901953E2435D8DB258C6ABB6BF48794F3B7011EBACFF8DAA18EF24602260B51553630B1D7E82043BDA0512DD8DBC9DC8FB8AC5ADCA1B67A1AC5914B99B3B15A8AE3A96AEF8D1876D0EE0CF990C8C9E9C95
padding = 9E94F98663D8E44E06DECD33
tmp_aes_key = E268F9812B69759377A1667AA1011E26B5CE873F3870C56BBB5FEC961B54FF4E
tmp_aes_iv = 41ECDC4E8EDBF9C1DF0D4B6D30F0CF52401ACF44B6BDFAD52437B2F76EC580C9</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 73A194B9163C0B89191567D3A3D2E49ADCEC976091213A824ABEE87BE3A5016C17D078118C5EA2F0E374B19C5D69D9203266C70EE4F4BB12C9CC3FD037AE2B6D4FDA3D6468708A1C935DAA89C0C7570A903F72FF32624988F7CC42E3977B251367F05974B949AE535AA5AB21130EB0FA873561AD5ECFEFF09B490416DE3B17EDEB626C8368D653E0DF28646C2B3B59E18CDA5784D754181EB7CE40FAA8C9223968637FB758749F3EE0FF8ED9293D889D54123607B95910279381DDDD9326CC40492B63A2AB0AD3A24322AECC74311CB3551AD08AA949011142D23AA9C4E355A71BE0D2FA944668DB3754C30F2FBB189745ABB95B888FDB95D6200C672F93806342158EC2A56B4B7CB69712E0A1D5A6241FE1332566DB6E7852C25B5DF19F3D1BDCFB8DA97CF7377A9DA380E502BCFDD2C2DB8D7C34B8CADAED988989CC8AD9AC9EB4D986AADF1B9E3C8C6DCD47FC6C89</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 58 3F 05 00 9A BD D1 68
0010 | 78 01 00 00 1F 5F 04 F5 C8 77 CF 24 B1 14 5A 5C
0020 | 34 8B 48 EC 97 09 62 3D F2 91 A3 A2 39 8F EC 75
0030 | 71 58 FA 8F C5 56 6B 3E FE 50 01 00 73 A1 94 B9
0040 | 16 3C 0B 89 19 15 67 D3 A3 D2 E4 9A DC EC 97 60
0050 | 91 21 3A 82 4A BE E8 7B E3 A5 01 6C 17 D0 78 11
0060 | 8C 5E A2 F0 E3 74 B1 9C 5D 69 D9 20 32 66 C7 0E
0070 | E4 F4 BB 12 C9 CC 3F D0 37 AE 2B 6D 4F DA 3D 64
0080 | 68 70 8A 1C 93 5D AA 89 C0 C7 57 0A 90 3F 72 FF
0090 | 32 62 49 88 F7 CC 42 E3 97 7B 25 13 67 F0 59 74
00A0 | B9 49 AE 53 5A A5 AB 21 13 0E B0 FA 87 35 61 AD
00B0 | 5E CF EF F0 9B 49 04 16 DE 3B 17 ED EB 62 6C 83
00C0 | 68 D6 53 E0 DF 28 64 6C 2B 3B 59 E1 8C DA 57 84
00D0 | D7 54 18 1E B7 CE 40 FA A8 C9 22 39 68 63 7F B7
00E0 | 58 74 9F 3E E0 FF 8E D9 29 3D 88 9D 54 12 36 07
00F0 | B9 59 10 27 93 81 DD DD 93 26 CC 40 49 2B 63 A2
0100 | AB 0A D3 A2 43 22 AE CC 74 31 1C B3 55 1A D0 8A
0110 | A9 49 01 11 42 D2 3A A9 C4 E3 55 A7 1B E0 D2 FA
0120 | 94 46 68 DB 37 54 C3 0F 2F BB 18 97 45 AB B9 5B
0130 | 88 8F DB 95 D6 20 0C 67 2F 93 80 63 42 15 8E C2
0140 | A5 6B 4B 7C B6 97 12 E0 A1 D5 A6 24 1F E1 33 25
0150 | 66 DB 6E 78 52 C2 5B 5D F1 9F 3D 1B DC FB 8D A9
0160 | 7C F7 37 7A 9D A3 80 E5 02 BC FD D2 C2 DB 8D 7C
0170 | 34 B8 CA DA ED 98 89 89 CC 8A D9 AC 9E B4 D9 86
0180 | AA DF 1B 9E 3C 8C 6D CD 47 FC 6C 89</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>583F05009ABDD168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010073A194B9163C0B89191567D3</code> <code>A3D2E49ADCEC976091213A824ABEE87B</code> <code>E3A5016C17D078118C5EA2F0E374B19C</code> <code>5D69D9203266C70EE4F4BB12C9CC3FD0</code> <code>37AE2B6D4FDA3D6468708A1C935DAA89</code> <code>C0C7570A903F72FF32624988F7CC42E3</code> <code>977B251367F05974B949AE535AA5AB21</code> <code>130EB0FA873561AD5ECFEFF09B490416</code> <code>DE3B17EDEB626C8368D653E0DF28646C</code> <code>2B3B59E18CDA5784D754181EB7CE40FA</code> <code>A8C9223968637FB758749F3EE0FF8ED9</code> <code>293D889D54123607B95910279381DDDD</code> <code>9326CC40492B63A2AB0AD3A24322AECC</code> <code>74311CB3551AD08AA949011142D23AA9</code> <code>C4E355A71BE0D2FA944668DB3754C30F</code> <code>2FBB189745ABB95B888FDB95D6200C67</code> <code>2F93806342158EC2A56B4B7CB69712E0</code> <code>A1D5A6241FE1332566DB6E7852C25B5D</code> <code>F19F3D1BDCFB8DA97CF7377A9DA380E5</code> <code>02BCFDD2C2DB8D7C34B8CADAED988989</code> <code>CC8AD9AC9EB4D986AADF1B9E3C8C6DCD</code><br> <code>47FC6C89</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 90E26D84021C2B07429C7AEF7B6A219F9DCB50E2CBC224B9B94179FE11D55EC4CA558E2BC2FC6745BFD89FF8D61A212C04D706B90802EFAE4D06403CE94756155053A1717EAA288CA65CF70DA90803D1EAE96E84653E6025A06255E19F54038D0EBED6917493A8C7A2B729FC9A5F07AAA3F840385A10B5E337D94F4E38922A613DB1421D261E7A681176D190335F675BEC8825A4DD151DD9960E8F20C446FCC9C01098255E39ACF151A299942009A2B98CFBA3DB95E85B0D4C0B735D237A4EE72200701785CA6F29258DC83FD196766C8CFC02A66AE7B315BB6E4D0AF3D6FDB02F0A9175993D543914B57B9A505A34E3D0BF97C0FF92FA2CC8E3447B844A77E5</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 88 A7 35 9C BD D1 68
0010 | 34 00 00 00 34 F7 CB 3B C8 77 CF 24 B1 14 5A 5C
0020 | 34 8B 48 EC 97 09 62 3D F2 91 A3 A2 39 8F EC 75
0030 | 71 58 FA 8F C5 56 6B 3E FC 53 FF 0B 3E 53 BE 7B
0040 | C4 A7 9D 84 61 C8 55 08</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0188A7359CBDD168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C877CF24B1145A5C348B48EC9709623D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F291A3A2398FEC757158FA8FC5566B3E</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>FC53FF0B3E53BE7BC4A79D8461C85508</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

