<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?237" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 3C B9 0E 00 73 22 7B 66
0010 | 14 00 00 00 F1 8E 7E BE C3 C8 F6 BE 0E 4F 8A 08
0020 | AE F2 D4 4C 20 7A CE 47</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>3CB90E0073227B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 CC 03 74 22 7B 66
0010 | A4 00 00 00 63 24 16 05 C3 C8 F6 BE 0E 4F 8A 08
0020 | AE F2 D4 4C 20 7A CE 47 A0 F0 D7 BA 6E F0 02 59
0030 | FC 98 9D 20 BA 91 C0 BC 08 22 1F 49 3A A2 24 37
0040 | 3F 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E0CC0374227B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A4000000</code> (164 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08221F493AA224373F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2458764437744793407</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2458764437744793407</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2458764437744793407 = 1381929973 * 1779225059</code></p>
<pre><code>p = 1381929973
q = 1779225059</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 22 1F 49 3A A2 24 37 3F 00 00 00
0010 | 04 52 5E 93 F5 00 00 00 04 6A 0C D1 E3 00 00 00
0020 | C3 C8 F6 BE 0E 4F 8A 08 AE F2 D4 4C 20 7A CE 47
0030 | A0 F0 D7 BA 6E F0 02 59 FC 98 9D 20 BA 91 C0 BC
0040 | FE 6A AC 3F 30 6D 99 D5 8E 30 76 FD 35 77 65 25
0050 | 54 18 F8 F9 24 5C EB 17 EC 81 B1 67 25 0F 1D F9
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08221F493AA224373F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2458764437744793407</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04525E93F5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1381929973</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046A0CD1E3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1779225059</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>FE6AAC3F306D99D58E3076FD35776525</code> <code>5418F8F9245CEB17EC81B167250F1DF9</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908221F493AA224373F00000004525E93F5000000046A0CD1E3000000C3C8F6BE0E4F8A08AEF2D44C207ACE47A0F0D7BA6EF00259FC989D20BA91C0BCFE6AAC3F306D99D58E3076FD357765255418F8F9245CEB17EC81B167250F1DF902000000
random_padding_bytes = FFD48E7D4E05C7D4BEC59DBF341BF5DE797CD466DD7ED015A34B7B08E8DF17901EB0FD196138882D9B68A0643C6F740E6B29971E72983C317A917547E7AF7DBC104F8B90AF2E9FDFFAED06AA5FCCF52779F12FEFCC678ED9B0EAD54C</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B9414995450EB67A3067A17A8662ABCF4E40BFEFD972EDA822FF2DE36B9B04AFACA0FB5D1F95C2A55BAB48240811689C99671600428A754734A552FF7D015004D677DFF8855EA0FBBCB13FB7E98ADE47BEC0FF81081913AEA521ADFD6FD2FA1DF394D3E4E377A77CCC4F75EDA14C257BD56DC0978893BA5573350A3FA2996436B8DDBCC210D4BB212C73E43D084C13B85AACB786A2C2A2252494760AF29504CC7BEF2E21244BA7D8D998508294E92F98E3925E4C77E53989DFDA7B97DE1D4A3266000BD004766BC158946A207B3A381195764DEC4D102AA385E08BD225A6F4EF2B48F513AD8115F2AB6343321962247A4B85C37622479BF6140D3AB9E5872FEC</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 48 3B 01 00 74 22 7B 66
0010 | 40 01 00 00 BE E4 12 D7 C3 C8 F6 BE 0E 4F 8A 08
0020 | AE F2 D4 4C 20 7A CE 47 A0 F0 D7 BA 6E F0 02 59
0030 | FC 98 9D 20 BA 91 C0 BC 04 52 5E 93 F5 00 00 00
0040 | 04 6A 0C D1 E3 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B9 41 49 95 45 0E B6 7A 30 67 A1 7A
0060 | 86 62 AB CF 4E 40 BF EF D9 72 ED A8 22 FF 2D E3
0070 | 6B 9B 04 AF AC A0 FB 5D 1F 95 C2 A5 5B AB 48 24
0080 | 08 11 68 9C 99 67 16 00 42 8A 75 47 34 A5 52 FF
0090 | 7D 01 50 04 D6 77 DF F8 85 5E A0 FB BC B1 3F B7
00A0 | E9 8A DE 47 BE C0 FF 81 08 19 13 AE A5 21 AD FD
00B0 | 6F D2 FA 1D F3 94 D3 E4 E3 77 A7 7C CC 4F 75 ED
00C0 | A1 4C 25 7B D5 6D C0 97 88 93 BA 55 73 35 0A 3F
00D0 | A2 99 64 36 B8 DD BC C2 10 D4 BB 21 2C 73 E4 3D
00E0 | 08 4C 13 B8 5A AC B7 86 A2 C2 A2 25 24 94 76 0A
00F0 | F2 95 04 CC 7B EF 2E 21 24 4B A7 D8 D9 98 50 82
0100 | 94 E9 2F 98 E3 92 5E 4C 77 E5 39 89 DF DA 7B 97
0110 | DE 1D 4A 32 66 00 0B D0 04 76 6B C1 58 94 6A 20
0120 | 7B 3A 38 11 95 76 4D EC 4D 10 2A A3 85 E0 8B D2
0130 | 25 A6 F4 EF 2B 48 F5 13 AD 81 15 F2 AB 63 43 32
0140 | 19 62 24 7A 4B 85 C3 76 22 47 9B F6 14 0D 3A B9
0150 | E5 87 2F EC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>483B010074227B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04525E93F5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1381929973</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046A0CD1E3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1779225059</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B9414995450EB67A3067A17A</code> <code>8662ABCF4E40BFEFD972EDA822FF2DE3</code> <code>6B9B04AFACA0FB5D1F95C2A55BAB4824</code> <code>0811689C99671600428A754734A552FF</code> <code>7D015004D677DFF8855EA0FBBCB13FB7</code> <code>E98ADE47BEC0FF81081913AEA521ADFD</code> <code>6FD2FA1DF394D3E4E377A77CCC4F75ED</code> <code>A14C257BD56DC0978893BA5573350A3F</code> <code>A2996436B8DDBCC210D4BB212C73E43D</code> <code>084C13B85AACB786A2C2A2252494760A</code> <code>F29504CC7BEF2E21244BA7D8D9985082</code> <code>94E92F98E3925E4C77E53989DFDA7B97</code> <code>DE1D4A3266000BD004766BC158946A20</code> <code>7B3A381195764DEC4D102AA385E08BD2</code> <code>25A6F4EF2B48F513AD8115F2AB634332</code> <code>1962247A4B85C37622479BF6140D3AB9</code><br> <code>E5872FEC</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C0 1A B7 74 22 7B 66
0010 | AC 02 00 00 5C 07 E8 D0 C3 C8 F6 BE 0E 4F 8A 08
0020 | AE F2 D4 4C 20 7A CE 47 A0 F0 D7 BA 6E F0 02 59
0030 | FC 98 9D 20 BA 91 C0 BC FE 50 02 00 74 7C AF 96
0040 | BC A5 3E 0E 25 CB A3 5C B2 79 39 4D B6 F5 85 DA
0050 | 43 39 B7 00 CE 70 31 AE 5A B9 05 F7 7A 8F AE 12
0060 | C8 C3 57 A6 AE C0 68 90 A7 E3 35 45 F9 65 26 1A
0070 | 92 03 81 18 CF 6D 6C F4 5C A7 A5 A7 A2 EA 32 12
0080 | 6A 2F F7 C5 F5 46 BF 19 61 2E 38 A7 A1 3F DA 0B
0090 | 8F 39 4B 8E E2 34 81 EC 51 1F 3C 4A 35 FC 98 A5
00A0 | 9A 5F C2 48 55 47 D1 70 46 03 B9 44 2C 72 64 12
00B0 | 2F E0 EC DE F0 37 BF E9 E1 EE 77 90 BE A1 F2 3B
00C0 | AF 9D 2C 90 07 AD 84 08 36 62 56 DC 69 A1 A0 88
00D0 | 80 CE 4A E7 74 3D DB C0 4E 64 51 E4 1D 04 6E 1C
00E0 | 19 41 61 59 56 A0 5F DC 74 BE 59 A6 23 B4 F8 5A
00F0 | F9 CD 07 DE 76 36 2D 73 59 FA B5 40 93 82 6B 20
0100 | AC FD CB 71 F2 9D 79 9D 2B C1 C4 39 2B 45 B0 D3
0110 | F9 BF F4 0F 88 32 A7 A3 75 FF D8 C5 C6 ED 99 EF
0120 | F0 41 C6 A8 AB 78 AE C5 25 BB 66 AD FB C2 52 CE
0130 | 07 53 9B 2C 2C 2F E7 AF 60 FD 6F 77 FC 4B 2E 1E
0140 | 12 7D 6D C0 CA 61 66 4B 7B FB 2F 39 91 5D 36 D4
0150 | F6 DB 34 83 C8 F4 AE 98 09 79 06 D7 2F A0 AC 72
0160 | 8D 78 B3 B0 2F F1 33 5A AD 5E 49 3B 95 4A 69 DA
0170 | B3 AF A3 95 CD 27 EF 4C 52 46 51 A5 1E 55 0A 9B
0180 | B1 8F 2E 7E 3B 8D C2 AA 38 9D 4A CE E9 1A 8D F9
0190 | 3D BD B6 86 D7 82 EC 84 1D F2 23 3C 06 57 14 94
01A0 | B6 85 3C 81 52 2B 30 23 05 49 D1 F6 33 AF B3 B4
01B0 | F1 90 D7 DA E8 95 8F 89 59 4F 7F C6 C0 AE 7D EC
01C0 | 3C 57 71 E3 24 AE 90 7D 0A 36 CD C4 07 87 D6 1A
01D0 | 13 40 B9 23 D9 60 0D 5A B7 00 77 8E 37 0D 8B 50
01E0 | 08 4E 87 B2 D7 71 40 24 B9 0D B9 7D 2C 05 21 D9
01F0 | 22 8A 26 F6 82 21 0A 96 BE 7E 41 CF 83 3A C6 9D
0200 | 49 FB 41 DF 17 44 B6 B7 06 FD 9B 5B CF 8B 6B 98
0210 | EF 8F 3B 98 61 AF 79 BF 2D 30 77 C5 37 3C E1 B6
0220 | 6F 93 5A DA 66 24 FC DF 51 A3 FE 05 59 16 CF 0C
0230 | D3 19 83 28 91 BA 7B EE 1A 18 4D AB B4 8D EA C8
0240 | DB CE 26 DC 8D D0 2D 4A 2F 74 9B 33 CA 39 4C 93
0250 | 0B DA 52 BC C6 19 B6 49 AD 5C 78 61 7C DD 2D EB
0260 | 57 13 80 13 55 2F D8 5A 22 76 E7 51 E9 68 28 CD
0270 | E3 FE 41 39 DB FA 83 02 BD A0 31 A6 5B D5 E1 7A
0280 | EF 5C 0F 98 FA 29 F5 59 13 BA AA 1B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C01AB774227B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>AC020000</code> (684 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200747CAF96BCA53E0E25CBA35C</code> <code>B279394DB6F585DA4339B700CE7031AE</code> <code>5AB905F77A8FAE12C8C357A6AEC06890</code> <code>A7E33545F965261A92038118CF6D6CF4</code> <code>5CA7A5A7A2EA32126A2FF7C5F546BF19</code> <code>612E38A7A13FDA0B8F394B8EE23481EC</code> <code>511F3C4A35FC98A59A5FC2485547D170</code> <code>4603B9442C7264122FE0ECDEF037BFE9</code> <code>E1EE7790BEA1F23BAF9D2C9007AD8408</code> <code>366256DC69A1A08880CE4AE7743DDBC0</code> <code>4E6451E41D046E1C1941615956A05FDC</code> <code>74BE59A623B4F85AF9CD07DE76362D73</code> <code>59FAB54093826B20ACFDCB71F29D799D</code> <code>2BC1C4392B45B0D3F9BFF40F8832A7A3</code> <code>75FFD8C5C6ED99EFF041C6A8AB78AEC5</code> <code>25BB66ADFBC252CE07539B2C2C2FE7AF</code> <code>60FD6F77FC4B2E1E127D6DC0CA61664B</code> <code>7BFB2F39915D36D4F6DB3483C8F4AE98</code> <code>097906D72FA0AC728D78B3B02FF1335A</code> <code>AD5E493B954A69DAB3AFA395CD27EF4C</code> <code>524651A51E550A9BB18F2E7E3B8DC2AA</code> <code>389D4ACEE91A8DF93DBDB686D782EC84</code> <code>1DF2233C06571494B6853C81522B3023</code> <code>0549D1F633AFB3B4F190D7DAE8958F89</code> <code>594F7FC6C0AE7DEC3C5771E324AE907D</code> <code>0A36CDC40787D61A1340B923D9600D5A</code> <code>B700778E370D8B50084E87B2D7714024</code> <code>B90DB97D2C0521D9228A26F682210A96</code> <code>BE7E41CF833AC69D49FB41DF1744B6B7</code> <code>06FD9B5BCF8B6B98EF8F3B9861AF79BF</code> <code>2D3077C5373CE1B66F935ADA6624FCDF</code> <code>51A3FE055916CF0CD319832891BA7BEE</code> <code>1A184DABB48DEAC8DBCE26DC8DD02D4A</code> <code>2F749B33CA394C930BDA52BCC619B649</code> <code>AD5C78617CDD2DEB57138013552FD85A</code> <code>2276E751E96828CDE3FE4139DBFA8302</code> <code>BDA031A65BD5E17AEF5C0F98FA29F559</code><br> <code>13BAAA1B</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 747CAF96BCA53E0E25CBA35CB279394DB6F585DA4339B700CE7031AE5AB905F77A8FAE12C8C357A6AEC06890A7E33545F965261A92038118CF6D6CF45CA7A5A7A2EA32126A2FF7C5F546BF19612E38A7A13FDA0B8F394B8EE23481EC511F3C4A35FC98A59A5FC2485547D1704603B9442C7264122FE0ECDEF037BFE9E1EE7790BEA1F23BAF9D2C9007AD8408366256DC69A1A08880CE4AE7743DDBC04E6451E41D046E1C1941615956A05FDC74BE59A623B4F85AF9CD07DE76362D7359FAB54093826B20ACFDCB71F29D799D2BC1C4392B45B0D3F9BFF40F8832A7A375FFD8C5C6ED99EFF041C6A8AB78AEC525BB66ADFBC252CE07539B2C2C2FE7AF60FD6F77FC4B2E1E127D6DC0CA61664B7BFB2F39915D36D4F6DB3483C8F4AE98097906D72FA0AC728D78B3B02FF1335AAD5E493B954A69DAB3AFA395CD27EF4C524651A51E550A9BB18F2E7E3B8DC2AA389D4ACEE91A8DF93DBDB686D782EC841DF2233C06571494B6853C81522B30230549D1F633AFB3B4F190D7DAE8958F89594F7FC6C0AE7DEC3C5771E324AE907D0A36CDC40787D61A1340B923D9600D5AB700778E370D8B50084E87B2D7714024B90DB97D2C0521D9228A26F682210A96BE7E41CF833AC69D49FB41DF1744B6B706FD9B5BCF8B6B98EF8F3B9861AF79BF2D3077C5373CE1B66F935ADA6624FCDF51A3FE055916CF0CD319832891BA7BEE1A184DABB48DEAC8DBCE26DC8DD02D4A2F749B33CA394C930BDA52BCC619B649AD5C78617CDD2DEB57138013552FD85A2276E751E96828CDE3FE4139DBFA8302BDA031A65BD5E17AEF5C0F98FA29F55913BAAA1B
tmp_aes_key = 11FE8FBEBAF5CD0D44E94C94684E0F579AAD13781558F3EBFE6859BB2EAAB02A
tmp_aes_iv = F7FFAE27F0F5E583A7ED94409F6B07420494B4BBA4CB58DF12214F4FFE6AAC3F</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 71F689E89CAD988B73F321CE4D3811340E213502BA0D89B5C3C8F6BE0E4F8A08AEF2D44C207ACE47A0F0D7BA6EF00259FC989D20BA91C0BC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005810B14927DC018378E3D61892D117D7CD2B1033A9D78FB68861B8ACC93CE73A4B1E13C97C6E8EB772530F315F60D99A90CAEC61EE1FE8FE3AF215BF8D3ADC5AD1DBAFD0E7362722D0D61371388223D276DF3775AB6A8C0FD9E3C2C302C7CCC08B5330018090938C2BC596E20060F0E2D621F524FEB4C95B39D5F27839E4522BC47CDF06A3BF5CB31DFEA7A6CD9EC7C33D7F2C87FA40587D9E9331CA17CAA6925805238F3E101EC9F3930E4F9E9496A476874F02D3451AC80D442F470885D20746773F71689E6C3414CC26377B75991368DBD4E2A131F053C8B81A7B7215AD1A08D180602D41FE8E7F6AA317D57D3358917EC6F0E350212F87964F3E7694202374227B6622C1BE46AB564D3D
answer = BA0D89B5C3C8F6BE0E4F8A08AEF2D44C207ACE47A0F0D7BA6EF00259FC989D20BA91C0BC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005810B14927DC018378E3D61892D117D7CD2B1033A9D78FB68861B8ACC93CE73A4B1E13C97C6E8EB772530F315F60D99A90CAEC61EE1FE8FE3AF215BF8D3ADC5AD1DBAFD0E7362722D0D61371388223D276DF3775AB6A8C0FD9E3C2C302C7CCC08B5330018090938C2BC596E20060F0E2D621F524FEB4C95B39D5F27839E4522BC47CDF06A3BF5CB31DFEA7A6CD9EC7C33D7F2C87FA40587D9E9331CA17CAA6925805238F3E101EC9F3930E4F9E9496A476874F02D3451AC80D442F470885D20746773F71689E6C3414CC26377B75991368DBD4E2A131F053C8B81A7B7215AD1A08D180602D41FE8E7F6AA317D57D3358917EC6F0E350212F87964F3E7694202374227B6622C1BE46AB564D3D</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 C3 C8 F6 BE 0E 4F 8A 08 AE F2 D4 4C
0010 | 20 7A CE 47 A0 F0 D7 BA 6E F0 02 59 FC 98 9D 20
0020 | BA 91 C0 BC 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 58 10 B1 49 27 DC 01 83 78 E3 D6 18 92 D1 17 D7
0140 | CD 2B 10 33 A9 D7 8F B6 88 61 B8 AC C9 3C E7 3A
0150 | 4B 1E 13 C9 7C 6E 8E B7 72 53 0F 31 5F 60 D9 9A
0160 | 90 CA EC 61 EE 1F E8 FE 3A F2 15 BF 8D 3A DC 5A
0170 | D1 DB AF D0 E7 36 27 22 D0 D6 13 71 38 82 23 D2
0180 | 76 DF 37 75 AB 6A 8C 0F D9 E3 C2 C3 02 C7 CC C0
0190 | 8B 53 30 01 80 90 93 8C 2B C5 96 E2 00 60 F0 E2
01A0 | D6 21 F5 24 FE B4 C9 5B 39 D5 F2 78 39 E4 52 2B
01B0 | C4 7C DF 06 A3 BF 5C B3 1D FE A7 A6 CD 9E C7 C3
01C0 | 3D 7F 2C 87 FA 40 58 7D 9E 93 31 CA 17 CA A6 92
01D0 | 58 05 23 8F 3E 10 1E C9 F3 93 0E 4F 9E 94 96 A4
01E0 | 76 87 4F 02 D3 45 1A C8 0D 44 2F 47 08 85 D2 07
01F0 | 46 77 3F 71 68 9E 6C 34 14 CC 26 37 7B 75 99 13
0200 | 68 DB D4 E2 A1 31 F0 53 C8 B8 1A 7B 72 15 AD 1A
0210 | 08 D1 80 60 2D 41 FE 8E 7F 6A A3 17 D5 7D 33 58
0220 | 91 7E C6 F0 E3 50 21 2F 87 96 4F 3E 76 94 20 23
0230 | 74 22 7B 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001005810B14927DC018378E3D618</code> <code>92D117D7CD2B1033A9D78FB68861B8AC</code> <code>C93CE73A4B1E13C97C6E8EB772530F31</code> <code>5F60D99A90CAEC61EE1FE8FE3AF215BF</code> <code>8D3ADC5AD1DBAFD0E7362722D0D61371</code> <code>388223D276DF3775AB6A8C0FD9E3C2C3</code> <code>02C7CCC08B5330018090938C2BC596E2</code> <code>0060F0E2D621F524FEB4C95B39D5F278</code> <code>39E4522BC47CDF06A3BF5CB31DFEA7A6</code> <code>CD9EC7C33D7F2C87FA40587D9E9331CA</code> <code>17CAA6925805238F3E101EC9F3930E4F</code> <code>9E9496A476874F02D3451AC80D442F47</code> <code>0885D20746773F71689E6C3414CC2637</code> <code>7B75991368DBD4E2A131F053C8B81A7B</code> <code>7215AD1A08D180602D41FE8E7F6AA317</code> <code>D57D3358917EC6F0E350212F87964F3E</code><br> <code>76942023</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>74227B66</code> (1719345780 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 4371999EFC8E12CDADD9B755E5323F276E06B2227D354847BAE21C45ABEDC730300DF9D9C4C946D046FA721E1202C9FAA18792D9A35E80A3DD17A37E20957815299D2BE2A1173EFC329A74B75C75EF6DDF791AD27CB51C4491A33BAE153CCCDC6D8457FC1A4C743BFFF0A5780B5D425216B3894472499593E735153557052096674FC01310E012C4C99CE6E7F000B03260C491F15E4277373F5C27BFA5A2C1C438E9C7368E5B1436CC88FA6F9D036154BFB72474C4044C3345EA35E901FBC2163C2A8133666918C5848B64AE5273954AA8E8E4E850BFE7BEF67B3DDAAE37C7834E8EC9D75F4136A598BCA9BB840D4AFCF50DB07ED75942345B2C36414CAC39A9</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 275A685782E5161214E261205ED27F15D103C9D93CDA91A6B3C99548E7271D7E222D42C9941B051981666EC8B7C4892F93EB0B41E176DE7082F6D062B6F7DDEFF57087330E1845C2234124268CE2E19401392493799680971014CFB37162506BD67E92E44C2B8196FFF5DE1AF3ABC01E1A54B02A50046784A5980EB83308D5713A5FB3A442CC10833D70C042465A10958F96D1601EE7909DB4102FEC8A1DEC82C280F4F13EDB8C89B6D2EBBDBE77614973ABBDE2AFA31E94B3A4E6FA3A96E443779C4C317070DF24643A1248509BB440EDE831BEC81CD165939BFCF1DA2D704A3504B8C888E2569E7EB020F3CA04FEF8DC5E4E0907FB495757B44DC908932406</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 C3 C8 F6 BE 0E 4F 8A 08 AE F2 D4 4C
0010 | 20 7A CE 47 A0 F0 D7 BA 6E F0 02 59 FC 98 9D 20
0020 | BA 91 C0 BC 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 27 5A 68 57 82 E5 16 12 14 E2 61 20 5E D2 7F 15
0040 | D1 03 C9 D9 3C DA 91 A6 B3 C9 95 48 E7 27 1D 7E
0050 | 22 2D 42 C9 94 1B 05 19 81 66 6E C8 B7 C4 89 2F
0060 | 93 EB 0B 41 E1 76 DE 70 82 F6 D0 62 B6 F7 DD EF
0070 | F5 70 87 33 0E 18 45 C2 23 41 24 26 8C E2 E1 94
0080 | 01 39 24 93 79 96 80 97 10 14 CF B3 71 62 50 6B
0090 | D6 7E 92 E4 4C 2B 81 96 FF F5 DE 1A F3 AB C0 1E
00A0 | 1A 54 B0 2A 50 04 67 84 A5 98 0E B8 33 08 D5 71
00B0 | 3A 5F B3 A4 42 CC 10 83 3D 70 C0 42 46 5A 10 95
00C0 | 8F 96 D1 60 1E E7 90 9D B4 10 2F EC 8A 1D EC 82
00D0 | C2 80 F4 F1 3E DB 8C 89 B6 D2 EB BD BE 77 61 49
00E0 | 73 AB BD E2 AF A3 1E 94 B3 A4 E6 FA 3A 96 E4 43
00F0 | 77 9C 4C 31 70 70 DF 24 64 3A 12 48 50 9B B4 40
0100 | ED E8 31 BE C8 1C D1 65 93 9B FC F1 DA 2D 70 4A
0110 | 35 04 B8 C8 88 E2 56 9E 7E B0 20 F3 CA 04 FE F8
0120 | DC 5E 4E 09 07 FB 49 57 57 B4 4D C9 08 93 24 06</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100275A685782E5161214E26120</code> <code>5ED27F15D103C9D93CDA91A6B3C99548</code> <code>E7271D7E222D42C9941B051981666EC8</code> <code>B7C4892F93EB0B41E176DE7082F6D062</code> <code>B6F7DDEFF57087330E1845C223412426</code> <code>8CE2E19401392493799680971014CFB3</code> <code>7162506BD67E92E44C2B8196FFF5DE1A</code> <code>F3ABC01E1A54B02A50046784A5980EB8</code> <code>3308D5713A5FB3A442CC10833D70C042</code> <code>465A10958F96D1601EE7909DB4102FEC</code> <code>8A1DEC82C280F4F13EDB8C89B6D2EBBD</code> <code>BE77614973ABBDE2AFA31E94B3A4E6FA</code> <code>3A96E443779C4C317070DF24643A1248</code> <code>509BB440EDE831BEC81CD165939BFCF1</code> <code>DA2D704A3504B8C888E2569E7EB020F3</code> <code>CA04FEF8DC5E4E0907FB495757B44DC9</code><br> <code>08932406</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366C3C8F6BE0E4F8A08AEF2D44C207ACE47A0F0D7BA6EF00259FC989D20BA91C0BC0000000000000000FE000100275A685782E5161214E261205ED27F15D103C9D93CDA91A6B3C99548E7271D7E222D42C9941B051981666EC8B7C4892F93EB0B41E176DE7082F6D062B6F7DDEFF57087330E1845C2234124268CE2E19401392493799680971014CFB37162506BD67E92E44C2B8196FFF5DE1AF3ABC01E1A54B02A50046784A5980EB83308D5713A5FB3A442CC10833D70C042465A10958F96D1601EE7909DB4102FEC8A1DEC82C280F4F13EDB8C89B6D2EBBDBE77614973ABBDE2AFA31E94B3A4E6FA3A96E443779C4C317070DF24643A1248509BB440EDE831BEC81CD165939BFCF1DA2D704A3504B8C888E2569E7EB020F3CA04FEF8DC5E4E0907FB495757B44DC908932406
padding = A1B036BFF3AA0739E1586422
tmp_aes_key = 11FE8FBEBAF5CD0D44E94C94684E0F579AAD13781558F3EBFE6859BB2EAAB02A
tmp_aes_iv = F7FFAE27F0F5E583A7ED94409F6B07420494B4BBA4CB58DF12214F4FFE6AAC3F</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 84EA0D2A191290694D445EF398907CDBACB4DD384C142D2B99C5153096F4BC48728DDB6BA33078187E7A8CC810567D44AECBADA7C56075F8D978E9A8BC92D238A7BEB91EB726E521F914A678C5607C8EDF07FE3FA73B330773DFF8F1FAB43951516B142A6231DFE2878B7E6CB9D09D413F65663592B5F0702AFBD13913CEC21331FB97A802CA866561FB6673B7505AFA6DCA65E0A928E133B1BBB8910BB21B7CADEDF07A0CB390F5E3BA7FA3F9E94739ED49C1B1187C7387FCDC24F8F536DA0354C24AF5DDB94EF4264859AA2115A8046CFF2AEB40B064E1EF403E16A1090103A766B12C390C3C31540F46C2A35BF9B4E6786AAA990FC875A95C875B3C17DEC03168CA450B426E8BFFEDFE80C15A70F872C962073C2A05B8E6E0836512BE8ADC18B4CD2746AAF783EF3D1E4210516BB113062DFCFB11B58FF654A1E6454633F116ED380C9A8D51B4838EAAB43F4B5414</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 93 0D 00 74 22 7B 66
0010 | 78 01 00 00 1F 5F 04 F5 C3 C8 F6 BE 0E 4F 8A 08
0020 | AE F2 D4 4C 20 7A CE 47 A0 F0 D7 BA 6E F0 02 59
0030 | FC 98 9D 20 BA 91 C0 BC FE 50 01 00 84 EA 0D 2A
0040 | 19 12 90 69 4D 44 5E F3 98 90 7C DB AC B4 DD 38
0050 | 4C 14 2D 2B 99 C5 15 30 96 F4 BC 48 72 8D DB 6B
0060 | A3 30 78 18 7E 7A 8C C8 10 56 7D 44 AE CB AD A7
0070 | C5 60 75 F8 D9 78 E9 A8 BC 92 D2 38 A7 BE B9 1E
0080 | B7 26 E5 21 F9 14 A6 78 C5 60 7C 8E DF 07 FE 3F
0090 | A7 3B 33 07 73 DF F8 F1 FA B4 39 51 51 6B 14 2A
00A0 | 62 31 DF E2 87 8B 7E 6C B9 D0 9D 41 3F 65 66 35
00B0 | 92 B5 F0 70 2A FB D1 39 13 CE C2 13 31 FB 97 A8
00C0 | 02 CA 86 65 61 FB 66 73 B7 50 5A FA 6D CA 65 E0
00D0 | A9 28 E1 33 B1 BB B8 91 0B B2 1B 7C AD ED F0 7A
00E0 | 0C B3 90 F5 E3 BA 7F A3 F9 E9 47 39 ED 49 C1 B1
00F0 | 18 7C 73 87 FC DC 24 F8 F5 36 DA 03 54 C2 4A F5
0100 | DD B9 4E F4 26 48 59 AA 21 15 A8 04 6C FF 2A EB
0110 | 40 B0 64 E1 EF 40 3E 16 A1 09 01 03 A7 66 B1 2C
0120 | 39 0C 3C 31 54 0F 46 C2 A3 5B F9 B4 E6 78 6A AA
0130 | 99 0F C8 75 A9 5C 87 5B 3C 17 DE C0 31 68 CA 45
0140 | 0B 42 6E 8B FF ED FE 80 C1 5A 70 F8 72 C9 62 07
0150 | 3C 2A 05 B8 E6 E0 83 65 12 BE 8A DC 18 B4 CD 27
0160 | 46 AA F7 83 EF 3D 1E 42 10 51 6B B1 13 06 2D FC
0170 | FB 11 B5 8F F6 54 A1 E6 45 46 33 F1 16 ED 38 0C
0180 | 9A 8D 51 B4 83 8E AA B4 3F 4B 54 14</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>44930D0074227B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010084EA0D2A191290694D445EF3</code> <code>98907CDBACB4DD384C142D2B99C51530</code> <code>96F4BC48728DDB6BA33078187E7A8CC8</code> <code>10567D44AECBADA7C56075F8D978E9A8</code> <code>BC92D238A7BEB91EB726E521F914A678</code> <code>C5607C8EDF07FE3FA73B330773DFF8F1</code> <code>FAB43951516B142A6231DFE2878B7E6C</code> <code>B9D09D413F65663592B5F0702AFBD139</code> <code>13CEC21331FB97A802CA866561FB6673</code> <code>B7505AFA6DCA65E0A928E133B1BBB891</code> <code>0BB21B7CADEDF07A0CB390F5E3BA7FA3</code> <code>F9E94739ED49C1B1187C7387FCDC24F8</code> <code>F536DA0354C24AF5DDB94EF4264859AA</code> <code>2115A8046CFF2AEB40B064E1EF403E16</code> <code>A1090103A766B12C390C3C31540F46C2</code> <code>A35BF9B4E6786AAA990FC875A95C875B</code> <code>3C17DEC03168CA450B426E8BFFEDFE80</code> <code>C15A70F872C962073C2A05B8E6E08365</code> <code>12BE8ADC18B4CD2746AAF783EF3D1E42</code> <code>10516BB113062DFCFB11B58FF654A1E6</code> <code>454633F116ED380C9A8D51B4838EAAB4</code><br> <code>3F4B5414</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 6AFCF5F3CF1811729A7BADD937DBF9B661B830B6162E76B92CB6FC183C85D6B62CD9BA1942861A38DB26DC6B55334A2715C43C070B413DC24D71F1A971A31DA260C144A4C94A6E30BD2FD4CB92C070E0A190F2E2CB354971C8D460839561EFBA5A2480017A4D1B4E6F8AC3FCCD3287CB44BE51E2F71E544B3D7F473DE8D26E62E58020FA8E6A8C9A49710322EC463134B9070830B133E2E89388FF65346520E8BAAE7B4CF2CA9EA654A6D0A14E4BDEE3FB05CDD1EE2D70E331E755D11B39776908272FD9CF0E6066B10C448F8FF99231ECBA630DDE7D99730FB9A4433EBF654DD2A388AE75AE9507CCEADBA78B802C0EA5AA5ABEBBBFF830AF196D140546ADA5</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 34 15 70 75 22 7B 66
0010 | 90 00 00 00 34 F7 CB 3B C3 C8 F6 BE 0E 4F 8A 08
0020 | AE F2 D4 4C 20 7A CE 47 A0 F0 D7 BA 6E F0 02 59
0030 | FC 98 9D 20 BA 91 C0 BC 45 39 C6 1E B8 8F FC 75
0040 | EA 2F 49 54 F2 94 D1 D4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0134157075227B66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90000000</code> (144 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3C8F6BE0E4F8A08AEF2D44C207ACE47</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>A0F0D7BA6EF00259FC989D20BA91C0BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4539C61EB88FFC75EA2F4954F294D1D4</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

