<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 80 8E 0C 00 94 16 DC 68
0010 | 14 00 00 00 F1 8E 7E BE 59 67 9B BC C8 06 F4 CB
0020 | 70 08 E8 DD 36 71 AF CD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>808E0C009416DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F8 C8 6F 94 16 DC 68
0010 | 50 00 00 00 63 24 16 05 59 67 9B BC C8 06 F4 CB
0020 | 70 08 E8 DD 36 71 AF CD F8 1A F5 19 7D 69 AC 2D
0030 | 40 80 2C BE 34 58 F0 89 08 1E 84 9C B5 1E E2 1A
0040 | AF 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F8C86F9416DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081E849CB51EE21AAF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2199054819784792751</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2199054819784792751</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2199054819784792751 = 1246203137 * 1764603823</code></p>
<pre><code>p = 1246203137
q = 1764603823</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1E 84 9C B5 1E E2 1A AF 00 00 00
0010 | 04 4A 47 8D 01 00 00 00 04 69 2D B7 AF 00 00 00
0020 | 59 67 9B BC C8 06 F4 CB 70 08 E8 DD 36 71 AF CD
0030 | F8 1A F5 19 7D 69 AC 2D 40 80 2C BE 34 58 F0 89
0040 | 48 BB 24 CF 81 F5 EA FA 5B BF C4 85 8E FF 09 ED
0050 | 8B 41 3D 8F 91 15 26 A3 20 3E 4A 75 EE C8 A7 C5
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081E849CB51EE21AAF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2199054819784792751</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044A478D01000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1246203137</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04692DB7AF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1764603823</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>48BB24CF81F5EAFA5BBFC4858EFF09ED</code> <code>8B413D8F911526A3203E4A75EEC8A7C5</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081E849CB51EE21AAF000000044A478D0100000004692DB7AF00000059679BBCC806F4CB7008E8DD3671AFCDF81AF5197D69AC2D40802CBE3458F08948BB24CF81F5EAFA5BBFC4858EFF09ED8B413D8F911526A3203E4A75EEC8A7C502000000
random_padding_bytes = 8C89EC4794CC5177950492B226FE6AC128A7CC30CEC1C10A34A20238FBBF83A24DEC9552944D76039409F03A375B03387D9317BEFF5D0407C268B7860256AD242A2A8F8285210E72F485890648EDB5D3174BB1B3B1C5CC70D31CB56D</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = AA77E51741A6E02CE057E45C2AEFE3597C33967857ED99185B9975AA6D74B5411F8C08FF62B754917F97D649CDE787E4AD2308FCC83FC881EDEA4AB916E0774A25A91EEE98B2AA3BF90ED1407ECE19D943D379ED9A5F2CF255F31D5A20F1677EA49E7479ADE4284237F33B77CE34EDCA7C319016ADA1BAAE3F040F728D477BC70997F359A355F92C34F08E57AD4122065C078EEF449A2CE6B1ECEEDFEA6FAAAF88B0CBD795FA98FC14DA6EA7031A455CB6C608E367ABADB8EDD853CB020B86EB771A64325616E7862207914F70E37831C6DD2F6A146CB3BF511EDE7B9A301B6991DA2994DBC30F866D8938478CC400A93C6CCD8A497C0645B54A12558428C069</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 84 8E 0C 00 94 16 DC 68
0010 | 40 01 00 00 BE E4 12 D7 59 67 9B BC C8 06 F4 CB
0020 | 70 08 E8 DD 36 71 AF CD F8 1A F5 19 7D 69 AC 2D
0030 | 40 80 2C BE 34 58 F0 89 04 4A 47 8D 01 00 00 00
0040 | 04 69 2D B7 AF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 AA 77 E5 17 41 A6 E0 2C E0 57 E4 5C
0060 | 2A EF E3 59 7C 33 96 78 57 ED 99 18 5B 99 75 AA
0070 | 6D 74 B5 41 1F 8C 08 FF 62 B7 54 91 7F 97 D6 49
0080 | CD E7 87 E4 AD 23 08 FC C8 3F C8 81 ED EA 4A B9
0090 | 16 E0 77 4A 25 A9 1E EE 98 B2 AA 3B F9 0E D1 40
00A0 | 7E CE 19 D9 43 D3 79 ED 9A 5F 2C F2 55 F3 1D 5A
00B0 | 20 F1 67 7E A4 9E 74 79 AD E4 28 42 37 F3 3B 77
00C0 | CE 34 ED CA 7C 31 90 16 AD A1 BA AE 3F 04 0F 72
00D0 | 8D 47 7B C7 09 97 F3 59 A3 55 F9 2C 34 F0 8E 57
00E0 | AD 41 22 06 5C 07 8E EF 44 9A 2C E6 B1 EC EE DF
00F0 | EA 6F AA AF 88 B0 CB D7 95 FA 98 FC 14 DA 6E A7
0100 | 03 1A 45 5C B6 C6 08 E3 67 AB AD B8 ED D8 53 CB
0110 | 02 0B 86 EB 77 1A 64 32 56 16 E7 86 22 07 91 4F
0120 | 70 E3 78 31 C6 DD 2F 6A 14 6C B3 BF 51 1E DE 7B
0130 | 9A 30 1B 69 91 DA 29 94 DB C3 0F 86 6D 89 38 47
0140 | 8C C4 00 A9 3C 6C CD 8A 49 7C 06 45 B5 4A 12 55
0150 | 84 28 C0 69</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>848E0C009416DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044A478D01000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1246203137</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04692DB7AF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1764603823</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100AA77E51741A6E02CE057E45C</code> <code>2AEFE3597C33967857ED99185B9975AA</code> <code>6D74B5411F8C08FF62B754917F97D649</code> <code>CDE787E4AD2308FCC83FC881EDEA4AB9</code> <code>16E0774A25A91EEE98B2AA3BF90ED140</code> <code>7ECE19D943D379ED9A5F2CF255F31D5A</code> <code>20F1677EA49E7479ADE4284237F33B77</code> <code>CE34EDCA7C319016ADA1BAAE3F040F72</code> <code>8D477BC70997F359A355F92C34F08E57</code> <code>AD4122065C078EEF449A2CE6B1ECEEDF</code> <code>EA6FAAAF88B0CBD795FA98FC14DA6EA7</code> <code>031A455CB6C608E367ABADB8EDD853CB</code> <code>020B86EB771A64325616E7862207914F</code> <code>70E37831C6DD2F6A146CB3BF511EDE7B</code> <code>9A301B6991DA2994DBC30F866D893847</code> <code>8CC400A93C6CCD8A497C0645B54A1255</code><br> <code>8428C069</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 91 A3 94 16 DC 68
0010 | 78 02 00 00 5C 07 E8 D0 59 67 9B BC C8 06 F4 CB
0020 | 70 08 E8 DD 36 71 AF CD F8 1A F5 19 7D 69 AC 2D
0030 | 40 80 2C BE 34 58 F0 89 FE 50 02 00 CF 8E 68 D3
0040 | B3 07 BC 80 4E B9 97 6C F9 3A 39 DC 75 C1 EB 07
0050 | 24 6C D8 67 A1 A4 2D E9 12 F5 2E 3A BD 4C 3E A4
0060 | 6D FE DE 4C 08 9E 92 0D 65 C9 57 1A EC 43 CA 01
0070 | 0B E8 D1 E7 F7 63 52 3B 3A 24 C8 06 0B 4B 7B 91
0080 | 0D 72 A2 B5 E1 C8 AB 57 B8 5D 71 78 BD 10 6B 5D
0090 | D6 4F 83 C6 F2 E1 6C 5D A2 0D FE 0D BB 51 77 FF
00A0 | 56 AD FB 38 02 3E 78 9C DA 02 09 A9 AF 87 C5 27
00B0 | 03 DA 5E AC 3C F3 1E E0 AF 94 38 9C 87 32 AE 4A
00C0 | D2 56 46 BF 73 5E 95 15 F2 0E 42 24 99 C1 88 F1
00D0 | DD 39 AA A5 D5 B2 0C 17 F7 D1 85 04 9A 4E 1F 4F
00E0 | B2 BA 84 DD 99 B8 B6 81 1C 09 2C 24 F7 7E 92 60
00F0 | 7A C9 DF 50 34 AD 0F 3E 40 F0 FB E8 C0 76 D8 32
0100 | 8E F0 52 E5 80 01 E2 5C 78 6C 04 E5 87 55 7E 1D
0110 | 4B 73 76 65 C7 EB 42 B5 C6 26 13 46 CD 7E 3C 26
0120 | 4D EB C9 BE F0 0E 7D 1A F7 3A 8F B7 20 B5 6A E6
0130 | 21 DF A0 FF BD 29 FB 37 ED 54 9A 31 E9 9E 44 64
0140 | D2 99 3C 70 17 01 8E E5 56 9B 40 D1 23 64 05 CA
0150 | BB A7 25 54 B1 3A 71 9D 29 BF BB 39 24 13 69 DD
0160 | 98 9A BD E7 F2 BB A2 C5 90 D6 3B D1 7D 54 B2 6D
0170 | EC 8C 35 69 F7 87 99 97 5D 62 5B 78 1D A2 5D A0
0180 | BD 45 91 E4 86 25 B2 D3 02 26 98 45 27 94 44 3B
0190 | 86 30 7F DC F1 78 B4 00 08 D0 66 D4 BE E9 7C 29
01A0 | D3 17 BC FF 23 C1 FA 0C 06 DD EE E6 77 FA CE F4
01B0 | FF E1 80 8E 28 16 18 74 DF 5F 1C DB 28 24 7B A0
01C0 | B1 AE 90 B7 D6 60 0E 27 17 A2 5D B5 06 E2 CA 17
01D0 | 67 46 BC 13 F8 2F 2F 19 61 64 F9 96 74 6B 2B 38
01E0 | 61 34 83 6F B3 BB 49 51 9F B4 13 29 C1 06 A7 FD
01F0 | 94 01 2C 75 AC 45 17 38 13 92 70 6E 50 B7 F8 3D
0200 | BC 05 EE 2F 65 F3 D7 B9 AE 49 46 8E F7 89 E2 4C
0210 | 30 76 80 E7 91 B4 FE 74 12 A0 1B E1 9C 7C A3 DB
0220 | AB 6A FD 79 13 AF E1 36 85 C5 B2 BF FD 9C 84 29
0230 | A0 30 66 C1 E9 77 18 48 22 FC 64 79 71 41 B6 BD
0240 | 7F 7B 5E 3F BB 5B 78 CB 00 76 03 C9 9F E6 C0 D5
0250 | BC 17 57 C5 0B BF 68 C3 2B DD AA E7 19 FA B8 9C
0260 | DB B5 DA 61 67 9D 09 A5 05 BD 0E B7 C2 14 78 E6
0270 | 0F 57 5E 8A 1F 2A 43 9C B1 6B 37 05 3A 8A 78 D6
0280 | 32 25 7D 2E 8E FA BE 31 11 4A 40 E5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015891A39416DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200CF8E68D3B307BC804EB9976C</code> <code>F93A39DC75C1EB07246CD867A1A42DE9</code> <code>12F52E3ABD4C3EA46DFEDE4C089E920D</code> <code>65C9571AEC43CA010BE8D1E7F763523B</code> <code>3A24C8060B4B7B910D72A2B5E1C8AB57</code> <code>B85D7178BD106B5DD64F83C6F2E16C5D</code> <code>A20DFE0DBB5177FF56ADFB38023E789C</code> <code>DA0209A9AF87C52703DA5EAC3CF31EE0</code> <code>AF94389C8732AE4AD25646BF735E9515</code> <code>F20E422499C188F1DD39AAA5D5B20C17</code> <code>F7D185049A4E1F4FB2BA84DD99B8B681</code> <code>1C092C24F77E92607AC9DF5034AD0F3E</code> <code>40F0FBE8C076D8328EF052E58001E25C</code> <code>786C04E587557E1D4B737665C7EB42B5</code> <code>C6261346CD7E3C264DEBC9BEF00E7D1A</code> <code>F73A8FB720B56AE621DFA0FFBD29FB37</code> <code>ED549A31E99E4464D2993C7017018EE5</code> <code>569B40D1236405CABBA72554B13A719D</code> <code>29BFBB39241369DD989ABDE7F2BBA2C5</code> <code>90D63BD17D54B26DEC8C3569F7879997</code> <code>5D625B781DA25DA0BD4591E48625B2D3</code> <code>022698452794443B86307FDCF178B400</code> <code>08D066D4BEE97C29D317BCFF23C1FA0C</code> <code>06DDEEE677FACEF4FFE1808E28161874</code> <code>DF5F1CDB28247BA0B1AE90B7D6600E27</code> <code>17A25DB506E2CA176746BC13F82F2F19</code> <code>6164F996746B2B386134836FB3BB4951</code> <code>9FB41329C106A7FD94012C75AC451738</code> <code>1392706E50B7F83DBC05EE2F65F3D7B9</code> <code>AE49468EF789E24C307680E791B4FE74</code> <code>12A01BE19C7CA3DBAB6AFD7913AFE136</code> <code>85C5B2BFFD9C8429A03066C1E9771848</code> <code>22FC64797141B6BD7F7B5E3FBB5B78CB</code> <code>007603C99FE6C0D5BC1757C50BBF68C3</code> <code>2BDDAAE719FAB89CDBB5DA61679D09A5</code> <code>05BD0EB7C21478E60F575E8A1F2A439C</code> <code>B16B37053A8A78D632257D2E8EFABE31</code><br> <code>114A40E5</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = CF8E68D3B307BC804EB9976CF93A39DC75C1EB07246CD867A1A42DE912F52E3ABD4C3EA46DFEDE4C089E920D65C9571AEC43CA010BE8D1E7F763523B3A24C8060B4B7B910D72A2B5E1C8AB57B85D7178BD106B5DD64F83C6F2E16C5DA20DFE0DBB5177FF56ADFB38023E789CDA0209A9AF87C52703DA5EAC3CF31EE0AF94389C8732AE4AD25646BF735E9515F20E422499C188F1DD39AAA5D5B20C17F7D185049A4E1F4FB2BA84DD99B8B6811C092C24F77E92607AC9DF5034AD0F3E40F0FBE8C076D8328EF052E58001E25C786C04E587557E1D4B737665C7EB42B5C6261346CD7E3C264DEBC9BEF00E7D1AF73A8FB720B56AE621DFA0FFBD29FB37ED549A31E99E4464D2993C7017018EE5569B40D1236405CABBA72554B13A719D29BFBB39241369DD989ABDE7F2BBA2C590D63BD17D54B26DEC8C3569F78799975D625B781DA25DA0BD4591E48625B2D3022698452794443B86307FDCF178B40008D066D4BEE97C29D317BCFF23C1FA0C06DDEEE677FACEF4FFE1808E28161874DF5F1CDB28247BA0B1AE90B7D6600E2717A25DB506E2CA176746BC13F82F2F196164F996746B2B386134836FB3BB49519FB41329C106A7FD94012C75AC4517381392706E50B7F83DBC05EE2F65F3D7B9AE49468EF789E24C307680E791B4FE7412A01BE19C7CA3DBAB6AFD7913AFE13685C5B2BFFD9C8429A03066C1E977184822FC64797141B6BD7F7B5E3FBB5B78CB007603C99FE6C0D5BC1757C50BBF68C32BDDAAE719FAB89CDBB5DA61679D09A505BD0EB7C21478E60F575E8A1F2A439CB16B37053A8A78D632257D2E8EFABE31114A40E5
tmp_aes_key = 4E2D6B7A6BF2DCAB1B604058DEDA60031071369B5F8E36559191A26A31E843D2
tmp_aes_iv = F17A44D84AB5CAC22745E8B35A5DF97C6747A515455B4B40C784881D48BB24CF</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 44EF092F1EEE94B025106F925DBC80A927CD9A7ABA0D89B559679BBCC806F4CB7008E8DD3671AFCDF81AF5197D69AC2D40802CBE3458F08903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005C26AAD0F5398EEE4DC765C8B4DADA78AB5F6162501C85F5925EE25C7E6C5F4F6288FD4457CE1DB6D9D374BE44E5A149755B85C59AC46F72504FFF155EAAB8F8F9CB1D5514615C083F243EF4226AEBD83AA34DEB71AF899E7E4EBEDFE619A085D71578E546D28EADB6F63953055890FB815FDF83176BD8DC3F5CD287DF237D0C0FB9718816EC33AC362F0B52A987AA94681CCC82DAFE7FA89DACE08156C7DC45DC7CBE68D3DE794ABC9B07FCDB3458FF652B6ED8FF8F084AAED537AADBD04A7FB7B91FDC49B8833ECC3FAFC61EA153E61529CFF3C234FE2D2DE4D7547C19F6254A23C96D33B52B0604BB96511316C9EEA361B4AFC722BDCFE0CC8005A21EECD39416DC68E99F58B52C206CA2
answer = BA0D89B559679BBCC806F4CB7008E8DD3671AFCDF81AF5197D69AC2D40802CBE3458F08903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001005C26AAD0F5398EEE4DC765C8B4DADA78AB5F6162501C85F5925EE25C7E6C5F4F6288FD4457CE1DB6D9D374BE44E5A149755B85C59AC46F72504FFF155EAAB8F8F9CB1D5514615C083F243EF4226AEBD83AA34DEB71AF899E7E4EBEDFE619A085D71578E546D28EADB6F63953055890FB815FDF83176BD8DC3F5CD287DF237D0C0FB9718816EC33AC362F0B52A987AA94681CCC82DAFE7FA89DACE08156C7DC45DC7CBE68D3DE794ABC9B07FCDB3458FF652B6ED8FF8F084AAED537AADBD04A7FB7B91FDC49B8833ECC3FAFC61EA153E61529CFF3C234FE2D2DE4D7547C19F6254A23C96D33B52B0604BB96511316C9EEA361B4AFC722BDCFE0CC8005A21EECD39416DC68E99F58B52C206CA2</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 59 67 9B BC C8 06 F4 CB 70 08 E8 DD
0010 | 36 71 AF CD F8 1A F5 19 7D 69 AC 2D 40 80 2C BE
0020 | 34 58 F0 89 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 5C 26 AA D0 F5 39 8E EE 4D C7 65 C8 B4 DA DA 78
0140 | AB 5F 61 62 50 1C 85 F5 92 5E E2 5C 7E 6C 5F 4F
0150 | 62 88 FD 44 57 CE 1D B6 D9 D3 74 BE 44 E5 A1 49
0160 | 75 5B 85 C5 9A C4 6F 72 50 4F FF 15 5E AA B8 F8
0170 | F9 CB 1D 55 14 61 5C 08 3F 24 3E F4 22 6A EB D8
0180 | 3A A3 4D EB 71 AF 89 9E 7E 4E BE DF E6 19 A0 85
0190 | D7 15 78 E5 46 D2 8E AD B6 F6 39 53 05 58 90 FB
01A0 | 81 5F DF 83 17 6B D8 DC 3F 5C D2 87 DF 23 7D 0C
01B0 | 0F B9 71 88 16 EC 33 AC 36 2F 0B 52 A9 87 AA 94
01C0 | 68 1C CC 82 DA FE 7F A8 9D AC E0 81 56 C7 DC 45
01D0 | DC 7C BE 68 D3 DE 79 4A BC 9B 07 FC DB 34 58 FF
01E0 | 65 2B 6E D8 FF 8F 08 4A AE D5 37 AA DB D0 4A 7F
01F0 | B7 B9 1F DC 49 B8 83 3E CC 3F AF C6 1E A1 53 E6
0200 | 15 29 CF F3 C2 34 FE 2D 2D E4 D7 54 7C 19 F6 25
0210 | 4A 23 C9 6D 33 B5 2B 06 04 BB 96 51 13 16 C9 EE
0220 | A3 61 B4 AF C7 22 BD CF E0 CC 80 05 A2 1E EC D3
0230 | 94 16 DC 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001005C26AAD0F5398EEE4DC765C8</code> <code>B4DADA78AB5F6162501C85F5925EE25C</code> <code>7E6C5F4F6288FD4457CE1DB6D9D374BE</code> <code>44E5A149755B85C59AC46F72504FFF15</code> <code>5EAAB8F8F9CB1D5514615C083F243EF4</code> <code>226AEBD83AA34DEB71AF899E7E4EBEDF</code> <code>E619A085D71578E546D28EADB6F63953</code> <code>055890FB815FDF83176BD8DC3F5CD287</code> <code>DF237D0C0FB9718816EC33AC362F0B52</code> <code>A987AA94681CCC82DAFE7FA89DACE081</code> <code>56C7DC45DC7CBE68D3DE794ABC9B07FC</code> <code>DB3458FF652B6ED8FF8F084AAED537AA</code> <code>DBD04A7FB7B91FDC49B8833ECC3FAFC6</code> <code>1EA153E61529CFF3C234FE2D2DE4D754</code> <code>7C19F6254A23C96D33B52B0604BB9651</code> <code>1316C9EEA361B4AFC722BDCFE0CC8005</code><br> <code>A21EECD3</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>9416DC68</code> (1759254164 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 32DA81D7A44D4188831CF250DB5FE86B47D48BE4C2CC990BCF0F552A878F0E5CC478F48E7879CA9414EC60D716872A7076DB8EA44AF32753DC5EF612BB8BBDA34B53F253DC3AAC22808CBE830DF7A7CF2B1C247C5C6B19836B8F8909FD016EBC96B91A64386724248F42C080ACA9842D212FC2329356AE71A47BEE2D89903D787E9F036036B5C5D8542198F8AF12A4CF0373E49B6FBE6B098428B0282F0A77EFEBC489A7F18B0F0DB44A0BE9FC9A1B67B1D3061EB25DAEFD19296AEFEEC6C10DE9F1FBB49D184B0D383B6A1A0E51A8B9FB7A3FDFFCA12B03CDCFD65E1563F0F8B526A9CEF109B24AB9D694D8C645ACACAA290F63A3A89E1C704208DE01988E38</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = C7017E1DA4346178E2FA9F32BDCD82CA956F8CA3D0234999513F217099E8F06DB2A06BDE2AF3813035AB8557C9FD545E3FE9F7E61C7BCEE35922C3AA23C895AFB6FF30744BCD0725D3DBED5915FE22B5C2724308C21306FAD7608B4227AFF47DB04F2C915EF99DF881504067B1E0E4E191F454986541FE81159EDCA3DA7604A528DC4C2EB042E5E77BEBE38F9CECEFBEFC6428C49F495FA64A7FEEC29DBE1199D37C35FB553952F1D6631EBEFED1C41C2FA649285FD77B7328828D60FFF8A0900CF9DB9A84EAEB19FE18BBAD65676367EA1E491AF06AC752B62E568473B57C4CD1ED0E02A389F2C94167EBF2ECD37119C0AF187F9E2CF2834678C9B159BAE6F2</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 59 67 9B BC C8 06 F4 CB 70 08 E8 DD
0010 | 36 71 AF CD F8 1A F5 19 7D 69 AC 2D 40 80 2C BE
0020 | 34 58 F0 89 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | C7 01 7E 1D A4 34 61 78 E2 FA 9F 32 BD CD 82 CA
0040 | 95 6F 8C A3 D0 23 49 99 51 3F 21 70 99 E8 F0 6D
0050 | B2 A0 6B DE 2A F3 81 30 35 AB 85 57 C9 FD 54 5E
0060 | 3F E9 F7 E6 1C 7B CE E3 59 22 C3 AA 23 C8 95 AF
0070 | B6 FF 30 74 4B CD 07 25 D3 DB ED 59 15 FE 22 B5
0080 | C2 72 43 08 C2 13 06 FA D7 60 8B 42 27 AF F4 7D
0090 | B0 4F 2C 91 5E F9 9D F8 81 50 40 67 B1 E0 E4 E1
00A0 | 91 F4 54 98 65 41 FE 81 15 9E DC A3 DA 76 04 A5
00B0 | 28 DC 4C 2E B0 42 E5 E7 7B EB E3 8F 9C EC EF BE
00C0 | FC 64 28 C4 9F 49 5F A6 4A 7F EE C2 9D BE 11 99
00D0 | D3 7C 35 FB 55 39 52 F1 D6 63 1E BE FE D1 C4 1C
00E0 | 2F A6 49 28 5F D7 7B 73 28 82 8D 60 FF F8 A0 90
00F0 | 0C F9 DB 9A 84 EA EB 19 FE 18 BB AD 65 67 63 67
0100 | EA 1E 49 1A F0 6A C7 52 B6 2E 56 84 73 B5 7C 4C
0110 | D1 ED 0E 02 A3 89 F2 C9 41 67 EB F2 EC D3 71 19
0120 | C0 AF 18 7F 9E 2C F2 83 46 78 C9 B1 59 BA E6 F2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100C7017E1DA4346178E2FA9F32</code> <code>BDCD82CA956F8CA3D0234999513F2170</code> <code>99E8F06DB2A06BDE2AF3813035AB8557</code> <code>C9FD545E3FE9F7E61C7BCEE35922C3AA</code> <code>23C895AFB6FF30744BCD0725D3DBED59</code> <code>15FE22B5C2724308C21306FAD7608B42</code> <code>27AFF47DB04F2C915EF99DF881504067</code> <code>B1E0E4E191F454986541FE81159EDCA3</code> <code>DA7604A528DC4C2EB042E5E77BEBE38F</code> <code>9CECEFBEFC6428C49F495FA64A7FEEC2</code> <code>9DBE1199D37C35FB553952F1D6631EBE</code> <code>FED1C41C2FA649285FD77B7328828D60</code> <code>FFF8A0900CF9DB9A84EAEB19FE18BBAD</code> <code>65676367EA1E491AF06AC752B62E5684</code> <code>73B57C4CD1ED0E02A389F2C94167EBF2</code> <code>ECD37119C0AF187F9E2CF2834678C9B1</code><br> <code>59BAE6F2</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436659679BBCC806F4CB7008E8DD3671AFCDF81AF5197D69AC2D40802CBE3458F0890000000000000000FE000100C7017E1DA4346178E2FA9F32BDCD82CA956F8CA3D0234999513F217099E8F06DB2A06BDE2AF3813035AB8557C9FD545E3FE9F7E61C7BCEE35922C3AA23C895AFB6FF30744BCD0725D3DBED5915FE22B5C2724308C21306FAD7608B4227AFF47DB04F2C915EF99DF881504067B1E0E4E191F454986541FE81159EDCA3DA7604A528DC4C2EB042E5E77BEBE38F9CECEFBEFC6428C49F495FA64A7FEEC29DBE1199D37C35FB553952F1D6631EBEFED1C41C2FA649285FD77B7328828D60FFF8A0900CF9DB9A84EAEB19FE18BBAD65676367EA1E491AF06AC752B62E568473B57C4CD1ED0E02A389F2C94167EBF2ECD37119C0AF187F9E2CF2834678C9B159BAE6F2
padding = 3D1C151EDED08C494F96DE45
tmp_aes_key = 4E2D6B7A6BF2DCAB1B604058DEDA60031071369B5F8E36559191A26A31E843D2
tmp_aes_iv = F17A44D84AB5CAC22745E8B35A5DF97C6747A515455B4B40C784881D48BB24CF</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 025D56851CFE6747EDA710DFFB6ACCA296BF039F4952C38A6078AB8F2E67AB6ABF10F473D97CABFF9E7CBC1FA18A9FECD4BD29F6F90B04DA86A8E54603A889FF793488847795F1E4121A0A09CA6B4646007CF51831D78A37F97FEE5D0F2A0955563901FA6AAE653C5FD74E66B8BDA6BF0B7D8D95BEDDEE4871649752648DC30F6A27041D600E939E5B06DBE943308E5F01F58DB82776EE6585C97FCEE9452F998BC130BBA3D8C2A471E82760D57482BD2012F7CF6D43267D126B480A913302BC3A7136FB051AC946B11BFA9749D0D3E36BE436878B0C3218553BDF58E2032B244AA44BF9476D916352675F95EC5EB6327F522DD1AEF96B734C47A5E40DAE5C795928CFA9960F89E71FEDF9D71602BB81006B857028D261C29FFD805EB90C0193C9C4BBE17104BD88752B3262A689D47B92FCF531FD2302D330DC784995B9C1DC0C0442E9A0B7F77203B3A062697F91D8</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 88 8E 0C 00 94 16 DC 68
0010 | 78 01 00 00 1F 5F 04 F5 59 67 9B BC C8 06 F4 CB
0020 | 70 08 E8 DD 36 71 AF CD F8 1A F5 19 7D 69 AC 2D
0030 | 40 80 2C BE 34 58 F0 89 FE 50 01 00 02 5D 56 85
0040 | 1C FE 67 47 ED A7 10 DF FB 6A CC A2 96 BF 03 9F
0050 | 49 52 C3 8A 60 78 AB 8F 2E 67 AB 6A BF 10 F4 73
0060 | D9 7C AB FF 9E 7C BC 1F A1 8A 9F EC D4 BD 29 F6
0070 | F9 0B 04 DA 86 A8 E5 46 03 A8 89 FF 79 34 88 84
0080 | 77 95 F1 E4 12 1A 0A 09 CA 6B 46 46 00 7C F5 18
0090 | 31 D7 8A 37 F9 7F EE 5D 0F 2A 09 55 56 39 01 FA
00A0 | 6A AE 65 3C 5F D7 4E 66 B8 BD A6 BF 0B 7D 8D 95
00B0 | BE DD EE 48 71 64 97 52 64 8D C3 0F 6A 27 04 1D
00C0 | 60 0E 93 9E 5B 06 DB E9 43 30 8E 5F 01 F5 8D B8
00D0 | 27 76 EE 65 85 C9 7F CE E9 45 2F 99 8B C1 30 BB
00E0 | A3 D8 C2 A4 71 E8 27 60 D5 74 82 BD 20 12 F7 CF
00F0 | 6D 43 26 7D 12 6B 48 0A 91 33 02 BC 3A 71 36 FB
0100 | 05 1A C9 46 B1 1B FA 97 49 D0 D3 E3 6B E4 36 87
0110 | 8B 0C 32 18 55 3B DF 58 E2 03 2B 24 4A A4 4B F9
0120 | 47 6D 91 63 52 67 5F 95 EC 5E B6 32 7F 52 2D D1
0130 | AE F9 6B 73 4C 47 A5 E4 0D AE 5C 79 59 28 CF A9
0140 | 96 0F 89 E7 1F ED F9 D7 16 02 BB 81 00 6B 85 70
0150 | 28 D2 61 C2 9F FD 80 5E B9 0C 01 93 C9 C4 BB E1
0160 | 71 04 BD 88 75 2B 32 62 A6 89 D4 7B 92 FC F5 31
0170 | FD 23 02 D3 30 DC 78 49 95 B9 C1 DC 0C 04 42 E9
0180 | A0 B7 F7 72 03 B3 A0 62 69 7F 91 D8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>888E0C009416DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100025D56851CFE6747EDA710DF</code> <code>FB6ACCA296BF039F4952C38A6078AB8F</code> <code>2E67AB6ABF10F473D97CABFF9E7CBC1F</code> <code>A18A9FECD4BD29F6F90B04DA86A8E546</code> <code>03A889FF793488847795F1E4121A0A09</code> <code>CA6B4646007CF51831D78A37F97FEE5D</code> <code>0F2A0955563901FA6AAE653C5FD74E66</code> <code>B8BDA6BF0B7D8D95BEDDEE4871649752</code> <code>648DC30F6A27041D600E939E5B06DBE9</code> <code>43308E5F01F58DB82776EE6585C97FCE</code> <code>E9452F998BC130BBA3D8C2A471E82760</code> <code>D57482BD2012F7CF6D43267D126B480A</code> <code>913302BC3A7136FB051AC946B11BFA97</code> <code>49D0D3E36BE436878B0C3218553BDF58</code> <code>E2032B244AA44BF9476D916352675F95</code> <code>EC5EB6327F522DD1AEF96B734C47A5E4</code> <code>0DAE5C795928CFA9960F89E71FEDF9D7</code> <code>1602BB81006B857028D261C29FFD805E</code> <code>B90C0193C9C4BBE17104BD88752B3262</code> <code>A689D47B92FCF531FD2302D330DC7849</code> <code>95B9C1DC0C0442E9A0B7F77203B3A062</code><br> <code>697F91D8</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 1D1CF313B34FEE8305A8233117BD56CFBB14762ACD49F79C8A29ED80550B6D4811D384B0DED63D4AAB3BB2B6FB484CA2866039898C3F0CC42656C159F927150F409C81746ECAE48F1F51847E611B17B7AB4C5F42B9BF0458D648DB99520ABACC4099F31F9BCE08FC10CAC7C4B13A94E06EA26EAEC0C752AC1C7D11F325C15F3B4764B4260137A5E77F72A5AE1E4287E99E0881D7C22F3E40E7471FCF70A9C7E6B1C9413CCE7999CB32FD86C71C331E79CB478A0FB825A5B02153288B421A72F0677E6186FC0B25C80B6521C519F75E2F941FAAD137DFBA66F1D79FAD6B2D390D643D7DF364A734FE0E2C244880CEFE033249B3EEB42B6BEC149CBE6161E0C580</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 8C 11 15 96 16 DC 68
0010 | 34 00 00 00 34 F7 CB 3B 59 67 9B BC C8 06 F4 CB
0020 | 70 08 E8 DD 36 71 AF CD F8 1A F5 19 7D 69 AC 2D
0030 | 40 80 2C BE 34 58 F0 89 C7 11 37 2B C3 60 F6 5D
0040 | F5 21 85 40 89 54 EB CE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018C11159616DC68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>59679BBCC806F4CB7008E8DD3671AFCD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F81AF5197D69AC2D40802CBE3458F089</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>C711372BC360F65DF52185408954EBCE</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

