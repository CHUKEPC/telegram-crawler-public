<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 0C 4F 0A 00 91 24 8C 66
0010 | 14 00 00 00 F1 8E 7E BE 5E 25 44 1D CD A9 58 CC
0020 | F5 B7 EA 41 05 B7 E0 C6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0C4F0A0091248C66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 0C F6 43 91 24 8C 66
0010 | 9C 00 00 00 63 24 16 05 5E 25 44 1D CD A9 58 CC
0020 | F5 B7 EA 41 05 B7 E0 C6 E1 9A 6A 77 B5 BF 45 7D
0030 | 85 3C CF 17 94 0B 62 C0 08 17 3D 29 59 1E 0C 3D
0040 | 6B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>010CF64391248C66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>9C000000</code> (156 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08173D29591E0C3D6B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1674540099184639339</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1674540099184639339</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1674540099184639339 = 1287208969 * 1300907731</code></p>
<pre><code>p = 1287208969
q = 1300907731</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 17 3D 29 59 1E 0C 3D 6B 00 00 00
0010 | 04 4C B9 40 09 00 00 00 04 4D 8A 46 D3 00 00 00
0020 | 5E 25 44 1D CD A9 58 CC F5 B7 EA 41 05 B7 E0 C6
0030 | E1 9A 6A 77 B5 BF 45 7D 85 3C CF 17 94 0B 62 C0
0040 | 04 E9 ED CC D3 54 84 06 27 82 B8 B5 1E E0 E0 4A
0050 | F0 EB 92 0C 36 C3 85 94 E9 57 E9 63 67 98 98 F7
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08173D29591E0C3D6B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1674540099184639339</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044CB94009000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1287208969</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044D8A46D3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1300907731</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>04E9EDCCD35484062782B8B51EE0E04A</code> <code>F0EB920C36C38594E957E963679898F7</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908173D29591E0C3D6B000000044CB94009000000044D8A46D30000005E25441DCDA958CCF5B7EA4105B7E0C6E19A6A77B5BF457D853CCF17940B62C004E9EDCCD35484062782B8B51EE0E04AF0EB920C36C38594E957E963679898F702000000
random_padding_bytes = 05FCDA12794F11E8208C4ECC11C9DAB673246A281F3C7FA0627F462A4CCCC4AEB71AF957F3E836986173E35F29420D008D2AA21A0EEC0B43A8018B1398812EE21B8EE7A89A8D0E39BF149C15FCB3065B7405EB53A377ECD0BCB419C9</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 106E7597AC8537688386D3552F5FA8CB1707701B4EF13DB347C44F2D12DE4D1024E2AD1FF45EDD26D140C918582418C5DBDA2D2A493339543D43152ED817C7D9A1830285E890119E04CBA2383E9A7B289216C1888CC66BCA7CE1933EA20FED256BC6064E3209E7BDB3A3E8742C1C88BC0B386576F2FA2DD5C437706A36E0CE08F0C73B6D04744E7555D4B8EA55E93E4E9B4E50BD68CF7A8094E0F8A898B8AE28584A3CD60EF9546BE2DBC1135AD865DFD8436ED22782A54643423F110AC6708FCEF949CB6E0525A38447377AD5623E31EA60625258DFCE5A1CCACEC205E124580AE2B982450EC714F24FDC4D5BD822062F96FABB4F041E868D8C0754B4FF44A6</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 10 4F 0A 00 91 24 8C 66
0010 | 40 01 00 00 BE E4 12 D7 5E 25 44 1D CD A9 58 CC
0020 | F5 B7 EA 41 05 B7 E0 C6 E1 9A 6A 77 B5 BF 45 7D
0030 | 85 3C CF 17 94 0B 62 C0 04 4C B9 40 09 00 00 00
0040 | 04 4D 8A 46 D3 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 10 6E 75 97 AC 85 37 68 83 86 D3 55
0060 | 2F 5F A8 CB 17 07 70 1B 4E F1 3D B3 47 C4 4F 2D
0070 | 12 DE 4D 10 24 E2 AD 1F F4 5E DD 26 D1 40 C9 18
0080 | 58 24 18 C5 DB DA 2D 2A 49 33 39 54 3D 43 15 2E
0090 | D8 17 C7 D9 A1 83 02 85 E8 90 11 9E 04 CB A2 38
00A0 | 3E 9A 7B 28 92 16 C1 88 8C C6 6B CA 7C E1 93 3E
00B0 | A2 0F ED 25 6B C6 06 4E 32 09 E7 BD B3 A3 E8 74
00C0 | 2C 1C 88 BC 0B 38 65 76 F2 FA 2D D5 C4 37 70 6A
00D0 | 36 E0 CE 08 F0 C7 3B 6D 04 74 4E 75 55 D4 B8 EA
00E0 | 55 E9 3E 4E 9B 4E 50 BD 68 CF 7A 80 94 E0 F8 A8
00F0 | 98 B8 AE 28 58 4A 3C D6 0E F9 54 6B E2 DB C1 13
0100 | 5A D8 65 DF D8 43 6E D2 27 82 A5 46 43 42 3F 11
0110 | 0A C6 70 8F CE F9 49 CB 6E 05 25 A3 84 47 37 7A
0120 | D5 62 3E 31 EA 60 62 52 58 DF CE 5A 1C CA CE C2
0130 | 05 E1 24 58 0A E2 B9 82 45 0E C7 14 F2 4F DC 4D
0140 | 5B D8 22 06 2F 96 FA BB 4F 04 1E 86 8D 8C 07 54
0150 | B4 FF 44 A6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>104F0A0091248C66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044CB94009000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1287208969</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044D8A46D3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1300907731</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100106E7597AC8537688386D355</code> <code>2F5FA8CB1707701B4EF13DB347C44F2D</code> <code>12DE4D1024E2AD1FF45EDD26D140C918</code> <code>582418C5DBDA2D2A493339543D43152E</code> <code>D817C7D9A1830285E890119E04CBA238</code> <code>3E9A7B289216C1888CC66BCA7CE1933E</code> <code>A20FED256BC6064E3209E7BDB3A3E874</code> <code>2C1C88BC0B386576F2FA2DD5C437706A</code> <code>36E0CE08F0C73B6D04744E7555D4B8EA</code> <code>55E93E4E9B4E50BD68CF7A8094E0F8A8</code> <code>98B8AE28584A3CD60EF9546BE2DBC113</code> <code>5AD865DFD8436ED22782A54643423F11</code> <code>0AC6708FCEF949CB6E0525A38447377A</code> <code>D5623E31EA60625258DFCE5A1CCACEC2</code> <code>05E124580AE2B982450EC714F24FDC4D</code> <code>5BD822062F96FABB4F041E868D8C0754</code><br> <code>B4FF44A6</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 74 E5 18 92 24 8C 66
0010 | D0 02 00 00 5C 07 E8 D0 5E 25 44 1D CD A9 58 CC
0020 | F5 B7 EA 41 05 B7 E0 C6 E1 9A 6A 77 B5 BF 45 7D
0030 | 85 3C CF 17 94 0B 62 C0 FE 50 02 00 61 D3 16 C0
0040 | EB D2 C3 08 47 DE 15 A6 41 F5 E4 AE C0 A3 D8 ED
0050 | 2C 45 2C 85 FB 78 E8 EA 09 73 4D B6 16 21 B1 EF
0060 | A4 FF 27 D3 2D 6E 4F 34 68 13 6F 94 0C D2 BD 78
0070 | E5 5F A1 D7 F5 BF 23 2D 69 1D EA BD 00 A0 64 2D
0080 | B8 BC 54 60 09 0B 99 8D 65 4D 99 82 81 A4 E5 74
0090 | 10 AC 56 83 6E AD 68 5A F2 79 95 D8 EB 85 D6 C2
00A0 | E9 0F 50 27 E3 06 C7 E5 04 29 4A 05 10 17 56 AD
00B0 | AB 98 33 65 B5 1E 8D 33 E8 31 ED CB 7B 0A 90 AE
00C0 | 7F 8F 4F AD FE A6 49 39 99 80 5A 4A 04 4B 56 D1
00D0 | 14 7E 1D 3D B7 B3 A2 76 26 98 80 20 92 59 94 E3
00E0 | 11 79 C4 E4 4B AA B7 C1 1A 47 9C D5 75 5E EC BA
00F0 | 3E 55 28 E6 C6 14 52 97 58 F8 8E AC 3A 92 D7 EC
0100 | 9D 3E 2E F8 94 B2 60 4E 18 6B 2A 31 B4 65 42 22
0110 | BE 8B 7F F5 71 D8 20 FB B6 AA CD 06 BE 97 20 47
0120 | B6 B1 9C D0 F4 68 FA 13 D2 85 B8 B2 AE 71 A2 14
0130 | 18 10 DA 43 37 56 BF C6 28 2F 1C 7E 5B 06 58 7D
0140 | 60 05 4E 26 8D 7F F0 7A F7 11 FE E4 A8 52 71 6B
0150 | 74 A0 4A F5 DC 93 7C F4 A1 7A 63 43 07 28 E8 0C
0160 | 4E 7E 55 BE 3C A1 59 C4 80 AB DB B8 AA 01 B9 84
0170 | F8 A0 27 2C 20 1F 54 C9 7A 44 3A 18 82 D0 23 AC
0180 | F7 A7 46 98 1D A3 C8 20 DD 46 B8 7D F5 B1 5D 9A
0190 | 6D E6 B0 AC 13 33 C2 99 A5 C2 04 24 10 2A E4 1B
01A0 | B0 C6 27 3D AD F4 94 91 27 F0 98 F3 EB 1F 45 FE
01B0 | 45 D9 20 4C 03 0C FB 15 F3 11 BC FA 58 47 4B 5B
01C0 | D4 56 0B 56 C9 CF 98 E3 55 D1 DD 5D 8C F3 27 1F
01D0 | E3 71 5D 24 BC 2A F6 DC D9 5F 28 05 97 92 2D 2A
01E0 | BD F6 12 D4 DA 88 B8 AC 91 F5 B0 C6 B0 91 FA EE
01F0 | 3B CC E9 73 3E 4F AB 3E C8 B7 15 41 85 EB DF 2B
0200 | 74 9B D6 0C C6 D6 5C ED 8F 1F FF BE D8 AA B7 94
0210 | 3E A4 C6 F0 3C 5E 70 48 67 5C DD A0 74 16 E4 56
0220 | 05 C3 EF E2 1C C2 00 7F 03 01 B8 C5 EA 14 9D 32
0230 | 4D C5 29 B3 70 34 DC 66 1F 3E 13 00 43 36 86 15
0240 | 0B A9 73 DA 7D E4 C8 DA 98 A1 71 24 0B 74 9D 80
0250 | 71 6E 87 5F 32 04 21 49 3D 5D BD DB 0B D7 71 2F
0260 | B9 CE 88 35 14 21 DC E3 20 44 8A D6 46 3D F0 08
0270 | A7 06 7E CC C8 DE E2 6A 11 42 EF F2 BE DB A7 C6
0280 | F2 E1 89 7D A4 1F 3E 12 68 AB 38 A2</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0174E51892248C66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>D0020000</code> (720 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020061D316C0EBD2C30847DE15A6</code> <code>41F5E4AEC0A3D8ED2C452C85FB78E8EA</code> <code>09734DB61621B1EFA4FF27D32D6E4F34</code> <code>68136F940CD2BD78E55FA1D7F5BF232D</code> <code>691DEABD00A0642DB8BC5460090B998D</code> <code>654D998281A4E57410AC56836EAD685A</code> <code>F27995D8EB85D6C2E90F5027E306C7E5</code> <code>04294A05101756ADAB983365B51E8D33</code> <code>E831EDCB7B0A90AE7F8F4FADFEA64939</code> <code>99805A4A044B56D1147E1D3DB7B3A276</code> <code>26988020925994E31179C4E44BAAB7C1</code> <code>1A479CD5755EECBA3E5528E6C6145297</code> <code>58F88EAC3A92D7EC9D3E2EF894B2604E</code> <code>186B2A31B4654222BE8B7FF571D820FB</code> <code>B6AACD06BE972047B6B19CD0F468FA13</code> <code>D285B8B2AE71A2141810DA433756BFC6</code> <code>282F1C7E5B06587D60054E268D7FF07A</code> <code>F711FEE4A852716B74A04AF5DC937CF4</code> <code>A17A63430728E80C4E7E55BE3CA159C4</code> <code>80ABDBB8AA01B984F8A0272C201F54C9</code> <code>7A443A1882D023ACF7A746981DA3C820</code> <code>DD46B87DF5B15D9A6DE6B0AC1333C299</code> <code>A5C20424102AE41BB0C6273DADF49491</code> <code>27F098F3EB1F45FE45D9204C030CFB15</code> <code>F311BCFA58474B5BD4560B56C9CF98E3</code> <code>55D1DD5D8CF3271FE3715D24BC2AF6DC</code> <code>D95F280597922D2ABDF612D4DA88B8AC</code> <code>91F5B0C6B091FAEE3BCCE9733E4FAB3E</code> <code>C8B7154185EBDF2B749BD60CC6D65CED</code> <code>8F1FFFBED8AAB7943EA4C6F03C5E7048</code> <code>675CDDA07416E45605C3EFE21CC2007F</code> <code>0301B8C5EA149D324DC529B37034DC66</code> <code>1F3E1300433686150BA973DA7DE4C8DA</code> <code>98A171240B749D80716E875F32042149</code> <code>3D5DBDDB0BD7712FB9CE88351421DCE3</code> <code>20448AD6463DF008A7067ECCC8DEE26A</code> <code>1142EFF2BEDBA7C6F2E1897DA41F3E12</code><br> <code>68AB38A2</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 61D316C0EBD2C30847DE15A641F5E4AEC0A3D8ED2C452C85FB78E8EA09734DB61621B1EFA4FF27D32D6E4F3468136F940CD2BD78E55FA1D7F5BF232D691DEABD00A0642DB8BC5460090B998D654D998281A4E57410AC56836EAD685AF27995D8EB85D6C2E90F5027E306C7E504294A05101756ADAB983365B51E8D33E831EDCB7B0A90AE7F8F4FADFEA6493999805A4A044B56D1147E1D3DB7B3A27626988020925994E31179C4E44BAAB7C11A479CD5755EECBA3E5528E6C614529758F88EAC3A92D7EC9D3E2EF894B2604E186B2A31B4654222BE8B7FF571D820FBB6AACD06BE972047B6B19CD0F468FA13D285B8B2AE71A2141810DA433756BFC6282F1C7E5B06587D60054E268D7FF07AF711FEE4A852716B74A04AF5DC937CF4A17A63430728E80C4E7E55BE3CA159C480ABDBB8AA01B984F8A0272C201F54C97A443A1882D023ACF7A746981DA3C820DD46B87DF5B15D9A6DE6B0AC1333C299A5C20424102AE41BB0C6273DADF4949127F098F3EB1F45FE45D9204C030CFB15F311BCFA58474B5BD4560B56C9CF98E355D1DD5D8CF3271FE3715D24BC2AF6DCD95F280597922D2ABDF612D4DA88B8AC91F5B0C6B091FAEE3BCCE9733E4FAB3EC8B7154185EBDF2B749BD60CC6D65CED8F1FFFBED8AAB7943EA4C6F03C5E7048675CDDA07416E45605C3EFE21CC2007F0301B8C5EA149D324DC529B37034DC661F3E1300433686150BA973DA7DE4C8DA98A171240B749D80716E875F320421493D5DBDDB0BD7712FB9CE88351421DCE320448AD6463DF008A7067ECCC8DEE26A1142EFF2BEDBA7C6F2E1897DA41F3E1268AB38A2
tmp_aes_key = DBCF1FC91FB69D06743207C365B21B3236C3239BC16D1FA2F1E5737D346365E4
tmp_aes_iv = FEDE50CC239D1D4615DDC024494D93043E25B6DC35107E00A77C687104E9EDCC</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = AD628A05D5D30CA6DD7185E1BEB7F5E9C3AE1075BA0D89B55E25441DCDA958CCF5B7EA4105B7E0C6E19A6A77B5BF457D853CCF17940B62C003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010007148DE492382AA5BA4EAAF239DDA648270F0B711489B661209C0002A0483BD86DFC8B4E6784312BFA5713652C00A753FD67412CD30A7E0B0D522FDF4594E3F951A16E6A6D8385EF698FAA7F9D69F3F7354917251119106897BE71EA470D0700EDC1449911115C517260DE60AACA91BF4F32C3EE1E7CCC6829E185009B97D344DF0B8D8126D5500EB2B8D93E571A303355D51BD46B0B2A1D0EC87D967CB2BACD424C1A159F1AD4C855474C9414D0900AE4CC1207396902F557FE773DDDB7B3B81E2AF223C06BF722379CAA5D67D3866A0F986CA0BE90807B9D4D6655CE39593570B47F52C193EE45B5DE842A890FEA55071515BF181D44D4EF3C6E323E45154492248C66A8FE4155D28B274B
answer = BA0D89B55E25441DCDA958CCF5B7EA4105B7E0C6E19A6A77B5BF457D853CCF17940B62C003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010007148DE492382AA5BA4EAAF239DDA648270F0B711489B661209C0002A0483BD86DFC8B4E6784312BFA5713652C00A753FD67412CD30A7E0B0D522FDF4594E3F951A16E6A6D8385EF698FAA7F9D69F3F7354917251119106897BE71EA470D0700EDC1449911115C517260DE60AACA91BF4F32C3EE1E7CCC6829E185009B97D344DF0B8D8126D5500EB2B8D93E571A303355D51BD46B0B2A1D0EC87D967CB2BACD424C1A159F1AD4C855474C9414D0900AE4CC1207396902F557FE773DDDB7B3B81E2AF223C06BF722379CAA5D67D3866A0F986CA0BE90807B9D4D6655CE39593570B47F52C193EE45B5DE842A890FEA55071515BF181D44D4EF3C6E323E45154492248C66A8FE4155D28B274B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 5E 25 44 1D CD A9 58 CC F5 B7 EA 41
0010 | 05 B7 E0 C6 E1 9A 6A 77 B5 BF 45 7D 85 3C CF 17
0020 | 94 0B 62 C0 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 07 14 8D E4 92 38 2A A5 BA 4E AA F2 39 DD A6 48
0140 | 27 0F 0B 71 14 89 B6 61 20 9C 00 02 A0 48 3B D8
0150 | 6D FC 8B 4E 67 84 31 2B FA 57 13 65 2C 00 A7 53
0160 | FD 67 41 2C D3 0A 7E 0B 0D 52 2F DF 45 94 E3 F9
0170 | 51 A1 6E 6A 6D 83 85 EF 69 8F AA 7F 9D 69 F3 F7
0180 | 35 49 17 25 11 19 10 68 97 BE 71 EA 47 0D 07 00
0190 | ED C1 44 99 11 11 5C 51 72 60 DE 60 AA CA 91 BF
01A0 | 4F 32 C3 EE 1E 7C CC 68 29 E1 85 00 9B 97 D3 44
01B0 | DF 0B 8D 81 26 D5 50 0E B2 B8 D9 3E 57 1A 30 33
01C0 | 55 D5 1B D4 6B 0B 2A 1D 0E C8 7D 96 7C B2 BA CD
01D0 | 42 4C 1A 15 9F 1A D4 C8 55 47 4C 94 14 D0 90 0A
01E0 | E4 CC 12 07 39 69 02 F5 57 FE 77 3D DD B7 B3 B8
01F0 | 1E 2A F2 23 C0 6B F7 22 37 9C AA 5D 67 D3 86 6A
0200 | 0F 98 6C A0 BE 90 80 7B 9D 4D 66 55 CE 39 59 35
0210 | 70 B4 7F 52 C1 93 EE 45 B5 DE 84 2A 89 0F EA 55
0220 | 07 15 15 BF 18 1D 44 D4 EF 3C 6E 32 3E 45 15 44
0230 | 92 24 8C 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010007148DE492382AA5BA4EAAF2</code> <code>39DDA648270F0B711489B661209C0002</code> <code>A0483BD86DFC8B4E6784312BFA571365</code> <code>2C00A753FD67412CD30A7E0B0D522FDF</code> <code>4594E3F951A16E6A6D8385EF698FAA7F</code> <code>9D69F3F7354917251119106897BE71EA</code> <code>470D0700EDC1449911115C517260DE60</code> <code>AACA91BF4F32C3EE1E7CCC6829E18500</code> <code>9B97D344DF0B8D8126D5500EB2B8D93E</code> <code>571A303355D51BD46B0B2A1D0EC87D96</code> <code>7CB2BACD424C1A159F1AD4C855474C94</code> <code>14D0900AE4CC1207396902F557FE773D</code> <code>DDB7B3B81E2AF223C06BF722379CAA5D</code> <code>67D3866A0F986CA0BE90807B9D4D6655</code> <code>CE39593570B47F52C193EE45B5DE842A</code> <code>890FEA55071515BF181D44D4EF3C6E32</code><br> <code>3E451544</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>92248C66</code> (1720460434 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 9CEA08D742748F64421BE17126105940F5CE9E678CF44A3B263BC0EA928AD51A1EB89E9416E8F2890E4AA7C1A66BE3E3185C389BBAEE318A1004CD337C28556E3CEBE4F8F7E6AB245995AF987D02952635392879EF9CC4A1C4BBB3430A892B3F7F66683C2ABD11298DFD05916B4467CB279203A9A2535A9ECE53AC3CF5B86F4039315949A76429836D7D59413CBAF0C8FE790BD976C9242EF58A8A9EEABFD645196D26D0248434B4EEFA0964EC94C0920B6D69EBA5EA02D090B691B642813149DF2BFF8C42A0BDE6B5224F4C9D8B10139E778B8DD971E28A8FC59C96139C1A90B0F4EFE89723B8E02A844DBD363514488353BDEDA678E0F40A72509319CBB1BA</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 8A1D81BA74D081C5FC2E52D8969353A323DDA95B793F2188C05DA2B6918FBB6DC95BEE6121ACE5B3B5CAC9B34B24AA751EBE73B3A2F924C360CA0B75B07840D3E8D1F382131C582CF0A7CC5A015A119434A81750DE8EA3B5B97321DF9BB7E4408498FE2AD129D6EFE4DACED2EECA3247262AA2A65A727CD74EDDDC914C0C280096270C487205D1D18A0F882AE79E01C9D9829A0E74E439DD658992BDBF516F76910FC881C578AC7BD69B3E001CFAF3AAC83D1438B4C5C3D0370853A6E7B5EE8346C6225C6A75910FB4A03BAB624371839952D162274D57A52BB4FC757D50F152146494ABAB58232B6CF8287E1BDE987984C3D6908D1CD04411543022B45E8975</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 5E 25 44 1D CD A9 58 CC F5 B7 EA 41
0010 | 05 B7 E0 C6 E1 9A 6A 77 B5 BF 45 7D 85 3C CF 17
0020 | 94 0B 62 C0 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 8A 1D 81 BA 74 D0 81 C5 FC 2E 52 D8 96 93 53 A3
0040 | 23 DD A9 5B 79 3F 21 88 C0 5D A2 B6 91 8F BB 6D
0050 | C9 5B EE 61 21 AC E5 B3 B5 CA C9 B3 4B 24 AA 75
0060 | 1E BE 73 B3 A2 F9 24 C3 60 CA 0B 75 B0 78 40 D3
0070 | E8 D1 F3 82 13 1C 58 2C F0 A7 CC 5A 01 5A 11 94
0080 | 34 A8 17 50 DE 8E A3 B5 B9 73 21 DF 9B B7 E4 40
0090 | 84 98 FE 2A D1 29 D6 EF E4 DA CE D2 EE CA 32 47
00A0 | 26 2A A2 A6 5A 72 7C D7 4E DD DC 91 4C 0C 28 00
00B0 | 96 27 0C 48 72 05 D1 D1 8A 0F 88 2A E7 9E 01 C9
00C0 | D9 82 9A 0E 74 E4 39 DD 65 89 92 BD BF 51 6F 76
00D0 | 91 0F C8 81 C5 78 AC 7B D6 9B 3E 00 1C FA F3 AA
00E0 | C8 3D 14 38 B4 C5 C3 D0 37 08 53 A6 E7 B5 EE 83
00F0 | 46 C6 22 5C 6A 75 91 0F B4 A0 3B AB 62 43 71 83
0100 | 99 52 D1 62 27 4D 57 A5 2B B4 FC 75 7D 50 F1 52
0110 | 14 64 94 AB AB 58 23 2B 6C F8 28 7E 1B DE 98 79
0120 | 84 C3 D6 90 8D 1C D0 44 11 54 30 22 B4 5E 89 75</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001008A1D81BA74D081C5FC2E52D8</code> <code>969353A323DDA95B793F2188C05DA2B6</code> <code>918FBB6DC95BEE6121ACE5B3B5CAC9B3</code> <code>4B24AA751EBE73B3A2F924C360CA0B75</code> <code>B07840D3E8D1F382131C582CF0A7CC5A</code> <code>015A119434A81750DE8EA3B5B97321DF</code> <code>9BB7E4408498FE2AD129D6EFE4DACED2</code> <code>EECA3247262AA2A65A727CD74EDDDC91</code> <code>4C0C280096270C487205D1D18A0F882A</code> <code>E79E01C9D9829A0E74E439DD658992BD</code> <code>BF516F76910FC881C578AC7BD69B3E00</code> <code>1CFAF3AAC83D1438B4C5C3D0370853A6</code> <code>E7B5EE8346C6225C6A75910FB4A03BAB</code> <code>624371839952D162274D57A52BB4FC75</code> <code>7D50F152146494ABAB58232B6CF8287E</code> <code>1BDE987984C3D6908D1CD04411543022</code><br> <code>B45E8975</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643665E25441DCDA958CCF5B7EA4105B7E0C6E19A6A77B5BF457D853CCF17940B62C00000000000000000FE0001008A1D81BA74D081C5FC2E52D8969353A323DDA95B793F2188C05DA2B6918FBB6DC95BEE6121ACE5B3B5CAC9B34B24AA751EBE73B3A2F924C360CA0B75B07840D3E8D1F382131C582CF0A7CC5A015A119434A81750DE8EA3B5B97321DF9BB7E4408498FE2AD129D6EFE4DACED2EECA3247262AA2A65A727CD74EDDDC914C0C280096270C487205D1D18A0F882AE79E01C9D9829A0E74E439DD658992BDBF516F76910FC881C578AC7BD69B3E001CFAF3AAC83D1438B4C5C3D0370853A6E7B5EE8346C6225C6A75910FB4A03BAB624371839952D162274D57A52BB4FC757D50F152146494ABAB58232B6CF8287E1BDE987984C3D6908D1CD04411543022B45E8975
padding = BD53D968A222B2BEA4DEB2C4
tmp_aes_key = DBCF1FC91FB69D06743207C365B21B3236C3239BC16D1FA2F1E5737D346365E4
tmp_aes_iv = FEDE50CC239D1D4615DDC024494D93043E25B6DC35107E00A77C687104E9EDCC</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 256B0213EF07F47844C2D3B6E99BB244AE5A6B1F2864F48228D2DC7CEA069925A433DDCD8527D069037E355611FC1C83BED55909BC3B3085BA824A64188B06A2FC88D9FC7FCECECDE8B0F68727F60852AB08D8E5841BDAF2D3EE966BE31547A5D2AA01666219465EB5614488D8BF259A5D35BA30B0E530813CC13523FBCD87BD0515E22D2E61DC7076B10EC108EEB07BD20CB0A42BCF9A29254DA51382808593DECEF3237D797A7DE708EFD869F55AEC43725EA5F1D59AC7AB8BDCA003B2481B7113FCA223647ECEDD81C073E7F843D42BFF887A9B32A7F286AF4E7085D1477817162F6209E3B3679A4045E25DC94688C888D8068BB4FB70221D15E619FAACDD33E604CB6CBF5EF0B0E5272B48186F890AAD0EC05134DF37C8DE50FE848C0E5F352FCEE2293C98F0BF546C57491705BD4D352423CE4AB26CFE9EB5ED735DF0658D31C5A3540E80ED5ECE32E5DBD826F3</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 5C 59 01 00 92 24 8C 66
0010 | 78 01 00 00 1F 5F 04 F5 5E 25 44 1D CD A9 58 CC
0020 | F5 B7 EA 41 05 B7 E0 C6 E1 9A 6A 77 B5 BF 45 7D
0030 | 85 3C CF 17 94 0B 62 C0 FE 50 01 00 25 6B 02 13
0040 | EF 07 F4 78 44 C2 D3 B6 E9 9B B2 44 AE 5A 6B 1F
0050 | 28 64 F4 82 28 D2 DC 7C EA 06 99 25 A4 33 DD CD
0060 | 85 27 D0 69 03 7E 35 56 11 FC 1C 83 BE D5 59 09
0070 | BC 3B 30 85 BA 82 4A 64 18 8B 06 A2 FC 88 D9 FC
0080 | 7F CE CE CD E8 B0 F6 87 27 F6 08 52 AB 08 D8 E5
0090 | 84 1B DA F2 D3 EE 96 6B E3 15 47 A5 D2 AA 01 66
00A0 | 62 19 46 5E B5 61 44 88 D8 BF 25 9A 5D 35 BA 30
00B0 | B0 E5 30 81 3C C1 35 23 FB CD 87 BD 05 15 E2 2D
00C0 | 2E 61 DC 70 76 B1 0E C1 08 EE B0 7B D2 0C B0 A4
00D0 | 2B CF 9A 29 25 4D A5 13 82 80 85 93 DE CE F3 23
00E0 | 7D 79 7A 7D E7 08 EF D8 69 F5 5A EC 43 72 5E A5
00F0 | F1 D5 9A C7 AB 8B DC A0 03 B2 48 1B 71 13 FC A2
0100 | 23 64 7E CE DD 81 C0 73 E7 F8 43 D4 2B FF 88 7A
0110 | 9B 32 A7 F2 86 AF 4E 70 85 D1 47 78 17 16 2F 62
0120 | 09 E3 B3 67 9A 40 45 E2 5D C9 46 88 C8 88 D8 06
0130 | 8B B4 FB 70 22 1D 15 E6 19 FA AC DD 33 E6 04 CB
0140 | 6C BF 5E F0 B0 E5 27 2B 48 18 6F 89 0A AD 0E C0
0150 | 51 34 DF 37 C8 DE 50 FE 84 8C 0E 5F 35 2F CE E2
0160 | 29 3C 98 F0 BF 54 6C 57 49 17 05 BD 4D 35 24 23
0170 | CE 4A B2 6C FE 9E B5 ED 73 5D F0 65 8D 31 C5 A3
0180 | 54 0E 80 ED 5E CE 32 E5 DB D8 26 F3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>5C59010092248C66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100256B0213EF07F47844C2D3B6</code> <code>E99BB244AE5A6B1F2864F48228D2DC7C</code> <code>EA069925A433DDCD8527D069037E3556</code> <code>11FC1C83BED55909BC3B3085BA824A64</code> <code>188B06A2FC88D9FC7FCECECDE8B0F687</code> <code>27F60852AB08D8E5841BDAF2D3EE966B</code> <code>E31547A5D2AA01666219465EB5614488</code> <code>D8BF259A5D35BA30B0E530813CC13523</code> <code>FBCD87BD0515E22D2E61DC7076B10EC1</code> <code>08EEB07BD20CB0A42BCF9A29254DA513</code> <code>82808593DECEF3237D797A7DE708EFD8</code> <code>69F55AEC43725EA5F1D59AC7AB8BDCA0</code> <code>03B2481B7113FCA223647ECEDD81C073</code> <code>E7F843D42BFF887A9B32A7F286AF4E70</code> <code>85D1477817162F6209E3B3679A4045E2</code> <code>5DC94688C888D8068BB4FB70221D15E6</code> <code>19FAACDD33E604CB6CBF5EF0B0E5272B</code> <code>48186F890AAD0EC05134DF37C8DE50FE</code> <code>848C0E5F352FCEE2293C98F0BF546C57</code> <code>491705BD4D352423CE4AB26CFE9EB5ED</code> <code>735DF0658D31C5A3540E80ED5ECE32E5</code><br> <code>DBD826F3</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2870BD4BE4D3304C40D8ADF9C06FB0119235D22AB35A3F91175816250B6083D3CB0FD072C307099CC95635C1F80ADC58C5365B7FFC8BE0BF69006834D6943CBB54E920875C2C5ADE9281E124748C9310D20410F5783466102DFFFD8C75F58BD033063467EA6706F3CA86EE082FAFAE9BE80D4C423765A759B78EC9C625C84325C68E8A965417170B431BA18CF59F4DECE65DBAD2CEB54DD4C3E0430211ED3240B1559752FDC14A0FF1D202E63FD657C4E950FF55F770B0BDC1C1781B58BCE67EAE11F267D16540E46EB68FBF995FA681D3958398E846B045259487F2E12CD7CB5405F3DBE92C78A9B6DBD963D749FC1B850B3FBCE83EEEA288028F34A14D437E</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B8 AF B4 92 24 8C 66
0010 | 94 00 00 00 34 F7 CB 3B 5E 25 44 1D CD A9 58 CC
0020 | F5 B7 EA 41 05 B7 E0 C6 E1 9A 6A 77 B5 BF 45 7D
0030 | 85 3C CF 17 94 0B 62 C0 A2 8A 60 B3 C1 1D 2A D1
0040 | 52 E9 D2 3C 32 0D 7F F7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B8AFB492248C66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>94000000</code> (148 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>5E25441DCDA958CCF5B7EA4105B7E0C6</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E19A6A77B5BF457D853CCF17940B62C0</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>A28A60B3C11D2AD152E9D23C320D7FF7</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

