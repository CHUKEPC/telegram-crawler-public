<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 14 6F 0E 00 45 49 A1 66
0010 | 14 00 00 00 F1 8E 7E BE C3 FA 31 68 7F B1 4A FE
0020 | 6E BB 7B F5 D8 7B 57 4C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>146F0E004549A166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D4 D3 1E 45 49 A1 66
0010 | C8 00 00 00 63 24 16 05 C3 FA 31 68 7F B1 4A FE
0020 | 6E BB 7B F5 D8 7B 57 4C 93 54 8E 81 C9 C9 93 7B
0030 | EF 21 FB BF 00 90 7E FF 08 26 4C BF 7C 87 82 6D
0040 | C3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D4D31E4549A166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C8000000</code> (200 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08264CBF7C87826DC3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2759791213241593283</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2759791213241593283</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2759791213241593283 = 1506452021 * 1831980823</code></p>
<pre><code>p = 1506452021
q = 1831980823</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 26 4C BF 7C 87 82 6D C3 00 00 00
0010 | 04 59 CA A2 35 00 00 00 04 6D 31 CF 17 00 00 00
0020 | C3 FA 31 68 7F B1 4A FE 6E BB 7B F5 D8 7B 57 4C
0030 | 93 54 8E 81 C9 C9 93 7B EF 21 FB BF 00 90 7E FF
0040 | 8E 82 B2 E5 69 2C 07 17 41 E1 46 76 3E CD 3E DB
0050 | 60 1C B7 6C 66 70 C6 99 46 11 C8 5E 20 42 1F 99
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08264CBF7C87826DC3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2759791213241593283</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0459CAA235000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1506452021</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046D31CF17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1831980823</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>8E82B2E5692C071741E146763ECD3EDB</code> <code>601CB76C6670C6994611C85E20421F99</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908264CBF7C87826DC30000000459CAA235000000046D31CF17000000C3FA31687FB14AFE6EBB7BF5D87B574C93548E81C9C9937BEF21FBBF00907EFF8E82B2E5692C071741E146763ECD3EDB601CB76C6670C6994611C85E20421F9902000000
random_padding_bytes = 78E32DC9E72D69A37891B7DAB6CA96125DE295DEB4DC017B6D726D915F9CB47068A3C6872388CAF63EFFE9FA7676AE2D87D05E5F0A5BC3467935B59F24414D219C5436AC0F3BEC1F512233FACB9623FB6A73074692E31A0672923F65</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 060322C172A83BC12CFE35E07606AB8D66671FEF502655CD9F0710056C1F0D1ECC01C45243FFF3609A97B1335687D4E82DB680B9A4C71B3FC0E0CDF2F1680B604AFE0BDE34A8D43CD1A52D4D7144FF87482141F4B96B390216483DBF7D393F502ED148BB030D463B52464E6689E280CF602DC7A5370AD9AC4407EEA650FA631431B32B92381226A17122CFD063C7B687D3A5BBAA120E234B891824D720381E743297EEF9FE34D28DE82F506AD2FED78404AB7A27C6DF81ADCDB797C3EEA331C6883700DAC0E466B77DF36812F14A37F95A617C96C9C319AEED1D68DA2303EAFB4EFAA2BD36517BC044F10C5C2C8ECF5A2917FDFF06EBE9C4A4BE412D321AEDC1</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 18 6F 0E 00 45 49 A1 66
0010 | 40 01 00 00 BE E4 12 D7 C3 FA 31 68 7F B1 4A FE
0020 | 6E BB 7B F5 D8 7B 57 4C 93 54 8E 81 C9 C9 93 7B
0030 | EF 21 FB BF 00 90 7E FF 04 59 CA A2 35 00 00 00
0040 | 04 6D 31 CF 17 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 06 03 22 C1 72 A8 3B C1 2C FE 35 E0
0060 | 76 06 AB 8D 66 67 1F EF 50 26 55 CD 9F 07 10 05
0070 | 6C 1F 0D 1E CC 01 C4 52 43 FF F3 60 9A 97 B1 33
0080 | 56 87 D4 E8 2D B6 80 B9 A4 C7 1B 3F C0 E0 CD F2
0090 | F1 68 0B 60 4A FE 0B DE 34 A8 D4 3C D1 A5 2D 4D
00A0 | 71 44 FF 87 48 21 41 F4 B9 6B 39 02 16 48 3D BF
00B0 | 7D 39 3F 50 2E D1 48 BB 03 0D 46 3B 52 46 4E 66
00C0 | 89 E2 80 CF 60 2D C7 A5 37 0A D9 AC 44 07 EE A6
00D0 | 50 FA 63 14 31 B3 2B 92 38 12 26 A1 71 22 CF D0
00E0 | 63 C7 B6 87 D3 A5 BB AA 12 0E 23 4B 89 18 24 D7
00F0 | 20 38 1E 74 32 97 EE F9 FE 34 D2 8D E8 2F 50 6A
0100 | D2 FE D7 84 04 AB 7A 27 C6 DF 81 AD CD B7 97 C3
0110 | EE A3 31 C6 88 37 00 DA C0 E4 66 B7 7D F3 68 12
0120 | F1 4A 37 F9 5A 61 7C 96 C9 C3 19 AE ED 1D 68 DA
0130 | 23 03 EA FB 4E FA A2 BD 36 51 7B C0 44 F1 0C 5C
0140 | 2C 8E CF 5A 29 17 FD FF 06 EB E9 C4 A4 BE 41 2D
0150 | 32 1A ED C1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>186F0E004549A166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0459CAA235000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1506452021</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046D31CF17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1831980823</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100060322C172A83BC12CFE35E0</code> <code>7606AB8D66671FEF502655CD9F071005</code> <code>6C1F0D1ECC01C45243FFF3609A97B133</code> <code>5687D4E82DB680B9A4C71B3FC0E0CDF2</code> <code>F1680B604AFE0BDE34A8D43CD1A52D4D</code> <code>7144FF87482141F4B96B390216483DBF</code> <code>7D393F502ED148BB030D463B52464E66</code> <code>89E280CF602DC7A5370AD9AC4407EEA6</code> <code>50FA631431B32B92381226A17122CFD0</code> <code>63C7B687D3A5BBAA120E234B891824D7</code> <code>20381E743297EEF9FE34D28DE82F506A</code> <code>D2FED78404AB7A27C6DF81ADCDB797C3</code> <code>EEA331C6883700DAC0E466B77DF36812</code> <code>F14A37F95A617C96C9C319AEED1D68DA</code> <code>2303EAFB4EFAA2BD36517BC044F10C5C</code> <code>2C8ECF5A2917FDFF06EBE9C4A4BE412D</code><br> <code>321AEDC1</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F4 47 F4 45 49 A1 66
0010 | C0 02 00 00 5C 07 E8 D0 C3 FA 31 68 7F B1 4A FE
0020 | 6E BB 7B F5 D8 7B 57 4C 93 54 8E 81 C9 C9 93 7B
0030 | EF 21 FB BF 00 90 7E FF FE 50 02 00 6A 39 36 56
0040 | 63 7B 0E 06 03 AF 89 0D A2 16 7E 32 E3 ED 23 8B
0050 | 94 56 8C AB 84 8C 88 89 62 43 98 C3 71 35 7C A7
0060 | F7 8B 33 67 90 C7 3C BB FB 49 0D C2 38 0C 7A F4
0070 | 9E 6D E4 0D D6 2A 24 AF 73 0F 13 9B 71 F8 FF D9
0080 | 73 43 06 59 76 83 86 AE 23 05 46 96 D4 FD E3 E5
0090 | 9D 9D 7D 89 A0 0A 6C 25 FF B3 F5 BF CE 9B 0D 7C
00A0 | 4C F1 36 48 86 91 F9 48 0C B4 9B FA 85 DF 22 6E
00B0 | CE 7D 31 27 88 55 A7 B5 24 E4 25 6C 08 AE 14 2B
00C0 | 14 43 42 63 3F 4B 27 A8 78 A0 7E 78 08 CF E6 57
00D0 | 18 73 7F 75 21 B4 0D BF 7B 6B 43 C8 50 4B 96 8C
00E0 | F1 7A F4 3C F9 85 71 E2 DA 71 82 D3 09 6F 68 3F
00F0 | BC 23 0E D7 55 FA 0C 35 8F E5 13 77 08 CF CD DE
0100 | F4 0B FA 49 56 1E CE 35 32 F9 13 54 90 D9 B0 8E
0110 | 33 9E FE D4 63 89 D8 54 4B 99 C5 73 60 72 96 83
0120 | 0A EB B6 FC F8 E0 38 75 A9 10 AE 1D 7F 86 5A A1
0130 | 34 9A F5 4D 3C 43 9A 8E 2E 65 39 71 53 02 BD 2F
0140 | 1E 3E 7F 72 E9 71 17 24 DE B9 69 FA D6 7F 12 C7
0150 | 7C AC C1 31 D0 F9 79 31 38 CA DA B8 AA 37 8C DD
0160 | 30 8C D5 F8 16 77 F4 61 69 B1 33 9F A8 2B 0B 22
0170 | 6E 1E 0A F6 8F E7 83 66 97 F6 D0 4A E7 41 A8 BE
0180 | C2 93 EE E7 13 DA D1 90 4E A3 AE D9 96 D2 B7 45
0190 | 51 0C B5 1B 4E 9F 4B 28 39 8E 18 9A AF E7 DC 04
01A0 | 61 C7 EC 37 50 17 88 69 41 DA 19 A4 46 CD 45 0C
01B0 | 9A 10 70 F3 4C 5F E7 58 94 A9 55 54 13 26 88 1B
01C0 | C0 60 9E B2 2D 83 E3 26 CE 0F 42 ED 0C 4E 25 E9
01D0 | 4D 57 6A 51 43 A8 49 92 57 E2 7F 27 04 C1 CF 2E
01E0 | 43 F7 72 35 31 DF F0 90 26 A3 94 3D F1 C8 72 F2
01F0 | 58 4B 4E 50 F0 F8 2F 70 6E 9C CE B5 43 F5 80 7C
0200 | 60 90 F5 9A 5C 17 11 AD 4D 15 F4 2B 35 5E 4D B2
0210 | 91 21 64 08 97 C0 E5 BA C1 6A C7 D7 B2 92 FF 4B
0220 | 0B 39 32 9F 75 A5 2F 12 6F 47 8D DB 61 07 3B 85
0230 | AD 16 35 6C E6 2C C6 EE EC 25 B6 B2 DA E3 6D 36
0240 | 9E 14 F2 55 B6 86 A5 A6 5C 89 B9 24 0F D4 80 AA
0250 | A3 09 64 3E D8 78 73 F1 B8 C7 6C 4D EA D3 2B 9B
0260 | 7D B2 EB 19 75 E3 22 B4 0B 13 35 D3 36 A2 A6 1D
0270 | AF BD FC 5D 08 97 D2 FD 53 2E 31 29 99 1E C3 B5
0280 | 67 2E 75 EF 49 74 62 00 36 7F 59 E6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F447F44549A166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C0020000</code> (704 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002006A393656637B0E0603AF890D</code> <code>A2167E32E3ED238B94568CAB848C8889</code> <code>624398C371357CA7F78B336790C73CBB</code> <code>FB490DC2380C7AF49E6DE40DD62A24AF</code> <code>730F139B71F8FFD973430659768386AE</code> <code>23054696D4FDE3E59D9D7D89A00A6C25</code> <code>FFB3F5BFCE9B0D7C4CF136488691F948</code> <code>0CB49BFA85DF226ECE7D31278855A7B5</code> <code>24E4256C08AE142B144342633F4B27A8</code> <code>78A07E7808CFE65718737F7521B40DBF</code> <code>7B6B43C8504B968CF17AF43CF98571E2</code> <code>DA7182D3096F683FBC230ED755FA0C35</code> <code>8FE5137708CFCDDEF40BFA49561ECE35</code> <code>32F9135490D9B08E339EFED46389D854</code> <code>4B99C573607296830AEBB6FCF8E03875</code> <code>A910AE1D7F865AA1349AF54D3C439A8E</code> <code>2E6539715302BD2F1E3E7F72E9711724</code> <code>DEB969FAD67F12C77CACC131D0F97931</code> <code>38CADAB8AA378CDD308CD5F81677F461</code> <code>69B1339FA82B0B226E1E0AF68FE78366</code> <code>97F6D04AE741A8BEC293EEE713DAD190</code> <code>4EA3AED996D2B745510CB51B4E9F4B28</code> <code>398E189AAFE7DC0461C7EC3750178869</code> <code>41DA19A446CD450C9A1070F34C5FE758</code> <code>94A955541326881BC0609EB22D83E326</code> <code>CE0F42ED0C4E25E94D576A5143A84992</code> <code>57E27F2704C1CF2E43F7723531DFF090</code> <code>26A3943DF1C872F2584B4E50F0F82F70</code> <code>6E9CCEB543F5807C6090F59A5C1711AD</code> <code>4D15F42B355E4DB29121640897C0E5BA</code> <code>C16AC7D7B292FF4B0B39329F75A52F12</code> <code>6F478DDB61073B85AD16356CE62CC6EE</code> <code>EC25B6B2DAE36D369E14F255B686A5A6</code> <code>5C89B9240FD480AAA309643ED87873F1</code> <code>B8C76C4DEAD32B9B7DB2EB1975E322B4</code> <code>0B1335D336A2A61DAFBDFC5D0897D2FD</code> <code>532E3129991EC3B5672E75EF49746200</code><br> <code>367F59E6</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 6A393656637B0E0603AF890DA2167E32E3ED238B94568CAB848C8889624398C371357CA7F78B336790C73CBBFB490DC2380C7AF49E6DE40DD62A24AF730F139B71F8FFD973430659768386AE23054696D4FDE3E59D9D7D89A00A6C25FFB3F5BFCE9B0D7C4CF136488691F9480CB49BFA85DF226ECE7D31278855A7B524E4256C08AE142B144342633F4B27A878A07E7808CFE65718737F7521B40DBF7B6B43C8504B968CF17AF43CF98571E2DA7182D3096F683FBC230ED755FA0C358FE5137708CFCDDEF40BFA49561ECE3532F9135490D9B08E339EFED46389D8544B99C573607296830AEBB6FCF8E03875A910AE1D7F865AA1349AF54D3C439A8E2E6539715302BD2F1E3E7F72E9711724DEB969FAD67F12C77CACC131D0F9793138CADAB8AA378CDD308CD5F81677F46169B1339FA82B0B226E1E0AF68FE7836697F6D04AE741A8BEC293EEE713DAD1904EA3AED996D2B745510CB51B4E9F4B28398E189AAFE7DC0461C7EC375017886941DA19A446CD450C9A1070F34C5FE75894A955541326881BC0609EB22D83E326CE0F42ED0C4E25E94D576A5143A8499257E27F2704C1CF2E43F7723531DFF09026A3943DF1C872F2584B4E50F0F82F706E9CCEB543F5807C6090F59A5C1711AD4D15F42B355E4DB29121640897C0E5BAC16AC7D7B292FF4B0B39329F75A52F126F478DDB61073B85AD16356CE62CC6EEEC25B6B2DAE36D369E14F255B686A5A65C89B9240FD480AAA309643ED87873F1B8C76C4DEAD32B9B7DB2EB1975E322B40B1335D336A2A61DAFBDFC5D0897D2FD532E3129991EC3B5672E75EF49746200367F59E6
tmp_aes_key = 12E80C711D4E145929DBD59D74C4C9C784B465D36C86484EDB794E373343523A
tmp_aes_iv = E46740B6386AD583BC7C143BDF4332C678F9CDC8EAB6EB4E602EBEF48E82B2E5</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = B3A14A01ED2A48826CB1A652B10DBF0B160345D3BA0D89B5C3FA31687FB14AFE6EBB7BF5D87B574C93548E81C9C9937BEF21FBBF00907EFF03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001006F7B20B65478004B0FFAFBE7C96EA5EB35B8CED549CDF7C2B950F7E4B813DCF2F1E0566D7E2AB00D5F3AADE543648D2BE878EE9CBEB8ADA694580644339F1CC73FC96DB2028328EFB62AA8D9AFC68F7C58373382813B5C39228E3F1AF42B0150C9FA09F7CA96332360B7B021CF3B6C6F22B9F881593997C5EB9315F3504119A983A93BC2CBEB48EDAADEE189C2E2E1370A5E01172854E7B700A81E4DB92BF0BF8B836988C27502237F862B65C6E98C1A095E9699096347551F949284611DCBDC29428044AA7D31A09E4E25E1D4A064146085721B64E010AD51DAC6E5DFFAAC4E478636E596C044C50EF6495F2AFB70AA802884757F3F5DDA30CCF3AA4AD65CBE4549A166843F091D09114CAA
answer = BA0D89B5C3FA31687FB14AFE6EBB7BF5D87B574C93548E81C9C9937BEF21FBBF00907EFF03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001006F7B20B65478004B0FFAFBE7C96EA5EB35B8CED549CDF7C2B950F7E4B813DCF2F1E0566D7E2AB00D5F3AADE543648D2BE878EE9CBEB8ADA694580644339F1CC73FC96DB2028328EFB62AA8D9AFC68F7C58373382813B5C39228E3F1AF42B0150C9FA09F7CA96332360B7B021CF3B6C6F22B9F881593997C5EB9315F3504119A983A93BC2CBEB48EDAADEE189C2E2E1370A5E01172854E7B700A81E4DB92BF0BF8B836988C27502237F862B65C6E98C1A095E9699096347551F949284611DCBDC29428044AA7D31A09E4E25E1D4A064146085721B64E010AD51DAC6E5DFFAAC4E478636E596C044C50EF6495F2AFB70AA802884757F3F5DDA30CCF3AA4AD65CBE4549A166843F091D09114CAA</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 C3 FA 31 68 7F B1 4A FE 6E BB 7B F5
0010 | D8 7B 57 4C 93 54 8E 81 C9 C9 93 7B EF 21 FB BF
0020 | 00 90 7E FF 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 6F 7B 20 B6 54 78 00 4B 0F FA FB E7 C9 6E A5 EB
0140 | 35 B8 CE D5 49 CD F7 C2 B9 50 F7 E4 B8 13 DC F2
0150 | F1 E0 56 6D 7E 2A B0 0D 5F 3A AD E5 43 64 8D 2B
0160 | E8 78 EE 9C BE B8 AD A6 94 58 06 44 33 9F 1C C7
0170 | 3F C9 6D B2 02 83 28 EF B6 2A A8 D9 AF C6 8F 7C
0180 | 58 37 33 82 81 3B 5C 39 22 8E 3F 1A F4 2B 01 50
0190 | C9 FA 09 F7 CA 96 33 23 60 B7 B0 21 CF 3B 6C 6F
01A0 | 22 B9 F8 81 59 39 97 C5 EB 93 15 F3 50 41 19 A9
01B0 | 83 A9 3B C2 CB EB 48 ED AA DE E1 89 C2 E2 E1 37
01C0 | 0A 5E 01 17 28 54 E7 B7 00 A8 1E 4D B9 2B F0 BF
01D0 | 8B 83 69 88 C2 75 02 23 7F 86 2B 65 C6 E9 8C 1A
01E0 | 09 5E 96 99 09 63 47 55 1F 94 92 84 61 1D CB DC
01F0 | 29 42 80 44 AA 7D 31 A0 9E 4E 25 E1 D4 A0 64 14
0200 | 60 85 72 1B 64 E0 10 AD 51 DA C6 E5 DF FA AC 4E
0210 | 47 86 36 E5 96 C0 44 C5 0E F6 49 5F 2A FB 70 AA
0220 | 80 28 84 75 7F 3F 5D DA 30 CC F3 AA 4A D6 5C BE
0230 | 45 49 A1 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001006F7B20B65478004B0FFAFBE7</code> <code>C96EA5EB35B8CED549CDF7C2B950F7E4</code> <code>B813DCF2F1E0566D7E2AB00D5F3AADE5</code> <code>43648D2BE878EE9CBEB8ADA694580644</code> <code>339F1CC73FC96DB2028328EFB62AA8D9</code> <code>AFC68F7C58373382813B5C39228E3F1A</code> <code>F42B0150C9FA09F7CA96332360B7B021</code> <code>CF3B6C6F22B9F881593997C5EB9315F3</code> <code>504119A983A93BC2CBEB48EDAADEE189</code> <code>C2E2E1370A5E01172854E7B700A81E4D</code> <code>B92BF0BF8B836988C27502237F862B65</code> <code>C6E98C1A095E9699096347551F949284</code> <code>611DCBDC29428044AA7D31A09E4E25E1</code> <code>D4A064146085721B64E010AD51DAC6E5</code> <code>DFFAAC4E478636E596C044C50EF6495F</code> <code>2AFB70AA802884757F3F5DDA30CCF3AA</code><br> <code>4AD65CBE</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>4549A166</code> (1721846085 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = AB2EB055179E334D17B7EC7E62484A8D586449EE0CCBAE778158632715172B3242B86DDC88802ADF21E68910394A465818320374D839831869F333B504B725F3F28F38D6FE8099463F18FB32532718B2ECD57382199E14A539E441D2E50EFA2F81B8EF41B29B043E756A2DE044BF89D2F642DF510BF16EE9F460E6CB95A72B7CB2E1B6769159E379AA74055D3C28E304F23D58BA3B431844C962DB1094C9E1EA5E9E0172E8C864F0C5AE1E5C24877C8108D0971CCA80CC647444A52A0427B7FB11CF9FC03201ACBC409E8C2F1E5B9D20BBADA60E5A711DABFE191E7BBBC60403292A7D3F75725B72898D822D25690D67956787B5CE6328689029E483094526E5</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 64294D850864834E4E34CA5B05E8999B469C131BF388CC9048AE632F46BC1F0BD2CFD88CD9D20D88672D6D01650E5138A9D3F9FB091D5828C4C0A6398524F0A0DB7B3DE7D8E1C884000E23294B2D684180A5F796DE64760FA723460B79C7C3862D163656B121F4522C5845F00290EC91B89BFBF08C6E80E957D35F33B3004169A47C4C546E704DE6B0EF7668C55D86CD1DBC327A86AB597ECF7846789A2DC5E1E153994C0DED01D3DAE773359E3F3A0BE41EA65163BE2B52C4CB8E1248E82B6FB09B89929BCFDEF2786E40345CE67895251F874E0B3EE7661B8FDE81162129699731034E8915F04DF1493D6C73CC0BDFC404C5BA0E2AEFBC11B8B817C5D4670E</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 C3 FA 31 68 7F B1 4A FE 6E BB 7B F5
0010 | D8 7B 57 4C 93 54 8E 81 C9 C9 93 7B EF 21 FB BF
0020 | 00 90 7E FF 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 64 29 4D 85 08 64 83 4E 4E 34 CA 5B 05 E8 99 9B
0040 | 46 9C 13 1B F3 88 CC 90 48 AE 63 2F 46 BC 1F 0B
0050 | D2 CF D8 8C D9 D2 0D 88 67 2D 6D 01 65 0E 51 38
0060 | A9 D3 F9 FB 09 1D 58 28 C4 C0 A6 39 85 24 F0 A0
0070 | DB 7B 3D E7 D8 E1 C8 84 00 0E 23 29 4B 2D 68 41
0080 | 80 A5 F7 96 DE 64 76 0F A7 23 46 0B 79 C7 C3 86
0090 | 2D 16 36 56 B1 21 F4 52 2C 58 45 F0 02 90 EC 91
00A0 | B8 9B FB F0 8C 6E 80 E9 57 D3 5F 33 B3 00 41 69
00B0 | A4 7C 4C 54 6E 70 4D E6 B0 EF 76 68 C5 5D 86 CD
00C0 | 1D BC 32 7A 86 AB 59 7E CF 78 46 78 9A 2D C5 E1
00D0 | E1 53 99 4C 0D ED 01 D3 DA E7 73 35 9E 3F 3A 0B
00E0 | E4 1E A6 51 63 BE 2B 52 C4 CB 8E 12 48 E8 2B 6F
00F0 | B0 9B 89 92 9B CF DE F2 78 6E 40 34 5C E6 78 95
0100 | 25 1F 87 4E 0B 3E E7 66 1B 8F DE 81 16 21 29 69
0110 | 97 31 03 4E 89 15 F0 4D F1 49 3D 6C 73 CC 0B DF
0120 | C4 04 C5 BA 0E 2A EF BC 11 B8 B8 17 C5 D4 67 0E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010064294D850864834E4E34CA5B</code> <code>05E8999B469C131BF388CC9048AE632F</code> <code>46BC1F0BD2CFD88CD9D20D88672D6D01</code> <code>650E5138A9D3F9FB091D5828C4C0A639</code> <code>8524F0A0DB7B3DE7D8E1C884000E2329</code> <code>4B2D684180A5F796DE64760FA723460B</code> <code>79C7C3862D163656B121F4522C5845F0</code> <code>0290EC91B89BFBF08C6E80E957D35F33</code> <code>B3004169A47C4C546E704DE6B0EF7668</code> <code>C55D86CD1DBC327A86AB597ECF784678</code> <code>9A2DC5E1E153994C0DED01D3DAE77335</code> <code>9E3F3A0BE41EA65163BE2B52C4CB8E12</code> <code>48E82B6FB09B89929BCFDEF2786E4034</code> <code>5CE67895251F874E0B3EE7661B8FDE81</code> <code>162129699731034E8915F04DF1493D6C</code> <code>73CC0BDFC404C5BA0E2AEFBC11B8B817</code><br> <code>C5D4670E</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366C3FA31687FB14AFE6EBB7BF5D87B574C93548E81C9C9937BEF21FBBF00907EFF0000000000000000FE00010064294D850864834E4E34CA5B05E8999B469C131BF388CC9048AE632F46BC1F0BD2CFD88CD9D20D88672D6D01650E5138A9D3F9FB091D5828C4C0A6398524F0A0DB7B3DE7D8E1C884000E23294B2D684180A5F796DE64760FA723460B79C7C3862D163656B121F4522C5845F00290EC91B89BFBF08C6E80E957D35F33B3004169A47C4C546E704DE6B0EF7668C55D86CD1DBC327A86AB597ECF7846789A2DC5E1E153994C0DED01D3DAE773359E3F3A0BE41EA65163BE2B52C4CB8E1248E82B6FB09B89929BCFDEF2786E40345CE67895251F874E0B3EE7661B8FDE81162129699731034E8915F04DF1493D6C73CC0BDFC404C5BA0E2AEFBC11B8B817C5D4670E
padding = 8DF91167272E406E5A93395C
tmp_aes_key = 12E80C711D4E145929DBD59D74C4C9C784B465D36C86484EDB794E373343523A
tmp_aes_iv = E46740B6386AD583BC7C143BDF4332C678F9CDC8EAB6EB4E602EBEF48E82B2E5</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C9E9C04B8D4F439A80A87AA9AAAE846464EEBA70FCD941D99B8189A9F825C85647EF27A9D73A085D98F864A321D16823DB15684D9576B3CC0E5CB0DCC520A18BC7851C926657CEF82E93DBF1238CADE8854C274FABFEED6C34687335131E7A1DAFAB9DA83D940E33D65C6D15518A15540C48E1335F855241D58ABB4E20B763318847DE93FCC651E039CAC3868895DC400DD7DC9DC36D75AA0638C63B84F8B40AA6E9A25BB48A42425F772D001782D97357EC3946AEBEA16426FB2C4BECD8BD30125AE25644576BC59B53385F299D69AE4245D3D811E335439A5F09C989D58F85B5C8E10977219F071578E141A568D5D98D1E174BAE85602E3B89D8AB26BA19492EEA9CBEF5164FA553CD472F15B411796084972BAC0331B835B952E5E02C50DE5BA2E2EB3F3F33D6C3B6ACD005B79E4BACEA665490DA5FCED36D7305F9756ADAE17F1391B170203702C97083AEE08F14</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 1C 6F 0E 00 45 49 A1 66
0010 | 78 01 00 00 1F 5F 04 F5 C3 FA 31 68 7F B1 4A FE
0020 | 6E BB 7B F5 D8 7B 57 4C 93 54 8E 81 C9 C9 93 7B
0030 | EF 21 FB BF 00 90 7E FF FE 50 01 00 C9 E9 C0 4B
0040 | 8D 4F 43 9A 80 A8 7A A9 AA AE 84 64 64 EE BA 70
0050 | FC D9 41 D9 9B 81 89 A9 F8 25 C8 56 47 EF 27 A9
0060 | D7 3A 08 5D 98 F8 64 A3 21 D1 68 23 DB 15 68 4D
0070 | 95 76 B3 CC 0E 5C B0 DC C5 20 A1 8B C7 85 1C 92
0080 | 66 57 CE F8 2E 93 DB F1 23 8C AD E8 85 4C 27 4F
0090 | AB FE ED 6C 34 68 73 35 13 1E 7A 1D AF AB 9D A8
00A0 | 3D 94 0E 33 D6 5C 6D 15 51 8A 15 54 0C 48 E1 33
00B0 | 5F 85 52 41 D5 8A BB 4E 20 B7 63 31 88 47 DE 93
00C0 | FC C6 51 E0 39 CA C3 86 88 95 DC 40 0D D7 DC 9D
00D0 | C3 6D 75 AA 06 38 C6 3B 84 F8 B4 0A A6 E9 A2 5B
00E0 | B4 8A 42 42 5F 77 2D 00 17 82 D9 73 57 EC 39 46
00F0 | AE BE A1 64 26 FB 2C 4B EC D8 BD 30 12 5A E2 56
0100 | 44 57 6B C5 9B 53 38 5F 29 9D 69 AE 42 45 D3 D8
0110 | 11 E3 35 43 9A 5F 09 C9 89 D5 8F 85 B5 C8 E1 09
0120 | 77 21 9F 07 15 78 E1 41 A5 68 D5 D9 8D 1E 17 4B
0130 | AE 85 60 2E 3B 89 D8 AB 26 BA 19 49 2E EA 9C BE
0140 | F5 16 4F A5 53 CD 47 2F 15 B4 11 79 60 84 97 2B
0150 | AC 03 31 B8 35 B9 52 E5 E0 2C 50 DE 5B A2 E2 EB
0160 | 3F 3F 33 D6 C3 B6 AC D0 05 B7 9E 4B AC EA 66 54
0170 | 90 DA 5F CE D3 6D 73 05 F9 75 6A DA E1 7F 13 91
0180 | B1 70 20 37 02 C9 70 83 AE E0 8F 14</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>1C6F0E004549A166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C9E9C04B8D4F439A80A87AA9</code> <code>AAAE846464EEBA70FCD941D99B8189A9</code> <code>F825C85647EF27A9D73A085D98F864A3</code> <code>21D16823DB15684D9576B3CC0E5CB0DC</code> <code>C520A18BC7851C926657CEF82E93DBF1</code> <code>238CADE8854C274FABFEED6C34687335</code> <code>131E7A1DAFAB9DA83D940E33D65C6D15</code> <code>518A15540C48E1335F855241D58ABB4E</code> <code>20B763318847DE93FCC651E039CAC386</code> <code>8895DC400DD7DC9DC36D75AA0638C63B</code> <code>84F8B40AA6E9A25BB48A42425F772D00</code> <code>1782D97357EC3946AEBEA16426FB2C4B</code> <code>ECD8BD30125AE25644576BC59B53385F</code> <code>299D69AE4245D3D811E335439A5F09C9</code> <code>89D58F85B5C8E10977219F071578E141</code> <code>A568D5D98D1E174BAE85602E3B89D8AB</code> <code>26BA19492EEA9CBEF5164FA553CD472F</code> <code>15B411796084972BAC0331B835B952E5</code> <code>E02C50DE5BA2E2EB3F3F33D6C3B6ACD0</code> <code>05B79E4BACEA665490DA5FCED36D7305</code> <code>F9756ADAE17F1391B170203702C97083</code><br> <code>AEE08F14</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = A065B2F30D9858452D2EB37BC81FA871BED25C11A31619CAFEAAC43658B8119CF5BDA5AB5904F6B50B71ACE7B6A8F7C1DA1536EED58264DEA994B9BA0374E37EA71C4BA46A108CEC9385C08E78E2080F26A995D54CBC035449029FB026AADDF157D4D85319E16E5D8DCD40A038A4600512A15432CF017BCAEC020E7D290A7D0BD4143F0211B2D660AEFEB399E9AF6B4912CCF68D368A289E18B784528ABAB310F58A8D6EA9525F99BDF8C142D616CEBB3EF5E74C6CF3B9D1453D2D82816D06EEF67CAD8F72C5E3892AFDBB542C2F357FC3DA0783A491A00E4B60510990DD9A77586FED0B1A1ECF8D3473DDBBCAD08F22501E6611E7E0D7EB0440CEA5816AE8D4</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 64 DF 98 46 49 A1 66
0010 | 6C 00 00 00 34 F7 CB 3B C3 FA 31 68 7F B1 4A FE
0020 | 6E BB 7B F5 D8 7B 57 4C 93 54 8E 81 C9 C9 93 7B
0030 | EF 21 FB BF 00 90 7E FF AD 66 69 D7 7F 9C D3 AE
0040 | FE 6D C0 37 21 4B 62 81</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0164DF984649A166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>6C000000</code> (108 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C3FA31687FB14AFE6EBB7BF5D87B574C</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>93548E81C9C9937BEF21FBBF00907EFF</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>AD6669D77F9CD3AEFE6DC037214B6281</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

