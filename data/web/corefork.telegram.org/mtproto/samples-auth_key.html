<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 60 CA 04 00 E4 F3 3E 67
0010 | 14 00 00 00 F1 8E 7E BE BA 09 95 73 51 42 D6 21
0020 | 6E 4E 52 F3 8D CE 78 43</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>60CA0400E4F33E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 19 D3 E4 F3 3E 67
0010 | 50 00 00 00 63 24 16 05 BA 09 95 73 51 42 D6 21
0020 | 6E 4E 52 F3 8D CE 78 43 BD D2 59 CC C8 B9 10 25
0030 | C5 5A 15 90 8E DA BB 41 08 0F A5 4A 2B FB 0F 27
0040 | A7 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015819D3E4F33E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>080FA54A2BFB0F27A7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1127388834482300839</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1127388834482300839</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1127388834482300839 = 1010676871 * 1115479009</code></p>
<pre><code>p = 1010676871
q = 1115479009</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 0F A5 4A 2B FB 0F 27 A7 00 00 00
0010 | 04 3C 3D B4 87 00 00 00 04 42 7C DB E1 00 00 00
0020 | BA 09 95 73 51 42 D6 21 6E 4E 52 F3 8D CE 78 43
0030 | BD D2 59 CC C8 B9 10 25 C5 5A 15 90 8E DA BB 41
0040 | 22 55 DC E3 1C 4C DB 1B 91 93 D6 DA F4 F0 26 15
0050 | 28 F5 85 5A 98 29 B4 32 19 54 38 24 38 A1 2C 30
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>080FA54A2BFB0F27A7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1127388834482300839</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043C3DB487000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1010676871</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04427CDBE1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1115479009</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>2255DCE31C4CDB1B9193D6DAF4F02615</code> <code>28F5855A9829B4321954382438A12C30</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9080FA54A2BFB0F27A7000000043C3DB48700000004427CDBE1000000BA0995735142D6216E4E52F38DCE7843BDD259CCC8B91025C55A15908EDABB412255DCE31C4CDB1B9193D6DAF4F0261528F5855A9829B4321954382438A12C3002000000
random_padding_bytes = EC4E4C77FF9086E18404CF0C664FD601631A030405572CC65440741401F31E886422257D756905163A8A256BCE3DC116E23FBFE8FADC7DD963A6BC20256C21930B3D2E6A8ECADCD91D78D5D5ECCDFFBE1CCC747BC601142363E6F973</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 4E1573F0DD3AC77F8BE5292EEFA0C9F624905FA596B4B6E7BABF7C4E88618E4213505AC000355EDA49AFE7E9B734F87087892BDC63751F823DC1E9726D3F01681BAD6A7386D42972A25BB2A391BFFC9A85714F01B39563437BCECD4CBD450C52BD5ACC96E276C18F7C6AC81C28A24A6283EBC54FACA506EF34F6F7809DA9655EC55FD3F93C13E60B099BB70627DAAC46CE420C2B994B21A0FA80B928D2F9B8763CA936E6659E4B4275879F6CEE96DC38EB531677BB4AD74AF7ECE5B09B2BB6E27FCCE380E7056FFD52FB2E05D247F3BE46C6352502A82C6F22C5226AAE2E7D43E1ADCEFB1D30662441E7F0CB04ACFD49C7B06417D217D8C61BD6437A19ED5289</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 64 CA 04 00 E4 F3 3E 67
0010 | 40 01 00 00 BE E4 12 D7 BA 09 95 73 51 42 D6 21
0020 | 6E 4E 52 F3 8D CE 78 43 BD D2 59 CC C8 B9 10 25
0030 | C5 5A 15 90 8E DA BB 41 04 3C 3D B4 87 00 00 00
0040 | 04 42 7C DB E1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 4E 15 73 F0 DD 3A C7 7F 8B E5 29 2E
0060 | EF A0 C9 F6 24 90 5F A5 96 B4 B6 E7 BA BF 7C 4E
0070 | 88 61 8E 42 13 50 5A C0 00 35 5E DA 49 AF E7 E9
0080 | B7 34 F8 70 87 89 2B DC 63 75 1F 82 3D C1 E9 72
0090 | 6D 3F 01 68 1B AD 6A 73 86 D4 29 72 A2 5B B2 A3
00A0 | 91 BF FC 9A 85 71 4F 01 B3 95 63 43 7B CE CD 4C
00B0 | BD 45 0C 52 BD 5A CC 96 E2 76 C1 8F 7C 6A C8 1C
00C0 | 28 A2 4A 62 83 EB C5 4F AC A5 06 EF 34 F6 F7 80
00D0 | 9D A9 65 5E C5 5F D3 F9 3C 13 E6 0B 09 9B B7 06
00E0 | 27 DA AC 46 CE 42 0C 2B 99 4B 21 A0 FA 80 B9 28
00F0 | D2 F9 B8 76 3C A9 36 E6 65 9E 4B 42 75 87 9F 6C
0100 | EE 96 DC 38 EB 53 16 77 BB 4A D7 4A F7 EC E5 B0
0110 | 9B 2B B6 E2 7F CC E3 80 E7 05 6F FD 52 FB 2E 05
0120 | D2 47 F3 BE 46 C6 35 25 02 A8 2C 6F 22 C5 22 6A
0130 | AE 2E 7D 43 E1 AD CE FB 1D 30 66 24 41 E7 F0 CB
0140 | 04 AC FD 49 C7 B0 64 17 D2 17 D8 C6 1B D6 43 7A
0150 | 19 ED 52 89</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>64CA0400E4F33E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043C3DB487000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1010676871</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04427CDBE1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1115479009</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001004E1573F0DD3AC77F8BE5292E</code> <code>EFA0C9F624905FA596B4B6E7BABF7C4E</code> <code>88618E4213505AC000355EDA49AFE7E9</code> <code>B734F87087892BDC63751F823DC1E972</code> <code>6D3F01681BAD6A7386D42972A25BB2A3</code> <code>91BFFC9A85714F01B39563437BCECD4C</code> <code>BD450C52BD5ACC96E276C18F7C6AC81C</code> <code>28A24A6283EBC54FACA506EF34F6F780</code> <code>9DA9655EC55FD3F93C13E60B099BB706</code> <code>27DAAC46CE420C2B994B21A0FA80B928</code> <code>D2F9B8763CA936E6659E4B4275879F6C</code> <code>EE96DC38EB531677BB4AD74AF7ECE5B0</code> <code>9B2BB6E27FCCE380E7056FFD52FB2E05</code> <code>D247F3BE46C6352502A82C6F22C5226A</code> <code>AE2E7D43E1ADCEFB1D30662441E7F0CB</code> <code>04ACFD49C7B06417D217D8C61BD6437A</code><br> <code>19ED5289</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E4 6E EA E4 F3 3E 67
0010 | 78 02 00 00 5C 07 E8 D0 BA 09 95 73 51 42 D6 21
0020 | 6E 4E 52 F3 8D CE 78 43 BD D2 59 CC C8 B9 10 25
0030 | C5 5A 15 90 8E DA BB 41 FE 50 02 00 34 9B F5 F1
0040 | 98 1A 99 12 B0 46 3F 96 5C 1E 10 A2 5C E3 C2 47
0050 | 70 DA 87 9B 88 A7 9B 36 E0 45 BA FB 76 75 31 8A
0060 | 49 07 F5 14 A0 D9 3E AE 3D C5 58 7F 50 79 A0 02
0070 | A9 BA 7A 3F 66 F7 D8 3F 67 97 84 60 00 C9 6F 52
0080 | 79 A3 FA 20 0E 6B D8 1D 40 AC E6 28 DB 15 40 55
0090 | 59 EA 22 E0 25 F2 CA 35 90 D2 CA 2D 1A 1C 88 03
00A0 | 7D 33 72 35 7F 45 42 DD 5C EE B7 4D 93 54 6A 92
00B0 | EC A1 8D AF 5D E9 0E 5E 7B BC 48 2D F4 AB 6D 91
00C0 | 3D 95 BE 80 1D CE 10 8A 6F A6 E8 8C 29 5F B7 00
00D0 | 7A 61 95 E4 3F E3 23 11 50 5B 02 B5 C9 BD 69 24
00E0 | 4F 48 2C 23 7B 09 96 B3 9C 18 78 61 0C 54 A1 40
00F0 | 20 82 03 53 BD 54 8D EE 55 E4 E7 E9 45 10 08 26
0100 | 5C A2 72 E3 D4 9E 9F 77 1D 43 02 18 EF 40 B2 1B
0110 | 1D 44 16 DB C9 26 07 4B FD B8 5F 43 70 34 FD A9
0120 | 5B D7 69 CE 1D AE 5D FD C0 E4 00 9E 5B C3 78 B6
0130 | DD 39 61 8E D9 E8 81 0B BC C9 3D 18 24 D2 B0 10
0140 | 41 48 84 38 83 71 AF 4A 74 FE AA EA 71 95 46 8F
0150 | 16 C2 3D 46 BF 4B 6D 6B 09 EE F4 C9 75 F7 BF CD
0160 | 0C 6F F4 92 42 4F B5 E2 FD B4 7E 5F BA 57 0B 4E
0170 | DF EA 47 E0 DA 3D 90 6A 16 31 F6 F1 0F 5B 92 89
0180 | 1A E6 82 4A AC 26 6C 53 E5 2E 17 9F 93 98 F0 08
0190 | C3 5A 9B 0D C1 16 6D 58 A7 E3 42 5A 41 7C 31 DD
01A0 | AA A7 DE 15 1E 9F 09 B4 1F ED C2 99 40 D3 E0 D4
01B0 | D5 FC 25 66 FF 78 37 D8 DD 30 DC EC 56 20 0C 6E
01C0 | CE 9E 7F 9C BB BC 99 0C 71 1E 21 08 4E 48 9F 36
01D0 | F4 6E C0 9A 1B 53 65 FB 6F 5B D8 D2 86 3E 61 B7
01E0 | 4B 8F 17 8B BD CF 9A 67 DA 0E F6 94 83 6F 91 FD
01F0 | FC D5 B1 5B 3B 7F D7 D5 B6 AF 9A A8 9A 9D 46 5D
0200 | BD 45 E1 ED 82 8F AB A1 D1 2A AB 99 92 B9 93 34
0210 | 51 3C FD 0F 75 19 DC BF 20 DF 9D 6A ED 73 1B D9
0220 | BD 98 5C 17 17 4E BA D6 C4 6A 0D 6E A8 DA 58 F8
0230 | 8F 69 9A 2D 67 15 0C 96 99 31 44 6F D0 C3 96 B9
0240 | 44 C5 71 1F 10 43 4D 83 1C D3 E0 95 D3 DB 6F 36
0250 | 65 A7 0F 99 D5 18 B9 C2 83 79 33 1B 08 83 3C 88
0260 | 33 98 3B AB 5A A2 D8 ED F8 F0 CD 81 16 72 02 87
0270 | 30 10 B6 14 91 78 83 8A AB B1 BC 78 C4 00 DC 39
0280 | 55 76 9A 35 64 7D 0C 04 09 FB A6 59</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E46EEAE4F33E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200349BF5F1981A9912B0463F96</code> <code>5C1E10A25CE3C24770DA879B88A79B36</code> <code>E045BAFB7675318A4907F514A0D93EAE</code> <code>3DC5587F5079A002A9BA7A3F66F7D83F</code> <code>6797846000C96F5279A3FA200E6BD81D</code> <code>40ACE628DB15405559EA22E025F2CA35</code> <code>90D2CA2D1A1C88037D3372357F4542DD</code> <code>5CEEB74D93546A92ECA18DAF5DE90E5E</code> <code>7BBC482DF4AB6D913D95BE801DCE108A</code> <code>6FA6E88C295FB7007A6195E43FE32311</code> <code>505B02B5C9BD69244F482C237B0996B3</code> <code>9C1878610C54A14020820353BD548DEE</code> <code>55E4E7E9451008265CA272E3D49E9F77</code> <code>1D430218EF40B21B1D4416DBC926074B</code> <code>FDB85F437034FDA95BD769CE1DAE5DFD</code> <code>C0E4009E5BC378B6DD39618ED9E8810B</code> <code>BCC93D1824D2B010414884388371AF4A</code> <code>74FEAAEA7195468F16C23D46BF4B6D6B</code> <code>09EEF4C975F7BFCD0C6FF492424FB5E2</code> <code>FDB47E5FBA570B4EDFEA47E0DA3D906A</code> <code>1631F6F10F5B92891AE6824AAC266C53</code> <code>E52E179F9398F008C35A9B0DC1166D58</code> <code>A7E3425A417C31DDAAA7DE151E9F09B4</code> <code>1FEDC29940D3E0D4D5FC2566FF7837D8</code> <code>DD30DCEC56200C6ECE9E7F9CBBBC990C</code> <code>711E21084E489F36F46EC09A1B5365FB</code> <code>6F5BD8D2863E61B74B8F178BBDCF9A67</code> <code>DA0EF694836F91FDFCD5B15B3B7FD7D5</code> <code>B6AF9AA89A9D465DBD45E1ED828FABA1</code> <code>D12AAB9992B99334513CFD0F7519DCBF</code> <code>20DF9D6AED731BD9BD985C17174EBAD6</code> <code>C46A0D6EA8DA58F88F699A2D67150C96</code> <code>9931446FD0C396B944C5711F10434D83</code> <code>1CD3E095D3DB6F3665A70F99D518B9C2</code> <code>8379331B08833C8833983BAB5AA2D8ED</code> <code>F8F0CD81167202873010B6149178838A</code> <code>ABB1BC78C400DC3955769A35647D0C04</code><br> <code>09FBA659</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 349BF5F1981A9912B0463F965C1E10A25CE3C24770DA879B88A79B36E045BAFB7675318A4907F514A0D93EAE3DC5587F5079A002A9BA7A3F66F7D83F6797846000C96F5279A3FA200E6BD81D40ACE628DB15405559EA22E025F2CA3590D2CA2D1A1C88037D3372357F4542DD5CEEB74D93546A92ECA18DAF5DE90E5E7BBC482DF4AB6D913D95BE801DCE108A6FA6E88C295FB7007A6195E43FE32311505B02B5C9BD69244F482C237B0996B39C1878610C54A14020820353BD548DEE55E4E7E9451008265CA272E3D49E9F771D430218EF40B21B1D4416DBC926074BFDB85F437034FDA95BD769CE1DAE5DFDC0E4009E5BC378B6DD39618ED9E8810BBCC93D1824D2B010414884388371AF4A74FEAAEA7195468F16C23D46BF4B6D6B09EEF4C975F7BFCD0C6FF492424FB5E2FDB47E5FBA570B4EDFEA47E0DA3D906A1631F6F10F5B92891AE6824AAC266C53E52E179F9398F008C35A9B0DC1166D58A7E3425A417C31DDAAA7DE151E9F09B41FEDC29940D3E0D4D5FC2566FF7837D8DD30DCEC56200C6ECE9E7F9CBBBC990C711E21084E489F36F46EC09A1B5365FB6F5BD8D2863E61B74B8F178BBDCF9A67DA0EF694836F91FDFCD5B15B3B7FD7D5B6AF9AA89A9D465DBD45E1ED828FABA1D12AAB9992B99334513CFD0F7519DCBF20DF9D6AED731BD9BD985C17174EBAD6C46A0D6EA8DA58F88F699A2D67150C969931446FD0C396B944C5711F10434D831CD3E095D3DB6F3665A70F99D518B9C28379331B08833C8833983BAB5AA2D8EDF8F0CD81167202873010B6149178838AABB1BC78C400DC3955769A35647D0C0409FBA659
tmp_aes_key = A500C2579A3DF0D51B34521EF022CCEE6C78965C85B470938FE735D38B3A4468
tmp_aes_iv = D9C55C92AE29988C2F72F56E759696FAF9435078EAD76EE258863D872255DCE3</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 820ADE71B41C29AD532386A4F9A8D9CF31D8094BBA0D89B5BA0995735142D6216E4E52F38DCE7843BDD259CCC8B91025C55A15908EDABB4103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100463480F520EB1FF49E18EE8BD1161A1383C3D4BE502DA622523BEFC60EB0265C6561EFD885A45973C8DA6A88994A4FEB78252CDD90A5F3B18BBA7FABB0FB3187FDFE3D20DBC70C3B3F9B6B3ADF42C2CE18EE369CFE0C36E8D9D56E312888CA02291D94BF2060E35EF26AA3770BBA525033E0177B863FBF8C0F14D45D8D6FD2BC24FD40F3F1F7A9480F52AB590A86EA386A8DA23AF396F77E6A780D11BEE51FE210A3F7A983AE8CC18F8EA6BE43640D574B73B41081E0D9380AFAF505F891E05C41A928487439586259DE6138364038B87086E0582FC637726BC4C705EDA7AEECB44EB2FEEA2510D28C0F2712C00D9C174EBBF1DC1611DA59D88F8B283A7BDBB0E4F33E671A902BD5F89C8851
answer = BA0D89B5BA0995735142D6216E4E52F38DCE7843BDD259CCC8B91025C55A15908EDABB4103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100463480F520EB1FF49E18EE8BD1161A1383C3D4BE502DA622523BEFC60EB0265C6561EFD885A45973C8DA6A88994A4FEB78252CDD90A5F3B18BBA7FABB0FB3187FDFE3D20DBC70C3B3F9B6B3ADF42C2CE18EE369CFE0C36E8D9D56E312888CA02291D94BF2060E35EF26AA3770BBA525033E0177B863FBF8C0F14D45D8D6FD2BC24FD40F3F1F7A9480F52AB590A86EA386A8DA23AF396F77E6A780D11BEE51FE210A3F7A983AE8CC18F8EA6BE43640D574B73B41081E0D9380AFAF505F891E05C41A928487439586259DE6138364038B87086E0582FC637726BC4C705EDA7AEECB44EB2FEEA2510D28C0F2712C00D9C174EBBF1DC1611DA59D88F8B283A7BDBB0E4F33E671A902BD5F89C8851</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 BA 09 95 73 51 42 D6 21 6E 4E 52 F3
0010 | 8D CE 78 43 BD D2 59 CC C8 B9 10 25 C5 5A 15 90
0020 | 8E DA BB 41 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 46 34 80 F5 20 EB 1F F4 9E 18 EE 8B D1 16 1A 13
0140 | 83 C3 D4 BE 50 2D A6 22 52 3B EF C6 0E B0 26 5C
0150 | 65 61 EF D8 85 A4 59 73 C8 DA 6A 88 99 4A 4F EB
0160 | 78 25 2C DD 90 A5 F3 B1 8B BA 7F AB B0 FB 31 87
0170 | FD FE 3D 20 DB C7 0C 3B 3F 9B 6B 3A DF 42 C2 CE
0180 | 18 EE 36 9C FE 0C 36 E8 D9 D5 6E 31 28 88 CA 02
0190 | 29 1D 94 BF 20 60 E3 5E F2 6A A3 77 0B BA 52 50
01A0 | 33 E0 17 7B 86 3F BF 8C 0F 14 D4 5D 8D 6F D2 BC
01B0 | 24 FD 40 F3 F1 F7 A9 48 0F 52 AB 59 0A 86 EA 38
01C0 | 6A 8D A2 3A F3 96 F7 7E 6A 78 0D 11 BE E5 1F E2
01D0 | 10 A3 F7 A9 83 AE 8C C1 8F 8E A6 BE 43 64 0D 57
01E0 | 4B 73 B4 10 81 E0 D9 38 0A FA F5 05 F8 91 E0 5C
01F0 | 41 A9 28 48 74 39 58 62 59 DE 61 38 36 40 38 B8
0200 | 70 86 E0 58 2F C6 37 72 6B C4 C7 05 ED A7 AE EC
0210 | B4 4E B2 FE EA 25 10 D2 8C 0F 27 12 C0 0D 9C 17
0220 | 4E BB F1 DC 16 11 DA 59 D8 8F 8B 28 3A 7B DB B0
0230 | E4 F3 3E 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100463480F520EB1FF49E18EE8B</code> <code>D1161A1383C3D4BE502DA622523BEFC6</code> <code>0EB0265C6561EFD885A45973C8DA6A88</code> <code>994A4FEB78252CDD90A5F3B18BBA7FAB</code> <code>B0FB3187FDFE3D20DBC70C3B3F9B6B3A</code> <code>DF42C2CE18EE369CFE0C36E8D9D56E31</code> <code>2888CA02291D94BF2060E35EF26AA377</code> <code>0BBA525033E0177B863FBF8C0F14D45D</code> <code>8D6FD2BC24FD40F3F1F7A9480F52AB59</code> <code>0A86EA386A8DA23AF396F77E6A780D11</code> <code>BEE51FE210A3F7A983AE8CC18F8EA6BE</code> <code>43640D574B73B41081E0D9380AFAF505</code> <code>F891E05C41A928487439586259DE6138</code> <code>364038B87086E0582FC637726BC4C705</code> <code>EDA7AEECB44EB2FEEA2510D28C0F2712</code> <code>C00D9C174EBBF1DC1611DA59D88F8B28</code><br> <code>3A7BDBB0</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E4F33E67</code> (1732178916 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 70CB30C24C0EF93A2CE7A5771B1544121F1DD503260F0566EDBD4590BFD48D472A97184F838B19EB956C70314B0109B6F8FE6A5F345F177830A4BF89277504228EFC5DD09004E0440493D04CB99CF578CDC5E4120E6FE97355714D7A972565E1BB51F999728DE20890F14C29D64B9EE54C747D7325D26AAB4D5D0D249A4B5CE9511C1A95A0781283E9874A0C97AAA2E511E074C26C05095A30E9EFA7B3C7755C73F2AB709027F93C25E81E4A4BF4F70247A17E6430466D1AC56C3CC5A9E17D57906E9880C75085F75C3918F069AFF974890D9AAB80A748D64EC484D34FA8CDD8E6E7BBFCE72528C1D441487B5A57BA32C2EDAFD39DA4D531ACCF800E8838B385</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 34B35279803D7774988B59B148ADAB4C29243B9980A0A0EC9008FFA53840DE287AA815DD402EC1CA7A87C886D9E66D4DE9D207F493A67E82A3803BA42245DFA7A5BF2B37F91534473EF35C545FE80279BB3A42A9549706F82244C913264D8D9C656125CA98FE05570A8C67EF73E856567581E5426F3013F32FB09A273BA23E8EAFBB4343D18CBBA19914152D64C8750BF213BB4CEEC7FDBEBC4ACA7222EECFE25C373C161492C5864168053B18DA1AF29A92CA375AE453E84F5D7FC3E3017ED657E796FFDE1FE9E0317943E658C93E02187F0BDF2DAD2DF2467BABAF923C2EA9458BAD7D52336056569DDFC3170EA18D93020B94977D6ED84659F5BE8BD86CFE</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 BA 09 95 73 51 42 D6 21 6E 4E 52 F3
0010 | 8D CE 78 43 BD D2 59 CC C8 B9 10 25 C5 5A 15 90
0020 | 8E DA BB 41 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 34 B3 52 79 80 3D 77 74 98 8B 59 B1 48 AD AB 4C
0040 | 29 24 3B 99 80 A0 A0 EC 90 08 FF A5 38 40 DE 28
0050 | 7A A8 15 DD 40 2E C1 CA 7A 87 C8 86 D9 E6 6D 4D
0060 | E9 D2 07 F4 93 A6 7E 82 A3 80 3B A4 22 45 DF A7
0070 | A5 BF 2B 37 F9 15 34 47 3E F3 5C 54 5F E8 02 79
0080 | BB 3A 42 A9 54 97 06 F8 22 44 C9 13 26 4D 8D 9C
0090 | 65 61 25 CA 98 FE 05 57 0A 8C 67 EF 73 E8 56 56
00A0 | 75 81 E5 42 6F 30 13 F3 2F B0 9A 27 3B A2 3E 8E
00B0 | AF BB 43 43 D1 8C BB A1 99 14 15 2D 64 C8 75 0B
00C0 | F2 13 BB 4C EE C7 FD BE BC 4A CA 72 22 EE CF E2
00D0 | 5C 37 3C 16 14 92 C5 86 41 68 05 3B 18 DA 1A F2
00E0 | 9A 92 CA 37 5A E4 53 E8 4F 5D 7F C3 E3 01 7E D6
00F0 | 57 E7 96 FF DE 1F E9 E0 31 79 43 E6 58 C9 3E 02
0100 | 18 7F 0B DF 2D AD 2D F2 46 7B AB AF 92 3C 2E A9
0110 | 45 8B AD 7D 52 33 60 56 56 9D DF C3 17 0E A1 8D
0120 | 93 02 0B 94 97 7D 6E D8 46 59 F5 BE 8B D8 6C FE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010034B35279803D7774988B59B1</code> <code>48ADAB4C29243B9980A0A0EC9008FFA5</code> <code>3840DE287AA815DD402EC1CA7A87C886</code> <code>D9E66D4DE9D207F493A67E82A3803BA4</code> <code>2245DFA7A5BF2B37F91534473EF35C54</code> <code>5FE80279BB3A42A9549706F82244C913</code> <code>264D8D9C656125CA98FE05570A8C67EF</code> <code>73E856567581E5426F3013F32FB09A27</code> <code>3BA23E8EAFBB4343D18CBBA19914152D</code> <code>64C8750BF213BB4CEEC7FDBEBC4ACA72</code> <code>22EECFE25C373C161492C5864168053B</code> <code>18DA1AF29A92CA375AE453E84F5D7FC3</code> <code>E3017ED657E796FFDE1FE9E0317943E6</code> <code>58C93E02187F0BDF2DAD2DF2467BABAF</code> <code>923C2EA9458BAD7D52336056569DDFC3</code> <code>170EA18D93020B94977D6ED84659F5BE</code><br> <code>8BD86CFE</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366BA0995735142D6216E4E52F38DCE7843BDD259CCC8B91025C55A15908EDABB410000000000000000FE00010034B35279803D7774988B59B148ADAB4C29243B9980A0A0EC9008FFA53840DE287AA815DD402EC1CA7A87C886D9E66D4DE9D207F493A67E82A3803BA42245DFA7A5BF2B37F91534473EF35C545FE80279BB3A42A9549706F82244C913264D8D9C656125CA98FE05570A8C67EF73E856567581E5426F3013F32FB09A273BA23E8EAFBB4343D18CBBA19914152D64C8750BF213BB4CEEC7FDBEBC4ACA7222EECFE25C373C161492C5864168053B18DA1AF29A92CA375AE453E84F5D7FC3E3017ED657E796FFDE1FE9E0317943E658C93E02187F0BDF2DAD2DF2467BABAF923C2EA9458BAD7D52336056569DDFC3170EA18D93020B94977D6ED84659F5BE8BD86CFE
padding = 643816CFA76CE69B5BE6DBE5
tmp_aes_key = A500C2579A3DF0D51B34521EF022CCEE6C78965C85B470938FE735D38B3A4468
tmp_aes_iv = D9C55C92AE29988C2F72F56E759696FAF9435078EAD76EE258863D872255DCE3</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 656AD684DDB92133D15305C36765BB82B666373265FFBF9E00C695A2F388C38920F2E4FBB0AC88CCD9A74B96DAD6AE9AEEA949C7650862519B6899A6273011F0E95349EB70F2F349FCC6E8D73AE2215A1BD2A200D063CE14F34AA388BF5CB62B65CED6ECB7D361AF3D247B2D3B371A1063006E675E7FF49171AB3FA2B2C33C2CD7A1F069979C412501AC9C19BFF0B905BD8003F98AA8F19A3E1A7A677598248374CAC24F3FBDDEA3CF0FF08C1717FC00C0E6BAD5F3905145A6DCE93D1EAA3A5DCD94D82DA386BAF50BC740EF89BB25BF583BB77AE72BACF8EE0C17D8519F6704C6E80287966BDAFF2078ECD42D0EADC17436B2E5FE7A78389DBCB97F4A894F43F3BFF73595A62B81EF5935A53A7B0E7F26074A3E2AE321C5C7E35BC335D4F6312D2743BEFD53A27011594342EFDB506AC084907D38D4746E87CE846E8DC0D2C4BE2B0683749FF67EB85E90676ADEBFDE</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D0 17 0B 00 E4 F3 3E 67
0010 | 78 01 00 00 1F 5F 04 F5 BA 09 95 73 51 42 D6 21
0020 | 6E 4E 52 F3 8D CE 78 43 BD D2 59 CC C8 B9 10 25
0030 | C5 5A 15 90 8E DA BB 41 FE 50 01 00 65 6A D6 84
0040 | DD B9 21 33 D1 53 05 C3 67 65 BB 82 B6 66 37 32
0050 | 65 FF BF 9E 00 C6 95 A2 F3 88 C3 89 20 F2 E4 FB
0060 | B0 AC 88 CC D9 A7 4B 96 DA D6 AE 9A EE A9 49 C7
0070 | 65 08 62 51 9B 68 99 A6 27 30 11 F0 E9 53 49 EB
0080 | 70 F2 F3 49 FC C6 E8 D7 3A E2 21 5A 1B D2 A2 00
0090 | D0 63 CE 14 F3 4A A3 88 BF 5C B6 2B 65 CE D6 EC
00A0 | B7 D3 61 AF 3D 24 7B 2D 3B 37 1A 10 63 00 6E 67
00B0 | 5E 7F F4 91 71 AB 3F A2 B2 C3 3C 2C D7 A1 F0 69
00C0 | 97 9C 41 25 01 AC 9C 19 BF F0 B9 05 BD 80 03 F9
00D0 | 8A A8 F1 9A 3E 1A 7A 67 75 98 24 83 74 CA C2 4F
00E0 | 3F BD DE A3 CF 0F F0 8C 17 17 FC 00 C0 E6 BA D5
00F0 | F3 90 51 45 A6 DC E9 3D 1E AA 3A 5D CD 94 D8 2D
0100 | A3 86 BA F5 0B C7 40 EF 89 BB 25 BF 58 3B B7 7A
0110 | E7 2B AC F8 EE 0C 17 D8 51 9F 67 04 C6 E8 02 87
0120 | 96 6B DA FF 20 78 EC D4 2D 0E AD C1 74 36 B2 E5
0130 | FE 7A 78 38 9D BC B9 7F 4A 89 4F 43 F3 BF F7 35
0140 | 95 A6 2B 81 EF 59 35 A5 3A 7B 0E 7F 26 07 4A 3E
0150 | 2A E3 21 C5 C7 E3 5B C3 35 D4 F6 31 2D 27 43 BE
0160 | FD 53 A2 70 11 59 43 42 EF DB 50 6A C0 84 90 7D
0170 | 38 D4 74 6E 87 CE 84 6E 8D C0 D2 C4 BE 2B 06 83
0180 | 74 9F F6 7E B8 5E 90 67 6A DE BF DE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D0170B00E4F33E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100656AD684DDB92133D15305C3</code> <code>6765BB82B666373265FFBF9E00C695A2</code> <code>F388C38920F2E4FBB0AC88CCD9A74B96</code> <code>DAD6AE9AEEA949C7650862519B6899A6</code> <code>273011F0E95349EB70F2F349FCC6E8D7</code> <code>3AE2215A1BD2A200D063CE14F34AA388</code> <code>BF5CB62B65CED6ECB7D361AF3D247B2D</code> <code>3B371A1063006E675E7FF49171AB3FA2</code> <code>B2C33C2CD7A1F069979C412501AC9C19</code> <code>BFF0B905BD8003F98AA8F19A3E1A7A67</code> <code>7598248374CAC24F3FBDDEA3CF0FF08C</code> <code>1717FC00C0E6BAD5F3905145A6DCE93D</code> <code>1EAA3A5DCD94D82DA386BAF50BC740EF</code> <code>89BB25BF583BB77AE72BACF8EE0C17D8</code> <code>519F6704C6E80287966BDAFF2078ECD4</code> <code>2D0EADC17436B2E5FE7A78389DBCB97F</code> <code>4A894F43F3BFF73595A62B81EF5935A5</code> <code>3A7B0E7F26074A3E2AE321C5C7E35BC3</code> <code>35D4F6312D2743BEFD53A27011594342</code> <code>EFDB506AC084907D38D4746E87CE846E</code> <code>8DC0D2C4BE2B0683749FF67EB85E9067</code><br> <code>6ADEBFDE</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 750665978A2E98F0AAB01433C3FF3F55BEFB1487C83F4F79FC28D669C099C66C7E05FD3FD41FB47C81C115FF2356CDD782FC87D7ED82572EC769875DCC2FA97407371386D401EDE4F1A55C35A88B9F7B1994216E3CA44930D55DD8D74661D5C1BA9C944EC7656639B7389CDFCC762861FDC1D32B4A2214AE3F3E2336A7F1E9566DD9EE33650380BB1465B20668AF0D620429C0F3CBC8CD9FA3AF4406946DB6E942F80897894DCBA3B2A5EA16F7E91957905652F58913703DD9208D43FC5D3853E33619E54B811E88A99E631F9663AB1B93293EE21BE2603AE22BEEA59CC79A0D61CDC0562BEB9C5DDBD06A336FD851C36B65A8F73CA5E6EFB05E45620586FA9D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 AD 3D E6 F3 3E 67
0010 | 34 00 00 00 34 F7 CB 3B BA 09 95 73 51 42 D6 21
0020 | 6E 4E 52 F3 8D CE 78 43 BD D2 59 CC C8 B9 10 25
0030 | C5 5A 15 90 8E DA BB 41 4F 40 FA 4A 59 2D 2A 5B
0040 | 23 A1 78 8E FC DB 9B 91</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C4AD3DE6F33E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>BA0995735142D6216E4E52F38DCE7843</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>BDD259CCC8B91025C55A15908EDABB41</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4F40FA4A592D2A5B23A1788EFCDB9B91</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

