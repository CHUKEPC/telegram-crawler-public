<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 0C 61 06 00 E2 88 33 67
0010 | 14 00 00 00 F1 8E 7E BE 28 72 1A 8E C4 CD 99 F8
0020 | A9 B9 5B DB 5A 5F D8 30</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0C610600E2883367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 44 DB B9 E2 88 33 67
0010 | 50 00 00 00 63 24 16 05 28 72 1A 8E C4 CD 99 F8
0020 | A9 B9 5B DB 5A 5F D8 30 71 7F 48 CF 46 34 E2 07
0030 | D3 21 B7 A6 A0 50 39 82 08 13 9E 3B B6 1E B5 BA
0040 | 8D 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0144DBB9E2883367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08139E3BB61EB5BA8D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1413632986426227341</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1413632986426227341</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1413632986426227341 = 1168940321 * 1209328621</code></p>
<pre><code>p = 1168940321
q = 1209328621</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 13 9E 3B B6 1E B5 BA 8D 00 00 00
0010 | 04 45 AC 9D 21 00 00 00 04 48 14 E3 ED 00 00 00
0020 | 28 72 1A 8E C4 CD 99 F8 A9 B9 5B DB 5A 5F D8 30
0030 | 71 7F 48 CF 46 34 E2 07 D3 21 B7 A6 A0 50 39 82
0040 | 56 84 9E 7F 80 A3 5D DD 7E EC A0 AC 29 69 D1 7D
0050 | 53 AB CA C9 EA A1 4E 7D 02 FB 16 CC E5 17 18 9F
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08139E3BB61EB5BA8D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1413632986426227341</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0445AC9D21000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1168940321</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044814E3ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1209328621</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>56849E7F80A35DDD7EECA0AC2969D17D</code> <code>53ABCAC9EAA14E7D02FB16CCE517189F</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908139E3BB61EB5BA8D0000000445AC9D21000000044814E3ED00000028721A8EC4CD99F8A9B95BDB5A5FD830717F48CF4634E207D321B7A6A050398256849E7F80A35DDD7EECA0AC2969D17D53ABCAC9EAA14E7D02FB16CCE517189F02000000
random_padding_bytes = EE2FE5580491683FA67D4DD722AA8385F57F20D61CB0196FB6388C643D4FD818976EC97FD085798FCC165B07096ED3868B393B61F798CB300A96725D71574DBE8DF845C6C2CACBA0F2B8A1920DE3973FE4036831811B1248A14BE97F</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 1B49394C7AE3D72AB7D6A53CF1AF23DF667AC7D9ADC11AB1CC9CA06F7688F870A1C6896482E6082AEC7AC5DFF08D83D4A03612E9478C9157DD223DCE03FA9C1E04797F41F2213C254608DA94B3B2693075B81FA72BEB40D607EED5303C813AED46E84D11F73769D74ED1D345A04CF9F1485A3330992E373CC51EA01E309CCD6BD3CF0445DA2698AF3205E040E0267E5BEC220B08E94DA59FD456E521D21B9296E5B150E61CE52C0CD25075DC19C7DFE0598C05FD515F0F5E834C778F28E353A84E917241D014D68FB65DA21FEBD75D7D8F27274B6784DAAEEECF1AB781D314B736B3803FA198D893D25B8C6EE1FBB143B7680D053B8A43D3D01F16E6567D4849</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 10 61 06 00 E2 88 33 67
0010 | 40 01 00 00 BE E4 12 D7 28 72 1A 8E C4 CD 99 F8
0020 | A9 B9 5B DB 5A 5F D8 30 71 7F 48 CF 46 34 E2 07
0030 | D3 21 B7 A6 A0 50 39 82 04 45 AC 9D 21 00 00 00
0040 | 04 48 14 E3 ED 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 1B 49 39 4C 7A E3 D7 2A B7 D6 A5 3C
0060 | F1 AF 23 DF 66 7A C7 D9 AD C1 1A B1 CC 9C A0 6F
0070 | 76 88 F8 70 A1 C6 89 64 82 E6 08 2A EC 7A C5 DF
0080 | F0 8D 83 D4 A0 36 12 E9 47 8C 91 57 DD 22 3D CE
0090 | 03 FA 9C 1E 04 79 7F 41 F2 21 3C 25 46 08 DA 94
00A0 | B3 B2 69 30 75 B8 1F A7 2B EB 40 D6 07 EE D5 30
00B0 | 3C 81 3A ED 46 E8 4D 11 F7 37 69 D7 4E D1 D3 45
00C0 | A0 4C F9 F1 48 5A 33 30 99 2E 37 3C C5 1E A0 1E
00D0 | 30 9C CD 6B D3 CF 04 45 DA 26 98 AF 32 05 E0 40
00E0 | E0 26 7E 5B EC 22 0B 08 E9 4D A5 9F D4 56 E5 21
00F0 | D2 1B 92 96 E5 B1 50 E6 1C E5 2C 0C D2 50 75 DC
0100 | 19 C7 DF E0 59 8C 05 FD 51 5F 0F 5E 83 4C 77 8F
0110 | 28 E3 53 A8 4E 91 72 41 D0 14 D6 8F B6 5D A2 1F
0120 | EB D7 5D 7D 8F 27 27 4B 67 84 DA AE EE CF 1A B7
0130 | 81 D3 14 B7 36 B3 80 3F A1 98 D8 93 D2 5B 8C 6E
0140 | E1 FB B1 43 B7 68 0D 05 3B 8A 43 D3 D0 1F 16 E6
0150 | 56 7D 48 49</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>10610600E2883367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0445AC9D21000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1168940321</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044814E3ED000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1209328621</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001001B49394C7AE3D72AB7D6A53C</code> <code>F1AF23DF667AC7D9ADC11AB1CC9CA06F</code> <code>7688F870A1C6896482E6082AEC7AC5DF</code> <code>F08D83D4A03612E9478C9157DD223DCE</code> <code>03FA9C1E04797F41F2213C254608DA94</code> <code>B3B2693075B81FA72BEB40D607EED530</code> <code>3C813AED46E84D11F73769D74ED1D345</code> <code>A04CF9F1485A3330992E373CC51EA01E</code> <code>309CCD6BD3CF0445DA2698AF3205E040</code> <code>E0267E5BEC220B08E94DA59FD456E521</code> <code>D21B9296E5B150E61CE52C0CD25075DC</code> <code>19C7DFE0598C05FD515F0F5E834C778F</code> <code>28E353A84E917241D014D68FB65DA21F</code> <code>EBD75D7D8F27274B6784DAAEEECF1AB7</code> <code>81D314B736B3803FA198D893D25B8C6E</code> <code>E1FBB143B7680D053B8A43D3D01F16E6</code><br> <code>567D4849</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 1C DE CC E2 88 33 67
0010 | 78 02 00 00 5C 07 E8 D0 28 72 1A 8E C4 CD 99 F8
0020 | A9 B9 5B DB 5A 5F D8 30 71 7F 48 CF 46 34 E2 07
0030 | D3 21 B7 A6 A0 50 39 82 FE 50 02 00 CD EB 38 E4
0040 | 95 1C 47 81 4F 9C 69 D4 68 9B AB E2 FD E1 B3 2B
0050 | E3 8D 5B BF D6 DE 93 F2 57 30 F8 42 D2 B0 77 3D
0060 | F9 52 C4 F3 21 84 42 FA 77 E7 E7 13 94 D8 94 49
0070 | 4E 78 7D 34 B4 41 12 66 9E 25 75 14 2F 1B 2E 8C
0080 | 42 F7 CD 03 36 DD BD D9 15 D9 42 C4 56 3B 7F 4A
0090 | 1C 21 63 49 77 30 60 DE 03 8E AF 14 35 93 B4 17
00A0 | 5E D1 F6 84 ED 90 A7 30 81 E0 E7 CC 63 B5 7A EE
00B0 | 98 40 31 09 E6 41 EA DD 87 5A 16 DE 07 C6 BA 51
00C0 | 5E 72 27 43 C2 14 8C D3 6B 8F 3D D7 67 4D 82 B7
00D0 | C4 27 B9 52 3E BA CC 1F D1 8F DE 29 0F 37 86 4C
00E0 | 4D CB 7A 3E 45 5F 97 4E D7 A3 ED C6 47 10 DB EB
00F0 | 42 29 C1 AD 29 10 3E 25 3F B3 C0 37 35 57 C3 22
0100 | D1 E6 5C B0 19 AD 18 CE E0 53 12 C3 00 01 A1 9A
0110 | A7 79 18 4D 11 FF 7E 59 21 C6 ED AD 23 E5 90 8E
0120 | BB AA D6 8B BB D7 E5 AE 08 8B 73 00 3C B0 80 9F
0130 | 9C 03 76 BC 13 1B C5 8B E3 32 AD 17 0A B5 50 71
0140 | A2 52 88 B5 6E 8B A7 09 1B F7 3D 59 E7 B8 B9 CB
0150 | D0 C6 0A 88 A4 59 DD 36 AE 9E 0A 2C FE F9 98 A0
0160 | 6B 91 4C D0 43 99 D4 D1 20 19 2A 8D C4 94 13 61
0170 | F4 D4 22 3B E6 E2 4A 81 72 DF AA 51 A3 6C 25 AA
0180 | D8 1E E7 86 5B F9 4A DF 1D D9 3F 90 D1 B0 83 DE
0190 | 81 2D 4E 67 25 F5 6B 6D FB 5D 8E 5D 15 79 5E 5F
01A0 | 36 56 3B A0 63 3F 30 8F 35 EB 50 72 42 E4 41 66
01B0 | 4A AE 15 42 97 07 25 9F 44 E4 A1 F2 77 FE 67 6A
01C0 | 13 BD BA C7 6D 8D AD 42 40 44 85 E5 33 E8 C1 51
01D0 | 33 A5 CA 83 75 53 B8 CB 94 94 3F 31 CD 10 53 74
01E0 | A8 7A E8 7B 8D E0 25 12 32 4E DF 0F B2 63 AC 99
01F0 | 5C 5D 87 61 5C EC BA DD 7B FD C5 38 CD F1 57 AB
0200 | 82 22 B5 79 69 2F 9F 40 4B 51 5A 2A C0 4D 64 8F
0210 | E8 65 6B 03 9D 15 03 86 CF 55 0A E1 C2 02 03 9C
0220 | 88 73 90 57 DC 3C 82 40 A2 0F AB 6A 3C 31 04 6B
0230 | FC 1E 7E E7 EF 2B B8 91 81 A3 9F 1D 08 15 AE F3
0240 | 83 43 5B DD 8F E9 66 D0 AF 5C 95 3D 2D 1C 44 7E
0250 | F0 5A 52 7A 34 D2 4F BB D1 7F 14 7A 53 E1 30 40
0260 | A6 AF DA 17 BD B7 16 11 18 8F 53 34 30 E8 4E CB
0270 | 18 5E AD 2A FA D1 71 57 AC 3A C0 D7 FA AD B1 EC
0280 | E9 23 23 D9 11 27 3D 50 86 13 70 8E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>011CDECCE2883367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200CDEB38E4951C47814F9C69D4</code> <code>689BABE2FDE1B32BE38D5BBFD6DE93F2</code> <code>5730F842D2B0773DF952C4F3218442FA</code> <code>77E7E71394D894494E787D34B4411266</code> <code>9E2575142F1B2E8C42F7CD0336DDBDD9</code> <code>15D942C4563B7F4A1C216349773060DE</code> <code>038EAF143593B4175ED1F684ED90A730</code> <code>81E0E7CC63B57AEE98403109E641EADD</code> <code>875A16DE07C6BA515E722743C2148CD3</code> <code>6B8F3DD7674D82B7C427B9523EBACC1F</code> <code>D18FDE290F37864C4DCB7A3E455F974E</code> <code>D7A3EDC64710DBEB4229C1AD29103E25</code> <code>3FB3C0373557C322D1E65CB019AD18CE</code> <code>E05312C30001A19AA779184D11FF7E59</code> <code>21C6EDAD23E5908EBBAAD68BBBD7E5AE</code> <code>088B73003CB0809F9C0376BC131BC58B</code> <code>E332AD170AB55071A25288B56E8BA709</code> <code>1BF73D59E7B8B9CBD0C60A88A459DD36</code> <code>AE9E0A2CFEF998A06B914CD04399D4D1</code> <code>20192A8DC4941361F4D4223BE6E24A81</code> <code>72DFAA51A36C25AAD81EE7865BF94ADF</code> <code>1DD93F90D1B083DE812D4E6725F56B6D</code> <code>FB5D8E5D15795E5F36563BA0633F308F</code> <code>35EB507242E441664AAE15429707259F</code> <code>44E4A1F277FE676A13BDBAC76D8DAD42</code> <code>404485E533E8C15133A5CA837553B8CB</code> <code>94943F31CD105374A87AE87B8DE02512</code> <code>324EDF0FB263AC995C5D87615CECBADD</code> <code>7BFDC538CDF157AB8222B579692F9F40</code> <code>4B515A2AC04D648FE8656B039D150386</code> <code>CF550AE1C202039C88739057DC3C8240</code> <code>A20FAB6A3C31046BFC1E7EE7EF2BB891</code> <code>81A39F1D0815AEF383435BDD8FE966D0</code> <code>AF5C953D2D1C447EF05A527A34D24FBB</code> <code>D17F147A53E13040A6AFDA17BDB71611</code> <code>188F533430E84ECB185EAD2AFAD17157</code> <code>AC3AC0D7FAADB1ECE92323D911273D50</code><br> <code>8613708E</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = CDEB38E4951C47814F9C69D4689BABE2FDE1B32BE38D5BBFD6DE93F25730F842D2B0773DF952C4F3218442FA77E7E71394D894494E787D34B44112669E2575142F1B2E8C42F7CD0336DDBDD915D942C4563B7F4A1C216349773060DE038EAF143593B4175ED1F684ED90A73081E0E7CC63B57AEE98403109E641EADD875A16DE07C6BA515E722743C2148CD36B8F3DD7674D82B7C427B9523EBACC1FD18FDE290F37864C4DCB7A3E455F974ED7A3EDC64710DBEB4229C1AD29103E253FB3C0373557C322D1E65CB019AD18CEE05312C30001A19AA779184D11FF7E5921C6EDAD23E5908EBBAAD68BBBD7E5AE088B73003CB0809F9C0376BC131BC58BE332AD170AB55071A25288B56E8BA7091BF73D59E7B8B9CBD0C60A88A459DD36AE9E0A2CFEF998A06B914CD04399D4D120192A8DC4941361F4D4223BE6E24A8172DFAA51A36C25AAD81EE7865BF94ADF1DD93F90D1B083DE812D4E6725F56B6DFB5D8E5D15795E5F36563BA0633F308F35EB507242E441664AAE15429707259F44E4A1F277FE676A13BDBAC76D8DAD42404485E533E8C15133A5CA837553B8CB94943F31CD105374A87AE87B8DE02512324EDF0FB263AC995C5D87615CECBADD7BFDC538CDF157AB8222B579692F9F404B515A2AC04D648FE8656B039D150386CF550AE1C202039C88739057DC3C8240A20FAB6A3C31046BFC1E7EE7EF2BB89181A39F1D0815AEF383435BDD8FE966D0AF5C953D2D1C447EF05A527A34D24FBBD17F147A53E13040A6AFDA17BDB71611188F533430E84ECB185EAD2AFAD17157AC3AC0D7FAADB1ECE92323D911273D508613708E
tmp_aes_key = F12B07E505018CEF441EC420E14670A2D76C55D01508ED3E0CA30463E513172B
tmp_aes_iv = 683098AF19C8B22A4C3BF3CA68BEC24BC944B62BD94EAC23AADABF7B56849E7F</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1D19AEE2F97D1271F02A9C2E11357FBEC93AFB44BA0D89B528721A8EC4CD99F8A9B95BDB5A5FD830717F48CF4634E207D321B7A6A050398203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009F3F786150218F6372353293B0B058436C6E0909E7725DF6F9253A7226347EAF95201B6692D9D66C96D08CB5574AE5BC94F599F3219B09BCE0AF7389A5C1C663C896B18EA73CE88A118B32C2080C197052C84687279C0B2BFEE96971511A64C75A4C32934F83EEBA5AD4D6E82204B8B877F7FF86F993EB5B6460067FC711F87C377E2898A9FDBAB1D30FC4E2F084F3D65844089637F3B0E67AAFAEB345D80F0A6B6BE2A65D1726F942431A3E89F7D3094BB570EE3E2DC325BCE3472F65582910DC21C7A7CB96CB9F8B9767192F053DCE8AE71C6E8C3C6C4D56D990FA7A37D8808A5723119D3D0D4E97932C5BC269453A3D1605CEC250605A42F527E080626B7AE2883367328EF2E0C51ACECC
answer = BA0D89B528721A8EC4CD99F8A9B95BDB5A5FD830717F48CF4634E207D321B7A6A050398203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009F3F786150218F6372353293B0B058436C6E0909E7725DF6F9253A7226347EAF95201B6692D9D66C96D08CB5574AE5BC94F599F3219B09BCE0AF7389A5C1C663C896B18EA73CE88A118B32C2080C197052C84687279C0B2BFEE96971511A64C75A4C32934F83EEBA5AD4D6E82204B8B877F7FF86F993EB5B6460067FC711F87C377E2898A9FDBAB1D30FC4E2F084F3D65844089637F3B0E67AAFAEB345D80F0A6B6BE2A65D1726F942431A3E89F7D3094BB570EE3E2DC325BCE3472F65582910DC21C7A7CB96CB9F8B9767192F053DCE8AE71C6E8C3C6C4D56D990FA7A37D8808A5723119D3D0D4E97932C5BC269453A3D1605CEC250605A42F527E080626B7AE2883367328EF2E0C51ACECC</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 28 72 1A 8E C4 CD 99 F8 A9 B9 5B DB
0010 | 5A 5F D8 30 71 7F 48 CF 46 34 E2 07 D3 21 B7 A6
0020 | A0 50 39 82 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 9F 3F 78 61 50 21 8F 63 72 35 32 93 B0 B0 58 43
0140 | 6C 6E 09 09 E7 72 5D F6 F9 25 3A 72 26 34 7E AF
0150 | 95 20 1B 66 92 D9 D6 6C 96 D0 8C B5 57 4A E5 BC
0160 | 94 F5 99 F3 21 9B 09 BC E0 AF 73 89 A5 C1 C6 63
0170 | C8 96 B1 8E A7 3C E8 8A 11 8B 32 C2 08 0C 19 70
0180 | 52 C8 46 87 27 9C 0B 2B FE E9 69 71 51 1A 64 C7
0190 | 5A 4C 32 93 4F 83 EE BA 5A D4 D6 E8 22 04 B8 B8
01A0 | 77 F7 FF 86 F9 93 EB 5B 64 60 06 7F C7 11 F8 7C
01B0 | 37 7E 28 98 A9 FD BA B1 D3 0F C4 E2 F0 84 F3 D6
01C0 | 58 44 08 96 37 F3 B0 E6 7A AF AE B3 45 D8 0F 0A
01D0 | 6B 6B E2 A6 5D 17 26 F9 42 43 1A 3E 89 F7 D3 09
01E0 | 4B B5 70 EE 3E 2D C3 25 BC E3 47 2F 65 58 29 10
01F0 | DC 21 C7 A7 CB 96 CB 9F 8B 97 67 19 2F 05 3D CE
0200 | 8A E7 1C 6E 8C 3C 6C 4D 56 D9 90 FA 7A 37 D8 80
0210 | 8A 57 23 11 9D 3D 0D 4E 97 93 2C 5B C2 69 45 3A
0220 | 3D 16 05 CE C2 50 60 5A 42 F5 27 E0 80 62 6B 7A
0230 | E2 88 33 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001009F3F786150218F6372353293</code> <code>B0B058436C6E0909E7725DF6F9253A72</code> <code>26347EAF95201B6692D9D66C96D08CB5</code> <code>574AE5BC94F599F3219B09BCE0AF7389</code> <code>A5C1C663C896B18EA73CE88A118B32C2</code> <code>080C197052C84687279C0B2BFEE96971</code> <code>511A64C75A4C32934F83EEBA5AD4D6E8</code> <code>2204B8B877F7FF86F993EB5B6460067F</code> <code>C711F87C377E2898A9FDBAB1D30FC4E2</code> <code>F084F3D65844089637F3B0E67AAFAEB3</code> <code>45D80F0A6B6BE2A65D1726F942431A3E</code> <code>89F7D3094BB570EE3E2DC325BCE3472F</code> <code>65582910DC21C7A7CB96CB9F8B976719</code> <code>2F053DCE8AE71C6E8C3C6C4D56D990FA</code> <code>7A37D8808A5723119D3D0D4E97932C5B</code> <code>C269453A3D1605CEC250605A42F527E0</code><br> <code>80626B7A</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E2883367</code> (1731430626 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = BF5313623DDC964E770267719AF1999200EA654AFB5908430F1591AC20F06239B4C604A3B4F92FD79AF775FE706937E5A4D51505BF632510109E9F8B874DA67E312520030E21631718F12FEA4B0FFF7B5765FF5C74CA85EB4BE33CE2B58A2B7F0D9DFEF7888EB30C6F693FDB70EAB365D7B6D052EE8DC5163A4F9BFAE3CFC62C3913D5E83063A96167D16F56446BB0B3837154FA8F92EBF17DDB51DE4872A76F6E3A55D2DAF77E69456966DB9F60AA3F063143F4600F5F22E7BD530E3A5FC613EBFAAC2F96F798C04B1BBA9B038A8C951F07EE9E9EDD3316F7823A104AE6D2AC931417E3E251AE898A7E7CEDD3B661BDAAA4B1111CC9CA07AB38D7869C9557B4</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 31E2FE823C46A7A7AD37A807D74635A473C2BBFE73C00261D190B10AC27F65107CCB4525169C418516B721B2CE33675C26FDF584DB3CF3637F02B559E84EF49472DA402D94BF5B58E17ADD1C11D45567FA67E3F15242F380B50C53F806AC764B3E4725E685ADB52A0EF2D272F750931B327670D29F273802DB7C161BA8A34454026AA687694A11459D79AE92F9678D110E33E561B31C1F421BC00EBD0BA0AD735FB77732ED37308ADE5CD069D13BAD0D6B22214D04DFE804EA44E3A5418B0AB8A04D32B6CBBE32714E2596F4E7DCBE4EB8F9124C20E467D4B3256F8E80F06B9009BC40C1E387FC8DC38A8A50832670F37C8921E3D84FE15BDD58F677346354D1</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 28 72 1A 8E C4 CD 99 F8 A9 B9 5B DB
0010 | 5A 5F D8 30 71 7F 48 CF 46 34 E2 07 D3 21 B7 A6
0020 | A0 50 39 82 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 31 E2 FE 82 3C 46 A7 A7 AD 37 A8 07 D7 46 35 A4
0040 | 73 C2 BB FE 73 C0 02 61 D1 90 B1 0A C2 7F 65 10
0050 | 7C CB 45 25 16 9C 41 85 16 B7 21 B2 CE 33 67 5C
0060 | 26 FD F5 84 DB 3C F3 63 7F 02 B5 59 E8 4E F4 94
0070 | 72 DA 40 2D 94 BF 5B 58 E1 7A DD 1C 11 D4 55 67
0080 | FA 67 E3 F1 52 42 F3 80 B5 0C 53 F8 06 AC 76 4B
0090 | 3E 47 25 E6 85 AD B5 2A 0E F2 D2 72 F7 50 93 1B
00A0 | 32 76 70 D2 9F 27 38 02 DB 7C 16 1B A8 A3 44 54
00B0 | 02 6A A6 87 69 4A 11 45 9D 79 AE 92 F9 67 8D 11
00C0 | 0E 33 E5 61 B3 1C 1F 42 1B C0 0E BD 0B A0 AD 73
00D0 | 5F B7 77 32 ED 37 30 8A DE 5C D0 69 D1 3B AD 0D
00E0 | 6B 22 21 4D 04 DF E8 04 EA 44 E3 A5 41 8B 0A B8
00F0 | A0 4D 32 B6 CB BE 32 71 4E 25 96 F4 E7 DC BE 4E
0100 | B8 F9 12 4C 20 E4 67 D4 B3 25 6F 8E 80 F0 6B 90
0110 | 09 BC 40 C1 E3 87 FC 8D C3 8A 8A 50 83 26 70 F3
0120 | 7C 89 21 E3 D8 4F E1 5B DD 58 F6 77 34 63 54 D1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010031E2FE823C46A7A7AD37A807</code> <code>D74635A473C2BBFE73C00261D190B10A</code> <code>C27F65107CCB4525169C418516B721B2</code> <code>CE33675C26FDF584DB3CF3637F02B559</code> <code>E84EF49472DA402D94BF5B58E17ADD1C</code> <code>11D45567FA67E3F15242F380B50C53F8</code> <code>06AC764B3E4725E685ADB52A0EF2D272</code> <code>F750931B327670D29F273802DB7C161B</code> <code>A8A34454026AA687694A11459D79AE92</code> <code>F9678D110E33E561B31C1F421BC00EBD</code> <code>0BA0AD735FB77732ED37308ADE5CD069</code> <code>D13BAD0D6B22214D04DFE804EA44E3A5</code> <code>418B0AB8A04D32B6CBBE32714E2596F4</code> <code>E7DCBE4EB8F9124C20E467D4B3256F8E</code> <code>80F06B9009BC40C1E387FC8DC38A8A50</code> <code>832670F37C8921E3D84FE15BDD58F677</code><br> <code>346354D1</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436628721A8EC4CD99F8A9B95BDB5A5FD830717F48CF4634E207D321B7A6A05039820000000000000000FE00010031E2FE823C46A7A7AD37A807D74635A473C2BBFE73C00261D190B10AC27F65107CCB4525169C418516B721B2CE33675C26FDF584DB3CF3637F02B559E84EF49472DA402D94BF5B58E17ADD1C11D45567FA67E3F15242F380B50C53F806AC764B3E4725E685ADB52A0EF2D272F750931B327670D29F273802DB7C161BA8A34454026AA687694A11459D79AE92F9678D110E33E561B31C1F421BC00EBD0BA0AD735FB77732ED37308ADE5CD069D13BAD0D6B22214D04DFE804EA44E3A5418B0AB8A04D32B6CBBE32714E2596F4E7DCBE4EB8F9124C20E467D4B3256F8E80F06B9009BC40C1E387FC8DC38A8A50832670F37C8921E3D84FE15BDD58F677346354D1
padding = 5CC4064BAFD1F5AAD4341D9E
tmp_aes_key = F12B07E505018CEF441EC420E14670A2D76C55D01508ED3E0CA30463E513172B
tmp_aes_iv = 683098AF19C8B22A4C3BF3CA68BEC24BC944B62BD94EAC23AADABF7B56849E7F</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C53460B35E1B0E9202D41310487197DFDB1E1A5BF3ED6FC4758B2FCB7587FA63E5B14EF202493E2A59EA09C8547927243F16EE93C3F2EB0277FC6C723BE7C53CE5571741EB192FDEC9ECD38D19490647E28B295149C1A9C8CA064B7C7ED6A05E0BDCF339B5CCFC9262721794DE5136C0441C2F130B7BF548692F252E47D9DD37FBCF08A4A1ECE99991EFAAA2869B159DF72EDB286546DBFB805DD19722BB5683F3A424B2CE0FC1A6CAEC4CA01568ADFC1CBDBB1F75260C9E065B13F33A6E7ECD5283E96B6664BC546EA0531EC210B7F8EC4C9BA760A84E5E2D95D52F1A83A2C1DA0C512DB8F30E8B4449DDE7C028D34BC54C05271B3F72C3F3FC60438B76F7E51CB1E7DCE53DCFE23686E39E9C4A9954A1784C2EE4F8E70520D2F2805600BDFF733ED7DD6EA619F74BFB4BA2AD24F12D07416CB4F59FB50CB1E59C244ADC44E897870C71EF5C24E89BE1D56F94F071F7</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 14 61 06 00 E2 88 33 67
0010 | 78 01 00 00 1F 5F 04 F5 28 72 1A 8E C4 CD 99 F8
0020 | A9 B9 5B DB 5A 5F D8 30 71 7F 48 CF 46 34 E2 07
0030 | D3 21 B7 A6 A0 50 39 82 FE 50 01 00 C5 34 60 B3
0040 | 5E 1B 0E 92 02 D4 13 10 48 71 97 DF DB 1E 1A 5B
0050 | F3 ED 6F C4 75 8B 2F CB 75 87 FA 63 E5 B1 4E F2
0060 | 02 49 3E 2A 59 EA 09 C8 54 79 27 24 3F 16 EE 93
0070 | C3 F2 EB 02 77 FC 6C 72 3B E7 C5 3C E5 57 17 41
0080 | EB 19 2F DE C9 EC D3 8D 19 49 06 47 E2 8B 29 51
0090 | 49 C1 A9 C8 CA 06 4B 7C 7E D6 A0 5E 0B DC F3 39
00A0 | B5 CC FC 92 62 72 17 94 DE 51 36 C0 44 1C 2F 13
00B0 | 0B 7B F5 48 69 2F 25 2E 47 D9 DD 37 FB CF 08 A4
00C0 | A1 EC E9 99 91 EF AA A2 86 9B 15 9D F7 2E DB 28
00D0 | 65 46 DB FB 80 5D D1 97 22 BB 56 83 F3 A4 24 B2
00E0 | CE 0F C1 A6 CA EC 4C A0 15 68 AD FC 1C BD BB 1F
00F0 | 75 26 0C 9E 06 5B 13 F3 3A 6E 7E CD 52 83 E9 6B
0100 | 66 64 BC 54 6E A0 53 1E C2 10 B7 F8 EC 4C 9B A7
0110 | 60 A8 4E 5E 2D 95 D5 2F 1A 83 A2 C1 DA 0C 51 2D
0120 | B8 F3 0E 8B 44 49 DD E7 C0 28 D3 4B C5 4C 05 27
0130 | 1B 3F 72 C3 F3 FC 60 43 8B 76 F7 E5 1C B1 E7 DC
0140 | E5 3D CF E2 36 86 E3 9E 9C 4A 99 54 A1 78 4C 2E
0150 | E4 F8 E7 05 20 D2 F2 80 56 00 BD FF 73 3E D7 DD
0160 | 6E A6 19 F7 4B FB 4B A2 AD 24 F1 2D 07 41 6C B4
0170 | F5 9F B5 0C B1 E5 9C 24 4A DC 44 E8 97 87 0C 71
0180 | EF 5C 24 E8 9B E1 D5 6F 94 F0 71 F7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>14610600E2883367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C53460B35E1B0E9202D41310</code> <code>487197DFDB1E1A5BF3ED6FC4758B2FCB</code> <code>7587FA63E5B14EF202493E2A59EA09C8</code> <code>547927243F16EE93C3F2EB0277FC6C72</code> <code>3BE7C53CE5571741EB192FDEC9ECD38D</code> <code>19490647E28B295149C1A9C8CA064B7C</code> <code>7ED6A05E0BDCF339B5CCFC9262721794</code> <code>DE5136C0441C2F130B7BF548692F252E</code> <code>47D9DD37FBCF08A4A1ECE99991EFAAA2</code> <code>869B159DF72EDB286546DBFB805DD197</code> <code>22BB5683F3A424B2CE0FC1A6CAEC4CA0</code> <code>1568ADFC1CBDBB1F75260C9E065B13F3</code> <code>3A6E7ECD5283E96B6664BC546EA0531E</code> <code>C210B7F8EC4C9BA760A84E5E2D95D52F</code> <code>1A83A2C1DA0C512DB8F30E8B4449DDE7</code> <code>C028D34BC54C05271B3F72C3F3FC6043</code> <code>8B76F7E51CB1E7DCE53DCFE23686E39E</code> <code>9C4A9954A1784C2EE4F8E70520D2F280</code> <code>5600BDFF733ED7DD6EA619F74BFB4BA2</code> <code>AD24F12D07416CB4F59FB50CB1E59C24</code> <code>4ADC44E897870C71EF5C24E89BE1D56F</code><br> <code>94F071F7</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 13A90127DB37DB45A823B8ED894849E8FC5ED9A6805E00EF8CFC5FBCD04FEDCE077937C7A74328321BE620B10EDC05C884A1F9414277A9E9C325787ADA0A0399ACB98BCF6C3383B559E0EBA30F6EF5614E214FC8D0CD399456541D2E5EC0AED92A0F2CA2025F3B291009069F3A994BCE011D312EBBBC57081AF04660777B087C11070E29B5E190DA3C2CD5A4C3B5890BCD0DA6BACCDA745A0E99B58B327150D5BB63770794198AD5056676E0C19F6EF10163F018E64DDFAAEA002124B361761358A63B5B29DFE3E1E66F1441B725156FB1DABE444E576F1F8D28AE611903B2C5BF1158F2B36F702440A617B52F72122BE3039702E36138AAF50567F8794E3C7D</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 6C 59 E4 88 33 67
0010 | 34 00 00 00 34 F7 CB 3B 28 72 1A 8E C4 CD 99 F8
0020 | A9 B9 5B DB 5A 5F D8 30 71 7F 48 CF 46 34 E2 07
0030 | D3 21 B7 A6 A0 50 39 82 05 7A 67 C6 69 0F DF 67
0040 | B2 F1 49 27 FE A2 E3 22</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01986C59E4883367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>28721A8EC4CD99F8A9B95BDB5A5FD830</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>717F48CF4634E207D321B7A6A0503982</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>057A67C6690FDF67B2F14927FEA2E322</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

