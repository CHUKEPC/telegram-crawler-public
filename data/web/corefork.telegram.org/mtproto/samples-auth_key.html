<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B8 B0 07 00 7A D6 72 67
0010 | 14 00 00 00 F1 8E 7E BE EE 85 9A 33 B0 A7 88 C3
0020 | A7 9D CF 8A BA A7 C7 87</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B8B007007AD67267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 4C 04 13 7B D6 72 67
0010 | 50 00 00 00 63 24 16 05 EE 85 9A 33 B0 A7 88 C3
0020 | A7 9D CF 8A BA A7 C7 87 AC DC A4 90 F0 0F 3D 67
0030 | 25 9E B2 B3 4E D8 51 B5 08 10 40 AE 0D 3D 4A 9E
0040 | 39 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014C04137BD67267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081040AE0D3D4A9E39000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1171127275002437177</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1171127275002437177</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1171127275002437177 = 1062048983 * 1102705519</code></p>
<pre><code>p = 1062048983
q = 1102705519</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 10 40 AE 0D 3D 4A 9E 39 00 00 00
0010 | 04 3F 4D 94 D7 00 00 00 04 41 B9 F3 6F 00 00 00
0020 | EE 85 9A 33 B0 A7 88 C3 A7 9D CF 8A BA A7 C7 87
0030 | AC DC A4 90 F0 0F 3D 67 25 9E B2 B3 4E D8 51 B5
0040 | C0 B1 E7 DB 8E 5E C8 BA FE 9D B3 E1 D5 12 36 23
0050 | 21 5B 79 E7 41 4B 14 21 EB EB 17 91 61 14 B3 1B
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081040AE0D3D4A9E39000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1171127275002437177</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043F4D94D7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1062048983</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0441B9F36F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1102705519</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>C0B1E7DB8E5EC8BAFE9DB3E1D5123623</code> <code>215B79E7414B1421EBEB17916114B31B</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081040AE0D3D4A9E39000000043F4D94D70000000441B9F36F000000EE859A33B0A788C3A79DCF8ABAA7C787ACDCA490F00F3D67259EB2B34ED851B5C0B1E7DB8E5EC8BAFE9DB3E1D5123623215B79E7414B1421EBEB17916114B31B02000000
random_padding_bytes = 174FB37E006106E0634CB34164DD8A06697F56BF7DDCC03739218029FD78A52A044DBA8BC43826504B4F91AF654CAC2BF9DE73A6AE8D917B3C563AF116B2F99B403FEF0176A719822C195716E064EA2416054A8C48C3A4499C9D41D3</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A14F50A4795F1FA2DC3876D7B882F01050B520E184923FEF6B6BCC13455440EE136835A7D183E265CC17CB37170FA9391051422C8CF99F2FDC289FB1327B8D1F3446999FAC39B7A2BA97A1083C607FFDBFDEB4B35C1CB9EFA4B3D1046F813941E65694095A2B813E8C0C1137035F5101413EB0321E6BFD6E7691AE65CF69AF93747D1B037353B43E8ED69810431DC3EFD6AE46E035881A69C18EAFE0CD2447AFFE5EA48FC48A17F317D2C2F2775DFC3616EA6D4C3B039FAE1F0BB77C4B77C8533DA7D3518309E958017BDCB48BC7E0583409D8607F1E60481FD94C3ACF1AD0F1B3E5BA5BA9F58231F24874771F693B2A504BE1DF0F86D669365D2FEF908412A8</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC 22 0D 00 7B D6 72 67
0010 | 40 01 00 00 BE E4 12 D7 EE 85 9A 33 B0 A7 88 C3
0020 | A7 9D CF 8A BA A7 C7 87 AC DC A4 90 F0 0F 3D 67
0030 | 25 9E B2 B3 4E D8 51 B5 04 3F 4D 94 D7 00 00 00
0040 | 04 41 B9 F3 6F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A1 4F 50 A4 79 5F 1F A2 DC 38 76 D7
0060 | B8 82 F0 10 50 B5 20 E1 84 92 3F EF 6B 6B CC 13
0070 | 45 54 40 EE 13 68 35 A7 D1 83 E2 65 CC 17 CB 37
0080 | 17 0F A9 39 10 51 42 2C 8C F9 9F 2F DC 28 9F B1
0090 | 32 7B 8D 1F 34 46 99 9F AC 39 B7 A2 BA 97 A1 08
00A0 | 3C 60 7F FD BF DE B4 B3 5C 1C B9 EF A4 B3 D1 04
00B0 | 6F 81 39 41 E6 56 94 09 5A 2B 81 3E 8C 0C 11 37
00C0 | 03 5F 51 01 41 3E B0 32 1E 6B FD 6E 76 91 AE 65
00D0 | CF 69 AF 93 74 7D 1B 03 73 53 B4 3E 8E D6 98 10
00E0 | 43 1D C3 EF D6 AE 46 E0 35 88 1A 69 C1 8E AF E0
00F0 | CD 24 47 AF FE 5E A4 8F C4 8A 17 F3 17 D2 C2 F2
0100 | 77 5D FC 36 16 EA 6D 4C 3B 03 9F AE 1F 0B B7 7C
0110 | 4B 77 C8 53 3D A7 D3 51 83 09 E9 58 01 7B DC B4
0120 | 8B C7 E0 58 34 09 D8 60 7F 1E 60 48 1F D9 4C 3A
0130 | CF 1A D0 F1 B3 E5 BA 5B A9 F5 82 31 F2 48 74 77
0140 | 1F 69 3B 2A 50 4B E1 DF 0F 86 D6 69 36 5D 2F EF
0150 | 90 84 12 A8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>EC220D007BD67267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043F4D94D7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1062048983</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0441B9F36F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1102705519</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A14F50A4795F1FA2DC3876D7</code> <code>B882F01050B520E184923FEF6B6BCC13</code> <code>455440EE136835A7D183E265CC17CB37</code> <code>170FA9391051422C8CF99F2FDC289FB1</code> <code>327B8D1F3446999FAC39B7A2BA97A108</code> <code>3C607FFDBFDEB4B35C1CB9EFA4B3D104</code> <code>6F813941E65694095A2B813E8C0C1137</code> <code>035F5101413EB0321E6BFD6E7691AE65</code> <code>CF69AF93747D1B037353B43E8ED69810</code> <code>431DC3EFD6AE46E035881A69C18EAFE0</code> <code>CD2447AFFE5EA48FC48A17F317D2C2F2</code> <code>775DFC3616EA6D4C3B039FAE1F0BB77C</code> <code>4B77C8533DA7D3518309E958017BDCB4</code> <code>8BC7E0583409D8607F1E60481FD94C3A</code> <code>CF1AD0F1B3E5BA5BA9F58231F2487477</code> <code>1F693B2A504BE1DF0F86D669365D2FEF</code><br> <code>908412A8</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 00 6C 27 7B D6 72 67
0010 | 78 02 00 00 5C 07 E8 D0 EE 85 9A 33 B0 A7 88 C3
0020 | A7 9D CF 8A BA A7 C7 87 AC DC A4 90 F0 0F 3D 67
0030 | 25 9E B2 B3 4E D8 51 B5 FE 50 02 00 78 D0 AB 41
0040 | EF EB 3E 7D A1 37 85 8A 3D 6B FC 38 13 3C CA 7D
0050 | D9 E2 09 3B E1 20 17 95 2C 4C 9E 05 32 B1 0D 7F
0060 | B2 65 17 B4 16 FD EB 73 5D AF 29 FB 01 52 37 1F
0070 | 36 92 76 DF 27 C4 7C 95 D1 55 19 6B 54 A1 49 10
0080 | D1 0F 46 DB 0D 30 12 8D 0A 8C CD 6A 7A 58 04 1E
0090 | C9 6C 8F 3E 41 1C 5F 7A F8 8D 3D 80 45 79 37 B9
00A0 | 95 7B B3 E2 A4 5F FC 9F 24 65 A3 06 80 E7 39 1A
00B0 | 8D 23 36 81 EA 06 25 B1 03 5D 52 3E 68 CD 41 EA
00C0 | 28 AD 78 1B 93 CE 92 8F 75 52 42 5E 6B 96 87 43
00D0 | C4 A8 D6 CE 5A 20 17 75 62 0F 12 18 35 8A CE DC
00E0 | 72 19 ED 7A FE 3A D5 F0 5E 60 AB F9 29 03 F9 18
00F0 | 29 32 5D 6D 13 59 A8 6E 8E 01 FA 5E 36 7F 99 2D
0100 | 30 1C C9 13 92 74 E7 06 B6 22 30 83 20 61 C9 53
0110 | AD 0F 76 54 46 BF BA 9E F2 0F D4 EC B2 8F E8 C0
0120 | ED 9D 77 32 A7 6A BD 48 14 40 39 67 F1 1E 98 05
0130 | 1B 54 66 4F 97 12 19 64 94 87 F4 BC 47 13 9F B6
0140 | BD A0 CD D6 BC 2A 42 76 7B 22 69 EB 56 FA 10 1A
0150 | DE 25 10 1B 66 6D 50 71 F3 4C 03 FC A9 8D F2 1B
0160 | 74 C8 C9 54 BC 23 F3 AF 4D 8F 20 29 DC A4 65 0D
0170 | 74 86 0F 67 3B 83 C8 A1 C7 C4 C3 68 FC AF 3F 76
0180 | 4E 28 F2 33 0B F7 3E CF 72 52 83 19 76 FE 69 2D
0190 | 82 70 EF 4A 94 87 B3 2F 4E D1 59 49 88 BE D3 33
01A0 | D9 41 4A DB 00 C2 4A C1 EC BD 23 B1 17 DD B6 C5
01B0 | 99 87 B4 85 62 5C AC 20 38 32 24 40 0C 88 66 92
01C0 | 75 96 59 1E 43 96 88 13 0C 1A 1E 75 47 36 C6 88
01D0 | 93 88 97 8E BD 16 7E 6A C8 A9 CB E1 38 7E F2 3D
01E0 | 6E 3A C9 A9 F0 2A 65 88 97 86 04 B0 DC 36 DB 2D
01F0 | AE CA 1E 6D 8F 43 55 BE 96 4E CB EB 82 9A 3C AF
0200 | 27 71 42 57 83 3A 60 08 31 E7 45 DE DE AD 94 C4
0210 | FC 38 20 58 DE 91 F8 81 03 04 EB D7 99 C5 61 E9
0220 | 6B D1 F0 BF D1 54 5C 90 E5 76 A0 B5 5E 08 C9 D9
0230 | 1D 43 43 E3 FF 15 1F 2C 61 F2 25 13 DF 0E FD E7
0240 | C9 6A FB 38 A3 F9 09 F8 41 31 24 0B C8 02 66 F7
0250 | 41 90 8E C4 8D C7 84 07 CD 4E A1 06 C2 E1 09 D6
0260 | FC 70 A4 99 EE 8D E4 E6 8E 02 AB 6D 8B D0 BD 3C
0270 | B8 30 DA 5C 03 33 FC CC 5C 83 25 73 69 D3 E2 ED
0280 | 66 9B 1D AC 49 00 5B 94 30 45 2F 15</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01006C277BD67267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020078D0AB41EFEB3E7DA137858A</code> <code>3D6BFC38133CCA7DD9E2093BE1201795</code> <code>2C4C9E0532B10D7FB26517B416FDEB73</code> <code>5DAF29FB0152371F369276DF27C47C95</code> <code>D155196B54A14910D10F46DB0D30128D</code> <code>0A8CCD6A7A58041EC96C8F3E411C5F7A</code> <code>F88D3D80457937B9957BB3E2A45FFC9F</code> <code>2465A30680E7391A8D233681EA0625B1</code> <code>035D523E68CD41EA28AD781B93CE928F</code> <code>7552425E6B968743C4A8D6CE5A201775</code> <code>620F1218358ACEDC7219ED7AFE3AD5F0</code> <code>5E60ABF92903F91829325D6D1359A86E</code> <code>8E01FA5E367F992D301CC9139274E706</code> <code>B62230832061C953AD0F765446BFBA9E</code> <code>F20FD4ECB28FE8C0ED9D7732A76ABD48</code> <code>14403967F11E98051B54664F97121964</code> <code>9487F4BC47139FB6BDA0CDD6BC2A4276</code> <code>7B2269EB56FA101ADE25101B666D5071</code> <code>F34C03FCA98DF21B74C8C954BC23F3AF</code> <code>4D8F2029DCA4650D74860F673B83C8A1</code> <code>C7C4C368FCAF3F764E28F2330BF73ECF</code> <code>7252831976FE692D8270EF4A9487B32F</code> <code>4ED1594988BED333D9414ADB00C24AC1</code> <code>ECBD23B117DDB6C59987B485625CAC20</code> <code>383224400C8866927596591E43968813</code> <code>0C1A1E754736C6889388978EBD167E6A</code> <code>C8A9CBE1387EF23D6E3AC9A9F02A6588</code> <code>978604B0DC36DB2DAECA1E6D8F4355BE</code> <code>964ECBEB829A3CAF27714257833A6008</code> <code>31E745DEDEAD94C4FC382058DE91F881</code> <code>0304EBD799C561E96BD1F0BFD1545C90</code> <code>E576A0B55E08C9D91D4343E3FF151F2C</code> <code>61F22513DF0EFDE7C96AFB38A3F909F8</code> <code>4131240BC80266F741908EC48DC78407</code> <code>CD4EA106C2E109D6FC70A499EE8DE4E6</code> <code>8E02AB6D8BD0BD3CB830DA5C0333FCCC</code> <code>5C83257369D3E2ED669B1DAC49005B94</code><br> <code>30452F15</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 78D0AB41EFEB3E7DA137858A3D6BFC38133CCA7DD9E2093BE12017952C4C9E0532B10D7FB26517B416FDEB735DAF29FB0152371F369276DF27C47C95D155196B54A14910D10F46DB0D30128D0A8CCD6A7A58041EC96C8F3E411C5F7AF88D3D80457937B9957BB3E2A45FFC9F2465A30680E7391A8D233681EA0625B1035D523E68CD41EA28AD781B93CE928F7552425E6B968743C4A8D6CE5A201775620F1218358ACEDC7219ED7AFE3AD5F05E60ABF92903F91829325D6D1359A86E8E01FA5E367F992D301CC9139274E706B62230832061C953AD0F765446BFBA9EF20FD4ECB28FE8C0ED9D7732A76ABD4814403967F11E98051B54664F971219649487F4BC47139FB6BDA0CDD6BC2A42767B2269EB56FA101ADE25101B666D5071F34C03FCA98DF21B74C8C954BC23F3AF4D8F2029DCA4650D74860F673B83C8A1C7C4C368FCAF3F764E28F2330BF73ECF7252831976FE692D8270EF4A9487B32F4ED1594988BED333D9414ADB00C24AC1ECBD23B117DDB6C59987B485625CAC20383224400C8866927596591E439688130C1A1E754736C6889388978EBD167E6AC8A9CBE1387EF23D6E3AC9A9F02A6588978604B0DC36DB2DAECA1E6D8F4355BE964ECBEB829A3CAF27714257833A600831E745DEDEAD94C4FC382058DE91F8810304EBD799C561E96BD1F0BFD1545C90E576A0B55E08C9D91D4343E3FF151F2C61F22513DF0EFDE7C96AFB38A3F909F84131240BC80266F741908EC48DC78407CD4EA106C2E109D6FC70A499EE8DE4E68E02AB6D8BD0BD3CB830DA5C0333FCCC5C83257369D3E2ED669B1DAC49005B9430452F15
tmp_aes_key = F59B0484601BBAB4490E464BBFC15380488AC72C05A4B0A54BAAD3215EBB79A3
tmp_aes_iv = 5F6A3B527928FF399BB492E8BB5BB4ABEB0F6E163CAF27D3744F36A9C0B1E7DB</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 578080E8C433E4FA9FE5A7E9BDFAFB6178D0FB88BA0D89B5EE859A33B0A788C3A79DCF8ABAA7C787ACDCA490F00F3D67259EB2B34ED851B503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100973578A0BAC42550653FC39411243B83BB5DB6AA40C15D1BBC88D59B682E84973620386B147394C81E8DD737E0C987A54CBBCE710908590422BD2BF8BCC7A5A5BB6F557A6346446F7D66CE8F2AE7F11D848E8C3722D90502DFA08CBDD79F1C22D7A9AC7DA839D5619F668AEF726C7B12E19AE85EFD0C398F0C65E7B9EBA082B02BC1F52E06C8DCE7C618DF4F7265FAD0E0D2FA7E1875FA40ABE8D6B8E6E34E5CAB6335C5711E6D9EAB237251F074ED90C40C76EED07ACFC347CDAF3AB945C10C5A4A4EC2F4339DF9C6B42690319D6FF6E23F0E18E761D93C989EF84F8B073DAF905E3BF200A1D5CA2A2003E97F8AE838B927D3467E9B59EC810831F51CF971487BD67267A0DBFF00182E3AE5
answer = BA0D89B5EE859A33B0A788C3A79DCF8ABAA7C787ACDCA490F00F3D67259EB2B34ED851B503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100973578A0BAC42550653FC39411243B83BB5DB6AA40C15D1BBC88D59B682E84973620386B147394C81E8DD737E0C987A54CBBCE710908590422BD2BF8BCC7A5A5BB6F557A6346446F7D66CE8F2AE7F11D848E8C3722D90502DFA08CBDD79F1C22D7A9AC7DA839D5619F668AEF726C7B12E19AE85EFD0C398F0C65E7B9EBA082B02BC1F52E06C8DCE7C618DF4F7265FAD0E0D2FA7E1875FA40ABE8D6B8E6E34E5CAB6335C5711E6D9EAB237251F074ED90C40C76EED07ACFC347CDAF3AB945C10C5A4A4EC2F4339DF9C6B42690319D6FF6E23F0E18E761D93C989EF84F8B073DAF905E3BF200A1D5CA2A2003E97F8AE838B927D3467E9B59EC810831F51CF971487BD67267A0DBFF00182E3AE5</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 EE 85 9A 33 B0 A7 88 C3 A7 9D CF 8A
0010 | BA A7 C7 87 AC DC A4 90 F0 0F 3D 67 25 9E B2 B3
0020 | 4E D8 51 B5 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 97 35 78 A0 BA C4 25 50 65 3F C3 94 11 24 3B 83
0140 | BB 5D B6 AA 40 C1 5D 1B BC 88 D5 9B 68 2E 84 97
0150 | 36 20 38 6B 14 73 94 C8 1E 8D D7 37 E0 C9 87 A5
0160 | 4C BB CE 71 09 08 59 04 22 BD 2B F8 BC C7 A5 A5
0170 | BB 6F 55 7A 63 46 44 6F 7D 66 CE 8F 2A E7 F1 1D
0180 | 84 8E 8C 37 22 D9 05 02 DF A0 8C BD D7 9F 1C 22
0190 | D7 A9 AC 7D A8 39 D5 61 9F 66 8A EF 72 6C 7B 12
01A0 | E1 9A E8 5E FD 0C 39 8F 0C 65 E7 B9 EB A0 82 B0
01B0 | 2B C1 F5 2E 06 C8 DC E7 C6 18 DF 4F 72 65 FA D0
01C0 | E0 D2 FA 7E 18 75 FA 40 AB E8 D6 B8 E6 E3 4E 5C
01D0 | AB 63 35 C5 71 1E 6D 9E AB 23 72 51 F0 74 ED 90
01E0 | C4 0C 76 EE D0 7A CF C3 47 CD AF 3A B9 45 C1 0C
01F0 | 5A 4A 4E C2 F4 33 9D F9 C6 B4 26 90 31 9D 6F F6
0200 | E2 3F 0E 18 E7 61 D9 3C 98 9E F8 4F 8B 07 3D AF
0210 | 90 5E 3B F2 00 A1 D5 CA 2A 20 03 E9 7F 8A E8 38
0220 | B9 27 D3 46 7E 9B 59 EC 81 08 31 F5 1C F9 71 48
0230 | 7B D6 72 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100973578A0BAC42550653FC394</code> <code>11243B83BB5DB6AA40C15D1BBC88D59B</code> <code>682E84973620386B147394C81E8DD737</code> <code>E0C987A54CBBCE710908590422BD2BF8</code> <code>BCC7A5A5BB6F557A6346446F7D66CE8F</code> <code>2AE7F11D848E8C3722D90502DFA08CBD</code> <code>D79F1C22D7A9AC7DA839D5619F668AEF</code> <code>726C7B12E19AE85EFD0C398F0C65E7B9</code> <code>EBA082B02BC1F52E06C8DCE7C618DF4F</code> <code>7265FAD0E0D2FA7E1875FA40ABE8D6B8</code> <code>E6E34E5CAB6335C5711E6D9EAB237251</code> <code>F074ED90C40C76EED07ACFC347CDAF3A</code> <code>B945C10C5A4A4EC2F4339DF9C6B42690</code> <code>319D6FF6E23F0E18E761D93C989EF84F</code> <code>8B073DAF905E3BF200A1D5CA2A2003E9</code> <code>7F8AE838B927D3467E9B59EC810831F5</code><br> <code>1CF97148</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>7BD67267</code> (1735579259 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = BEF95C8AB2C146C4A4D9F5594DB12679291AAD3889C55658ADB48748968A9523DDB37DEEC045FC5B1D4BEC823D3076F58923E2D22CAA799B93747141E90E343DC69B8073F8E74E35EB08D5542F59B7A5441EC97633577759FABB142D7ABA794C07E51B7A273E638D56B549F594C6349CDCAA2B93A71CF46B3EE1ADCB57FAE5E0D3DFD2E99DC65B916315F50468B94C7D866AFB86A5A29A6F39FE552ABE963C04BBBAA7B186224641007BF9295D495043237797CE1F39243A93899F195BD402654615948B7212EC39B38287D68ED1951138492E366438A753959C934276CB4741974C775D4E950EC1EFAF3381342E7DC009FFEB6582B433B6A45263E900FF9D0E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 21D67172EF9C77F2D5A1DA961C1871B9E3462383CC2A29FBEDCDFE12DA962B065D446DD02C68F3CD5188CBDA8DB06C3942C35660E4BEEC33D9E33175D65B49B95BBF1342D00682617A753045A778BCE447AC86A45376052992C108239167273BC4D55548A2A812D0B77AB3E6C779928F79EACA6680F0D79CB7084FB2454958FF3658E9407EC16CD5684AECDDA7D3A1BE0A4D6C02C5F1ADCA7B95B8CD026139C03E3D2E7FB8C89D9E6F924CC073D398FAED1897B5078729422CAB32D9A3D8F98102BD5FCFE69AE75664E5F6A3AB1FBBC1043DE09764C70D37648F3FF38F38643DD85212D1035DA7351DF8CF21A13C03B7ECCA554F28807D729C7BF8B8CE4B5D9C</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 EE 85 9A 33 B0 A7 88 C3 A7 9D CF 8A
0010 | BA A7 C7 87 AC DC A4 90 F0 0F 3D 67 25 9E B2 B3
0020 | 4E D8 51 B5 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 21 D6 71 72 EF 9C 77 F2 D5 A1 DA 96 1C 18 71 B9
0040 | E3 46 23 83 CC 2A 29 FB ED CD FE 12 DA 96 2B 06
0050 | 5D 44 6D D0 2C 68 F3 CD 51 88 CB DA 8D B0 6C 39
0060 | 42 C3 56 60 E4 BE EC 33 D9 E3 31 75 D6 5B 49 B9
0070 | 5B BF 13 42 D0 06 82 61 7A 75 30 45 A7 78 BC E4
0080 | 47 AC 86 A4 53 76 05 29 92 C1 08 23 91 67 27 3B
0090 | C4 D5 55 48 A2 A8 12 D0 B7 7A B3 E6 C7 79 92 8F
00A0 | 79 EA CA 66 80 F0 D7 9C B7 08 4F B2 45 49 58 FF
00B0 | 36 58 E9 40 7E C1 6C D5 68 4A EC DD A7 D3 A1 BE
00C0 | 0A 4D 6C 02 C5 F1 AD CA 7B 95 B8 CD 02 61 39 C0
00D0 | 3E 3D 2E 7F B8 C8 9D 9E 6F 92 4C C0 73 D3 98 FA
00E0 | ED 18 97 B5 07 87 29 42 2C AB 32 D9 A3 D8 F9 81
00F0 | 02 BD 5F CF E6 9A E7 56 64 E5 F6 A3 AB 1F BB C1
0100 | 04 3D E0 97 64 C7 0D 37 64 8F 3F F3 8F 38 64 3D
0110 | D8 52 12 D1 03 5D A7 35 1D F8 CF 21 A1 3C 03 B7
0120 | EC CA 55 4F 28 80 7D 72 9C 7B F8 B8 CE 4B 5D 9C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010021D67172EF9C77F2D5A1DA96</code> <code>1C1871B9E3462383CC2A29FBEDCDFE12</code> <code>DA962B065D446DD02C68F3CD5188CBDA</code> <code>8DB06C3942C35660E4BEEC33D9E33175</code> <code>D65B49B95BBF1342D00682617A753045</code> <code>A778BCE447AC86A45376052992C10823</code> <code>9167273BC4D55548A2A812D0B77AB3E6</code> <code>C779928F79EACA6680F0D79CB7084FB2</code> <code>454958FF3658E9407EC16CD5684AECDD</code> <code>A7D3A1BE0A4D6C02C5F1ADCA7B95B8CD</code> <code>026139C03E3D2E7FB8C89D9E6F924CC0</code> <code>73D398FAED1897B5078729422CAB32D9</code> <code>A3D8F98102BD5FCFE69AE75664E5F6A3</code> <code>AB1FBBC1043DE09764C70D37648F3FF3</code> <code>8F38643DD85212D1035DA7351DF8CF21</code> <code>A13C03B7ECCA554F28807D729C7BF8B8</code><br> <code>CE4B5D9C</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366EE859A33B0A788C3A79DCF8ABAA7C787ACDCA490F00F3D67259EB2B34ED851B50000000000000000FE00010021D67172EF9C77F2D5A1DA961C1871B9E3462383CC2A29FBEDCDFE12DA962B065D446DD02C68F3CD5188CBDA8DB06C3942C35660E4BEEC33D9E33175D65B49B95BBF1342D00682617A753045A778BCE447AC86A45376052992C108239167273BC4D55548A2A812D0B77AB3E6C779928F79EACA6680F0D79CB7084FB2454958FF3658E9407EC16CD5684AECDDA7D3A1BE0A4D6C02C5F1ADCA7B95B8CD026139C03E3D2E7FB8C89D9E6F924CC073D398FAED1897B5078729422CAB32D9A3D8F98102BD5FCFE69AE75664E5F6A3AB1FBBC1043DE09764C70D37648F3FF38F38643DD85212D1035DA7351DF8CF21A13C03B7ECCA554F28807D729C7BF8B8CE4B5D9C
padding = 92686CA480B46AE4D2BB8686
tmp_aes_key = F59B0484601BBAB4490E464BBFC15380488AC72C05A4B0A54BAAD3215EBB79A3
tmp_aes_iv = 5F6A3B527928FF399BB492E8BB5BB4ABEB0F6E163CAF27D3744F36A9C0B1E7DB</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 6E6D2B221BD54ADBE50621D151315769A780584D9B706EC7620FF3EEF21562A67F23EDF23BFA9747043EAFFE68B7F221170C7B91728A2D5E7AB7248F3DF31A1C01D9A447FEE32849500A1AFFB5F0373F26002EB6C00A4FAC88D44F7B3BC7E4D9E3C0610BD82D56CA8697C8F1F30D245A1CE38F370AB223D7A6B6CD4C21E795D44D7ABBA06CD13C0F8C7224DE2228F964E4EAC272685091141ED2AD6FB88035867F1279E8F2D828BA331417B500F18DA9DD18E0DA4B94D406D9EC53BA20562B140BDDCD7F832AA5E9F4BAE2FE9448C83B80F2D81EEA165AAF2DDDD1751540E8194309E209C62E347BFF8753BB0C3A8BF2808C2151F62801DD2F05E6A5D5029BA6283C6A3030DEE1CEE6BC7540AAC4AAB6D59F3E6C58F5BDA8637461F583357BBDD82A451536DCFABA3638D66163B422D16391B06C02B5DF3EAC9B4ADF78B02DE96802FCAE5393BFD31A2C0884B07713C1</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 22 0D 00 7B D6 72 67
0010 | 78 01 00 00 1F 5F 04 F5 EE 85 9A 33 B0 A7 88 C3
0020 | A7 9D CF 8A BA A7 C7 87 AC DC A4 90 F0 0F 3D 67
0030 | 25 9E B2 B3 4E D8 51 B5 FE 50 01 00 6E 6D 2B 22
0040 | 1B D5 4A DB E5 06 21 D1 51 31 57 69 A7 80 58 4D
0050 | 9B 70 6E C7 62 0F F3 EE F2 15 62 A6 7F 23 ED F2
0060 | 3B FA 97 47 04 3E AF FE 68 B7 F2 21 17 0C 7B 91
0070 | 72 8A 2D 5E 7A B7 24 8F 3D F3 1A 1C 01 D9 A4 47
0080 | FE E3 28 49 50 0A 1A FF B5 F0 37 3F 26 00 2E B6
0090 | C0 0A 4F AC 88 D4 4F 7B 3B C7 E4 D9 E3 C0 61 0B
00A0 | D8 2D 56 CA 86 97 C8 F1 F3 0D 24 5A 1C E3 8F 37
00B0 | 0A B2 23 D7 A6 B6 CD 4C 21 E7 95 D4 4D 7A BB A0
00C0 | 6C D1 3C 0F 8C 72 24 DE 22 28 F9 64 E4 EA C2 72
00D0 | 68 50 91 14 1E D2 AD 6F B8 80 35 86 7F 12 79 E8
00E0 | F2 D8 28 BA 33 14 17 B5 00 F1 8D A9 DD 18 E0 DA
00F0 | 4B 94 D4 06 D9 EC 53 BA 20 56 2B 14 0B DD CD 7F
0100 | 83 2A A5 E9 F4 BA E2 FE 94 48 C8 3B 80 F2 D8 1E
0110 | EA 16 5A AF 2D DD D1 75 15 40 E8 19 43 09 E2 09
0120 | C6 2E 34 7B FF 87 53 BB 0C 3A 8B F2 80 8C 21 51
0130 | F6 28 01 DD 2F 05 E6 A5 D5 02 9B A6 28 3C 6A 30
0140 | 30 DE E1 CE E6 BC 75 40 AA C4 AA B6 D5 9F 3E 6C
0150 | 58 F5 BD A8 63 74 61 F5 83 35 7B BD D8 2A 45 15
0160 | 36 DC FA BA 36 38 D6 61 63 B4 22 D1 63 91 B0 6C
0170 | 02 B5 DF 3E AC 9B 4A DF 78 B0 2D E9 68 02 FC AE
0180 | 53 93 BF D3 1A 2C 08 84 B0 77 13 C1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0220D007BD67267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001006E6D2B221BD54ADBE50621D1</code> <code>51315769A780584D9B706EC7620FF3EE</code> <code>F21562A67F23EDF23BFA9747043EAFFE</code> <code>68B7F221170C7B91728A2D5E7AB7248F</code> <code>3DF31A1C01D9A447FEE32849500A1AFF</code> <code>B5F0373F26002EB6C00A4FAC88D44F7B</code> <code>3BC7E4D9E3C0610BD82D56CA8697C8F1</code> <code>F30D245A1CE38F370AB223D7A6B6CD4C</code> <code>21E795D44D7ABBA06CD13C0F8C7224DE</code> <code>2228F964E4EAC272685091141ED2AD6F</code> <code>B88035867F1279E8F2D828BA331417B5</code> <code>00F18DA9DD18E0DA4B94D406D9EC53BA</code> <code>20562B140BDDCD7F832AA5E9F4BAE2FE</code> <code>9448C83B80F2D81EEA165AAF2DDDD175</code> <code>1540E8194309E209C62E347BFF8753BB</code> <code>0C3A8BF2808C2151F62801DD2F05E6A5</code> <code>D5029BA6283C6A3030DEE1CEE6BC7540</code> <code>AAC4AAB6D59F3E6C58F5BDA8637461F5</code> <code>83357BBDD82A451536DCFABA3638D661</code> <code>63B422D16391B06C02B5DF3EAC9B4ADF</code> <code>78B02DE96802FCAE5393BFD31A2C0884</code><br> <code>B07713C1</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 50FBE9A0097B97666A70567EF7A265018202B29945D1FA0BF62FCF6B8FAE613C35DE523E7E8A5D6E396FC449994E43B3294F697D8FAFD0EF7223F88D326B65DC558BACD6E3FFF4FC017435032A308D421DDE1ADCE2DFF01E49CD0BB771D131BD88CE1B17358E87E25D84A3D3DF1FD81CD2F5C100FCA374C8F8CF26D906A406A94E96835E833D8F395AAE6E6E34C02DEF8E14071F408A9019F1324ED355B398D4E12A27B086D4D41666D5ED83B6C6A2FB4E6933FCC07B8FBBD1E5CF06457D2CF90251F2C7D070B48F9E5D5E0B7A8F5AA1DD18A34589C6AD2111EB601CDC9823AE23FE78040CF738F5966D3DAAECEA5BF1D922B50DA2C5059652E7E9C6023B6739</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 68 52 6E 7C D6 72 67
0010 | 34 00 00 00 34 F7 CB 3B EE 85 9A 33 B0 A7 88 C3
0020 | A7 9D CF 8A BA A7 C7 87 AC DC A4 90 F0 0F 3D 67
0030 | 25 9E B2 B3 4E D8 51 B5 AD 09 2C 4A 4F 95 A7 43
0040 | FF AC 4C EC 1E 24 32 A6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0168526E7CD67267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>EE859A33B0A788C3A79DCF8ABAA7C787</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>ACDCA490F00F3D67259EB2B34ED851B5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>AD092C4A4F95A743FFAC4CEC1E2432A6</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

