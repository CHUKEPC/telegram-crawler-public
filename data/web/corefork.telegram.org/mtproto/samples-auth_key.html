<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 58 86 0D 00 57 C2 AF 66
0010 | 14 00 00 00 F1 8E 7E BE 11 B9 C2 84 50 81 17 76
0020 | D4 24 CA 45 CD D0 38 74</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>58860D0057C2AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B8 09 7C 57 C2 AF 66
0010 | 54 00 00 00 63 24 16 05 11 B9 C2 84 50 81 17 76
0020 | D4 24 CA 45 CD D0 38 74 46 0A 42 F7 E8 9B 5F 4E
0030 | 9B 13 1B 62 6D CD 43 14 08 1E CA 00 88 61 80 8B
0040 | D1 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B8097C57C2AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>54000000</code> (84 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081ECA008861808BD1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2218586352184757201</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2218586352184757201</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2218586352184757201 = 1308465869 * 1695563029</code></p>
<pre><code>p = 1308465869
q = 1695563029</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1E CA 00 88 61 80 8B D1 00 00 00
0010 | 04 4D FD 9A CD 00 00 00 04 65 10 3D 15 00 00 00
0020 | 11 B9 C2 84 50 81 17 76 D4 24 CA 45 CD D0 38 74
0030 | 46 0A 42 F7 E8 9B 5F 4E 9B 13 1B 62 6D CD 43 14
0040 | D1 44 94 66 E7 24 4E D4 A1 94 E6 6E FB 19 20 AC
0050 | B7 8B 50 A6 DA 5C 66 E4 D9 CF 9B 47 25 63 E9 A1
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081ECA008861808BD1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2218586352184757201</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044DFD9ACD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1308465869</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0465103D15000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1695563029</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>D1449466E7244ED4A194E66EFB1920AC</code> <code>B78B50A6DA5C66E4D9CF9B472563E9A1</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081ECA008861808BD1000000044DFD9ACD0000000465103D1500000011B9C28450811776D424CA45CDD03874460A42F7E89B5F4E9B131B626DCD4314D1449466E7244ED4A194E66EFB1920ACB78B50A6DA5C66E4D9CF9B472563E9A102000000
random_padding_bytes = D928E03E2D182003FDD073198CAFC5C9FF4FF398D108A82863F2F99253AB267EE4BC2B0E8C9CE3A3AADC03C6B56BF0D11AB702FA7DDAA012F216FD61FAEC30D3A8BA03F970B9AB7882AF1A5F6AD457E38DA4C08E13D8C61A66F1A41A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 66B4C08174C9A630BFE83A625C4C34EF67D5B3096E5CBE9CD09447676A7E3F4A6C194889A89CE4EE1C801A8823C25EE9AFAA339DB24726E7B6BF65D9C86064BF2AD687CE883C7FCAED4C3A2B378E99799DE7A9170E1A3B58EA403A3F597132C2F33073A411AF733568B7E1B0F8AC66121725AE8355FA43CB63E05D6D710132F4336EB8A0CE40792D13FBACB7E87F3E887453FF422301D2B4EAAF007D9BE739B920C20F485551136ACDA6C943583A158C62DEE5AECBDFCC3F88F705EB1F350193ACE8E007AF33275A0489BF1FFF8422BE9B9315AC79160166F9CFE96C971AB74FED0CDAC515FC7CBB1598EBEBCECF7E6500106C5BE4FFB9E2CEA0E4E651A6AD52</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 5C 86 0D 00 57 C2 AF 66
0010 | 40 01 00 00 BE E4 12 D7 11 B9 C2 84 50 81 17 76
0020 | D4 24 CA 45 CD D0 38 74 46 0A 42 F7 E8 9B 5F 4E
0030 | 9B 13 1B 62 6D CD 43 14 04 4D FD 9A CD 00 00 00
0040 | 04 65 10 3D 15 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 66 B4 C0 81 74 C9 A6 30 BF E8 3A 62
0060 | 5C 4C 34 EF 67 D5 B3 09 6E 5C BE 9C D0 94 47 67
0070 | 6A 7E 3F 4A 6C 19 48 89 A8 9C E4 EE 1C 80 1A 88
0080 | 23 C2 5E E9 AF AA 33 9D B2 47 26 E7 B6 BF 65 D9
0090 | C8 60 64 BF 2A D6 87 CE 88 3C 7F CA ED 4C 3A 2B
00A0 | 37 8E 99 79 9D E7 A9 17 0E 1A 3B 58 EA 40 3A 3F
00B0 | 59 71 32 C2 F3 30 73 A4 11 AF 73 35 68 B7 E1 B0
00C0 | F8 AC 66 12 17 25 AE 83 55 FA 43 CB 63 E0 5D 6D
00D0 | 71 01 32 F4 33 6E B8 A0 CE 40 79 2D 13 FB AC B7
00E0 | E8 7F 3E 88 74 53 FF 42 23 01 D2 B4 EA AF 00 7D
00F0 | 9B E7 39 B9 20 C2 0F 48 55 51 13 6A CD A6 C9 43
0100 | 58 3A 15 8C 62 DE E5 AE CB DF CC 3F 88 F7 05 EB
0110 | 1F 35 01 93 AC E8 E0 07 AF 33 27 5A 04 89 BF 1F
0120 | FF 84 22 BE 9B 93 15 AC 79 16 01 66 F9 CF E9 6C
0130 | 97 1A B7 4F ED 0C DA C5 15 FC 7C BB 15 98 EB EB
0140 | CE CF 7E 65 00 10 6C 5B E4 FF B9 E2 CE A0 E4 E6
0150 | 51 A6 AD 52</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>5C860D0057C2AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044DFD9ACD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1308465869</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0465103D15000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1695563029</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010066B4C08174C9A630BFE83A62</code> <code>5C4C34EF67D5B3096E5CBE9CD0944767</code> <code>6A7E3F4A6C194889A89CE4EE1C801A88</code> <code>23C25EE9AFAA339DB24726E7B6BF65D9</code> <code>C86064BF2AD687CE883C7FCAED4C3A2B</code> <code>378E99799DE7A9170E1A3B58EA403A3F</code> <code>597132C2F33073A411AF733568B7E1B0</code> <code>F8AC66121725AE8355FA43CB63E05D6D</code> <code>710132F4336EB8A0CE40792D13FBACB7</code> <code>E87F3E887453FF422301D2B4EAAF007D</code> <code>9BE739B920C20F485551136ACDA6C943</code> <code>583A158C62DEE5AECBDFCC3F88F705EB</code> <code>1F350193ACE8E007AF33275A0489BF1F</code> <code>FF8422BE9B9315AC79160166F9CFE96C</code> <code>971AB74FED0CDAC515FC7CBB1598EBEB</code> <code>CECF7E6500106C5BE4FFB9E2CEA0E4E6</code><br> <code>51A6AD52</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B8 1D 3E 58 C2 AF 66
0010 | F0 02 00 00 5C 07 E8 D0 11 B9 C2 84 50 81 17 76
0020 | D4 24 CA 45 CD D0 38 74 46 0A 42 F7 E8 9B 5F 4E
0030 | 9B 13 1B 62 6D CD 43 14 FE 50 02 00 EE BE 28 88
0040 | 0E AC F2 EB 57 DC E9 60 8F 51 DE 85 62 5E 9B 0A
0050 | FA B8 E0 BA 26 8F 29 E7 38 94 32 79 A8 15 73 84
0060 | ED A1 01 D2 4E 6B 2C 98 01 26 E2 60 F9 FF B6 02
0070 | 3B CB 27 18 20 0F BD 1F 78 A1 65 32 79 AD 19 C6
0080 | 2B CB 98 83 B2 EB 3B 13 BC A8 71 67 95 4D 70 54
0090 | AD EA 5A B9 36 D2 89 94 EC A1 4F AE 6E BF 21 B6
00A0 | 8E 73 78 08 59 29 74 F2 E3 EA EE 7D 5A ED 69 39
00B0 | C1 02 F1 6D C6 66 6F 51 79 32 93 0E F8 2A DD 90
00C0 | 48 45 D8 BB EB B8 F7 3A AC 3B 00 B3 81 5C AA 19
00D0 | C9 6A C7 C0 29 8E E0 CE BB FB B8 1C 06 6F 62 C6
00E0 | 03 0D AC 62 59 A7 E9 6D 9E 9C AF 50 D1 8A F2 37
00F0 | 21 56 77 D2 97 17 23 10 AA F5 62 CA 1C 50 BA 92
0100 | B1 7B B7 DD 61 4D 78 56 51 C2 7C B1 93 BC AD 7B
0110 | DA DC A3 71 29 28 9D C4 5F 3D D1 76 8F 18 9F 48
0120 | 7C 0D EB 8F 0D 72 EE F2 BC DF D2 38 C6 77 60 D1
0130 | A8 3B 4A 2D 2A D7 7A 36 40 73 5B B6 15 92 EF 46
0140 | 51 47 F2 E6 B7 0D EA 1C E3 68 6F CC 26 12 47 AC
0150 | 5D 9D F7 9F D2 E8 91 8D 04 C5 B6 5F 9C A9 70 D4
0160 | EB 55 E1 D5 BD 45 F9 9C 60 13 AC 5B 50 0E 3D C4
0170 | 6A 2C F8 DA 3D 99 03 24 D2 61 57 D1 8F 18 76 92
0180 | 31 21 3E E3 48 D8 91 59 E3 09 36 81 AC D6 A0 1E
0190 | 6D 23 04 C2 93 87 D0 1B E9 58 31 9D 85 21 95 74
01A0 | AF A3 EE B9 A3 AB EB 8E 73 61 65 93 75 57 35 BC
01B0 | 6E DB 81 49 EC 30 AC C5 37 37 3D 21 87 8A 6F 09
01C0 | 3E BA FA C5 2B 26 44 60 FF 1A 96 7E 37 A6 76 DC
01D0 | E8 44 CB 64 11 B5 B2 09 36 F0 4D 07 3D 04 6F 07
01E0 | 03 E1 3E FE 8A 99 60 53 20 61 50 85 D7 BF 77 A7
01F0 | 97 30 D3 45 0A 7A 83 3B E6 4D 05 14 35 34 F7 7F
0200 | 12 DF 8F 0E BF 68 9C 8C C8 27 15 02 13 C5 00 45
0210 | 35 01 0E 72 30 44 49 2D 5F 43 22 67 39 24 3D 62
0220 | 13 12 15 1E 90 C1 84 16 C0 14 05 5E BE A0 B9 96
0230 | 46 F4 E7 FB 07 6F 02 37 12 A1 64 8D 1B 72 99 9D
0240 | A7 36 79 C6 5A F6 87 C0 DC 31 BD A7 66 25 E2 08
0250 | AE 96 E3 5A 82 7F 2E 7B 4B 89 1D BE 2F 3C BE 45
0260 | EA 02 EC 9C 8C B2 5C 09 81 4E 9F FD 3A C8 12 10
0270 | 7D B8 75 21 FB 07 C2 B8 29 53 E2 4A F4 CC 5E C1
0280 | 3F 94 58 C2 D1 9D 44 0F 2D 76 D6 6B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B81D3E58C2AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>F0020000</code> (752 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200EEBE28880EACF2EB57DCE960</code> <code>8F51DE85625E9B0AFAB8E0BA268F29E7</code> <code>38943279A8157384EDA101D24E6B2C98</code> <code>0126E260F9FFB6023BCB2718200FBD1F</code> <code>78A1653279AD19C62BCB9883B2EB3B13</code> <code>BCA87167954D7054ADEA5AB936D28994</code> <code>ECA14FAE6EBF21B68E737808592974F2</code> <code>E3EAEE7D5AED6939C102F16DC6666F51</code> <code>7932930EF82ADD904845D8BBEBB8F73A</code> <code>AC3B00B3815CAA19C96AC7C0298EE0CE</code> <code>BBFBB81C066F62C6030DAC6259A7E96D</code> <code>9E9CAF50D18AF237215677D297172310</code> <code>AAF562CA1C50BA92B17BB7DD614D7856</code> <code>51C27CB193BCAD7BDADCA37129289DC4</code> <code>5F3DD1768F189F487C0DEB8F0D72EEF2</code> <code>BCDFD238C67760D1A83B4A2D2AD77A36</code> <code>40735BB61592EF465147F2E6B70DEA1C</code> <code>E3686FCC261247AC5D9DF79FD2E8918D</code> <code>04C5B65F9CA970D4EB55E1D5BD45F99C</code> <code>6013AC5B500E3DC46A2CF8DA3D990324</code> <code>D26157D18F18769231213EE348D89159</code> <code>E3093681ACD6A01E6D2304C29387D01B</code> <code>E958319D85219574AFA3EEB9A3ABEB8E</code> <code>73616593755735BC6EDB8149EC30ACC5</code> <code>37373D21878A6F093EBAFAC52B264460</code> <code>FF1A967E37A676DCE844CB6411B5B209</code> <code>36F04D073D046F0703E13EFE8A996053</code> <code>20615085D7BF77A79730D3450A7A833B</code> <code>E64D05143534F77F12DF8F0EBF689C8C</code> <code>C827150213C5004535010E723044492D</code> <code>5F43226739243D621312151E90C18416</code> <code>C014055EBEA0B99646F4E7FB076F0237</code> <code>12A1648D1B72999DA73679C65AF687C0</code> <code>DC31BDA76625E208AE96E35A827F2E7B</code> <code>4B891DBE2F3CBE45EA02EC9C8CB25C09</code> <code>814E9FFD3AC812107DB87521FB07C2B8</code> <code>2953E24AF4CC5EC13F9458C2D19D440F</code><br> <code>2D76D66B</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = EEBE28880EACF2EB57DCE9608F51DE85625E9B0AFAB8E0BA268F29E738943279A8157384EDA101D24E6B2C980126E260F9FFB6023BCB2718200FBD1F78A1653279AD19C62BCB9883B2EB3B13BCA87167954D7054ADEA5AB936D28994ECA14FAE6EBF21B68E737808592974F2E3EAEE7D5AED6939C102F16DC6666F517932930EF82ADD904845D8BBEBB8F73AAC3B00B3815CAA19C96AC7C0298EE0CEBBFBB81C066F62C6030DAC6259A7E96D9E9CAF50D18AF237215677D297172310AAF562CA1C50BA92B17BB7DD614D785651C27CB193BCAD7BDADCA37129289DC45F3DD1768F189F487C0DEB8F0D72EEF2BCDFD238C67760D1A83B4A2D2AD77A3640735BB61592EF465147F2E6B70DEA1CE3686FCC261247AC5D9DF79FD2E8918D04C5B65F9CA970D4EB55E1D5BD45F99C6013AC5B500E3DC46A2CF8DA3D990324D26157D18F18769231213EE348D89159E3093681ACD6A01E6D2304C29387D01BE958319D85219574AFA3EEB9A3ABEB8E73616593755735BC6EDB8149EC30ACC537373D21878A6F093EBAFAC52B264460FF1A967E37A676DCE844CB6411B5B20936F04D073D046F0703E13EFE8A99605320615085D7BF77A79730D3450A7A833BE64D05143534F77F12DF8F0EBF689C8CC827150213C5004535010E723044492D5F43226739243D621312151E90C18416C014055EBEA0B99646F4E7FB076F023712A1648D1B72999DA73679C65AF687C0DC31BDA76625E208AE96E35A827F2E7B4B891DBE2F3CBE45EA02EC9C8CB25C09814E9FFD3AC812107DB87521FB07C2B82953E24AF4CC5EC13F9458C2D19D440F2D76D66B
tmp_aes_key = 1A1FED6F7BFBAF3F9F937DB0FADB2AE244441F2AA4B79FE561E76C94CCD0CC9A
tmp_aes_iv = DC2BB68E57BB645A96CF81879767AFC8AF52883C3B1971F7B5B3A0E5D1449466</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = B475F96199BF36A3B95731308F7DC78B7B7C6988BA0D89B511B9C28450811776D424CA45CDD03874460A42F7E89B5F4E9B131B626DCD431403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003BD926F73D68817843BFC4963D3B97C0CACFC97C270F89E781C71F19E4C46FF8D52D5CF329BADEC610B27A80641E4D9E05CE8A04ACC5A1818DF53222A59931D182D87CEC135B53D3A2E6989B65B6DA1B258662D01054CF4BE2EFD19B85D9856D5A2C763AF0126883063A23D21C90A9434E7B6C0DA56033E6BB2DFE83A6E3D6BC018FEF853C2685AA4872BFC0C93BC4438D096C4A8E6A7DB880DAB669EC56A947B9C2782BAEA78F580FE97DB88B18CBEF0FB0BD4DFFAA074B7B86A99CF12E2E7716B03443D9BAB7D2B9AE1543AC158DEE559EC4C961BF9562791020F6E137E827E0D57372D97E3240844B6E592877DD31BC81B0A5F356564A5A5832F6285D52E058C2AF66E970BF0B9F3B0E20
answer = BA0D89B511B9C28450811776D424CA45CDD03874460A42F7E89B5F4E9B131B626DCD431403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003BD926F73D68817843BFC4963D3B97C0CACFC97C270F89E781C71F19E4C46FF8D52D5CF329BADEC610B27A80641E4D9E05CE8A04ACC5A1818DF53222A59931D182D87CEC135B53D3A2E6989B65B6DA1B258662D01054CF4BE2EFD19B85D9856D5A2C763AF0126883063A23D21C90A9434E7B6C0DA56033E6BB2DFE83A6E3D6BC018FEF853C2685AA4872BFC0C93BC4438D096C4A8E6A7DB880DAB669EC56A947B9C2782BAEA78F580FE97DB88B18CBEF0FB0BD4DFFAA074B7B86A99CF12E2E7716B03443D9BAB7D2B9AE1543AC158DEE559EC4C961BF9562791020F6E137E827E0D57372D97E3240844B6E592877DD31BC81B0A5F356564A5A5832F6285D52E058C2AF66E970BF0B9F3B0E20</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 11 B9 C2 84 50 81 17 76 D4 24 CA 45
0010 | CD D0 38 74 46 0A 42 F7 E8 9B 5F 4E 9B 13 1B 62
0020 | 6D CD 43 14 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 3B D9 26 F7 3D 68 81 78 43 BF C4 96 3D 3B 97 C0
0140 | CA CF C9 7C 27 0F 89 E7 81 C7 1F 19 E4 C4 6F F8
0150 | D5 2D 5C F3 29 BA DE C6 10 B2 7A 80 64 1E 4D 9E
0160 | 05 CE 8A 04 AC C5 A1 81 8D F5 32 22 A5 99 31 D1
0170 | 82 D8 7C EC 13 5B 53 D3 A2 E6 98 9B 65 B6 DA 1B
0180 | 25 86 62 D0 10 54 CF 4B E2 EF D1 9B 85 D9 85 6D
0190 | 5A 2C 76 3A F0 12 68 83 06 3A 23 D2 1C 90 A9 43
01A0 | 4E 7B 6C 0D A5 60 33 E6 BB 2D FE 83 A6 E3 D6 BC
01B0 | 01 8F EF 85 3C 26 85 AA 48 72 BF C0 C9 3B C4 43
01C0 | 8D 09 6C 4A 8E 6A 7D B8 80 DA B6 69 EC 56 A9 47
01D0 | B9 C2 78 2B AE A7 8F 58 0F E9 7D B8 8B 18 CB EF
01E0 | 0F B0 BD 4D FF AA 07 4B 7B 86 A9 9C F1 2E 2E 77
01F0 | 16 B0 34 43 D9 BA B7 D2 B9 AE 15 43 AC 15 8D EE
0200 | 55 9E C4 C9 61 BF 95 62 79 10 20 F6 E1 37 E8 27
0210 | E0 D5 73 72 D9 7E 32 40 84 4B 6E 59 28 77 DD 31
0220 | BC 81 B0 A5 F3 56 56 4A 5A 58 32 F6 28 5D 52 E0
0230 | 58 C2 AF 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001003BD926F73D68817843BFC496</code> <code>3D3B97C0CACFC97C270F89E781C71F19</code> <code>E4C46FF8D52D5CF329BADEC610B27A80</code> <code>641E4D9E05CE8A04ACC5A1818DF53222</code> <code>A59931D182D87CEC135B53D3A2E6989B</code> <code>65B6DA1B258662D01054CF4BE2EFD19B</code> <code>85D9856D5A2C763AF0126883063A23D2</code> <code>1C90A9434E7B6C0DA56033E6BB2DFE83</code> <code>A6E3D6BC018FEF853C2685AA4872BFC0</code> <code>C93BC4438D096C4A8E6A7DB880DAB669</code> <code>EC56A947B9C2782BAEA78F580FE97DB8</code> <code>8B18CBEF0FB0BD4DFFAA074B7B86A99C</code> <code>F12E2E7716B03443D9BAB7D2B9AE1543</code> <code>AC158DEE559EC4C961BF9562791020F6</code> <code>E137E827E0D57372D97E3240844B6E59</code> <code>2877DD31BC81B0A5F356564A5A5832F6</code><br> <code>285D52E0</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>58C2AF66</code> (1722794584 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = F28C0CCF5F5938919943588FADD6370D14E58BC4FF7CF896091C68F4C201ED022F7E0056611EA0A29E7953333B56DB1BF033F51905479825BB2F8353C35A4024202779479FDE54C341344F71B3729026BCD33DD044405F0C38E04F36737305E98209E432E3DD00EC0D5EA8DA3885BAD711BCBFE50EF93B8B71C2DD37627DDE47FF1AD06330F43CB5BC93F287B5E570A54B356460CCA6365543FD73324A7863CDA2C6EF5D06A88C1ECA211075AEAB4B5DC4D2C037442B558CAEA10008DC583C559D114DA2DD7D6ED583FA93764947B0B14E8D8BAD4EDE77CA1FCCE5DA7170CB67AC9F080FFE7B33732BBA68A6230AD1E504506E47CEECC4BAB8EC45478F06D247</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 1DF4FC94AADE7F83CA2A60697350FB28BD0C574CC4FB74264A4C435D5C2011AC914839A95FE8451DBE8E3201F904465D99E72B0D072E4BE4D1461452B3521ADED3E957ECABA6252FFBA6FC72F7838AF3B2CE79FABC4E9F8943A6FB848A86818107D4E15720B3059ABDF3D1E594B14F9329ADA57A898E2818FB8974B81D6AABC22E3AFECA6224329C4EA74754063502098161D57D5A364FF643585A0F1B0BAAEDDFD69388740AF5D0DB8D735256955EBC1BAAE4CF1CF14EAB5E801280A0996BA62B6496D040689C86FD0B61FB2C35DE6061A8BE27073F26B865837DC3C224C7DB42BF1ACE8E4E883FAFF8770B1F3A09AF485071BC06B12AFD6B6F57989A3B3582</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 11 B9 C2 84 50 81 17 76 D4 24 CA 45
0010 | CD D0 38 74 46 0A 42 F7 E8 9B 5F 4E 9B 13 1B 62
0020 | 6D CD 43 14 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 1D F4 FC 94 AA DE 7F 83 CA 2A 60 69 73 50 FB 28
0040 | BD 0C 57 4C C4 FB 74 26 4A 4C 43 5D 5C 20 11 AC
0050 | 91 48 39 A9 5F E8 45 1D BE 8E 32 01 F9 04 46 5D
0060 | 99 E7 2B 0D 07 2E 4B E4 D1 46 14 52 B3 52 1A DE
0070 | D3 E9 57 EC AB A6 25 2F FB A6 FC 72 F7 83 8A F3
0080 | B2 CE 79 FA BC 4E 9F 89 43 A6 FB 84 8A 86 81 81
0090 | 07 D4 E1 57 20 B3 05 9A BD F3 D1 E5 94 B1 4F 93
00A0 | 29 AD A5 7A 89 8E 28 18 FB 89 74 B8 1D 6A AB C2
00B0 | 2E 3A FE CA 62 24 32 9C 4E A7 47 54 06 35 02 09
00C0 | 81 61 D5 7D 5A 36 4F F6 43 58 5A 0F 1B 0B AA ED
00D0 | DF D6 93 88 74 0A F5 D0 DB 8D 73 52 56 95 5E BC
00E0 | 1B AA E4 CF 1C F1 4E AB 5E 80 12 80 A0 99 6B A6
00F0 | 2B 64 96 D0 40 68 9C 86 FD 0B 61 FB 2C 35 DE 60
0100 | 61 A8 BE 27 07 3F 26 B8 65 83 7D C3 C2 24 C7 DB
0110 | 42 BF 1A CE 8E 4E 88 3F AF F8 77 0B 1F 3A 09 AF
0120 | 48 50 71 BC 06 B1 2A FD 6B 6F 57 98 9A 3B 35 82</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001001DF4FC94AADE7F83CA2A6069</code> <code>7350FB28BD0C574CC4FB74264A4C435D</code> <code>5C2011AC914839A95FE8451DBE8E3201</code> <code>F904465D99E72B0D072E4BE4D1461452</code> <code>B3521ADED3E957ECABA6252FFBA6FC72</code> <code>F7838AF3B2CE79FABC4E9F8943A6FB84</code> <code>8A86818107D4E15720B3059ABDF3D1E5</code> <code>94B14F9329ADA57A898E2818FB8974B8</code> <code>1D6AABC22E3AFECA6224329C4EA74754</code> <code>063502098161D57D5A364FF643585A0F</code> <code>1B0BAAEDDFD69388740AF5D0DB8D7352</code> <code>56955EBC1BAAE4CF1CF14EAB5E801280</code> <code>A0996BA62B6496D040689C86FD0B61FB</code> <code>2C35DE6061A8BE27073F26B865837DC3</code> <code>C224C7DB42BF1ACE8E4E883FAFF8770B</code> <code>1F3A09AF485071BC06B12AFD6B6F5798</code><br> <code>9A3B3582</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436611B9C28450811776D424CA45CDD03874460A42F7E89B5F4E9B131B626DCD43140000000000000000FE0001001DF4FC94AADE7F83CA2A60697350FB28BD0C574CC4FB74264A4C435D5C2011AC914839A95FE8451DBE8E3201F904465D99E72B0D072E4BE4D1461452B3521ADED3E957ECABA6252FFBA6FC72F7838AF3B2CE79FABC4E9F8943A6FB848A86818107D4E15720B3059ABDF3D1E594B14F9329ADA57A898E2818FB8974B81D6AABC22E3AFECA6224329C4EA74754063502098161D57D5A364FF643585A0F1B0BAAEDDFD69388740AF5D0DB8D735256955EBC1BAAE4CF1CF14EAB5E801280A0996BA62B6496D040689C86FD0B61FB2C35DE6061A8BE27073F26B865837DC3C224C7DB42BF1ACE8E4E883FAFF8770B1F3A09AF485071BC06B12AFD6B6F57989A3B3582
padding = E9C4D2B19A570E24FA7B42EF
tmp_aes_key = 1A1FED6F7BFBAF3F9F937DB0FADB2AE244441F2AA4B79FE561E76C94CCD0CC9A
tmp_aes_iv = DC2BB68E57BB645A96CF81879767AFC8AF52883C3B1971F7B5B3A0E5D1449466</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C9B1B0550BC9E68CD811FCFBA555E4C457342DF4F81D14F1C8DD8385AE71AB272594173139DA637AE60E834F45ED18C8B1269B81387A22F1BA015E7A63A403E22FB5DA641D6116B8945ADF0DC5AADC86370E4A7CBE65208FFDB4F84A806FEB290E72D671D58FD7635CF86DE5ABA024DDFC84E7B28456E20D73B8F7BAA1C868E1F6EF3F1B592392E0B364BE3400786CCD9D7955EFD970732B22375C246CFB419D3E5684A1BC926E9787A4027690919793794D2501052D017143495443312BA12AC75B2992A76A165E38D008CF38BFF491FA383D384BC4FFC7DD274ED904A68DBD4B23CD4F1C78238BBC429C420AA0AA3A3B3AAA3C41E75125987CEDC5741DB76E95C5D2BB2F62AD79F97CC2EB7A6130EF6A1264B1E8270E22AA6EAE72B4EDCAC0422E40402D67ECF5445585462D49B70F47725E2CC7857055487675062C343A2463E3C26042C1F74DC57B5D40F043F960</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B4 8B 0C 00 58 C2 AF 66
0010 | 78 01 00 00 1F 5F 04 F5 11 B9 C2 84 50 81 17 76
0020 | D4 24 CA 45 CD D0 38 74 46 0A 42 F7 E8 9B 5F 4E
0030 | 9B 13 1B 62 6D CD 43 14 FE 50 01 00 C9 B1 B0 55
0040 | 0B C9 E6 8C D8 11 FC FB A5 55 E4 C4 57 34 2D F4
0050 | F8 1D 14 F1 C8 DD 83 85 AE 71 AB 27 25 94 17 31
0060 | 39 DA 63 7A E6 0E 83 4F 45 ED 18 C8 B1 26 9B 81
0070 | 38 7A 22 F1 BA 01 5E 7A 63 A4 03 E2 2F B5 DA 64
0080 | 1D 61 16 B8 94 5A DF 0D C5 AA DC 86 37 0E 4A 7C
0090 | BE 65 20 8F FD B4 F8 4A 80 6F EB 29 0E 72 D6 71
00A0 | D5 8F D7 63 5C F8 6D E5 AB A0 24 DD FC 84 E7 B2
00B0 | 84 56 E2 0D 73 B8 F7 BA A1 C8 68 E1 F6 EF 3F 1B
00C0 | 59 23 92 E0 B3 64 BE 34 00 78 6C CD 9D 79 55 EF
00D0 | D9 70 73 2B 22 37 5C 24 6C FB 41 9D 3E 56 84 A1
00E0 | BC 92 6E 97 87 A4 02 76 90 91 97 93 79 4D 25 01
00F0 | 05 2D 01 71 43 49 54 43 31 2B A1 2A C7 5B 29 92
0100 | A7 6A 16 5E 38 D0 08 CF 38 BF F4 91 FA 38 3D 38
0110 | 4B C4 FF C7 DD 27 4E D9 04 A6 8D BD 4B 23 CD 4F
0120 | 1C 78 23 8B BC 42 9C 42 0A A0 AA 3A 3B 3A AA 3C
0130 | 41 E7 51 25 98 7C ED C5 74 1D B7 6E 95 C5 D2 BB
0140 | 2F 62 AD 79 F9 7C C2 EB 7A 61 30 EF 6A 12 64 B1
0150 | E8 27 0E 22 AA 6E AE 72 B4 ED CA C0 42 2E 40 40
0160 | 2D 67 EC F5 44 55 85 46 2D 49 B7 0F 47 72 5E 2C
0170 | C7 85 70 55 48 76 75 06 2C 34 3A 24 63 E3 C2 60
0180 | 42 C1 F7 4D C5 7B 5D 40 F0 43 F9 60</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B48B0C0058C2AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C9B1B0550BC9E68CD811FCFB</code> <code>A555E4C457342DF4F81D14F1C8DD8385</code> <code>AE71AB272594173139DA637AE60E834F</code> <code>45ED18C8B1269B81387A22F1BA015E7A</code> <code>63A403E22FB5DA641D6116B8945ADF0D</code> <code>C5AADC86370E4A7CBE65208FFDB4F84A</code> <code>806FEB290E72D671D58FD7635CF86DE5</code> <code>ABA024DDFC84E7B28456E20D73B8F7BA</code> <code>A1C868E1F6EF3F1B592392E0B364BE34</code> <code>00786CCD9D7955EFD970732B22375C24</code> <code>6CFB419D3E5684A1BC926E9787A40276</code> <code>90919793794D2501052D017143495443</code> <code>312BA12AC75B2992A76A165E38D008CF</code> <code>38BFF491FA383D384BC4FFC7DD274ED9</code> <code>04A68DBD4B23CD4F1C78238BBC429C42</code> <code>0AA0AA3A3B3AAA3C41E75125987CEDC5</code> <code>741DB76E95C5D2BB2F62AD79F97CC2EB</code> <code>7A6130EF6A1264B1E8270E22AA6EAE72</code> <code>B4EDCAC0422E40402D67ECF544558546</code> <code>2D49B70F47725E2CC785705548767506</code> <code>2C343A2463E3C26042C1F74DC57B5D40</code><br> <code>F043F960</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 1CFDBEA303AB6C8180759A13C41F300315A8B30C8558D9A6CB96E872015B01295F19FF164E3DA25D813B88A0C80C8171E69FEA06863BEE5BFA2096ABB411BF845D3BF4BF73C8F5387C73ADC8D5123F5182F578ACA9CA0A86D1A133287AF40EFF2EC0D1BC0A376ADA222888D5D6AAF870FDE65849D0FFC13336E43DF1194F62D6BBAA5361AB85B3DDC04EE6E63C33954E5A39B1A550FD1E747E11DCB4C54CE074395BDA6FF5882DE6E367DFC851FC5721B64E8BC0B0BE2951B7FB32A0EC3A2D91832688E913C8EDA1F3788918426A46CD3AEA2347AE9CEA089BFBA4E7FEF56FB09FD99CB8298BDEDC8193E446E9900C6CC0D13D4561A03BB2F3777C6F38C7E9AF</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 78 4C 3A 59 C2 AF 66
0010 | A8 00 00 00 34 F7 CB 3B 11 B9 C2 84 50 81 17 76
0020 | D4 24 CA 45 CD D0 38 74 46 0A 42 F7 E8 9B 5F 4E
0030 | 9B 13 1B 62 6D CD 43 14 DC F6 6C 4B A4 7E E9 B6
0040 | 19 A1 0F 79 1C 39 C8 E0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01784C3A59C2AF66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8000000</code> (168 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>11B9C28450811776D424CA45CDD03874</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>460A42F7E89B5F4E9B131B626DCD4314</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>DCF66C4BA47EE9B619A10F791C39C8E0</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

