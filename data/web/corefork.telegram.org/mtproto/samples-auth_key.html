<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 60 8D 08 00 B3 CB 96 66
0010 | 14 00 00 00 F1 8E 7E BE 4D 1C B7 28 44 DE 76 80
0020 | 1B C0 99 E2 67 2E CB A5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>608D0800B3CB9666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 4C 1B 4B B3 CB 96 66
0010 | 78 00 00 00 63 24 16 05 4D 1C B7 28 44 DE 76 80
0020 | 1B C0 99 E2 67 2E CB A5 4D 35 E8 A8 DE AA 39 AA
0030 | 5D F2 BF 85 78 8B 77 25 08 16 31 F9 E6 DF 5F 7C
0040 | B3 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014C1B4BB3CB9666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78000000</code> (120 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081631F9E6DF5F7CB3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1599334112678608051</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1599334112678608051</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1599334112678608051 = 1022618293 * 1563960007</code></p>
<pre><code>p = 1022618293
q = 1563960007</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 31 F9 E6 DF 5F 7C B3 00 00 00
0010 | 04 3C F3 EA B5 00 00 00 04 5D 38 22 C7 00 00 00
0020 | 4D 1C B7 28 44 DE 76 80 1B C0 99 E2 67 2E CB A5
0030 | 4D 35 E8 A8 DE AA 39 AA 5D F2 BF 85 78 8B 77 25
0040 | CE D7 B5 85 FF 04 84 46 48 7D 82 84 13 B6 23 C0
0050 | 0B 0F 48 1A D6 EA 0A 3F D9 59 86 BC D1 6F B5 28
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081631F9E6DF5F7CB3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1599334112678608051</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043CF3EAB5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1022618293</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045D3822C7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1563960007</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>CED7B585FF048446487D828413B623C0</code> <code>0B0F481AD6EA0A3FD95986BCD16FB528</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081631F9E6DF5F7CB3000000043CF3EAB5000000045D3822C70000004D1CB72844DE76801BC099E2672ECBA54D35E8A8DEAA39AA5DF2BF85788B7725CED7B585FF048446487D828413B623C00B0F481AD6EA0A3FD95986BCD16FB52802000000
random_padding_bytes = 5F30124D2F41E7C46C7161F32E28E709051744E278E304A58410ED4F71ED12C229BBAF08CCAEAAC1BC74879293FEC0336B4388454627357966ED32EA1A2CD1AF549652FAF720EC46510DEE64886AD8B2A15307226E12A69E27350DF0</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 6847B76DE5E9C45E0C06C0990EA19274109FB5709139AF1C32B6483F79003FF0C168D76DD812B5D18950A88B859F2325EF639B32DECA05BA81AFA38A4E0C5CBFF599C1EBE9842BFAD83F46A3BB054EEE99EF5B757159759BF9EBC72B125FE56D03F8300D7A30A6A6793536589E564FB9CCDBB3DF83EA7425432482AC35AB22AD4971A597E2959B2D998DC55B1F287D8378EB9DE6A33923C5477F9F74BC7D43C479540BE9E0551D9BB22AB5D0136CC96999624B03A0A0AF9B224AE60892EB1A33FE08E2CECAC96EF64DFA952ECF83134C4E712561FC4FFA31AF28D30A4DFC82F7B8681DDE83D292F678DD617595232B60CD9A8B73A04ACB55916AFFC80515DCFE</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 64 8D 08 00 B3 CB 96 66
0010 | 40 01 00 00 BE E4 12 D7 4D 1C B7 28 44 DE 76 80
0020 | 1B C0 99 E2 67 2E CB A5 4D 35 E8 A8 DE AA 39 AA
0030 | 5D F2 BF 85 78 8B 77 25 04 3C F3 EA B5 00 00 00
0040 | 04 5D 38 22 C7 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 68 47 B7 6D E5 E9 C4 5E 0C 06 C0 99
0060 | 0E A1 92 74 10 9F B5 70 91 39 AF 1C 32 B6 48 3F
0070 | 79 00 3F F0 C1 68 D7 6D D8 12 B5 D1 89 50 A8 8B
0080 | 85 9F 23 25 EF 63 9B 32 DE CA 05 BA 81 AF A3 8A
0090 | 4E 0C 5C BF F5 99 C1 EB E9 84 2B FA D8 3F 46 A3
00A0 | BB 05 4E EE 99 EF 5B 75 71 59 75 9B F9 EB C7 2B
00B0 | 12 5F E5 6D 03 F8 30 0D 7A 30 A6 A6 79 35 36 58
00C0 | 9E 56 4F B9 CC DB B3 DF 83 EA 74 25 43 24 82 AC
00D0 | 35 AB 22 AD 49 71 A5 97 E2 95 9B 2D 99 8D C5 5B
00E0 | 1F 28 7D 83 78 EB 9D E6 A3 39 23 C5 47 7F 9F 74
00F0 | BC 7D 43 C4 79 54 0B E9 E0 55 1D 9B B2 2A B5 D0
0100 | 13 6C C9 69 99 62 4B 03 A0 A0 AF 9B 22 4A E6 08
0110 | 92 EB 1A 33 FE 08 E2 CE CA C9 6E F6 4D FA 95 2E
0120 | CF 83 13 4C 4E 71 25 61 FC 4F FA 31 AF 28 D3 0A
0130 | 4D FC 82 F7 B8 68 1D DE 83 D2 92 F6 78 DD 61 75
0140 | 95 23 2B 60 CD 9A 8B 73 A0 4A CB 55 91 6A FF C8
0150 | 05 15 DC FE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>648D0800B3CB9666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043CF3EAB5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1022618293</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045D3822C7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1563960007</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001006847B76DE5E9C45E0C06C099</code> <code>0EA19274109FB5709139AF1C32B6483F</code> <code>79003FF0C168D76DD812B5D18950A88B</code> <code>859F2325EF639B32DECA05BA81AFA38A</code> <code>4E0C5CBFF599C1EBE9842BFAD83F46A3</code> <code>BB054EEE99EF5B757159759BF9EBC72B</code> <code>125FE56D03F8300D7A30A6A679353658</code> <code>9E564FB9CCDBB3DF83EA7425432482AC</code> <code>35AB22AD4971A597E2959B2D998DC55B</code> <code>1F287D8378EB9DE6A33923C5477F9F74</code> <code>BC7D43C479540BE9E0551D9BB22AB5D0</code> <code>136CC96999624B03A0A0AF9B224AE608</code> <code>92EB1A33FE08E2CECAC96EF64DFA952E</code> <code>CF83134C4E712561FC4FFA31AF28D30A</code> <code>4DFC82F7B8681DDE83D292F678DD6175</code> <code>95232B60CD9A8B73A04ACB55916AFFC8</code><br> <code>0515DCFE</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 69 1A B4 CB 96 66
0010 | F4 02 00 00 5C 07 E8 D0 4D 1C B7 28 44 DE 76 80
0020 | 1B C0 99 E2 67 2E CB A5 4D 35 E8 A8 DE AA 39 AA
0030 | 5D F2 BF 85 78 8B 77 25 FE 50 02 00 48 6F 87 03
0040 | A0 32 C3 10 0A 5B A2 54 34 8B D8 EC 52 84 B2 ED
0050 | 9A D7 A8 AF FC 8F 19 2F DA 7A ED 00 F8 C5 CB D7
0060 | 59 F3 5B 45 C9 37 0E A2 7E 8B 1B 83 B6 AA 60 53
0070 | 6D FB B8 58 A4 04 C9 61 BE F1 0D 70 C2 A3 D0 8A
0080 | 19 7C 3A 2C F8 A0 7D 71 26 D9 BE 10 C6 F4 F4 8E
0090 | 86 12 93 E1 D4 1C 08 B1 4D CA 4A 29 94 29 7A 7C
00A0 | 40 E9 DA 11 A4 45 CC 85 C5 DF 1C 6B 01 5F 8D 19
00B0 | 8A B0 80 F2 AD AB 74 E2 74 BF 81 CB 7A E1 41 58
00C0 | 4A 04 31 BC E3 25 8B 2D 53 D4 4F 5B 85 36 B2 D7
00D0 | 35 ED 45 2D F2 41 A1 24 04 3E BB 73 9B A4 3B 60
00E0 | 3F 17 35 97 4C 07 66 C7 23 ED AC B7 F4 0A 3B 8C
00F0 | 07 56 B0 54 41 0E AD 94 C3 97 78 E1 B4 AD 06 E1
0100 | F7 B6 39 99 F8 4A F4 4A 12 1E 4B 3D 24 FB D2 4A
0110 | 55 5F 62 D2 D5 2D 6B D9 D9 36 97 1D F3 31 75 6C
0120 | 22 34 88 97 01 8B 35 4B A5 1B 4D AF 23 74 E3 48
0130 | 3B 0B F1 52 88 E8 59 7E A1 FA 20 DC 6B A2 03 E0
0140 | 02 FF C3 31 EA 1C BE 17 E3 D8 B8 9D C0 3C 48 3C
0150 | A9 A8 61 1C 01 CF F5 AE B9 2C 4E B6 3A 37 FE 72
0160 | 87 52 BB F9 6B 7E 72 89 F4 00 8D 65 FB 7B 6D E1
0170 | 4D EF 6A 7B AF 3A 2B 01 B1 90 1B C8 DB 2F 33 F8
0180 | 0F 68 97 63 BD BA D8 2E 86 61 03 46 CF 7E 59 94
0190 | B1 22 82 DE 28 74 7E 3C AC 30 5B A3 1A CA 83 8C
01A0 | E5 4E 71 41 7F 99 BC E8 47 65 E1 49 AB BC 30 8E
01B0 | ED C9 73 3A 27 89 EE D8 45 E1 70 A3 CD DF F9 4D
01C0 | 87 16 8C F8 D8 33 B3 0A D1 6A 68 67 F6 CB DB CA
01D0 | 91 A5 3F 08 79 02 FB CD B2 79 AA 16 F1 32 CC E2
01E0 | 6A 9C 1B 09 BB EC 85 DE 47 A4 EA 2F DE 3F 2B 77
01F0 | 97 80 23 A9 78 93 38 E7 61 83 6D DF 55 77 33 E9
0200 | 20 29 BE F2 42 88 76 F0 D2 C5 D4 66 3C 41 D8 3A
0210 | 02 7D F1 A3 FB BF 9F 7B 68 1F BE 00 9A 83 98 B8
0220 | 36 4F 11 B8 7B A6 5C CB B9 C1 F3 43 31 E1 CC 43
0230 | 00 A3 A5 0F CC 4B 7C 6F 32 62 3B 15 F0 F0 34 9C
0240 | EC E3 83 1C DE C2 CB F1 A5 8D 1D 7F 4E 9A FD 6E
0250 | B4 AD 05 42 09 DD DE FF 7E C0 78 C4 5D 77 28 C5
0260 | 3F 47 44 2C EA 7A 25 16 D2 F4 8E 35 B4 B7 C1 B3
0270 | 15 34 32 21 21 DB 0C 06 7C E8 AB 04 3A 7D EB 35
0280 | 17 1B B2 8D 41 A1 70 C1 45 91 A2 5C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130691AB4CB9666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>F4020000</code> (756 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200486F8703A032C3100A5BA254</code> <code>348BD8EC5284B2ED9AD7A8AFFC8F192F</code> <code>DA7AED00F8C5CBD759F35B45C9370EA2</code> <code>7E8B1B83B6AA60536DFBB858A404C961</code> <code>BEF10D70C2A3D08A197C3A2CF8A07D71</code> <code>26D9BE10C6F4F48E861293E1D41C08B1</code> <code>4DCA4A2994297A7C40E9DA11A445CC85</code> <code>C5DF1C6B015F8D198AB080F2ADAB74E2</code> <code>74BF81CB7AE141584A0431BCE3258B2D</code> <code>53D44F5B8536B2D735ED452DF241A124</code> <code>043EBB739BA43B603F1735974C0766C7</code> <code>23EDACB7F40A3B8C0756B054410EAD94</code> <code>C39778E1B4AD06E1F7B63999F84AF44A</code> <code>121E4B3D24FBD24A555F62D2D52D6BD9</code> <code>D936971DF331756C22348897018B354B</code> <code>A51B4DAF2374E3483B0BF15288E8597E</code> <code>A1FA20DC6BA203E002FFC331EA1CBE17</code> <code>E3D8B89DC03C483CA9A8611C01CFF5AE</code> <code>B92C4EB63A37FE728752BBF96B7E7289</code> <code>F4008D65FB7B6DE14DEF6A7BAF3A2B01</code> <code>B1901BC8DB2F33F80F689763BDBAD82E</code> <code>86610346CF7E5994B12282DE28747E3C</code> <code>AC305BA31ACA838CE54E71417F99BCE8</code> <code>4765E149ABBC308EEDC9733A2789EED8</code> <code>45E170A3CDDFF94D87168CF8D833B30A</code> <code>D16A6867F6CBDBCA91A53F087902FBCD</code> <code>B279AA16F132CCE26A9C1B09BBEC85DE</code> <code>47A4EA2FDE3F2B77978023A9789338E7</code> <code>61836DDF557733E92029BEF2428876F0</code> <code>D2C5D4663C41D83A027DF1A3FBBF9F7B</code> <code>681FBE009A8398B8364F11B87BA65CCB</code> <code>B9C1F34331E1CC4300A3A50FCC4B7C6F</code> <code>32623B15F0F0349CECE3831CDEC2CBF1</code> <code>A58D1D7F4E9AFD6EB4AD054209DDDEFF</code> <code>7EC078C45D7728C53F47442CEA7A2516</code> <code>D2F48E35B4B7C1B31534322121DB0C06</code> <code>7CE8AB043A7DEB35171BB28D41A170C1</code><br> <code>4591A25C</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 486F8703A032C3100A5BA254348BD8EC5284B2ED9AD7A8AFFC8F192FDA7AED00F8C5CBD759F35B45C9370EA27E8B1B83B6AA60536DFBB858A404C961BEF10D70C2A3D08A197C3A2CF8A07D7126D9BE10C6F4F48E861293E1D41C08B14DCA4A2994297A7C40E9DA11A445CC85C5DF1C6B015F8D198AB080F2ADAB74E274BF81CB7AE141584A0431BCE3258B2D53D44F5B8536B2D735ED452DF241A124043EBB739BA43B603F1735974C0766C723EDACB7F40A3B8C0756B054410EAD94C39778E1B4AD06E1F7B63999F84AF44A121E4B3D24FBD24A555F62D2D52D6BD9D936971DF331756C22348897018B354BA51B4DAF2374E3483B0BF15288E8597EA1FA20DC6BA203E002FFC331EA1CBE17E3D8B89DC03C483CA9A8611C01CFF5AEB92C4EB63A37FE728752BBF96B7E7289F4008D65FB7B6DE14DEF6A7BAF3A2B01B1901BC8DB2F33F80F689763BDBAD82E86610346CF7E5994B12282DE28747E3CAC305BA31ACA838CE54E71417F99BCE84765E149ABBC308EEDC9733A2789EED845E170A3CDDFF94D87168CF8D833B30AD16A6867F6CBDBCA91A53F087902FBCDB279AA16F132CCE26A9C1B09BBEC85DE47A4EA2FDE3F2B77978023A9789338E761836DDF557733E92029BEF2428876F0D2C5D4663C41D83A027DF1A3FBBF9F7B681FBE009A8398B8364F11B87BA65CCBB9C1F34331E1CC4300A3A50FCC4B7C6F32623B15F0F0349CECE3831CDEC2CBF1A58D1D7F4E9AFD6EB4AD054209DDDEFF7EC078C45D7728C53F47442CEA7A2516D2F48E35B4B7C1B31534322121DB0C067CE8AB043A7DEB35171BB28D41A170C14591A25C
tmp_aes_key = 4CC52DE314BD7B61B14811DD6F9DF2EF72E5D49D5AD7784699D9C8E9FB1F8990
tmp_aes_iv = 3DED1375676C6DA8205E6FCEBECF7DEB6D7B2DD03B09B98FBE93A8DBCED7B585</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 7B402FAF7E1AEECF9A5287CC65BC1B84A7DA41AEBA0D89B54D1CB72844DE76801BC099E2672ECBA54D35E8A8DEAA39AA5DF2BF85788B772503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010055B0ED467C121A0D726EFC61C454477E0984C1D323F605C11353171C5EE9807B6864C00B357E978882EF6FF6BFD6077152634FB8AF006D84663A887EDFCEEFAA47406298E5BC9A9FB07D395F4C396ECD3558283D36E850263E20D22F01497BE254D797D4C4AA681BC1A3C02A5A11829894B7F6B483735B190C2C4275BE90DAE197D8A603D1701E4100D3FABA109DC1255110EB4A1E8E21B26288A1DD07233423FF084F20100550EA018A65673FF3F5DE9E34055546A783EF8682D461C936BB4231F1812AB5E1D16FECA59C4EA2816AC08A67AEE95D9BE4E6485C5C9D038BC6FDD65807B20CD0A4E75FAF6327035A8E50781CBB1CC2050F888FDB14A7B1330F2BB4CB96664859722E5A280B1F
answer = BA0D89B54D1CB72844DE76801BC099E2672ECBA54D35E8A8DEAA39AA5DF2BF85788B772503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010055B0ED467C121A0D726EFC61C454477E0984C1D323F605C11353171C5EE9807B6864C00B357E978882EF6FF6BFD6077152634FB8AF006D84663A887EDFCEEFAA47406298E5BC9A9FB07D395F4C396ECD3558283D36E850263E20D22F01497BE254D797D4C4AA681BC1A3C02A5A11829894B7F6B483735B190C2C4275BE90DAE197D8A603D1701E4100D3FABA109DC1255110EB4A1E8E21B26288A1DD07233423FF084F20100550EA018A65673FF3F5DE9E34055546A783EF8682D461C936BB4231F1812AB5E1D16FECA59C4EA2816AC08A67AEE95D9BE4E6485C5C9D038BC6FDD65807B20CD0A4E75FAF6327035A8E50781CBB1CC2050F888FDB14A7B1330F2BB4CB96664859722E5A280B1F</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 4D 1C B7 28 44 DE 76 80 1B C0 99 E2
0010 | 67 2E CB A5 4D 35 E8 A8 DE AA 39 AA 5D F2 BF 85
0020 | 78 8B 77 25 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 55 B0 ED 46 7C 12 1A 0D 72 6E FC 61 C4 54 47 7E
0140 | 09 84 C1 D3 23 F6 05 C1 13 53 17 1C 5E E9 80 7B
0150 | 68 64 C0 0B 35 7E 97 88 82 EF 6F F6 BF D6 07 71
0160 | 52 63 4F B8 AF 00 6D 84 66 3A 88 7E DF CE EF AA
0170 | 47 40 62 98 E5 BC 9A 9F B0 7D 39 5F 4C 39 6E CD
0180 | 35 58 28 3D 36 E8 50 26 3E 20 D2 2F 01 49 7B E2
0190 | 54 D7 97 D4 C4 AA 68 1B C1 A3 C0 2A 5A 11 82 98
01A0 | 94 B7 F6 B4 83 73 5B 19 0C 2C 42 75 BE 90 DA E1
01B0 | 97 D8 A6 03 D1 70 1E 41 00 D3 FA BA 10 9D C1 25
01C0 | 51 10 EB 4A 1E 8E 21 B2 62 88 A1 DD 07 23 34 23
01D0 | FF 08 4F 20 10 05 50 EA 01 8A 65 67 3F F3 F5 DE
01E0 | 9E 34 05 55 46 A7 83 EF 86 82 D4 61 C9 36 BB 42
01F0 | 31 F1 81 2A B5 E1 D1 6F EC A5 9C 4E A2 81 6A C0
0200 | 8A 67 AE E9 5D 9B E4 E6 48 5C 5C 9D 03 8B C6 FD
0210 | D6 58 07 B2 0C D0 A4 E7 5F AF 63 27 03 5A 8E 50
0220 | 78 1C BB 1C C2 05 0F 88 8F DB 14 A7 B1 33 0F 2B
0230 | B4 CB 96 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010055B0ED467C121A0D726EFC61</code> <code>C454477E0984C1D323F605C11353171C</code> <code>5EE9807B6864C00B357E978882EF6FF6</code> <code>BFD6077152634FB8AF006D84663A887E</code> <code>DFCEEFAA47406298E5BC9A9FB07D395F</code> <code>4C396ECD3558283D36E850263E20D22F</code> <code>01497BE254D797D4C4AA681BC1A3C02A</code> <code>5A11829894B7F6B483735B190C2C4275</code> <code>BE90DAE197D8A603D1701E4100D3FABA</code> <code>109DC1255110EB4A1E8E21B26288A1DD</code> <code>07233423FF084F20100550EA018A6567</code> <code>3FF3F5DE9E34055546A783EF8682D461</code> <code>C936BB4231F1812AB5E1D16FECA59C4E</code> <code>A2816AC08A67AEE95D9BE4E6485C5C9D</code> <code>038BC6FDD65807B20CD0A4E75FAF6327</code> <code>035A8E50781CBB1CC2050F888FDB14A7</code><br> <code>B1330F2B</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B4CB9666</code> (1721158580 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 9D9E5FB92641D721433BD29AAE9B5F14D25CA024CE8790EC861B950D00A074F7A15853962033D53372A32A8BD7E4D66DE9576AE307175CA92ED926D4396CCC47F907F9A0AE666B1AEC45F520B456861319BF421DBE0C8316DEB4AD59E81D757B1D17333301C9649E4ABDDC12C1EE1262ED303C30CFB5B79479BCFB8AAE8C0C8F3A52A48DFC73D8C71E8D9A92843A819101065F34A70F5896DA7F20F73A20CA2AF1A13C01A1E3901D854424ADA3E2EFF1127D20C2A4F288CE5D7DB951B36A343C72087A75F1B8C24D38ACB8626BD4BDFC1CDCC642D5C69E14CE894F508DC486C175641F5C25F28315F7092E1601EF23BA07D78E1F47FD3EB6C3B575A14EF1EDDF</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 566EC30E615B0E69FD8048389CCC35B3F54345E2460A10AD2F72343663DAF713BBE95A2AF675E7D9FDBB5AEEAF38F8E40832CC976D535088591565CCCE85FD0A480351AE067A35055AA6EF7057E0BE6F52A86A2ADED66D2B77726E9517085C5A2C69A33FC1146E984841A0E21EDACDEBAECCAEE630AECC35184DB416026DFFA64AF738408434B9699F6F407A2A61E6279835DB556C5BDE9FBE64DC00273523594C915BA41F5B7C7329D023FDA8DA685533416C386AD888BB2482290453FABE78928843BCB5DF960B12124750AFB07276CF93A6518FF9B7DB436E596D7E7A45FEB22F3061A2C779876094E4D2748BE38CD85F511B37ABC8DAAB2F2C692A66D868</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 4D 1C B7 28 44 DE 76 80 1B C0 99 E2
0010 | 67 2E CB A5 4D 35 E8 A8 DE AA 39 AA 5D F2 BF 85
0020 | 78 8B 77 25 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 56 6E C3 0E 61 5B 0E 69 FD 80 48 38 9C CC 35 B3
0040 | F5 43 45 E2 46 0A 10 AD 2F 72 34 36 63 DA F7 13
0050 | BB E9 5A 2A F6 75 E7 D9 FD BB 5A EE AF 38 F8 E4
0060 | 08 32 CC 97 6D 53 50 88 59 15 65 CC CE 85 FD 0A
0070 | 48 03 51 AE 06 7A 35 05 5A A6 EF 70 57 E0 BE 6F
0080 | 52 A8 6A 2A DE D6 6D 2B 77 72 6E 95 17 08 5C 5A
0090 | 2C 69 A3 3F C1 14 6E 98 48 41 A0 E2 1E DA CD EB
00A0 | AE CC AE E6 30 AE CC 35 18 4D B4 16 02 6D FF A6
00B0 | 4A F7 38 40 84 34 B9 69 9F 6F 40 7A 2A 61 E6 27
00C0 | 98 35 DB 55 6C 5B DE 9F BE 64 DC 00 27 35 23 59
00D0 | 4C 91 5B A4 1F 5B 7C 73 29 D0 23 FD A8 DA 68 55
00E0 | 33 41 6C 38 6A D8 88 BB 24 82 29 04 53 FA BE 78
00F0 | 92 88 43 BC B5 DF 96 0B 12 12 47 50 AF B0 72 76
0100 | CF 93 A6 51 8F F9 B7 DB 43 6E 59 6D 7E 7A 45 FE
0110 | B2 2F 30 61 A2 C7 79 87 60 94 E4 D2 74 8B E3 8C
0120 | D8 5F 51 1B 37 AB C8 DA AB 2F 2C 69 2A 66 D8 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100566EC30E615B0E69FD804838</code> <code>9CCC35B3F54345E2460A10AD2F723436</code> <code>63DAF713BBE95A2AF675E7D9FDBB5AEE</code> <code>AF38F8E40832CC976D535088591565CC</code> <code>CE85FD0A480351AE067A35055AA6EF70</code> <code>57E0BE6F52A86A2ADED66D2B77726E95</code> <code>17085C5A2C69A33FC1146E984841A0E2</code> <code>1EDACDEBAECCAEE630AECC35184DB416</code> <code>026DFFA64AF738408434B9699F6F407A</code> <code>2A61E6279835DB556C5BDE9FBE64DC00</code> <code>273523594C915BA41F5B7C7329D023FD</code> <code>A8DA685533416C386AD888BB24822904</code> <code>53FABE78928843BCB5DF960B12124750</code> <code>AFB07276CF93A6518FF9B7DB436E596D</code> <code>7E7A45FEB22F3061A2C779876094E4D2</code> <code>748BE38CD85F511B37ABC8DAAB2F2C69</code><br> <code>2A66D868</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643664D1CB72844DE76801BC099E2672ECBA54D35E8A8DEAA39AA5DF2BF85788B77250000000000000000FE000100566EC30E615B0E69FD8048389CCC35B3F54345E2460A10AD2F72343663DAF713BBE95A2AF675E7D9FDBB5AEEAF38F8E40832CC976D535088591565CCCE85FD0A480351AE067A35055AA6EF7057E0BE6F52A86A2ADED66D2B77726E9517085C5A2C69A33FC1146E984841A0E21EDACDEBAECCAEE630AECC35184DB416026DFFA64AF738408434B9699F6F407A2A61E6279835DB556C5BDE9FBE64DC00273523594C915BA41F5B7C7329D023FDA8DA685533416C386AD888BB2482290453FABE78928843BCB5DF960B12124750AFB07276CF93A6518FF9B7DB436E596D7E7A45FEB22F3061A2C779876094E4D2748BE38CD85F511B37ABC8DAAB2F2C692A66D868
padding = D2067C5471AC206EB5351854
tmp_aes_key = 4CC52DE314BD7B61B14811DD6F9DF2EF72E5D49D5AD7784699D9C8E9FB1F8990
tmp_aes_iv = 3DED1375676C6DA8205E6FCEBECF7DEB6D7B2DD03B09B98FBE93A8DBCED7B585</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 55ADF2FDB57DA8CC4265076496A4EBEF499E672E3174C2E99D046EA8BA4BE8D8D398BCFDB17C1215AE22821DFFEB856D0FDE45AF22341F94C6F90058D77BE34FEC35EE47A78A0CF3D319BA5DA3DA63FCC5F85DC936DD3F64A89CA0274073B0D778C7B070339215540987C6D09B9B0C570BC8CE1825DC43D1D7FE0AE5B46C26F6C2B7534C4A6BEDDA38BBF25C6F725DDD370CE990C293A25246B8BD7F39B2558D7E462A55916C360016DCB589C9663C075F590CCDFBA961BBBEC51707254A103522BCE229148EA50E1BB3BBF542A3447059AC775BD42FFB7636C215F44E40226D633D509ACBC2EED24D42201DE5A7A48B15D7DE88BC537D4FE0028DFE9B523B47AD14FFA21E32BB0FEE7936301B2A189239B28B695F72327FBCBAF13196B62008B6B8BD19DDADE8AAD477018F0F3B7F8635B0006640E1D67E6323E0E0CD0C958026E7E9BE9F855CD6ED13080D27D0021E</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 10 73 07 00 B4 CB 96 66
0010 | 78 01 00 00 1F 5F 04 F5 4D 1C B7 28 44 DE 76 80
0020 | 1B C0 99 E2 67 2E CB A5 4D 35 E8 A8 DE AA 39 AA
0030 | 5D F2 BF 85 78 8B 77 25 FE 50 01 00 55 AD F2 FD
0040 | B5 7D A8 CC 42 65 07 64 96 A4 EB EF 49 9E 67 2E
0050 | 31 74 C2 E9 9D 04 6E A8 BA 4B E8 D8 D3 98 BC FD
0060 | B1 7C 12 15 AE 22 82 1D FF EB 85 6D 0F DE 45 AF
0070 | 22 34 1F 94 C6 F9 00 58 D7 7B E3 4F EC 35 EE 47
0080 | A7 8A 0C F3 D3 19 BA 5D A3 DA 63 FC C5 F8 5D C9
0090 | 36 DD 3F 64 A8 9C A0 27 40 73 B0 D7 78 C7 B0 70
00A0 | 33 92 15 54 09 87 C6 D0 9B 9B 0C 57 0B C8 CE 18
00B0 | 25 DC 43 D1 D7 FE 0A E5 B4 6C 26 F6 C2 B7 53 4C
00C0 | 4A 6B ED DA 38 BB F2 5C 6F 72 5D DD 37 0C E9 90
00D0 | C2 93 A2 52 46 B8 BD 7F 39 B2 55 8D 7E 46 2A 55
00E0 | 91 6C 36 00 16 DC B5 89 C9 66 3C 07 5F 59 0C CD
00F0 | FB A9 61 BB BE C5 17 07 25 4A 10 35 22 BC E2 29
0100 | 14 8E A5 0E 1B B3 BB F5 42 A3 44 70 59 AC 77 5B
0110 | D4 2F FB 76 36 C2 15 F4 4E 40 22 6D 63 3D 50 9A
0120 | CB C2 EE D2 4D 42 20 1D E5 A7 A4 8B 15 D7 DE 88
0130 | BC 53 7D 4F E0 02 8D FE 9B 52 3B 47 AD 14 FF A2
0140 | 1E 32 BB 0F EE 79 36 30 1B 2A 18 92 39 B2 8B 69
0150 | 5F 72 32 7F BC BA F1 31 96 B6 20 08 B6 B8 BD 19
0160 | DD AD E8 AA D4 77 01 8F 0F 3B 7F 86 35 B0 00 66
0170 | 40 E1 D6 7E 63 23 E0 E0 CD 0C 95 80 26 E7 E9 BE
0180 | 9F 85 5C D6 ED 13 08 0D 27 D0 02 1E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>10730700B4CB9666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010055ADF2FDB57DA8CC42650764</code> <code>96A4EBEF499E672E3174C2E99D046EA8</code> <code>BA4BE8D8D398BCFDB17C1215AE22821D</code> <code>FFEB856D0FDE45AF22341F94C6F90058</code> <code>D77BE34FEC35EE47A78A0CF3D319BA5D</code> <code>A3DA63FCC5F85DC936DD3F64A89CA027</code> <code>4073B0D778C7B070339215540987C6D0</code> <code>9B9B0C570BC8CE1825DC43D1D7FE0AE5</code> <code>B46C26F6C2B7534C4A6BEDDA38BBF25C</code> <code>6F725DDD370CE990C293A25246B8BD7F</code> <code>39B2558D7E462A55916C360016DCB589</code> <code>C9663C075F590CCDFBA961BBBEC51707</code> <code>254A103522BCE229148EA50E1BB3BBF5</code> <code>42A3447059AC775BD42FFB7636C215F4</code> <code>4E40226D633D509ACBC2EED24D42201D</code> <code>E5A7A48B15D7DE88BC537D4FE0028DFE</code> <code>9B523B47AD14FFA21E32BB0FEE793630</code> <code>1B2A189239B28B695F72327FBCBAF131</code> <code>96B62008B6B8BD19DDADE8AAD477018F</code> <code>0F3B7F8635B0006640E1D67E6323E0E0</code> <code>CD0C958026E7E9BE9F855CD6ED13080D</code><br> <code>27D0021E</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = C13035258A69C36CCEAC7E92D76A44961467D812AA48518CDDAB99630402A6B17698311F3A2ABA8EE375333BA68F5EAD82754417C14811B2067A3FF55D4AA7C0390F8688DE3A7969970517AF6100CA4734347B5E82BF144436A711CC449E8B3D52BCD881283354EAFC4BBE97EAD7D9551AD8C2E50D7617F4A15AF2C6C8916B43AC95F72DF8944CE558211DE8803699E0EDA882523C92523651C036C9C56E244DC5FA6C2F4FFC5C00A58684782F02395711EC32EB3F319896AC33CA6990FCAD782C9BD187E407B0467CBDBC98445B1D95CBD5F9B5A5D1DB58E350318284D7E538C4CEF5207A6D9967A11C5DF2EF802CA5E6994FB5A29C89C68FA806390BB3BCE5</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 68 E3 25 B5 CB 96 66
0010 | 88 00 00 00 34 F7 CB 3B 4D 1C B7 28 44 DE 76 80
0020 | 1B C0 99 E2 67 2E CB A5 4D 35 E8 A8 DE AA 39 AA
0030 | 5D F2 BF 85 78 8B 77 25 CD 88 17 25 3C 41 33 28
0040 | C2 F2 26 76 85 DA 45 8B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0168E325B5CB9666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>88000000</code> (136 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>4D1CB72844DE76801BC099E2672ECBA5</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4D35E8A8DEAA39AA5DF2BF85788B7725</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>CD8817253C413328C2F2267685DA458B</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

