<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 BC 76 09 00 FE 0F 98 66
0010 | 14 00 00 00 F1 8E 7E BE E1 90 78 1B 9B 7E 8F E6
0020 | E0 F1 12 C1 4F 9D 21 82</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>BC760900FE0F9866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A4 A9 8D FE 0F 98 66
0010 | B8 00 00 00 63 24 16 05 E1 90 78 1B 9B 7E 8F E6
0020 | E0 F1 12 C1 4F 9D 21 82 EF 3B AC 77 3D 05 90 7F
0030 | 94 DB F3 E8 E7 D1 7A 28 08 19 44 5F 21 89 A8 6F
0040 | 19 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A4A98DFE0F9866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B8000000</code> (184 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0819445F2189A86F19000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1820684747012599577</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1820684747012599577</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1820684747012599577 = 1328775719 * 1370197183</code></p>
<pre><code>p = 1328775719
q = 1370197183</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 44 5F 21 89 A8 6F 19 00 00 00
0010 | 04 4F 33 82 27 00 00 00 04 51 AB 8C BF 00 00 00
0020 | E1 90 78 1B 9B 7E 8F E6 E0 F1 12 C1 4F 9D 21 82
0030 | EF 3B AC 77 3D 05 90 7F 94 DB F3 E8 E7 D1 7A 28
0040 | C2 FA C5 BA D6 EC BC CA 15 EC 9D F6 74 02 6D C8
0050 | B5 77 9C 08 0C 82 48 DE 99 A1 60 D4 FD 1A 5B 23
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0819445F2189A86F19000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1820684747012599577</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044F338227000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1328775719</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0451AB8CBF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1370197183</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>C2FAC5BAD6ECBCCA15EC9DF674026DC8</code> <code>B5779C080C8248DE99A160D4FD1A5B23</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90819445F2189A86F19000000044F3382270000000451AB8CBF000000E190781B9B7E8FE6E0F112C14F9D2182EF3BAC773D05907F94DBF3E8E7D17A28C2FAC5BAD6ECBCCA15EC9DF674026DC8B5779C080C8248DE99A160D4FD1A5B2302000000
random_padding_bytes = 684BA7FF81FA9C42327226762CA190014DFBD253A3D2BFDFACC4C88C0C0F7672E64A4415CE2DC80B413043CEB1019577E12DA834EFB6361A3D24EAF3B7E21426ADEA4D878A19631C0864E57353031C57E4FA9A2ACAEE27649D248F8A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A17FB6AD4FF7A325CAE22C23AC96ADF80FC934023F586EBF8D6C42A90869BFDD432748865BDD7C7F126126B17D90B0074EE354AF090B8EAF273358CCAACD09D56586B8C96A9337C57C7A651A4FEA13A6FDD69CD214089A4DB83523D15BF5F43E2C2680E530CBF0F56CB0F0C4AECC9AF25A98E86D526E2EB5239BCC1D828866B13B00F67862FDDCA5058D974C8838764B9A057918D2F6D5A8967926B2323BF974054F08E3417A44619CADC8E40D59D5BFBDDB91EF689F4945946DFE2243BA76B921D6552AE2D5C35D75FC4DA8C06F5531827ED4B9DEBBA9BA4784D6CE19002E75AB7699EB282872C70BD40155A4E4874A68A324E76E7A8B36274BF8BE90F66E9E</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 76 09 00 FE 0F 98 66
0010 | 40 01 00 00 BE E4 12 D7 E1 90 78 1B 9B 7E 8F E6
0020 | E0 F1 12 C1 4F 9D 21 82 EF 3B AC 77 3D 05 90 7F
0030 | 94 DB F3 E8 E7 D1 7A 28 04 4F 33 82 27 00 00 00
0040 | 04 51 AB 8C BF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A1 7F B6 AD 4F F7 A3 25 CA E2 2C 23
0060 | AC 96 AD F8 0F C9 34 02 3F 58 6E BF 8D 6C 42 A9
0070 | 08 69 BF DD 43 27 48 86 5B DD 7C 7F 12 61 26 B1
0080 | 7D 90 B0 07 4E E3 54 AF 09 0B 8E AF 27 33 58 CC
0090 | AA CD 09 D5 65 86 B8 C9 6A 93 37 C5 7C 7A 65 1A
00A0 | 4F EA 13 A6 FD D6 9C D2 14 08 9A 4D B8 35 23 D1
00B0 | 5B F5 F4 3E 2C 26 80 E5 30 CB F0 F5 6C B0 F0 C4
00C0 | AE CC 9A F2 5A 98 E8 6D 52 6E 2E B5 23 9B CC 1D
00D0 | 82 88 66 B1 3B 00 F6 78 62 FD DC A5 05 8D 97 4C
00E0 | 88 38 76 4B 9A 05 79 18 D2 F6 D5 A8 96 79 26 B2
00F0 | 32 3B F9 74 05 4F 08 E3 41 7A 44 61 9C AD C8 E4
0100 | 0D 59 D5 BF BD DB 91 EF 68 9F 49 45 94 6D FE 22
0110 | 43 BA 76 B9 21 D6 55 2A E2 D5 C3 5D 75 FC 4D A8
0120 | C0 6F 55 31 82 7E D4 B9 DE BB A9 BA 47 84 D6 CE
0130 | 19 00 2E 75 AB 76 99 EB 28 28 72 C7 0B D4 01 55
0140 | A4 E4 87 4A 68 A3 24 E7 6E 7A 8B 36 27 4B F8 BE
0150 | 90 F6 6E 9E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C0760900FE0F9866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044F338227000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1328775719</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0451AB8CBF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1370197183</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A17FB6AD4FF7A325CAE22C23</code> <code>AC96ADF80FC934023F586EBF8D6C42A9</code> <code>0869BFDD432748865BDD7C7F126126B1</code> <code>7D90B0074EE354AF090B8EAF273358CC</code> <code>AACD09D56586B8C96A9337C57C7A651A</code> <code>4FEA13A6FDD69CD214089A4DB83523D1</code> <code>5BF5F43E2C2680E530CBF0F56CB0F0C4</code> <code>AECC9AF25A98E86D526E2EB5239BCC1D</code> <code>828866B13B00F67862FDDCA5058D974C</code> <code>8838764B9A057918D2F6D5A8967926B2</code> <code>323BF974054F08E3417A44619CADC8E4</code> <code>0D59D5BFBDDB91EF689F4945946DFE22</code> <code>43BA76B921D6552AE2D5C35D75FC4DA8</code> <code>C06F5531827ED4B9DEBBA9BA4784D6CE</code> <code>19002E75AB7699EB282872C70BD40155</code> <code>A4E4874A68A324E76E7A8B36274BF8BE</code><br> <code>90F66E9E</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 EC AE 56 FF 0F 98 66
0010 | BC 02 00 00 5C 07 E8 D0 E1 90 78 1B 9B 7E 8F E6
0020 | E0 F1 12 C1 4F 9D 21 82 EF 3B AC 77 3D 05 90 7F
0030 | 94 DB F3 E8 E7 D1 7A 28 FE 50 02 00 71 74 82 0D
0040 | E8 63 F0 64 41 26 CE EB C0 4C 4C 90 0E 37 5F DB
0050 | 64 1D F1 98 64 3B 0D D5 BB 6E F1 64 0B B4 CB 10
0060 | 72 1A B5 3F 8E 43 97 6E C9 1A BB A6 38 79 B0 9E
0070 | D2 31 07 BD 71 01 07 B2 AE 08 DB F6 00 12 F1 BC
0080 | F6 EA 5F D0 76 F6 C6 66 2E 30 B4 DA F0 03 DA 66
0090 | 35 6E 8F 60 82 F9 AE 19 E7 50 D9 09 2D 69 92 18
00A0 | 92 6D 53 ED 9F 86 E8 4B 1F A7 FA 8D D9 BC 1D 50
00B0 | 21 0D FB AD CF D0 AC A2 CA 4B 3B 78 22 25 28 AE
00C0 | 70 20 5C 38 07 1D B6 C8 10 50 B9 B1 1F C4 B8 7D
00D0 | 22 32 D0 F3 EA C5 B4 91 24 CA 5B 4E 7B 26 83 50
00E0 | 76 65 C3 2C B2 5B 55 6D C2 51 1F B6 27 DE 62 09
00F0 | 3A 51 40 3D D4 9E 15 0A 4C 18 03 7B BB 3E BB 7A
0100 | BF 2A 9D 58 7D 29 C9 A4 6D F8 19 5B 00 98 85 D9
0110 | BE FC D2 B0 CF 1C CD BC 7B E9 2D 43 87 79 CE BE
0120 | 4D AF E7 CF 78 AA B9 A8 A9 21 CC 23 67 A0 49 2F
0130 | 31 39 CF 6E 10 DC 06 AE 16 A4 6C 6F B6 2B 99 04
0140 | AB DF 17 88 86 D1 BA 19 12 14 97 C0 51 06 B9 1C
0150 | 66 26 1B 0A B3 41 9F FE 99 5D 0C C6 F1 7D 34 E6
0160 | 8E 92 A6 42 C1 F1 FA A3 B4 EF 14 CB A4 59 44 4E
0170 | EA E8 90 5F 39 8C 4A 34 DC 2F 22 BB 50 56 EC 65
0180 | 16 79 BE 76 CE DA 63 0A 96 41 FC 0B ED 51 99 A4
0190 | 95 11 85 10 FA 63 64 8E 6B BE 24 36 BA 46 61 5B
01A0 | 24 34 A3 8C 33 DE 74 A8 D5 45 9E 52 4B 01 85 EB
01B0 | 53 32 1F D0 08 4E C0 02 A4 EF 89 E3 D8 54 CE 0A
01C0 | 01 92 F3 9E 71 9E 00 30 61 58 13 D9 3D 52 43 15
01D0 | FC C3 45 FE 64 FF 02 8D C7 B3 FB 21 51 0D 0A EE
01E0 | 21 AE 8B 1A 64 A7 74 65 B6 1C B5 68 A4 2B 37 B2
01F0 | EB C5 24 A7 90 29 24 F9 0B 6A A9 F3 6A 14 D9 71
0200 | 78 A5 2F AD D0 52 96 E1 FB 19 48 19 C8 B0 CE 31
0210 | BC 84 16 CB AC 99 B3 9C C1 35 1B 91 05 0E EC B9
0220 | 85 7F D0 10 D0 DC 64 4E 9D 13 27 3C 0F 4D 1C 6E
0230 | A5 43 74 83 6B E8 15 DB DD DC F5 62 42 15 6C CC
0240 | 14 76 A7 B8 31 FC 4E 26 E0 1F 87 51 07 FD DA 64
0250 | B3 00 EB 0A A6 8E B9 AD 2D 4C B8 CD AC 36 B9 19
0260 | AA D2 9F 21 4A FD 8C 1E F0 AE 51 F1 CC 8F E5 57
0270 | ED 1D 33 AF C5 7E 86 58 CC C3 84 62 6A 21 9E A6
0280 | 65 8C 84 F9 10 FA 9A 66 37 90 CD 48</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01ECAE56FF0F9866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC020000</code> (700 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002007174820DE863F0644126CEEB</code> <code>C04C4C900E375FDB641DF198643B0DD5</code> <code>BB6EF1640BB4CB10721AB53F8E43976E</code> <code>C91ABBA63879B09ED23107BD710107B2</code> <code>AE08DBF60012F1BCF6EA5FD076F6C666</code> <code>2E30B4DAF003DA66356E8F6082F9AE19</code> <code>E750D9092D699218926D53ED9F86E84B</code> <code>1FA7FA8DD9BC1D50210DFBADCFD0ACA2</code> <code>CA4B3B78222528AE70205C38071DB6C8</code> <code>1050B9B11FC4B87D2232D0F3EAC5B491</code> <code>24CA5B4E7B2683507665C32CB25B556D</code> <code>C2511FB627DE62093A51403DD49E150A</code> <code>4C18037BBB3EBB7ABF2A9D587D29C9A4</code> <code>6DF8195B009885D9BEFCD2B0CF1CCDBC</code> <code>7BE92D438779CEBE4DAFE7CF78AAB9A8</code> <code>A921CC2367A0492F3139CF6E10DC06AE</code> <code>16A46C6FB62B9904ABDF178886D1BA19</code> <code>121497C05106B91C66261B0AB3419FFE</code> <code>995D0CC6F17D34E68E92A642C1F1FAA3</code> <code>B4EF14CBA459444EEAE8905F398C4A34</code> <code>DC2F22BB5056EC651679BE76CEDA630A</code> <code>9641FC0BED5199A495118510FA63648E</code> <code>6BBE2436BA46615B2434A38C33DE74A8</code> <code>D5459E524B0185EB53321FD0084EC002</code> <code>A4EF89E3D854CE0A0192F39E719E0030</code> <code>615813D93D524315FCC345FE64FF028D</code> <code>C7B3FB21510D0AEE21AE8B1A64A77465</code> <code>B61CB568A42B37B2EBC524A7902924F9</code> <code>0B6AA9F36A14D97178A52FADD05296E1</code> <code>FB194819C8B0CE31BC8416CBAC99B39C</code> <code>C1351B91050EECB9857FD010D0DC644E</code> <code>9D13273C0F4D1C6EA54374836BE815DB</code> <code>DDDCF56242156CCC1476A7B831FC4E26</code> <code>E01F875107FDDA64B300EB0AA68EB9AD</code> <code>2D4CB8CDAC36B919AAD29F214AFD8C1E</code> <code>F0AE51F1CC8FE557ED1D33AFC57E8658</code> <code>CCC384626A219EA6658C84F910FA9A66</code><br> <code>3790CD48</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 7174820DE863F0644126CEEBC04C4C900E375FDB641DF198643B0DD5BB6EF1640BB4CB10721AB53F8E43976EC91ABBA63879B09ED23107BD710107B2AE08DBF60012F1BCF6EA5FD076F6C6662E30B4DAF003DA66356E8F6082F9AE19E750D9092D699218926D53ED9F86E84B1FA7FA8DD9BC1D50210DFBADCFD0ACA2CA4B3B78222528AE70205C38071DB6C81050B9B11FC4B87D2232D0F3EAC5B49124CA5B4E7B2683507665C32CB25B556DC2511FB627DE62093A51403DD49E150A4C18037BBB3EBB7ABF2A9D587D29C9A46DF8195B009885D9BEFCD2B0CF1CCDBC7BE92D438779CEBE4DAFE7CF78AAB9A8A921CC2367A0492F3139CF6E10DC06AE16A46C6FB62B9904ABDF178886D1BA19121497C05106B91C66261B0AB3419FFE995D0CC6F17D34E68E92A642C1F1FAA3B4EF14CBA459444EEAE8905F398C4A34DC2F22BB5056EC651679BE76CEDA630A9641FC0BED5199A495118510FA63648E6BBE2436BA46615B2434A38C33DE74A8D5459E524B0185EB53321FD0084EC002A4EF89E3D854CE0A0192F39E719E0030615813D93D524315FCC345FE64FF028DC7B3FB21510D0AEE21AE8B1A64A77465B61CB568A42B37B2EBC524A7902924F90B6AA9F36A14D97178A52FADD05296E1FB194819C8B0CE31BC8416CBAC99B39CC1351B91050EECB9857FD010D0DC644E9D13273C0F4D1C6EA54374836BE815DBDDDCF56242156CCC1476A7B831FC4E26E01F875107FDDA64B300EB0AA68EB9AD2D4CB8CDAC36B919AAD29F214AFD8C1EF0AE51F1CC8FE557ED1D33AFC57E8658CCC384626A219EA6658C84F910FA9A663790CD48
tmp_aes_key = 5918547CCFD1EF0C14957551261817A7189DB4F68DBDD59459A8260347A6E18B
tmp_aes_iv = 67444E972D9578EB08FC833ABCE9B4F7058A68DFCBD1DCDCFF42776CC2FAC5BA</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 8A4CA773F160B3913790E97EDCAB373FD5BF7231BA0D89B5E190781B9B7E8FE6E0F112C14F9D2182EF3BAC773D05907F94DBF3E8E7D17A2803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010040CDCB94DF9F87C25399B060DA1A80A0DCC5C0DC3603FD584E16449FC8360C9FBA5C322DC77DD6FC30B19EAACDB94DFA2155D097359BBEB082760C0FAF9A899188E01F91233D58E59C6E4D17F954D6C83160395FFC52F4407CEBA1EF0A7FB30AC7E81B236807957715BF30DF6C76B15C8CD97F6AFFBCF778C754E2A573427EEED5F7FDAD856F4A972E823DB0073A506E73D3B654B52F130DCB31565AC54EFFF6CCD03BE4ADC2249E62B0430981C87EEDCFA9798A45C9ACED35A4DA86FF5B581D7C85B1AB4CB71F1590664B77AEBE63CBF8CD035481CF31E7D2CA5BAF231554DF175145AAD6DB53BB9F7A740D0C17398852DD1151391222810B2C388B2729B96FFF0F9866044EF86BAA4C7C28
answer = BA0D89B5E190781B9B7E8FE6E0F112C14F9D2182EF3BAC773D05907F94DBF3E8E7D17A2803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010040CDCB94DF9F87C25399B060DA1A80A0DCC5C0DC3603FD584E16449FC8360C9FBA5C322DC77DD6FC30B19EAACDB94DFA2155D097359BBEB082760C0FAF9A899188E01F91233D58E59C6E4D17F954D6C83160395FFC52F4407CEBA1EF0A7FB30AC7E81B236807957715BF30DF6C76B15C8CD97F6AFFBCF778C754E2A573427EEED5F7FDAD856F4A972E823DB0073A506E73D3B654B52F130DCB31565AC54EFFF6CCD03BE4ADC2249E62B0430981C87EEDCFA9798A45C9ACED35A4DA86FF5B581D7C85B1AB4CB71F1590664B77AEBE63CBF8CD035481CF31E7D2CA5BAF231554DF175145AAD6DB53BB9F7A740D0C17398852DD1151391222810B2C388B2729B96FFF0F9866044EF86BAA4C7C28</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E1 90 78 1B 9B 7E 8F E6 E0 F1 12 C1
0010 | 4F 9D 21 82 EF 3B AC 77 3D 05 90 7F 94 DB F3 E8
0020 | E7 D1 7A 28 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 40 CD CB 94 DF 9F 87 C2 53 99 B0 60 DA 1A 80 A0
0140 | DC C5 C0 DC 36 03 FD 58 4E 16 44 9F C8 36 0C 9F
0150 | BA 5C 32 2D C7 7D D6 FC 30 B1 9E AA CD B9 4D FA
0160 | 21 55 D0 97 35 9B BE B0 82 76 0C 0F AF 9A 89 91
0170 | 88 E0 1F 91 23 3D 58 E5 9C 6E 4D 17 F9 54 D6 C8
0180 | 31 60 39 5F FC 52 F4 40 7C EB A1 EF 0A 7F B3 0A
0190 | C7 E8 1B 23 68 07 95 77 15 BF 30 DF 6C 76 B1 5C
01A0 | 8C D9 7F 6A FF BC F7 78 C7 54 E2 A5 73 42 7E EE
01B0 | D5 F7 FD AD 85 6F 4A 97 2E 82 3D B0 07 3A 50 6E
01C0 | 73 D3 B6 54 B5 2F 13 0D CB 31 56 5A C5 4E FF F6
01D0 | CC D0 3B E4 AD C2 24 9E 62 B0 43 09 81 C8 7E ED
01E0 | CF A9 79 8A 45 C9 AC ED 35 A4 DA 86 FF 5B 58 1D
01F0 | 7C 85 B1 AB 4C B7 1F 15 90 66 4B 77 AE BE 63 CB
0200 | F8 CD 03 54 81 CF 31 E7 D2 CA 5B AF 23 15 54 DF
0210 | 17 51 45 AA D6 DB 53 BB 9F 7A 74 0D 0C 17 39 88
0220 | 52 DD 11 51 39 12 22 81 0B 2C 38 8B 27 29 B9 6F
0230 | FF 0F 98 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010040CDCB94DF9F87C25399B060</code> <code>DA1A80A0DCC5C0DC3603FD584E16449F</code> <code>C8360C9FBA5C322DC77DD6FC30B19EAA</code> <code>CDB94DFA2155D097359BBEB082760C0F</code> <code>AF9A899188E01F91233D58E59C6E4D17</code> <code>F954D6C83160395FFC52F4407CEBA1EF</code> <code>0A7FB30AC7E81B236807957715BF30DF</code> <code>6C76B15C8CD97F6AFFBCF778C754E2A5</code> <code>73427EEED5F7FDAD856F4A972E823DB0</code> <code>073A506E73D3B654B52F130DCB31565A</code> <code>C54EFFF6CCD03BE4ADC2249E62B04309</code> <code>81C87EEDCFA9798A45C9ACED35A4DA86</code> <code>FF5B581D7C85B1AB4CB71F1590664B77</code> <code>AEBE63CBF8CD035481CF31E7D2CA5BAF</code> <code>231554DF175145AAD6DB53BB9F7A740D</code> <code>0C17398852DD1151391222810B2C388B</code><br> <code>2729B96F</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>FF0F9866</code> (1721241599 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 0424D9CE284E44D63399229B4B168E9245B1DBB446A4ADE4E2DF145EFA8A0BB6B23FDECD90B92BC8626D63E06F5E5BA8B14D227413A80AB2D20F9FEC7A98BD2F858B706018597326773C8C16496778F80BC3BBF229D6AA902F3C44318B7C6DD9CFE899E36A8292E42F9E454E6302373E80BD1B8DA7C063A25167212EAE03A7D95949E6BF288E74F7C95A3399CFB2131344D4F1143A1D8A24562DCCF88957D8DB58F0C178F9AD58B67BC39F9D5BE70267EDB7E67199868348B97152C7BE97879FCF42C8CE3C4B05FF9D706D9E536CEE9FCED96F9E7ADAF3E11F2F2B8C5FF1382F42067ACC7EFB570936FD37F88087584A6EF16E5CB05E64C6A725391BDA3B512D</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 061876A7301C91A243E316B62928FBFE60B4EAD143BF496A11C5CABCC222DBE3237EA4F35033D42BAC96831F32E3E8DBA8D3BF4E32FAC43AA992DE16C3AA497E70AC43ED623DDD01D269F4486A81624232776A792612961A0A496C42F527835555C838CD4FCDB83583667DC7166D1F94C251273426A5615B9237A96A112792EF218E42C386BF8DA906E398564B82440CB2A0F41A6BA22B4E7B8A1A35F82414D9B322164280937C7EF1C71AF0B3DF086E22E928F40DE3CEC3E7CACB822E4FFFFCE9D6C71B37F8F7247C95BBA5F09A1C70FF90AA315D814091DC5EF663DF0F81495FED577CEEBD9FD36E77153FBE5EE8FE638709E3360F4BF8D31A9DD21F047E12</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E1 90 78 1B 9B 7E 8F E6 E0 F1 12 C1
0010 | 4F 9D 21 82 EF 3B AC 77 3D 05 90 7F 94 DB F3 E8
0020 | E7 D1 7A 28 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 06 18 76 A7 30 1C 91 A2 43 E3 16 B6 29 28 FB FE
0040 | 60 B4 EA D1 43 BF 49 6A 11 C5 CA BC C2 22 DB E3
0050 | 23 7E A4 F3 50 33 D4 2B AC 96 83 1F 32 E3 E8 DB
0060 | A8 D3 BF 4E 32 FA C4 3A A9 92 DE 16 C3 AA 49 7E
0070 | 70 AC 43 ED 62 3D DD 01 D2 69 F4 48 6A 81 62 42
0080 | 32 77 6A 79 26 12 96 1A 0A 49 6C 42 F5 27 83 55
0090 | 55 C8 38 CD 4F CD B8 35 83 66 7D C7 16 6D 1F 94
00A0 | C2 51 27 34 26 A5 61 5B 92 37 A9 6A 11 27 92 EF
00B0 | 21 8E 42 C3 86 BF 8D A9 06 E3 98 56 4B 82 44 0C
00C0 | B2 A0 F4 1A 6B A2 2B 4E 7B 8A 1A 35 F8 24 14 D9
00D0 | B3 22 16 42 80 93 7C 7E F1 C7 1A F0 B3 DF 08 6E
00E0 | 22 E9 28 F4 0D E3 CE C3 E7 CA CB 82 2E 4F FF FC
00F0 | E9 D6 C7 1B 37 F8 F7 24 7C 95 BB A5 F0 9A 1C 70
0100 | FF 90 AA 31 5D 81 40 91 DC 5E F6 63 DF 0F 81 49
0110 | 5F ED 57 7C EE BD 9F D3 6E 77 15 3F BE 5E E8 FE
0120 | 63 87 09 E3 36 0F 4B F8 D3 1A 9D D2 1F 04 7E 12</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100061876A7301C91A243E316B6</code> <code>2928FBFE60B4EAD143BF496A11C5CABC</code> <code>C222DBE3237EA4F35033D42BAC96831F</code> <code>32E3E8DBA8D3BF4E32FAC43AA992DE16</code> <code>C3AA497E70AC43ED623DDD01D269F448</code> <code>6A81624232776A792612961A0A496C42</code> <code>F527835555C838CD4FCDB83583667DC7</code> <code>166D1F94C251273426A5615B9237A96A</code> <code>112792EF218E42C386BF8DA906E39856</code> <code>4B82440CB2A0F41A6BA22B4E7B8A1A35</code> <code>F82414D9B322164280937C7EF1C71AF0</code> <code>B3DF086E22E928F40DE3CEC3E7CACB82</code> <code>2E4FFFFCE9D6C71B37F8F7247C95BBA5</code> <code>F09A1C70FF90AA315D814091DC5EF663</code> <code>DF0F81495FED577CEEBD9FD36E77153F</code> <code>BE5EE8FE638709E3360F4BF8D31A9DD2</code><br> <code>1F047E12</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E190781B9B7E8FE6E0F112C14F9D2182EF3BAC773D05907F94DBF3E8E7D17A280000000000000000FE000100061876A7301C91A243E316B62928FBFE60B4EAD143BF496A11C5CABCC222DBE3237EA4F35033D42BAC96831F32E3E8DBA8D3BF4E32FAC43AA992DE16C3AA497E70AC43ED623DDD01D269F4486A81624232776A792612961A0A496C42F527835555C838CD4FCDB83583667DC7166D1F94C251273426A5615B9237A96A112792EF218E42C386BF8DA906E398564B82440CB2A0F41A6BA22B4E7B8A1A35F82414D9B322164280937C7EF1C71AF0B3DF086E22E928F40DE3CEC3E7CACB822E4FFFFCE9D6C71B37F8F7247C95BBA5F09A1C70FF90AA315D814091DC5EF663DF0F81495FED577CEEBD9FD36E77153FBE5EE8FE638709E3360F4BF8D31A9DD21F047E12
padding = 9DB0621E0A237DE31C0CF4E6
tmp_aes_key = 5918547CCFD1EF0C14957551261817A7189DB4F68DBDD59459A8260347A6E18B
tmp_aes_iv = 67444E972D9578EB08FC833ABCE9B4F7058A68DFCBD1DCDCFF42776CC2FAC5BA</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 05A842D8F2426610AD02F44D86D2384CB5C7D529897448DA22AF65AE9410359E1C4934467FBD099B78FBC96406204CD1012434C8333C1C76BFE6BB1C5F6DF6E24C0E7FB03EA1AEE6E258A2C5753B039C7EF806824685F8E3C4DFC704FBCA2BB7F7C340CF490EC717C97F063ED15C87BA25DCD4DE71C4813EBF7684A801DFB8B293B704D0082ED65C14D6082A6117A8E16882E2CE59389E77B679D5772C547519C2311FBDC3AB2FE827FAD88DAAC3B4F890A5277F13ABBC78816DC847C41801DCBEEE9CCFF5DD8BFBA3B62CCB8039C8F757EB1DFDE0F19F875CE76CF2E87726D7A2EEFE9238B9C43539C3094AB5BAB3D312D8C9FB5E64B70CE5AE084861F70BBF5B4475CE900B3B04B42B81D9315285E933B59C2C8103529EC0528C451D65C3BA870D1B73EE2243C01F7610F3F72D3BE331D835F3C84001417EF5FDDD9186AB4EEE2D836EAF1438CC12069F5B7EB937A8</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A4 08 05 00 FF 0F 98 66
0010 | 78 01 00 00 1F 5F 04 F5 E1 90 78 1B 9B 7E 8F E6
0020 | E0 F1 12 C1 4F 9D 21 82 EF 3B AC 77 3D 05 90 7F
0030 | 94 DB F3 E8 E7 D1 7A 28 FE 50 01 00 05 A8 42 D8
0040 | F2 42 66 10 AD 02 F4 4D 86 D2 38 4C B5 C7 D5 29
0050 | 89 74 48 DA 22 AF 65 AE 94 10 35 9E 1C 49 34 46
0060 | 7F BD 09 9B 78 FB C9 64 06 20 4C D1 01 24 34 C8
0070 | 33 3C 1C 76 BF E6 BB 1C 5F 6D F6 E2 4C 0E 7F B0
0080 | 3E A1 AE E6 E2 58 A2 C5 75 3B 03 9C 7E F8 06 82
0090 | 46 85 F8 E3 C4 DF C7 04 FB CA 2B B7 F7 C3 40 CF
00A0 | 49 0E C7 17 C9 7F 06 3E D1 5C 87 BA 25 DC D4 DE
00B0 | 71 C4 81 3E BF 76 84 A8 01 DF B8 B2 93 B7 04 D0
00C0 | 08 2E D6 5C 14 D6 08 2A 61 17 A8 E1 68 82 E2 CE
00D0 | 59 38 9E 77 B6 79 D5 77 2C 54 75 19 C2 31 1F BD
00E0 | C3 AB 2F E8 27 FA D8 8D AA C3 B4 F8 90 A5 27 7F
00F0 | 13 AB BC 78 81 6D C8 47 C4 18 01 DC BE EE 9C CF
0100 | F5 DD 8B FB A3 B6 2C CB 80 39 C8 F7 57 EB 1D FD
0110 | E0 F1 9F 87 5C E7 6C F2 E8 77 26 D7 A2 EE FE 92
0120 | 38 B9 C4 35 39 C3 09 4A B5 BA B3 D3 12 D8 C9 FB
0130 | 5E 64 B7 0C E5 AE 08 48 61 F7 0B BF 5B 44 75 CE
0140 | 90 0B 3B 04 B4 2B 81 D9 31 52 85 E9 33 B5 9C 2C
0150 | 81 03 52 9E C0 52 8C 45 1D 65 C3 BA 87 0D 1B 73
0160 | EE 22 43 C0 1F 76 10 F3 F7 2D 3B E3 31 D8 35 F3
0170 | C8 40 01 41 7E F5 FD DD 91 86 AB 4E EE 2D 83 6E
0180 | AF 14 38 CC 12 06 9F 5B 7E B9 37 A8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A4080500FF0F9866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010005A842D8F2426610AD02F44D</code> <code>86D2384CB5C7D529897448DA22AF65AE</code> <code>9410359E1C4934467FBD099B78FBC964</code> <code>06204CD1012434C8333C1C76BFE6BB1C</code> <code>5F6DF6E24C0E7FB03EA1AEE6E258A2C5</code> <code>753B039C7EF806824685F8E3C4DFC704</code> <code>FBCA2BB7F7C340CF490EC717C97F063E</code> <code>D15C87BA25DCD4DE71C4813EBF7684A8</code> <code>01DFB8B293B704D0082ED65C14D6082A</code> <code>6117A8E16882E2CE59389E77B679D577</code> <code>2C547519C2311FBDC3AB2FE827FAD88D</code> <code>AAC3B4F890A5277F13ABBC78816DC847</code> <code>C41801DCBEEE9CCFF5DD8BFBA3B62CCB</code> <code>8039C8F757EB1DFDE0F19F875CE76CF2</code> <code>E87726D7A2EEFE9238B9C43539C3094A</code> <code>B5BAB3D312D8C9FB5E64B70CE5AE0848</code> <code>61F70BBF5B4475CE900B3B04B42B81D9</code> <code>315285E933B59C2C8103529EC0528C45</code> <code>1D65C3BA870D1B73EE2243C01F7610F3</code> <code>F72D3BE331D835F3C84001417EF5FDDD</code> <code>9186AB4EEE2D836EAF1438CC12069F5B</code><br> <code>7EB937A8</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 143E2FAC9B15F6EB83F861D8A9F8E1994CF662FF087632503B54697DB9AA8D577206E60460BAA78049E0636E72C1814F39D6CF1F9DFF3991D1170B5505AB5279943BC5D5F0C47105BFD889B1C08ECF0AA4625466EE8FD038E9233564DF751C7B51E523B8D7D33705393C62DE2C72086753C435220B6FE1B0896DA513F32235A068B827A19746CAFC467A1078203E8AA2A9F23419AC04E003F3A9F3DDA1BB6A9CEAF12AB61BB9A2BC0C50727D0C6BAABD4A27A997FF63E60ED7C9CCB1AB1B19781FA31077AB97CFA8E74929292D5233135EEBB2BFC5B91A27D68090956A62B45870A890A0B65294B588F99E0A9BCD645CA6997E8010A89466582A7D559CDBA807</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C 38 DC FF 0F 98 66
0010 | 34 00 00 00 34 F7 CB 3B E1 90 78 1B 9B 7E 8F E6
0020 | E0 F1 12 C1 4F 9D 21 82 EF 3B AC 77 3D 05 90 7F
0030 | 94 DB F3 E8 E7 D1 7A 28 9E 5F 3E D7 C4 FF 02 E3
0040 | A1 0A 26 15 E3 D9 C8 83</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017C38DCFF0F9866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E190781B9B7E8FE6E0F112C14F9D2182</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EF3BAC773D05907F94DBF3E8E7D17A28</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>9E5F3ED7C4FF02E3A10A2615E3D9C883</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

