<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E0 DF 08 00 DF 67 89 66
0010 | 14 00 00 00 F1 8E 7E BE 24 51 93 B7 F5 9B 5B BC
0020 | 8C C5 6C B6 43 18 20 22</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E0DF0800DF678966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 97 6E DF 67 89 66
0010 | 58 00 00 00 63 24 16 05 24 51 93 B7 F5 9B 5B BC
0020 | 8C C5 6C B6 43 18 20 22 12 38 54 3A 19 42 67 BC
0030 | 53 14 82 A7 E3 C2 ED 64 08 1D B8 A4 A1 D9 52 C3
0040 | 8B 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130976EDF678966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081DB8A4A1D952C38B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2141642637857440651</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2141642637857440651</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2141642637857440651 = 1329070753 * 1611383467</code></p>
<pre><code>p = 1329070753
q = 1611383467</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1D B8 A4 A1 D9 52 C3 8B 00 00 00
0010 | 04 4F 38 02 A1 00 00 00 04 60 0B C2 AB 00 00 00
0020 | 24 51 93 B7 F5 9B 5B BC 8C C5 6C B6 43 18 20 22
0030 | 12 38 54 3A 19 42 67 BC 53 14 82 A7 E3 C2 ED 64
0040 | 61 55 EC C9 94 CB BC FB 0D C2 C7 93 F9 80 9B 96
0050 | 58 39 3B FD 15 01 BD E0 D1 64 B2 E4 B7 E9 42 4B
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081DB8A4A1D952C38B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2141642637857440651</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044F3802A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1329070753</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04600BC2AB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1611383467</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>6155ECC994CBBCFB0DC2C793F9809B96</code> <code>58393BFD1501BDE0D164B2E4B7E9424B</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081DB8A4A1D952C38B000000044F3802A100000004600BC2AB000000245193B7F59B5BBC8CC56CB6431820221238543A194267BC531482A7E3C2ED646155ECC994CBBCFB0DC2C793F9809B9658393BFD1501BDE0D164B2E4B7E9424B02000000
random_padding_bytes = EA0DEB206D25CC5E8D38D80517DF22693C90E630FED547496596D195302D3533B2E25A0BCBAE9AB55AF20A73ADD1B3E5C7910FB7FC22FD241CB2FF1012793625810226EA738F28054935B34BC673A92FF094E32F11C3843AE135CB6A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 31338A47F38101AF1CE82D2C64632A2BA0497EF970194478825BDB1CFB0BB1CD28605D729DC0658CC756C6338B20459B2CBFC33EB4EB94F9D352B59643EC449F4C5611CA246BE2BC47152BFB2837AF86298F8A80175E242215169170C96E058A162419C2DAA0E3A1D59290DAA2CD5456FD2B6D569A399FFA454CF28DF922B33B2CF693433C0E1E74EC0EE5B8D454EC442799110462048EE523F47952FE00F06095D93D4DE0D55E6D4DB360248C83278515EC8547DF872CB39354F1CFA7670E2FB457585E0FB7264DEA8F4DC7DC80BD931769796227C776B8BB0F7E32014B7558F369169496DA990345A38C8415E6678DDC9933A4D5F0AC213D60E3A8D9B74B8F</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E4 DF 08 00 DF 67 89 66
0010 | 40 01 00 00 BE E4 12 D7 24 51 93 B7 F5 9B 5B BC
0020 | 8C C5 6C B6 43 18 20 22 12 38 54 3A 19 42 67 BC
0030 | 53 14 82 A7 E3 C2 ED 64 04 4F 38 02 A1 00 00 00
0040 | 04 60 0B C2 AB 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 31 33 8A 47 F3 81 01 AF 1C E8 2D 2C
0060 | 64 63 2A 2B A0 49 7E F9 70 19 44 78 82 5B DB 1C
0070 | FB 0B B1 CD 28 60 5D 72 9D C0 65 8C C7 56 C6 33
0080 | 8B 20 45 9B 2C BF C3 3E B4 EB 94 F9 D3 52 B5 96
0090 | 43 EC 44 9F 4C 56 11 CA 24 6B E2 BC 47 15 2B FB
00A0 | 28 37 AF 86 29 8F 8A 80 17 5E 24 22 15 16 91 70
00B0 | C9 6E 05 8A 16 24 19 C2 DA A0 E3 A1 D5 92 90 DA
00C0 | A2 CD 54 56 FD 2B 6D 56 9A 39 9F FA 45 4C F2 8D
00D0 | F9 22 B3 3B 2C F6 93 43 3C 0E 1E 74 EC 0E E5 B8
00E0 | D4 54 EC 44 27 99 11 04 62 04 8E E5 23 F4 79 52
00F0 | FE 00 F0 60 95 D9 3D 4D E0 D5 5E 6D 4D B3 60 24
0100 | 8C 83 27 85 15 EC 85 47 DF 87 2C B3 93 54 F1 CF
0110 | A7 67 0E 2F B4 57 58 5E 0F B7 26 4D EA 8F 4D C7
0120 | DC 80 BD 93 17 69 79 62 27 C7 76 B8 BB 0F 7E 32
0130 | 01 4B 75 58 F3 69 16 94 96 DA 99 03 45 A3 8C 84
0140 | 15 E6 67 8D DC 99 33 A4 D5 F0 AC 21 3D 60 E3 A8
0150 | D9 B7 4B 8F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E4DF0800DF678966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044F3802A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1329070753</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04600BC2AB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1611383467</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010031338A47F38101AF1CE82D2C</code> <code>64632A2BA0497EF970194478825BDB1C</code> <code>FB0BB1CD28605D729DC0658CC756C633</code> <code>8B20459B2CBFC33EB4EB94F9D352B596</code> <code>43EC449F4C5611CA246BE2BC47152BFB</code> <code>2837AF86298F8A80175E242215169170</code> <code>C96E058A162419C2DAA0E3A1D59290DA</code> <code>A2CD5456FD2B6D569A399FFA454CF28D</code> <code>F922B33B2CF693433C0E1E74EC0EE5B8</code> <code>D454EC442799110462048EE523F47952</code> <code>FE00F06095D93D4DE0D55E6D4DB36024</code> <code>8C83278515EC8547DF872CB39354F1CF</code> <code>A7670E2FB457585E0FB7264DEA8F4DC7</code> <code>DC80BD931769796227C776B8BB0F7E32</code> <code>014B7558F369169496DA990345A38C84</code> <code>15E6678DDC9933A4D5F0AC213D60E3A8</code><br> <code>D9B74B8F</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 08 66 20 E0 67 89 66
0010 | E8 02 00 00 5C 07 E8 D0 24 51 93 B7 F5 9B 5B BC
0020 | 8C C5 6C B6 43 18 20 22 12 38 54 3A 19 42 67 BC
0030 | 53 14 82 A7 E3 C2 ED 64 FE 50 02 00 35 D5 91 1D
0040 | F0 26 5E 6E F5 2A B9 9A 6E ED 40 AD E9 59 2C 9C
0050 | E2 3A B8 B6 56 01 0E 92 B9 9E 40 8E 91 D8 60 A1
0060 | B1 A3 75 00 FD 9D AA AC B2 75 E3 1A 7B 97 84 89
0070 | 3F 6C 04 C1 18 60 ED 86 1F CD B4 BB 17 F3 76 EA
0080 | 6F F7 D3 75 94 D4 2E FF 93 9D 42 C6 9B B8 A8 BB
0090 | 4C DB CE 00 5D B7 F7 B6 D4 15 DC 8C FA B4 0D F0
00A0 | A2 A4 22 3C 49 55 B1 75 83 5D B9 3E 11 7E FD 52
00B0 | D4 8F EA 47 6C 6C BF C8 3B A1 A0 42 2B B7 C8 B8
00C0 | 44 EE B5 CA 7D E6 2F 59 54 A1 67 D8 41 E1 6F 44
00D0 | 2B B7 1C CC A7 D6 1D D5 C7 84 CC 8C 09 46 60 BF
00E0 | C5 EB CF B1 F0 37 25 87 F1 DB A4 50 0B 86 8F 2C
00F0 | E0 5B 18 AC DB 98 88 16 CF F6 66 4E 23 3A 4B 57
0100 | D2 8F FB 44 3F BE 74 C0 22 9F F3 04 29 D5 72 E9
0110 | 77 C2 7E A6 05 E7 0C 7B 0E 2C D4 3D 30 5D BB 25
0120 | FC 0B E7 04 58 F9 93 BB 48 8C 37 32 DD D6 E3 06
0130 | 72 39 82 D4 4A 49 03 A6 4D 0E FB 21 45 46 2A F8
0140 | 6A 1E 19 93 FD 8C C4 F4 2F EB AB A0 0B 86 ED CC
0150 | 50 60 17 98 79 42 07 B5 EE 67 DE 52 44 2C 7D A9
0160 | C5 F9 5C F9 DC 12 03 B0 9A 5C 7A BD 67 CC DE 63
0170 | 18 4F A1 E9 5B 20 CD EB 5F CD 91 45 20 E6 DF 62
0180 | 4B 84 4B F0 2D 5F F2 F4 89 B0 09 D9 71 5D 98 C5
0190 | A3 2A CC 6E 7E 78 E8 E0 C2 6A 89 99 97 A4 80 30
01A0 | B0 1F 3A 23 48 2D AD 5D BA 59 6D A8 FD 7C B1 5F
01B0 | 14 08 F1 F6 6A 88 36 3E 21 2A 13 3F 0D 8A D0 BD
01C0 | 04 C1 4B 06 AD 86 5C 62 1F A8 92 3C BC A9 1F 3A
01D0 | F3 4C 97 D5 26 FA 0A 1B 82 39 5B AF E0 45 C8 30
01E0 | 7C 31 5F 1C FA 05 C9 DE 22 6B 63 6C 52 46 38 95
01F0 | 80 3B 07 D0 90 2B 40 A4 48 88 51 3C F2 41 58 D7
0200 | 55 3C 84 C4 1D 32 70 1A 5E E1 68 82 F5 C5 F0 26
0210 | 1F 19 F4 7A 2C B2 3D C2 BB 92 44 5B 58 65 61 51
0220 | 62 B6 11 70 39 97 BC C9 7C 2A F7 8E 0E 2F 21 85
0230 | B2 F2 F4 7F 47 A3 9C 50 FC 77 64 D6 D7 3A A2 D9
0240 | EB BB 5D E3 95 05 F2 FD 49 E4 9F AC E0 0C F9 7A
0250 | 37 23 35 89 81 E6 40 90 80 C9 BE E4 F8 5B 0D 8E
0260 | 13 90 C8 BE B2 99 49 C8 B7 37 81 8B E6 83 1B 2C
0270 | 7C 30 7C 38 84 EA FE 8D 0E F4 11 D7 05 E1 C1 1F
0280 | EA 23 45 73 C6 61 2E 23 32 77 AC 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01086620E0678966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>E8020000</code> (744 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020035D5911DF0265E6EF52AB99A</code> <code>6EED40ADE9592C9CE23AB8B656010E92</code> <code>B99E408E91D860A1B1A37500FD9DAAAC</code> <code>B275E31A7B9784893F6C04C11860ED86</code> <code>1FCDB4BB17F376EA6FF7D37594D42EFF</code> <code>939D42C69BB8A8BB4CDBCE005DB7F7B6</code> <code>D415DC8CFAB40DF0A2A4223C4955B175</code> <code>835DB93E117EFD52D48FEA476C6CBFC8</code> <code>3BA1A0422BB7C8B844EEB5CA7DE62F59</code> <code>54A167D841E16F442BB71CCCA7D61DD5</code> <code>C784CC8C094660BFC5EBCFB1F0372587</code> <code>F1DBA4500B868F2CE05B18ACDB988816</code> <code>CFF6664E233A4B57D28FFB443FBE74C0</code> <code>229FF30429D572E977C27EA605E70C7B</code> <code>0E2CD43D305DBB25FC0BE70458F993BB</code> <code>488C3732DDD6E306723982D44A4903A6</code> <code>4D0EFB2145462AF86A1E1993FD8CC4F4</code> <code>2FEBABA00B86EDCC50601798794207B5</code> <code>EE67DE52442C7DA9C5F95CF9DC1203B0</code> <code>9A5C7ABD67CCDE63184FA1E95B20CDEB</code> <code>5FCD914520E6DF624B844BF02D5FF2F4</code> <code>89B009D9715D98C5A32ACC6E7E78E8E0</code> <code>C26A899997A48030B01F3A23482DAD5D</code> <code>BA596DA8FD7CB15F1408F1F66A88363E</code> <code>212A133F0D8AD0BD04C14B06AD865C62</code> <code>1FA8923CBCA91F3AF34C97D526FA0A1B</code> <code>82395BAFE045C8307C315F1CFA05C9DE</code> <code>226B636C52463895803B07D0902B40A4</code> <code>4888513CF24158D7553C84C41D32701A</code> <code>5EE16882F5C5F0261F19F47A2CB23DC2</code> <code>BB92445B5865615162B611703997BCC9</code> <code>7C2AF78E0E2F2185B2F2F47F47A39C50</code> <code>FC7764D6D73AA2D9EBBB5DE39505F2FD</code> <code>49E49FACE00CF97A3723358981E64090</code> <code>80C9BEE4F85B0D8E1390C8BEB29949C8</code> <code>B737818BE6831B2C7C307C3884EAFE8D</code> <code>0EF411D705E1C11FEA234573C6612E23</code><br> <code>3277AC65</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 35D5911DF0265E6EF52AB99A6EED40ADE9592C9CE23AB8B656010E92B99E408E91D860A1B1A37500FD9DAAACB275E31A7B9784893F6C04C11860ED861FCDB4BB17F376EA6FF7D37594D42EFF939D42C69BB8A8BB4CDBCE005DB7F7B6D415DC8CFAB40DF0A2A4223C4955B175835DB93E117EFD52D48FEA476C6CBFC83BA1A0422BB7C8B844EEB5CA7DE62F5954A167D841E16F442BB71CCCA7D61DD5C784CC8C094660BFC5EBCFB1F0372587F1DBA4500B868F2CE05B18ACDB988816CFF6664E233A4B57D28FFB443FBE74C0229FF30429D572E977C27EA605E70C7B0E2CD43D305DBB25FC0BE70458F993BB488C3732DDD6E306723982D44A4903A64D0EFB2145462AF86A1E1993FD8CC4F42FEBABA00B86EDCC50601798794207B5EE67DE52442C7DA9C5F95CF9DC1203B09A5C7ABD67CCDE63184FA1E95B20CDEB5FCD914520E6DF624B844BF02D5FF2F489B009D9715D98C5A32ACC6E7E78E8E0C26A899997A48030B01F3A23482DAD5DBA596DA8FD7CB15F1408F1F66A88363E212A133F0D8AD0BD04C14B06AD865C621FA8923CBCA91F3AF34C97D526FA0A1B82395BAFE045C8307C315F1CFA05C9DE226B636C52463895803B07D0902B40A44888513CF24158D7553C84C41D32701A5EE16882F5C5F0261F19F47A2CB23DC2BB92445B5865615162B611703997BCC97C2AF78E0E2F2185B2F2F47F47A39C50FC7764D6D73AA2D9EBBB5DE39505F2FD49E49FACE00CF97A3723358981E6409080C9BEE4F85B0D8E1390C8BEB29949C8B737818BE6831B2C7C307C3884EAFE8D0EF411D705E1C11FEA234573C6612E233277AC65
tmp_aes_key = EB1DEED079C861DCBB389AFC13961A14C1DFD95EED5800484B54AE157EB980B0
tmp_aes_iv = 804327EBEF76C86A7C81ACD8E82F02EDF3F5DEE0FE475FA0A8697D2C6155ECC9</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 7DF01684237F0202BA8E36E4821EB3E75D5B1FABBA0D89B5245193B7F59B5BBC8CC56CB6431820221238543A194267BC531482A7E3C2ED6403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009C6DA0F03FC74CF209ABCA82CEA24A45FFA65FCDFABBC51D0256B841B6878074CA8E267FBEEB8665BEB6379FCE7037EC1BFA4493D42988A5C1327DC05B96C27778D1932EE617A499259F743AF43D0993DCBCAED1F6AB711649C3C3F844D98E3A6EA52F73EF4A05EC57054E774C7497C49B9128F28E3E4391CA3E01CB701721B2A0974ED269EAC14F5CB3966B4F9E7D149AAF769A87BC2FF224798B2B5B32FF3378AE2E4D8A3D31DF9F7F8938B310EE9ADB8784873A60F2641F55E977AC0A24458DF7793980E93043B83EC70D890E43B822CF040FDD57081C1B943396C7A5C26338FA2E66BF0022EE1A6371DCD48CDF22763BF6DEF856E0EF29967BB1674247BEE0678966C32B46BCE0A56975
answer = BA0D89B5245193B7F59B5BBC8CC56CB6431820221238543A194267BC531482A7E3C2ED6403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001009C6DA0F03FC74CF209ABCA82CEA24A45FFA65FCDFABBC51D0256B841B6878074CA8E267FBEEB8665BEB6379FCE7037EC1BFA4493D42988A5C1327DC05B96C27778D1932EE617A499259F743AF43D0993DCBCAED1F6AB711649C3C3F844D98E3A6EA52F73EF4A05EC57054E774C7497C49B9128F28E3E4391CA3E01CB701721B2A0974ED269EAC14F5CB3966B4F9E7D149AAF769A87BC2FF224798B2B5B32FF3378AE2E4D8A3D31DF9F7F8938B310EE9ADB8784873A60F2641F55E977AC0A24458DF7793980E93043B83EC70D890E43B822CF040FDD57081C1B943396C7A5C26338FA2E66BF0022EE1A6371DCD48CDF22763BF6DEF856E0EF29967BB1674247BEE0678966C32B46BCE0A56975</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 24 51 93 B7 F5 9B 5B BC 8C C5 6C B6
0010 | 43 18 20 22 12 38 54 3A 19 42 67 BC 53 14 82 A7
0020 | E3 C2 ED 64 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 9C 6D A0 F0 3F C7 4C F2 09 AB CA 82 CE A2 4A 45
0140 | FF A6 5F CD FA BB C5 1D 02 56 B8 41 B6 87 80 74
0150 | CA 8E 26 7F BE EB 86 65 BE B6 37 9F CE 70 37 EC
0160 | 1B FA 44 93 D4 29 88 A5 C1 32 7D C0 5B 96 C2 77
0170 | 78 D1 93 2E E6 17 A4 99 25 9F 74 3A F4 3D 09 93
0180 | DC BC AE D1 F6 AB 71 16 49 C3 C3 F8 44 D9 8E 3A
0190 | 6E A5 2F 73 EF 4A 05 EC 57 05 4E 77 4C 74 97 C4
01A0 | 9B 91 28 F2 8E 3E 43 91 CA 3E 01 CB 70 17 21 B2
01B0 | A0 97 4E D2 69 EA C1 4F 5C B3 96 6B 4F 9E 7D 14
01C0 | 9A AF 76 9A 87 BC 2F F2 24 79 8B 2B 5B 32 FF 33
01D0 | 78 AE 2E 4D 8A 3D 31 DF 9F 7F 89 38 B3 10 EE 9A
01E0 | DB 87 84 87 3A 60 F2 64 1F 55 E9 77 AC 0A 24 45
01F0 | 8D F7 79 39 80 E9 30 43 B8 3E C7 0D 89 0E 43 B8
0200 | 22 CF 04 0F DD 57 08 1C 1B 94 33 96 C7 A5 C2 63
0210 | 38 FA 2E 66 BF 00 22 EE 1A 63 71 DC D4 8C DF 22
0220 | 76 3B F6 DE F8 56 E0 EF 29 96 7B B1 67 42 47 BE
0230 | E0 67 89 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001009C6DA0F03FC74CF209ABCA82</code> <code>CEA24A45FFA65FCDFABBC51D0256B841</code> <code>B6878074CA8E267FBEEB8665BEB6379F</code> <code>CE7037EC1BFA4493D42988A5C1327DC0</code> <code>5B96C27778D1932EE617A499259F743A</code> <code>F43D0993DCBCAED1F6AB711649C3C3F8</code> <code>44D98E3A6EA52F73EF4A05EC57054E77</code> <code>4C7497C49B9128F28E3E4391CA3E01CB</code> <code>701721B2A0974ED269EAC14F5CB3966B</code> <code>4F9E7D149AAF769A87BC2FF224798B2B</code> <code>5B32FF3378AE2E4D8A3D31DF9F7F8938</code> <code>B310EE9ADB8784873A60F2641F55E977</code> <code>AC0A24458DF7793980E93043B83EC70D</code> <code>890E43B822CF040FDD57081C1B943396</code> <code>C7A5C26338FA2E66BF0022EE1A6371DC</code> <code>D48CDF22763BF6DEF856E0EF29967BB1</code><br> <code>674247BE</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>E0678966</code> (1720281056 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A2D7C1DC092B41FBD4D0E65F7EABB90AFCD1A575A1CDEC150ED971CF3ED1E63B05C18670115E3F0A708C4025E1F398CCDA44AC164696BA35004B06CF50E8656E3AF8D6E055F20D872FEB052CCD5088A106D397C540FF230475D5A5901CC81CE9662928F556189032AED0A56CCAB46C583AC16D9A66104E3BB9FB6B61353BBF0B77DCE83C7ED01280E45362B891CEE149C3505018EDC23486FB7A6062FEFC6BFFD0CB62E359CB7FCF95657A7CBF85C1F52F21BCD24166AA1A93F252E24736F65632AC73D3116EF7BE9317F066C3AC825789BCAF0DFA55AFA4D23AC25C5BA2C1E95C21927D8FBCC78F5163F2393239BFAB48537ECB8A9433030CE6925259AF3F60</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = AB97981E05567552D981606DB53FBBF54BA7A999809FDD0D0F7D023B0AD846125C39BD0B323331C71302945CFD5E5A66E1F48265E88A17A465B647DD0B14142A80AFC44E8DC7A6ECE7A48BC6F4111FA9E4CDACCD8C8E92CFBC7149B93EB362B32EB02BA9789DAF248B7335406C3891931568181BD54EF08F303430E234AA21251284A2C40D52001DF41AC3ED1A5BB83723C554B767EF2DD9B4B18ADD9AB24F9F2499084BA67D9A6D72516AA4D205113581B60E3BC8AB76530B1D00D6931FD4AAEBE4930F18C10005D935C6BC991EC46A942396C693D5224713AC74720D4EA2B784F9B47C2472CA9148C8C2CF227856FB2D226BA5BE424BD517D3A2093761C10A</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 24 51 93 B7 F5 9B 5B BC 8C C5 6C B6
0010 | 43 18 20 22 12 38 54 3A 19 42 67 BC 53 14 82 A7
0020 | E3 C2 ED 64 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | AB 97 98 1E 05 56 75 52 D9 81 60 6D B5 3F BB F5
0040 | 4B A7 A9 99 80 9F DD 0D 0F 7D 02 3B 0A D8 46 12
0050 | 5C 39 BD 0B 32 33 31 C7 13 02 94 5C FD 5E 5A 66
0060 | E1 F4 82 65 E8 8A 17 A4 65 B6 47 DD 0B 14 14 2A
0070 | 80 AF C4 4E 8D C7 A6 EC E7 A4 8B C6 F4 11 1F A9
0080 | E4 CD AC CD 8C 8E 92 CF BC 71 49 B9 3E B3 62 B3
0090 | 2E B0 2B A9 78 9D AF 24 8B 73 35 40 6C 38 91 93
00A0 | 15 68 18 1B D5 4E F0 8F 30 34 30 E2 34 AA 21 25
00B0 | 12 84 A2 C4 0D 52 00 1D F4 1A C3 ED 1A 5B B8 37
00C0 | 23 C5 54 B7 67 EF 2D D9 B4 B1 8A DD 9A B2 4F 9F
00D0 | 24 99 08 4B A6 7D 9A 6D 72 51 6A A4 D2 05 11 35
00E0 | 81 B6 0E 3B C8 AB 76 53 0B 1D 00 D6 93 1F D4 AA
00F0 | EB E4 93 0F 18 C1 00 05 D9 35 C6 BC 99 1E C4 6A
0100 | 94 23 96 C6 93 D5 22 47 13 AC 74 72 0D 4E A2 B7
0110 | 84 F9 B4 7C 24 72 CA 91 48 C8 C2 CF 22 78 56 FB
0120 | 2D 22 6B A5 BE 42 4B D5 17 D3 A2 09 37 61 C1 0A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100AB97981E05567552D981606D</code> <code>B53FBBF54BA7A999809FDD0D0F7D023B</code> <code>0AD846125C39BD0B323331C71302945C</code> <code>FD5E5A66E1F48265E88A17A465B647DD</code> <code>0B14142A80AFC44E8DC7A6ECE7A48BC6</code> <code>F4111FA9E4CDACCD8C8E92CFBC7149B9</code> <code>3EB362B32EB02BA9789DAF248B733540</code> <code>6C3891931568181BD54EF08F303430E2</code> <code>34AA21251284A2C40D52001DF41AC3ED</code> <code>1A5BB83723C554B767EF2DD9B4B18ADD</code> <code>9AB24F9F2499084BA67D9A6D72516AA4</code> <code>D205113581B60E3BC8AB76530B1D00D6</code> <code>931FD4AAEBE4930F18C10005D935C6BC</code> <code>991EC46A942396C693D5224713AC7472</code> <code>0D4EA2B784F9B47C2472CA9148C8C2CF</code> <code>227856FB2D226BA5BE424BD517D3A209</code><br> <code>3761C10A</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366245193B7F59B5BBC8CC56CB6431820221238543A194267BC531482A7E3C2ED640000000000000000FE000100AB97981E05567552D981606DB53FBBF54BA7A999809FDD0D0F7D023B0AD846125C39BD0B323331C71302945CFD5E5A66E1F48265E88A17A465B647DD0B14142A80AFC44E8DC7A6ECE7A48BC6F4111FA9E4CDACCD8C8E92CFBC7149B93EB362B32EB02BA9789DAF248B7335406C3891931568181BD54EF08F303430E234AA21251284A2C40D52001DF41AC3ED1A5BB83723C554B767EF2DD9B4B18ADD9AB24F9F2499084BA67D9A6D72516AA4D205113581B60E3BC8AB76530B1D00D6931FD4AAEBE4930F18C10005D935C6BC991EC46A942396C693D5224713AC74720D4EA2B784F9B47C2472CA9148C8C2CF227856FB2D226BA5BE424BD517D3A2093761C10A
padding = A9110132D6F262C66402E6D7
tmp_aes_key = EB1DEED079C861DCBB389AFC13961A14C1DFD95EED5800484B54AE157EB980B0
tmp_aes_iv = 804327EBEF76C86A7C81ACD8E82F02EDF3F5DEE0FE475FA0A8697D2C6155ECC9</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 5E5CFE20CCB74AE7EB61E477571FF7A76D881352C1EB1B4FD8ED80B64FDFC256B6DE061C89BB387BFECCD39D8BFEA22D8EED63984DF8980F9BF2BBF1BFDAE37F897C24BFBCCE51A8D6AD15D27EF6FBA49041432A88408B0A9E4922F9B27262A4D231CE27CEFE86C6FA15A87FA48E53C4599D315E9B3B988F054E6D6AE76CA08CCDB9F3AD12646E05C4A42D8F6BF3ADDE0D5F0388C762EE8F7454A34B3CC9854843EEC9C090AE6D74A75FA397F20C6A451B1A90DB330E15474ADB94F18AC80237E5C46B4CD9F3628BDA267948535103BEB5B8E22DF2A0C8DFC236DF0C800A36FA23FF3BB057BF33162DE271D73795BDCE094DCC02F8840022D220F4FBD89DF86E561F75C2407342BFF8C70C1E4FD2F47DDBC2866BF6F22DE9E6BFCBB502D534F75602C0305EB9E26BA03835923339B159D894DC36D1C3F9B6863FC197E5632D2495863AF73434B30F795FC44934EFF107</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 BC 00 00 E0 67 89 66
0010 | 78 01 00 00 1F 5F 04 F5 24 51 93 B7 F5 9B 5B BC
0020 | 8C C5 6C B6 43 18 20 22 12 38 54 3A 19 42 67 BC
0030 | 53 14 82 A7 E3 C2 ED 64 FE 50 01 00 5E 5C FE 20
0040 | CC B7 4A E7 EB 61 E4 77 57 1F F7 A7 6D 88 13 52
0050 | C1 EB 1B 4F D8 ED 80 B6 4F DF C2 56 B6 DE 06 1C
0060 | 89 BB 38 7B FE CC D3 9D 8B FE A2 2D 8E ED 63 98
0070 | 4D F8 98 0F 9B F2 BB F1 BF DA E3 7F 89 7C 24 BF
0080 | BC CE 51 A8 D6 AD 15 D2 7E F6 FB A4 90 41 43 2A
0090 | 88 40 8B 0A 9E 49 22 F9 B2 72 62 A4 D2 31 CE 27
00A0 | CE FE 86 C6 FA 15 A8 7F A4 8E 53 C4 59 9D 31 5E
00B0 | 9B 3B 98 8F 05 4E 6D 6A E7 6C A0 8C CD B9 F3 AD
00C0 | 12 64 6E 05 C4 A4 2D 8F 6B F3 AD DE 0D 5F 03 88
00D0 | C7 62 EE 8F 74 54 A3 4B 3C C9 85 48 43 EE C9 C0
00E0 | 90 AE 6D 74 A7 5F A3 97 F2 0C 6A 45 1B 1A 90 DB
00F0 | 33 0E 15 47 4A DB 94 F1 8A C8 02 37 E5 C4 6B 4C
0100 | D9 F3 62 8B DA 26 79 48 53 51 03 BE B5 B8 E2 2D
0110 | F2 A0 C8 DF C2 36 DF 0C 80 0A 36 FA 23 FF 3B B0
0120 | 57 BF 33 16 2D E2 71 D7 37 95 BD CE 09 4D CC 02
0130 | F8 84 00 22 D2 20 F4 FB D8 9D F8 6E 56 1F 75 C2
0140 | 40 73 42 BF F8 C7 0C 1E 4F D2 F4 7D DB C2 86 6B
0150 | F6 F2 2D E9 E6 BF CB B5 02 D5 34 F7 56 02 C0 30
0160 | 5E B9 E2 6B A0 38 35 92 33 39 B1 59 D8 94 DC 36
0170 | D1 C3 F9 B6 86 3F C1 97 E5 63 2D 24 95 86 3A F7
0180 | 34 34 B3 0F 79 5F C4 49 34 EF F1 07</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A8BC0000E0678966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001005E5CFE20CCB74AE7EB61E477</code> <code>571FF7A76D881352C1EB1B4FD8ED80B6</code> <code>4FDFC256B6DE061C89BB387BFECCD39D</code> <code>8BFEA22D8EED63984DF8980F9BF2BBF1</code> <code>BFDAE37F897C24BFBCCE51A8D6AD15D2</code> <code>7EF6FBA49041432A88408B0A9E4922F9</code> <code>B27262A4D231CE27CEFE86C6FA15A87F</code> <code>A48E53C4599D315E9B3B988F054E6D6A</code> <code>E76CA08CCDB9F3AD12646E05C4A42D8F</code> <code>6BF3ADDE0D5F0388C762EE8F7454A34B</code> <code>3CC9854843EEC9C090AE6D74A75FA397</code> <code>F20C6A451B1A90DB330E15474ADB94F1</code> <code>8AC80237E5C46B4CD9F3628BDA267948</code> <code>535103BEB5B8E22DF2A0C8DFC236DF0C</code> <code>800A36FA23FF3BB057BF33162DE271D7</code> <code>3795BDCE094DCC02F8840022D220F4FB</code> <code>D89DF86E561F75C2407342BFF8C70C1E</code> <code>4FD2F47DDBC2866BF6F22DE9E6BFCBB5</code> <code>02D534F75602C0305EB9E26BA0383592</code> <code>3339B159D894DC36D1C3F9B6863FC197</code> <code>E5632D2495863AF73434B30F795FC449</code><br> <code>34EFF107</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = B2C082716DA83CFB3B63671D483EB079F74DBE33917A58E9D8DC8E04B0D30BDAB6321024875EF8E9EC124947A91814469CEE3376C801EBF4E5E49D6AEAC827B08D992641035D7A2E31856D880A770ACFBD2278886DF12EA1F71FEB4C34A8AFC9DEAE2652550ADD221B5E5EB2ABA8E316C45D2875788BE138B71BC3B1FFD8428453E979864B9DCB806041EF6609A6A514C41FCC59F8EE69FD463B477CF39F76F15694F4535C07D67C9DA807ED13426CE2D96B51053864FCBF036A5F017AE5FDE4C8AE9BA8C23E6876EE168E0AE10143B153F093E450A15A1122BBA787A0ACD0F4DF12FC9EB49577C6C3FD5700FA4E136AF529215629B1777E178B4F0399F4862B</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 8C E5 CF E0 67 89 66
0010 | B0 00 00 00 34 F7 CB 3B 24 51 93 B7 F5 9B 5B BC
0020 | 8C C5 6C B6 43 18 20 22 12 38 54 3A 19 42 67 BC
0030 | 53 14 82 A7 E3 C2 ED 64 11 D9 18 9A F2 62 02 34
0040 | 5F 84 29 79 BB A1 8A DA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018CE5CFE0678966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B0000000</code> (176 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>245193B7F59B5BBC8CC56CB643182022</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1238543A194267BC531482A7E3C2ED64</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>11D9189AF26202345F842979BBA18ADA</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

