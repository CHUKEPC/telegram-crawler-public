<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 58 5D 0D 00 1B 49 DD 68
0010 | 14 00 00 00 F1 8E 7E BE E6 C3 09 41 21 CA 52 44
0020 | 13 FA AA 48 83 C3 B0 EE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>585D0D001B49DD68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 4C 8B 63 1B 49 DD 68
0010 | 50 00 00 00 63 24 16 05 E6 C3 09 41 21 CA 52 44
0020 | 13 FA AA 48 83 C3 B0 EE 6F 7F CA 54 E1 7F 38 09
0030 | 95 22 B1 9E C6 02 9B 05 08 16 FF B6 E6 E9 83 EF
0040 | 83 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>014C8B631B49DD68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0816FFB6E6E983EF83000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1657244290772103043</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1657244290772103043</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1657244290772103043 = 1078144657 * 1537126099</code></p>
<pre><code>p = 1078144657
q = 1537126099</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 FF B6 E6 E9 83 EF 83 00 00 00
0010 | 04 40 43 2E 91 00 00 00 04 5B 9E AE D3 00 00 00
0020 | E6 C3 09 41 21 CA 52 44 13 FA AA 48 83 C3 B0 EE
0030 | 6F 7F CA 54 E1 7F 38 09 95 22 B1 9E C6 02 9B 05
0040 | 5D 1A 2B F1 84 35 CB 2D 49 01 F0 E3 83 E5 D6 11
0050 | 9B F9 3E D0 08 B1 EB 5E 95 5F 71 65 93 F5 AC 89
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0816FFB6E6E983EF83000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1657244290772103043</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0440432E91000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1078144657</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045B9EAED3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1537126099</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>5D1A2BF18435CB2D4901F0E383E5D611</code> <code>9BF93ED008B1EB5E955F716593F5AC89</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90816FFB6E6E983EF830000000440432E91000000045B9EAED3000000E6C3094121CA524413FAAA4883C3B0EE6F7FCA54E17F38099522B19EC6029B055D1A2BF18435CB2D4901F0E383E5D6119BF93ED008B1EB5E955F716593F5AC8902000000
random_padding_bytes = 6266173F56B00EB7D769347D5204BE3472380B229BC9342600A0B5453F7DA27C1492E9022DE81486E0A3C9B24DE2C70A2C978E980B60D78A2EACCB6597FA9F5FC0B69CCA5B77738BB8EB8F18AE7285D746692B8836F2F6BDA35D8D75</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 49DA2C33BD9B8854AF95BB00872164CDE13C6BEC7F9D8AE9D28F27A74112DD833BCA4BEB514412A7B11F9EC3D6FC72781860B5DC44C6C5ED5D9D273D16D0781F0E8B47AB0648BCC9E4D006CEEB917722FABC5A56E2EFF42765C12739427777358AFC5E60A36838439E1CAF5E4E1F54CBA10F951C4A80AA779B94F84211B6E4C7C3DD6C2E8DF9F5E4C74570582676BD3D3D9D611EAB8AE692D40B02032BD9EFD724054CCA9DB69AD4AEBFF15BA2913156DD2A9C3F41391EEF7B283D656381BDF846AF6C952CE08B5CD20D822CEBB1249E5012655351DE4C60B2ED2668DFC26AE2DD2B7F08612B8C7251F95D7644771FC06E33C4BD2AF5DBDBF44D30B7B5F67599</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 5C 5D 0D 00 1B 49 DD 68
0010 | 40 01 00 00 BE E4 12 D7 E6 C3 09 41 21 CA 52 44
0020 | 13 FA AA 48 83 C3 B0 EE 6F 7F CA 54 E1 7F 38 09
0030 | 95 22 B1 9E C6 02 9B 05 04 40 43 2E 91 00 00 00
0040 | 04 5B 9E AE D3 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 49 DA 2C 33 BD 9B 88 54 AF 95 BB 00
0060 | 87 21 64 CD E1 3C 6B EC 7F 9D 8A E9 D2 8F 27 A7
0070 | 41 12 DD 83 3B CA 4B EB 51 44 12 A7 B1 1F 9E C3
0080 | D6 FC 72 78 18 60 B5 DC 44 C6 C5 ED 5D 9D 27 3D
0090 | 16 D0 78 1F 0E 8B 47 AB 06 48 BC C9 E4 D0 06 CE
00A0 | EB 91 77 22 FA BC 5A 56 E2 EF F4 27 65 C1 27 39
00B0 | 42 77 77 35 8A FC 5E 60 A3 68 38 43 9E 1C AF 5E
00C0 | 4E 1F 54 CB A1 0F 95 1C 4A 80 AA 77 9B 94 F8 42
00D0 | 11 B6 E4 C7 C3 DD 6C 2E 8D F9 F5 E4 C7 45 70 58
00E0 | 26 76 BD 3D 3D 9D 61 1E AB 8A E6 92 D4 0B 02 03
00F0 | 2B D9 EF D7 24 05 4C CA 9D B6 9A D4 AE BF F1 5B
0100 | A2 91 31 56 DD 2A 9C 3F 41 39 1E EF 7B 28 3D 65
0110 | 63 81 BD F8 46 AF 6C 95 2C E0 8B 5C D2 0D 82 2C
0120 | EB B1 24 9E 50 12 65 53 51 DE 4C 60 B2 ED 26 68
0130 | DF C2 6A E2 DD 2B 7F 08 61 2B 8C 72 51 F9 5D 76
0140 | 44 77 1F C0 6E 33 C4 BD 2A F5 DB DB F4 4D 30 B7
0150 | B5 F6 75 99</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>5C5D0D001B49DD68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0440432E91000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1078144657</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045B9EAED3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1537126099</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010049DA2C33BD9B8854AF95BB00</code> <code>872164CDE13C6BEC7F9D8AE9D28F27A7</code> <code>4112DD833BCA4BEB514412A7B11F9EC3</code> <code>D6FC72781860B5DC44C6C5ED5D9D273D</code> <code>16D0781F0E8B47AB0648BCC9E4D006CE</code> <code>EB917722FABC5A56E2EFF42765C12739</code> <code>427777358AFC5E60A36838439E1CAF5E</code> <code>4E1F54CBA10F951C4A80AA779B94F842</code> <code>11B6E4C7C3DD6C2E8DF9F5E4C7457058</code> <code>2676BD3D3D9D611EAB8AE692D40B0203</code> <code>2BD9EFD724054CCA9DB69AD4AEBFF15B</code> <code>A2913156DD2A9C3F41391EEF7B283D65</code> <code>6381BDF846AF6C952CE08B5CD20D822C</code> <code>EBB1249E5012655351DE4C60B2ED2668</code> <code>DFC26AE2DD2B7F08612B8C7251F95D76</code> <code>44771FC06E33C4BD2AF5DBDBF44D30B7</code><br> <code>B5F67599</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 50 E1 89 1B 49 DD 68
0010 | 78 02 00 00 5C 07 E8 D0 E6 C3 09 41 21 CA 52 44
0020 | 13 FA AA 48 83 C3 B0 EE 6F 7F CA 54 E1 7F 38 09
0030 | 95 22 B1 9E C6 02 9B 05 FE 50 02 00 D9 D7 F8 80
0040 | CA FC 5E AF BA 8D EE 9E D4 B7 BF 58 9C F3 8D 25
0050 | 7F C5 15 7B 04 C1 8D 68 30 1D E9 39 5D F2 6B 40
0060 | 93 B5 40 E7 74 11 68 5B 59 01 27 D5 48 06 13 9D
0070 | BE 08 8E 8F 0A 46 7B 20 C0 7D 2C 5A A9 27 DD 6C
0080 | 63 B7 25 B5 BA A1 10 8B E8 DF 76 14 25 93 F8 AF
0090 | 1F 09 A3 BB E1 EA 17 25 BF 00 0D 76 72 67 22 9C
00A0 | CB 73 27 65 42 B9 AD 0D 58 45 26 99 37 23 E5 64
00B0 | 8B F0 F9 49 F0 F6 45 B2 F0 3B D2 59 27 FE A3 9F
00C0 | 99 91 51 D8 AC 43 65 3B 9A 97 2E 28 7E AC 04 78
00D0 | 0D A3 91 16 AE C5 EA AB F4 BC 29 FC 46 1C BE 99
00E0 | B1 44 D8 1D CC 60 EB DD 13 31 E8 D5 2C 6E E4 3B
00F0 | 4D A0 D7 3F 0B DF 77 CE 12 7B B5 24 62 1D 3C CA
0100 | 76 2D FC 26 E8 A4 91 70 56 D2 A9 70 68 88 92 B9
0110 | AA 6D 30 7D F5 BF 40 4E 38 84 A8 9C 62 B0 C4 A6
0120 | 80 0C EF DA 88 B2 69 51 07 8A CD 0E 5B 64 C0 4E
0130 | CF A8 F0 2B 75 35 8C B3 89 30 90 72 F0 2A 7B DA
0140 | E3 1B 59 41 EE 88 19 27 F9 04 22 9F 8F 24 29 53
0150 | 97 0D 16 55 EE 9A E7 14 0C 23 CE 2A F3 97 25 B3
0160 | F9 B2 48 B5 76 62 45 62 18 34 AD A9 6D A9 28 1B
0170 | 29 75 9B 72 17 6F FB 17 39 9F 20 2E D2 EF AA C8
0180 | 36 6B F2 0C AB 0B 4B EC E5 EC 85 D3 69 D1 28 86
0190 | 5C 21 9E 21 F1 08 6E 8F B7 19 C5 2E C5 24 5A 9D
01A0 | 02 D1 76 34 BD 56 64 85 B5 3A 6A 2C E2 72 BF 5C
01B0 | 79 2C BA 43 2A 04 3C CD 3C 4A C5 27 2A A6 F1 AA
01C0 | 25 60 DD 4D 25 9E 01 B4 49 A0 3F D5 C4 C7 B5 93
01D0 | 4D 7B C2 3F 14 C0 A9 E5 DB 19 B4 20 87 85 26 72
01E0 | C7 E1 CF 9E 10 2E F5 D7 8F D4 B9 4D E2 D3 CF 59
01F0 | C3 E3 08 E0 7A 3E 75 C2 C8 8A 6E C3 59 74 0A 88
0200 | EC F0 0F 32 96 DB CE FA 6B B7 78 B7 E2 EE AE CB
0210 | 79 CC 97 51 F5 09 12 52 F0 A6 D0 7A 9B 78 69 9E
0220 | C7 84 F2 1F 24 F2 54 0D BF 59 29 E8 4E 3D B7 C4
0230 | 8D 9D BE E0 19 1F 92 E6 5B 2C 8E F0 86 8B CC 71
0240 | 7C EC 5F BD BE 58 76 FA CC 68 9B 22 3D 45 39 10
0250 | 83 DA 1A C4 30 E3 90 3D 7B 00 50 8F 3D EC C8 75
0260 | ED 66 DB B9 2A C6 6F BF 17 C0 ED 05 D3 44 BE 13
0270 | EA 75 C7 DC 3A 2B CB 15 8A C3 46 30 D2 DB FF BD
0280 | F0 F9 DD 02 87 5B F5 2B 2C 50 D3 CF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0150E1891B49DD68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200D9D7F880CAFC5EAFBA8DEE9E</code> <code>D4B7BF589CF38D257FC5157B04C18D68</code> <code>301DE9395DF26B4093B540E77411685B</code> <code>590127D54806139DBE088E8F0A467B20</code> <code>C07D2C5AA927DD6C63B725B5BAA1108B</code> <code>E8DF76142593F8AF1F09A3BBE1EA1725</code> <code>BF000D767267229CCB73276542B9AD0D</code> <code>584526993723E5648BF0F949F0F645B2</code> <code>F03BD25927FEA39F999151D8AC43653B</code> <code>9A972E287EAC04780DA39116AEC5EAAB</code> <code>F4BC29FC461CBE99B144D81DCC60EBDD</code> <code>1331E8D52C6EE43B4DA0D73F0BDF77CE</code> <code>127BB524621D3CCA762DFC26E8A49170</code> <code>56D2A970688892B9AA6D307DF5BF404E</code> <code>3884A89C62B0C4A6800CEFDA88B26951</code> <code>078ACD0E5B64C04ECFA8F02B75358CB3</code> <code>89309072F02A7BDAE31B5941EE881927</code> <code>F904229F8F242953970D1655EE9AE714</code> <code>0C23CE2AF39725B3F9B248B576624562</code> <code>1834ADA96DA9281B29759B72176FFB17</code> <code>399F202ED2EFAAC8366BF20CAB0B4BEC</code> <code>E5EC85D369D128865C219E21F1086E8F</code> <code>B719C52EC5245A9D02D17634BD566485</code> <code>B53A6A2CE272BF5C792CBA432A043CCD</code> <code>3C4AC5272AA6F1AA2560DD4D259E01B4</code> <code>49A03FD5C4C7B5934D7BC23F14C0A9E5</code> <code>DB19B42087852672C7E1CF9E102EF5D7</code> <code>8FD4B94DE2D3CF59C3E308E07A3E75C2</code> <code>C88A6EC359740A88ECF00F3296DBCEFA</code> <code>6BB778B7E2EEAECB79CC9751F5091252</code> <code>F0A6D07A9B78699EC784F21F24F2540D</code> <code>BF5929E84E3DB7C48D9DBEE0191F92E6</code> <code>5B2C8EF0868BCC717CEC5FBDBE5876FA</code> <code>CC689B223D45391083DA1AC430E3903D</code> <code>7B00508F3DECC875ED66DBB92AC66FBF</code> <code>17C0ED05D344BE13EA75C7DC3A2BCB15</code> <code>8AC34630D2DBFFBDF0F9DD02875BF52B</code><br> <code>2C50D3CF</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = D9D7F880CAFC5EAFBA8DEE9ED4B7BF589CF38D257FC5157B04C18D68301DE9395DF26B4093B540E77411685B590127D54806139DBE088E8F0A467B20C07D2C5AA927DD6C63B725B5BAA1108BE8DF76142593F8AF1F09A3BBE1EA1725BF000D767267229CCB73276542B9AD0D584526993723E5648BF0F949F0F645B2F03BD25927FEA39F999151D8AC43653B9A972E287EAC04780DA39116AEC5EAABF4BC29FC461CBE99B144D81DCC60EBDD1331E8D52C6EE43B4DA0D73F0BDF77CE127BB524621D3CCA762DFC26E8A4917056D2A970688892B9AA6D307DF5BF404E3884A89C62B0C4A6800CEFDA88B26951078ACD0E5B64C04ECFA8F02B75358CB389309072F02A7BDAE31B5941EE881927F904229F8F242953970D1655EE9AE7140C23CE2AF39725B3F9B248B5766245621834ADA96DA9281B29759B72176FFB17399F202ED2EFAAC8366BF20CAB0B4BECE5EC85D369D128865C219E21F1086E8FB719C52EC5245A9D02D17634BD566485B53A6A2CE272BF5C792CBA432A043CCD3C4AC5272AA6F1AA2560DD4D259E01B449A03FD5C4C7B5934D7BC23F14C0A9E5DB19B42087852672C7E1CF9E102EF5D78FD4B94DE2D3CF59C3E308E07A3E75C2C88A6EC359740A88ECF00F3296DBCEFA6BB778B7E2EEAECB79CC9751F5091252F0A6D07A9B78699EC784F21F24F2540DBF5929E84E3DB7C48D9DBEE0191F92E65B2C8EF0868BCC717CEC5FBDBE5876FACC689B223D45391083DA1AC430E3903D7B00508F3DECC875ED66DBB92AC66FBF17C0ED05D344BE13EA75C7DC3A2BCB158AC34630D2DBFFBDF0F9DD02875BF52B2C50D3CF
tmp_aes_key = 0FAEA1E996A2F2F55CA5CCADCE613B9B14CF39B986BF7B22CF3B213FFA526FB1
tmp_aes_iv = 9A1E248EFE22DCD042691B6498C5FF9561CF848EEFF9842DA32D812D5D1A2BF1</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 295B10918FF6960FC26EB9FEC6D4B61531E44691BA0D89B5E6C3094121CA524413FAAA4883C3B0EE6F7FCA54E17F38099522B19EC6029B0503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BE9C0A266E188DED22E06E12D3D74CD7EA7B5479A41487A6068877352D179379C2FA9E6D9578E28FC893A18B726B80AA644602255CBB92CC87A1BBDE1B94AA510CDA6EA82DD25A7D64EF3EB94E7E1AFDD38068C46260245B3C1E32F597A026A2D6EDBC10A93F997219CD880C0C0DD61B754B0207D675BACA7E109E26085CD2E40478D473C70CACF2B8CE7D7CC79114470E667AD5D7DA9BB84180AD65000F78645E7912937A4BB9B82B39B4F25B4CF6C9A1E4A0FC9B29DE504D8212E9301094B1B644A50FA836FCC2E29172DD3C4E7F61C2E52A0E783B365E0E0F55E0AED9C2A48B55C97AF52E34F2742A99345073C00BE831C6BCCD5972D29394ED4CE68A34471B49DD68844E73C31D8E735F
answer = BA0D89B5E6C3094121CA524413FAAA4883C3B0EE6F7FCA54E17F38099522B19EC6029B0503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BE9C0A266E188DED22E06E12D3D74CD7EA7B5479A41487A6068877352D179379C2FA9E6D9578E28FC893A18B726B80AA644602255CBB92CC87A1BBDE1B94AA510CDA6EA82DD25A7D64EF3EB94E7E1AFDD38068C46260245B3C1E32F597A026A2D6EDBC10A93F997219CD880C0C0DD61B754B0207D675BACA7E109E26085CD2E40478D473C70CACF2B8CE7D7CC79114470E667AD5D7DA9BB84180AD65000F78645E7912937A4BB9B82B39B4F25B4CF6C9A1E4A0FC9B29DE504D8212E9301094B1B644A50FA836FCC2E29172DD3C4E7F61C2E52A0E783B365E0E0F55E0AED9C2A48B55C97AF52E34F2742A99345073C00BE831C6BCCD5972D29394ED4CE68A34471B49DD68844E73C31D8E735F</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E6 C3 09 41 21 CA 52 44 13 FA AA 48
0010 | 83 C3 B0 EE 6F 7F CA 54 E1 7F 38 09 95 22 B1 9E
0020 | C6 02 9B 05 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | BE 9C 0A 26 6E 18 8D ED 22 E0 6E 12 D3 D7 4C D7
0140 | EA 7B 54 79 A4 14 87 A6 06 88 77 35 2D 17 93 79
0150 | C2 FA 9E 6D 95 78 E2 8F C8 93 A1 8B 72 6B 80 AA
0160 | 64 46 02 25 5C BB 92 CC 87 A1 BB DE 1B 94 AA 51
0170 | 0C DA 6E A8 2D D2 5A 7D 64 EF 3E B9 4E 7E 1A FD
0180 | D3 80 68 C4 62 60 24 5B 3C 1E 32 F5 97 A0 26 A2
0190 | D6 ED BC 10 A9 3F 99 72 19 CD 88 0C 0C 0D D6 1B
01A0 | 75 4B 02 07 D6 75 BA CA 7E 10 9E 26 08 5C D2 E4
01B0 | 04 78 D4 73 C7 0C AC F2 B8 CE 7D 7C C7 91 14 47
01C0 | 0E 66 7A D5 D7 DA 9B B8 41 80 AD 65 00 0F 78 64
01D0 | 5E 79 12 93 7A 4B B9 B8 2B 39 B4 F2 5B 4C F6 C9
01E0 | A1 E4 A0 FC 9B 29 DE 50 4D 82 12 E9 30 10 94 B1
01F0 | B6 44 A5 0F A8 36 FC C2 E2 91 72 DD 3C 4E 7F 61
0200 | C2 E5 2A 0E 78 3B 36 5E 0E 0F 55 E0 AE D9 C2 A4
0210 | 8B 55 C9 7A F5 2E 34 F2 74 2A 99 34 50 73 C0 0B
0220 | E8 31 C6 BC CD 59 72 D2 93 94 ED 4C E6 8A 34 47
0230 | 1B 49 DD 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100BE9C0A266E188DED22E06E12</code> <code>D3D74CD7EA7B5479A41487A606887735</code> <code>2D179379C2FA9E6D9578E28FC893A18B</code> <code>726B80AA644602255CBB92CC87A1BBDE</code> <code>1B94AA510CDA6EA82DD25A7D64EF3EB9</code> <code>4E7E1AFDD38068C46260245B3C1E32F5</code> <code>97A026A2D6EDBC10A93F997219CD880C</code> <code>0C0DD61B754B0207D675BACA7E109E26</code> <code>085CD2E40478D473C70CACF2B8CE7D7C</code> <code>C79114470E667AD5D7DA9BB84180AD65</code> <code>000F78645E7912937A4BB9B82B39B4F2</code> <code>5B4CF6C9A1E4A0FC9B29DE504D8212E9</code> <code>301094B1B644A50FA836FCC2E29172DD</code> <code>3C4E7F61C2E52A0E783B365E0E0F55E0</code> <code>AED9C2A48B55C97AF52E34F2742A9934</code> <code>5073C00BE831C6BCCD5972D29394ED4C</code><br> <code>E68A3447</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>1B49DD68</code> (1759332635 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = E8BD64F4A25FAD408A67FFE8640568505D009292A0B448DAE314397DDBBC9E896947A38D3307B2DF2B8A6C3D83325E36DAC34F4E8D65CC37E6BC13FA3C96F455F484FED40555BC55CC0A5ECB8A338177EA5F49EF9BA7C8105E9D82A6C04BF7420AFB2C00319B429C8CF92D7210473E5E23B67A04B6B13E70C77EE7DB8102883B038F633D0C138E671212089E1C82C8516F95CECB3042587E17829C6B3909F33698C1757E052E20A3DD03CFF0B90F7A98749EF5B01C37D19249B404DE4FF08BA67919AF41B226387C67F4CBBC31F6A14E7E7B00B98A1AC5D9654206BB37CC4AAAD06EFDF457D030E3305E2A4463D1D7FE26786389B50A4CDF59DBAFEEA3EBDB03</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4F989998D184E53742D52A0EFA0702D1A14FD934A04C128EF05EFA53F0556A6BE2C136177AB76DA552850BA7AB633FD65FAD3F349204603D21DB83F0E6355E47395A855E7EE72311DA9756F78ECE342258FA2FAFBD4C9024EB3381B567F119BF2B839B20E1B10B61B656C73CA069594E28871B22AC2957780AD8E9110A77DEB89E7FAF4EAF4A5E8F22C61F6B23AFCA29E9516352D0BD7D39EF6A0AA68056FD879207F7E69B15A65D53F0161986847BB4237AE1473F3D33C6E0836401D538F68DAEA3406D5D1CF0A185EBFC169E1202B0C2A51F0B6A5857CB5135AA040DA12592584B1C2B10559D40C5E01250DD9CA82725202B9DAF5D9C554A6DFA8B4E77EC98</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E6 C3 09 41 21 CA 52 44 13 FA AA 48
0010 | 83 C3 B0 EE 6F 7F CA 54 E1 7F 38 09 95 22 B1 9E
0020 | C6 02 9B 05 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 4F 98 99 98 D1 84 E5 37 42 D5 2A 0E FA 07 02 D1
0040 | A1 4F D9 34 A0 4C 12 8E F0 5E FA 53 F0 55 6A 6B
0050 | E2 C1 36 17 7A B7 6D A5 52 85 0B A7 AB 63 3F D6
0060 | 5F AD 3F 34 92 04 60 3D 21 DB 83 F0 E6 35 5E 47
0070 | 39 5A 85 5E 7E E7 23 11 DA 97 56 F7 8E CE 34 22
0080 | 58 FA 2F AF BD 4C 90 24 EB 33 81 B5 67 F1 19 BF
0090 | 2B 83 9B 20 E1 B1 0B 61 B6 56 C7 3C A0 69 59 4E
00A0 | 28 87 1B 22 AC 29 57 78 0A D8 E9 11 0A 77 DE B8
00B0 | 9E 7F AF 4E AF 4A 5E 8F 22 C6 1F 6B 23 AF CA 29
00C0 | E9 51 63 52 D0 BD 7D 39 EF 6A 0A A6 80 56 FD 87
00D0 | 92 07 F7 E6 9B 15 A6 5D 53 F0 16 19 86 84 7B B4
00E0 | 23 7A E1 47 3F 3D 33 C6 E0 83 64 01 D5 38 F6 8D
00F0 | AE A3 40 6D 5D 1C F0 A1 85 EB FC 16 9E 12 02 B0
0100 | C2 A5 1F 0B 6A 58 57 CB 51 35 AA 04 0D A1 25 92
0110 | 58 4B 1C 2B 10 55 9D 40 C5 E0 12 50 DD 9C A8 27
0120 | 25 20 2B 9D AF 5D 9C 55 4A 6D FA 8B 4E 77 EC 98</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004F989998D184E53742D52A0E</code> <code>FA0702D1A14FD934A04C128EF05EFA53</code> <code>F0556A6BE2C136177AB76DA552850BA7</code> <code>AB633FD65FAD3F349204603D21DB83F0</code> <code>E6355E47395A855E7EE72311DA9756F7</code> <code>8ECE342258FA2FAFBD4C9024EB3381B5</code> <code>67F119BF2B839B20E1B10B61B656C73C</code> <code>A069594E28871B22AC2957780AD8E911</code> <code>0A77DEB89E7FAF4EAF4A5E8F22C61F6B</code> <code>23AFCA29E9516352D0BD7D39EF6A0AA6</code> <code>8056FD879207F7E69B15A65D53F01619</code> <code>86847BB4237AE1473F3D33C6E0836401</code> <code>D538F68DAEA3406D5D1CF0A185EBFC16</code> <code>9E1202B0C2A51F0B6A5857CB5135AA04</code> <code>0DA12592584B1C2B10559D40C5E01250</code> <code>DD9CA82725202B9DAF5D9C554A6DFA8B</code><br> <code>4E77EC98</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E6C3094121CA524413FAAA4883C3B0EE6F7FCA54E17F38099522B19EC6029B050000000000000000FE0001004F989998D184E53742D52A0EFA0702D1A14FD934A04C128EF05EFA53F0556A6BE2C136177AB76DA552850BA7AB633FD65FAD3F349204603D21DB83F0E6355E47395A855E7EE72311DA9756F78ECE342258FA2FAFBD4C9024EB3381B567F119BF2B839B20E1B10B61B656C73CA069594E28871B22AC2957780AD8E9110A77DEB89E7FAF4EAF4A5E8F22C61F6B23AFCA29E9516352D0BD7D39EF6A0AA68056FD879207F7E69B15A65D53F0161986847BB4237AE1473F3D33C6E0836401D538F68DAEA3406D5D1CF0A185EBFC169E1202B0C2A51F0B6A5857CB5135AA040DA12592584B1C2B10559D40C5E01250DD9CA82725202B9DAF5D9C554A6DFA8B4E77EC98
padding = AEDF30007577379FFD63F4C1
tmp_aes_key = 0FAEA1E996A2F2F55CA5CCADCE613B9B14CF39B986BF7B22CF3B213FFA526FB1
tmp_aes_iv = 9A1E248EFE22DCD042691B6498C5FF9561CF848EEFF9842DA32D812D5D1A2BF1</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 50FE831B8E87371452EF43780CFBC716EC6C31E8FB8761AC415265CA3369789013BE8A71E66ED8CC41020151A3870952548F398E983C08B7BA0962B88494E009C899F3AAEAB20B3F952D5D090EC08D542E39401E132B1F20EB17F4D3A43E7F1DA159CC5B4E1148F2F906AEBFFA8AE08EABA7CCDB797DA46EC365DB14D680DBE87FC3D50798C0775325D02F5845CADD64006D26C64858C044EE4B2D2A9856BEED008CC7EAD6A38DD8C207F9D60B08EB68EBE50C02916CF06259CBCFFA4ACAD938A0DA03FE87A7AAE96D5FB4E9A957FD4FAB53FBF0A987B2E35B7FDDA40AD1A8E220EBB0FA3C7E32B281F7F6D6559B24D768B284288C1564C20C0D83AEDF7BD9D15866F767455F7E0934A1159AC852FE6FDCF369A2C77E5F383F2CCDE46626A2338B25F7D90175ADE73A23843CB627933C654735BBFE45ACFFC5323C7AE171E29F7272EFD3D3013FF29828B4ADBE7EC3D5</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 60 5D 0D 00 1B 49 DD 68
0010 | 78 01 00 00 1F 5F 04 F5 E6 C3 09 41 21 CA 52 44
0020 | 13 FA AA 48 83 C3 B0 EE 6F 7F CA 54 E1 7F 38 09
0030 | 95 22 B1 9E C6 02 9B 05 FE 50 01 00 50 FE 83 1B
0040 | 8E 87 37 14 52 EF 43 78 0C FB C7 16 EC 6C 31 E8
0050 | FB 87 61 AC 41 52 65 CA 33 69 78 90 13 BE 8A 71
0060 | E6 6E D8 CC 41 02 01 51 A3 87 09 52 54 8F 39 8E
0070 | 98 3C 08 B7 BA 09 62 B8 84 94 E0 09 C8 99 F3 AA
0080 | EA B2 0B 3F 95 2D 5D 09 0E C0 8D 54 2E 39 40 1E
0090 | 13 2B 1F 20 EB 17 F4 D3 A4 3E 7F 1D A1 59 CC 5B
00A0 | 4E 11 48 F2 F9 06 AE BF FA 8A E0 8E AB A7 CC DB
00B0 | 79 7D A4 6E C3 65 DB 14 D6 80 DB E8 7F C3 D5 07
00C0 | 98 C0 77 53 25 D0 2F 58 45 CA DD 64 00 6D 26 C6
00D0 | 48 58 C0 44 EE 4B 2D 2A 98 56 BE ED 00 8C C7 EA
00E0 | D6 A3 8D D8 C2 07 F9 D6 0B 08 EB 68 EB E5 0C 02
00F0 | 91 6C F0 62 59 CB CF FA 4A CA D9 38 A0 DA 03 FE
0100 | 87 A7 AA E9 6D 5F B4 E9 A9 57 FD 4F AB 53 FB F0
0110 | A9 87 B2 E3 5B 7F DD A4 0A D1 A8 E2 20 EB B0 FA
0120 | 3C 7E 32 B2 81 F7 F6 D6 55 9B 24 D7 68 B2 84 28
0130 | 8C 15 64 C2 0C 0D 83 AE DF 7B D9 D1 58 66 F7 67
0140 | 45 5F 7E 09 34 A1 15 9A C8 52 FE 6F DC F3 69 A2
0150 | C7 7E 5F 38 3F 2C CD E4 66 26 A2 33 8B 25 F7 D9
0160 | 01 75 AD E7 3A 23 84 3C B6 27 93 3C 65 47 35 BB
0170 | FE 45 AC FF C5 32 3C 7A E1 71 E2 9F 72 72 EF D3
0180 | D3 01 3F F2 98 28 B4 AD BE 7E C3 D5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>605D0D001B49DD68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010050FE831B8E87371452EF4378</code> <code>0CFBC716EC6C31E8FB8761AC415265CA</code> <code>3369789013BE8A71E66ED8CC41020151</code> <code>A3870952548F398E983C08B7BA0962B8</code> <code>8494E009C899F3AAEAB20B3F952D5D09</code> <code>0EC08D542E39401E132B1F20EB17F4D3</code> <code>A43E7F1DA159CC5B4E1148F2F906AEBF</code> <code>FA8AE08EABA7CCDB797DA46EC365DB14</code> <code>D680DBE87FC3D50798C0775325D02F58</code> <code>45CADD64006D26C64858C044EE4B2D2A</code> <code>9856BEED008CC7EAD6A38DD8C207F9D6</code> <code>0B08EB68EBE50C02916CF06259CBCFFA</code> <code>4ACAD938A0DA03FE87A7AAE96D5FB4E9</code> <code>A957FD4FAB53FBF0A987B2E35B7FDDA4</code> <code>0AD1A8E220EBB0FA3C7E32B281F7F6D6</code> <code>559B24D768B284288C1564C20C0D83AE</code> <code>DF7BD9D15866F767455F7E0934A1159A</code> <code>C852FE6FDCF369A2C77E5F383F2CCDE4</code> <code>6626A2338B25F7D90175ADE73A23843C</code> <code>B627933C654735BBFE45ACFFC5323C7A</code> <code>E171E29F7272EFD3D3013FF29828B4AD</code><br> <code>BE7EC3D5</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 71C2FCA56A9D525B84B1DBB2509AF5EA2B1B691E6C9C2F2EB7B03318D92112AB465A31E71572330E982221624418EF89736C1FA38E554681C982FB7225DE470A79B49333013D694C43DA69EDBE7A5797C035D974B66390D8DF84E88E61E281B9A4700328876CEEFE0273CBC2BF5539CB46CECC15E4E46918A007E97918EA6770DB44A379581C4A9313FBC48114D549EE4D37D16012224B6DB215288D785A4527CC66476384DFB4DA8B36D30C10D7BBA57562F17F42A585F21EFA83CDF711FD6DFE207190BB09F6511E92344962656950EE771D01BC796905A99EA40DE479E339BD91203BD0A9E9F7A61C06E047A265CAF86C93C0E76FD4D37955289061730C79</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A8 61 86 1E 49 DD 68
0010 | 34 00 00 00 34 F7 CB 3B E6 C3 09 41 21 CA 52 44
0020 | 13 FA AA 48 83 C3 B0 EE 6F 7F CA 54 E1 7F 38 09
0030 | 95 22 B1 9E C6 02 9B 05 62 5F B9 37 A8 11 C2 4C
0040 | E6 0D A2 6E 88 33 2C 0A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A861861E49DD68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E6C3094121CA524413FAAA4883C3B0EE</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6F7FCA54E17F38099522B19EC6029B05</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>625FB937A811C24CE60DA26E88332C0A</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

