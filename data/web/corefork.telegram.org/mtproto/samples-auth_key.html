<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 AC 08 04 00 13 B0 D6 68
0010 | 14 00 00 00 F1 8E 7E BE DE 16 BA 81 E8 13 52 3B
0020 | 56 F9 6D C9 40 FF 73 77</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>AC08040013B0D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A8 34 37 13 B0 D6 68
0010 | 50 00 00 00 63 24 16 05 DE 16 BA 81 E8 13 52 3B
0020 | 56 F9 6D C9 40 FF 73 77 4C CB B3 2C 1C F0 52 DE
0030 | EB 01 F9 BA 8A 70 50 80 08 13 96 D1 37 FF 88 CA
0040 | 6B 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A8343713B0D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081396D137FF88CA6B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1411545571667790443</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1411545571667790443</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1411545571667790443 = 1041698509 * 1355042327</code></p>
<pre><code>p = 1041698509
q = 1355042327</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 13 96 D1 37 FF 88 CA 6B 00 00 00
0010 | 04 3E 17 0E CD 00 00 00 04 50 C4 4E 17 00 00 00
0020 | DE 16 BA 81 E8 13 52 3B 56 F9 6D C9 40 FF 73 77
0030 | 4C CB B3 2C 1C F0 52 DE EB 01 F9 BA 8A 70 50 80
0040 | 51 7C 15 EC A1 34 62 3A DC A2 DD A7 39 80 23 1A
0050 | F9 88 BC 70 EE A4 70 80 35 19 B6 FE 5C 93 52 34
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081396D137FF88CA6B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1411545571667790443</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043E170ECD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1041698509</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0450C44E17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1355042327</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>517C15ECA134623ADCA2DDA73980231A</code> <code>F988BC70EEA470803519B6FE5C935234</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081396D137FF88CA6B000000043E170ECD0000000450C44E17000000DE16BA81E813523B56F96DC940FF73774CCBB32C1CF052DEEB01F9BA8A705080517C15ECA134623ADCA2DDA73980231AF988BC70EEA470803519B6FE5C93523402000000
random_padding_bytes = BDE76D665510F812DA4ECD9D6376A925DB8AACAAD0AF31367993E959B11A5BEEB8E840FE7CCF0B6566ADA6161B4253F95A938E66C050B30149F050D9F809853F533A1E080E7430CA843C5B259EFE9ED79F1D5588968E7CC7DFA46719</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D35A5F3847546CDB70C2D92667D83D0750145E3360AF37EA79E2A849B43D34C1E888BBE991770482003F25FF9EF781A2C1DB47A7DD14EF0BA27E25A06CE65629B80C3DB71887F9E889E3BDE0FCACCED65A082AB55A6AE8FCB74F90C4B62437AD8C14684AFAAEE879DEF1B75E4BA4A8C6E38005A0129EF8E05517C075457F3264AB32B5D4E7D30B7B4A3BEDE8A691A4DAA9B161DF7A826E38618552E9C1D2A65CEBCF4AC9A2C3A4A67965B617BD7E376B23418507202FAF84C8B130C95142C05F98DD9C04973EF8EA306045C109440E74457A17A2E3B034C22ADA3614552FE9B1302DE2C3D114421C3EF6D631BB2001C384F9BBD13C7E6BC27980774B8FA52475</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 88 58 0E 00 13 B0 D6 68
0010 | 40 01 00 00 BE E4 12 D7 DE 16 BA 81 E8 13 52 3B
0020 | 56 F9 6D C9 40 FF 73 77 4C CB B3 2C 1C F0 52 DE
0030 | EB 01 F9 BA 8A 70 50 80 04 3E 17 0E CD 00 00 00
0040 | 04 50 C4 4E 17 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D3 5A 5F 38 47 54 6C DB 70 C2 D9 26
0060 | 67 D8 3D 07 50 14 5E 33 60 AF 37 EA 79 E2 A8 49
0070 | B4 3D 34 C1 E8 88 BB E9 91 77 04 82 00 3F 25 FF
0080 | 9E F7 81 A2 C1 DB 47 A7 DD 14 EF 0B A2 7E 25 A0
0090 | 6C E6 56 29 B8 0C 3D B7 18 87 F9 E8 89 E3 BD E0
00A0 | FC AC CE D6 5A 08 2A B5 5A 6A E8 FC B7 4F 90 C4
00B0 | B6 24 37 AD 8C 14 68 4A FA AE E8 79 DE F1 B7 5E
00C0 | 4B A4 A8 C6 E3 80 05 A0 12 9E F8 E0 55 17 C0 75
00D0 | 45 7F 32 64 AB 32 B5 D4 E7 D3 0B 7B 4A 3B ED E8
00E0 | A6 91 A4 DA A9 B1 61 DF 7A 82 6E 38 61 85 52 E9
00F0 | C1 D2 A6 5C EB CF 4A C9 A2 C3 A4 A6 79 65 B6 17
0100 | BD 7E 37 6B 23 41 85 07 20 2F AF 84 C8 B1 30 C9
0110 | 51 42 C0 5F 98 DD 9C 04 97 3E F8 EA 30 60 45 C1
0120 | 09 44 0E 74 45 7A 17 A2 E3 B0 34 C2 2A DA 36 14
0130 | 55 2F E9 B1 30 2D E2 C3 D1 14 42 1C 3E F6 D6 31
0140 | BB 20 01 C3 84 F9 BB D1 3C 7E 6B C2 79 80 77 4B
0150 | 8F A5 24 75</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>88580E0013B0D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043E170ECD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1041698509</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0450C44E17000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1355042327</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D35A5F3847546CDB70C2D926</code> <code>67D83D0750145E3360AF37EA79E2A849</code> <code>B43D34C1E888BBE991770482003F25FF</code> <code>9EF781A2C1DB47A7DD14EF0BA27E25A0</code> <code>6CE65629B80C3DB71887F9E889E3BDE0</code> <code>FCACCED65A082AB55A6AE8FCB74F90C4</code> <code>B62437AD8C14684AFAAEE879DEF1B75E</code> <code>4BA4A8C6E38005A0129EF8E05517C075</code> <code>457F3264AB32B5D4E7D30B7B4A3BEDE8</code> <code>A691A4DAA9B161DF7A826E38618552E9</code> <code>C1D2A65CEBCF4AC9A2C3A4A67965B617</code> <code>BD7E376B23418507202FAF84C8B130C9</code> <code>5142C05F98DD9C04973EF8EA306045C1</code> <code>09440E74457A17A2E3B034C22ADA3614</code> <code>552FE9B1302DE2C3D114421C3EF6D631</code> <code>BB2001C384F9BBD13C7E6BC27980774B</code><br> <code>8FA52475</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 38 5D 61 13 B0 D6 68
0010 | 78 02 00 00 5C 07 E8 D0 DE 16 BA 81 E8 13 52 3B
0020 | 56 F9 6D C9 40 FF 73 77 4C CB B3 2C 1C F0 52 DE
0030 | EB 01 F9 BA 8A 70 50 80 FE 50 02 00 E2 F3 87 36
0040 | 91 25 68 BC 95 74 55 DA BF 83 37 0F A0 48 5A 98
0050 | A5 EE A4 00 41 26 A5 37 E3 3B 83 2B 6E 0D CB EB
0060 | BE 6A C7 B1 53 5A 11 FE C2 20 D6 4E 62 8C CD 44
0070 | 19 E3 D1 8F 4F 82 DD B7 2E 43 55 68 4A F1 1E 45
0080 | 59 4A 3F 73 EA 8C 35 57 FC A2 B1 89 62 0C B0 70
0090 | AC 30 6A AA DE 71 1D 64 BE D2 0C A7 E6 4A D8 2C
00A0 | 7E 70 CA 1E BD 84 D7 CA AF 3B 87 43 0C 3D 8B C6
00B0 | 5A 02 09 63 AC 36 FB 5B 3E C9 52 B6 4A CA 13 C2
00C0 | 04 54 CB B3 B1 5F A2 F7 1E A5 2A B7 28 FA C5 CE
00D0 | 5D 75 E1 B8 CA 1F 4E D9 52 D1 DD 30 A0 99 AF 8C
00E0 | 5E 91 98 11 0D 23 15 79 F3 3D F2 C0 7B 1A C6 AD
00F0 | C6 82 16 48 96 A5 66 1C 13 1C 36 5E 98 00 CF 85
0100 | A2 01 44 D6 13 63 65 E4 1B 29 0B 62 FC E9 F1 99
0110 | 44 24 2C 8B 59 D1 FE AE DC 82 A9 17 E1 93 0B 18
0120 | 67 F8 D9 36 FF CB D0 D3 B6 78 18 0C 76 B5 14 ED
0130 | 50 E2 E6 A9 77 87 47 88 DA C5 1F A7 2A C1 E8 AC
0140 | BA 39 AA 7F 86 E6 C9 EA 98 E9 5F 2E D9 E4 68 F3
0150 | 43 D8 A3 D0 36 E3 07 36 41 8B 27 BE 18 CB 27 3B
0160 | A2 19 44 EA 09 99 3C 6E 59 11 B2 C3 1C 8E 02 E5
0170 | 0F EF 45 A4 21 FB F4 EE F9 86 F9 96 F6 8B 95 D3
0180 | D4 C7 24 8B AD EC E8 49 68 3E A5 90 17 C5 10 64
0190 | D4 9F DC C3 20 AA C5 C4 15 51 BE 71 13 77 3C C3
01A0 | 3A D1 8E 71 68 01 C3 8D 3F 1D 51 D8 30 7E 33 53
01B0 | 18 60 EE 0D B8 41 50 66 1B 13 CE 1F 91 08 E6 47
01C0 | 18 EA BC 65 38 C5 1B 0C 2B 7A 57 E2 19 98 F7 DF
01D0 | FD DB 1D D5 BB A5 09 4E F7 D6 73 AF ED B7 96 D6
01E0 | F5 66 64 2E D1 E1 4B 91 70 D2 CE BE C1 05 7C C7
01F0 | D2 20 18 AB A1 15 E5 E2 E8 74 32 CE A1 FB CA C6
0200 | 01 33 38 8C 60 B6 2F A4 DA 7B 60 B2 5F 34 F9 65
0210 | BB 1C 57 2E E5 C7 DA 63 AA 7D 65 2A F0 18 21 DD
0220 | 05 B8 A7 B3 30 3E F9 9C 1F 56 A9 E9 ED C5 B3 E0
0230 | C7 2A BF 09 7F 20 42 F0 91 2D 08 7C EA 17 E7 01
0240 | 47 91 21 26 B6 6D 2B 61 17 04 DD 63 0F 20 F8 10
0250 | 2B 59 75 A1 5D 75 EE 2E D7 59 82 30 99 F5 2E 53
0260 | 76 E1 30 90 72 CC 26 82 62 3F C2 54 89 6F 42 8D
0270 | A7 E0 CC 38 01 83 4B 8C 67 7A 38 38 7E 7A AA 0C
0280 | FE E1 9D B0 4A C2 C8 A6 F8 5A A4 C1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01385D6113B0D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200E2F38736912568BC957455DA</code> <code>BF83370FA0485A98A5EEA4004126A537</code> <code>E33B832B6E0DCBEBBE6AC7B1535A11FE</code> <code>C220D64E628CCD4419E3D18F4F82DDB7</code> <code>2E4355684AF11E45594A3F73EA8C3557</code> <code>FCA2B189620CB070AC306AAADE711D64</code> <code>BED20CA7E64AD82C7E70CA1EBD84D7CA</code> <code>AF3B87430C3D8BC65A020963AC36FB5B</code> <code>3EC952B64ACA13C20454CBB3B15FA2F7</code> <code>1EA52AB728FAC5CE5D75E1B8CA1F4ED9</code> <code>52D1DD30A099AF8C5E9198110D231579</code> <code>F33DF2C07B1AC6ADC682164896A5661C</code> <code>131C365E9800CF85A20144D6136365E4</code> <code>1B290B62FCE9F19944242C8B59D1FEAE</code> <code>DC82A917E1930B1867F8D936FFCBD0D3</code> <code>B678180C76B514ED50E2E6A977874788</code> <code>DAC51FA72AC1E8ACBA39AA7F86E6C9EA</code> <code>98E95F2ED9E468F343D8A3D036E30736</code> <code>418B27BE18CB273BA21944EA09993C6E</code> <code>5911B2C31C8E02E50FEF45A421FBF4EE</code> <code>F986F996F68B95D3D4C7248BADECE849</code> <code>683EA59017C51064D49FDCC320AAC5C4</code> <code>1551BE7113773CC33AD18E716801C38D</code> <code>3F1D51D8307E33531860EE0DB8415066</code> <code>1B13CE1F9108E64718EABC6538C51B0C</code> <code>2B7A57E21998F7DFFDDB1DD5BBA5094E</code> <code>F7D673AFEDB796D6F566642ED1E14B91</code> <code>70D2CEBEC1057CC7D22018ABA115E5E2</code> <code>E87432CEA1FBCAC60133388C60B62FA4</code> <code>DA7B60B25F34F965BB1C572EE5C7DA63</code> <code>AA7D652AF01821DD05B8A7B3303EF99C</code> <code>1F56A9E9EDC5B3E0C72ABF097F2042F0</code> <code>912D087CEA17E70147912126B66D2B61</code> <code>1704DD630F20F8102B5975A15D75EE2E</code> <code>D759823099F52E5376E1309072CC2682</code> <code>623FC254896F428DA7E0CC3801834B8C</code> <code>677A38387E7AAA0CFEE19DB04AC2C8A6</code><br> <code>F85AA4C1</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = E2F38736912568BC957455DABF83370FA0485A98A5EEA4004126A537E33B832B6E0DCBEBBE6AC7B1535A11FEC220D64E628CCD4419E3D18F4F82DDB72E4355684AF11E45594A3F73EA8C3557FCA2B189620CB070AC306AAADE711D64BED20CA7E64AD82C7E70CA1EBD84D7CAAF3B87430C3D8BC65A020963AC36FB5B3EC952B64ACA13C20454CBB3B15FA2F71EA52AB728FAC5CE5D75E1B8CA1F4ED952D1DD30A099AF8C5E9198110D231579F33DF2C07B1AC6ADC682164896A5661C131C365E9800CF85A20144D6136365E41B290B62FCE9F19944242C8B59D1FEAEDC82A917E1930B1867F8D936FFCBD0D3B678180C76B514ED50E2E6A977874788DAC51FA72AC1E8ACBA39AA7F86E6C9EA98E95F2ED9E468F343D8A3D036E30736418B27BE18CB273BA21944EA09993C6E5911B2C31C8E02E50FEF45A421FBF4EEF986F996F68B95D3D4C7248BADECE849683EA59017C51064D49FDCC320AAC5C41551BE7113773CC33AD18E716801C38D3F1D51D8307E33531860EE0DB84150661B13CE1F9108E64718EABC6538C51B0C2B7A57E21998F7DFFDDB1DD5BBA5094EF7D673AFEDB796D6F566642ED1E14B9170D2CEBEC1057CC7D22018ABA115E5E2E87432CEA1FBCAC60133388C60B62FA4DA7B60B25F34F965BB1C572EE5C7DA63AA7D652AF01821DD05B8A7B3303EF99C1F56A9E9EDC5B3E0C72ABF097F2042F0912D087CEA17E70147912126B66D2B611704DD630F20F8102B5975A15D75EE2ED759823099F52E5376E1309072CC2682623FC254896F428DA7E0CC3801834B8C677A38387E7AAA0CFEE19DB04AC2C8A6F85AA4C1
tmp_aes_key = 0B6DCC66941398E3D00B99BB169A2222576CE16483DE66E1ABD103CF49A3C178
tmp_aes_iv = 56F7047E396B93853DD6E9A88E3338CFDD0684AE789525050FAEB8D4517C15EC</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 1785B4FFBE18A9EE37DD6ECC509C806597CF665DBA0D89B5DE16BA81E813523B56F96DC940FF73774CCBB32C1CF052DEEB01F9BA8A70508003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010023B7E68DF36EE9D6DFF5F500064FACB41288D4859FD22748A6F1C15BC3151A401C9B8B13F46C9ABB498C817883550D76E87EE70910CD4A2EF4644F6EDD6E2A4774B46C7232EAE2F2C5CC7943FE303F5A1C52E9ACAB4DBF892F72C0F5BD3A27F390960ADD33D1DFB9DAF1A422DDE53ACA20AE7D84D38010B2EF148AAB06EBBCF08204EA04AF041B518595F079D5361BFE08F4386767EBE01A8FD3CCB7107CBE23D59F400D5B5D6980FCEB353BE5FCC5D1FB49550D8C4AB0F77023ABBEA5040182BFEFA8801613C6071EE2C87F013A8EE79E68431264B13929F7E38B85793E0B8D63D17985CB49CC568720BF721F2A753FC9A308C0A27E092AAEF7722718C8A8F513B0D6682DBC8612BF5474F6
answer = BA0D89B5DE16BA81E813523B56F96DC940FF73774CCBB32C1CF052DEEB01F9BA8A70508003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010023B7E68DF36EE9D6DFF5F500064FACB41288D4859FD22748A6F1C15BC3151A401C9B8B13F46C9ABB498C817883550D76E87EE70910CD4A2EF4644F6EDD6E2A4774B46C7232EAE2F2C5CC7943FE303F5A1C52E9ACAB4DBF892F72C0F5BD3A27F390960ADD33D1DFB9DAF1A422DDE53ACA20AE7D84D38010B2EF148AAB06EBBCF08204EA04AF041B518595F079D5361BFE08F4386767EBE01A8FD3CCB7107CBE23D59F400D5B5D6980FCEB353BE5FCC5D1FB49550D8C4AB0F77023ABBEA5040182BFEFA8801613C6071EE2C87F013A8EE79E68431264B13929F7E38B85793E0B8D63D17985CB49CC568720BF721F2A753FC9A308C0A27E092AAEF7722718C8A8F513B0D6682DBC8612BF5474F6</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 DE 16 BA 81 E8 13 52 3B 56 F9 6D C9
0010 | 40 FF 73 77 4C CB B3 2C 1C F0 52 DE EB 01 F9 BA
0020 | 8A 70 50 80 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 23 B7 E6 8D F3 6E E9 D6 DF F5 F5 00 06 4F AC B4
0140 | 12 88 D4 85 9F D2 27 48 A6 F1 C1 5B C3 15 1A 40
0150 | 1C 9B 8B 13 F4 6C 9A BB 49 8C 81 78 83 55 0D 76
0160 | E8 7E E7 09 10 CD 4A 2E F4 64 4F 6E DD 6E 2A 47
0170 | 74 B4 6C 72 32 EA E2 F2 C5 CC 79 43 FE 30 3F 5A
0180 | 1C 52 E9 AC AB 4D BF 89 2F 72 C0 F5 BD 3A 27 F3
0190 | 90 96 0A DD 33 D1 DF B9 DA F1 A4 22 DD E5 3A CA
01A0 | 20 AE 7D 84 D3 80 10 B2 EF 14 8A AB 06 EB BC F0
01B0 | 82 04 EA 04 AF 04 1B 51 85 95 F0 79 D5 36 1B FE
01C0 | 08 F4 38 67 67 EB E0 1A 8F D3 CC B7 10 7C BE 23
01D0 | D5 9F 40 0D 5B 5D 69 80 FC EB 35 3B E5 FC C5 D1
01E0 | FB 49 55 0D 8C 4A B0 F7 70 23 AB BE A5 04 01 82
01F0 | BF EF A8 80 16 13 C6 07 1E E2 C8 7F 01 3A 8E E7
0200 | 9E 68 43 12 64 B1 39 29 F7 E3 8B 85 79 3E 0B 8D
0210 | 63 D1 79 85 CB 49 CC 56 87 20 BF 72 1F 2A 75 3F
0220 | C9 A3 08 C0 A2 7E 09 2A AE F7 72 27 18 C8 A8 F5
0230 | 13 B0 D6 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010023B7E68DF36EE9D6DFF5F500</code> <code>064FACB41288D4859FD22748A6F1C15B</code> <code>C3151A401C9B8B13F46C9ABB498C8178</code> <code>83550D76E87EE70910CD4A2EF4644F6E</code> <code>DD6E2A4774B46C7232EAE2F2C5CC7943</code> <code>FE303F5A1C52E9ACAB4DBF892F72C0F5</code> <code>BD3A27F390960ADD33D1DFB9DAF1A422</code> <code>DDE53ACA20AE7D84D38010B2EF148AAB</code> <code>06EBBCF08204EA04AF041B518595F079</code> <code>D5361BFE08F4386767EBE01A8FD3CCB7</code> <code>107CBE23D59F400D5B5D6980FCEB353B</code> <code>E5FCC5D1FB49550D8C4AB0F77023ABBE</code> <code>A5040182BFEFA8801613C6071EE2C87F</code> <code>013A8EE79E68431264B13929F7E38B85</code> <code>793E0B8D63D17985CB49CC568720BF72</code> <code>1F2A753FC9A308C0A27E092AAEF77227</code><br> <code>18C8A8F5</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>13B0D668</code> (1758900243 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = AA404A9485B95DE9FEA8432F0FC8E09742E671A6EA869598AC0529B75434585EE2859A73BC217DFA1A1D6D244F6508DA52FC539900FB62FCE11F1BDC5E5774759EA2D94DE6DD01F1ECBBB0006CD2A2E002B50DF6EB15E6B5137621450D8ACA6659614556FF01AF208C6B159B41E5282B11F28CE2E34265ACB2D5D0BD4233886FBB629647F5723008EB17C55FAB7A37D977903E66168F4B58A4D2FF338B2DD8C70CF109F647B626F58075B1BCEDB9BE1BF59C5B766E4EEBA072DAFD382832C158CE48101C91E4C533550FE4C3A7062109ACE8710D0746E6DFD19F54779393DF2056D0BE80A21C19A948D776F43798D41877FE56A53DA341DC65179DF76DA66EB6</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 5BCCE3A371B8865AE1B9C287064F9B6CE36549F2C67DE8A4997A550049846782AA30C2C837DAC9DE438497B07654DB19F53970278F9DD4DFBD272C840E99E033B29E12167887776436A77037F462DE1CC006BF7AA4813356D3917C0594F1C84459581130CD1C0D763D7B202D03A27E1DCA5B67F580EE539E7A3319772A35E1D051FF7B60DF44BC63B2591C570AB57CC0AF7D26A1263343A449C5BAC689ECB593C8DB2E6D26E2DC15C4B250A01E50BBB7A65C9852D9B562395723BBA8FFB8681B16F50796D260F3CD179C09497B22EA5A8B1CDBC642DB2967CFDFC1FA9DF276668853D7DC0193540878CDC49C55EA8ED5F194714A2AF128F696503B7291A2B69C</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 DE 16 BA 81 E8 13 52 3B 56 F9 6D C9
0010 | 40 FF 73 77 4C CB B3 2C 1C F0 52 DE EB 01 F9 BA
0020 | 8A 70 50 80 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 5B CC E3 A3 71 B8 86 5A E1 B9 C2 87 06 4F 9B 6C
0040 | E3 65 49 F2 C6 7D E8 A4 99 7A 55 00 49 84 67 82
0050 | AA 30 C2 C8 37 DA C9 DE 43 84 97 B0 76 54 DB 19
0060 | F5 39 70 27 8F 9D D4 DF BD 27 2C 84 0E 99 E0 33
0070 | B2 9E 12 16 78 87 77 64 36 A7 70 37 F4 62 DE 1C
0080 | C0 06 BF 7A A4 81 33 56 D3 91 7C 05 94 F1 C8 44
0090 | 59 58 11 30 CD 1C 0D 76 3D 7B 20 2D 03 A2 7E 1D
00A0 | CA 5B 67 F5 80 EE 53 9E 7A 33 19 77 2A 35 E1 D0
00B0 | 51 FF 7B 60 DF 44 BC 63 B2 59 1C 57 0A B5 7C C0
00C0 | AF 7D 26 A1 26 33 43 A4 49 C5 BA C6 89 EC B5 93
00D0 | C8 DB 2E 6D 26 E2 DC 15 C4 B2 50 A0 1E 50 BB B7
00E0 | A6 5C 98 52 D9 B5 62 39 57 23 BB A8 FF B8 68 1B
00F0 | 16 F5 07 96 D2 60 F3 CD 17 9C 09 49 7B 22 EA 5A
0100 | 8B 1C DB C6 42 DB 29 67 CF DF C1 FA 9D F2 76 66
0110 | 88 53 D7 DC 01 93 54 08 78 CD C4 9C 55 EA 8E D5
0120 | F1 94 71 4A 2A F1 28 F6 96 50 3B 72 91 A2 B6 9C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001005BCCE3A371B8865AE1B9C287</code> <code>064F9B6CE36549F2C67DE8A4997A5500</code> <code>49846782AA30C2C837DAC9DE438497B0</code> <code>7654DB19F53970278F9DD4DFBD272C84</code> <code>0E99E033B29E12167887776436A77037</code> <code>F462DE1CC006BF7AA4813356D3917C05</code> <code>94F1C84459581130CD1C0D763D7B202D</code> <code>03A27E1DCA5B67F580EE539E7A331977</code> <code>2A35E1D051FF7B60DF44BC63B2591C57</code> <code>0AB57CC0AF7D26A1263343A449C5BAC6</code> <code>89ECB593C8DB2E6D26E2DC15C4B250A0</code> <code>1E50BBB7A65C9852D9B562395723BBA8</code> <code>FFB8681B16F50796D260F3CD179C0949</code> <code>7B22EA5A8B1CDBC642DB2967CFDFC1FA</code> <code>9DF276668853D7DC0193540878CDC49C</code> <code>55EA8ED5F194714A2AF128F696503B72</code><br> <code>91A2B69C</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366DE16BA81E813523B56F96DC940FF73774CCBB32C1CF052DEEB01F9BA8A7050800000000000000000FE0001005BCCE3A371B8865AE1B9C287064F9B6CE36549F2C67DE8A4997A550049846782AA30C2C837DAC9DE438497B07654DB19F53970278F9DD4DFBD272C840E99E033B29E12167887776436A77037F462DE1CC006BF7AA4813356D3917C0594F1C84459581130CD1C0D763D7B202D03A27E1DCA5B67F580EE539E7A3319772A35E1D051FF7B60DF44BC63B2591C570AB57CC0AF7D26A1263343A449C5BAC689ECB593C8DB2E6D26E2DC15C4B250A01E50BBB7A65C9852D9B562395723BBA8FFB8681B16F50796D260F3CD179C09497B22EA5A8B1CDBC642DB2967CFDFC1FA9DF276668853D7DC0193540878CDC49C55EA8ED5F194714A2AF128F696503B7291A2B69C
padding = D717C85C205B39D3864159F5
tmp_aes_key = 0B6DCC66941398E3D00B99BB169A2222576CE16483DE66E1ABD103CF49A3C178
tmp_aes_iv = 56F7047E396B93853DD6E9A88E3338CFDD0684AE789525050FAEB8D4517C15EC</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 998C072728D1A217800A45E4CC10C0C1445FB41C0B1066DE0AC90E342F05F305E4D51DF525FD1C67EDF16CF7D9DC5C3E6937E25F2097F73DA42CCFC25857B4E63B78C9B1992A77F7CD054A02B28A013E4991EAA61C50813BA7D758584DF67011B07864E226AE3A22ABC0FB95B90E41052F8DCF61CA8BDA222E3FB7FD845539EA368BBE3664F330B1CAF252BF9DD62E7F00ACD4D28E986E79F41498087BECAC49016A6074B2F8B87E9BFFF0321A919E25B6905F2DC572035B2FCD37FDB9FB1DFC2B1EB86ACAFE2B5334A46ADD345A134263147793441E01395C3C3422D83DF59F6A811BBDC0DA53F7698260882C27E4B54DD1E1A1F8AB32E471CE5A9D04E5380822EC4AE24E044177FB23C6B618F099503C7B243161F25CFE43098641E94C9FCD767F2813AF05E57E93438864FC0FD481FA694624352A4A304FA958CC9A93E7B474ABD57B76CE2A0154E2B56B25640C91</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 8C 58 0E 00 13 B0 D6 68
0010 | 78 01 00 00 1F 5F 04 F5 DE 16 BA 81 E8 13 52 3B
0020 | 56 F9 6D C9 40 FF 73 77 4C CB B3 2C 1C F0 52 DE
0030 | EB 01 F9 BA 8A 70 50 80 FE 50 01 00 99 8C 07 27
0040 | 28 D1 A2 17 80 0A 45 E4 CC 10 C0 C1 44 5F B4 1C
0050 | 0B 10 66 DE 0A C9 0E 34 2F 05 F3 05 E4 D5 1D F5
0060 | 25 FD 1C 67 ED F1 6C F7 D9 DC 5C 3E 69 37 E2 5F
0070 | 20 97 F7 3D A4 2C CF C2 58 57 B4 E6 3B 78 C9 B1
0080 | 99 2A 77 F7 CD 05 4A 02 B2 8A 01 3E 49 91 EA A6
0090 | 1C 50 81 3B A7 D7 58 58 4D F6 70 11 B0 78 64 E2
00A0 | 26 AE 3A 22 AB C0 FB 95 B9 0E 41 05 2F 8D CF 61
00B0 | CA 8B DA 22 2E 3F B7 FD 84 55 39 EA 36 8B BE 36
00C0 | 64 F3 30 B1 CA F2 52 BF 9D D6 2E 7F 00 AC D4 D2
00D0 | 8E 98 6E 79 F4 14 98 08 7B EC AC 49 01 6A 60 74
00E0 | B2 F8 B8 7E 9B FF F0 32 1A 91 9E 25 B6 90 5F 2D
00F0 | C5 72 03 5B 2F CD 37 FD B9 FB 1D FC 2B 1E B8 6A
0100 | CA FE 2B 53 34 A4 6A DD 34 5A 13 42 63 14 77 93
0110 | 44 1E 01 39 5C 3C 34 22 D8 3D F5 9F 6A 81 1B BD
0120 | C0 DA 53 F7 69 82 60 88 2C 27 E4 B5 4D D1 E1 A1
0130 | F8 AB 32 E4 71 CE 5A 9D 04 E5 38 08 22 EC 4A E2
0140 | 4E 04 41 77 FB 23 C6 B6 18 F0 99 50 3C 7B 24 31
0150 | 61 F2 5C FE 43 09 86 41 E9 4C 9F CD 76 7F 28 13
0160 | AF 05 E5 7E 93 43 88 64 FC 0F D4 81 FA 69 46 24
0170 | 35 2A 4A 30 4F A9 58 CC 9A 93 E7 B4 74 AB D5 7B
0180 | 76 CE 2A 01 54 E2 B5 6B 25 64 0C 91</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>8C580E0013B0D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100998C072728D1A217800A45E4</code> <code>CC10C0C1445FB41C0B1066DE0AC90E34</code> <code>2F05F305E4D51DF525FD1C67EDF16CF7</code> <code>D9DC5C3E6937E25F2097F73DA42CCFC2</code> <code>5857B4E63B78C9B1992A77F7CD054A02</code> <code>B28A013E4991EAA61C50813BA7D75858</code> <code>4DF67011B07864E226AE3A22ABC0FB95</code> <code>B90E41052F8DCF61CA8BDA222E3FB7FD</code> <code>845539EA368BBE3664F330B1CAF252BF</code> <code>9DD62E7F00ACD4D28E986E79F4149808</code> <code>7BECAC49016A6074B2F8B87E9BFFF032</code> <code>1A919E25B6905F2DC572035B2FCD37FD</code> <code>B9FB1DFC2B1EB86ACAFE2B5334A46ADD</code> <code>345A134263147793441E01395C3C3422</code> <code>D83DF59F6A811BBDC0DA53F769826088</code> <code>2C27E4B54DD1E1A1F8AB32E471CE5A9D</code> <code>04E5380822EC4AE24E044177FB23C6B6</code> <code>18F099503C7B243161F25CFE43098641</code> <code>E94C9FCD767F2813AF05E57E93438864</code> <code>FC0FD481FA694624352A4A304FA958CC</code> <code>9A93E7B474ABD57B76CE2A0154E2B56B</code><br> <code>25640C91</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 6A8DB3B8F723AE1C4E10D4D7CDAFC4348E2EBC02E15C2EECB5962CD3405F424FD3E7EDA48A4798C670EA428FEA54EB3F62DAFDF462B8B5C39AAB86D5E50FC00821BFC85FD0B5887634A1498C038102320C5091295ACC57295CF0382E42D8BFFE99CBFDCEFD054D0F5E65D908A41594286DA25CA3E1E2225E3D0EBE9A326FC1A3608B059D862E2F458D0CAAC8B1C0D7B0EDB0CBE73526AD6CD1F93A22CBF7A1B7B67E991AA43C1E4E77CEB458AB140E54C6DB0C356FD94E12AA3E002F2FB373A262C783053DB469A1A6272EEB3BFE0FD5E993D27ABE749F8796ACEEB2AF9C23AE5B97D2BA77EF5CE183553A5224B708CE198EECC1B8D34B5DCD657051644DA46B</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 AC 25 9B 17 B0 D6 68
0010 | 34 00 00 00 34 F7 CB 3B DE 16 BA 81 E8 13 52 3B
0020 | 56 F9 6D C9 40 FF 73 77 4C CB B3 2C 1C F0 52 DE
0030 | EB 01 F9 BA 8A 70 50 80 F2 B1 48 30 5E 46 68 81
0040 | D4 C3 71 D8 D4 14 9C 59</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01AC259B17B0D668</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>DE16BA81E813523B56F96DC940FF7377</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CCBB32C1CF052DEEB01F9BA8A705080</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>F2B148305E466881D4C371D8D4149C59</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

