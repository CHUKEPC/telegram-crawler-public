<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 05 04 00 74 FA 62 67
0010 | 14 00 00 00 F1 8E 7E BE A2 AF 30 A7 D7 AC 5A CB
0020 | 8F DC 32 53 09 81 2D A7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0805040074FA6267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 84 FA 61 74 FA 62 67
0010 | 50 00 00 00 63 24 16 05 A2 AF 30 A7 D7 AC 5A CB
0020 | 8F DC 32 53 09 81 2D A7 8B 0F 2C A6 3C 1F 9A 74
0030 | F3 D7 BA 66 3B 86 4E C5 08 14 8D 51 03 86 EF D1
0040 | 41 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0184FA6174FA6267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08148D510386EFD141000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1480928928065376577</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1480928928065376577</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1480928928065376577 = 1030871917 * 1436578981</code></p>
<pre><code>p = 1030871917
q = 1436578981</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 14 8D 51 03 86 EF D1 41 00 00 00
0010 | 04 3D 71 DB 6D 00 00 00 04 55 A0 74 A5 00 00 00
0020 | A2 AF 30 A7 D7 AC 5A CB 8F DC 32 53 09 81 2D A7
0030 | 8B 0F 2C A6 3C 1F 9A 74 F3 D7 BA 66 3B 86 4E C5
0040 | F9 0F AA 4E 3E 4F 21 A4 8C 3F E7 45 96 65 D7 41
0050 | 7C EF 1E 9B E6 7A 72 0B EE 84 E0 79 33 60 92 79
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08148D510386EFD141000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1480928928065376577</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043D71DB6D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1030871917</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0455A074A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1436578981</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>F90FAA4E3E4F21A48C3FE7459665D741</code> <code>7CEF1E9BE67A720BEE84E07933609279</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908148D510386EFD141000000043D71DB6D0000000455A074A5000000A2AF30A7D7AC5ACB8FDC325309812DA78B0F2CA63C1F9A74F3D7BA663B864EC5F90FAA4E3E4F21A48C3FE7459665D7417CEF1E9BE67A720BEE84E0793360927902000000
random_padding_bytes = B5646A737C682B66359638BC02275D2DF848D00250EE90C3CFAE2D2E29EE75ECD1B2A4E0F2C8C02122BDD1B407EACA02A8EA1E359218167FCBF46E71B7C15741985C881B4E30736ABBBCBE936B40648090146BAA6FA271FC765D5F32</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = BA7A715164B3309B951F273C92342838CE9CFDC8652BF4EED05E85CDB29CC534063139C1EDD859977D19C236C0D77FC6A4E609A108D324A76A7D63F4214227B2405B3FF6E7BF8B2DFF9946A969FEF8F62B1ABEDABE4467807757CA20A8BF79DE171E316099694FA9732353DDDC567BB3F5BC1A5ED5926270F9FE9991C4808F3749C6B77302802DF6107261181629A7BCC2769861C540ABD602C6DE14F20F9A9F341E3EAC49DD7A080A11D241C2119A52FF281BCF92137212ADF424813B5082B06113468096CC1D2005A315AB6E03CFE7B90B9EB10B20F45210111DE12863C231A7577FE0BC322453333508BCDF3C4878ABC1EF01C2078B2D5EEA5C99F14502B8</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 33 09 00 74 FA 62 67
0010 | 40 01 00 00 BE E4 12 D7 A2 AF 30 A7 D7 AC 5A CB
0020 | 8F DC 32 53 09 81 2D A7 8B 0F 2C A6 3C 1F 9A 74
0030 | F3 D7 BA 66 3B 86 4E C5 04 3D 71 DB 6D 00 00 00
0040 | 04 55 A0 74 A5 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 BA 7A 71 51 64 B3 30 9B 95 1F 27 3C
0060 | 92 34 28 38 CE 9C FD C8 65 2B F4 EE D0 5E 85 CD
0070 | B2 9C C5 34 06 31 39 C1 ED D8 59 97 7D 19 C2 36
0080 | C0 D7 7F C6 A4 E6 09 A1 08 D3 24 A7 6A 7D 63 F4
0090 | 21 42 27 B2 40 5B 3F F6 E7 BF 8B 2D FF 99 46 A9
00A0 | 69 FE F8 F6 2B 1A BE DA BE 44 67 80 77 57 CA 20
00B0 | A8 BF 79 DE 17 1E 31 60 99 69 4F A9 73 23 53 DD
00C0 | DC 56 7B B3 F5 BC 1A 5E D5 92 62 70 F9 FE 99 91
00D0 | C4 80 8F 37 49 C6 B7 73 02 80 2D F6 10 72 61 18
00E0 | 16 29 A7 BC C2 76 98 61 C5 40 AB D6 02 C6 DE 14
00F0 | F2 0F 9A 9F 34 1E 3E AC 49 DD 7A 08 0A 11 D2 41
0100 | C2 11 9A 52 FF 28 1B CF 92 13 72 12 AD F4 24 81
0110 | 3B 50 82 B0 61 13 46 80 96 CC 1D 20 05 A3 15 AB
0120 | 6E 03 CF E7 B9 0B 9E B1 0B 20 F4 52 10 11 1D E1
0130 | 28 63 C2 31 A7 57 7F E0 BC 32 24 53 33 35 08 BC
0140 | DF 3C 48 78 AB C1 EF 01 C2 07 8B 2D 5E EA 5C 99
0150 | F1 45 02 B8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0833090074FA6267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043D71DB6D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1030871917</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0455A074A5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1436578981</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100BA7A715164B3309B951F273C</code> <code>92342838CE9CFDC8652BF4EED05E85CD</code> <code>B29CC534063139C1EDD859977D19C236</code> <code>C0D77FC6A4E609A108D324A76A7D63F4</code> <code>214227B2405B3FF6E7BF8B2DFF9946A9</code> <code>69FEF8F62B1ABEDABE4467807757CA20</code> <code>A8BF79DE171E316099694FA9732353DD</code> <code>DC567BB3F5BC1A5ED5926270F9FE9991</code> <code>C4808F3749C6B77302802DF610726118</code> <code>1629A7BCC2769861C540ABD602C6DE14</code> <code>F20F9A9F341E3EAC49DD7A080A11D241</code> <code>C2119A52FF281BCF92137212ADF42481</code> <code>3B5082B06113468096CC1D2005A315AB</code> <code>6E03CFE7B90B9EB10B20F45210111DE1</code> <code>2863C231A7577FE0BC322453333508BC</code> <code>DF3C4878ABC1EF01C2078B2D5EEA5C99</code><br> <code>F14502B8</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 E6 7C 74 FA 62 67
0010 | 78 02 00 00 5C 07 E8 D0 A2 AF 30 A7 D7 AC 5A CB
0020 | 8F DC 32 53 09 81 2D A7 8B 0F 2C A6 3C 1F 9A 74
0030 | F3 D7 BA 66 3B 86 4E C5 FE 50 02 00 9E 8E 08 55
0040 | 7D BA F2 FD ED C2 15 4D 69 83 93 01 78 12 CC 8B
0050 | B7 F6 57 F9 40 53 7F 22 99 80 42 67 B6 91 3D 92
0060 | BC 1F EF DE C3 81 2E 3B 53 B1 C3 E3 F7 73 AD E0
0070 | 7C 8A E5 14 9F 19 F7 72 F2 13 14 1B 0E 0E 5D 70
0080 | 48 00 93 84 17 B3 45 E5 FE 8E CE 62 3A A0 E0 B8
0090 | ED 51 9E 40 70 FC 50 17 17 44 69 A0 D6 B4 D7 BB
00A0 | E4 05 BE 2F 02 26 8F 88 AE F2 6A 2F 97 E3 5D B6
00B0 | 51 E7 25 9F A1 B8 94 CF 77 4C 29 04 8B 8B 48 F1
00C0 | 01 8E E1 E5 82 35 C2 96 56 10 86 4C A6 48 56 18
00D0 | C4 1E B2 BE AB 04 FD 77 65 C5 69 7E 2C 43 8A 3B
00E0 | AE 7F BA CD 5C EA DC 8C 8C 19 15 07 5E 20 60 AF
00F0 | 06 89 63 91 CB CC 95 E1 1A 5C 78 3A C2 7E 96 59
0100 | AA 17 40 7A 8E DE FE 67 4E 7F 9C FE A2 76 C3 C2
0110 | F8 42 49 4C A8 B4 60 48 29 24 4A FF 85 57 CD 69
0120 | 58 CA FB C5 33 81 A5 05 43 1E 02 A8 CB 94 15 77
0130 | 57 4C 98 9A F1 C0 72 AC 69 82 48 80 E8 70 5D 04
0140 | 88 32 97 53 46 91 97 F4 A8 A8 EE 57 55 89 F6 CC
0150 | B3 25 24 AC 79 49 E9 79 6B 82 58 CA 4C 00 AB 74
0160 | BB 2C F8 76 5F DD 66 63 3C 3B 33 8E 8F 55 EC 3A
0170 | E4 A7 D8 E1 0F 4F 18 BD 9C E5 FD 21 7B CD 8C 0E
0180 | 6A 3D 88 2D E3 7B 49 B6 CE 92 3C F4 80 EA 6C EE
0190 | A6 7C 5E A2 35 DF 7F 76 DF CC C1 0A F2 DE 72 1A
01A0 | B3 CD C7 48 55 33 1D D6 8A 1F 99 7F 71 DC FE 6C
01B0 | 5C 72 1D 30 86 16 6B 4C C6 73 B6 F7 1F B9 D0 CC
01C0 | 3E AC 1A F5 B8 F7 11 67 A1 CB 97 E0 B1 B2 11 E5
01D0 | 1A 0C 3A 88 6A 61 FD D5 4E 24 45 07 AE 38 13 43
01E0 | B2 32 6F 5B 7D EC 49 2E B0 7C 7E A6 08 38 8E 4F
01F0 | 0B 34 75 0E 3E DA 53 FD 04 98 C3 D3 47 C6 D2 0C
0200 | AB 8C 2F DA 8F E8 D7 15 4D C7 8E 42 22 66 84 C0
0210 | 9B 50 0B C0 8F 6E DB 1D A6 38 F1 CA 4C C9 3F 07
0220 | 68 74 1A 0C 82 64 46 B5 8D E0 A5 0E 7A 73 46 42
0230 | 1E B6 31 36 80 69 22 F2 D9 75 50 43 9F F8 E5 C0
0240 | 55 57 06 0B 5C 4D 42 A8 02 0F 49 DF 53 B6 D9 E5
0250 | C5 92 71 C8 FE 94 F8 F8 29 96 E3 E0 27 E5 3C 97
0260 | B0 4B D8 C9 A6 0E 0A 08 96 F5 AA D9 13 3A 95 2A
0270 | AE 95 E8 70 2C 6B 5D 00 07 63 69 0C B4 79 15 2E
0280 | 47 F9 AD A3 9C 7F 82 96 34 57 43 18</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0158E67C74FA6267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002009E8E08557DBAF2FDEDC2154D</code> <code>698393017812CC8BB7F657F940537F22</code> <code>99804267B6913D92BC1FEFDEC3812E3B</code> <code>53B1C3E3F773ADE07C8AE5149F19F772</code> <code>F213141B0E0E5D704800938417B345E5</code> <code>FE8ECE623AA0E0B8ED519E4070FC5017</code> <code>174469A0D6B4D7BBE405BE2F02268F88</code> <code>AEF26A2F97E35DB651E7259FA1B894CF</code> <code>774C29048B8B48F1018EE1E58235C296</code> <code>5610864CA6485618C41EB2BEAB04FD77</code> <code>65C5697E2C438A3BAE7FBACD5CEADC8C</code> <code>8C1915075E2060AF06896391CBCC95E1</code> <code>1A5C783AC27E9659AA17407A8EDEFE67</code> <code>4E7F9CFEA276C3C2F842494CA8B46048</code> <code>29244AFF8557CD6958CAFBC53381A505</code> <code>431E02A8CB941577574C989AF1C072AC</code> <code>69824880E8705D0488329753469197F4</code> <code>A8A8EE575589F6CCB32524AC7949E979</code> <code>6B8258CA4C00AB74BB2CF8765FDD6663</code> <code>3C3B338E8F55EC3AE4A7D8E10F4F18BD</code> <code>9CE5FD217BCD8C0E6A3D882DE37B49B6</code> <code>CE923CF480EA6CEEA67C5EA235DF7F76</code> <code>DFCCC10AF2DE721AB3CDC74855331DD6</code> <code>8A1F997F71DCFE6C5C721D3086166B4C</code> <code>C673B6F71FB9D0CC3EAC1AF5B8F71167</code> <code>A1CB97E0B1B211E51A0C3A886A61FDD5</code> <code>4E244507AE381343B2326F5B7DEC492E</code> <code>B07C7EA608388E4F0B34750E3EDA53FD</code> <code>0498C3D347C6D20CAB8C2FDA8FE8D715</code> <code>4DC78E42226684C09B500BC08F6EDB1D</code> <code>A638F1CA4CC93F0768741A0C826446B5</code> <code>8DE0A50E7A7346421EB63136806922F2</code> <code>D97550439FF8E5C05557060B5C4D42A8</code> <code>020F49DF53B6D9E5C59271C8FE94F8F8</code> <code>2996E3E027E53C97B04BD8C9A60E0A08</code> <code>96F5AAD9133A952AAE95E8702C6B5D00</code> <code>0763690CB479152E47F9ADA39C7F8296</code><br> <code>34574318</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 9E8E08557DBAF2FDEDC2154D698393017812CC8BB7F657F940537F2299804267B6913D92BC1FEFDEC3812E3B53B1C3E3F773ADE07C8AE5149F19F772F213141B0E0E5D704800938417B345E5FE8ECE623AA0E0B8ED519E4070FC5017174469A0D6B4D7BBE405BE2F02268F88AEF26A2F97E35DB651E7259FA1B894CF774C29048B8B48F1018EE1E58235C2965610864CA6485618C41EB2BEAB04FD7765C5697E2C438A3BAE7FBACD5CEADC8C8C1915075E2060AF06896391CBCC95E11A5C783AC27E9659AA17407A8EDEFE674E7F9CFEA276C3C2F842494CA8B4604829244AFF8557CD6958CAFBC53381A505431E02A8CB941577574C989AF1C072AC69824880E8705D0488329753469197F4A8A8EE575589F6CCB32524AC7949E9796B8258CA4C00AB74BB2CF8765FDD66633C3B338E8F55EC3AE4A7D8E10F4F18BD9CE5FD217BCD8C0E6A3D882DE37B49B6CE923CF480EA6CEEA67C5EA235DF7F76DFCCC10AF2DE721AB3CDC74855331DD68A1F997F71DCFE6C5C721D3086166B4CC673B6F71FB9D0CC3EAC1AF5B8F71167A1CB97E0B1B211E51A0C3A886A61FDD54E244507AE381343B2326F5B7DEC492EB07C7EA608388E4F0B34750E3EDA53FD0498C3D347C6D20CAB8C2FDA8FE8D7154DC78E42226684C09B500BC08F6EDB1DA638F1CA4CC93F0768741A0C826446B58DE0A50E7A7346421EB63136806922F2D97550439FF8E5C05557060B5C4D42A8020F49DF53B6D9E5C59271C8FE94F8F82996E3E027E53C97B04BD8C9A60E0A0896F5AAD9133A952AAE95E8702C6B5D000763690CB479152E47F9ADA39C7F829634574318
tmp_aes_key = 0F2A63445BB00F66B007950ADFAB9339F6569E8E01B141FE1D70A636F6410D55
tmp_aes_iv = 2F791034A534104CC5FEAFDB7BFEF284FBA1EDA8ADDF7B64656560D5F90FAA4E</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 06B81C8140957D1A4142A2ABEB6E19CED9AC327FBA0D89B5A2AF30A7D7AC5ACB8FDC325309812DA78B0F2CA63C1F9A74F3D7BA663B864EC503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004754FC037AB751BF58CAA3E48F1617B43C84D38DBA56F7D7413B78F5607B12EB49B62C83CB356C9643BB1B3C693477EECED93B5B25DA9E36AD9A8DF3F6E665333FAF7D9FB6B7490353BC6C2C2300927714F98D1B6D7E7C91F0975DC03E13CF3914D6CB2B9FC27E21460A2A662494BB0572566482617437BD6F2A5E76F51613ED521940CE04B0CC3F45EF4036E82A34C94A0C649E55C5C8D78E859B632F11D37A900F01780F8E493AC89C5EC5C4D13D35680578C81E7AC2978BE0812D22391E0B4CC7E25BD12C32DBB416D3CFC5E689299C8B9B75D899D52F26876AB5A047D63E31096AF4010DF9159F6486AF46307FD28E8908ECF2CB3A77BAB7ADB42989CB1774FA62672C8A65EF81EDE1DC
answer = BA0D89B5A2AF30A7D7AC5ACB8FDC325309812DA78B0F2CA63C1F9A74F3D7BA663B864EC503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001004754FC037AB751BF58CAA3E48F1617B43C84D38DBA56F7D7413B78F5607B12EB49B62C83CB356C9643BB1B3C693477EECED93B5B25DA9E36AD9A8DF3F6E665333FAF7D9FB6B7490353BC6C2C2300927714F98D1B6D7E7C91F0975DC03E13CF3914D6CB2B9FC27E21460A2A662494BB0572566482617437BD6F2A5E76F51613ED521940CE04B0CC3F45EF4036E82A34C94A0C649E55C5C8D78E859B632F11D37A900F01780F8E493AC89C5EC5C4D13D35680578C81E7AC2978BE0812D22391E0B4CC7E25BD12C32DBB416D3CFC5E689299C8B9B75D899D52F26876AB5A047D63E31096AF4010DF9159F6486AF46307FD28E8908ECF2CB3A77BAB7ADB42989CB1774FA62672C8A65EF81EDE1DC</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 A2 AF 30 A7 D7 AC 5A CB 8F DC 32 53
0010 | 09 81 2D A7 8B 0F 2C A6 3C 1F 9A 74 F3 D7 BA 66
0020 | 3B 86 4E C5 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 47 54 FC 03 7A B7 51 BF 58 CA A3 E4 8F 16 17 B4
0140 | 3C 84 D3 8D BA 56 F7 D7 41 3B 78 F5 60 7B 12 EB
0150 | 49 B6 2C 83 CB 35 6C 96 43 BB 1B 3C 69 34 77 EE
0160 | CE D9 3B 5B 25 DA 9E 36 AD 9A 8D F3 F6 E6 65 33
0170 | 3F AF 7D 9F B6 B7 49 03 53 BC 6C 2C 23 00 92 77
0180 | 14 F9 8D 1B 6D 7E 7C 91 F0 97 5D C0 3E 13 CF 39
0190 | 14 D6 CB 2B 9F C2 7E 21 46 0A 2A 66 24 94 BB 05
01A0 | 72 56 64 82 61 74 37 BD 6F 2A 5E 76 F5 16 13 ED
01B0 | 52 19 40 CE 04 B0 CC 3F 45 EF 40 36 E8 2A 34 C9
01C0 | 4A 0C 64 9E 55 C5 C8 D7 8E 85 9B 63 2F 11 D3 7A
01D0 | 90 0F 01 78 0F 8E 49 3A C8 9C 5E C5 C4 D1 3D 35
01E0 | 68 05 78 C8 1E 7A C2 97 8B E0 81 2D 22 39 1E 0B
01F0 | 4C C7 E2 5B D1 2C 32 DB B4 16 D3 CF C5 E6 89 29
0200 | 9C 8B 9B 75 D8 99 D5 2F 26 87 6A B5 A0 47 D6 3E
0210 | 31 09 6A F4 01 0D F9 15 9F 64 86 AF 46 30 7F D2
0220 | 8E 89 08 EC F2 CB 3A 77 BA B7 AD B4 29 89 CB 17
0230 | 74 FA 62 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001004754FC037AB751BF58CAA3E4</code> <code>8F1617B43C84D38DBA56F7D7413B78F5</code> <code>607B12EB49B62C83CB356C9643BB1B3C</code> <code>693477EECED93B5B25DA9E36AD9A8DF3</code> <code>F6E665333FAF7D9FB6B7490353BC6C2C</code> <code>2300927714F98D1B6D7E7C91F0975DC0</code> <code>3E13CF3914D6CB2B9FC27E21460A2A66</code> <code>2494BB0572566482617437BD6F2A5E76</code> <code>F51613ED521940CE04B0CC3F45EF4036</code> <code>E82A34C94A0C649E55C5C8D78E859B63</code> <code>2F11D37A900F01780F8E493AC89C5EC5</code> <code>C4D13D35680578C81E7AC2978BE0812D</code> <code>22391E0B4CC7E25BD12C32DBB416D3CF</code> <code>C5E689299C8B9B75D899D52F26876AB5</code> <code>A047D63E31096AF4010DF9159F6486AF</code> <code>46307FD28E8908ECF2CB3A77BAB7ADB4</code><br> <code>2989CB17</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>74FA6267</code> (1734539892 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 1FB117B69437A41C91F23209E035DF4D163B2AA3496E0C84D36473AE24846786BEC81B1EF3E07803BD5B9039FF425B93544BC324C286DA6E388601DF3EB2BC097C4C64D1177A83F464CB916541EFE11DF8CC413C86133E6F7BD20269FDA07B9802B1B728051BC33A2A68467C96473970BB8627033EF44304949A63771A7F82C09EAF95975DCECCD9EDDEFB81B0C4E11F747992C91F48DE90EECB88DF04F5035083D97F16CD44120FF11AB252E11D973C31830680FDCA21AFB13E02734D060819FD0EF2898BEAE3E550DFCFD2E17D8F9B1C35E5A07DE08836A95C1F3F5228D5E5F237742B9E5351AE5F8C09AA7B5FC4C93FBA75CFA9C4D9A03B931D10AFA11052</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 0790A4DB71C8A8A7E19C2E85A8C57DB3546B1C39A7E5746945F4FA1045F52440B636F8E1E59AD077159FBEB7774B6F10971053D5AAAB89A1D4F9E3AE9A3700923E46950191EEA8A05BB88A42C43A4006A7F0740966A39576A4629B09907A9CE010D0A54CFCD4F12811E54C4EAF0BA6FFA2C580407137B4EB0DA5FB47AF6471981380D3088DC1903B67249034E43670C7C1E666DCAFA61021F6389AD9D73E7A6BF0A4BAB4A82D693F7CCFD1DD52C3DB30316440E04BE2D6CEBB8ADDDD659D202066B986CC261EB6B7F0785B4FDBB02379211ACF73B2421A0778589BE705D078E34F77F9FCA2753C0FBC0D73604217E3A0A48C81C26C529DE8CB32AFADEAC1FCDE</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 A2 AF 30 A7 D7 AC 5A CB 8F DC 32 53
0010 | 09 81 2D A7 8B 0F 2C A6 3C 1F 9A 74 F3 D7 BA 66
0020 | 3B 86 4E C5 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 07 90 A4 DB 71 C8 A8 A7 E1 9C 2E 85 A8 C5 7D B3
0040 | 54 6B 1C 39 A7 E5 74 69 45 F4 FA 10 45 F5 24 40
0050 | B6 36 F8 E1 E5 9A D0 77 15 9F BE B7 77 4B 6F 10
0060 | 97 10 53 D5 AA AB 89 A1 D4 F9 E3 AE 9A 37 00 92
0070 | 3E 46 95 01 91 EE A8 A0 5B B8 8A 42 C4 3A 40 06
0080 | A7 F0 74 09 66 A3 95 76 A4 62 9B 09 90 7A 9C E0
0090 | 10 D0 A5 4C FC D4 F1 28 11 E5 4C 4E AF 0B A6 FF
00A0 | A2 C5 80 40 71 37 B4 EB 0D A5 FB 47 AF 64 71 98
00B0 | 13 80 D3 08 8D C1 90 3B 67 24 90 34 E4 36 70 C7
00C0 | C1 E6 66 DC AF A6 10 21 F6 38 9A D9 D7 3E 7A 6B
00D0 | F0 A4 BA B4 A8 2D 69 3F 7C CF D1 DD 52 C3 DB 30
00E0 | 31 64 40 E0 4B E2 D6 CE BB 8A DD DD 65 9D 20 20
00F0 | 66 B9 86 CC 26 1E B6 B7 F0 78 5B 4F DB B0 23 79
0100 | 21 1A CF 73 B2 42 1A 07 78 58 9B E7 05 D0 78 E3
0110 | 4F 77 F9 FC A2 75 3C 0F BC 0D 73 60 42 17 E3 A0
0120 | A4 8C 81 C2 6C 52 9D E8 CB 32 AF AD EA C1 FC DE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001000790A4DB71C8A8A7E19C2E85</code> <code>A8C57DB3546B1C39A7E5746945F4FA10</code> <code>45F52440B636F8E1E59AD077159FBEB7</code> <code>774B6F10971053D5AAAB89A1D4F9E3AE</code> <code>9A3700923E46950191EEA8A05BB88A42</code> <code>C43A4006A7F0740966A39576A4629B09</code> <code>907A9CE010D0A54CFCD4F12811E54C4E</code> <code>AF0BA6FFA2C580407137B4EB0DA5FB47</code> <code>AF6471981380D3088DC1903B67249034</code> <code>E43670C7C1E666DCAFA61021F6389AD9</code> <code>D73E7A6BF0A4BAB4A82D693F7CCFD1DD</code> <code>52C3DB30316440E04BE2D6CEBB8ADDDD</code> <code>659D202066B986CC261EB6B7F0785B4F</code> <code>DBB02379211ACF73B2421A0778589BE7</code> <code>05D078E34F77F9FCA2753C0FBC0D7360</code> <code>4217E3A0A48C81C26C529DE8CB32AFAD</code><br> <code>EAC1FCDE</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366A2AF30A7D7AC5ACB8FDC325309812DA78B0F2CA63C1F9A74F3D7BA663B864EC50000000000000000FE0001000790A4DB71C8A8A7E19C2E85A8C57DB3546B1C39A7E5746945F4FA1045F52440B636F8E1E59AD077159FBEB7774B6F10971053D5AAAB89A1D4F9E3AE9A3700923E46950191EEA8A05BB88A42C43A4006A7F0740966A39576A4629B09907A9CE010D0A54CFCD4F12811E54C4EAF0BA6FFA2C580407137B4EB0DA5FB47AF6471981380D3088DC1903B67249034E43670C7C1E666DCAFA61021F6389AD9D73E7A6BF0A4BAB4A82D693F7CCFD1DD52C3DB30316440E04BE2D6CEBB8ADDDD659D202066B986CC261EB6B7F0785B4FDBB02379211ACF73B2421A0778589BE705D078E34F77F9FCA2753C0FBC0D73604217E3A0A48C81C26C529DE8CB32AFADEAC1FCDE
padding = CE882AB23F16A8058318C7AB
tmp_aes_key = 0F2A63445BB00F66B007950ADFAB9339F6569E8E01B141FE1D70A636F6410D55
tmp_aes_iv = 2F791034A534104CC5FEAFDB7BFEF284FBA1EDA8ADDF7B64656560D5F90FAA4E</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 4D36ED618F67C008AF60B33F609DCE76BE29C3F4B378184600355FB6050F93E07EA6FDF36A12ABB21FCB108DEF62A034E2CB0A9A8535374C005736C010AE2C983147D0A46052A58D0709ACB5D573B7F3B6C9A70C9A6534C187453A8B8E1BCF85B6B28245203A5A6552A3DD02F3003695A168482171D5E561C33FEBC2C4E0A6ED5CF6C3BC8702EFC30E6DA85641E8704E1EB8FE8D8B50069A4385EDB12685830DC6D3AFEA37A636DE97614D26B0C290A658CABC6745102C96337FF742B0BC23928D764B1F6EFBF08DE6F02D90BF19445DDF5E807B6F52E620E5A5C313A4EED181BA654E4C5593E9F91102C92F3A35EAA56C164FA0637BEF85FE885F7B99F75FCBB0FFBF514A9C0F448A651FF049E149A86A349741088AD97C4ECF8F6F561FB47D90C0376DD81D300000E4082B5C0AED97BE1033C3162EC84A9E39E7392FDFFD465F7F425E0FFF2A8AE35AFFC366A610E1</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 0C 33 09 00 74 FA 62 67
0010 | 78 01 00 00 1F 5F 04 F5 A2 AF 30 A7 D7 AC 5A CB
0020 | 8F DC 32 53 09 81 2D A7 8B 0F 2C A6 3C 1F 9A 74
0030 | F3 D7 BA 66 3B 86 4E C5 FE 50 01 00 4D 36 ED 61
0040 | 8F 67 C0 08 AF 60 B3 3F 60 9D CE 76 BE 29 C3 F4
0050 | B3 78 18 46 00 35 5F B6 05 0F 93 E0 7E A6 FD F3
0060 | 6A 12 AB B2 1F CB 10 8D EF 62 A0 34 E2 CB 0A 9A
0070 | 85 35 37 4C 00 57 36 C0 10 AE 2C 98 31 47 D0 A4
0080 | 60 52 A5 8D 07 09 AC B5 D5 73 B7 F3 B6 C9 A7 0C
0090 | 9A 65 34 C1 87 45 3A 8B 8E 1B CF 85 B6 B2 82 45
00A0 | 20 3A 5A 65 52 A3 DD 02 F3 00 36 95 A1 68 48 21
00B0 | 71 D5 E5 61 C3 3F EB C2 C4 E0 A6 ED 5C F6 C3 BC
00C0 | 87 02 EF C3 0E 6D A8 56 41 E8 70 4E 1E B8 FE 8D
00D0 | 8B 50 06 9A 43 85 ED B1 26 85 83 0D C6 D3 AF EA
00E0 | 37 A6 36 DE 97 61 4D 26 B0 C2 90 A6 58 CA BC 67
00F0 | 45 10 2C 96 33 7F F7 42 B0 BC 23 92 8D 76 4B 1F
0100 | 6E FB F0 8D E6 F0 2D 90 BF 19 44 5D DF 5E 80 7B
0110 | 6F 52 E6 20 E5 A5 C3 13 A4 EE D1 81 BA 65 4E 4C
0120 | 55 93 E9 F9 11 02 C9 2F 3A 35 EA A5 6C 16 4F A0
0130 | 63 7B EF 85 FE 88 5F 7B 99 F7 5F CB B0 FF BF 51
0140 | 4A 9C 0F 44 8A 65 1F F0 49 E1 49 A8 6A 34 97 41
0150 | 08 8A D9 7C 4E CF 8F 6F 56 1F B4 7D 90 C0 37 6D
0160 | D8 1D 30 00 00 E4 08 2B 5C 0A ED 97 BE 10 33 C3
0170 | 16 2E C8 4A 9E 39 E7 39 2F DF FD 46 5F 7F 42 5E
0180 | 0F FF 2A 8A E3 5A FF C3 66 A6 10 E1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0C33090074FA6267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001004D36ED618F67C008AF60B33F</code> <code>609DCE76BE29C3F4B378184600355FB6</code> <code>050F93E07EA6FDF36A12ABB21FCB108D</code> <code>EF62A034E2CB0A9A8535374C005736C0</code> <code>10AE2C983147D0A46052A58D0709ACB5</code> <code>D573B7F3B6C9A70C9A6534C187453A8B</code> <code>8E1BCF85B6B28245203A5A6552A3DD02</code> <code>F3003695A168482171D5E561C33FEBC2</code> <code>C4E0A6ED5CF6C3BC8702EFC30E6DA856</code> <code>41E8704E1EB8FE8D8B50069A4385EDB1</code> <code>2685830DC6D3AFEA37A636DE97614D26</code> <code>B0C290A658CABC6745102C96337FF742</code> <code>B0BC23928D764B1F6EFBF08DE6F02D90</code> <code>BF19445DDF5E807B6F52E620E5A5C313</code> <code>A4EED181BA654E4C5593E9F91102C92F</code> <code>3A35EAA56C164FA0637BEF85FE885F7B</code> <code>99F75FCBB0FFBF514A9C0F448A651FF0</code> <code>49E149A86A349741088AD97C4ECF8F6F</code> <code>561FB47D90C0376DD81D300000E4082B</code> <code>5C0AED97BE1033C3162EC84A9E39E739</code> <code>2FDFFD465F7F425E0FFF2A8AE35AFFC3</code><br> <code>66A610E1</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2E09DDEE6BEA32B35A7C0E31D29097583F0E7F460E5293548610D991A85694FBA2C4626F7A02242717330DBA3273AF5871D21D717384B0EFC28A7088F4C06AC34217BAAC56A3C871F949E9CD1FFA88489E435A73972999A5D654612B4D83AF7EC2FA36AC8FAB54AFD0F65C4DC8CBB075A71798D8F42E77C0AD976B2A066BB17462732BE25051B6346CADB509A2D456E6226B14CD52EB90E1ECEE54A69C292E6C53E1A0DF5A9D671E1AF12DF128F83EFF6F055198BA84C2497A062D895A5814C427E484282E3078F388870652543D44A9F7B4388A695B105D06D0C23E628ECA405D01EB97EAC9E420DB17FC0328786FE539D86169E5861036050E8EDA85DB3445</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E0 75 06 77 FA 62 67
0010 | 34 00 00 00 34 F7 CB 3B A2 AF 30 A7 D7 AC 5A CB
0020 | 8F DC 32 53 09 81 2D A7 8B 0F 2C A6 3C 1F 9A 74
0030 | F3 D7 BA 66 3B 86 4E C5 AB 6F B9 94 2A B9 EE DB
0040 | 07 3D FD B9 07 DB 2E B0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E0750677FA6267</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>A2AF30A7D7AC5ACB8FDC325309812DA7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8B0F2CA63C1F9A74F3D7BA663B864EC5</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>AB6FB9942AB9EEDB073DFDB907DB2EB0</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

