<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 84 33 05 00 81 4D D4 68
0010 | 14 00 00 00 F1 8E 7E BE 3C AD F8 67 1C ED A5 99
0020 | 90 10 4E 4C E4 09 A1 20</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>84330500814DD468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 A1 86 81 4D D4 68
0010 | 50 00 00 00 63 24 16 05 3C AD F8 67 1C ED A5 99
0020 | 90 10 4E 4C E4 09 A1 20 74 6E F0 6B EC 71 11 22
0030 | 79 DC 14 E3 E8 10 FF 37 08 17 65 49 0A 2D B8 5D
0040 | 99 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E8A186814DD468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081765490A2DB85D99000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1685833943585676697</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1685833943585676697</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1685833943585676697 = 1269107803 * 1328361499</code></p>
<pre><code>p = 1269107803
q = 1328361499</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 17 65 49 0A 2D B8 5D 99 00 00 00
0010 | 04 4B A5 0C 5B 00 00 00 04 4F 2D 30 1B 00 00 00
0020 | 3C AD F8 67 1C ED A5 99 90 10 4E 4C E4 09 A1 20
0030 | 74 6E F0 6B EC 71 11 22 79 DC 14 E3 E8 10 FF 37
0040 | AA 5D FF AE BC 70 82 2F D6 BB E0 14 9D 5C 25 FE
0050 | B0 00 54 60 E9 36 34 E4 21 A0 A4 F3 05 AA 86 10
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081765490A2DB85D99000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1685833943585676697</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044BA50C5B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1269107803</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044F2D301B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1328361499</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>AA5DFFAEBC70822FD6BBE0149D5C25FE</code> <code>B0005460E93634E421A0A4F305AA8610</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081765490A2DB85D99000000044BA50C5B000000044F2D301B0000003CADF8671CEDA59990104E4CE409A120746EF06BEC71112279DC14E3E810FF37AA5DFFAEBC70822FD6BBE0149D5C25FEB0005460E93634E421A0A4F305AA861002000000
random_padding_bytes = BB518FC51DC10AA4237E969F7E3B936187AE7D3C2811FB5F5DB81F312DBDD157660FF5F94BC596B6FCC4F279038FE13C3598448C3AEEFA550E561384960B5CCFB3854EDBE52D775AA9AAFDE2C2B3BDB415F9A9DE637E76D86B162C21</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 7D6E2C3CB15DAD68889213ED0D325677858A69B9D233D000A56A4A8A173D66A3B79B0D9C07A859179DA335089E54D933AC24F0B4FA5198AEA16969EC3B60F4DAFEA280EA51EDD77B6B82C435BE0550184BE8D4B0125C81445F637646BC4A72A2D31F5C52DE39782383CF31C4A6CCDF34C0B1E9AC0E5E810D1E59EFD75D0E1CB207CC3E3EE5EF446412215FD45D713844A8B39AB74ECB0083838988973E7DBBB179A739699BE612198851E5A38CA2156208A001FFBF28F7C3D74602DBE5C7D763902FC08E1D17FB20B4786EB9FCD2D8D7C24897F322393DE85B9FFA5E1550D805F83D4632195A421A625037E5998C35A27356D38267E38D1D81EF8FE787AD4D33</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 90 07 09 00 81 4D D4 68
0010 | 40 01 00 00 BE E4 12 D7 3C AD F8 67 1C ED A5 99
0020 | 90 10 4E 4C E4 09 A1 20 74 6E F0 6B EC 71 11 22
0030 | 79 DC 14 E3 E8 10 FF 37 04 4B A5 0C 5B 00 00 00
0040 | 04 4F 2D 30 1B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 7D 6E 2C 3C B1 5D AD 68 88 92 13 ED
0060 | 0D 32 56 77 85 8A 69 B9 D2 33 D0 00 A5 6A 4A 8A
0070 | 17 3D 66 A3 B7 9B 0D 9C 07 A8 59 17 9D A3 35 08
0080 | 9E 54 D9 33 AC 24 F0 B4 FA 51 98 AE A1 69 69 EC
0090 | 3B 60 F4 DA FE A2 80 EA 51 ED D7 7B 6B 82 C4 35
00A0 | BE 05 50 18 4B E8 D4 B0 12 5C 81 44 5F 63 76 46
00B0 | BC 4A 72 A2 D3 1F 5C 52 DE 39 78 23 83 CF 31 C4
00C0 | A6 CC DF 34 C0 B1 E9 AC 0E 5E 81 0D 1E 59 EF D7
00D0 | 5D 0E 1C B2 07 CC 3E 3E E5 EF 44 64 12 21 5F D4
00E0 | 5D 71 38 44 A8 B3 9A B7 4E CB 00 83 83 89 88 97
00F0 | 3E 7D BB B1 79 A7 39 69 9B E6 12 19 88 51 E5 A3
0100 | 8C A2 15 62 08 A0 01 FF BF 28 F7 C3 D7 46 02 DB
0110 | E5 C7 D7 63 90 2F C0 8E 1D 17 FB 20 B4 78 6E B9
0120 | FC D2 D8 D7 C2 48 97 F3 22 39 3D E8 5B 9F FA 5E
0130 | 15 50 D8 05 F8 3D 46 32 19 5A 42 1A 62 50 37 E5
0140 | 99 8C 35 A2 73 56 D3 82 67 E3 8D 1D 81 EF 8F E7
0150 | 87 AD 4D 33</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>90070900814DD468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044BA50C5B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1269107803</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044F2D301B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1328361499</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001007D6E2C3CB15DAD68889213ED</code> <code>0D325677858A69B9D233D000A56A4A8A</code> <code>173D66A3B79B0D9C07A859179DA33508</code> <code>9E54D933AC24F0B4FA5198AEA16969EC</code> <code>3B60F4DAFEA280EA51EDD77B6B82C435</code> <code>BE0550184BE8D4B0125C81445F637646</code> <code>BC4A72A2D31F5C52DE39782383CF31C4</code> <code>A6CCDF34C0B1E9AC0E5E810D1E59EFD7</code> <code>5D0E1CB207CC3E3EE5EF446412215FD4</code> <code>5D713844A8B39AB74ECB008383898897</code> <code>3E7DBBB179A739699BE612198851E5A3</code> <code>8CA2156208A001FFBF28F7C3D74602DB</code> <code>E5C7D763902FC08E1D17FB20B4786EB9</code> <code>FCD2D8D7C24897F322393DE85B9FFA5E</code> <code>1550D805F83D4632195A421A625037E5</code> <code>998C35A27356D38267E38D1D81EF8FE7</code><br> <code>87AD4D33</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 3C BB 81 4D D4 68
0010 | 78 02 00 00 5C 07 E8 D0 3C AD F8 67 1C ED A5 99
0020 | 90 10 4E 4C E4 09 A1 20 74 6E F0 6B EC 71 11 22
0030 | 79 DC 14 E3 E8 10 FF 37 FE 50 02 00 D1 2A 12 8E
0040 | F1 AF FF B1 3E A6 4D 55 DC F1 2F B6 D9 49 8E 5D
0050 | B4 AD 73 65 82 AF E8 E7 28 D2 6E 3B 9D 96 92 4F
0060 | 8A 59 67 2D 8F 2F F0 BB 5A 7C CC EB C1 75 71 D7
0070 | C9 1B FE 4D 69 87 18 0F 77 98 B8 82 BF AF 0C 41
0080 | 8F 5B 6D 8E 9E 97 AA D1 D8 66 4F 41 5B 4A D8 39
0090 | 83 35 28 A2 26 F5 05 2A C3 0F AE 88 12 AA E1 11
00A0 | 51 51 9E 10 02 89 F3 05 48 21 88 4C 83 F2 59 F5
00B0 | 97 59 DE 70 19 6A 63 ED 98 FE 6F E7 7D F7 A0 4B
00C0 | 64 9E 77 D1 2A 06 51 36 C2 DD BF D6 FC 21 80 88
00D0 | B7 08 CB 88 A0 44 D3 3D 46 0E 1E F3 9D 4E 8C C0
00E0 | F3 6B CD BE D7 AC 49 26 25 05 A8 12 1D 3D 9A C7
00F0 | 2D 1B 86 38 D2 5A D2 00 39 A7 3B CD 7A 38 11 F2
0100 | 9A DA 5C 57 22 EF EC 0F 14 AD A5 9F 49 8F CA 40
0110 | 17 7D E5 67 02 3A E6 30 66 64 BA A5 68 B7 B5 21
0120 | E8 69 02 22 18 01 25 E6 4A 7F 8C C1 62 36 91 52
0130 | 8D A6 45 0B 00 F7 3F 29 69 D8 51 DA 8C 3D DB 22
0140 | 03 A5 EF BF D5 24 30 07 C7 19 34 BB 48 A8 BD 86
0150 | 27 9A 99 BF 25 FD E2 79 14 FC E4 63 C0 88 85 69
0160 | 67 16 CE 4E E6 74 3F 4A 50 ED E1 9C 83 7D F2 6C
0170 | 31 30 FD E9 F4 C7 87 65 BD DC 2C DB EC 88 77 52
0180 | C4 8A 09 4D 6C 65 CF D0 5D DD 3B D4 AC 3A 76 3B
0190 | 40 64 4C 36 F3 CB 33 38 25 3B 80 88 06 08 2F B5
01A0 | 1B C1 7C CB 5A 5D B7 22 02 69 2C 88 88 93 BD 77
01B0 | 5D 0C D5 8C 19 17 2E 4C 00 48 4A 64 80 C6 71 D9
01C0 | 56 43 44 9A 54 95 E5 DD 89 27 33 1B D3 2D ED B9
01D0 | 84 E3 0C 79 41 E8 9E 0C DE 32 ED C1 28 26 FA DA
01E0 | 71 89 65 3B CB 09 C9 DA DE A7 A4 DE A9 67 21 EC
01F0 | 22 18 59 B5 F5 FF 5D B0 9F 42 C1 1E 97 0D 03 A1
0200 | BD 21 2A 5F 64 08 8F 2A CF F2 1E CB 4E DA E5 57
0210 | FF B5 9B 42 12 F1 6A 68 F4 0F 81 11 DE 94 A9 41
0220 | 13 F2 EC DC F0 35 F1 18 11 4B DE 04 55 16 69 E4
0230 | AA B8 E7 DB A9 AC 42 BC C0 DB 05 B1 6E 22 AD 1E
0240 | AA 1E C5 C3 51 6F B1 9D 29 80 FF 74 58 03 31 A3
0250 | DF 53 DF C4 C4 20 3C 79 3A D5 07 8A 64 8F 4E 15
0260 | F6 60 81 39 24 93 55 91 78 6E 00 9A C9 49 2E 90
0270 | 59 F4 78 34 C3 4B 0A BC B2 BF 44 09 C7 AA 94 96
0280 | 35 75 3D 85 E1 C9 9A 79 72 A3 90 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01303CBB814DD468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200D12A128EF1AFFFB13EA64D55</code> <code>DCF12FB6D9498E5DB4AD736582AFE8E7</code> <code>28D26E3B9D96924F8A59672D8F2FF0BB</code> <code>5A7CCCEBC17571D7C91BFE4D6987180F</code> <code>7798B882BFAF0C418F5B6D8E9E97AAD1</code> <code>D8664F415B4AD839833528A226F5052A</code> <code>C30FAE8812AAE11151519E100289F305</code> <code>4821884C83F259F59759DE70196A63ED</code> <code>98FE6FE77DF7A04B649E77D12A065136</code> <code>C2DDBFD6FC218088B708CB88A044D33D</code> <code>460E1EF39D4E8CC0F36BCDBED7AC4926</code> <code>2505A8121D3D9AC72D1B8638D25AD200</code> <code>39A73BCD7A3811F29ADA5C5722EFEC0F</code> <code>14ADA59F498FCA40177DE567023AE630</code> <code>6664BAA568B7B521E8690222180125E6</code> <code>4A7F8CC1623691528DA6450B00F73F29</code> <code>69D851DA8C3DDB2203A5EFBFD5243007</code> <code>C71934BB48A8BD86279A99BF25FDE279</code> <code>14FCE463C08885696716CE4EE6743F4A</code> <code>50EDE19C837DF26C3130FDE9F4C78765</code> <code>BDDC2CDBEC887752C48A094D6C65CFD0</code> <code>5DDD3BD4AC3A763B40644C36F3CB3338</code> <code>253B808806082FB51BC17CCB5A5DB722</code> <code>02692C888893BD775D0CD58C19172E4C</code> <code>00484A6480C671D95643449A5495E5DD</code> <code>8927331BD32DEDB984E30C7941E89E0C</code> <code>DE32EDC12826FADA7189653BCB09C9DA</code> <code>DEA7A4DEA96721EC221859B5F5FF5DB0</code> <code>9F42C11E970D03A1BD212A5F64088F2A</code> <code>CFF21ECB4EDAE557FFB59B4212F16A68</code> <code>F40F8111DE94A94113F2ECDCF035F118</code> <code>114BDE04551669E4AAB8E7DBA9AC42BC</code> <code>C0DB05B16E22AD1EAA1EC5C3516FB19D</code> <code>2980FF74580331A3DF53DFC4C4203C79</code> <code>3AD5078A648F4E15F660813924935591</code> <code>786E009AC9492E9059F47834C34B0ABC</code> <code>B2BF4409C7AA949635753D85E1C99A79</code><br> <code>72A39045</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = D12A128EF1AFFFB13EA64D55DCF12FB6D9498E5DB4AD736582AFE8E728D26E3B9D96924F8A59672D8F2FF0BB5A7CCCEBC17571D7C91BFE4D6987180F7798B882BFAF0C418F5B6D8E9E97AAD1D8664F415B4AD839833528A226F5052AC30FAE8812AAE11151519E100289F3054821884C83F259F59759DE70196A63ED98FE6FE77DF7A04B649E77D12A065136C2DDBFD6FC218088B708CB88A044D33D460E1EF39D4E8CC0F36BCDBED7AC49262505A8121D3D9AC72D1B8638D25AD20039A73BCD7A3811F29ADA5C5722EFEC0F14ADA59F498FCA40177DE567023AE6306664BAA568B7B521E8690222180125E64A7F8CC1623691528DA6450B00F73F2969D851DA8C3DDB2203A5EFBFD5243007C71934BB48A8BD86279A99BF25FDE27914FCE463C08885696716CE4EE6743F4A50EDE19C837DF26C3130FDE9F4C78765BDDC2CDBEC887752C48A094D6C65CFD05DDD3BD4AC3A763B40644C36F3CB3338253B808806082FB51BC17CCB5A5DB72202692C888893BD775D0CD58C19172E4C00484A6480C671D95643449A5495E5DD8927331BD32DEDB984E30C7941E89E0CDE32EDC12826FADA7189653BCB09C9DADEA7A4DEA96721EC221859B5F5FF5DB09F42C11E970D03A1BD212A5F64088F2ACFF21ECB4EDAE557FFB59B4212F16A68F40F8111DE94A94113F2ECDCF035F118114BDE04551669E4AAB8E7DBA9AC42BCC0DB05B16E22AD1EAA1EC5C3516FB19D2980FF74580331A3DF53DFC4C4203C793AD5078A648F4E15F660813924935591786E009AC9492E9059F47834C34B0ABCB2BF4409C7AA949635753D85E1C99A7972A39045
tmp_aes_key = 59AAC7C88150809F248EFF1B3D3B7D10A4158B3C6AEC448DCF0D78B523AEF91A
tmp_aes_iv = F9B9A84C745C135814442E37299A42B2F3FA89CF2AE75D4ED2E28C98AA5DFFAE</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 0597610D5D57729BECE145AD25B02255E3E9B307BA0D89B53CADF8671CEDA59990104E4CE409A120746EF06BEC71112279DC14E3E810FF3703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010022B54CD47F6FFE13F0DA0783F9C9CEE81F0D2DC2E3D4BA854547CD5768A073695C7F69B534B359CF49EA4D17A0F11887426F8D5EEC25069FAB38C2A19401977DB99CB82502C23915F5510DA2055932BB1B5752A952DBDB239A6C3288C2FF4B1806AB33523022C977188279D039F33C7045E2860B0A299BA1D62DCB441B37D5614B85560D02B1D39291941D7EA5F3BC799683C9F107136BB7080F7F5670145F6AA1D18549DD1BDA8F7D0CAA5F13A9384DE02EAB0F9C774BC14CF8BED72720A4EF3ADE3D2384C95D7D575C5C9DF8C7BE06D0F9CAF640512B5F4FADE3B0012A5000478F225B68E13193672A6842B43F7932969D0B7E63349B34AD151EDC42A9608A814DD4686D3E4F1132CC2D0D
answer = BA0D89B53CADF8671CEDA59990104E4CE409A120746EF06BEC71112279DC14E3E810FF3703000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010022B54CD47F6FFE13F0DA0783F9C9CEE81F0D2DC2E3D4BA854547CD5768A073695C7F69B534B359CF49EA4D17A0F11887426F8D5EEC25069FAB38C2A19401977DB99CB82502C23915F5510DA2055932BB1B5752A952DBDB239A6C3288C2FF4B1806AB33523022C977188279D039F33C7045E2860B0A299BA1D62DCB441B37D5614B85560D02B1D39291941D7EA5F3BC799683C9F107136BB7080F7F5670145F6AA1D18549DD1BDA8F7D0CAA5F13A9384DE02EAB0F9C774BC14CF8BED72720A4EF3ADE3D2384C95D7D575C5C9DF8C7BE06D0F9CAF640512B5F4FADE3B0012A5000478F225B68E13193672A6842B43F7932969D0B7E63349B34AD151EDC42A9608A814DD4686D3E4F1132CC2D0D</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 3C AD F8 67 1C ED A5 99 90 10 4E 4C
0010 | E4 09 A1 20 74 6E F0 6B EC 71 11 22 79 DC 14 E3
0020 | E8 10 FF 37 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 22 B5 4C D4 7F 6F FE 13 F0 DA 07 83 F9 C9 CE E8
0140 | 1F 0D 2D C2 E3 D4 BA 85 45 47 CD 57 68 A0 73 69
0150 | 5C 7F 69 B5 34 B3 59 CF 49 EA 4D 17 A0 F1 18 87
0160 | 42 6F 8D 5E EC 25 06 9F AB 38 C2 A1 94 01 97 7D
0170 | B9 9C B8 25 02 C2 39 15 F5 51 0D A2 05 59 32 BB
0180 | 1B 57 52 A9 52 DB DB 23 9A 6C 32 88 C2 FF 4B 18
0190 | 06 AB 33 52 30 22 C9 77 18 82 79 D0 39 F3 3C 70
01A0 | 45 E2 86 0B 0A 29 9B A1 D6 2D CB 44 1B 37 D5 61
01B0 | 4B 85 56 0D 02 B1 D3 92 91 94 1D 7E A5 F3 BC 79
01C0 | 96 83 C9 F1 07 13 6B B7 08 0F 7F 56 70 14 5F 6A
01D0 | A1 D1 85 49 DD 1B DA 8F 7D 0C AA 5F 13 A9 38 4D
01E0 | E0 2E AB 0F 9C 77 4B C1 4C F8 BE D7 27 20 A4 EF
01F0 | 3A DE 3D 23 84 C9 5D 7D 57 5C 5C 9D F8 C7 BE 06
0200 | D0 F9 CA F6 40 51 2B 5F 4F AD E3 B0 01 2A 50 00
0210 | 47 8F 22 5B 68 E1 31 93 67 2A 68 42 B4 3F 79 32
0220 | 96 9D 0B 7E 63 34 9B 34 AD 15 1E DC 42 A9 60 8A
0230 | 81 4D D4 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010022B54CD47F6FFE13F0DA0783</code> <code>F9C9CEE81F0D2DC2E3D4BA854547CD57</code> <code>68A073695C7F69B534B359CF49EA4D17</code> <code>A0F11887426F8D5EEC25069FAB38C2A1</code> <code>9401977DB99CB82502C23915F5510DA2</code> <code>055932BB1B5752A952DBDB239A6C3288</code> <code>C2FF4B1806AB33523022C977188279D0</code> <code>39F33C7045E2860B0A299BA1D62DCB44</code> <code>1B37D5614B85560D02B1D39291941D7E</code> <code>A5F3BC799683C9F107136BB7080F7F56</code> <code>70145F6AA1D18549DD1BDA8F7D0CAA5F</code> <code>13A9384DE02EAB0F9C774BC14CF8BED7</code> <code>2720A4EF3ADE3D2384C95D7D575C5C9D</code> <code>F8C7BE06D0F9CAF640512B5F4FADE3B0</code> <code>012A5000478F225B68E13193672A6842</code> <code>B43F7932969D0B7E63349B34AD151EDC</code><br> <code>42A9608A</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>814DD468</code> (1758743937 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 7D3442F3834ADCB21A543A636088322C4905C1823AE4AFFCEEC3796AAF8CC58F1B6DE5066DEA1021E9FE7A5C62EC113DF343DB472F152F4014950420158FC48DDC477AD391F5B5992874ADCAB706FEE11BD686DEB78550E04AF9AC1453D56D604436128346B3E2CD3F5F879583D061A740B02E9C61B209DFA693CF2F21A554FDCBB7884BDCB6450645F8A9E32211AE690532CFD03DFAC1D348997316036B01F44090F95CFB9049A82DC1DC6AB098493333730709240F76FA461CAED530B98E1C0086C5186710DB81493FCFDC9FD4C14F1743A30E9026AAB934081E313AC204254C4EAEE4050AF00F857EF810D5B4730CE513A2A53380631F302157A688544107</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 618DB7E6AAA7C23B53F37736EC0494530E1E4BB0A4C05B92068198EA819A7CC2AD6309E8F5812D78784C8B2D3B47894062E2BBB5CE3283049FCC31A1A74387C4D06ED57F3C578B3E1EE0EB948BE055BBAC174B77C85D019F2CFE396BBC20215F1DC3332366808DFAB780BB5A06D1FE954C075677E060B736243A1B72894C56D240E4FE61A69397CDBA5B8C6615A6CFEAD8D9E0EF56F061F8835E28ADCF8E7D1BD0462D1BA806A32530748F3914D35FC811710DF178C91BCAC5AACA324D90F7C349336BB9DE50050363E0EE177D881954DB2984B445C0BD6153540B8747629B5C32AB3791E0C77BFE74CC2FFF44181A5131509EE0DC80B88F6A017925835081FB</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 3C AD F8 67 1C ED A5 99 90 10 4E 4C
0010 | E4 09 A1 20 74 6E F0 6B EC 71 11 22 79 DC 14 E3
0020 | E8 10 FF 37 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 61 8D B7 E6 AA A7 C2 3B 53 F3 77 36 EC 04 94 53
0040 | 0E 1E 4B B0 A4 C0 5B 92 06 81 98 EA 81 9A 7C C2
0050 | AD 63 09 E8 F5 81 2D 78 78 4C 8B 2D 3B 47 89 40
0060 | 62 E2 BB B5 CE 32 83 04 9F CC 31 A1 A7 43 87 C4
0070 | D0 6E D5 7F 3C 57 8B 3E 1E E0 EB 94 8B E0 55 BB
0080 | AC 17 4B 77 C8 5D 01 9F 2C FE 39 6B BC 20 21 5F
0090 | 1D C3 33 23 66 80 8D FA B7 80 BB 5A 06 D1 FE 95
00A0 | 4C 07 56 77 E0 60 B7 36 24 3A 1B 72 89 4C 56 D2
00B0 | 40 E4 FE 61 A6 93 97 CD BA 5B 8C 66 15 A6 CF EA
00C0 | D8 D9 E0 EF 56 F0 61 F8 83 5E 28 AD CF 8E 7D 1B
00D0 | D0 46 2D 1B A8 06 A3 25 30 74 8F 39 14 D3 5F C8
00E0 | 11 71 0D F1 78 C9 1B CA C5 AA CA 32 4D 90 F7 C3
00F0 | 49 33 6B B9 DE 50 05 03 63 E0 EE 17 7D 88 19 54
0100 | DB 29 84 B4 45 C0 BD 61 53 54 0B 87 47 62 9B 5C
0110 | 32 AB 37 91 E0 C7 7B FE 74 CC 2F FF 44 18 1A 51
0120 | 31 50 9E E0 DC 80 B8 8F 6A 01 79 25 83 50 81 FB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100618DB7E6AAA7C23B53F37736</code> <code>EC0494530E1E4BB0A4C05B92068198EA</code> <code>819A7CC2AD6309E8F5812D78784C8B2D</code> <code>3B47894062E2BBB5CE3283049FCC31A1</code> <code>A74387C4D06ED57F3C578B3E1EE0EB94</code> <code>8BE055BBAC174B77C85D019F2CFE396B</code> <code>BC20215F1DC3332366808DFAB780BB5A</code> <code>06D1FE954C075677E060B736243A1B72</code> <code>894C56D240E4FE61A69397CDBA5B8C66</code> <code>15A6CFEAD8D9E0EF56F061F8835E28AD</code> <code>CF8E7D1BD0462D1BA806A32530748F39</code> <code>14D35FC811710DF178C91BCAC5AACA32</code> <code>4D90F7C349336BB9DE50050363E0EE17</code> <code>7D881954DB2984B445C0BD6153540B87</code> <code>47629B5C32AB3791E0C77BFE74CC2FFF</code> <code>44181A5131509EE0DC80B88F6A017925</code><br> <code>835081FB</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643663CADF8671CEDA59990104E4CE409A120746EF06BEC71112279DC14E3E810FF370000000000000000FE000100618DB7E6AAA7C23B53F37736EC0494530E1E4BB0A4C05B92068198EA819A7CC2AD6309E8F5812D78784C8B2D3B47894062E2BBB5CE3283049FCC31A1A74387C4D06ED57F3C578B3E1EE0EB948BE055BBAC174B77C85D019F2CFE396BBC20215F1DC3332366808DFAB780BB5A06D1FE954C075677E060B736243A1B72894C56D240E4FE61A69397CDBA5B8C6615A6CFEAD8D9E0EF56F061F8835E28ADCF8E7D1BD0462D1BA806A32530748F3914D35FC811710DF178C91BCAC5AACA324D90F7C349336BB9DE50050363E0EE177D881954DB2984B445C0BD6153540B8747629B5C32AB3791E0C77BFE74CC2FFF44181A5131509EE0DC80B88F6A017925835081FB
padding = ADC202C60DD0CC3F3702A2C0
tmp_aes_key = 59AAC7C88150809F248EFF1B3D3B7D10A4158B3C6AEC448DCF0D78B523AEF91A
tmp_aes_iv = F9B9A84C745C135814442E37299A42B2F3FA89CF2AE75D4ED2E28C98AA5DFFAE</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 6D45AB1BED0A8BD9C1A6DA6B9CCF6C5D7E7FDB0069BD339F94D9471D973D5AE3D9CA0CF91654B27AE6CBA255237302721567D5FE63596548755F00A535E32E45A8AC85275797A8515D112DCF1070DFFF9925E2CB1778FEDD6DE749E3CC46728E45C15E19978E3045B7B0D74B7EBF94627BE257CBD207C2EB52AAB60CB51E6F76831DF08DCABDDCE9F68BC06D62990E037AFA5520F61EE248F47CBE6A71F0A6F2A99E542BC8BFC9CE0F649B23042FA3B0096C291572011E963F5BC7522374548E9A2D514DCFDCE86A2EE2B95DB9BFE960060A9E4A502ADFDDA1BC3167043BC4DD2A063132AFB27135C4CD2C864CD1F4A44488B56465F0FDA4511E7C5DE2DFAB7BD298EDFBF4C77B568C7F2C207D7DACC881ACB4DC0D0A534741201B6D09266AE3CA50ED0B2F469FB2A489847905D1E0C66D4C8D67A1311C00DAA77C51C2320E1C2D23EDE8284A6821F137ACBEE76530A8</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 94 07 09 00 81 4D D4 68
0010 | 78 01 00 00 1F 5F 04 F5 3C AD F8 67 1C ED A5 99
0020 | 90 10 4E 4C E4 09 A1 20 74 6E F0 6B EC 71 11 22
0030 | 79 DC 14 E3 E8 10 FF 37 FE 50 01 00 6D 45 AB 1B
0040 | ED 0A 8B D9 C1 A6 DA 6B 9C CF 6C 5D 7E 7F DB 00
0050 | 69 BD 33 9F 94 D9 47 1D 97 3D 5A E3 D9 CA 0C F9
0060 | 16 54 B2 7A E6 CB A2 55 23 73 02 72 15 67 D5 FE
0070 | 63 59 65 48 75 5F 00 A5 35 E3 2E 45 A8 AC 85 27
0080 | 57 97 A8 51 5D 11 2D CF 10 70 DF FF 99 25 E2 CB
0090 | 17 78 FE DD 6D E7 49 E3 CC 46 72 8E 45 C1 5E 19
00A0 | 97 8E 30 45 B7 B0 D7 4B 7E BF 94 62 7B E2 57 CB
00B0 | D2 07 C2 EB 52 AA B6 0C B5 1E 6F 76 83 1D F0 8D
00C0 | CA BD DC E9 F6 8B C0 6D 62 99 0E 03 7A FA 55 20
00D0 | F6 1E E2 48 F4 7C BE 6A 71 F0 A6 F2 A9 9E 54 2B
00E0 | C8 BF C9 CE 0F 64 9B 23 04 2F A3 B0 09 6C 29 15
00F0 | 72 01 1E 96 3F 5B C7 52 23 74 54 8E 9A 2D 51 4D
0100 | CF DC E8 6A 2E E2 B9 5D B9 BF E9 60 06 0A 9E 4A
0110 | 50 2A DF DD A1 BC 31 67 04 3B C4 DD 2A 06 31 32
0120 | AF B2 71 35 C4 CD 2C 86 4C D1 F4 A4 44 88 B5 64
0130 | 65 F0 FD A4 51 1E 7C 5D E2 DF AB 7B D2 98 ED FB
0140 | F4 C7 7B 56 8C 7F 2C 20 7D 7D AC C8 81 AC B4 DC
0150 | 0D 0A 53 47 41 20 1B 6D 09 26 6A E3 CA 50 ED 0B
0160 | 2F 46 9F B2 A4 89 84 79 05 D1 E0 C6 6D 4C 8D 67
0170 | A1 31 1C 00 DA A7 7C 51 C2 32 0E 1C 2D 23 ED E8
0180 | 28 4A 68 21 F1 37 AC BE E7 65 30 A8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>94070900814DD468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001006D45AB1BED0A8BD9C1A6DA6B</code> <code>9CCF6C5D7E7FDB0069BD339F94D9471D</code> <code>973D5AE3D9CA0CF91654B27AE6CBA255</code> <code>237302721567D5FE63596548755F00A5</code> <code>35E32E45A8AC85275797A8515D112DCF</code> <code>1070DFFF9925E2CB1778FEDD6DE749E3</code> <code>CC46728E45C15E19978E3045B7B0D74B</code> <code>7EBF94627BE257CBD207C2EB52AAB60C</code> <code>B51E6F76831DF08DCABDDCE9F68BC06D</code> <code>62990E037AFA5520F61EE248F47CBE6A</code> <code>71F0A6F2A99E542BC8BFC9CE0F649B23</code> <code>042FA3B0096C291572011E963F5BC752</code> <code>2374548E9A2D514DCFDCE86A2EE2B95D</code> <code>B9BFE960060A9E4A502ADFDDA1BC3167</code> <code>043BC4DD2A063132AFB27135C4CD2C86</code> <code>4CD1F4A44488B56465F0FDA4511E7C5D</code> <code>E2DFAB7BD298EDFBF4C77B568C7F2C20</code> <code>7D7DACC881ACB4DC0D0A534741201B6D</code> <code>09266AE3CA50ED0B2F469FB2A4898479</code> <code>05D1E0C66D4C8D67A1311C00DAA77C51</code> <code>C2320E1C2D23EDE8284A6821F137ACBE</code><br> <code>E76530A8</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 19DC8D3AF72A6A67FCCF38CFC23A94777BA7030C7C141A19E99CACEF7CAFA329A4E463E4B6F7052B781081A636AE96C57029A199C8A75FFB56C569352C9FFAC03D03D434D667AA554FCB395FB179B3C825E217A8A7CC82B2C3E1FCE12274021AF63D83BDC6671D9699840C1AEF717A68996F5C5EB9800377E73FDF502A789898ED59E6EC2D57435D97617FD3C3E96548FB679C4D8B24AFC370C5336C28A6BC8AE369791711C881B6E474A220DF75AF9D1D152C585950030D63281E172AD82F9E4D7CD6AAC96B1A587944AA795D5D43C4C7B61D3D4D6AD5BC188F0BDDBB48870DF02FFCE030654418B73C0B64486534E98DB747D621A16B123BC7E43936D023A7</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 08 85 28 83 4D D4 68
0010 | 34 00 00 00 34 F7 CB 3B 3C AD F8 67 1C ED A5 99
0020 | 90 10 4E 4C E4 09 A1 20 74 6E F0 6B EC 71 11 22
0030 | 79 DC 14 E3 E8 10 FF 37 06 6C 44 24 6D 9C 10 43
0040 | 5F 5E 90 88 D7 EA F9 8C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01088528834DD468</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3CADF8671CEDA59990104E4CE409A120</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>746EF06BEC71112279DC14E3E810FF37</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>066C44246D9C10435F5E9088D7EAF98C</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

