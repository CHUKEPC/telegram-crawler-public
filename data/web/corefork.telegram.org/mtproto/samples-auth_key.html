<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 AC 0A 00 05 1A D5 68
0010 | 14 00 00 00 F1 8E 7E BE D2 01 59 95 B4 D0 97 DC
0020 | A4 E7 A7 EB 1A 80 D2 09</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>08AC0A00051AD568</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 2C ED 8F 05 1A D5 68
0010 | 50 00 00 00 63 24 16 05 D2 01 59 95 B4 D0 97 DC
0020 | A4 E7 A7 EB 1A 80 D2 09 E4 2B 4C 9C 5F 25 7A 8E
0030 | 97 3F 48 E4 84 6A D1 D3 08 21 F4 A4 C5 AA 8D CA
0040 | C5 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>012CED8F051AD568</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0821F4A4C5AA8DCAC5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2446761666445953733</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2446761666445953733</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2446761666445953733 = 1391666197 * 1758152689</code></p>
<pre><code>p = 1391666197
q = 1758152689</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 21 F4 A4 C5 AA 8D CA C5 00 00 00
0010 | 04 52 F3 24 15 00 00 00 04 68 CB 47 F1 00 00 00
0020 | D2 01 59 95 B4 D0 97 DC A4 E7 A7 EB 1A 80 D2 09
0030 | E4 2B 4C 9C 5F 25 7A 8E 97 3F 48 E4 84 6A D1 D3
0040 | 78 21 73 90 D9 08 61 2D 5C 27 CE 48 56 E7 42 69
0050 | 04 8D 4D C3 1F 11 0B A5 DD 82 AA 07 10 7C 6E 29
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0821F4A4C5AA8DCAC5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2446761666445953733</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0452F32415000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1391666197</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0468CB47F1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1758152689</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>78217390D908612D5C27CE4856E74269</code> <code>048D4DC31F110BA5DD82AA07107C6E29</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90821F4A4C5AA8DCAC50000000452F324150000000468CB47F1000000D2015995B4D097DCA4E7A7EB1A80D209E42B4C9C5F257A8E973F48E4846AD1D378217390D908612D5C27CE4856E74269048D4DC31F110BA5DD82AA07107C6E2902000000
random_padding_bytes = DA0D66187C76E9B6107B2713C81F0DF0FEC39151EC0CE0C148EBA8013B95504CBECA1DFACBCF4DF82E3EE29E499E6F27CC8F78D89E9F219A12146C483AC02E2F13AD6175BEFBE65A10A79B48CE665481C71FB3860D7AEBEFBEB18951</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = ABB6A3C4856D127C2867BF870786E44BF5D13E7C3D6267070FD2B59351915E472DBE6373C218B7B3F9DE195242A47C17534B3497757BCEB5AA18767522C5E330D8E54903C04DF3C40126DF511E29C20461A4232C4BBE414020614D066FD8232ABE197DB624B9AE75C2EBCE9ADB8D8E1B289AC9E58F930D93D75AEEDD47FB56AB7782773A9700A92EF83BFF26E5A51E0F0897D7C3BA5286A45098E6423890503EA44114A70627E08972F622458C55E8C41FACD3744F88C3504F987ADAFF0DC8BF1973CCBC834D457191B7B45442AAF9C6893A49C4154779F65761FB5919ACE36D6987AC84EC20A904537E6483B68D32C5FCB7F695FA988CD409644C3125F33B6C</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 0C AC 0A 00 05 1A D5 68
0010 | 40 01 00 00 BE E4 12 D7 D2 01 59 95 B4 D0 97 DC
0020 | A4 E7 A7 EB 1A 80 D2 09 E4 2B 4C 9C 5F 25 7A 8E
0030 | 97 3F 48 E4 84 6A D1 D3 04 52 F3 24 15 00 00 00
0040 | 04 68 CB 47 F1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 AB B6 A3 C4 85 6D 12 7C 28 67 BF 87
0060 | 07 86 E4 4B F5 D1 3E 7C 3D 62 67 07 0F D2 B5 93
0070 | 51 91 5E 47 2D BE 63 73 C2 18 B7 B3 F9 DE 19 52
0080 | 42 A4 7C 17 53 4B 34 97 75 7B CE B5 AA 18 76 75
0090 | 22 C5 E3 30 D8 E5 49 03 C0 4D F3 C4 01 26 DF 51
00A0 | 1E 29 C2 04 61 A4 23 2C 4B BE 41 40 20 61 4D 06
00B0 | 6F D8 23 2A BE 19 7D B6 24 B9 AE 75 C2 EB CE 9A
00C0 | DB 8D 8E 1B 28 9A C9 E5 8F 93 0D 93 D7 5A EE DD
00D0 | 47 FB 56 AB 77 82 77 3A 97 00 A9 2E F8 3B FF 26
00E0 | E5 A5 1E 0F 08 97 D7 C3 BA 52 86 A4 50 98 E6 42
00F0 | 38 90 50 3E A4 41 14 A7 06 27 E0 89 72 F6 22 45
0100 | 8C 55 E8 C4 1F AC D3 74 4F 88 C3 50 4F 98 7A DA
0110 | FF 0D C8 BF 19 73 CC BC 83 4D 45 71 91 B7 B4 54
0120 | 42 AA F9 C6 89 3A 49 C4 15 47 79 F6 57 61 FB 59
0130 | 19 AC E3 6D 69 87 AC 84 EC 20 A9 04 53 7E 64 83
0140 | B6 8D 32 C5 FC B7 F6 95 FA 98 8C D4 09 64 4C 31
0150 | 25 F3 3B 6C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0CAC0A00051AD568</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0452F32415000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1391666197</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0468CB47F1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1758152689</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100ABB6A3C4856D127C2867BF87</code> <code>0786E44BF5D13E7C3D6267070FD2B593</code> <code>51915E472DBE6373C218B7B3F9DE1952</code> <code>42A47C17534B3497757BCEB5AA187675</code> <code>22C5E330D8E54903C04DF3C40126DF51</code> <code>1E29C20461A4232C4BBE414020614D06</code> <code>6FD8232ABE197DB624B9AE75C2EBCE9A</code> <code>DB8D8E1B289AC9E58F930D93D75AEEDD</code> <code>47FB56AB7782773A9700A92EF83BFF26</code> <code>E5A51E0F0897D7C3BA5286A45098E642</code> <code>3890503EA44114A70627E08972F62245</code> <code>8C55E8C41FACD3744F88C3504F987ADA</code> <code>FF0DC8BF1973CCBC834D457191B7B454</code> <code>42AAF9C6893A49C4154779F65761FB59</code> <code>19ACE36D6987AC84EC20A904537E6483</code> <code>B68D32C5FCB7F695FA988CD409644C31</code><br> <code>25F33B6C</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 88 BB B6 05 1A D5 68
0010 | 78 02 00 00 5C 07 E8 D0 D2 01 59 95 B4 D0 97 DC
0020 | A4 E7 A7 EB 1A 80 D2 09 E4 2B 4C 9C 5F 25 7A 8E
0030 | 97 3F 48 E4 84 6A D1 D3 FE 50 02 00 CF 60 8F 58
0040 | 0F FA CA 86 0F 72 96 AC EB B4 C3 28 7C 9D 51 0B
0050 | 78 0E 18 BE AA 25 16 5D 4A A4 1D 41 B1 46 16 98
0060 | 79 90 B2 F5 62 F9 98 8F 51 2F 4D 28 F3 F9 61 F0
0070 | F3 C2 23 07 E5 06 09 E0 FA 30 67 60 25 3A CD F7
0080 | 43 A6 8E 54 8E D0 C9 65 95 40 29 CD 2E 77 6F 7B
0090 | 46 D1 BF 49 2A C8 1C 47 4D 84 83 A7 7F E4 8C F4
00A0 | 2F 62 94 13 22 D5 10 A7 D1 C2 FB 22 16 33 B9 C4
00B0 | D7 98 E2 E8 0B 16 67 46 EE B0 52 A8 FF E6 6B 0B
00C0 | EE C2 FC EC 20 68 D3 4D 1E A8 55 B5 12 E1 B0 BE
00D0 | 72 D3 D8 56 B4 08 0E D3 AC 61 07 A3 31 64 4A DF
00E0 | 56 E3 CF 96 15 3F 3F 5C AB F0 7D 84 34 D9 2D E1
00F0 | AA D8 B5 7D 0C 0C 98 0D 57 93 B3 60 7B A7 FD 0E
0100 | 49 53 9C 4A 36 27 5E 4F F2 37 41 1D 07 C1 6F 16
0110 | 92 65 6C 20 E4 3A 59 AB AD 78 3C D5 AC 2B AA ED
0120 | EB 3B 8C 03 1B 59 71 E0 EA 6C 72 31 16 E8 49 C9
0130 | 1B 34 61 DA DD AA F5 39 14 16 FF F8 00 57 31 26
0140 | 06 BF 40 B6 18 78 A9 A3 5A 22 8A 6F FF E2 6D A9
0150 | 3C 7B 03 49 C9 8B 18 A9 21 4A 3F 1C 42 15 4D 49
0160 | 4F E8 ED 30 E5 DD 36 A5 94 08 1E 92 B9 87 9F 28
0170 | C9 3B 20 58 4A C8 D8 4C C7 66 D0 E5 EE A2 EC 81
0180 | 35 68 62 91 C7 FE 64 58 97 D2 58 0B B1 5C 62 22
0190 | 8E 7E 20 FB E4 DB D6 35 53 DD 20 0B 8A DC 95 61
01A0 | 70 46 89 07 B0 37 9A B2 0D F0 8E 9F E4 D0 42 90
01B0 | 4C D3 33 34 2D D6 D8 8C 5F 0D CC 4C C9 8A 88 F6
01C0 | 92 D9 92 F5 A4 9D 77 AF 93 DB 10 58 27 94 02 85
01D0 | 85 ED 9A A5 50 4C 34 13 FB F9 E1 20 6F 7E 82 96
01E0 | 26 33 F4 2E 3D 65 41 39 4A A3 69 A3 0F C9 9C DC
01F0 | 3C 5E 3B 09 7A 7A AA EF 91 2A FD 2A EF 15 A5 DC
0200 | 26 6C AB 3A 90 13 42 E6 2A 80 F3 4E 1B AB 7F DF
0210 | C0 D0 67 89 28 47 BD AD DA 3F AB 66 7B 23 A1 A8
0220 | E6 38 A5 AE 8E AF 89 4B 27 A6 D8 05 0B EB 8C 87
0230 | 99 F0 34 60 84 A8 3C FA 9D 9F BB D6 0C 99 BF F6
0240 | 13 74 47 EE 11 AC E2 CB B2 66 44 78 9B 83 5D 3E
0250 | 72 A9 02 01 44 22 13 4A 77 BB D4 A2 D0 C9 06 62
0260 | F7 29 4C F0 A6 30 76 D2 FD 52 6B 0B 97 4D E1 8A
0270 | 98 30 09 4B 1D EE B4 98 67 6A 8E 89 93 54 7D 75
0280 | 90 51 C7 34 FA 81 2A 61 D3 58 D0 8A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0188BBB6051AD568</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200CF608F580FFACA860F7296AC</code> <code>EBB4C3287C9D510B780E18BEAA25165D</code> <code>4AA41D41B14616987990B2F562F9988F</code> <code>512F4D28F3F961F0F3C22307E50609E0</code> <code>FA306760253ACDF743A68E548ED0C965</code> <code>954029CD2E776F7B46D1BF492AC81C47</code> <code>4D8483A77FE48CF42F62941322D510A7</code> <code>D1C2FB221633B9C4D798E2E80B166746</code> <code>EEB052A8FFE66B0BEEC2FCEC2068D34D</code> <code>1EA855B512E1B0BE72D3D856B4080ED3</code> <code>AC6107A331644ADF56E3CF96153F3F5C</code> <code>ABF07D8434D92DE1AAD8B57D0C0C980D</code> <code>5793B3607BA7FD0E49539C4A36275E4F</code> <code>F237411D07C16F1692656C20E43A59AB</code> <code>AD783CD5AC2BAAEDEB3B8C031B5971E0</code> <code>EA6C723116E849C91B3461DADDAAF539</code> <code>1416FFF80057312606BF40B61878A9A3</code> <code>5A228A6FFFE26DA93C7B0349C98B18A9</code> <code>214A3F1C42154D494FE8ED30E5DD36A5</code> <code>94081E92B9879F28C93B20584AC8D84C</code> <code>C766D0E5EEA2EC8135686291C7FE6458</code> <code>97D2580BB15C62228E7E20FBE4DBD635</code> <code>53DD200B8ADC956170468907B0379AB2</code> <code>0DF08E9FE4D042904CD333342DD6D88C</code> <code>5F0DCC4CC98A88F692D992F5A49D77AF</code> <code>93DB10582794028585ED9AA5504C3413</code> <code>FBF9E1206F7E82962633F42E3D654139</code> <code>4AA369A30FC99CDC3C5E3B097A7AAAEF</code> <code>912AFD2AEF15A5DC266CAB3A901342E6</code> <code>2A80F34E1BAB7FDFC0D067892847BDAD</code> <code>DA3FAB667B23A1A8E638A5AE8EAF894B</code> <code>27A6D8050BEB8C8799F0346084A83CFA</code> <code>9D9FBBD60C99BFF6137447EE11ACE2CB</code> <code>B26644789B835D3E72A902014422134A</code> <code>77BBD4A2D0C90662F7294CF0A63076D2</code> <code>FD526B0B974DE18A9830094B1DEEB498</code> <code>676A8E8993547D759051C734FA812A61</code><br> <code>D358D08A</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = CF608F580FFACA860F7296ACEBB4C3287C9D510B780E18BEAA25165D4AA41D41B14616987990B2F562F9988F512F4D28F3F961F0F3C22307E50609E0FA306760253ACDF743A68E548ED0C965954029CD2E776F7B46D1BF492AC81C474D8483A77FE48CF42F62941322D510A7D1C2FB221633B9C4D798E2E80B166746EEB052A8FFE66B0BEEC2FCEC2068D34D1EA855B512E1B0BE72D3D856B4080ED3AC6107A331644ADF56E3CF96153F3F5CABF07D8434D92DE1AAD8B57D0C0C980D5793B3607BA7FD0E49539C4A36275E4FF237411D07C16F1692656C20E43A59ABAD783CD5AC2BAAEDEB3B8C031B5971E0EA6C723116E849C91B3461DADDAAF5391416FFF80057312606BF40B61878A9A35A228A6FFFE26DA93C7B0349C98B18A9214A3F1C42154D494FE8ED30E5DD36A594081E92B9879F28C93B20584AC8D84CC766D0E5EEA2EC8135686291C7FE645897D2580BB15C62228E7E20FBE4DBD63553DD200B8ADC956170468907B0379AB20DF08E9FE4D042904CD333342DD6D88C5F0DCC4CC98A88F692D992F5A49D77AF93DB10582794028585ED9AA5504C3413FBF9E1206F7E82962633F42E3D6541394AA369A30FC99CDC3C5E3B097A7AAAEF912AFD2AEF15A5DC266CAB3A901342E62A80F34E1BAB7FDFC0D067892847BDADDA3FAB667B23A1A8E638A5AE8EAF894B27A6D8050BEB8C8799F0346084A83CFA9D9FBBD60C99BFF6137447EE11ACE2CBB26644789B835D3E72A902014422134A77BBD4A2D0C90662F7294CF0A63076D2FD526B0B974DE18A9830094B1DEEB498676A8E8993547D759051C734FA812A61D358D08A
tmp_aes_key = D8F2AE222CD552328E255F55AD211C4CCAE0792D26F807A3FA40431D6001073B
tmp_aes_iv = 52979D7D92B026E0AE31B79CBFA834E33F7B3748C75D6747B2863A8478217390</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = F80610BEE82997189A35BE626AAD7599D8CCE126BA0D89B5D2015995B4D097DCA4E7A7EB1A80D209E42B4C9C5F257A8E973F48E4846AD1D303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001CF1E4702CB7ADFDD01C00F3E6F2BC7A047A2F3C2F523E03887FD866B4FC60845D18F359778749696FE4F8EDAAEF17D5566BC0117458BE34F3964ADE3AFEFA1F7DCC85329374DEF032A9D03818D8108FC5F76C576BB653A17FF5053BB88ECE25B3FA3B4592631E05367212D106760C78C752203232E0ED6FE0E3F14E4FECD20BC25A52328D32E79562D577EFFD925799AEF32384B4B829FFFD5A0E0C357BF89B85A8E78323B085EB220225B15E54EB49C3F9C1CAA66058294A8E073AFFF7730B4907EB946E9DF84DFA1FC6F23981452686E8A5FE29B0505651FCD1410DE3174199B2715842D024B583C0683DCD059D6B659308B740F3C1F06E6B6F9EE5B3EF9F051AD56871CA6D0EA2ADE992
answer = BA0D89B5D2015995B4D097DCA4E7A7EB1A80D209E42B4C9C5F257A8E973F48E4846AD1D303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001CF1E4702CB7ADFDD01C00F3E6F2BC7A047A2F3C2F523E03887FD866B4FC60845D18F359778749696FE4F8EDAAEF17D5566BC0117458BE34F3964ADE3AFEFA1F7DCC85329374DEF032A9D03818D8108FC5F76C576BB653A17FF5053BB88ECE25B3FA3B4592631E05367212D106760C78C752203232E0ED6FE0E3F14E4FECD20BC25A52328D32E79562D577EFFD925799AEF32384B4B829FFFD5A0E0C357BF89B85A8E78323B085EB220225B15E54EB49C3F9C1CAA66058294A8E073AFFF7730B4907EB946E9DF84DFA1FC6F23981452686E8A5FE29B0505651FCD1410DE3174199B2715842D024B583C0683DCD059D6B659308B740F3C1F06E6B6F9EE5B3EF9F051AD56871CA6D0EA2ADE992</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 D2 01 59 95 B4 D0 97 DC A4 E7 A7 EB
0010 | 1A 80 D2 09 E4 2B 4C 9C 5F 25 7A 8E 97 3F 48 E4
0020 | 84 6A D1 D3 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 1C F1 E4 70 2C B7 AD FD D0 1C 00 F3 E6 F2 BC 7A
0140 | 04 7A 2F 3C 2F 52 3E 03 88 7F D8 66 B4 FC 60 84
0150 | 5D 18 F3 59 77 87 49 69 6F E4 F8 ED AA EF 17 D5
0160 | 56 6B C0 11 74 58 BE 34 F3 96 4A DE 3A FE FA 1F
0170 | 7D CC 85 32 93 74 DE F0 32 A9 D0 38 18 D8 10 8F
0180 | C5 F7 6C 57 6B B6 53 A1 7F F5 05 3B B8 8E CE 25
0190 | B3 FA 3B 45 92 63 1E 05 36 72 12 D1 06 76 0C 78
01A0 | C7 52 20 32 32 E0 ED 6F E0 E3 F1 4E 4F EC D2 0B
01B0 | C2 5A 52 32 8D 32 E7 95 62 D5 77 EF FD 92 57 99
01C0 | AE F3 23 84 B4 B8 29 FF FD 5A 0E 0C 35 7B F8 9B
01D0 | 85 A8 E7 83 23 B0 85 EB 22 02 25 B1 5E 54 EB 49
01E0 | C3 F9 C1 CA A6 60 58 29 4A 8E 07 3A FF F7 73 0B
01F0 | 49 07 EB 94 6E 9D F8 4D FA 1F C6 F2 39 81 45 26
0200 | 86 E8 A5 FE 29 B0 50 56 51 FC D1 41 0D E3 17 41
0210 | 99 B2 71 58 42 D0 24 B5 83 C0 68 3D CD 05 9D 6B
0220 | 65 93 08 B7 40 F3 C1 F0 6E 6B 6F 9E E5 B3 EF 9F
0230 | 05 1A D5 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001001CF1E4702CB7ADFDD01C00F3</code> <code>E6F2BC7A047A2F3C2F523E03887FD866</code> <code>B4FC60845D18F359778749696FE4F8ED</code> <code>AAEF17D5566BC0117458BE34F3964ADE</code> <code>3AFEFA1F7DCC85329374DEF032A9D038</code> <code>18D8108FC5F76C576BB653A17FF5053B</code> <code>B88ECE25B3FA3B4592631E05367212D1</code> <code>06760C78C752203232E0ED6FE0E3F14E</code> <code>4FECD20BC25A52328D32E79562D577EF</code> <code>FD925799AEF32384B4B829FFFD5A0E0C</code> <code>357BF89B85A8E78323B085EB220225B1</code> <code>5E54EB49C3F9C1CAA66058294A8E073A</code> <code>FFF7730B4907EB946E9DF84DFA1FC6F2</code> <code>3981452686E8A5FE29B0505651FCD141</code> <code>0DE3174199B2715842D024B583C0683D</code> <code>CD059D6B659308B740F3C1F06E6B6F9E</code><br> <code>E5B3EF9F</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>051AD568</code> (1758796293 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = F4BE57F5A5B044377CC1C0CA644FCA96F5B10FE7D4ABF6139C3F7C97FCCE73A927D88D8E41C4D6B428FF68E3D359DB3E0AD670E8D3C34BE24284EF1DBBB75B2FD71137C821500A2281D182C159A3FCB63445B52508DC3F4058542363C8DEE35FB783A417ED345624AA5A949D1DD3D4FF06229C3342B79C18D42039EC6C601174AB237BA3652A262E52FFC6554DDCC367C9D1511E8F1EF488000734F81D9D6F2AFEF42420846264F3430433A8C94EC91C6882002F0F281217D54B1D099A25D924AB4012A937CDCE12C1375A3545A9A4431941B046A232EE2568620CF0B5B847B4A4991F12F34A8E66B0DAA63EBCBA510DE242DFCC0663D3A632D649414515967D</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 5CB1E8227B2DF6D006E504C2999A2C30452102811B959878DBAAC159D1A99307F1E71E722FDBD3113746B4484AE04AB5973AED05480C92366AE244B014CF9E2BD91EA5FF794DEA652B4F4FDF9B26F972D70D33E74EF447072944C8B1C5E1EF791F9C721B003B9E42D93A9690D10EC6E56400A88344A39D24706E57D496040FC91CB5D64B8A286D7BA6DE6C6E4D11BDEDC6C89BCBEEBA43779531F7F30B1AE7DD041E21A78B55686DB95F0C47701FDF91ECDE83BEAEEC7A1EA7A097652827A8B6206F7D624E70F6987B3201F92D4EAC3046B98DB46CE2B73E548361736AED482FE783EF4711631360A95F4D41481B2FE098062ECCD38726849E5EACED290D92E3</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 D2 01 59 95 B4 D0 97 DC A4 E7 A7 EB
0010 | 1A 80 D2 09 E4 2B 4C 9C 5F 25 7A 8E 97 3F 48 E4
0020 | 84 6A D1 D3 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 5C B1 E8 22 7B 2D F6 D0 06 E5 04 C2 99 9A 2C 30
0040 | 45 21 02 81 1B 95 98 78 DB AA C1 59 D1 A9 93 07
0050 | F1 E7 1E 72 2F DB D3 11 37 46 B4 48 4A E0 4A B5
0060 | 97 3A ED 05 48 0C 92 36 6A E2 44 B0 14 CF 9E 2B
0070 | D9 1E A5 FF 79 4D EA 65 2B 4F 4F DF 9B 26 F9 72
0080 | D7 0D 33 E7 4E F4 47 07 29 44 C8 B1 C5 E1 EF 79
0090 | 1F 9C 72 1B 00 3B 9E 42 D9 3A 96 90 D1 0E C6 E5
00A0 | 64 00 A8 83 44 A3 9D 24 70 6E 57 D4 96 04 0F C9
00B0 | 1C B5 D6 4B 8A 28 6D 7B A6 DE 6C 6E 4D 11 BD ED
00C0 | C6 C8 9B CB EE BA 43 77 95 31 F7 F3 0B 1A E7 DD
00D0 | 04 1E 21 A7 8B 55 68 6D B9 5F 0C 47 70 1F DF 91
00E0 | EC DE 83 BE AE EC 7A 1E A7 A0 97 65 28 27 A8 B6
00F0 | 20 6F 7D 62 4E 70 F6 98 7B 32 01 F9 2D 4E AC 30
0100 | 46 B9 8D B4 6C E2 B7 3E 54 83 61 73 6A ED 48 2F
0110 | E7 83 EF 47 11 63 13 60 A9 5F 4D 41 48 1B 2F E0
0120 | 98 06 2E CC D3 87 26 84 9E 5E AC ED 29 0D 92 E3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001005CB1E8227B2DF6D006E504C2</code> <code>999A2C30452102811B959878DBAAC159</code> <code>D1A99307F1E71E722FDBD3113746B448</code> <code>4AE04AB5973AED05480C92366AE244B0</code> <code>14CF9E2BD91EA5FF794DEA652B4F4FDF</code> <code>9B26F972D70D33E74EF447072944C8B1</code> <code>C5E1EF791F9C721B003B9E42D93A9690</code> <code>D10EC6E56400A88344A39D24706E57D4</code> <code>96040FC91CB5D64B8A286D7BA6DE6C6E</code> <code>4D11BDEDC6C89BCBEEBA43779531F7F3</code> <code>0B1AE7DD041E21A78B55686DB95F0C47</code> <code>701FDF91ECDE83BEAEEC7A1EA7A09765</code> <code>2827A8B6206F7D624E70F6987B3201F9</code> <code>2D4EAC3046B98DB46CE2B73E54836173</code> <code>6AED482FE783EF4711631360A95F4D41</code> <code>481B2FE098062ECCD38726849E5EACED</code><br> <code>290D92E3</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366D2015995B4D097DCA4E7A7EB1A80D209E42B4C9C5F257A8E973F48E4846AD1D30000000000000000FE0001005CB1E8227B2DF6D006E504C2999A2C30452102811B959878DBAAC159D1A99307F1E71E722FDBD3113746B4484AE04AB5973AED05480C92366AE244B014CF9E2BD91EA5FF794DEA652B4F4FDF9B26F972D70D33E74EF447072944C8B1C5E1EF791F9C721B003B9E42D93A9690D10EC6E56400A88344A39D24706E57D496040FC91CB5D64B8A286D7BA6DE6C6E4D11BDEDC6C89BCBEEBA43779531F7F30B1AE7DD041E21A78B55686DB95F0C47701FDF91ECDE83BEAEEC7A1EA7A097652827A8B6206F7D624E70F6987B3201F92D4EAC3046B98DB46CE2B73E548361736AED482FE783EF4711631360A95F4D41481B2FE098062ECCD38726849E5EACED290D92E3
padding = E4862D2E5C2F8D20EF6AFCBB
tmp_aes_key = D8F2AE222CD552328E255F55AD211C4CCAE0792D26F807A3FA40431D6001073B
tmp_aes_iv = 52979D7D92B026E0AE31B79CBFA834E33F7B3748C75D6747B2863A8478217390</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = F62201EE96E2C80D9A38B5DE7EE147C66CFDD6DE0C1485B54A865E8FA717F6A57A25F140287FAB95AB7FA71B4957F29665DD93567530F583639EE81AC7059D917A9FF7B00ED615EA579BBB8B5E1FFCE598F6F323BE02A35021CB11E06D071DD4403ECD7A21F1536859E00603EE37C89CB9940EA4DEBDE33F1592C29352FAC39C4260B505AE0FF29CC9AD00C41C4673B3757113264A990CCD27C116F4F261F2AC93153E461D5E57F754ED3F2D847EC65BCF4A74B92327F5FD048DE56BC45F9F50055A59E673DD3401B6B4E460B8416926FA2A9D103AC8C7262E677E18DAB7A5E7286DB82EA4CE0785331EE9F178A3A126DB95826169FDF916492BFD349CF439CFF1811F62619F27A266F8EED0C43CF9933D15DF3821F335525556E5B9A3D35F082F0C4852B2244D0129DBF9C4F97EFC9F29C5FA09F11F1C24DCFA69A89C7DA3EE6F97DE1561507DD1A9EB90D16B1F28CF</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 10 AC 0A 00 05 1A D5 68
0010 | 78 01 00 00 1F 5F 04 F5 D2 01 59 95 B4 D0 97 DC
0020 | A4 E7 A7 EB 1A 80 D2 09 E4 2B 4C 9C 5F 25 7A 8E
0030 | 97 3F 48 E4 84 6A D1 D3 FE 50 01 00 F6 22 01 EE
0040 | 96 E2 C8 0D 9A 38 B5 DE 7E E1 47 C6 6C FD D6 DE
0050 | 0C 14 85 B5 4A 86 5E 8F A7 17 F6 A5 7A 25 F1 40
0060 | 28 7F AB 95 AB 7F A7 1B 49 57 F2 96 65 DD 93 56
0070 | 75 30 F5 83 63 9E E8 1A C7 05 9D 91 7A 9F F7 B0
0080 | 0E D6 15 EA 57 9B BB 8B 5E 1F FC E5 98 F6 F3 23
0090 | BE 02 A3 50 21 CB 11 E0 6D 07 1D D4 40 3E CD 7A
00A0 | 21 F1 53 68 59 E0 06 03 EE 37 C8 9C B9 94 0E A4
00B0 | DE BD E3 3F 15 92 C2 93 52 FA C3 9C 42 60 B5 05
00C0 | AE 0F F2 9C C9 AD 00 C4 1C 46 73 B3 75 71 13 26
00D0 | 4A 99 0C CD 27 C1 16 F4 F2 61 F2 AC 93 15 3E 46
00E0 | 1D 5E 57 F7 54 ED 3F 2D 84 7E C6 5B CF 4A 74 B9
00F0 | 23 27 F5 FD 04 8D E5 6B C4 5F 9F 50 05 5A 59 E6
0100 | 73 DD 34 01 B6 B4 E4 60 B8 41 69 26 FA 2A 9D 10
0110 | 3A C8 C7 26 2E 67 7E 18 DA B7 A5 E7 28 6D B8 2E
0120 | A4 CE 07 85 33 1E E9 F1 78 A3 A1 26 DB 95 82 61
0130 | 69 FD F9 16 49 2B FD 34 9C F4 39 CF F1 81 1F 62
0140 | 61 9F 27 A2 66 F8 EE D0 C4 3C F9 93 3D 15 DF 38
0150 | 21 F3 35 52 55 56 E5 B9 A3 D3 5F 08 2F 0C 48 52
0160 | B2 24 4D 01 29 DB F9 C4 F9 7E FC 9F 29 C5 FA 09
0170 | F1 1F 1C 24 DC FA 69 A8 9C 7D A3 EE 6F 97 DE 15
0180 | 61 50 7D D1 A9 EB 90 D1 6B 1F 28 CF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>10AC0A00051AD568</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100F62201EE96E2C80D9A38B5DE</code> <code>7EE147C66CFDD6DE0C1485B54A865E8F</code> <code>A717F6A57A25F140287FAB95AB7FA71B</code> <code>4957F29665DD93567530F583639EE81A</code> <code>C7059D917A9FF7B00ED615EA579BBB8B</code> <code>5E1FFCE598F6F323BE02A35021CB11E0</code> <code>6D071DD4403ECD7A21F1536859E00603</code> <code>EE37C89CB9940EA4DEBDE33F1592C293</code> <code>52FAC39C4260B505AE0FF29CC9AD00C4</code> <code>1C4673B3757113264A990CCD27C116F4</code> <code>F261F2AC93153E461D5E57F754ED3F2D</code> <code>847EC65BCF4A74B92327F5FD048DE56B</code> <code>C45F9F50055A59E673DD3401B6B4E460</code> <code>B8416926FA2A9D103AC8C7262E677E18</code> <code>DAB7A5E7286DB82EA4CE0785331EE9F1</code> <code>78A3A126DB95826169FDF916492BFD34</code> <code>9CF439CFF1811F62619F27A266F8EED0</code> <code>C43CF9933D15DF3821F335525556E5B9</code> <code>A3D35F082F0C4852B2244D0129DBF9C4</code> <code>F97EFC9F29C5FA09F11F1C24DCFA69A8</code> <code>9C7DA3EE6F97DE1561507DD1A9EB90D1</code><br> <code>6B1F28CF</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 1B9FD7E79384F8382054108F89006421FA410BCF7A25D9975E85EA0E9C7FA751CC0FEF1D11D0B93DBD82FA8569CF94C2ECA2FE02C86C4E229BA5BAA33764AA1F4C454FDB85D438B9FD43E0EA3B8EAEA099DC3F0E9891F924B890FD7927F8624D8A2D05FD8F5016846861019B234CCBB42FC285CBED5B49B6EC66D6E0F1255468D21B3472B9602BB796EF6E96C3AD40C4EFA688FCBBA024A8DEEA402658BDA2175221405F2DFCD45D2C6FC54F68A70DD3EEE8773D7B4B638D98F0990C570CEB385EC7026E7D1B6EE92017DA419959F35F1898192858CE6D3C797C8BFEA542A0BB58CD7ADC3C3FBA9962BD5D57DD827FE760055D6EBC360C3F738F175EFAE7861A</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 3C 8F 8B 07 1A D5 68
0010 | 34 00 00 00 34 F7 CB 3B D2 01 59 95 B4 D0 97 DC
0020 | A4 E7 A7 EB 1A 80 D2 09 E4 2B 4C 9C 5F 25 7A 8E
0030 | 97 3F 48 E4 84 6A D1 D3 F9 20 A0 FE 6F 02 05 8A
0040 | DD 7C 05 A7 99 3B 35 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013C8F8B071AD568</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>D2015995B4D097DCA4E7A7EB1A80D209</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>E42B4C9C5F257A8E973F48E4846AD1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>F920A0FE6F02058ADD7C05A7993B3500</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

