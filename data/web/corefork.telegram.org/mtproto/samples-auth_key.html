<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B4 44 08 00 5F D1 DB 68
0010 | 14 00 00 00 F1 8E 7E BE 73 AE 1B 01 A8 F1 1A C9
0020 | 77 DA 08 8D BA 05 D5 F7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B44408005FD1DB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 B9 54 5F D1 DB 68
0010 | 50 00 00 00 63 24 16 05 73 AE 1B 01 A8 F1 1A C9
0020 | 77 DA 08 8D BA 05 D5 F7 F7 A5 66 DA 00 8F 27 EC
0030 | 27 12 82 36 8C EE A7 88 08 23 EA 83 5C 88 1C FF
0040 | A5 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E8B9545FD1DB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0823EA835C881CFFA5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2588025369321602981</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2588025369321602981</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2588025369321602981 = 1548792197 * 1670995873</code></p>
<pre><code>p = 1548792197
q = 1670995873</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 23 EA 83 5C 88 1C FF A5 00 00 00
0010 | 04 5C 50 B1 85 00 00 00 04 63 99 5F A1 00 00 00
0020 | 73 AE 1B 01 A8 F1 1A C9 77 DA 08 8D BA 05 D5 F7
0030 | F7 A5 66 DA 00 8F 27 EC 27 12 82 36 8C EE A7 88
0040 | 9A FC 73 13 9F CC 28 E5 78 4C 55 EE 23 1C CA 6F
0050 | C4 BB 11 27 EB 33 04 01 16 D1 26 BF 7C 9F 8B 18
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0823EA835C881CFFA5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2588025369321602981</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045C50B185000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1548792197</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0463995FA1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1670995873</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>9AFC73139FCC28E5784C55EE231CCA6F</code> <code>C4BB1127EB33040116D126BF7C9F8B18</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90823EA835C881CFFA5000000045C50B1850000000463995FA100000073AE1B01A8F11AC977DA088DBA05D5F7F7A566DA008F27EC271282368CEEA7889AFC73139FCC28E5784C55EE231CCA6FC4BB1127EB33040116D126BF7C9F8B1802000000
random_padding_bytes = 4DBD36411A117AA3FA21E5DDA0A335C3D76C06A51F83B7B70B7B1B3AAB3E8580DD06EA7050B839531121A2E1AF54CC52072060DBD7966D74EB0CF0780318CB16FF676A7C5F5F9232316F08E18DC630808F847130DEA1FC573E5EEB6A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 6F0B40D6B0AAF44B1A32E2C014505415E45FE17ADBDF25FF200F06D1A5A758A27DD178FB87D782F6B13CDBAB0BD2637CE4DA65DC500FB397649184E2C04792F5F9E9BFF9A7C5B71020795DB5FA10E8E2A80614EA4473446E2F5C037BAC6C4DD9FEB3F337E4CC0D15679076A53B9C8CFE414257E52FE65D2921FA6EA72B67A35E1EED1C5D41C634690F7D40B173891BF67C9BE966532D07EB645A6521C0F9563B575AA6CD74560E64452EF472F67C84E93A40FD47C80DAC608A60CF9E5026748BCF9F0B050DF8544A9F89C81C948581543060BB474E39633AFC85DC71BBF7E9768B5C87261E344F45C4B2CB30370D0E4BA95CED9AF33E85CBFD0E44E77F70A5A6</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 A3 0D 00 5F D1 DB 68
0010 | 40 01 00 00 BE E4 12 D7 73 AE 1B 01 A8 F1 1A C9
0020 | 77 DA 08 8D BA 05 D5 F7 F7 A5 66 DA 00 8F 27 EC
0030 | 27 12 82 36 8C EE A7 88 04 5C 50 B1 85 00 00 00
0040 | 04 63 99 5F A1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 6F 0B 40 D6 B0 AA F4 4B 1A 32 E2 C0
0060 | 14 50 54 15 E4 5F E1 7A DB DF 25 FF 20 0F 06 D1
0070 | A5 A7 58 A2 7D D1 78 FB 87 D7 82 F6 B1 3C DB AB
0080 | 0B D2 63 7C E4 DA 65 DC 50 0F B3 97 64 91 84 E2
0090 | C0 47 92 F5 F9 E9 BF F9 A7 C5 B7 10 20 79 5D B5
00A0 | FA 10 E8 E2 A8 06 14 EA 44 73 44 6E 2F 5C 03 7B
00B0 | AC 6C 4D D9 FE B3 F3 37 E4 CC 0D 15 67 90 76 A5
00C0 | 3B 9C 8C FE 41 42 57 E5 2F E6 5D 29 21 FA 6E A7
00D0 | 2B 67 A3 5E 1E ED 1C 5D 41 C6 34 69 0F 7D 40 B1
00E0 | 73 89 1B F6 7C 9B E9 66 53 2D 07 EB 64 5A 65 21
00F0 | C0 F9 56 3B 57 5A A6 CD 74 56 0E 64 45 2E F4 72
0100 | F6 7C 84 E9 3A 40 FD 47 C8 0D AC 60 8A 60 CF 9E
0110 | 50 26 74 8B CF 9F 0B 05 0D F8 54 4A 9F 89 C8 1C
0120 | 94 85 81 54 30 60 BB 47 4E 39 63 3A FC 85 DC 71
0130 | BB F7 E9 76 8B 5C 87 26 1E 34 4F 45 C4 B2 CB 30
0140 | 37 0D 0E 4B A9 5C ED 9A F3 3E 85 CB FD 0E 44 E7
0150 | 7F 70 A5 A6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>78A30D005FD1DB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045C50B185000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1548792197</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0463995FA1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1670995873</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001006F0B40D6B0AAF44B1A32E2C0</code> <code>14505415E45FE17ADBDF25FF200F06D1</code> <code>A5A758A27DD178FB87D782F6B13CDBAB</code> <code>0BD2637CE4DA65DC500FB397649184E2</code> <code>C04792F5F9E9BFF9A7C5B71020795DB5</code> <code>FA10E8E2A80614EA4473446E2F5C037B</code> <code>AC6C4DD9FEB3F337E4CC0D15679076A5</code> <code>3B9C8CFE414257E52FE65D2921FA6EA7</code> <code>2B67A35E1EED1C5D41C634690F7D40B1</code> <code>73891BF67C9BE966532D07EB645A6521</code> <code>C0F9563B575AA6CD74560E64452EF472</code> <code>F67C84E93A40FD47C80DAC608A60CF9E</code> <code>5026748BCF9F0B050DF8544A9F89C81C</code> <code>948581543060BB474E39633AFC85DC71</code> <code>BBF7E9768B5C87261E344F45C4B2CB30</code> <code>370D0E4BA95CED9AF33E85CBFD0E44E7</code><br> <code>7F70A5A6</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 94 52 7C 5F D1 DB 68
0010 | 78 02 00 00 5C 07 E8 D0 73 AE 1B 01 A8 F1 1A C9
0020 | 77 DA 08 8D BA 05 D5 F7 F7 A5 66 DA 00 8F 27 EC
0030 | 27 12 82 36 8C EE A7 88 FE 50 02 00 45 9D C6 CC
0040 | C9 3C 51 91 82 FE C3 FC 42 C4 41 FE CD 7A 19 BB
0050 | C9 D7 EF D8 DC 6A 3E E2 2B 3E D1 79 DB C7 3A CE
0060 | CF 73 C4 4A D2 64 3F 5F B9 CA 6C E7 24 F0 75 18
0070 | C2 27 30 4B D7 69 23 28 1E 0E 78 CB E0 B9 DA 4E
0080 | B4 8E 62 C3 76 47 F6 8C AF 5A DC FA CC AF 6D 33
0090 | FB 8C 09 C1 78 D5 76 A9 61 F9 30 93 83 BD 2B B0
00A0 | 8D A2 78 CE 26 78 72 CB FD 4B A9 6D 97 37 79 C0
00B0 | CE 47 13 CB EB 85 17 6D 90 C5 7A B2 D6 61 BF B5
00C0 | 58 34 91 FA 5F 7C 53 62 87 A2 93 BA 2C 73 80 BF
00D0 | 7B 2D A9 38 06 6F 39 84 E7 04 9A FE 7D 77 52 A3
00E0 | B3 4B BB C7 E1 A1 26 75 76 3E E1 77 B8 12 38 47
00F0 | D1 0D 50 FC E8 5C 98 4E AE 58 FE E1 5F B5 AB 22
0100 | 42 4A ED 66 9A A1 76 B3 F8 29 EA 92 5C 7C 99 A1
0110 | 2F 0D 52 D6 4C E2 68 85 C0 53 4D 00 97 8E E4 13
0120 | B6 BA 3D 90 A1 EC 66 A6 DB D3 14 D4 BB 18 48 74
0130 | 89 41 45 AC F9 61 65 56 D0 F8 92 BA 60 25 45 B7
0140 | 90 14 4D 4C E2 95 F5 63 6A D7 3D 7A B9 30 25 ED
0150 | 26 C3 83 62 28 B9 15 7A 6A 5D 67 B2 37 18 FD E6
0160 | 9F E5 A7 2D 24 61 E8 38 EA 13 AC C1 2C CA 95 01
0170 | EF D9 81 01 87 73 46 7C 41 C8 58 7E FB 85 40 A6
0180 | AB B3 F1 3F 37 39 F3 0B 4A 97 37 67 2C 4D 48 F9
0190 | 41 9A F2 3C BA E6 AC EC 8A 1F 7E CC 7E 99 98 84
01A0 | 8F C9 37 8B D8 8D CD 5B 33 16 0A F5 66 D2 C2 C5
01B0 | AA 86 DD 77 35 DF 82 1D F3 11 2C DD 96 44 57 94
01C0 | BA 66 70 37 04 7E 79 27 35 0C 8F D3 06 34 C0 A2
01D0 | FD FD 07 B3 F8 0F 4A A7 79 55 D8 74 24 F0 BE 55
01E0 | 66 FD 85 5E F2 92 3E 0F F8 DE 66 B4 B9 0E F6 15
01F0 | BA E7 B0 B7 43 99 5D 9D 15 2B EC 34 02 11 74 5A
0200 | 47 F5 F6 48 24 BF AF FB 46 24 51 06 39 0B 38 87
0210 | 3E 7C 06 16 86 20 50 C5 23 93 89 6D 86 66 CE 17
0220 | 12 28 C3 6C 87 35 63 7D 3A D0 5B A0 80 82 3A D7
0230 | 00 66 5E 82 5D 48 4D FD EE 67 D1 31 43 F6 B1 07
0240 | 76 91 6A 2E 7B 78 97 A9 55 32 E3 BA 3F F4 84 DA
0250 | C0 CE A6 B3 BB CD 02 CF CE 1B 82 48 E1 11 BF 2E
0260 | D1 00 47 B1 5E C0 3E 2F 2F 15 CE FF 50 94 4D C7
0270 | BE E5 8F 69 AE E0 8F 84 58 0E 7D 48 CF 53 D6 E4
0280 | 0E D9 A5 E7 8D 02 73 84 FF 7E 0D 95</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0194527C5FD1DB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200459DC6CCC93C519182FEC3FC</code> <code>42C441FECD7A19BBC9D7EFD8DC6A3EE2</code> <code>2B3ED179DBC73ACECF73C44AD2643F5F</code> <code>B9CA6CE724F07518C227304BD7692328</code> <code>1E0E78CBE0B9DA4EB48E62C37647F68C</code> <code>AF5ADCFACCAF6D33FB8C09C178D576A9</code> <code>61F9309383BD2BB08DA278CE267872CB</code> <code>FD4BA96D973779C0CE4713CBEB85176D</code> <code>90C57AB2D661BFB5583491FA5F7C5362</code> <code>87A293BA2C7380BF7B2DA938066F3984</code> <code>E7049AFE7D7752A3B34BBBC7E1A12675</code> <code>763EE177B8123847D10D50FCE85C984E</code> <code>AE58FEE15FB5AB22424AED669AA176B3</code> <code>F829EA925C7C99A12F0D52D64CE26885</code> <code>C0534D00978EE413B6BA3D90A1EC66A6</code> <code>DBD314D4BB184874894145ACF9616556</code> <code>D0F892BA602545B790144D4CE295F563</code> <code>6AD73D7AB93025ED26C3836228B9157A</code> <code>6A5D67B23718FDE69FE5A72D2461E838</code> <code>EA13ACC12CCA9501EFD981018773467C</code> <code>41C8587EFB8540A6ABB3F13F3739F30B</code> <code>4A9737672C4D48F9419AF23CBAE6ACEC</code> <code>8A1F7ECC7E9998848FC9378BD88DCD5B</code> <code>33160AF566D2C2C5AA86DD7735DF821D</code> <code>F3112CDD96445794BA667037047E7927</code> <code>350C8FD30634C0A2FDFD07B3F80F4AA7</code> <code>7955D87424F0BE5566FD855EF2923E0F</code> <code>F8DE66B4B90EF615BAE7B0B743995D9D</code> <code>152BEC340211745A47F5F64824BFAFFB</code> <code>46245106390B38873E7C0616862050C5</code> <code>2393896D8666CE171228C36C8735637D</code> <code>3AD05BA080823AD700665E825D484DFD</code> <code>EE67D13143F6B10776916A2E7B7897A9</code> <code>5532E3BA3FF484DAC0CEA6B3BBCD02CF</code> <code>CE1B8248E111BF2ED10047B15EC03E2F</code> <code>2F15CEFF50944DC7BEE58F69AEE08F84</code> <code>580E7D48CF53D6E40ED9A5E78D027384</code><br> <code>FF7E0D95</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 459DC6CCC93C519182FEC3FC42C441FECD7A19BBC9D7EFD8DC6A3EE22B3ED179DBC73ACECF73C44AD2643F5FB9CA6CE724F07518C227304BD76923281E0E78CBE0B9DA4EB48E62C37647F68CAF5ADCFACCAF6D33FB8C09C178D576A961F9309383BD2BB08DA278CE267872CBFD4BA96D973779C0CE4713CBEB85176D90C57AB2D661BFB5583491FA5F7C536287A293BA2C7380BF7B2DA938066F3984E7049AFE7D7752A3B34BBBC7E1A12675763EE177B8123847D10D50FCE85C984EAE58FEE15FB5AB22424AED669AA176B3F829EA925C7C99A12F0D52D64CE26885C0534D00978EE413B6BA3D90A1EC66A6DBD314D4BB184874894145ACF9616556D0F892BA602545B790144D4CE295F5636AD73D7AB93025ED26C3836228B9157A6A5D67B23718FDE69FE5A72D2461E838EA13ACC12CCA9501EFD981018773467C41C8587EFB8540A6ABB3F13F3739F30B4A9737672C4D48F9419AF23CBAE6ACEC8A1F7ECC7E9998848FC9378BD88DCD5B33160AF566D2C2C5AA86DD7735DF821DF3112CDD96445794BA667037047E7927350C8FD30634C0A2FDFD07B3F80F4AA77955D87424F0BE5566FD855EF2923E0FF8DE66B4B90EF615BAE7B0B743995D9D152BEC340211745A47F5F64824BFAFFB46245106390B38873E7C0616862050C52393896D8666CE171228C36C8735637D3AD05BA080823AD700665E825D484DFDEE67D13143F6B10776916A2E7B7897A95532E3BA3FF484DAC0CEA6B3BBCD02CFCE1B8248E111BF2ED10047B15EC03E2F2F15CEFF50944DC7BEE58F69AEE08F84580E7D48CF53D6E40ED9A5E78D027384FF7E0D95
tmp_aes_key = DEB538E5BC0B8A5FD74A3B3BBB1D7E586ACE4289E628149B83CC233E3F20DF25
tmp_aes_iv = 876C26A30A6DB11E8C330A6DCA6303F22784280FB1D9D45C730D799C9AFC7313</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 5972FF5FB787C3520994CE013365407BFE9B0436BA0D89B573AE1B01A8F11AC977DA088DBA05D5F7F7A566DA008F27EC271282368CEEA78803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100984A638FAB379041422511D26397705813CED7C69279D411D1802045ACF73CAC3A71F99020FDDC9D414117FB31CA97836DB848784631348CEC5860F9A97EF99D205E3FF8B14342AA3900E133E651BBD51D5FBDAB2BEC82F7AED8C0A46916D9AD2CC2FEBB07200C4B3E0246796D8DA79A5E8F6DF084D2B52D57805715CEF780AB038476BD910E53BB9C99F0F586B54571CB2D9E95C7C79CEAA813AB076B97FA359C246761293566E065E141D9B2C2875151C6EC83637859951A2033CF9A84F758482E2A99D25E17072DD87AA7F82FD966A3270A010C1D996BB7CCC43CD6E0756400D07A8532A3BC964F6A0EF4BED03BBDC03A3A4923B4CB3464EA6AB993CCDD2D5FD1DB686241E7B6F4BE3163
answer = BA0D89B573AE1B01A8F11AC977DA088DBA05D5F7F7A566DA008F27EC271282368CEEA78803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100984A638FAB379041422511D26397705813CED7C69279D411D1802045ACF73CAC3A71F99020FDDC9D414117FB31CA97836DB848784631348CEC5860F9A97EF99D205E3FF8B14342AA3900E133E651BBD51D5FBDAB2BEC82F7AED8C0A46916D9AD2CC2FEBB07200C4B3E0246796D8DA79A5E8F6DF084D2B52D57805715CEF780AB038476BD910E53BB9C99F0F586B54571CB2D9E95C7C79CEAA813AB076B97FA359C246761293566E065E141D9B2C2875151C6EC83637859951A2033CF9A84F758482E2A99D25E17072DD87AA7F82FD966A3270A010C1D996BB7CCC43CD6E0756400D07A8532A3BC964F6A0EF4BED03BBDC03A3A4923B4CB3464EA6AB993CCDD2D5FD1DB686241E7B6F4BE3163</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 73 AE 1B 01 A8 F1 1A C9 77 DA 08 8D
0010 | BA 05 D5 F7 F7 A5 66 DA 00 8F 27 EC 27 12 82 36
0020 | 8C EE A7 88 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 98 4A 63 8F AB 37 90 41 42 25 11 D2 63 97 70 58
0140 | 13 CE D7 C6 92 79 D4 11 D1 80 20 45 AC F7 3C AC
0150 | 3A 71 F9 90 20 FD DC 9D 41 41 17 FB 31 CA 97 83
0160 | 6D B8 48 78 46 31 34 8C EC 58 60 F9 A9 7E F9 9D
0170 | 20 5E 3F F8 B1 43 42 AA 39 00 E1 33 E6 51 BB D5
0180 | 1D 5F BD AB 2B EC 82 F7 AE D8 C0 A4 69 16 D9 AD
0190 | 2C C2 FE BB 07 20 0C 4B 3E 02 46 79 6D 8D A7 9A
01A0 | 5E 8F 6D F0 84 D2 B5 2D 57 80 57 15 CE F7 80 AB
01B0 | 03 84 76 BD 91 0E 53 BB 9C 99 F0 F5 86 B5 45 71
01C0 | CB 2D 9E 95 C7 C7 9C EA A8 13 AB 07 6B 97 FA 35
01D0 | 9C 24 67 61 29 35 66 E0 65 E1 41 D9 B2 C2 87 51
01E0 | 51 C6 EC 83 63 78 59 95 1A 20 33 CF 9A 84 F7 58
01F0 | 48 2E 2A 99 D2 5E 17 07 2D D8 7A A7 F8 2F D9 66
0200 | A3 27 0A 01 0C 1D 99 6B B7 CC C4 3C D6 E0 75 64
0210 | 00 D0 7A 85 32 A3 BC 96 4F 6A 0E F4 BE D0 3B BD
0220 | C0 3A 3A 49 23 B4 CB 34 64 EA 6A B9 93 CC DD 2D
0230 | 5F D1 DB 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100984A638FAB379041422511D2</code> <code>6397705813CED7C69279D411D1802045</code> <code>ACF73CAC3A71F99020FDDC9D414117FB</code> <code>31CA97836DB848784631348CEC5860F9</code> <code>A97EF99D205E3FF8B14342AA3900E133</code> <code>E651BBD51D5FBDAB2BEC82F7AED8C0A4</code> <code>6916D9AD2CC2FEBB07200C4B3E024679</code> <code>6D8DA79A5E8F6DF084D2B52D57805715</code> <code>CEF780AB038476BD910E53BB9C99F0F5</code> <code>86B54571CB2D9E95C7C79CEAA813AB07</code> <code>6B97FA359C246761293566E065E141D9</code> <code>B2C2875151C6EC83637859951A2033CF</code> <code>9A84F758482E2A99D25E17072DD87AA7</code> <code>F82FD966A3270A010C1D996BB7CCC43C</code> <code>D6E0756400D07A8532A3BC964F6A0EF4</code> <code>BED03BBDC03A3A4923B4CB3464EA6AB9</code><br> <code>93CCDD2D</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>5FD1DB68</code> (1759236447 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 5DE8D5AD74FAB004AC5E1437ED6CCB5695F65D1DD47092F5F8D605319576E9099A8CFBF588E4759ACCAD6E133F03851D96361526BD3045086F587DDD6FABBE7C6AB92B2D3362C04E4F1E21B513776AEFFB9F34A1A16A839A8D2471BB40A417723ACF324F30C08A5C959B8FAF1256814ECE774BEB8C59DA3EFBF1E44C6F047BEFFF4453A0540919901DF90D886D1E04659C742F9FA80C6FFE0D806C24F999A6F5CECF648DB10720BCC9B62BA91D07EF42FF9DA07296BFBB69C962FF3AC6536C14CD3C95FD61C7AA362418945EF86AB11C41D6A0928CB3375E75DB7D8C10973AE996167F03276195CADE76F69DF227EA5D32BAAAF183D2D7F944218E0B640DAFE4</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 2B5C9138CAEFB5F95E2B6CABE9933D94FFEA32CCADF50975E63347784B01BB6DE285537C46EE7F2EC4FAF7FDFCC26E538D946A92E41C65B04BAE92CE61E0EEB974A1DE239EF157F7CA83D3F5B52254940E1BA9D79B70CA9460D916B97375BCE5DB2535296AF547D3BEE2FAA3BA73EA1091CCBFFAB985B9C10CFBC2DFBF78FEC82581AA85E2F66C841D69B56366E28682D03FA519A84D7BD05F740C181D4DC54F0733335588CDBDF593625A162C124A13E03850BE7B1F09EBDFE714871B2A2AC1D8019233D6B3779AD8612F3E4CAD8BB8B92F48D3E3A59A3FD783F6DA5C3A1592E074DCD9B538A51E36661CFB5819F7996DF97B6D89D4C02F054497D212110204</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 73 AE 1B 01 A8 F1 1A C9 77 DA 08 8D
0010 | BA 05 D5 F7 F7 A5 66 DA 00 8F 27 EC 27 12 82 36
0020 | 8C EE A7 88 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 2B 5C 91 38 CA EF B5 F9 5E 2B 6C AB E9 93 3D 94
0040 | FF EA 32 CC AD F5 09 75 E6 33 47 78 4B 01 BB 6D
0050 | E2 85 53 7C 46 EE 7F 2E C4 FA F7 FD FC C2 6E 53
0060 | 8D 94 6A 92 E4 1C 65 B0 4B AE 92 CE 61 E0 EE B9
0070 | 74 A1 DE 23 9E F1 57 F7 CA 83 D3 F5 B5 22 54 94
0080 | 0E 1B A9 D7 9B 70 CA 94 60 D9 16 B9 73 75 BC E5
0090 | DB 25 35 29 6A F5 47 D3 BE E2 FA A3 BA 73 EA 10
00A0 | 91 CC BF FA B9 85 B9 C1 0C FB C2 DF BF 78 FE C8
00B0 | 25 81 AA 85 E2 F6 6C 84 1D 69 B5 63 66 E2 86 82
00C0 | D0 3F A5 19 A8 4D 7B D0 5F 74 0C 18 1D 4D C5 4F
00D0 | 07 33 33 55 88 CD BD F5 93 62 5A 16 2C 12 4A 13
00E0 | E0 38 50 BE 7B 1F 09 EB DF E7 14 87 1B 2A 2A C1
00F0 | D8 01 92 33 D6 B3 77 9A D8 61 2F 3E 4C AD 8B B8
0100 | B9 2F 48 D3 E3 A5 9A 3F D7 83 F6 DA 5C 3A 15 92
0110 | E0 74 DC D9 B5 38 A5 1E 36 66 1C FB 58 19 F7 99
0120 | 6D F9 7B 6D 89 D4 C0 2F 05 44 97 D2 12 11 02 04</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001002B5C9138CAEFB5F95E2B6CAB</code> <code>E9933D94FFEA32CCADF50975E6334778</code> <code>4B01BB6DE285537C46EE7F2EC4FAF7FD</code> <code>FCC26E538D946A92E41C65B04BAE92CE</code> <code>61E0EEB974A1DE239EF157F7CA83D3F5</code> <code>B52254940E1BA9D79B70CA9460D916B9</code> <code>7375BCE5DB2535296AF547D3BEE2FAA3</code> <code>BA73EA1091CCBFFAB985B9C10CFBC2DF</code> <code>BF78FEC82581AA85E2F66C841D69B563</code> <code>66E28682D03FA519A84D7BD05F740C18</code> <code>1D4DC54F0733335588CDBDF593625A16</code> <code>2C124A13E03850BE7B1F09EBDFE71487</code> <code>1B2A2AC1D8019233D6B3779AD8612F3E</code> <code>4CAD8BB8B92F48D3E3A59A3FD783F6DA</code> <code>5C3A1592E074DCD9B538A51E36661CFB</code> <code>5819F7996DF97B6D89D4C02F054497D2</code><br> <code>12110204</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436673AE1B01A8F11AC977DA088DBA05D5F7F7A566DA008F27EC271282368CEEA7880000000000000000FE0001002B5C9138CAEFB5F95E2B6CABE9933D94FFEA32CCADF50975E63347784B01BB6DE285537C46EE7F2EC4FAF7FDFCC26E538D946A92E41C65B04BAE92CE61E0EEB974A1DE239EF157F7CA83D3F5B52254940E1BA9D79B70CA9460D916B97375BCE5DB2535296AF547D3BEE2FAA3BA73EA1091CCBFFAB985B9C10CFBC2DFBF78FEC82581AA85E2F66C841D69B56366E28682D03FA519A84D7BD05F740C181D4DC54F0733335588CDBDF593625A162C124A13E03850BE7B1F09EBDFE714871B2A2AC1D8019233D6B3779AD8612F3E4CAD8BB8B92F48D3E3A59A3FD783F6DA5C3A1592E074DCD9B538A51E36661CFB5819F7996DF97B6D89D4C02F054497D212110204
padding = C7299E94A1CC55BBCF23E14C
tmp_aes_key = DEB538E5BC0B8A5FD74A3B3BBB1D7E586ACE4289E628149B83CC233E3F20DF25
tmp_aes_iv = 876C26A30A6DB11E8C330A6DCA6303F22784280FB1D9D45C730D799C9AFC7313</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 106A7E04F19A9A4548919C4636576C19CE06BE4BDDAE4FFE011C256BE41830C74154AF8EEB645D4B2242280BE38A77D2F91814A4EAC70364E38792DA23899D3059157563AF0DEF2AAEC975E385E437E52B0F9508A401D09C864585F89697B3CC9519855AB2BA9D0E806D22847285059FE685F39BDB871916067B3FDA5C0A4FF729A2E3CCE19CD1FED2542F0E3AE20561D153631F7CB606C6B6B11928D21F11AFEE8D10965F9133F994FB2F1051971A3E54930B27F9611A1E281FCB78E5743122DA7201A7A617422011E44716A7431072077B3D6B5FB69BF2C63B22FE99BA9D4F039819CBC2146DD2B6945821A8E5C71A59097611B6B96926CAD9DAC28EE348E91CD6EF8B1AB734B372CE523022BA0E60797A66D8B67CCAAC670B9A53EDE6B35692DD3A2E4ACDA67808FA9F77FFEFEF0718B9AA638BE2F54BC51D0D0D7BE57AABB6B6AFB6D242967E27E115CD560DBC92</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 7C A3 0D 00 5F D1 DB 68
0010 | 78 01 00 00 1F 5F 04 F5 73 AE 1B 01 A8 F1 1A C9
0020 | 77 DA 08 8D BA 05 D5 F7 F7 A5 66 DA 00 8F 27 EC
0030 | 27 12 82 36 8C EE A7 88 FE 50 01 00 10 6A 7E 04
0040 | F1 9A 9A 45 48 91 9C 46 36 57 6C 19 CE 06 BE 4B
0050 | DD AE 4F FE 01 1C 25 6B E4 18 30 C7 41 54 AF 8E
0060 | EB 64 5D 4B 22 42 28 0B E3 8A 77 D2 F9 18 14 A4
0070 | EA C7 03 64 E3 87 92 DA 23 89 9D 30 59 15 75 63
0080 | AF 0D EF 2A AE C9 75 E3 85 E4 37 E5 2B 0F 95 08
0090 | A4 01 D0 9C 86 45 85 F8 96 97 B3 CC 95 19 85 5A
00A0 | B2 BA 9D 0E 80 6D 22 84 72 85 05 9F E6 85 F3 9B
00B0 | DB 87 19 16 06 7B 3F DA 5C 0A 4F F7 29 A2 E3 CC
00C0 | E1 9C D1 FE D2 54 2F 0E 3A E2 05 61 D1 53 63 1F
00D0 | 7C B6 06 C6 B6 B1 19 28 D2 1F 11 AF EE 8D 10 96
00E0 | 5F 91 33 F9 94 FB 2F 10 51 97 1A 3E 54 93 0B 27
00F0 | F9 61 1A 1E 28 1F CB 78 E5 74 31 22 DA 72 01 A7
0100 | A6 17 42 20 11 E4 47 16 A7 43 10 72 07 7B 3D 6B
0110 | 5F B6 9B F2 C6 3B 22 FE 99 BA 9D 4F 03 98 19 CB
0120 | C2 14 6D D2 B6 94 58 21 A8 E5 C7 1A 59 09 76 11
0130 | B6 B9 69 26 CA D9 DA C2 8E E3 48 E9 1C D6 EF 8B
0140 | 1A B7 34 B3 72 CE 52 30 22 BA 0E 60 79 7A 66 D8
0150 | B6 7C CA AC 67 0B 9A 53 ED E6 B3 56 92 DD 3A 2E
0160 | 4A CD A6 78 08 FA 9F 77 FF EF EF 07 18 B9 AA 63
0170 | 8B E2 F5 4B C5 1D 0D 0D 7B E5 7A AB B6 B6 AF B6
0180 | D2 42 96 7E 27 E1 15 CD 56 0D BC 92</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>7CA30D005FD1DB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100106A7E04F19A9A4548919C46</code> <code>36576C19CE06BE4BDDAE4FFE011C256B</code> <code>E41830C74154AF8EEB645D4B2242280B</code> <code>E38A77D2F91814A4EAC70364E38792DA</code> <code>23899D3059157563AF0DEF2AAEC975E3</code> <code>85E437E52B0F9508A401D09C864585F8</code> <code>9697B3CC9519855AB2BA9D0E806D2284</code> <code>7285059FE685F39BDB871916067B3FDA</code> <code>5C0A4FF729A2E3CCE19CD1FED2542F0E</code> <code>3AE20561D153631F7CB606C6B6B11928</code> <code>D21F11AFEE8D10965F9133F994FB2F10</code> <code>51971A3E54930B27F9611A1E281FCB78</code> <code>E5743122DA7201A7A617422011E44716</code> <code>A7431072077B3D6B5FB69BF2C63B22FE</code> <code>99BA9D4F039819CBC2146DD2B6945821</code> <code>A8E5C71A59097611B6B96926CAD9DAC2</code> <code>8EE348E91CD6EF8B1AB734B372CE5230</code> <code>22BA0E60797A66D8B67CCAAC670B9A53</code> <code>EDE6B35692DD3A2E4ACDA67808FA9F77</code> <code>FFEFEF0718B9AA638BE2F54BC51D0D0D</code> <code>7BE57AABB6B6AFB6D242967E27E115CD</code><br> <code>560DBC92</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 89CA71DFCE83C844C1F1F819CFB48F515997733315DB78F0BC69DC0FB6D563CCCED972A3AB1B2D19FD1E9EC2A7F7538BDF668F5C3E50F90BCE63D71C2CD7659E0B1E2B9E5D30079C4D8C6D65E9FE848D8359D1ACFFDF54E557254DCAF90D2C06191CEE0089E82AD0B7C9331C5E3F08164145548DBC7EAF25AA03FE869BDD79F21569297B7D0DE38FC8191B4473DC8A539B4E77DE526AC7E02B9041CAFD5027C51665D046F1515EF226B355B6A5DF52F1090C6E9C0DFCFD6BEE9DFA8BD2ABFC0CE9CB9F6583D28474DB505C17B158A1AB4B6D21B3A59D2A4C40A4613B9E1F8B8EB54155705582417DD17A4F26C42FFFA83F923067307D7599CBE31863E349CF17</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 BC EA 9D 60 D1 DB 68
0010 | 34 00 00 00 34 F7 CB 3B 73 AE 1B 01 A8 F1 1A C9
0020 | 77 DA 08 8D BA 05 D5 F7 F7 A5 66 DA 00 8F 27 EC
0030 | 27 12 82 36 8C EE A7 88 56 15 CC 88 29 5D C1 A8
0040 | 3C F0 58 92 9C 26 E4 AD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01BCEA9D60D1DB68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>73AE1B01A8F11AC977DA088DBA05D5F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>F7A566DA008F27EC271282368CEEA788</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>5615CC88295DC1A83CF058929C26E4AD</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

