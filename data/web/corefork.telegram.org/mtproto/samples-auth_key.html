<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 1A 00 00 44 42 88 66
0010 | 14 00 00 00 F1 8E 7E BE 39 8D DB F9 93 7A 80 D8
0020 | 74 6E E6 4E D3 88 0D 2D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F01A000044428866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 A0 DC F6 44 42 88 66
0010 | BC 00 00 00 63 24 16 05 39 8D DB F9 93 7A 80 D8
0020 | 74 6E E6 4E D3 88 0D 2D 8C A2 EC 8F F5 A5 25 3E
0030 | 0D 8B FE 82 57 8B 87 29 08 22 4C D8 2F 93 75 24
0040 | CD 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01A0DCF644428866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC000000</code> (188 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08224CD82F937524CD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2471587994368550093</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2471587994368550093</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2471587994368550093 = 1520934161 * 1625046013</code></p>
<pre><code>p = 1520934161
q = 1625046013</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 22 4C D8 2F 93 75 24 CD 00 00 00
0010 | 04 5A A7 9D 11 00 00 00 04 60 DC 3B FD 00 00 00
0020 | 39 8D DB F9 93 7A 80 D8 74 6E E6 4E D3 88 0D 2D
0030 | 8C A2 EC 8F F5 A5 25 3E 0D 8B FE 82 57 8B 87 29
0040 | 4D 95 A3 EC 01 E4 DF E2 0A 32 9E F3 DB 4E 10 8D
0050 | D0 41 BD AB 38 31 7A E6 D2 6C E0 73 EE FE 88 F3
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08224CD82F937524CD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2471587994368550093</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045AA79D11000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1520934161</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0460DC3BFD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1625046013</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>4D95A3EC01E4DFE20A329EF3DB4E108D</code> <code>D041BDAB38317AE6D26CE073EEFE88F3</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908224CD82F937524CD000000045AA79D110000000460DC3BFD000000398DDBF9937A80D8746EE64ED3880D2D8CA2EC8FF5A5253E0D8BFE82578B87294D95A3EC01E4DFE20A329EF3DB4E108DD041BDAB38317AE6D26CE073EEFE88F302000000
random_padding_bytes = F77AF76C95C4825D826A01EA03CC093CA92ABF3EAA0D8157785FD74ADB6F0611265AE58726F4FF0F526DDED5C65109EFC7307D9E7E9A6393204C28071C0D3ADC492F8BF9CA01BA2FD65FFF1573869C2B807F032CE4A1C5720BFFE585</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 2B03C37FB170269F14E9E57B92691A6C30F113E3CD92F07E0157F2EDA9A6F1E0F531F8B35E96497C089C6D35A5F94CC80E1BE2235412291063CACF940BD2A1159FB092443C9C75159EE86F94B528F979C85B42E7AB15617078F3F2B9566389BA527346A794898530CC64C5BD96DAE27467612E6EAA57CED8B817D151604EA682F08DB37D517CF16BB45F1D0DCBF542F6E9640C3C58015412656C83BED0733F7DC9EE956C8B7C46A3D170BCBF5425E3EB612D9C4BBCC931F376AE2F3A6D388E254C8ACF9F3F742C5D3032C92657BCCC1103974DF25ECC2AA7A912820687A49A6BE987E8F7420FB20E55D806B9C83598C454741011BCA1023A6945D75076EFF0F3</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 48 CB 02 00 45 42 88 66
0010 | 40 01 00 00 BE E4 12 D7 39 8D DB F9 93 7A 80 D8
0020 | 74 6E E6 4E D3 88 0D 2D 8C A2 EC 8F F5 A5 25 3E
0030 | 0D 8B FE 82 57 8B 87 29 04 5A A7 9D 11 00 00 00
0040 | 04 60 DC 3B FD 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 2B 03 C3 7F B1 70 26 9F 14 E9 E5 7B
0060 | 92 69 1A 6C 30 F1 13 E3 CD 92 F0 7E 01 57 F2 ED
0070 | A9 A6 F1 E0 F5 31 F8 B3 5E 96 49 7C 08 9C 6D 35
0080 | A5 F9 4C C8 0E 1B E2 23 54 12 29 10 63 CA CF 94
0090 | 0B D2 A1 15 9F B0 92 44 3C 9C 75 15 9E E8 6F 94
00A0 | B5 28 F9 79 C8 5B 42 E7 AB 15 61 70 78 F3 F2 B9
00B0 | 56 63 89 BA 52 73 46 A7 94 89 85 30 CC 64 C5 BD
00C0 | 96 DA E2 74 67 61 2E 6E AA 57 CE D8 B8 17 D1 51
00D0 | 60 4E A6 82 F0 8D B3 7D 51 7C F1 6B B4 5F 1D 0D
00E0 | CB F5 42 F6 E9 64 0C 3C 58 01 54 12 65 6C 83 BE
00F0 | D0 73 3F 7D C9 EE 95 6C 8B 7C 46 A3 D1 70 BC BF
0100 | 54 25 E3 EB 61 2D 9C 4B BC C9 31 F3 76 AE 2F 3A
0110 | 6D 38 8E 25 4C 8A CF 9F 3F 74 2C 5D 30 32 C9 26
0120 | 57 BC CC 11 03 97 4D F2 5E CC 2A A7 A9 12 82 06
0130 | 87 A4 9A 6B E9 87 E8 F7 42 0F B2 0E 55 D8 06 B9
0140 | C8 35 98 C4 54 74 10 11 BC A1 02 3A 69 45 D7 50
0150 | 76 EF F0 F3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>48CB020045428866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045AA79D11000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1520934161</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0460DC3BFD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1625046013</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001002B03C37FB170269F14E9E57B</code> <code>92691A6C30F113E3CD92F07E0157F2ED</code> <code>A9A6F1E0F531F8B35E96497C089C6D35</code> <code>A5F94CC80E1BE2235412291063CACF94</code> <code>0BD2A1159FB092443C9C75159EE86F94</code> <code>B528F979C85B42E7AB15617078F3F2B9</code> <code>566389BA527346A794898530CC64C5BD</code> <code>96DAE27467612E6EAA57CED8B817D151</code> <code>604EA682F08DB37D517CF16BB45F1D0D</code> <code>CBF542F6E9640C3C58015412656C83BE</code> <code>D0733F7DC9EE956C8B7C46A3D170BCBF</code> <code>5425E3EB612D9C4BBCC931F376AE2F3A</code> <code>6D388E254C8ACF9F3F742C5D3032C926</code> <code>57BCCC1103974DF25ECC2AA7A9128206</code> <code>87A49A6BE987E8F7420FB20E55D806B9</code> <code>C83598C454741011BCA1023A6945D750</code><br> <code>76EFF0F3</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F0 25 A4 45 42 88 66
0010 | B8 02 00 00 5C 07 E8 D0 39 8D DB F9 93 7A 80 D8
0020 | 74 6E E6 4E D3 88 0D 2D 8C A2 EC 8F F5 A5 25 3E
0030 | 0D 8B FE 82 57 8B 87 29 FE 50 02 00 EC 1E 36 D7
0040 | 8B FB 9C 1E 7E 9E 1A AF 0E D1 5D 8D 9C 1A A1 43
0050 | C0 56 AA 64 92 1D AF FE 75 EA 2B F0 B6 D7 C6 D3
0060 | FF 99 AB B1 55 4C 97 79 BB 33 5F 1A 74 9F C7 3A
0070 | 8F E6 4D 2D 11 D7 62 B3 4C 74 CB D7 82 64 0D E6
0080 | B1 9B C3 AA C0 D4 80 BF 89 52 32 6C 6D C8 A4 C1
0090 | CF 37 85 48 0D AD AD CA 6D 52 46 F4 28 D9 74 05
00A0 | 71 FE 25 00 93 FF 39 11 10 9D 13 90 C0 89 89 91
00B0 | 67 89 4D 6D B9 30 BC 93 3F 48 F8 7C FA 95 75 C9
00C0 | 5F 96 F6 D4 4D E8 26 17 EA C3 5B E2 F6 EC A5 5B
00D0 | 2C 55 59 38 27 9E AF 39 EC 40 13 A5 D4 DD 53 90
00E0 | F6 65 E3 06 15 68 52 9D 98 78 B5 40 6E 58 23 92
00F0 | 65 F7 0D F9 67 12 8D 00 C6 D1 79 A0 50 B1 2A 79
0100 | AA 43 14 4F 45 0C BE 5A E3 C0 A2 75 38 C7 1B AD
0110 | 59 5B 11 A7 E6 66 62 79 03 F1 89 7A FD FC 40 1A
0120 | 36 EF 3B 3E 8E 83 85 49 D7 5F A1 69 85 0F 6F 79
0130 | A1 06 05 06 4F D2 21 D5 E5 98 74 37 7A 42 8E 94
0140 | 93 60 68 BC B2 26 97 8A 81 24 A7 20 9C 6C C9 7D
0150 | 64 30 BE DC 0D 11 3F 34 BB E9 88 FC BD 8C 9E FE
0160 | 3D 20 99 A8 05 2D F6 74 8D 9B 55 EC 3D 6F F9 63
0170 | 6E 55 81 0C 37 E2 77 6A 7C 60 DB B7 6C 3D 14 3E
0180 | B5 E2 6E 0F 67 D2 C1 2F CF FE 6A F1 A5 BC 90 5D
0190 | 64 B3 74 17 55 02 E5 B9 10 9B 26 28 72 30 43 5E
01A0 | 80 9F 17 DF 67 B1 49 59 F5 D2 15 A9 BE 49 18 A3
01B0 | F9 D3 5F 88 01 7C 5D 07 91 63 CA B3 C2 73 A6 18
01C0 | 70 E8 CA 2A CB 81 20 AA D4 97 AA 24 0E 44 BA 59
01D0 | 2E AD 4B B7 6F 9D 74 AB 29 EB 98 3D CD 53 81 AC
01E0 | 09 F6 2F AE 23 25 4C B9 E3 64 B7 00 3C 21 81 7B
01F0 | 81 FA 4E B7 7E FD E9 1F A1 4A EA C8 9C 19 7A AB
0200 | 12 17 78 03 65 53 9D DA 43 6E 86 5F 43 B1 4C 92
0210 | 75 EE 77 E7 67 30 9A 22 AA A0 6D C6 FC FF 9E 1C
0220 | CD 05 13 EF F8 A3 7D 57 1C 28 0D 09 44 5E 78 DA
0230 | 3B 7B 5B 79 A8 7A A6 F6 4F 8E 48 E3 31 02 B6 03
0240 | 06 1C CD CA 7C 57 5F E0 73 BB 94 23 6B 72 36 76
0250 | 03 48 1B 9E A8 B3 1F 79 AF 90 50 FF E4 26 BA 35
0260 | B3 4F A9 16 C1 80 37 16 55 73 48 86 13 8D 44 BA
0270 | 53 CE 77 93 F7 03 08 51 9E F4 E8 4C A1 64 89 E8
0280 | 32 13 E9 9D 08 BE 24 7A D2 11 A7 EA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F025A445428866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B8020000</code> (696 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200EC1E36D78BFB9C1E7E9E1AAF</code> <code>0ED15D8D9C1AA143C056AA64921DAFFE</code> <code>75EA2BF0B6D7C6D3FF99ABB1554C9779</code> <code>BB335F1A749FC73A8FE64D2D11D762B3</code> <code>4C74CBD782640DE6B19BC3AAC0D480BF</code> <code>8952326C6DC8A4C1CF3785480DADADCA</code> <code>6D5246F428D9740571FE250093FF3911</code> <code>109D1390C089899167894D6DB930BC93</code> <code>3F48F87CFA9575C95F96F6D44DE82617</code> <code>EAC35BE2F6ECA55B2C555938279EAF39</code> <code>EC4013A5D4DD5390F665E3061568529D</code> <code>9878B5406E58239265F70DF967128D00</code> <code>C6D179A050B12A79AA43144F450CBE5A</code> <code>E3C0A27538C71BAD595B11A7E6666279</code> <code>03F1897AFDFC401A36EF3B3E8E838549</code> <code>D75FA169850F6F79A10605064FD221D5</code> <code>E59874377A428E94936068BCB226978A</code> <code>8124A7209C6CC97D6430BEDC0D113F34</code> <code>BBE988FCBD8C9EFE3D2099A8052DF674</code> <code>8D9B55EC3D6FF9636E55810C37E2776A</code> <code>7C60DBB76C3D143EB5E26E0F67D2C12F</code> <code>CFFE6AF1A5BC905D64B374175502E5B9</code> <code>109B26287230435E809F17DF67B14959</code> <code>F5D215A9BE4918A3F9D35F88017C5D07</code> <code>9163CAB3C273A61870E8CA2ACB8120AA</code> <code>D497AA240E44BA592EAD4BB76F9D74AB</code> <code>29EB983DCD5381AC09F62FAE23254CB9</code> <code>E364B7003C21817B81FA4EB77EFDE91F</code> <code>A14AEAC89C197AAB1217780365539DDA</code> <code>436E865F43B14C9275EE77E767309A22</code> <code>AAA06DC6FCFF9E1CCD0513EFF8A37D57</code> <code>1C280D09445E78DA3B7B5B79A87AA6F6</code> <code>4F8E48E33102B603061CCDCA7C575FE0</code> <code>73BB94236B72367603481B9EA8B31F79</code> <code>AF9050FFE426BA35B34FA916C1803716</code> <code>55734886138D44BA53CE7793F7030851</code> <code>9EF4E84CA16489E83213E99D08BE247A</code><br> <code>D211A7EA</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = EC1E36D78BFB9C1E7E9E1AAF0ED15D8D9C1AA143C056AA64921DAFFE75EA2BF0B6D7C6D3FF99ABB1554C9779BB335F1A749FC73A8FE64D2D11D762B34C74CBD782640DE6B19BC3AAC0D480BF8952326C6DC8A4C1CF3785480DADADCA6D5246F428D9740571FE250093FF3911109D1390C089899167894D6DB930BC933F48F87CFA9575C95F96F6D44DE82617EAC35BE2F6ECA55B2C555938279EAF39EC4013A5D4DD5390F665E3061568529D9878B5406E58239265F70DF967128D00C6D179A050B12A79AA43144F450CBE5AE3C0A27538C71BAD595B11A7E666627903F1897AFDFC401A36EF3B3E8E838549D75FA169850F6F79A10605064FD221D5E59874377A428E94936068BCB226978A8124A7209C6CC97D6430BEDC0D113F34BBE988FCBD8C9EFE3D2099A8052DF6748D9B55EC3D6FF9636E55810C37E2776A7C60DBB76C3D143EB5E26E0F67D2C12FCFFE6AF1A5BC905D64B374175502E5B9109B26287230435E809F17DF67B14959F5D215A9BE4918A3F9D35F88017C5D079163CAB3C273A61870E8CA2ACB8120AAD497AA240E44BA592EAD4BB76F9D74AB29EB983DCD5381AC09F62FAE23254CB9E364B7003C21817B81FA4EB77EFDE91FA14AEAC89C197AAB1217780365539DDA436E865F43B14C9275EE77E767309A22AAA06DC6FCFF9E1CCD0513EFF8A37D571C280D09445E78DA3B7B5B79A87AA6F64F8E48E33102B603061CCDCA7C575FE073BB94236B72367603481B9EA8B31F79AF9050FFE426BA35B34FA916C180371655734886138D44BA53CE7793F70308519EF4E84CA16489E83213E99D08BE247AD211A7EA
tmp_aes_key = 8E9BCDF0570238EA68479EC856957F1758D2D464493C1655D577FFBB524DEB9E
tmp_aes_iv = 6048C38AF2E0E70B3B1A24148ED603EB80F8C30743CDE5CC500F84864D95A3EC</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 2DB08BB8873822F728C4FA96357A707FB0204926BA0D89B5398DDBF9937A80D8746EE64ED3880D2D8CA2EC8FF5A5253E0D8BFE82578B872903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007F563DC14E0FE403C3288CB7112AA9BEE9C9A03DD9B57F443BC66A96276FA6B6794613EAB032F7A564AECF24431742D5FAADB3FD264DD4C994513FCFD5F7A8A16A3852137B43C123934D4173C30D434BB29867F1330872B59DBDB063CF0435CC0A82D2F79E1A6247F8986C6508A852B52058877869D511FEC686F6401799ADCB4C26921F07B136B55C1A065453CEE825F6665706CEF3720FB6EB2F4DD30E1A78985F8F0F0AE81D58C8E2E97C5C16207F46CDE176D33E2C7B066FFEDB36CFE497130D337CFB20FD100DC4ACB143895E3D0CA0E9F66514DA2E2208C6B80357F884A882DA869FAFA1A65B7BD946A47F654015C3C2E5E47A03C660DA6EAE95AFB896454288661FEC3703B3688E94
answer = BA0D89B5398DDBF9937A80D8746EE64ED3880D2D8CA2EC8FF5A5253E0D8BFE82578B872903000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007F563DC14E0FE403C3288CB7112AA9BEE9C9A03DD9B57F443BC66A96276FA6B6794613EAB032F7A564AECF24431742D5FAADB3FD264DD4C994513FCFD5F7A8A16A3852137B43C123934D4173C30D434BB29867F1330872B59DBDB063CF0435CC0A82D2F79E1A6247F8986C6508A852B52058877869D511FEC686F6401799ADCB4C26921F07B136B55C1A065453CEE825F6665706CEF3720FB6EB2F4DD30E1A78985F8F0F0AE81D58C8E2E97C5C16207F46CDE176D33E2C7B066FFEDB36CFE497130D337CFB20FD100DC4ACB143895E3D0CA0E9F66514DA2E2208C6B80357F884A882DA869FAFA1A65B7BD946A47F654015C3C2E5E47A03C660DA6EAE95AFB896454288661FEC3703B3688E94</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 39 8D DB F9 93 7A 80 D8 74 6E E6 4E
0010 | D3 88 0D 2D 8C A2 EC 8F F5 A5 25 3E 0D 8B FE 82
0020 | 57 8B 87 29 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 7F 56 3D C1 4E 0F E4 03 C3 28 8C B7 11 2A A9 BE
0140 | E9 C9 A0 3D D9 B5 7F 44 3B C6 6A 96 27 6F A6 B6
0150 | 79 46 13 EA B0 32 F7 A5 64 AE CF 24 43 17 42 D5
0160 | FA AD B3 FD 26 4D D4 C9 94 51 3F CF D5 F7 A8 A1
0170 | 6A 38 52 13 7B 43 C1 23 93 4D 41 73 C3 0D 43 4B
0180 | B2 98 67 F1 33 08 72 B5 9D BD B0 63 CF 04 35 CC
0190 | 0A 82 D2 F7 9E 1A 62 47 F8 98 6C 65 08 A8 52 B5
01A0 | 20 58 87 78 69 D5 11 FE C6 86 F6 40 17 99 AD CB
01B0 | 4C 26 92 1F 07 B1 36 B5 5C 1A 06 54 53 CE E8 25
01C0 | F6 66 57 06 CE F3 72 0F B6 EB 2F 4D D3 0E 1A 78
01D0 | 98 5F 8F 0F 0A E8 1D 58 C8 E2 E9 7C 5C 16 20 7F
01E0 | 46 CD E1 76 D3 3E 2C 7B 06 6F FE DB 36 CF E4 97
01F0 | 13 0D 33 7C FB 20 FD 10 0D C4 AC B1 43 89 5E 3D
0200 | 0C A0 E9 F6 65 14 DA 2E 22 08 C6 B8 03 57 F8 84
0210 | A8 82 DA 86 9F AF A1 A6 5B 7B D9 46 A4 7F 65 40
0220 | 15 C3 C2 E5 E4 7A 03 C6 60 DA 6E AE 95 AF B8 96
0230 | 45 42 88 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007F563DC14E0FE403C3288CB7</code> <code>112AA9BEE9C9A03DD9B57F443BC66A96</code> <code>276FA6B6794613EAB032F7A564AECF24</code> <code>431742D5FAADB3FD264DD4C994513FCF</code> <code>D5F7A8A16A3852137B43C123934D4173</code> <code>C30D434BB29867F1330872B59DBDB063</code> <code>CF0435CC0A82D2F79E1A6247F8986C65</code> <code>08A852B52058877869D511FEC686F640</code> <code>1799ADCB4C26921F07B136B55C1A0654</code> <code>53CEE825F6665706CEF3720FB6EB2F4D</code> <code>D30E1A78985F8F0F0AE81D58C8E2E97C</code> <code>5C16207F46CDE176D33E2C7B066FFEDB</code> <code>36CFE497130D337CFB20FD100DC4ACB1</code> <code>43895E3D0CA0E9F66514DA2E2208C6B8</code> <code>0357F884A882DA869FAFA1A65B7BD946</code> <code>A47F654015C3C2E5E47A03C660DA6EAE</code><br> <code>95AFB896</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>45428866</code> (1720205893 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 9CF93ACC8B60673E2BD956177B30AA952C03776A38A0F8F40A0A79C4F9B652D8F1DAD9EA226FFB92CFC68C51BF990C9FEA53295E0B33B60ED6B46F752CB27930B5DDBEED273E018CE369C7B7CDCF8CC9740436FF9C29ADA6FF7530B3F0933489EF1E882C68810B523A5F41335260B995CB8300E212F5DC3D34DB4AA0A1AA1FD83ED122EAB72F250414CCD1BC9FA4EB5A20E10CE3FE165A214C78850B1E5D5EA387B5B046E412AC967422A94B7ECEEAFC56038FF7F4CC370633A5C54BC8E1B16CB84BC5F277827A1AC0B67E2C3AD4EDEEEFAFF95ADBF395C148746F7BE4AC55E03E921C83B066A1FD51F2441563A7B6DBB2DC85A32420FD922C76C8F3DBA75382</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 9B6F1D157BE53750FAD2CF4D35E3BC680EA14D0BF22B1F37D871CAE627537BFE483C12E27D079808235103E3D826C29E66EB79E0EB0B497617FD8797EE98B24325940CDE8C03CBE9ACDA18F7DCC93A1252465816F1AB54252B35BC8F7BCC4459E764432F0A9B351F97BED47A907BFD3913230D1FE3499FC8C31E6B33BCA597724F89C194D342591094B533D978646A68AAC2FFE912C06198CF1A6FDA2A51FE423A9BC784AD2E99FF40C7FC33F69E0A5E3762252B0B97BE75F64977C8A329F986E75FD0266E48D1649DB7017CFEDD58AA1EF8F808D9AF3DB28F9A96ABFAFB43E2473576D29A5DF805525172DDE83E7DEE3EDD01F0B5496E6F5EDA6F992DF6B8DE</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 39 8D DB F9 93 7A 80 D8 74 6E E6 4E
0010 | D3 88 0D 2D 8C A2 EC 8F F5 A5 25 3E 0D 8B FE 82
0020 | 57 8B 87 29 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 9B 6F 1D 15 7B E5 37 50 FA D2 CF 4D 35 E3 BC 68
0040 | 0E A1 4D 0B F2 2B 1F 37 D8 71 CA E6 27 53 7B FE
0050 | 48 3C 12 E2 7D 07 98 08 23 51 03 E3 D8 26 C2 9E
0060 | 66 EB 79 E0 EB 0B 49 76 17 FD 87 97 EE 98 B2 43
0070 | 25 94 0C DE 8C 03 CB E9 AC DA 18 F7 DC C9 3A 12
0080 | 52 46 58 16 F1 AB 54 25 2B 35 BC 8F 7B CC 44 59
0090 | E7 64 43 2F 0A 9B 35 1F 97 BE D4 7A 90 7B FD 39
00A0 | 13 23 0D 1F E3 49 9F C8 C3 1E 6B 33 BC A5 97 72
00B0 | 4F 89 C1 94 D3 42 59 10 94 B5 33 D9 78 64 6A 68
00C0 | AA C2 FF E9 12 C0 61 98 CF 1A 6F DA 2A 51 FE 42
00D0 | 3A 9B C7 84 AD 2E 99 FF 40 C7 FC 33 F6 9E 0A 5E
00E0 | 37 62 25 2B 0B 97 BE 75 F6 49 77 C8 A3 29 F9 86
00F0 | E7 5F D0 26 6E 48 D1 64 9D B7 01 7C FE DD 58 AA
0100 | 1E F8 F8 08 D9 AF 3D B2 8F 9A 96 AB FA FB 43 E2
0110 | 47 35 76 D2 9A 5D F8 05 52 51 72 DD E8 3E 7D EE
0120 | 3E DD 01 F0 B5 49 6E 6F 5E DA 6F 99 2D F6 B8 DE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001009B6F1D157BE53750FAD2CF4D</code> <code>35E3BC680EA14D0BF22B1F37D871CAE6</code> <code>27537BFE483C12E27D079808235103E3</code> <code>D826C29E66EB79E0EB0B497617FD8797</code> <code>EE98B24325940CDE8C03CBE9ACDA18F7</code> <code>DCC93A1252465816F1AB54252B35BC8F</code> <code>7BCC4459E764432F0A9B351F97BED47A</code> <code>907BFD3913230D1FE3499FC8C31E6B33</code> <code>BCA597724F89C194D342591094B533D9</code> <code>78646A68AAC2FFE912C06198CF1A6FDA</code> <code>2A51FE423A9BC784AD2E99FF40C7FC33</code> <code>F69E0A5E3762252B0B97BE75F64977C8</code> <code>A329F986E75FD0266E48D1649DB7017C</code> <code>FEDD58AA1EF8F808D9AF3DB28F9A96AB</code> <code>FAFB43E2473576D29A5DF805525172DD</code> <code>E83E7DEE3EDD01F0B5496E6F5EDA6F99</code><br> <code>2DF6B8DE</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366398DDBF9937A80D8746EE64ED3880D2D8CA2EC8FF5A5253E0D8BFE82578B87290000000000000000FE0001009B6F1D157BE53750FAD2CF4D35E3BC680EA14D0BF22B1F37D871CAE627537BFE483C12E27D079808235103E3D826C29E66EB79E0EB0B497617FD8797EE98B24325940CDE8C03CBE9ACDA18F7DCC93A1252465816F1AB54252B35BC8F7BCC4459E764432F0A9B351F97BED47A907BFD3913230D1FE3499FC8C31E6B33BCA597724F89C194D342591094B533D978646A68AAC2FFE912C06198CF1A6FDA2A51FE423A9BC784AD2E99FF40C7FC33F69E0A5E3762252B0B97BE75F64977C8A329F986E75FD0266E48D1649DB7017CFEDD58AA1EF8F808D9AF3DB28F9A96ABFAFB43E2473576D29A5DF805525172DDE83E7DEE3EDD01F0B5496E6F5EDA6F992DF6B8DE
padding = 0A1EB899A22DE53DA9B39222
tmp_aes_key = 8E9BCDF0570238EA68479EC856957F1758D2D464493C1655D577FFBB524DEB9E
tmp_aes_iv = 6048C38AF2E0E70B3B1A24148ED603EB80F8C30743CDE5CC500F84864D95A3EC</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 55F11A0026B5AD5AC5828AB9829C89CBBD55B813972A35B19BE41D7C650F49409322E718E3D17E19853D107021D4907CB821DE489FC8A282110AE38A523B385446283976B7A05838317543A4098E7E7A62301D93B362DF107B2C22CB22D7C2531C4FCA2D16762CE978C97B5DF3B3E60BE01087E32D7D70BD1B8433B58F01126D0C56F98C9D77777B5E4EB57CE3EE17AF033E81B19E1E281F13CBCE3BA19639A31E0BD9FAC8E24D5ACB2928C8998AB60D95035D439EAECE695E6E278173A8A933587F0E5D09F0BAB18FA1B9A04AEC3BAF3F3EE99E33F69129283E161FA464D9E7A6B35F4BDAE1644C84EBC405165F370FE68EAB5A6FFB99F27BCEF9DD3B6B2EF91FBD76D00C92A8C10B992A07050DE57E4A5523A0C0E3F217D27D7F1B3AD9A5AEA45EC31C89352C0727152E1A8CC99A805ECC6601F8AA6F92613BCF8504588E6B7592F73990E4C456E39680C997EBB396</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 0C 0A 00 45 42 88 66
0010 | 78 01 00 00 1F 5F 04 F5 39 8D DB F9 93 7A 80 D8
0020 | 74 6E E6 4E D3 88 0D 2D 8C A2 EC 8F F5 A5 25 3E
0030 | 0D 8B FE 82 57 8B 87 29 FE 50 01 00 55 F1 1A 00
0040 | 26 B5 AD 5A C5 82 8A B9 82 9C 89 CB BD 55 B8 13
0050 | 97 2A 35 B1 9B E4 1D 7C 65 0F 49 40 93 22 E7 18
0060 | E3 D1 7E 19 85 3D 10 70 21 D4 90 7C B8 21 DE 48
0070 | 9F C8 A2 82 11 0A E3 8A 52 3B 38 54 46 28 39 76
0080 | B7 A0 58 38 31 75 43 A4 09 8E 7E 7A 62 30 1D 93
0090 | B3 62 DF 10 7B 2C 22 CB 22 D7 C2 53 1C 4F CA 2D
00A0 | 16 76 2C E9 78 C9 7B 5D F3 B3 E6 0B E0 10 87 E3
00B0 | 2D 7D 70 BD 1B 84 33 B5 8F 01 12 6D 0C 56 F9 8C
00C0 | 9D 77 77 7B 5E 4E B5 7C E3 EE 17 AF 03 3E 81 B1
00D0 | 9E 1E 28 1F 13 CB CE 3B A1 96 39 A3 1E 0B D9 FA
00E0 | C8 E2 4D 5A CB 29 28 C8 99 8A B6 0D 95 03 5D 43
00F0 | 9E AE CE 69 5E 6E 27 81 73 A8 A9 33 58 7F 0E 5D
0100 | 09 F0 BA B1 8F A1 B9 A0 4A EC 3B AF 3F 3E E9 9E
0110 | 33 F6 91 29 28 3E 16 1F A4 64 D9 E7 A6 B3 5F 4B
0120 | DA E1 64 4C 84 EB C4 05 16 5F 37 0F E6 8E AB 5A
0130 | 6F FB 99 F2 7B CE F9 DD 3B 6B 2E F9 1F BD 76 D0
0140 | 0C 92 A8 C1 0B 99 2A 07 05 0D E5 7E 4A 55 23 A0
0150 | C0 E3 F2 17 D2 7D 7F 1B 3A D9 A5 AE A4 5E C3 1C
0160 | 89 35 2C 07 27 15 2E 1A 8C C9 9A 80 5E CC 66 01
0170 | F8 AA 6F 92 61 3B CF 85 04 58 8E 6B 75 92 F7 39
0180 | 90 E4 C4 56 E3 96 80 C9 97 EB B3 96</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B00C0A0045428866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010055F11A0026B5AD5AC5828AB9</code> <code>829C89CBBD55B813972A35B19BE41D7C</code> <code>650F49409322E718E3D17E19853D1070</code> <code>21D4907CB821DE489FC8A282110AE38A</code> <code>523B385446283976B7A05838317543A4</code> <code>098E7E7A62301D93B362DF107B2C22CB</code> <code>22D7C2531C4FCA2D16762CE978C97B5D</code> <code>F3B3E60BE01087E32D7D70BD1B8433B5</code> <code>8F01126D0C56F98C9D77777B5E4EB57C</code> <code>E3EE17AF033E81B19E1E281F13CBCE3B</code> <code>A19639A31E0BD9FAC8E24D5ACB2928C8</code> <code>998AB60D95035D439EAECE695E6E2781</code> <code>73A8A933587F0E5D09F0BAB18FA1B9A0</code> <code>4AEC3BAF3F3EE99E33F69129283E161F</code> <code>A464D9E7A6B35F4BDAE1644C84EBC405</code> <code>165F370FE68EAB5A6FFB99F27BCEF9DD</code> <code>3B6B2EF91FBD76D00C92A8C10B992A07</code> <code>050DE57E4A5523A0C0E3F217D27D7F1B</code> <code>3AD9A5AEA45EC31C89352C0727152E1A</code> <code>8CC99A805ECC6601F8AA6F92613BCF85</code> <code>04588E6B7592F73990E4C456E39680C9</code><br> <code>97EBB396</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 840B908CA64E0FB6225CA44BC886D7BAF8810183920E925BD3DC713A19B6A6D8360B3DCA4653D967036BC7ED84C7EDE32DF633E7A9443EA00905D6E25FA4916A2BBC3A4025A6679A9097E8B208839C220DFCE2A3ACFFA24E84E4F23A57D47DE39AE79D391ECBD8EF3EB7796C9FAC18B4CEDF972AEA3FAC98D33C1A7BA988AB35E0861FA930343244614AD36EB39775999DF7BDEEF3D3DCAC2D7E5A43923ACB87E8201733EF95C1C74F544F2977E8892DDDB5537F16337C41E7F6094827C9F6D04D06167651FF2F63240855C17F9449F88D95F767828C1601D74B170EF6E90DFD6DFF6C462C977B2C5A069D9425427F618D7251C100DEC085C50ABE50366395B5</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 48 45 29 46 42 88 66
0010 | 7C 00 00 00 34 F7 CB 3B 39 8D DB F9 93 7A 80 D8
0020 | 74 6E E6 4E D3 88 0D 2D 8C A2 EC 8F F5 A5 25 3E
0030 | 0D 8B FE 82 57 8B 87 29 04 58 BD 97 70 9D BD 78
0040 | 01 4D 57 70 9D 79 04 45</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0148452946428866</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>7C000000</code> (124 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>398DDBF9937A80D8746EE64ED3880D2D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>8CA2EC8FF5A5253E0D8BFE82578B8729</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>0458BD97709DBD78014D57709D790445</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

