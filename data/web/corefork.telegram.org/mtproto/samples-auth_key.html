<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 B0 92 00 00 08 0A C3 68
0010 | 14 00 00 00 F1 8E 7E BE E1 14 C5 23 71 CA 63 62
0020 | 3D 95 87 5F 6D 68 C8 2B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>B0920000080AC368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 64 86 1B 08 0A C3 68
0010 | 50 00 00 00 63 24 16 05 E1 14 C5 23 71 CA 63 62
0020 | 3D 95 87 5F 6D 68 C8 2B 92 18 AE 27 8B DC F0 1D
0030 | 47 75 0E 32 7F FF C6 BD 08 1D EE EA 7F 08 B2 61
0040 | 05 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0164861B080AC368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081DEEEA7F08B26105000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2156919102884700421</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2156919102884700421</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2156919102884700421 = 1333306321 * 1617722101</code></p>
<pre><code>p = 1333306321
q = 1617722101</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1D EE EA 7F 08 B2 61 05 00 00 00
0010 | 04 4F 78 A3 D1 00 00 00 04 60 6C 7A F5 00 00 00
0020 | E1 14 C5 23 71 CA 63 62 3D 95 87 5F 6D 68 C8 2B
0030 | 92 18 AE 27 8B DC F0 1D 47 75 0E 32 7F FF C6 BD
0040 | 16 97 CB B0 A6 F6 1E D7 73 D9 4D 63 59 42 9F 9B
0050 | B9 16 81 50 32 C1 8A E5 98 BA 1C 38 26 74 3F 5B
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081DEEEA7F08B26105000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2156919102884700421</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044F78A3D1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1333306321</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04606C7AF5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1617722101</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>1697CBB0A6F61ED773D94D6359429F9B</code> <code>B916815032C18AE598BA1C3826743F5B</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081DEEEA7F08B26105000000044F78A3D100000004606C7AF5000000E114C52371CA63623D95875F6D68C82B9218AE278BDCF01D47750E327FFFC6BD1697CBB0A6F61ED773D94D6359429F9BB916815032C18AE598BA1C3826743F5B02000000
random_padding_bytes = FA4F8066D94F563569E07E7FB9466BB811BC1537CA88F0B188A04BA462C3806F8574938DFB02934F437A677B8E1A38D155C3A606B7B62BE906CA61695A36BF6E99584C9FDEA6FD14C99DDEC45A62FAFA37F5BD0F4FFCEF0AF044ABC4</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 7AF0B0968317FB85B9EAD21963D4E0132F1C415523794C904CADA6FE84341F17EC877C31012EE497BEF04139FBBA08C8B60A57BFDF92BDAE9049AEAB380927FE6522383607598C9DF634811307F21D95F1FF76C6327F6D11C529B041AA7AA3CC309CE0290E3E6F86E96B7BAD028D1A32B17FF39F88F57234AA50AA03D7F0F4B08634409FA8F9F899235AD93D967C1992E39DB74828012886681D60FF562C1FB4FAB510A21D16D8D90C95DC6FD41F5EF3531933C20862AA257F1872F98787E2A9BFC2CD59C38C9D64C7B77E0517072A812984AFCAEB1336FBA5F7DFF43B95A9F000B8FA8BF402CBF92A173470A340726C44FD2BF509E0B1DA3E7A11024183A4CC</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 8C 48 0B 00 08 0A C3 68
0010 | 40 01 00 00 BE E4 12 D7 E1 14 C5 23 71 CA 63 62
0020 | 3D 95 87 5F 6D 68 C8 2B 92 18 AE 27 8B DC F0 1D
0030 | 47 75 0E 32 7F FF C6 BD 04 4F 78 A3 D1 00 00 00
0040 | 04 60 6C 7A F5 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 7A F0 B0 96 83 17 FB 85 B9 EA D2 19
0060 | 63 D4 E0 13 2F 1C 41 55 23 79 4C 90 4C AD A6 FE
0070 | 84 34 1F 17 EC 87 7C 31 01 2E E4 97 BE F0 41 39
0080 | FB BA 08 C8 B6 0A 57 BF DF 92 BD AE 90 49 AE AB
0090 | 38 09 27 FE 65 22 38 36 07 59 8C 9D F6 34 81 13
00A0 | 07 F2 1D 95 F1 FF 76 C6 32 7F 6D 11 C5 29 B0 41
00B0 | AA 7A A3 CC 30 9C E0 29 0E 3E 6F 86 E9 6B 7B AD
00C0 | 02 8D 1A 32 B1 7F F3 9F 88 F5 72 34 AA 50 AA 03
00D0 | D7 F0 F4 B0 86 34 40 9F A8 F9 F8 99 23 5A D9 3D
00E0 | 96 7C 19 92 E3 9D B7 48 28 01 28 86 68 1D 60 FF
00F0 | 56 2C 1F B4 FA B5 10 A2 1D 16 D8 D9 0C 95 DC 6F
0100 | D4 1F 5E F3 53 19 33 C2 08 62 AA 25 7F 18 72 F9
0110 | 87 87 E2 A9 BF C2 CD 59 C3 8C 9D 64 C7 B7 7E 05
0120 | 17 07 2A 81 29 84 AF CA EB 13 36 FB A5 F7 DF F4
0130 | 3B 95 A9 F0 00 B8 FA 8B F4 02 CB F9 2A 17 34 70
0140 | A3 40 72 6C 44 FD 2B F5 09 E0 B1 DA 3E 7A 11 02
0150 | 41 83 A4 CC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>8C480B00080AC368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044F78A3D1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1333306321</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04606C7AF5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1617722101</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001007AF0B0968317FB85B9EAD219</code> <code>63D4E0132F1C415523794C904CADA6FE</code> <code>84341F17EC877C31012EE497BEF04139</code> <code>FBBA08C8B60A57BFDF92BDAE9049AEAB</code> <code>380927FE6522383607598C9DF6348113</code> <code>07F21D95F1FF76C6327F6D11C529B041</code> <code>AA7AA3CC309CE0290E3E6F86E96B7BAD</code> <code>028D1A32B17FF39F88F57234AA50AA03</code> <code>D7F0F4B08634409FA8F9F899235AD93D</code> <code>967C1992E39DB74828012886681D60FF</code> <code>562C1FB4FAB510A21D16D8D90C95DC6F</code> <code>D41F5EF3531933C20862AA257F1872F9</code> <code>8787E2A9BFC2CD59C38C9D64C7B77E05</code> <code>17072A812984AFCAEB1336FBA5F7DFF4</code> <code>3B95A9F000B8FA8BF402CBF92A173470</code> <code>A340726C44FD2BF509E0B1DA3E7A1102</code><br> <code>4183A4CC</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 FC 39 37 08 0A C3 68
0010 | 78 02 00 00 5C 07 E8 D0 E1 14 C5 23 71 CA 63 62
0020 | 3D 95 87 5F 6D 68 C8 2B 92 18 AE 27 8B DC F0 1D
0030 | 47 75 0E 32 7F FF C6 BD FE 50 02 00 F5 49 93 FF
0040 | FA AD C1 68 1D 65 E7 DA EE 41 4B 1D 47 B7 59 A3
0050 | B3 49 CA D6 1D 91 92 1F 73 07 9F D0 70 36 A3 88
0060 | C5 E2 D6 E9 E5 43 30 59 70 A0 75 78 41 E1 1D 97
0070 | DB E1 AF EB 73 00 8C 2B A6 7C 76 91 9D AC 32 48
0080 | 04 68 B8 A0 DC 66 F1 46 76 D5 68 6D 94 E9 25 DC
0090 | 1F 85 74 B6 A7 54 40 F6 3F AF D6 1F 82 C1 31 04
00A0 | 3E 49 D6 44 3C 7C 7C D6 83 34 03 96 76 89 9C 0D
00B0 | 47 AD C0 2E 9B 16 56 07 DD D0 D4 57 62 B0 94 0D
00C0 | 2C F6 DE 13 CD E9 F9 9A 8D 35 15 D8 C4 BC 3D 34
00D0 | E8 C7 E0 67 41 8C FB 8D D9 BA 45 EC BB 09 6C 9D
00E0 | A2 D0 A1 B1 20 DC 46 27 F3 14 1F 87 A7 2D 02 BB
00F0 | 80 7E 64 30 17 81 BF 3E 1C B2 EC 95 31 F1 3F 39
0100 | 32 84 23 71 B1 70 F7 B3 B1 00 4A A8 DE E6 8C 2C
0110 | 55 31 F7 74 8B 13 80 C4 96 11 48 CD 89 0B 9B 98
0120 | E7 78 F8 39 27 6D 9F 78 D9 CD BE 22 6C B1 52 74
0130 | CF E0 06 0A 49 41 35 2F CA 8E 5A 86 B1 0A 2E 6E
0140 | 76 12 7D C5 C9 99 C3 7F E0 44 BA FB 84 0E F1 63
0150 | 32 FC DD 6D FB 85 B5 D9 CF AA 84 EB 79 16 A2 32
0160 | 9B A7 F0 FE 2B AA B3 E4 4C 72 E5 C4 B8 6E DF 97
0170 | 34 F6 D1 EF 57 E3 A3 A2 5B 04 A2 CD DF D3 5C 4E
0180 | 0B BA 3C 1F 1B 83 03 D2 82 41 43 90 3F B5 84 F3
0190 | 7C 0D 79 86 75 C1 4C E3 68 6F C6 4E 1C D7 C8 76
01A0 | 5F 22 67 37 13 76 25 62 4E 26 DF E3 5E C0 EA CE
01B0 | 6C 53 08 40 FE 3F E4 2E 53 FF 9F EA 19 0C 4F D0
01C0 | 23 A4 9D 2E 51 08 82 4B 9A 6C A0 49 FB 29 9E D0
01D0 | 3A B6 86 B1 2E 49 A3 58 E5 A2 57 14 AC 03 E4 BC
01E0 | 55 4D 0C A7 EE BC 0B 4B A8 F6 60 A4 47 CB 4D 24
01F0 | 5E 09 A4 DE 6B 77 F1 EF 0A 57 29 66 1F E5 CF 7C
0200 | 67 EB DC 9E A2 5C A8 07 E4 78 DB 0F CA 00 68 37
0210 | 86 F8 F2 F7 FE 43 2C E8 D6 F8 04 82 25 D0 6E D1
0220 | D7 9D 51 E6 01 75 3D 15 EE 39 12 78 C0 61 7D 3F
0230 | 2F 3A C6 F9 54 28 AE 83 7B 8A E1 63 04 E4 C5 34
0240 | 0B DF 48 AB F8 B1 95 E0 9E 23 8D 39 F9 73 38 93
0250 | EB 0F 60 03 B0 99 8E 25 1F C0 B5 B7 E5 33 AB C3
0260 | 89 FC 4E 25 08 96 14 8D 1E 2C 32 32 A9 3B FA 4C
0270 | AC 30 B2 DC E5 87 D7 B1 25 7E CE 15 6E 5C B4 5B
0280 | 60 83 7C 1E 60 90 81 63 4A 3A DA F0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01FC3937080AC368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200F54993FFFAADC1681D65E7DA</code> <code>EE414B1D47B759A3B349CAD61D91921F</code> <code>73079FD07036A388C5E2D6E9E5433059</code> <code>70A0757841E11D97DBE1AFEB73008C2B</code> <code>A67C76919DAC32480468B8A0DC66F146</code> <code>76D5686D94E925DC1F8574B6A75440F6</code> <code>3FAFD61F82C131043E49D6443C7C7CD6</code> <code>8334039676899C0D47ADC02E9B165607</code> <code>DDD0D45762B0940D2CF6DE13CDE9F99A</code> <code>8D3515D8C4BC3D34E8C7E067418CFB8D</code> <code>D9BA45ECBB096C9DA2D0A1B120DC4627</code> <code>F3141F87A72D02BB807E64301781BF3E</code> <code>1CB2EC9531F13F3932842371B170F7B3</code> <code>B1004AA8DEE68C2C5531F7748B1380C4</code> <code>961148CD890B9B98E778F839276D9F78</code> <code>D9CDBE226CB15274CFE0060A4941352F</code> <code>CA8E5A86B10A2E6E76127DC5C999C37F</code> <code>E044BAFB840EF16332FCDD6DFB85B5D9</code> <code>CFAA84EB7916A2329BA7F0FE2BAAB3E4</code> <code>4C72E5C4B86EDF9734F6D1EF57E3A3A2</code> <code>5B04A2CDDFD35C4E0BBA3C1F1B8303D2</code> <code>824143903FB584F37C0D798675C14CE3</code> <code>686FC64E1CD7C8765F22673713762562</code> <code>4E26DFE35EC0EACE6C530840FE3FE42E</code> <code>53FF9FEA190C4FD023A49D2E5108824B</code> <code>9A6CA049FB299ED03AB686B12E49A358</code> <code>E5A25714AC03E4BC554D0CA7EEBC0B4B</code> <code>A8F660A447CB4D245E09A4DE6B77F1EF</code> <code>0A5729661FE5CF7C67EBDC9EA25CA807</code> <code>E478DB0FCA00683786F8F2F7FE432CE8</code> <code>D6F8048225D06ED1D79D51E601753D15</code> <code>EE391278C0617D3F2F3AC6F95428AE83</code> <code>7B8AE16304E4C5340BDF48ABF8B195E0</code> <code>9E238D39F9733893EB0F6003B0998E25</code> <code>1FC0B5B7E533ABC389FC4E250896148D</code> <code>1E2C3232A93BFA4CAC30B2DCE587D7B1</code> <code>257ECE156E5CB45B60837C1E60908163</code><br> <code>4A3ADAF0</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = F54993FFFAADC1681D65E7DAEE414B1D47B759A3B349CAD61D91921F73079FD07036A388C5E2D6E9E543305970A0757841E11D97DBE1AFEB73008C2BA67C76919DAC32480468B8A0DC66F14676D5686D94E925DC1F8574B6A75440F63FAFD61F82C131043E49D6443C7C7CD68334039676899C0D47ADC02E9B165607DDD0D45762B0940D2CF6DE13CDE9F99A8D3515D8C4BC3D34E8C7E067418CFB8DD9BA45ECBB096C9DA2D0A1B120DC4627F3141F87A72D02BB807E64301781BF3E1CB2EC9531F13F3932842371B170F7B3B1004AA8DEE68C2C5531F7748B1380C4961148CD890B9B98E778F839276D9F78D9CDBE226CB15274CFE0060A4941352FCA8E5A86B10A2E6E76127DC5C999C37FE044BAFB840EF16332FCDD6DFB85B5D9CFAA84EB7916A2329BA7F0FE2BAAB3E44C72E5C4B86EDF9734F6D1EF57E3A3A25B04A2CDDFD35C4E0BBA3C1F1B8303D2824143903FB584F37C0D798675C14CE3686FC64E1CD7C8765F226737137625624E26DFE35EC0EACE6C530840FE3FE42E53FF9FEA190C4FD023A49D2E5108824B9A6CA049FB299ED03AB686B12E49A358E5A25714AC03E4BC554D0CA7EEBC0B4BA8F660A447CB4D245E09A4DE6B77F1EF0A5729661FE5CF7C67EBDC9EA25CA807E478DB0FCA00683786F8F2F7FE432CE8D6F8048225D06ED1D79D51E601753D15EE391278C0617D3F2F3AC6F95428AE837B8AE16304E4C5340BDF48ABF8B195E09E238D39F9733893EB0F6003B0998E251FC0B5B7E533ABC389FC4E250896148D1E2C3232A93BFA4CAC30B2DCE587D7B1257ECE156E5CB45B60837C1E609081634A3ADAF0
tmp_aes_key = B52C922736016A885C6A0F98103042CECAB6E813E483A5B1BA2EE9177342F51B
tmp_aes_iv = 997F94D58E3A430375AC78E5C71154541B9EDE79AFC00450B71C555D1697CBB0</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 722F24DBAB85D6385B1F0612806625C163D1D067BA0D89B5E114C52371CA63623D95875F6D68C82B9218AE278BDCF01D47750E327FFFC6BD03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003C7F454F8EF1B7BE32945C566D56A2BE6C945C312E3605AA5441939BF50B301B7E88A68B71B27DFA4200E9DE2809C091B044E033B1362F238655CB3F63801067F49FFE0CCDD0F8114DE18549BFACEAD120781A92EEF999DA613C2C3498FE165A2C167A110211A71873EFA1C73676FCA289BC1E9CDC757442BB5AD62FBD993F3F43118E4BDFC94CDC208E913826EE354AAD8B0CE9965B9A1F6516F51D26C483B6D823BE25E80FB78531F0FDDB18C8BD93E22A54A3A8B9D737765C008042EEC4DF61067026CD126F731CF1CD6888930DF70288D43AE71F26633778501B6DE0745801E01C41E037DF562E9E7ED5D260ABA498B891872AD801305C048CD0058939AB080AC3689A802822B7DE58DC
answer = BA0D89B5E114C52371CA63623D95875F6D68C82B9218AE278BDCF01D47750E327FFFC6BD03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003C7F454F8EF1B7BE32945C566D56A2BE6C945C312E3605AA5441939BF50B301B7E88A68B71B27DFA4200E9DE2809C091B044E033B1362F238655CB3F63801067F49FFE0CCDD0F8114DE18549BFACEAD120781A92EEF999DA613C2C3498FE165A2C167A110211A71873EFA1C73676FCA289BC1E9CDC757442BB5AD62FBD993F3F43118E4BDFC94CDC208E913826EE354AAD8B0CE9965B9A1F6516F51D26C483B6D823BE25E80FB78531F0FDDB18C8BD93E22A54A3A8B9D737765C008042EEC4DF61067026CD126F731CF1CD6888930DF70288D43AE71F26633778501B6DE0745801E01C41E037DF562E9E7ED5D260ABA498B891872AD801305C048CD0058939AB080AC3689A802822B7DE58DC</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 E1 14 C5 23 71 CA 63 62 3D 95 87 5F
0010 | 6D 68 C8 2B 92 18 AE 27 8B DC F0 1D 47 75 0E 32
0020 | 7F FF C6 BD 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 3C 7F 45 4F 8E F1 B7 BE 32 94 5C 56 6D 56 A2 BE
0140 | 6C 94 5C 31 2E 36 05 AA 54 41 93 9B F5 0B 30 1B
0150 | 7E 88 A6 8B 71 B2 7D FA 42 00 E9 DE 28 09 C0 91
0160 | B0 44 E0 33 B1 36 2F 23 86 55 CB 3F 63 80 10 67
0170 | F4 9F FE 0C CD D0 F8 11 4D E1 85 49 BF AC EA D1
0180 | 20 78 1A 92 EE F9 99 DA 61 3C 2C 34 98 FE 16 5A
0190 | 2C 16 7A 11 02 11 A7 18 73 EF A1 C7 36 76 FC A2
01A0 | 89 BC 1E 9C DC 75 74 42 BB 5A D6 2F BD 99 3F 3F
01B0 | 43 11 8E 4B DF C9 4C DC 20 8E 91 38 26 EE 35 4A
01C0 | AD 8B 0C E9 96 5B 9A 1F 65 16 F5 1D 26 C4 83 B6
01D0 | D8 23 BE 25 E8 0F B7 85 31 F0 FD DB 18 C8 BD 93
01E0 | E2 2A 54 A3 A8 B9 D7 37 76 5C 00 80 42 EE C4 DF
01F0 | 61 06 70 26 CD 12 6F 73 1C F1 CD 68 88 93 0D F7
0200 | 02 88 D4 3A E7 1F 26 63 37 78 50 1B 6D E0 74 58
0210 | 01 E0 1C 41 E0 37 DF 56 2E 9E 7E D5 D2 60 AB A4
0220 | 98 B8 91 87 2A D8 01 30 5C 04 8C D0 05 89 39 AB
0230 | 08 0A C3 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001003C7F454F8EF1B7BE32945C56</code> <code>6D56A2BE6C945C312E3605AA5441939B</code> <code>F50B301B7E88A68B71B27DFA4200E9DE</code> <code>2809C091B044E033B1362F238655CB3F</code> <code>63801067F49FFE0CCDD0F8114DE18549</code> <code>BFACEAD120781A92EEF999DA613C2C34</code> <code>98FE165A2C167A110211A71873EFA1C7</code> <code>3676FCA289BC1E9CDC757442BB5AD62F</code> <code>BD993F3F43118E4BDFC94CDC208E9138</code> <code>26EE354AAD8B0CE9965B9A1F6516F51D</code> <code>26C483B6D823BE25E80FB78531F0FDDB</code> <code>18C8BD93E22A54A3A8B9D737765C0080</code> <code>42EEC4DF61067026CD126F731CF1CD68</code> <code>88930DF70288D43AE71F26633778501B</code> <code>6DE0745801E01C41E037DF562E9E7ED5</code> <code>D260ABA498B891872AD801305C048CD0</code><br> <code>058939AB</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>080AC368</code> (1757612552 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 8F6DB729005C904885CC919DA9DA995A52079870B7A98DAE8D0C916C62F4DD1D6C6905B5FDB6180E20B8BA62F3F9A619108EC26895F2000D1F22A26434DB93A6D751C13E1916BD3C7E61DF71D7ECB2D1B43C442ED661B4CB8E4FFBC81A2FECD0CC9F861869D523135C438538F70128EA3C3B183F6369846BD782E4374A84BF7237012FF36897D35E9682BBEBC915C20A674F55C94C80977934115590C7919B65EF2FFADBDC5EFEE06D2A79630930F845C66D20F5CBE046039B3C9C6D3EB1065AE9940987D2852A99A0D68A239A5C8D5B8F3C47C8CD442F893DD899C1A4E114D681FA9976E51C579DDB586A458F95AFD88EC80E16EF18D0CDF7A6B368796B7622</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 532B62DC1591FDB6F62DB13D6FAE3AA298AB9981BAE674DD6B5AAF850724A41342E339685D974A0FED48AF3FBD8394527AE0A3B8FB2B6AD35CD81A819B682CE48E58E0C178DDD51F12C6DC7C3A5867A4AF04F92F63B4A0C941327F1ACC88B3ECE0E56264F340699117283083616ECCD3C0D77D8ED3E16F8CD51F56283CCDE4AD5759861C050BB90F1CED129D5C53CC374745894A10A7EB7AC17D4E5952C0CF4D376D091CBC27DA1A4E196C7712BF98F059434C7ED92A582F8D74033A0042A6AA374CB9912C6588734DC63EA33803AE8EC1B29B74AF32D531544692D14261B05C784E18B30C8B7ABEE4866D40AB525190BD1E89034D6FED053FFA9BA69FBCA723</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 E1 14 C5 23 71 CA 63 62 3D 95 87 5F
0010 | 6D 68 C8 2B 92 18 AE 27 8B DC F0 1D 47 75 0E 32
0020 | 7F FF C6 BD 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 53 2B 62 DC 15 91 FD B6 F6 2D B1 3D 6F AE 3A A2
0040 | 98 AB 99 81 BA E6 74 DD 6B 5A AF 85 07 24 A4 13
0050 | 42 E3 39 68 5D 97 4A 0F ED 48 AF 3F BD 83 94 52
0060 | 7A E0 A3 B8 FB 2B 6A D3 5C D8 1A 81 9B 68 2C E4
0070 | 8E 58 E0 C1 78 DD D5 1F 12 C6 DC 7C 3A 58 67 A4
0080 | AF 04 F9 2F 63 B4 A0 C9 41 32 7F 1A CC 88 B3 EC
0090 | E0 E5 62 64 F3 40 69 91 17 28 30 83 61 6E CC D3
00A0 | C0 D7 7D 8E D3 E1 6F 8C D5 1F 56 28 3C CD E4 AD
00B0 | 57 59 86 1C 05 0B B9 0F 1C ED 12 9D 5C 53 CC 37
00C0 | 47 45 89 4A 10 A7 EB 7A C1 7D 4E 59 52 C0 CF 4D
00D0 | 37 6D 09 1C BC 27 DA 1A 4E 19 6C 77 12 BF 98 F0
00E0 | 59 43 4C 7E D9 2A 58 2F 8D 74 03 3A 00 42 A6 AA
00F0 | 37 4C B9 91 2C 65 88 73 4D C6 3E A3 38 03 AE 8E
0100 | C1 B2 9B 74 AF 32 D5 31 54 46 92 D1 42 61 B0 5C
0110 | 78 4E 18 B3 0C 8B 7A BE E4 86 6D 40 AB 52 51 90
0120 | BD 1E 89 03 4D 6F ED 05 3F FA 9B A6 9F BC A7 23</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100532B62DC1591FDB6F62DB13D</code> <code>6FAE3AA298AB9981BAE674DD6B5AAF85</code> <code>0724A41342E339685D974A0FED48AF3F</code> <code>BD8394527AE0A3B8FB2B6AD35CD81A81</code> <code>9B682CE48E58E0C178DDD51F12C6DC7C</code> <code>3A5867A4AF04F92F63B4A0C941327F1A</code> <code>CC88B3ECE0E56264F340699117283083</code> <code>616ECCD3C0D77D8ED3E16F8CD51F5628</code> <code>3CCDE4AD5759861C050BB90F1CED129D</code> <code>5C53CC374745894A10A7EB7AC17D4E59</code> <code>52C0CF4D376D091CBC27DA1A4E196C77</code> <code>12BF98F059434C7ED92A582F8D74033A</code> <code>0042A6AA374CB9912C6588734DC63EA3</code> <code>3803AE8EC1B29B74AF32D531544692D1</code> <code>4261B05C784E18B30C8B7ABEE4866D40</code> <code>AB525190BD1E89034D6FED053FFA9BA6</code><br> <code>9FBCA723</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366E114C52371CA63623D95875F6D68C82B9218AE278BDCF01D47750E327FFFC6BD0000000000000000FE000100532B62DC1591FDB6F62DB13D6FAE3AA298AB9981BAE674DD6B5AAF850724A41342E339685D974A0FED48AF3FBD8394527AE0A3B8FB2B6AD35CD81A819B682CE48E58E0C178DDD51F12C6DC7C3A5867A4AF04F92F63B4A0C941327F1ACC88B3ECE0E56264F340699117283083616ECCD3C0D77D8ED3E16F8CD51F56283CCDE4AD5759861C050BB90F1CED129D5C53CC374745894A10A7EB7AC17D4E5952C0CF4D376D091CBC27DA1A4E196C7712BF98F059434C7ED92A582F8D74033A0042A6AA374CB9912C6588734DC63EA33803AE8EC1B29B74AF32D531544692D14261B05C784E18B30C8B7ABEE4866D40AB525190BD1E89034D6FED053FFA9BA69FBCA723
padding = 4889F2FB281C1EA6022B7D20
tmp_aes_key = B52C922736016A885C6A0F98103042CECAB6E813E483A5B1BA2EE9177342F51B
tmp_aes_iv = 997F94D58E3A430375AC78E5C71154541B9EDE79AFC00450B71C555D1697CBB0</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 1E2BCCA11A558631295723726B63E9BAEE99091886575138C574C078925DA61B7DE299D1731AF476D69DCF947D8C8178A97162612B5AD92BDD6680A10F89651F642BC5CFAD818CC9225CB2A5502E45E822E84B04AF77ED84D6AFC2CFC6CDA9D18249CD0878D77F8B9F2DD15FC00B1E06C0C712453929AD026F7C1C37D445D215B246B20F580B68C77D39DF0688B48CD09087358F2083B149E215F97527E40A9934E516E4E2C2185BF4E90ADFAFBA54A6A64106894EEC299CD69ADE877E52E7C4E1F16D2C2A0A3AFF1161331379A7B874FF9B5B90E35C412428D792595B4DB953A5C408AF753D5F914413BAC52F961FD922504189AF1798E9E3B1E0E5342F35167A2F80D4537C216785CAF3254C16FBEE7966C6DA35D71D0C9F00BE3777B51566378F070C7AF5985E84F0625A25CC1CB20FEA52E76205C2B8C589BF175513705BAF338F61255BD00408E6573CE231961D</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 90 48 0B 00 08 0A C3 68
0010 | 78 01 00 00 1F 5F 04 F5 E1 14 C5 23 71 CA 63 62
0020 | 3D 95 87 5F 6D 68 C8 2B 92 18 AE 27 8B DC F0 1D
0030 | 47 75 0E 32 7F FF C6 BD FE 50 01 00 1E 2B CC A1
0040 | 1A 55 86 31 29 57 23 72 6B 63 E9 BA EE 99 09 18
0050 | 86 57 51 38 C5 74 C0 78 92 5D A6 1B 7D E2 99 D1
0060 | 73 1A F4 76 D6 9D CF 94 7D 8C 81 78 A9 71 62 61
0070 | 2B 5A D9 2B DD 66 80 A1 0F 89 65 1F 64 2B C5 CF
0080 | AD 81 8C C9 22 5C B2 A5 50 2E 45 E8 22 E8 4B 04
0090 | AF 77 ED 84 D6 AF C2 CF C6 CD A9 D1 82 49 CD 08
00A0 | 78 D7 7F 8B 9F 2D D1 5F C0 0B 1E 06 C0 C7 12 45
00B0 | 39 29 AD 02 6F 7C 1C 37 D4 45 D2 15 B2 46 B2 0F
00C0 | 58 0B 68 C7 7D 39 DF 06 88 B4 8C D0 90 87 35 8F
00D0 | 20 83 B1 49 E2 15 F9 75 27 E4 0A 99 34 E5 16 E4
00E0 | E2 C2 18 5B F4 E9 0A DF AF BA 54 A6 A6 41 06 89
00F0 | 4E EC 29 9C D6 9A DE 87 7E 52 E7 C4 E1 F1 6D 2C
0100 | 2A 0A 3A FF 11 61 33 13 79 A7 B8 74 FF 9B 5B 90
0110 | E3 5C 41 24 28 D7 92 59 5B 4D B9 53 A5 C4 08 AF
0120 | 75 3D 5F 91 44 13 BA C5 2F 96 1F D9 22 50 41 89
0130 | AF 17 98 E9 E3 B1 E0 E5 34 2F 35 16 7A 2F 80 D4
0140 | 53 7C 21 67 85 CA F3 25 4C 16 FB EE 79 66 C6 DA
0150 | 35 D7 1D 0C 9F 00 BE 37 77 B5 15 66 37 8F 07 0C
0160 | 7A F5 98 5E 84 F0 62 5A 25 CC 1C B2 0F EA 52 E7
0170 | 62 05 C2 B8 C5 89 BF 17 55 13 70 5B AF 33 8F 61
0180 | 25 5B D0 04 08 E6 57 3C E2 31 96 1D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>90480B00080AC368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001001E2BCCA11A55863129572372</code> <code>6B63E9BAEE99091886575138C574C078</code> <code>925DA61B7DE299D1731AF476D69DCF94</code> <code>7D8C8178A97162612B5AD92BDD6680A1</code> <code>0F89651F642BC5CFAD818CC9225CB2A5</code> <code>502E45E822E84B04AF77ED84D6AFC2CF</code> <code>C6CDA9D18249CD0878D77F8B9F2DD15F</code> <code>C00B1E06C0C712453929AD026F7C1C37</code> <code>D445D215B246B20F580B68C77D39DF06</code> <code>88B48CD09087358F2083B149E215F975</code> <code>27E40A9934E516E4E2C2185BF4E90ADF</code> <code>AFBA54A6A64106894EEC299CD69ADE87</code> <code>7E52E7C4E1F16D2C2A0A3AFF11613313</code> <code>79A7B874FF9B5B90E35C412428D79259</code> <code>5B4DB953A5C408AF753D5F914413BAC5</code> <code>2F961FD922504189AF1798E9E3B1E0E5</code> <code>342F35167A2F80D4537C216785CAF325</code> <code>4C16FBEE7966C6DA35D71D0C9F00BE37</code> <code>77B51566378F070C7AF5985E84F0625A</code> <code>25CC1CB20FEA52E76205C2B8C589BF17</code> <code>5513705BAF338F61255BD00408E6573C</code><br> <code>E231961D</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 129C44EB415424F4315E0F5F9E4A9CD63B36141BAC8C254CFF9DC479B5EA327EBD25EEEBDD1C782960303206801D11B03A98DB50573B1CCB5BDD07665E5540BDAAB83C7330315A17FA4965F938C11E5297DDC2BF824B68510F30781FF9082A6E7F389E91DB66736099BC0E3A1AE0C6F82C4C6A1EBB2976279906F6EF25CEBBF022D35DCD2225ACA408E69859A7F2ED9254B658B5AC1437D7EDA933AC24CA7407F27CB98D9C9B60092E7EEAF65062313F1D917045E669490A34FEBA307E094468706D5E7F31C9448F918E9D8ED2BFB0B39A0039A3FE4F30E19B0AB1814CFA2A39257C2DFBA0EAB3E1B7E939747B99BBAD269CF40E0EA1C670614C06309F711E41</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 FC B1 63 09 0A C3 68
0010 | 34 00 00 00 34 F7 CB 3B E1 14 C5 23 71 CA 63 62
0020 | 3D 95 87 5F 6D 68 C8 2B 92 18 AE 27 8B DC F0 1D
0030 | 47 75 0E 32 7F FF C6 BD 74 A1 4E 8F 85 AF 2E D4
0040 | 5D FF 1B 8D 19 A8 59 3F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01FCB163090AC368</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>E114C52371CA63623D95875F6D68C82B</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9218AE278BDCF01D47750E327FFFC6BD</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>74A14E8F85AF2ED45DFF1B8D19A8593F</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

