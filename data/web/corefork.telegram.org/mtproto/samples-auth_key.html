<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 5C 54 07 00 D5 7C AE 66
0010 | 14 00 00 00 F1 8E 7E BE 98 34 7C 45 20 EB E0 DA
0020 | DB F9 DE F5 87 F6 3A 18</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>5C540700D57CAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 74 90 DB D5 7C AE 66
0010 | C8 00 00 00 63 24 16 05 98 34 7C 45 20 EB E0 DA
0020 | DB F9 DE F5 87 F6 3A 18 9A 91 88 40 20 68 F2 31
0030 | 91 D9 0C C3 31 3C FE D2 08 0F A1 9D 05 A1 83 1A
0040 | 5D 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017490DBD57CAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>C8000000</code> (200 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>080FA19D05A1831A5D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1126354029329455709</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1126354029329455709</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1126354029329455709 = 1047794147 * 1074976447</code></p>
<pre><code>p = 1047794147
q = 1074976447</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 0F A1 9D 05 A1 83 1A 5D 00 00 00
0010 | 04 3E 74 11 E3 00 00 00 04 40 12 D6 BF 00 00 00
0020 | 98 34 7C 45 20 EB E0 DA DB F9 DE F5 87 F6 3A 18
0030 | 9A 91 88 40 20 68 F2 31 91 D9 0C C3 31 3C FE D2
0040 | 87 3C C6 12 C1 7A 98 30 AA 40 41 18 56 12 8B 15
0050 | 2A A6 92 41 8A D8 FC 3B 6A 7E C1 BA DF 1A 7C C3
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>080FA19D05A1831A5D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1126354029329455709</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043E7411E3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1047794147</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>044012D6BF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1074976447</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>873CC612C17A9830AA40411856128B15</code> <code>2AA692418AD8FC3B6A7EC1BADF1A7CC3</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9080FA19D05A1831A5D000000043E7411E3000000044012D6BF00000098347C4520EBE0DADBF9DEF587F63A189A9188402068F23191D90CC3313CFED2873CC612C17A9830AA40411856128B152AA692418AD8FC3B6A7EC1BADF1A7CC302000000
random_padding_bytes = 7E3A165D4F87FDA3F2B5A0FE14639AACF9EF9C55B1CCA0E1270A3E30543E01D2AEE50E0509B7B25B659285ADB3350478DAEF8C11A5874B34457496D65B199A44C7D18D3C80DFDB21583C46B736C8A59CB332E6E79287F6B492787A60</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 46735142BBFC6C0924570D4792BAB3D3BEF366EB9B3F86167B5969A72E7487968CE37FEE44C7F4AE17558F5411BBB3AFBB4DC21B1823FA6999BD922FF19D382E81E37D3F2EEBF7D15255FF4AFD95B010F7AB894AC4F234014A0A89EEF9DCA7C8E4132D831D7415877C3BC90C02CB17B7FA6038ED76ED61F7AEB2308B3D21CC9EDF4D70D370E176FD93AA1482E9654066CFB656FC9BD6106A3D549AD1A99E2CC5EEBE8AE699B6C1779F5CBC3791F8AF238673E9EBCD48BE5A19635F110567E5A5DE7439B7012E8425F3F0A65B0268A0DB12D2BFABE38558094C8B0E3989DD4ACBEA3952FE16ACB334C23047E2114414B2A2BD43A7AD2A365C86879ABCEBFE417A</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 14 15 0C 00 D6 7C AE 66
0010 | 40 01 00 00 BE E4 12 D7 98 34 7C 45 20 EB E0 DA
0020 | DB F9 DE F5 87 F6 3A 18 9A 91 88 40 20 68 F2 31
0030 | 91 D9 0C C3 31 3C FE D2 04 3E 74 11 E3 00 00 00
0040 | 04 40 12 D6 BF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 46 73 51 42 BB FC 6C 09 24 57 0D 47
0060 | 92 BA B3 D3 BE F3 66 EB 9B 3F 86 16 7B 59 69 A7
0070 | 2E 74 87 96 8C E3 7F EE 44 C7 F4 AE 17 55 8F 54
0080 | 11 BB B3 AF BB 4D C2 1B 18 23 FA 69 99 BD 92 2F
0090 | F1 9D 38 2E 81 E3 7D 3F 2E EB F7 D1 52 55 FF 4A
00A0 | FD 95 B0 10 F7 AB 89 4A C4 F2 34 01 4A 0A 89 EE
00B0 | F9 DC A7 C8 E4 13 2D 83 1D 74 15 87 7C 3B C9 0C
00C0 | 02 CB 17 B7 FA 60 38 ED 76 ED 61 F7 AE B2 30 8B
00D0 | 3D 21 CC 9E DF 4D 70 D3 70 E1 76 FD 93 AA 14 82
00E0 | E9 65 40 66 CF B6 56 FC 9B D6 10 6A 3D 54 9A D1
00F0 | A9 9E 2C C5 EE BE 8A E6 99 B6 C1 77 9F 5C BC 37
0100 | 91 F8 AF 23 86 73 E9 EB CD 48 BE 5A 19 63 5F 11
0110 | 05 67 E5 A5 DE 74 39 B7 01 2E 84 25 F3 F0 A6 5B
0120 | 02 68 A0 DB 12 D2 BF AB E3 85 58 09 4C 8B 0E 39
0130 | 89 DD 4A CB EA 39 52 FE 16 AC B3 34 C2 30 47 E2
0140 | 11 44 14 B2 A2 BD 43 A7 AD 2A 36 5C 86 87 9A BC
0150 | EB FE 41 7A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>14150C00D67CAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043E7411E3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1047794147</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>044012D6BF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1074976447</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010046735142BBFC6C0924570D47</code> <code>92BAB3D3BEF366EB9B3F86167B5969A7</code> <code>2E7487968CE37FEE44C7F4AE17558F54</code> <code>11BBB3AFBB4DC21B1823FA6999BD922F</code> <code>F19D382E81E37D3F2EEBF7D15255FF4A</code> <code>FD95B010F7AB894AC4F234014A0A89EE</code> <code>F9DCA7C8E4132D831D7415877C3BC90C</code> <code>02CB17B7FA6038ED76ED61F7AEB2308B</code> <code>3D21CC9EDF4D70D370E176FD93AA1482</code> <code>E9654066CFB656FC9BD6106A3D549AD1</code> <code>A99E2CC5EEBE8AE699B6C1779F5CBC37</code> <code>91F8AF238673E9EBCD48BE5A19635F11</code> <code>0567E5A5DE7439B7012E8425F3F0A65B</code> <code>0268A0DB12D2BFABE38558094C8B0E39</code> <code>89DD4ACBEA3952FE16ACB334C23047E2</code> <code>114414B2A2BD43A7AD2A365C86879ABC</code><br> <code>EBFE417A</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 8C 73 A4 D6 7C AE 66
0010 | B8 02 00 00 5C 07 E8 D0 98 34 7C 45 20 EB E0 DA
0020 | DB F9 DE F5 87 F6 3A 18 9A 91 88 40 20 68 F2 31
0030 | 91 D9 0C C3 31 3C FE D2 FE 50 02 00 F1 03 E3 4D
0040 | 57 63 16 DC 3A 7E 00 30 86 5E D0 4F A6 29 83 96
0050 | 12 B9 5E D3 78 F8 BB A2 F7 6A 07 1B D1 F0 E7 51
0060 | C5 74 41 ED F5 1E C1 96 3F 9C 88 69 EF 96 F1 58
0070 | 78 B1 2D 3A 1A 67 C9 4E B2 DF D6 A2 D7 C0 A0 89
0080 | 90 F1 EF C7 60 9A EC 68 12 75 32 6F 16 81 CD F5
0090 | 7F 90 F1 DE 61 0C 79 31 1C 4C EC 4D 07 75 D3 39
00A0 | 4B 3F 8B BD 47 F5 0E F1 0D A9 A3 36 38 9A 25 9E
00B0 | 6A F9 CA D0 26 83 AE 29 24 57 52 F0 88 08 1D 1F
00C0 | 79 49 69 86 51 E7 59 E1 EF F9 74 E4 FF 3A 21 AA
00D0 | F3 E7 3C 92 E2 CF 7C FB F2 46 0D ED 2D 83 B1 A6
00E0 | A7 AC 31 C8 D0 93 F1 FA 4E 19 22 03 59 CA 59 39
00F0 | 5F EF 93 9D C3 DD D5 48 C3 CE 9E F6 8A FD 99 48
0100 | 8A 70 34 CC 0F CE 55 C7 F1 62 39 C1 82 AE A5 AF
0110 | 96 54 64 B6 C7 7B CC 47 C2 04 2D 4D 1A 8D 6E 00
0120 | F5 25 68 D5 1B 30 08 8C 12 3C 0C 25 A9 56 A5 9C
0130 | 8D 35 87 EA 9A 0B 8C 1E 81 46 75 87 4C 1D 92 8E
0140 | 0A 92 A0 6E CF 5B EC 44 C2 53 8D 05 A1 D6 DC 87
0150 | BB 72 48 C8 DD 8A 86 B0 68 5B 75 AC B4 79 A4 A9
0160 | BC DB 51 A7 9D D5 AA F5 51 64 69 A5 2A 47 93 A2
0170 | 77 C3 9B 08 D8 FB 5C 55 58 EB 38 44 5E 78 CD FF
0180 | C3 41 8F A5 BC 6D 3F 22 E6 75 EF 65 A1 9D 4C 34
0190 | F8 0D 11 CF 45 90 6E AB 4B 4D 4E 94 12 97 67 89
01A0 | DD 90 51 99 40 3A C5 86 A3 F2 58 0F 7F 9E BC 86
01B0 | F9 1B 78 F8 E7 5B 0A 89 A6 5E 71 EB 90 F4 D7 9A
01C0 | FA B7 CF 44 B1 C9 93 16 2F 38 E1 D7 6E EA 16 20
01D0 | E5 29 4B A9 FB A3 26 6A 58 C8 D2 92 E8 2E 6D E7
01E0 | DA D3 06 4D 0C 70 EB 8E AD B9 80 23 B7 83 AF BD
01F0 | 11 CE AD 10 3F 31 99 8E 43 DB 27 04 F8 92 AC EA
0200 | 10 08 0B 02 6A CB 12 17 90 D4 AA E7 4A 95 19 BB
0210 | 9F 1F 5C BA 8F 55 DB A2 90 57 FA 22 41 76 BB D9
0220 | 6F 4B 8F 0A 8E 98 9A 5A 3B 4D 9F 5B 39 70 F9 34
0230 | D2 0A E9 39 89 FE 13 B0 E4 87 17 06 B5 0E C9 B7
0240 | 61 38 9F D0 25 65 E2 C8 49 39 69 90 3D 13 A7 F8
0250 | 3A 7C 0E 69 5F 69 76 7A E0 91 C4 10 0E 50 45 84
0260 | 6F B8 CD FD 85 6A 4D A3 DD DF 8F 5E 90 09 DC 1D
0270 | F0 C9 F2 43 6A 77 06 7F 56 A1 D2 C0 04 E3 97 C3
0280 | 15 3C CA 8B E1 A3 6E 29 DD 8D FA AB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018C73A4D67CAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>B8020000</code> (696 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200F103E34D576316DC3A7E0030</code> <code>865ED04FA629839612B95ED378F8BBA2</code> <code>F76A071BD1F0E751C57441EDF51EC196</code> <code>3F9C8869EF96F15878B12D3A1A67C94E</code> <code>B2DFD6A2D7C0A08990F1EFC7609AEC68</code> <code>1275326F1681CDF57F90F1DE610C7931</code> <code>1C4CEC4D0775D3394B3F8BBD47F50EF1</code> <code>0DA9A336389A259E6AF9CAD02683AE29</code> <code>245752F088081D1F7949698651E759E1</code> <code>EFF974E4FF3A21AAF3E73C92E2CF7CFB</code> <code>F2460DED2D83B1A6A7AC31C8D093F1FA</code> <code>4E19220359CA59395FEF939DC3DDD548</code> <code>C3CE9EF68AFD99488A7034CC0FCE55C7</code> <code>F16239C182AEA5AF965464B6C77BCC47</code> <code>C2042D4D1A8D6E00F52568D51B30088C</code> <code>123C0C25A956A59C8D3587EA9A0B8C1E</code> <code>814675874C1D928E0A92A06ECF5BEC44</code> <code>C2538D05A1D6DC87BB7248C8DD8A86B0</code> <code>685B75ACB479A4A9BCDB51A79DD5AAF5</code> <code>516469A52A4793A277C39B08D8FB5C55</code> <code>58EB38445E78CDFFC3418FA5BC6D3F22</code> <code>E675EF65A19D4C34F80D11CF45906EAB</code> <code>4B4D4E9412976789DD905199403AC586</code> <code>A3F2580F7F9EBC86F91B78F8E75B0A89</code> <code>A65E71EB90F4D79AFAB7CF44B1C99316</code> <code>2F38E1D76EEA1620E5294BA9FBA3266A</code> <code>58C8D292E82E6DE7DAD3064D0C70EB8E</code> <code>ADB98023B783AFBD11CEAD103F31998E</code> <code>43DB2704F892ACEA10080B026ACB1217</code> <code>90D4AAE74A9519BB9F1F5CBA8F55DBA2</code> <code>9057FA224176BBD96F4B8F0A8E989A5A</code> <code>3B4D9F5B3970F934D20AE93989FE13B0</code> <code>E4871706B50EC9B761389FD02565E2C8</code> <code>493969903D13A7F83A7C0E695F69767A</code> <code>E091C4100E5045846FB8CDFD856A4DA3</code> <code>DDDF8F5E9009DC1DF0C9F2436A77067F</code> <code>56A1D2C004E397C3153CCA8BE1A36E29</code><br> <code>DD8DFAAB</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = F103E34D576316DC3A7E0030865ED04FA629839612B95ED378F8BBA2F76A071BD1F0E751C57441EDF51EC1963F9C8869EF96F15878B12D3A1A67C94EB2DFD6A2D7C0A08990F1EFC7609AEC681275326F1681CDF57F90F1DE610C79311C4CEC4D0775D3394B3F8BBD47F50EF10DA9A336389A259E6AF9CAD02683AE29245752F088081D1F7949698651E759E1EFF974E4FF3A21AAF3E73C92E2CF7CFBF2460DED2D83B1A6A7AC31C8D093F1FA4E19220359CA59395FEF939DC3DDD548C3CE9EF68AFD99488A7034CC0FCE55C7F16239C182AEA5AF965464B6C77BCC47C2042D4D1A8D6E00F52568D51B30088C123C0C25A956A59C8D3587EA9A0B8C1E814675874C1D928E0A92A06ECF5BEC44C2538D05A1D6DC87BB7248C8DD8A86B0685B75ACB479A4A9BCDB51A79DD5AAF5516469A52A4793A277C39B08D8FB5C5558EB38445E78CDFFC3418FA5BC6D3F22E675EF65A19D4C34F80D11CF45906EAB4B4D4E9412976789DD905199403AC586A3F2580F7F9EBC86F91B78F8E75B0A89A65E71EB90F4D79AFAB7CF44B1C993162F38E1D76EEA1620E5294BA9FBA3266A58C8D292E82E6DE7DAD3064D0C70EB8EADB98023B783AFBD11CEAD103F31998E43DB2704F892ACEA10080B026ACB121790D4AAE74A9519BB9F1F5CBA8F55DBA29057FA224176BBD96F4B8F0A8E989A5A3B4D9F5B3970F934D20AE93989FE13B0E4871706B50EC9B761389FD02565E2C8493969903D13A7F83A7C0E695F69767AE091C4100E5045846FB8CDFD856A4DA3DDDF8F5E9009DC1DF0C9F2436A77067F56A1D2C004E397C3153CCA8BE1A36E29DD8DFAAB
tmp_aes_key = 1FFFA9B5D7E45DB6209F9E01E4696BF605CADC0FDDE85B3DBE7DA3D1340F6FFC
tmp_aes_iv = 775604724F7BA654671797DB82CF137216DA2B7B0508157953386F9E873CC612</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = C1E648CED14AFB4B06CAC0DBF81C193BCF7E9AA9BA0D89B598347C4520EBE0DADBF9DEF587F63A189A9188402068F23191D90CC3313CFED203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010045BE02C3DFE09F63C4761C2224C02BE4A07B1CC2B3A17019999A8893C2A190D7802D4E1D4BEBC4858B2D37DC9BADD9402F9AA494C22F989A237DFBCF523EB79A4870E81D33A134A0108E3A156834951EE4E29F08F35669B0B8DD7228803C601619013CA0A424A036DD4F5405BEFDEC63344567CA13CA3E293881E38F611D02207899E2CBCB37A07DD5463ED93D21DE6098F73D57B4865CE58489D4EB4391AF9195AB08CF724BFD5B6CC9331E43D88DE8C2D3F8356AEF78F7BD369298F5DADF01B9749479D8594B10E408A5DB3C54809B02F4347238A20CF74EFF8D2A4973F70521EB3020A4DAE9881A6D0ECE7F73E9079BB77D095EFBC41872427500C26C2748D67CAE663C396F053C33D658
answer = BA0D89B598347C4520EBE0DADBF9DEF587F63A189A9188402068F23191D90CC3313CFED203000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010045BE02C3DFE09F63C4761C2224C02BE4A07B1CC2B3A17019999A8893C2A190D7802D4E1D4BEBC4858B2D37DC9BADD9402F9AA494C22F989A237DFBCF523EB79A4870E81D33A134A0108E3A156834951EE4E29F08F35669B0B8DD7228803C601619013CA0A424A036DD4F5405BEFDEC63344567CA13CA3E293881E38F611D02207899E2CBCB37A07DD5463ED93D21DE6098F73D57B4865CE58489D4EB4391AF9195AB08CF724BFD5B6CC9331E43D88DE8C2D3F8356AEF78F7BD369298F5DADF01B9749479D8594B10E408A5DB3C54809B02F4347238A20CF74EFF8D2A4973F70521EB3020A4DAE9881A6D0ECE7F73E9079BB77D095EFBC41872427500C26C2748D67CAE663C396F053C33D658</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 98 34 7C 45 20 EB E0 DA DB F9 DE F5
0010 | 87 F6 3A 18 9A 91 88 40 20 68 F2 31 91 D9 0C C3
0020 | 31 3C FE D2 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 45 BE 02 C3 DF E0 9F 63 C4 76 1C 22 24 C0 2B E4
0140 | A0 7B 1C C2 B3 A1 70 19 99 9A 88 93 C2 A1 90 D7
0150 | 80 2D 4E 1D 4B EB C4 85 8B 2D 37 DC 9B AD D9 40
0160 | 2F 9A A4 94 C2 2F 98 9A 23 7D FB CF 52 3E B7 9A
0170 | 48 70 E8 1D 33 A1 34 A0 10 8E 3A 15 68 34 95 1E
0180 | E4 E2 9F 08 F3 56 69 B0 B8 DD 72 28 80 3C 60 16
0190 | 19 01 3C A0 A4 24 A0 36 DD 4F 54 05 BE FD EC 63
01A0 | 34 45 67 CA 13 CA 3E 29 38 81 E3 8F 61 1D 02 20
01B0 | 78 99 E2 CB CB 37 A0 7D D5 46 3E D9 3D 21 DE 60
01C0 | 98 F7 3D 57 B4 86 5C E5 84 89 D4 EB 43 91 AF 91
01D0 | 95 AB 08 CF 72 4B FD 5B 6C C9 33 1E 43 D8 8D E8
01E0 | C2 D3 F8 35 6A EF 78 F7 BD 36 92 98 F5 DA DF 01
01F0 | B9 74 94 79 D8 59 4B 10 E4 08 A5 DB 3C 54 80 9B
0200 | 02 F4 34 72 38 A2 0C F7 4E FF 8D 2A 49 73 F7 05
0210 | 21 EB 30 20 A4 DA E9 88 1A 6D 0E CE 7F 73 E9 07
0220 | 9B B7 7D 09 5E FB C4 18 72 42 75 00 C2 6C 27 48
0230 | D6 7C AE 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010045BE02C3DFE09F63C4761C22</code> <code>24C02BE4A07B1CC2B3A17019999A8893</code> <code>C2A190D7802D4E1D4BEBC4858B2D37DC</code> <code>9BADD9402F9AA494C22F989A237DFBCF</code> <code>523EB79A4870E81D33A134A0108E3A15</code> <code>6834951EE4E29F08F35669B0B8DD7228</code> <code>803C601619013CA0A424A036DD4F5405</code> <code>BEFDEC63344567CA13CA3E293881E38F</code> <code>611D02207899E2CBCB37A07DD5463ED9</code> <code>3D21DE6098F73D57B4865CE58489D4EB</code> <code>4391AF9195AB08CF724BFD5B6CC9331E</code> <code>43D88DE8C2D3F8356AEF78F7BD369298</code> <code>F5DADF01B9749479D8594B10E408A5DB</code> <code>3C54809B02F4347238A20CF74EFF8D2A</code> <code>4973F70521EB3020A4DAE9881A6D0ECE</code> <code>7F73E9079BB77D095EFBC41872427500</code><br> <code>C26C2748</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>D67CAE66</code> (1722711254 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 488B742194B2B37D45C22916124ECF11D98311BA876C50A69433BA0D3A023359BD840D58389EBF223C79097926869213F2715226FD2484B239A3C3D8E6BE303614D9AC3707608747DE436A38F7BAC04AD4D3BFDE63798BE03DF41FF18118D72DB74FBEB7D799E30022D3581454B7AD46822EFF3B32A41690947189FC2B0AC9E1FA76873C2EE87D092192D06320230B11596959A4E71AD220048A56DA3F2BEF566E2EF1F0F11A89B107279269254769BC54C45E7CED7490AED498F2EABEF7769599960503D4F2AE93B288ED991E3F5780F83F8C985CC18CBC73EA431FD3414C4AFBBEF63B1863B61CCB69D2C9F18E780BDACDE059CBC9C9557C7CD029B01ED3E5</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 55AEDE83E23F21E7F3E81526E01C2C64FBD8A8C1A9951E828E262226F8B3A81A28C68943F7285BDA3DAC6AC1533283F0BCA77BE945F2F36067CFAA287B67C2B68659CC7543B0601BDA60DA0CF95BC29AD1CA01CD023B69C13DC5D733A741B1E904BEB8F78277B91771F31526E9F2D4A01B41671038E00AF59046F8FFB204DA1AB6878D13B6FCBF91F6D0E9A47320CF9096E46EBA132DB37D2DFC8A36B45317C125D947A526097CB810E69398F918C50F6589C5FEF815ACC28D4127F9D6A1FF767E9108D7B60D5C6E6D68C2A270E2747D7DD35295BD477B4ACFA0BAE3E4CA3E62F3292626EEC7F645F816279C645BC75F704F9EED4DADC05AD2ED7E98D24D88E1</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 98 34 7C 45 20 EB E0 DA DB F9 DE F5
0010 | 87 F6 3A 18 9A 91 88 40 20 68 F2 31 91 D9 0C C3
0020 | 31 3C FE D2 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 55 AE DE 83 E2 3F 21 E7 F3 E8 15 26 E0 1C 2C 64
0040 | FB D8 A8 C1 A9 95 1E 82 8E 26 22 26 F8 B3 A8 1A
0050 | 28 C6 89 43 F7 28 5B DA 3D AC 6A C1 53 32 83 F0
0060 | BC A7 7B E9 45 F2 F3 60 67 CF AA 28 7B 67 C2 B6
0070 | 86 59 CC 75 43 B0 60 1B DA 60 DA 0C F9 5B C2 9A
0080 | D1 CA 01 CD 02 3B 69 C1 3D C5 D7 33 A7 41 B1 E9
0090 | 04 BE B8 F7 82 77 B9 17 71 F3 15 26 E9 F2 D4 A0
00A0 | 1B 41 67 10 38 E0 0A F5 90 46 F8 FF B2 04 DA 1A
00B0 | B6 87 8D 13 B6 FC BF 91 F6 D0 E9 A4 73 20 CF 90
00C0 | 96 E4 6E BA 13 2D B3 7D 2D FC 8A 36 B4 53 17 C1
00D0 | 25 D9 47 A5 26 09 7C B8 10 E6 93 98 F9 18 C5 0F
00E0 | 65 89 C5 FE F8 15 AC C2 8D 41 27 F9 D6 A1 FF 76
00F0 | 7E 91 08 D7 B6 0D 5C 6E 6D 68 C2 A2 70 E2 74 7D
0100 | 7D D3 52 95 BD 47 7B 4A CF A0 BA E3 E4 CA 3E 62
0110 | F3 29 26 26 EE C7 F6 45 F8 16 27 9C 64 5B C7 5F
0120 | 70 4F 9E ED 4D AD C0 5A D2 ED 7E 98 D2 4D 88 E1</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010055AEDE83E23F21E7F3E81526</code> <code>E01C2C64FBD8A8C1A9951E828E262226</code> <code>F8B3A81A28C68943F7285BDA3DAC6AC1</code> <code>533283F0BCA77BE945F2F36067CFAA28</code> <code>7B67C2B68659CC7543B0601BDA60DA0C</code> <code>F95BC29AD1CA01CD023B69C13DC5D733</code> <code>A741B1E904BEB8F78277B91771F31526</code> <code>E9F2D4A01B41671038E00AF59046F8FF</code> <code>B204DA1AB6878D13B6FCBF91F6D0E9A4</code> <code>7320CF9096E46EBA132DB37D2DFC8A36</code> <code>B45317C125D947A526097CB810E69398</code> <code>F918C50F6589C5FEF815ACC28D4127F9</code> <code>D6A1FF767E9108D7B60D5C6E6D68C2A2</code> <code>70E2747D7DD35295BD477B4ACFA0BAE3</code> <code>E4CA3E62F3292626EEC7F645F816279C</code> <code>645BC75F704F9EED4DADC05AD2ED7E98</code><br> <code>D24D88E1</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436698347C4520EBE0DADBF9DEF587F63A189A9188402068F23191D90CC3313CFED20000000000000000FE00010055AEDE83E23F21E7F3E81526E01C2C64FBD8A8C1A9951E828E262226F8B3A81A28C68943F7285BDA3DAC6AC1533283F0BCA77BE945F2F36067CFAA287B67C2B68659CC7543B0601BDA60DA0CF95BC29AD1CA01CD023B69C13DC5D733A741B1E904BEB8F78277B91771F31526E9F2D4A01B41671038E00AF59046F8FFB204DA1AB6878D13B6FCBF91F6D0E9A47320CF9096E46EBA132DB37D2DFC8A36B45317C125D947A526097CB810E69398F918C50F6589C5FEF815ACC28D4127F9D6A1FF767E9108D7B60D5C6E6D68C2A270E2747D7DD35295BD477B4ACFA0BAE3E4CA3E62F3292626EEC7F645F816279C645BC75F704F9EED4DADC05AD2ED7E98D24D88E1
padding = 2083F51E9B7D408A67C913FF
tmp_aes_key = 1FFFA9B5D7E45DB6209F9E01E4696BF605CADC0FDDE85B3DBE7DA3D1340F6FFC
tmp_aes_iv = 775604724F7BA654671797DB82CF137216DA2B7B0508157953386F9E873CC612</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = F7AF24E1D13FA6C6A7FB383972A7CB419E05A4349D5EA125D1AC2BB311030FD3883BAFEF646F8149CC5611B85F1492343F6CC01E9F793B766A995C174C92D49938F9D555087A46E16FBB45B521C75B6E6288D1ED2FA4BAFAF3B094FC59EBB154E6EB42AA9C615F6450F2B2A60EE4C7908435EC3ABC18422841B5D3CEDA9CDFF0192D7B8D7FCB29A8906E1158C85C72C3CD3DB849891C1BDBAB2649B9AA330487B6CA144E99E591D3063D886C0AADDEF67845E9D9EC78A4968405E86C1EAE292B41FC07797DDC98669893A234329B365603FEB638DD879C7A610FF54F053B8218CB95FC184D512339CEA169E1D835BB1D477CACEB89C5DCF9F09A4CE17535BA8255E4E6EB2B62A6E84C48F5B9F9E7DC81A4A9A1ACBC427EC5823A7FBA2ACB9939D1230A5E1135ABC6886B3EFEE09F0467ECA2E6E3B97F622121C1A7552EE955D873BD8DAA8B3C13F60764768BA9550853</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 18 15 0C 00 D6 7C AE 66
0010 | 78 01 00 00 1F 5F 04 F5 98 34 7C 45 20 EB E0 DA
0020 | DB F9 DE F5 87 F6 3A 18 9A 91 88 40 20 68 F2 31
0030 | 91 D9 0C C3 31 3C FE D2 FE 50 01 00 F7 AF 24 E1
0040 | D1 3F A6 C6 A7 FB 38 39 72 A7 CB 41 9E 05 A4 34
0050 | 9D 5E A1 25 D1 AC 2B B3 11 03 0F D3 88 3B AF EF
0060 | 64 6F 81 49 CC 56 11 B8 5F 14 92 34 3F 6C C0 1E
0070 | 9F 79 3B 76 6A 99 5C 17 4C 92 D4 99 38 F9 D5 55
0080 | 08 7A 46 E1 6F BB 45 B5 21 C7 5B 6E 62 88 D1 ED
0090 | 2F A4 BA FA F3 B0 94 FC 59 EB B1 54 E6 EB 42 AA
00A0 | 9C 61 5F 64 50 F2 B2 A6 0E E4 C7 90 84 35 EC 3A
00B0 | BC 18 42 28 41 B5 D3 CE DA 9C DF F0 19 2D 7B 8D
00C0 | 7F CB 29 A8 90 6E 11 58 C8 5C 72 C3 CD 3D B8 49
00D0 | 89 1C 1B DB AB 26 49 B9 AA 33 04 87 B6 CA 14 4E
00E0 | 99 E5 91 D3 06 3D 88 6C 0A AD DE F6 78 45 E9 D9
00F0 | EC 78 A4 96 84 05 E8 6C 1E AE 29 2B 41 FC 07 79
0100 | 7D DC 98 66 98 93 A2 34 32 9B 36 56 03 FE B6 38
0110 | DD 87 9C 7A 61 0F F5 4F 05 3B 82 18 CB 95 FC 18
0120 | 4D 51 23 39 CE A1 69 E1 D8 35 BB 1D 47 7C AC EB
0130 | 89 C5 DC F9 F0 9A 4C E1 75 35 BA 82 55 E4 E6 EB
0140 | 2B 62 A6 E8 4C 48 F5 B9 F9 E7 DC 81 A4 A9 A1 AC
0150 | BC 42 7E C5 82 3A 7F BA 2A CB 99 39 D1 23 0A 5E
0160 | 11 35 AB C6 88 6B 3E FE E0 9F 04 67 EC A2 E6 E3
0170 | B9 7F 62 21 21 C1 A7 55 2E E9 55 D8 73 BD 8D AA
0180 | 8B 3C 13 F6 07 64 76 8B A9 55 08 53</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>18150C00D67CAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100F7AF24E1D13FA6C6A7FB3839</code> <code>72A7CB419E05A4349D5EA125D1AC2BB3</code> <code>11030FD3883BAFEF646F8149CC5611B8</code> <code>5F1492343F6CC01E9F793B766A995C17</code> <code>4C92D49938F9D555087A46E16FBB45B5</code> <code>21C75B6E6288D1ED2FA4BAFAF3B094FC</code> <code>59EBB154E6EB42AA9C615F6450F2B2A6</code> <code>0EE4C7908435EC3ABC18422841B5D3CE</code> <code>DA9CDFF0192D7B8D7FCB29A8906E1158</code> <code>C85C72C3CD3DB849891C1BDBAB2649B9</code> <code>AA330487B6CA144E99E591D3063D886C</code> <code>0AADDEF67845E9D9EC78A4968405E86C</code> <code>1EAE292B41FC07797DDC98669893A234</code> <code>329B365603FEB638DD879C7A610FF54F</code> <code>053B8218CB95FC184D512339CEA169E1</code> <code>D835BB1D477CACEB89C5DCF9F09A4CE1</code> <code>7535BA8255E4E6EB2B62A6E84C48F5B9</code> <code>F9E7DC81A4A9A1ACBC427EC5823A7FBA</code> <code>2ACB9939D1230A5E1135ABC6886B3EFE</code> <code>E09F0467ECA2E6E3B97F622121C1A755</code> <code>2EE955D873BD8DAA8B3C13F60764768B</code><br> <code>A9550853</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 672CE08166CEE9DB5C45EDB97C9721FE361698F28EBE9DDC0DA6E270E6C61DF56C7E0FD5A09CB06754AC7305B3E151020DC4DBC5D4012BE2A4A9C891A0E742D0F6B61C873C77554B3FAC552CCFF51FBCF15F6ADA8EA08D7B4550392A29473408415D0773F8D35351CC636DA33141BA14AA1B78EE06CCFCA023354113B266D88CC7A0067C1465E16E52E7EAFC88E0F37F31FFE966AAD255F12D2D26E678F59B6F37A242C2C939B03E76760DC6B667ABB235031A38B1213935F5C67DBC5C6AF372B860ADE71334B04043373D9054DB14D2C45ED29E3D12CED9D3D239A4851C179AB86BC6C86791630176322E0D17B0EB826095CB51DE03B7E214F45E689DD4291F</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 90 0E 24 D7 7C AE 66
0010 | A8 00 00 00 34 F7 CB 3B 98 34 7C 45 20 EB E0 DA
0020 | DB F9 DE F5 87 F6 3A 18 9A 91 88 40 20 68 F2 31
0030 | 91 D9 0C C3 31 3C FE D2 2A B7 BC 7D 2D 87 D7 B8
0040 | 9D 96 2F 86 77 36 53 88</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01900E24D77CAE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A8000000</code> (168 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>98347C4520EBE0DADBF9DEF587F63A18</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9A9188402068F23191D90CC3313CFED2</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>2AB7BC7D2D87D7B89D962F8677365388</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

