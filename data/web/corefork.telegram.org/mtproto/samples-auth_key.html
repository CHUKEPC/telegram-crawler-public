<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 51 09 00 7C AF 5E 67
0010 | 14 00 00 00 F1 8E 7E BE 3A 7B 5A FB 77 0C F2 72
0020 | C5 A9 01 FB 02 5E B7 86</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>445109007CAF5E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D0 9D 31 7C AF 5E 67
0010 | 50 00 00 00 63 24 16 05 3A 7B 5A FB 77 0C F2 72
0020 | C5 A9 01 FB 02 5E B7 86 6E A6 15 ED 42 09 C6 F9
0030 | C8 AF 56 CE 98 3E 2F 71 08 16 3C 28 68 EF 68 11
0040 | C9 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D09D317CAF5E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08163C2868EF6811C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1602199998595338697</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1602199998595338697</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1602199998595338697 = 1045815431 * 1532010287</code></p>
<pre><code>p = 1045815431
q = 1532010287</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 16 3C 28 68 EF 68 11 C9 00 00 00
0010 | 04 3E 55 E0 87 00 00 00 04 5B 50 9F 2F 00 00 00
0020 | 3A 7B 5A FB 77 0C F2 72 C5 A9 01 FB 02 5E B7 86
0030 | 6E A6 15 ED 42 09 C6 F9 C8 AF 56 CE 98 3E 2F 71
0040 | FD 16 13 D9 9D 69 DC 9B EF 0D 16 D5 A0 7C 6F 77
0050 | AB 84 AB F0 B1 D8 4B 5D 8B 9A C7 30 42 83 86 D0
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08163C2868EF6811C9000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1602199998595338697</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043E55E087000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1045815431</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045B509F2F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1532010287</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>FD1613D99D69DC9BEF0D16D5A07C6F77</code> <code>AB84ABF0B1D84B5D8B9AC730428386D0</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908163C2868EF6811C9000000043E55E087000000045B509F2F0000003A7B5AFB770CF272C5A901FB025EB7866EA615ED4209C6F9C8AF56CE983E2F71FD1613D99D69DC9BEF0D16D5A07C6F77AB84ABF0B1D84B5D8B9AC730428386D002000000
random_padding_bytes = 6825804BF23319427C2C84F22957F76FC7B7D284F38DFCA733BC0020405A13648EAAFDBF873099A33FC74C6B95FCC25714A6126B977B37119E7C839F6B81E113BD9C2174850C08D5A21414006365CCA9F73B5A3364F868D9492F610C</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A75B2612A3C14596589B2CD600BDFF332B966229D44206B563B57D7B15B029F83870ADFCF2C813AB18149B5F4631676301156029A4B31BB4A83B554586D0590B5CA78026E3B301A2D06D33516BDE71CFE002CE4B35F602445DA8FFB2DEBE3656F22104D4073C9263A9E75941872EABE0749749116383454FA11E2C111B70A6F74673B3C3050C5101F652C9EA7067C43746995FA3DF7673E5DF085694B1F50B18070984D5CC4B94C69378C89019843E9587A4335EF0AD60365C5C20F9E071553AEAFAB2341DFD1F14CB14F4D1271FD0757428D7386E26293F8C066F58979949A2D6BB8F23F3ABD23A94A218F3FE5ADE7A97B63E7C01906E3C667D694FF117572F</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 30 C4 09 00 7C AF 5E 67
0010 | 40 01 00 00 BE E4 12 D7 3A 7B 5A FB 77 0C F2 72
0020 | C5 A9 01 FB 02 5E B7 86 6E A6 15 ED 42 09 C6 F9
0030 | C8 AF 56 CE 98 3E 2F 71 04 3E 55 E0 87 00 00 00
0040 | 04 5B 50 9F 2F 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A7 5B 26 12 A3 C1 45 96 58 9B 2C D6
0060 | 00 BD FF 33 2B 96 62 29 D4 42 06 B5 63 B5 7D 7B
0070 | 15 B0 29 F8 38 70 AD FC F2 C8 13 AB 18 14 9B 5F
0080 | 46 31 67 63 01 15 60 29 A4 B3 1B B4 A8 3B 55 45
0090 | 86 D0 59 0B 5C A7 80 26 E3 B3 01 A2 D0 6D 33 51
00A0 | 6B DE 71 CF E0 02 CE 4B 35 F6 02 44 5D A8 FF B2
00B0 | DE BE 36 56 F2 21 04 D4 07 3C 92 63 A9 E7 59 41
00C0 | 87 2E AB E0 74 97 49 11 63 83 45 4F A1 1E 2C 11
00D0 | 1B 70 A6 F7 46 73 B3 C3 05 0C 51 01 F6 52 C9 EA
00E0 | 70 67 C4 37 46 99 5F A3 DF 76 73 E5 DF 08 56 94
00F0 | B1 F5 0B 18 07 09 84 D5 CC 4B 94 C6 93 78 C8 90
0100 | 19 84 3E 95 87 A4 33 5E F0 AD 60 36 5C 5C 20 F9
0110 | E0 71 55 3A EA FA B2 34 1D FD 1F 14 CB 14 F4 D1
0120 | 27 1F D0 75 74 28 D7 38 6E 26 29 3F 8C 06 6F 58
0130 | 97 99 49 A2 D6 BB 8F 23 F3 AB D2 3A 94 A2 18 F3
0140 | FE 5A DE 7A 97 B6 3E 7C 01 90 6E 3C 66 7D 69 4F
0150 | F1 17 57 2F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>30C409007CAF5E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043E55E087000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1045815431</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045B509F2F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1532010287</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A75B2612A3C14596589B2CD6</code> <code>00BDFF332B966229D44206B563B57D7B</code> <code>15B029F83870ADFCF2C813AB18149B5F</code> <code>4631676301156029A4B31BB4A83B5545</code> <code>86D0590B5CA78026E3B301A2D06D3351</code> <code>6BDE71CFE002CE4B35F602445DA8FFB2</code> <code>DEBE3656F22104D4073C9263A9E75941</code> <code>872EABE0749749116383454FA11E2C11</code> <code>1B70A6F74673B3C3050C5101F652C9EA</code> <code>7067C43746995FA3DF7673E5DF085694</code> <code>B1F50B18070984D5CC4B94C69378C890</code> <code>19843E9587A4335EF0AD60365C5C20F9</code> <code>E071553AEAFAB2341DFD1F14CB14F4D1</code> <code>271FD0757428D7386E26293F8C066F58</code> <code>979949A2D6BB8F23F3ABD23A94A218F3</code> <code>FE5ADE7A97B63E7C01906E3C667D694F</code><br> <code>F117572F</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 8F 51 7C AF 5E 67
0010 | 78 02 00 00 5C 07 E8 D0 3A 7B 5A FB 77 0C F2 72
0020 | C5 A9 01 FB 02 5E B7 86 6E A6 15 ED 42 09 C6 F9
0030 | C8 AF 56 CE 98 3E 2F 71 FE 50 02 00 3C ED 1B 6C
0040 | 92 9E 96 AE 93 24 45 60 14 66 70 DD C0 B2 FE 0C
0050 | 75 3A EC 96 16 10 8C 7C 56 33 2C 19 90 3C 54 4C
0060 | 5F 4A 89 56 69 86 3C 7B 3C 22 6E 9E BB 2C 58 97
0070 | 8C 17 4A 4A 29 AE 1C 35 6D FB E5 60 6C C3 29 67
0080 | 65 2A C6 56 2A 09 B7 4F D4 70 53 AF 0A 8C E0 62
0090 | 70 29 83 69 CB 3E 3F 30 B4 04 80 F7 B9 E8 1A FE
00A0 | 35 93 B4 24 42 FF 42 B5 68 13 5E 7B 81 33 E4 65
00B0 | F6 16 36 E5 1E 8E C6 94 87 89 39 EB 9F 43 AE 99
00C0 | 85 8C 5C 7F 8E F0 09 41 D0 A7 EE FA D1 06 58 0F
00D0 | 9F 03 13 3D 2C 58 7C 8E AA D8 4A 1B D8 1F E6 9C
00E0 | 93 01 06 AB A2 58 57 0A 15 25 BE 59 26 D7 F5 30
00F0 | 0C 21 FB B2 12 9E 85 6A 65 F1 52 26 DF 2A 57 BD
0100 | 50 2F 98 0E 3D DD 1D 9C F3 F0 45 2D A5 D1 15 1D
0110 | 11 C1 C9 81 28 C2 22 98 CA E6 02 2D 75 20 B8 39
0120 | F7 25 BA BB 1F 4B CC 05 5D 3F 2C 64 66 1B 11 DF
0130 | 10 D9 B2 D2 A9 23 69 34 9D 53 A7 25 78 35 3E B8
0140 | 31 36 21 C4 E5 ED 27 C1 8C 73 5D C6 7A 72 C2 B0
0150 | D6 65 54 CA 5E E8 6B 96 EF 61 35 82 88 0D AB 89
0160 | 1A 33 26 88 30 9C C1 A1 35 AA 84 A8 52 78 5B 7D
0170 | 13 88 9C 8D 63 ED E6 37 74 88 F0 C2 D3 2D B5 F5
0180 | CF E9 09 9F 69 CF 36 16 BE 08 2E 3A 61 88 F4 85
0190 | A3 82 DA 2E 81 26 F6 54 52 9E 01 D2 CD 63 57 DF
01A0 | 96 54 96 46 64 C0 DE 5C EF 42 9A C1 3A 80 F6 D2
01B0 | 99 4C BF C5 CA 32 78 81 A3 07 07 4C FE 08 14 60
01C0 | D0 13 9A 04 6D 40 47 6A 89 71 40 71 FA 85 DE 3B
01D0 | 75 F2 C3 34 70 C7 57 51 ED 07 B4 07 67 0B CA DC
01E0 | 27 44 A9 A1 70 DB 9F 00 79 52 D7 A5 4F 6B 52 2F
01F0 | 3A D6 EC 8E 8A D0 20 33 46 FC 6B B0 B8 7D 7A 4E
0200 | BC 44 9D 75 A7 7A 22 8E 0B 17 FE FD B4 21 82 13
0210 | DB BB 5E B2 16 8E C1 69 10 F4 CB 9E 3E 05 A4 80
0220 | 46 2B 76 C9 0C B8 4A 32 3F F9 9E A1 30 CA 8C 18
0230 | 2D 1F 59 A8 5A 1A 9C FD C5 76 8A 3B 53 47 2A E0
0240 | 8F 5B D9 6E C0 9C 91 8E 89 E9 EB 0E D5 67 CA 00
0250 | 32 D3 D5 43 F3 23 43 14 94 E7 89 E8 8A D8 F3 AD
0260 | 60 7C 42 8E 9D 19 30 9A 0F 1C 4C 28 BE 60 BD 9F
0270 | 29 F6 DA 58 F7 E5 1B 9C 6E EC B0 26 45 C8 7E C6
0280 | F9 00 19 06 FE 40 57 77 66 B2 97 B8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B48F517CAF5E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002003CED1B6C929E96AE93244560</code> <code>146670DDC0B2FE0C753AEC9616108C7C</code> <code>56332C19903C544C5F4A895669863C7B</code> <code>3C226E9EBB2C58978C174A4A29AE1C35</code> <code>6DFBE5606CC32967652AC6562A09B74F</code> <code>D47053AF0A8CE06270298369CB3E3F30</code> <code>B40480F7B9E81AFE3593B42442FF42B5</code> <code>68135E7B8133E465F61636E51E8EC694</code> <code>878939EB9F43AE99858C5C7F8EF00941</code> <code>D0A7EEFAD106580F9F03133D2C587C8E</code> <code>AAD84A1BD81FE69C930106ABA258570A</code> <code>1525BE5926D7F5300C21FBB2129E856A</code> <code>65F15226DF2A57BD502F980E3DDD1D9C</code> <code>F3F0452DA5D1151D11C1C98128C22298</code> <code>CAE6022D7520B839F725BABB1F4BCC05</code> <code>5D3F2C64661B11DF10D9B2D2A9236934</code> <code>9D53A72578353EB8313621C4E5ED27C1</code> <code>8C735DC67A72C2B0D66554CA5EE86B96</code> <code>EF613582880DAB891A332688309CC1A1</code> <code>35AA84A852785B7D13889C8D63EDE637</code> <code>7488F0C2D32DB5F5CFE9099F69CF3616</code> <code>BE082E3A6188F485A382DA2E8126F654</code> <code>529E01D2CD6357DF9654964664C0DE5C</code> <code>EF429AC13A80F6D2994CBFC5CA327881</code> <code>A307074CFE081460D0139A046D40476A</code> <code>89714071FA85DE3B75F2C33470C75751</code> <code>ED07B407670BCADC2744A9A170DB9F00</code> <code>7952D7A54F6B522F3AD6EC8E8AD02033</code> <code>46FC6BB0B87D7A4EBC449D75A77A228E</code> <code>0B17FEFDB4218213DBBB5EB2168EC169</code> <code>10F4CB9E3E05A480462B76C90CB84A32</code> <code>3FF99EA130CA8C182D1F59A85A1A9CFD</code> <code>C5768A3B53472AE08F5BD96EC09C918E</code> <code>89E9EB0ED567CA0032D3D543F3234314</code> <code>94E789E88AD8F3AD607C428E9D19309A</code> <code>0F1C4C28BE60BD9F29F6DA58F7E51B9C</code> <code>6EECB02645C87EC6F9001906FE405777</code><br> <code>66B297B8</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 3CED1B6C929E96AE93244560146670DDC0B2FE0C753AEC9616108C7C56332C19903C544C5F4A895669863C7B3C226E9EBB2C58978C174A4A29AE1C356DFBE5606CC32967652AC6562A09B74FD47053AF0A8CE06270298369CB3E3F30B40480F7B9E81AFE3593B42442FF42B568135E7B8133E465F61636E51E8EC694878939EB9F43AE99858C5C7F8EF00941D0A7EEFAD106580F9F03133D2C587C8EAAD84A1BD81FE69C930106ABA258570A1525BE5926D7F5300C21FBB2129E856A65F15226DF2A57BD502F980E3DDD1D9CF3F0452DA5D1151D11C1C98128C22298CAE6022D7520B839F725BABB1F4BCC055D3F2C64661B11DF10D9B2D2A92369349D53A72578353EB8313621C4E5ED27C18C735DC67A72C2B0D66554CA5EE86B96EF613582880DAB891A332688309CC1A135AA84A852785B7D13889C8D63EDE6377488F0C2D32DB5F5CFE9099F69CF3616BE082E3A6188F485A382DA2E8126F654529E01D2CD6357DF9654964664C0DE5CEF429AC13A80F6D2994CBFC5CA327881A307074CFE081460D0139A046D40476A89714071FA85DE3B75F2C33470C75751ED07B407670BCADC2744A9A170DB9F007952D7A54F6B522F3AD6EC8E8AD0203346FC6BB0B87D7A4EBC449D75A77A228E0B17FEFDB4218213DBBB5EB2168EC16910F4CB9E3E05A480462B76C90CB84A323FF99EA130CA8C182D1F59A85A1A9CFDC5768A3B53472AE08F5BD96EC09C918E89E9EB0ED567CA0032D3D543F323431494E789E88AD8F3AD607C428E9D19309A0F1C4C28BE60BD9F29F6DA58F7E51B9C6EECB02645C87EC6F9001906FE40577766B297B8
tmp_aes_key = 2CE2B3E63FFF9DA314C14CA55094FD111CCD8C1AE1AACB7476DE9FFB23BDF1ED
tmp_aes_iv = F393DD5C55454CFD76237359AC84DD75B2A710BA004172D270B778F4FD1613D9</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = B90B851786A6982FD684B03183C25336D7D8780EBA0D89B53A7B5AFB770CF272C5A901FB025EB7866EA615ED4209C6F9C8AF56CE983E2F7103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007FFCDEC11F03F6A4D525C7EF1FF5CB81E30D12CA387411BD2F5FEEF5A87FABF5E23C5AB5018E7B2C8F5939EC1145034EB3E89739A065EC065EB0F89B469D5F63A8350532D11420BA4EA16B2429E06B5C1E61C1A58AE3549644B99EAC5B4E63DC4705C16B6B4A71F1D647F0E70F82FEB599F4DFFCB546A1A3E8D4F58635FAC186724FEA8BD0F804793DF8AE181F2FF703C64E247CB18EE05FD59D02E0451E2638915D114FB3F5803AD7488A5649EE18EAAE2F9646E12BB43D8B2111F1F0CDCBD097EBC04B71419E75CC2FA2F45802149F666BFEF87DA869B416EC5B5373602F0EC65473F370F91960BF0712EA54A36C2530EBD7F9605E5A221D61118012CD4FC97CAF5E6718CF733A9913F41B
answer = BA0D89B53A7B5AFB770CF272C5A901FB025EB7866EA615ED4209C6F9C8AF56CE983E2F7103000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007FFCDEC11F03F6A4D525C7EF1FF5CB81E30D12CA387411BD2F5FEEF5A87FABF5E23C5AB5018E7B2C8F5939EC1145034EB3E89739A065EC065EB0F89B469D5F63A8350532D11420BA4EA16B2429E06B5C1E61C1A58AE3549644B99EAC5B4E63DC4705C16B6B4A71F1D647F0E70F82FEB599F4DFFCB546A1A3E8D4F58635FAC186724FEA8BD0F804793DF8AE181F2FF703C64E247CB18EE05FD59D02E0451E2638915D114FB3F5803AD7488A5649EE18EAAE2F9646E12BB43D8B2111F1F0CDCBD097EBC04B71419E75CC2FA2F45802149F666BFEF87DA869B416EC5B5373602F0EC65473F370F91960BF0712EA54A36C2530EBD7F9605E5A221D61118012CD4FC97CAF5E6718CF733A9913F41B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 3A 7B 5A FB 77 0C F2 72 C5 A9 01 FB
0010 | 02 5E B7 86 6E A6 15 ED 42 09 C6 F9 C8 AF 56 CE
0020 | 98 3E 2F 71 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 7F FC DE C1 1F 03 F6 A4 D5 25 C7 EF 1F F5 CB 81
0140 | E3 0D 12 CA 38 74 11 BD 2F 5F EE F5 A8 7F AB F5
0150 | E2 3C 5A B5 01 8E 7B 2C 8F 59 39 EC 11 45 03 4E
0160 | B3 E8 97 39 A0 65 EC 06 5E B0 F8 9B 46 9D 5F 63
0170 | A8 35 05 32 D1 14 20 BA 4E A1 6B 24 29 E0 6B 5C
0180 | 1E 61 C1 A5 8A E3 54 96 44 B9 9E AC 5B 4E 63 DC
0190 | 47 05 C1 6B 6B 4A 71 F1 D6 47 F0 E7 0F 82 FE B5
01A0 | 99 F4 DF FC B5 46 A1 A3 E8 D4 F5 86 35 FA C1 86
01B0 | 72 4F EA 8B D0 F8 04 79 3D F8 AE 18 1F 2F F7 03
01C0 | C6 4E 24 7C B1 8E E0 5F D5 9D 02 E0 45 1E 26 38
01D0 | 91 5D 11 4F B3 F5 80 3A D7 48 8A 56 49 EE 18 EA
01E0 | AE 2F 96 46 E1 2B B4 3D 8B 21 11 F1 F0 CD CB D0
01F0 | 97 EB C0 4B 71 41 9E 75 CC 2F A2 F4 58 02 14 9F
0200 | 66 6B FE F8 7D A8 69 B4 16 EC 5B 53 73 60 2F 0E
0210 | C6 54 73 F3 70 F9 19 60 BF 07 12 EA 54 A3 6C 25
0220 | 30 EB D7 F9 60 5E 5A 22 1D 61 11 80 12 CD 4F C9
0230 | 7C AF 5E 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007FFCDEC11F03F6A4D525C7EF</code> <code>1FF5CB81E30D12CA387411BD2F5FEEF5</code> <code>A87FABF5E23C5AB5018E7B2C8F5939EC</code> <code>1145034EB3E89739A065EC065EB0F89B</code> <code>469D5F63A8350532D11420BA4EA16B24</code> <code>29E06B5C1E61C1A58AE3549644B99EAC</code> <code>5B4E63DC4705C16B6B4A71F1D647F0E7</code> <code>0F82FEB599F4DFFCB546A1A3E8D4F586</code> <code>35FAC186724FEA8BD0F804793DF8AE18</code> <code>1F2FF703C64E247CB18EE05FD59D02E0</code> <code>451E2638915D114FB3F5803AD7488A56</code> <code>49EE18EAAE2F9646E12BB43D8B2111F1</code> <code>F0CDCBD097EBC04B71419E75CC2FA2F4</code> <code>5802149F666BFEF87DA869B416EC5B53</code> <code>73602F0EC65473F370F91960BF0712EA</code> <code>54A36C2530EBD7F9605E5A221D611180</code><br> <code>12CD4FC9</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>7CAF5E67</code> (1734258556 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 2A292E684F84B9AA9862F3967467C8DA1867F36CB42C2074B21F3D543ECABBB0203C7083E45F9669BF74DDD4C23129184D2BAAE92072C5E7E62042857C212B233CF8AF264B2397B0B8503DBEBBB69EBA55A9DAB8859AA4F53E4129486C4647CA9D0A79D43915D9DC78CA8A91F435E341741F1D72AC20CB91F1D4B288B48A03E3749CAFB35C6EC094B4C99421C8112FBBE51D49226A603F79B756BF6AEC2BBC5E8C73A81C000E348BC9E9D3FD7A365484C95ACE55EF369DB5CA54AF1279CBDC50D03F0F5885456EF867463A47774F5D2E74EF5AA0F2FB10DE03EE161CDF5BC17C5E7B7C45DF3F8D686F268015B8767C02EBF09F20C69D00EC980DD710A96DC01D</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4A870468233A1BA7A7552DA0D3E83FF8421F70EC821B46F5577F6CF7F22CE345C616569387DD9F2881C0232AA796A6DFAB2B212106D6D23B1CF254A14EFB5CC19685E36AF6E151B90232C99523373F7BAE92C6AF8C2517547B10091434E0DE9336310F42DCC5F76838419A23FCCD1F3217771678DBAA59A9933B612D8D85B7E376AB81E56BCC5B1A4B2B12806E29C1A5056C437F2247A6218FC8C9D3450B74621EA5DF30BFAC06C4D429A1B6151692F26A0AA352E6F0F81417AFAC897AA338DF3B94DB40EBB218BEF6C997DB9131EB8ABD7AED21211268A6EAE62CB9A5F98B9B36E7B12E7397247BF3E6887A1E7A6D85B8F76F04C758C8FCF2EE8DAF3F88A6AD</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 3A 7B 5A FB 77 0C F2 72 C5 A9 01 FB
0010 | 02 5E B7 86 6E A6 15 ED 42 09 C6 F9 C8 AF 56 CE
0020 | 98 3E 2F 71 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 4A 87 04 68 23 3A 1B A7 A7 55 2D A0 D3 E8 3F F8
0040 | 42 1F 70 EC 82 1B 46 F5 57 7F 6C F7 F2 2C E3 45
0050 | C6 16 56 93 87 DD 9F 28 81 C0 23 2A A7 96 A6 DF
0060 | AB 2B 21 21 06 D6 D2 3B 1C F2 54 A1 4E FB 5C C1
0070 | 96 85 E3 6A F6 E1 51 B9 02 32 C9 95 23 37 3F 7B
0080 | AE 92 C6 AF 8C 25 17 54 7B 10 09 14 34 E0 DE 93
0090 | 36 31 0F 42 DC C5 F7 68 38 41 9A 23 FC CD 1F 32
00A0 | 17 77 16 78 DB AA 59 A9 93 3B 61 2D 8D 85 B7 E3
00B0 | 76 AB 81 E5 6B CC 5B 1A 4B 2B 12 80 6E 29 C1 A5
00C0 | 05 6C 43 7F 22 47 A6 21 8F C8 C9 D3 45 0B 74 62
00D0 | 1E A5 DF 30 BF AC 06 C4 D4 29 A1 B6 15 16 92 F2
00E0 | 6A 0A A3 52 E6 F0 F8 14 17 AF AC 89 7A A3 38 DF
00F0 | 3B 94 DB 40 EB B2 18 BE F6 C9 97 DB 91 31 EB 8A
0100 | BD 7A ED 21 21 12 68 A6 EA E6 2C B9 A5 F9 8B 9B
0110 | 36 E7 B1 2E 73 97 24 7B F3 E6 88 7A 1E 7A 6D 85
0120 | B8 F7 6F 04 C7 58 C8 FC F2 EE 8D AF 3F 88 A6 AD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004A870468233A1BA7A7552DA0</code> <code>D3E83FF8421F70EC821B46F5577F6CF7</code> <code>F22CE345C616569387DD9F2881C0232A</code> <code>A796A6DFAB2B212106D6D23B1CF254A1</code> <code>4EFB5CC19685E36AF6E151B90232C995</code> <code>23373F7BAE92C6AF8C2517547B100914</code> <code>34E0DE9336310F42DCC5F76838419A23</code> <code>FCCD1F3217771678DBAA59A9933B612D</code> <code>8D85B7E376AB81E56BCC5B1A4B2B1280</code> <code>6E29C1A5056C437F2247A6218FC8C9D3</code> <code>450B74621EA5DF30BFAC06C4D429A1B6</code> <code>151692F26A0AA352E6F0F81417AFAC89</code> <code>7AA338DF3B94DB40EBB218BEF6C997DB</code> <code>9131EB8ABD7AED21211268A6EAE62CB9</code> <code>A5F98B9B36E7B12E7397247BF3E6887A</code> <code>1E7A6D85B8F76F04C758C8FCF2EE8DAF</code><br> <code>3F88A6AD</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643663A7B5AFB770CF272C5A901FB025EB7866EA615ED4209C6F9C8AF56CE983E2F710000000000000000FE0001004A870468233A1BA7A7552DA0D3E83FF8421F70EC821B46F5577F6CF7F22CE345C616569387DD9F2881C0232AA796A6DFAB2B212106D6D23B1CF254A14EFB5CC19685E36AF6E151B90232C99523373F7BAE92C6AF8C2517547B10091434E0DE9336310F42DCC5F76838419A23FCCD1F3217771678DBAA59A9933B612D8D85B7E376AB81E56BCC5B1A4B2B12806E29C1A5056C437F2247A6218FC8C9D3450B74621EA5DF30BFAC06C4D429A1B6151692F26A0AA352E6F0F81417AFAC897AA338DF3B94DB40EBB218BEF6C997DB9131EB8ABD7AED21211268A6EAE62CB9A5F98B9B36E7B12E7397247BF3E6887A1E7A6D85B8F76F04C758C8FCF2EE8DAF3F88A6AD
padding = 3E6C073B570CB7B237A6C31B
tmp_aes_key = 2CE2B3E63FFF9DA314C14CA55094FD111CCD8C1AE1AACB7476DE9FFB23BDF1ED
tmp_aes_iv = F393DD5C55454CFD76237359AC84DD75B2A710BA004172D270B778F4FD1613D9</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 2136BBD3F2F8D78E921F04ED07FFCE5790DE11FEE48DF08A9BB55F3091272340FA64132350FCD933961B81FEB2FC5F97CF1764F8B992DC83C3E20B6D02D8D03FCEDE89A98A07987248356579A893A14BC766B67C93CF6F2F36370E56631F8157F0BA6D73B2A151D1EEAE57E5A01ACEBE2CC0254FD5644795D028ADBF5C22BEB51973BAEDD1B42FCD0E8CC09EFA4385142C791B5752139108B81AFE92E38D87103D70AA9BA3401612C58B641A5136EFEA56DBEBCF1E02492571E2C8AA7C264D406A7177227AAEE36DCAE6FA46CBF2A704B3919B575422D34844E2ACA78EA473D18C75ACE5B7AEB8BC7B89116C9B2AAB7198B05C5E72318468C2FC5E939898934FE06A3B41694C13F245016AA4E1A74A45421804057212C4DE61D709F9E7FB1776E2341F2A40D68DCED91B7A0F5155F7A8D37270EB5141BE4506A41CBDCBA6922379B85B86348F7FC5B7B5370B3C24B269</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 64 A7 0A 00 7C AF 5E 67
0010 | 78 01 00 00 1F 5F 04 F5 3A 7B 5A FB 77 0C F2 72
0020 | C5 A9 01 FB 02 5E B7 86 6E A6 15 ED 42 09 C6 F9
0030 | C8 AF 56 CE 98 3E 2F 71 FE 50 01 00 21 36 BB D3
0040 | F2 F8 D7 8E 92 1F 04 ED 07 FF CE 57 90 DE 11 FE
0050 | E4 8D F0 8A 9B B5 5F 30 91 27 23 40 FA 64 13 23
0060 | 50 FC D9 33 96 1B 81 FE B2 FC 5F 97 CF 17 64 F8
0070 | B9 92 DC 83 C3 E2 0B 6D 02 D8 D0 3F CE DE 89 A9
0080 | 8A 07 98 72 48 35 65 79 A8 93 A1 4B C7 66 B6 7C
0090 | 93 CF 6F 2F 36 37 0E 56 63 1F 81 57 F0 BA 6D 73
00A0 | B2 A1 51 D1 EE AE 57 E5 A0 1A CE BE 2C C0 25 4F
00B0 | D5 64 47 95 D0 28 AD BF 5C 22 BE B5 19 73 BA ED
00C0 | D1 B4 2F CD 0E 8C C0 9E FA 43 85 14 2C 79 1B 57
00D0 | 52 13 91 08 B8 1A FE 92 E3 8D 87 10 3D 70 AA 9B
00E0 | A3 40 16 12 C5 8B 64 1A 51 36 EF EA 56 DB EB CF
00F0 | 1E 02 49 25 71 E2 C8 AA 7C 26 4D 40 6A 71 77 22
0100 | 7A AE E3 6D CA E6 FA 46 CB F2 A7 04 B3 91 9B 57
0110 | 54 22 D3 48 44 E2 AC A7 8E A4 73 D1 8C 75 AC E5
0120 | B7 AE B8 BC 7B 89 11 6C 9B 2A AB 71 98 B0 5C 5E
0130 | 72 31 84 68 C2 FC 5E 93 98 98 93 4F E0 6A 3B 41
0140 | 69 4C 13 F2 45 01 6A A4 E1 A7 4A 45 42 18 04 05
0150 | 72 12 C4 DE 61 D7 09 F9 E7 FB 17 76 E2 34 1F 2A
0160 | 40 D6 8D CE D9 1B 7A 0F 51 55 F7 A8 D3 72 70 EB
0170 | 51 41 BE 45 06 A4 1C BD CB A6 92 23 79 B8 5B 86
0180 | 34 8F 7F C5 B7 B5 37 0B 3C 24 B2 69</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>64A70A007CAF5E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001002136BBD3F2F8D78E921F04ED</code> <code>07FFCE5790DE11FEE48DF08A9BB55F30</code> <code>91272340FA64132350FCD933961B81FE</code> <code>B2FC5F97CF1764F8B992DC83C3E20B6D</code> <code>02D8D03FCEDE89A98A07987248356579</code> <code>A893A14BC766B67C93CF6F2F36370E56</code> <code>631F8157F0BA6D73B2A151D1EEAE57E5</code> <code>A01ACEBE2CC0254FD5644795D028ADBF</code> <code>5C22BEB51973BAEDD1B42FCD0E8CC09E</code> <code>FA4385142C791B5752139108B81AFE92</code> <code>E38D87103D70AA9BA3401612C58B641A</code> <code>5136EFEA56DBEBCF1E02492571E2C8AA</code> <code>7C264D406A7177227AAEE36DCAE6FA46</code> <code>CBF2A704B3919B575422D34844E2ACA7</code> <code>8EA473D18C75ACE5B7AEB8BC7B89116C</code> <code>9B2AAB7198B05C5E72318468C2FC5E93</code> <code>9898934FE06A3B41694C13F245016AA4</code> <code>E1A74A45421804057212C4DE61D709F9</code> <code>E7FB1776E2341F2A40D68DCED91B7A0F</code> <code>5155F7A8D37270EB5141BE4506A41CBD</code> <code>CBA6922379B85B86348F7FC5B7B5370B</code><br> <code>3C24B269</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 0E182D19641B3F8D5672D8A808324AA57AC442F543F2DC6C73E7F7CADB5767C77AF3E825BD0AAC344A8644AC827529833813BB2B3BC46C1E3DAC3DBF1FD71BE1DEDBF5273DE15A12697FC8A99919DB1FB1DA913AED44E2C57FD427DA822D0E321DD1EB3380FD6AA1D452C8B0299DFD84B6E728FE8759D17916AE65F9E228E79694FE0EB4EF43D9A377E580A8E451E68DFE385AEF5C64A4EE27D62914A3B390824FF86FFEE161325CBC0AB03AA3DFCF4B807E51BB501E516402CCC1746B083ED87376FEFB756748EBD6CD062B5336A1B05D22BAA345BD098332F9069B02C7C613A02BC81224C307E62372FC322445B38C0C6041371E94DAAD06A1C02EA9356E0C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 50 F8 8A 7D AF 5E 67
0010 | 34 00 00 00 34 F7 CB 3B 3A 7B 5A FB 77 0C F2 72
0020 | C5 A9 01 FB 02 5E B7 86 6E A6 15 ED 42 09 C6 F9
0030 | C8 AF 56 CE 98 3E 2F 71 24 66 64 28 42 F5 83 25
0040 | D8 90 E7 46 B4 69 3A DB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0150F88A7DAF5E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>3A7B5AFB770CF272C5A901FB025EB786</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6EA615ED4209C6F9C8AF56CE983E2F71</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>2466642842F58325D890E746B4693ADB</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

