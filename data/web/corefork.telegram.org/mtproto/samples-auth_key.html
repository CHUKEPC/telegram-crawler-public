<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C4 D4 00 00 B4 56 C8 68
0010 | 14 00 00 00 F1 8E 7E BE C3 28 B0 FF 8F 45 36 AC
0020 | E9 B0 18 E0 69 E1 56 2D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C4D40000B456C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 84 A1 7B B4 56 C8 68
0010 | 50 00 00 00 63 24 16 05 C3 28 B0 FF 8F 45 36 AC
0020 | E9 B0 18 E0 69 E1 56 2D EB A6 7D 85 AC CF 91 49
0030 | 4B 02 8E 99 C4 BE 9B FC 08 17 39 35 61 F9 47 AD
0040 | 79 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0184A17BB456C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0817393561F947AD79000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1673427431455174009</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1673427431455174009</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1673427431455174009 = 1176364999 * 1422540991</code></p>
<pre><code>p = 1176364999
q = 1422540991</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 17 39 35 61 F9 47 AD 79 00 00 00
0010 | 04 46 1D E7 C7 00 00 00 04 54 CA 40 BF 00 00 00
0020 | C3 28 B0 FF 8F 45 36 AC E9 B0 18 E0 69 E1 56 2D
0030 | EB A6 7D 85 AC CF 91 49 4B 02 8E 99 C4 BE 9B FC
0040 | AD 3A 23 41 21 01 4D F6 36 54 3C 35 77 0E 49 67
0050 | 95 31 00 DB 35 33 5B A9 40 22 67 77 A3 F5 9A 9C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0817393561F947AD79000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1673427431455174009</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04461DE7C7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1176364999</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0454CA40BF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1422540991</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>AD3A234121014DF636543C35770E4967</code> <code>953100DB35335BA940226777A3F59A9C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90817393561F947AD7900000004461DE7C70000000454CA40BF000000C328B0FF8F4536ACE9B018E069E1562DEBA67D85ACCF91494B028E99C4BE9BFCAD3A234121014DF636543C35770E4967953100DB35335BA940226777A3F59A9C02000000
random_padding_bytes = A1DC2DE1C038FBEEDEC1AB8B37FF1CD7113BF4F7DF7836EC47544B3BA21E0C82CF1C0040BBA3F1384EBF0C3145EC0444B523DBFB71B817647B8C44E7059B1D354C6CB2A758D100DBD522057BA8A0F2F122275E5D3CD319EDAE485D84</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 8821A36C69866BBF85E23FB87172F172CDD6F93BDA9870F45629D684B083611CF89C36F770E375ED11E061ECC5889A74E3ECA5107A0B84DACD44254C3199295D88172DDE5B728AB4C87BB0440B536A41A67FCE6EF936E9F8252EAB73DCE4A4645D0F9A99F2B78AC53E1D73C3291179EE09DC05373217961B977F53736999E061BA53993F20D71259BB72B3C62AFFF6C116F9FA352465DF4685179ACD1F867945A2593FC86265297D5BACDAEA75EDC4DE6B35838C49E8AB59973C76C4916711A438A97F3C59F889BB95CFCC8BE9C162C145ADFD0627F83B8D30D479AD5A43F34655273DB26CB6804F5DE2C20CFEE1DFA248B22C412FF6CA3D014637F5627B4E65</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 94 BE 01 00 B4 56 C8 68
0010 | 40 01 00 00 BE E4 12 D7 C3 28 B0 FF 8F 45 36 AC
0020 | E9 B0 18 E0 69 E1 56 2D EB A6 7D 85 AC CF 91 49
0030 | 4B 02 8E 99 C4 BE 9B FC 04 46 1D E7 C7 00 00 00
0040 | 04 54 CA 40 BF 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 88 21 A3 6C 69 86 6B BF 85 E2 3F B8
0060 | 71 72 F1 72 CD D6 F9 3B DA 98 70 F4 56 29 D6 84
0070 | B0 83 61 1C F8 9C 36 F7 70 E3 75 ED 11 E0 61 EC
0080 | C5 88 9A 74 E3 EC A5 10 7A 0B 84 DA CD 44 25 4C
0090 | 31 99 29 5D 88 17 2D DE 5B 72 8A B4 C8 7B B0 44
00A0 | 0B 53 6A 41 A6 7F CE 6E F9 36 E9 F8 25 2E AB 73
00B0 | DC E4 A4 64 5D 0F 9A 99 F2 B7 8A C5 3E 1D 73 C3
00C0 | 29 11 79 EE 09 DC 05 37 32 17 96 1B 97 7F 53 73
00D0 | 69 99 E0 61 BA 53 99 3F 20 D7 12 59 BB 72 B3 C6
00E0 | 2A FF F6 C1 16 F9 FA 35 24 65 DF 46 85 17 9A CD
00F0 | 1F 86 79 45 A2 59 3F C8 62 65 29 7D 5B AC DA EA
0100 | 75 ED C4 DE 6B 35 83 8C 49 E8 AB 59 97 3C 76 C4
0110 | 91 67 11 A4 38 A9 7F 3C 59 F8 89 BB 95 CF CC 8B
0120 | E9 C1 62 C1 45 AD FD 06 27 F8 3B 8D 30 D4 79 AD
0130 | 5A 43 F3 46 55 27 3D B2 6C B6 80 4F 5D E2 C2 0C
0140 | FE E1 DF A2 48 B2 2C 41 2F F6 CA 3D 01 46 37 F5
0150 | 62 7B 4E 65</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>94BE0100B456C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04461DE7C7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1176364999</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0454CA40BF000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1422540991</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001008821A36C69866BBF85E23FB8</code> <code>7172F172CDD6F93BDA9870F45629D684</code> <code>B083611CF89C36F770E375ED11E061EC</code> <code>C5889A74E3ECA5107A0B84DACD44254C</code> <code>3199295D88172DDE5B728AB4C87BB044</code> <code>0B536A41A67FCE6EF936E9F8252EAB73</code> <code>DCE4A4645D0F9A99F2B78AC53E1D73C3</code> <code>291179EE09DC05373217961B977F5373</code> <code>6999E061BA53993F20D71259BB72B3C6</code> <code>2AFFF6C116F9FA352465DF4685179ACD</code> <code>1F867945A2593FC86265297D5BACDAEA</code> <code>75EDC4DE6B35838C49E8AB59973C76C4</code> <code>916711A438A97F3C59F889BB95CFCC8B</code> <code>E9C162C145ADFD0627F83B8D30D479AD</code> <code>5A43F34655273DB26CB6804F5DE2C20C</code> <code>FEE1DFA248B22C412FF6CA3D014637F5</code><br> <code>627B4E65</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 18 28 B3 B4 56 C8 68
0010 | 78 02 00 00 5C 07 E8 D0 C3 28 B0 FF 8F 45 36 AC
0020 | E9 B0 18 E0 69 E1 56 2D EB A6 7D 85 AC CF 91 49
0030 | 4B 02 8E 99 C4 BE 9B FC FE 50 02 00 4C 5D FE 3F
0040 | 8C 48 9D 8C 84 DF 12 3C 7D CF 48 BD 62 BA BB 54
0050 | 78 45 1D B6 A6 17 A9 17 DF 92 87 12 E7 AB 38 8C
0060 | BB 81 F1 66 D6 D7 67 A3 23 F4 0A 17 EB B3 CE B6
0070 | A1 70 C9 1F 70 9D D5 66 DB 2A 87 FF E3 E1 EB CD
0080 | F9 CD 06 51 0D 69 99 E3 97 EF 01 79 10 91 EF B2
0090 | 93 03 D1 05 54 7D 6B 4D 84 CC 5F A6 21 42 C5 1F
00A0 | 96 C8 11 B0 09 58 59 CF 57 DF CA 8E 03 E6 FD B7
00B0 | 9F 9B FC C8 73 DA 1A 71 A1 0A 1C D1 DE CA F8 A7
00C0 | E8 23 E7 05 52 57 C3 FB 12 7B 9E F8 4E 02 ED 6C
00D0 | A5 84 8C 7D 7C 26 F2 7F C6 22 AB 9C 3E B0 62 65
00E0 | DF FD 0D E2 0F E7 6E 70 CF 03 76 F5 A2 64 5A 9B
00F0 | 09 AD FF F7 E8 7F DD BF 1A 3F 6D F1 C8 95 80 0C
0100 | 45 02 8F 0E 69 46 03 B5 05 08 2D 09 B9 38 E9 D1
0110 | 67 FA EF 2C EF 9D D7 E1 AA BA A4 D2 D0 06 D6 9B
0120 | FF B2 CA 54 DB FB FD CE 80 F2 AA 37 3B DE D7 A6
0130 | 17 C6 6C C5 E6 2F 60 F5 12 EB F2 D1 1C EA D4 34
0140 | E0 9F 71 0E 4A 85 42 22 5E 0D 6C 2A 79 8A 6A 73
0150 | 02 FC 06 20 59 9E 78 72 09 B4 F8 7E B9 B5 F5 81
0160 | 3F 69 99 6C 19 7D C8 AC 27 41 8A DD 4D D7 1F D1
0170 | 1C 79 41 96 2F 7F 6A 98 D4 6F CF C5 99 56 30 5F
0180 | 84 01 9F B1 E3 F4 C3 25 4B 3A 32 27 AC 5D A2 96
0190 | C7 80 88 E3 2C 9E 06 40 C8 27 51 F9 66 2A 7F 53
01A0 | 1F 71 8F 39 E1 EA 2E E6 E2 3C 23 D1 60 F6 21 41
01B0 | B2 0C 4B 14 29 16 FE 9D 4C EA 63 51 03 50 9B B2
01C0 | 4D 8E 37 E7 35 38 32 79 C3 3F FC 62 80 35 7E E0
01D0 | D9 C7 63 6D EC E7 AF 4F 18 BA 5A C7 B6 89 66 0C
01E0 | D1 BA 9F B6 E8 61 FF 7C 16 CE CA 03 F7 98 EE 70
01F0 | 02 61 9E F3 83 CE 01 7E FF 9E C8 57 13 50 DF D4
0200 | 63 0C 03 D5 BC CD 83 67 9C EF 37 E9 E1 D4 04 5E
0210 | 61 FF 03 0C 5E F2 75 CC BF A8 19 F3 57 F6 DF 66
0220 | 1B AF DB 0D 1E 49 9A 2D 04 5E A9 B3 8D AB 3C 64
0230 | 8A 6B FC 50 E4 96 43 B7 6D D0 3F 54 45 1D EB 2A
0240 | 02 5E B1 EC 91 3F D3 FD 30 AC 0B C9 19 10 6F 1D
0250 | 78 97 71 3D 8E E4 75 78 FA 24 10 B4 7D F7 5C B6
0260 | B4 31 FB 73 50 56 1C 46 25 D5 D0 5A 32 74 9D 4F
0270 | 10 6D 70 4C 66 09 19 78 FF AC FB 53 1A 26 9A 5E
0280 | B2 C8 1B C0 2A 88 99 18 E5 50 1D ED</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>011828B3B456C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002004C5DFE3F8C489D8C84DF123C</code> <code>7DCF48BD62BABB5478451DB6A617A917</code> <code>DF928712E7AB388CBB81F166D6D767A3</code> <code>23F40A17EBB3CEB6A170C91F709DD566</code> <code>DB2A87FFE3E1EBCDF9CD06510D6999E3</code> <code>97EF01791091EFB29303D105547D6B4D</code> <code>84CC5FA62142C51F96C811B0095859CF</code> <code>57DFCA8E03E6FDB79F9BFCC873DA1A71</code> <code>A10A1CD1DECAF8A7E823E7055257C3FB</code> <code>127B9EF84E02ED6CA5848C7D7C26F27F</code> <code>C622AB9C3EB06265DFFD0DE20FE76E70</code> <code>CF0376F5A2645A9B09ADFFF7E87FDDBF</code> <code>1A3F6DF1C895800C45028F0E694603B5</code> <code>05082D09B938E9D167FAEF2CEF9DD7E1</code> <code>AABAA4D2D006D69BFFB2CA54DBFBFDCE</code> <code>80F2AA373BDED7A617C66CC5E62F60F5</code> <code>12EBF2D11CEAD434E09F710E4A854222</code> <code>5E0D6C2A798A6A7302FC0620599E7872</code> <code>09B4F87EB9B5F5813F69996C197DC8AC</code> <code>27418ADD4DD71FD11C7941962F7F6A98</code> <code>D46FCFC59956305F84019FB1E3F4C325</code> <code>4B3A3227AC5DA296C78088E32C9E0640</code> <code>C82751F9662A7F531F718F39E1EA2EE6</code> <code>E23C23D160F62141B20C4B142916FE9D</code> <code>4CEA635103509BB24D8E37E735383279</code> <code>C33FFC6280357EE0D9C7636DECE7AF4F</code> <code>18BA5AC7B689660CD1BA9FB6E861FF7C</code> <code>16CECA03F798EE7002619EF383CE017E</code> <code>FF9EC8571350DFD4630C03D5BCCD8367</code> <code>9CEF37E9E1D4045E61FF030C5EF275CC</code> <code>BFA819F357F6DF661BAFDB0D1E499A2D</code> <code>045EA9B38DAB3C648A6BFC50E49643B7</code> <code>6DD03F54451DEB2A025EB1EC913FD3FD</code> <code>30AC0BC919106F1D7897713D8EE47578</code> <code>FA2410B47DF75CB6B431FB7350561C46</code> <code>25D5D05A32749D4F106D704C66091978</code> <code>FFACFB531A269A5EB2C81BC02A889918</code><br> <code>E5501DED</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 4C5DFE3F8C489D8C84DF123C7DCF48BD62BABB5478451DB6A617A917DF928712E7AB388CBB81F166D6D767A323F40A17EBB3CEB6A170C91F709DD566DB2A87FFE3E1EBCDF9CD06510D6999E397EF01791091EFB29303D105547D6B4D84CC5FA62142C51F96C811B0095859CF57DFCA8E03E6FDB79F9BFCC873DA1A71A10A1CD1DECAF8A7E823E7055257C3FB127B9EF84E02ED6CA5848C7D7C26F27FC622AB9C3EB06265DFFD0DE20FE76E70CF0376F5A2645A9B09ADFFF7E87FDDBF1A3F6DF1C895800C45028F0E694603B505082D09B938E9D167FAEF2CEF9DD7E1AABAA4D2D006D69BFFB2CA54DBFBFDCE80F2AA373BDED7A617C66CC5E62F60F512EBF2D11CEAD434E09F710E4A8542225E0D6C2A798A6A7302FC0620599E787209B4F87EB9B5F5813F69996C197DC8AC27418ADD4DD71FD11C7941962F7F6A98D46FCFC59956305F84019FB1E3F4C3254B3A3227AC5DA296C78088E32C9E0640C82751F9662A7F531F718F39E1EA2EE6E23C23D160F62141B20C4B142916FE9D4CEA635103509BB24D8E37E735383279C33FFC6280357EE0D9C7636DECE7AF4F18BA5AC7B689660CD1BA9FB6E861FF7C16CECA03F798EE7002619EF383CE017EFF9EC8571350DFD4630C03D5BCCD83679CEF37E9E1D4045E61FF030C5EF275CCBFA819F357F6DF661BAFDB0D1E499A2D045EA9B38DAB3C648A6BFC50E49643B76DD03F54451DEB2A025EB1EC913FD3FD30AC0BC919106F1D7897713D8EE47578FA2410B47DF75CB6B431FB7350561C4625D5D05A32749D4F106D704C66091978FFACFB531A269A5EB2C81BC02A889918E5501DED
tmp_aes_key = F874C6C15DE7323578DED08FBB1B5963945F470D3FD21A69016838EC665D3D4F
tmp_aes_iv = B1AF7DD827391FDAB2DF7F05C72D9AAEECEEEDAF0AC7A7B8038FE08AAD3A2341</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 57C842D876E2CF1AC30087E74CCF08D48E1DB667BA0D89B5C328B0FF8F4536ACE9B018E069E1562DEBA67D85ACCF91494B028E99C4BE9BFC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100ACAAE5BF7586F7298D971D2CED22F121BB32448F04D519C6CC349A8C8F4BC2EEB094D54A3F8D3B9C531D8663252ABE272A8B4D313215C30BE741E4A620FC4483AA7D41D557DA73B35477B11E7479F0D589BBFC6FF6318CC31B1F7B16F24B00069150FB53B446CF0EF8B6F7941BA7192E0CA776E13967BD329F45E70C7F78D93D526389F0BBE817458EBDDF519564B418D3750B7ADD361D18C55A954B0319B2FB2F676C2476D45BD49E2EBA68C55EA035F42E4696C6EC80EBB7AEDD8DBCC7934C30CBA3F15A03AEDAE38E57DBB630ABFAF4C4985947AC4B92CA7A834249349F9AD42BFCFE15610FB6898D99E557ADA16CF35E4CBADA9272D546097BE0CC28935AB456C868C9DA5B5532BA9E22
answer = BA0D89B5C328B0FF8F4536ACE9B018E069E1562DEBA67D85ACCF91494B028E99C4BE9BFC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100ACAAE5BF7586F7298D971D2CED22F121BB32448F04D519C6CC349A8C8F4BC2EEB094D54A3F8D3B9C531D8663252ABE272A8B4D313215C30BE741E4A620FC4483AA7D41D557DA73B35477B11E7479F0D589BBFC6FF6318CC31B1F7B16F24B00069150FB53B446CF0EF8B6F7941BA7192E0CA776E13967BD329F45E70C7F78D93D526389F0BBE817458EBDDF519564B418D3750B7ADD361D18C55A954B0319B2FB2F676C2476D45BD49E2EBA68C55EA035F42E4696C6EC80EBB7AEDD8DBCC7934C30CBA3F15A03AEDAE38E57DBB630ABFAF4C4985947AC4B92CA7A834249349F9AD42BFCFE15610FB6898D99E557ADA16CF35E4CBADA9272D546097BE0CC28935AB456C868C9DA5B5532BA9E22</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 C3 28 B0 FF 8F 45 36 AC E9 B0 18 E0
0010 | 69 E1 56 2D EB A6 7D 85 AC CF 91 49 4B 02 8E 99
0020 | C4 BE 9B FC 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | AC AA E5 BF 75 86 F7 29 8D 97 1D 2C ED 22 F1 21
0140 | BB 32 44 8F 04 D5 19 C6 CC 34 9A 8C 8F 4B C2 EE
0150 | B0 94 D5 4A 3F 8D 3B 9C 53 1D 86 63 25 2A BE 27
0160 | 2A 8B 4D 31 32 15 C3 0B E7 41 E4 A6 20 FC 44 83
0170 | AA 7D 41 D5 57 DA 73 B3 54 77 B1 1E 74 79 F0 D5
0180 | 89 BB FC 6F F6 31 8C C3 1B 1F 7B 16 F2 4B 00 06
0190 | 91 50 FB 53 B4 46 CF 0E F8 B6 F7 94 1B A7 19 2E
01A0 | 0C A7 76 E1 39 67 BD 32 9F 45 E7 0C 7F 78 D9 3D
01B0 | 52 63 89 F0 BB E8 17 45 8E BD DF 51 95 64 B4 18
01C0 | D3 75 0B 7A DD 36 1D 18 C5 5A 95 4B 03 19 B2 FB
01D0 | 2F 67 6C 24 76 D4 5B D4 9E 2E BA 68 C5 5E A0 35
01E0 | F4 2E 46 96 C6 EC 80 EB B7 AE DD 8D BC C7 93 4C
01F0 | 30 CB A3 F1 5A 03 AE DA E3 8E 57 DB B6 30 AB FA
0200 | F4 C4 98 59 47 AC 4B 92 CA 7A 83 42 49 34 9F 9A
0210 | D4 2B FC FE 15 61 0F B6 89 8D 99 E5 57 AD A1 6C
0220 | F3 5E 4C BA DA 92 72 D5 46 09 7B E0 CC 28 93 5A
0230 | B4 56 C8 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100ACAAE5BF7586F7298D971D2C</code> <code>ED22F121BB32448F04D519C6CC349A8C</code> <code>8F4BC2EEB094D54A3F8D3B9C531D8663</code> <code>252ABE272A8B4D313215C30BE741E4A6</code> <code>20FC4483AA7D41D557DA73B35477B11E</code> <code>7479F0D589BBFC6FF6318CC31B1F7B16</code> <code>F24B00069150FB53B446CF0EF8B6F794</code> <code>1BA7192E0CA776E13967BD329F45E70C</code> <code>7F78D93D526389F0BBE817458EBDDF51</code> <code>9564B418D3750B7ADD361D18C55A954B</code> <code>0319B2FB2F676C2476D45BD49E2EBA68</code> <code>C55EA035F42E4696C6EC80EBB7AEDD8D</code> <code>BCC7934C30CBA3F15A03AEDAE38E57DB</code> <code>B630ABFAF4C4985947AC4B92CA7A8342</code> <code>49349F9AD42BFCFE15610FB6898D99E5</code> <code>57ADA16CF35E4CBADA9272D546097BE0</code><br> <code>CC28935A</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>B456C868</code> (1757959860 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 380F94E1889551BBFB67EF0B682C57C966B0F9E6B25805DCA346A5E558828D717E8960A1679841F92C9C3E2E84DA9D1A31FBA51D36C0C083DFC48C3BEB55EFE857EF20482C2067D6A5784AFA3BC0B57A36C10FD0C0B6D007E814F71C48E58BA828E24D5FE3006A5925E91E669ACA724A47F033C6D7271F1D2EAC4C7B841426F7298FDF10E79E04B143A0B7BCDB743C0E999754778885F21D5658BD0290F4A0D946C894BB73B28B1FEF9B466BBD97AF0D3D72C4374BB3511ED842D469EB8E1DB57DDA856787B02BCEF931D8E3BABB95641430ED346838CB590E6AF40783BCFB4BF09D8217A220E17A58A7FC9BBF74BAE4CDF47CD8612F548A685C896FC3B42E4E</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 9DFF8D13D1C8DFFDBBAB3D04EB25DC220DD14B613A4764E79A3D81CC9B68111F0A9047FE13A6398D1AC8B5B82A5A33516F948006BAD4DEE389AE4201345EE1DD9AD748FBC28177CFEB00C55100A679E6C5C3BBCE974FD649716F3899DD652FB7ABBD0F636B33C7D2674965916994BB162362DAF61F0ADCBF18026E56345D3E42F693B5A4499379302E05597A2B12F566ED7277BAEDECA7A2CFF41B8D0DC60936F8649B1C7B9A919918990B5640DB843E46AEFF7CBDE59925EE625D96E1CEA3D58D5D536E2970100A42B3F661603FDB4BB3C14E36F7EFF515200248F5AEF7F6E4F9E902009F6E7494EC519CA21AB9F26FBD5CD264DC1E075B5CBD5EF2616C439D</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 C3 28 B0 FF 8F 45 36 AC E9 B0 18 E0
0010 | 69 E1 56 2D EB A6 7D 85 AC CF 91 49 4B 02 8E 99
0020 | C4 BE 9B FC 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 9D FF 8D 13 D1 C8 DF FD BB AB 3D 04 EB 25 DC 22
0040 | 0D D1 4B 61 3A 47 64 E7 9A 3D 81 CC 9B 68 11 1F
0050 | 0A 90 47 FE 13 A6 39 8D 1A C8 B5 B8 2A 5A 33 51
0060 | 6F 94 80 06 BA D4 DE E3 89 AE 42 01 34 5E E1 DD
0070 | 9A D7 48 FB C2 81 77 CF EB 00 C5 51 00 A6 79 E6
0080 | C5 C3 BB CE 97 4F D6 49 71 6F 38 99 DD 65 2F B7
0090 | AB BD 0F 63 6B 33 C7 D2 67 49 65 91 69 94 BB 16
00A0 | 23 62 DA F6 1F 0A DC BF 18 02 6E 56 34 5D 3E 42
00B0 | F6 93 B5 A4 49 93 79 30 2E 05 59 7A 2B 12 F5 66
00C0 | ED 72 77 BA ED EC A7 A2 CF F4 1B 8D 0D C6 09 36
00D0 | F8 64 9B 1C 7B 9A 91 99 18 99 0B 56 40 DB 84 3E
00E0 | 46 AE FF 7C BD E5 99 25 EE 62 5D 96 E1 CE A3 D5
00F0 | 8D 5D 53 6E 29 70 10 0A 42 B3 F6 61 60 3F DB 4B
0100 | B3 C1 4E 36 F7 EF F5 15 20 02 48 F5 AE F7 F6 E4
0110 | F9 E9 02 00 9F 6E 74 94 EC 51 9C A2 1A B9 F2 6F
0120 | BD 5C D2 64 DC 1E 07 5B 5C BD 5E F2 61 6C 43 9D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001009DFF8D13D1C8DFFDBBAB3D04</code> <code>EB25DC220DD14B613A4764E79A3D81CC</code> <code>9B68111F0A9047FE13A6398D1AC8B5B8</code> <code>2A5A33516F948006BAD4DEE389AE4201</code> <code>345EE1DD9AD748FBC28177CFEB00C551</code> <code>00A679E6C5C3BBCE974FD649716F3899</code> <code>DD652FB7ABBD0F636B33C7D267496591</code> <code>6994BB162362DAF61F0ADCBF18026E56</code> <code>345D3E42F693B5A4499379302E05597A</code> <code>2B12F566ED7277BAEDECA7A2CFF41B8D</code> <code>0DC60936F8649B1C7B9A919918990B56</code> <code>40DB843E46AEFF7CBDE59925EE625D96</code> <code>E1CEA3D58D5D536E2970100A42B3F661</code> <code>603FDB4BB3C14E36F7EFF515200248F5</code> <code>AEF7F6E4F9E902009F6E7494EC519CA2</code> <code>1AB9F26FBD5CD264DC1E075B5CBD5EF2</code><br> <code>616C439D</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366C328B0FF8F4536ACE9B018E069E1562DEBA67D85ACCF91494B028E99C4BE9BFC0000000000000000FE0001009DFF8D13D1C8DFFDBBAB3D04EB25DC220DD14B613A4764E79A3D81CC9B68111F0A9047FE13A6398D1AC8B5B82A5A33516F948006BAD4DEE389AE4201345EE1DD9AD748FBC28177CFEB00C55100A679E6C5C3BBCE974FD649716F3899DD652FB7ABBD0F636B33C7D2674965916994BB162362DAF61F0ADCBF18026E56345D3E42F693B5A4499379302E05597A2B12F566ED7277BAEDECA7A2CFF41B8D0DC60936F8649B1C7B9A919918990B5640DB843E46AEFF7CBDE59925EE625D96E1CEA3D58D5D536E2970100A42B3F661603FDB4BB3C14E36F7EFF515200248F5AEF7F6E4F9E902009F6E7494EC519CA21AB9F26FBD5CD264DC1E075B5CBD5EF2616C439D
padding = 38D68AF860BD6289FE83F80D
tmp_aes_key = F874C6C15DE7323578DED08FBB1B5963945F470D3FD21A69016838EC665D3D4F
tmp_aes_iv = B1AF7DD827391FDAB2DF7F05C72D9AAEECEEEDAF0AC7A7B8038FE08AAD3A2341</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 926588645CE1E352014DF91CF18A7C98D2A5C6284A23A8A8D4875C0D1751F31E0896EC57EB8CD19BE314E02A9E080136714B3AC23F429018ED6BB326EB74DAB61885503A65C3EDFFDC5F400B32C7EC150227D40CCF321F28C45B0F4606AF302F4F26D2C0097965A9D713BBE5A5679BD4D6BBBFA1587F29F93EFC99CE50A5FE3A2E66C749DF203C57C15993E3C982D2C259D99CEC8AB6DEF43A780466F7DBE079F70366CD5D3CE46282C320CE0223149C1088DBDA2640A37DFF6DF67011CA8E46143DF68CDCF7C8FF3D46DE7A9502458A39607AB019FBDEFE8A3AA91B67832326DF3D6E4AA63F8670C0A9E25AF6222A9F3C85652ECFC6B4DC5887DEE2E9961DAFA018E039D1315E7A395BA8360CDFFA7DFC5E4D52129F5F602DA25DD91D9F53294CCDC0E9D5454D92B4737CC3D2CEE5C4E8A240149B4F7CB9B7CE40983F322A498914684CAAA87C11507B44DFD29453F3</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C8 37 02 00 B4 56 C8 68
0010 | 78 01 00 00 1F 5F 04 F5 C3 28 B0 FF 8F 45 36 AC
0020 | E9 B0 18 E0 69 E1 56 2D EB A6 7D 85 AC CF 91 49
0030 | 4B 02 8E 99 C4 BE 9B FC FE 50 01 00 92 65 88 64
0040 | 5C E1 E3 52 01 4D F9 1C F1 8A 7C 98 D2 A5 C6 28
0050 | 4A 23 A8 A8 D4 87 5C 0D 17 51 F3 1E 08 96 EC 57
0060 | EB 8C D1 9B E3 14 E0 2A 9E 08 01 36 71 4B 3A C2
0070 | 3F 42 90 18 ED 6B B3 26 EB 74 DA B6 18 85 50 3A
0080 | 65 C3 ED FF DC 5F 40 0B 32 C7 EC 15 02 27 D4 0C
0090 | CF 32 1F 28 C4 5B 0F 46 06 AF 30 2F 4F 26 D2 C0
00A0 | 09 79 65 A9 D7 13 BB E5 A5 67 9B D4 D6 BB BF A1
00B0 | 58 7F 29 F9 3E FC 99 CE 50 A5 FE 3A 2E 66 C7 49
00C0 | DF 20 3C 57 C1 59 93 E3 C9 82 D2 C2 59 D9 9C EC
00D0 | 8A B6 DE F4 3A 78 04 66 F7 DB E0 79 F7 03 66 CD
00E0 | 5D 3C E4 62 82 C3 20 CE 02 23 14 9C 10 88 DB DA
00F0 | 26 40 A3 7D FF 6D F6 70 11 CA 8E 46 14 3D F6 8C
0100 | DC F7 C8 FF 3D 46 DE 7A 95 02 45 8A 39 60 7A B0
0110 | 19 FB DE FE 8A 3A A9 1B 67 83 23 26 DF 3D 6E 4A
0120 | A6 3F 86 70 C0 A9 E2 5A F6 22 2A 9F 3C 85 65 2E
0130 | CF C6 B4 DC 58 87 DE E2 E9 96 1D AF A0 18 E0 39
0140 | D1 31 5E 7A 39 5B A8 36 0C DF FA 7D FC 5E 4D 52
0150 | 12 9F 5F 60 2D A2 5D D9 1D 9F 53 29 4C CD C0 E9
0160 | D5 45 4D 92 B4 73 7C C3 D2 CE E5 C4 E8 A2 40 14
0170 | 9B 4F 7C B9 B7 CE 40 98 3F 32 2A 49 89 14 68 4C
0180 | AA A8 7C 11 50 7B 44 DF D2 94 53 F3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C8370200B456C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100926588645CE1E352014DF91C</code> <code>F18A7C98D2A5C6284A23A8A8D4875C0D</code> <code>1751F31E0896EC57EB8CD19BE314E02A</code> <code>9E080136714B3AC23F429018ED6BB326</code> <code>EB74DAB61885503A65C3EDFFDC5F400B</code> <code>32C7EC150227D40CCF321F28C45B0F46</code> <code>06AF302F4F26D2C0097965A9D713BBE5</code> <code>A5679BD4D6BBBFA1587F29F93EFC99CE</code> <code>50A5FE3A2E66C749DF203C57C15993E3</code> <code>C982D2C259D99CEC8AB6DEF43A780466</code> <code>F7DBE079F70366CD5D3CE46282C320CE</code> <code>0223149C1088DBDA2640A37DFF6DF670</code> <code>11CA8E46143DF68CDCF7C8FF3D46DE7A</code> <code>9502458A39607AB019FBDEFE8A3AA91B</code> <code>67832326DF3D6E4AA63F8670C0A9E25A</code> <code>F6222A9F3C85652ECFC6B4DC5887DEE2</code> <code>E9961DAFA018E039D1315E7A395BA836</code> <code>0CDFFA7DFC5E4D52129F5F602DA25DD9</code> <code>1D9F53294CCDC0E9D5454D92B4737CC3</code> <code>D2CEE5C4E8A240149B4F7CB9B7CE4098</code> <code>3F322A498914684CAAA87C11507B44DF</code><br> <code>D29453F3</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7BCB98D7E76CC058416BF8BF5F93B77667A4DE8A038FA8F927A9E40C59737161B5B46E7C452C3EDE744DE1D25EC476859DDDFC9B907E8D76615BB77D26BDDDB2D78F19F21323227F7622E1E35CC34029AB8E69B887210934FDC95B41D1C6AA48D9BD474702C46445EFB469BD6AD926556B09BEF650BBABD8EA83844540580B4BE67BBCE578231FC7E1838B9C4DEDB3789424D90AE2D8B2F0BA6249969A4D8A5EEAF5B0FC7D282137F8AF8A8D8F3EB3D044E032B371AC0F51BA4B588DDAE443990E26FCBECB2C9D08C101C0F0054EF06B5812D3B45CF30800F3D421019E376B8352A2D34D310B3767A77E8A9CA759CD9ADF7F944F89AD678B01A1591FCE93867E</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 BC C1 BA B5 56 C8 68
0010 | 34 00 00 00 34 F7 CB 3B C3 28 B0 FF 8F 45 36 AC
0020 | E9 B0 18 E0 69 E1 56 2D EB A6 7D 85 AC CF 91 49
0030 | 4B 02 8E 99 C4 BE 9B FC D2 B5 2F 2E 31 E0 0D 7C
0040 | CD 72 25 20 FC 9D 92 93</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01BCC1BAB556C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C328B0FF8F4536ACE9B018E069E1562D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EBA67D85ACCF91494B028E99C4BE9BFC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>D2B52F2E31E00D7CCD722520FC9D9293</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

