<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 38 40 0E 00 2A C5 96 66
0010 | 14 00 00 00 F1 8E 7E BE F6 82 BC AE D6 6D 37 DF
0020 | C8 5F 2F 8E 45 5B 24 FA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>38400E002AC59666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 34 7B 42 2A C5 96 66
0010 | 68 00 00 00 63 24 16 05 F6 82 BC AE D6 6D 37 DF
0020 | C8 5F 2F 8E 45 5B 24 FA CC 5A 5E 98 8D E8 26 0B
0030 | 1E A7 A5 AE 5E 9B B4 B3 08 1D 9E 37 F0 DF 6A 8F
0040 | EB 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01347B422AC59666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>68000000</code> (104 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081D9E37F0DF6A8FEB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2134204781100175339</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2134204781100175339</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2134204781100175339 = 1340884063 * 1591640053</code></p>
<pre><code>p = 1340884063
q = 1591640053</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1D 9E 37 F0 DF 6A 8F EB 00 00 00
0010 | 04 4F EC 44 5F 00 00 00 04 5E DE 7F F5 00 00 00
0020 | F6 82 BC AE D6 6D 37 DF C8 5F 2F 8E 45 5B 24 FA
0030 | CC 5A 5E 98 8D E8 26 0B 1E A7 A5 AE 5E 9B B4 B3
0040 | 99 16 8C 34 5E C4 A3 3A B7 7B 6E A9 5C 67 38 3A
0050 | 23 93 51 3E 1A 2F 88 AE 3E 60 1B 8B E5 5C DC 92
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081D9E37F0DF6A8FEB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2134204781100175339</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044FEC445F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1340884063</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045EDE7FF5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1591640053</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>99168C345EC4A33AB77B6EA95C67383A</code> <code>2393513E1A2F88AE3E601B8BE55CDC92</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081D9E37F0DF6A8FEB000000044FEC445F000000045EDE7FF5000000F682BCAED66D37DFC85F2F8E455B24FACC5A5E988DE8260B1EA7A5AE5E9BB4B399168C345EC4A33AB77B6EA95C67383A2393513E1A2F88AE3E601B8BE55CDC9202000000
random_padding_bytes = E5D51A658C033CCAA5A839B15B0B0EDC8DB905F73705BA6F4806D7109215E8E7FA88A57D87F5878DD7067776A4DB55A3C777E10FCB253786CB802C1117999CEEE197AB2C9683A3D052381C0C71EA3BD5B924C8DA9DB94293C9F04D6A</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = B5812471C9574BC9BAB413AB97AC6438A672364E11910BD14F670B1D3A2AFB8081C6E49021E0E93E1A6EDA7B861475ADD9BB5D3974543CE20D350B3B3F61F1ED97A7AE79341DFBE3CD94FAD96D45025CEDEBC77EFD29FDB53F87527FDD3DBC666D374BC87D1F2CBF874BA59BF3D86C10B0D1004B18BE25A66DA078044A3101121C5A990388572C630C2ACC88265B0FCF993EC0F727A69D7A52060559ED233EF1BB1D6A48F9E85739A1320D6C3D6BAAF266CCE66797D3AF83BCD9BCBFC7AB721DC366F8312AB715FCFAAB0A5F024C1F9C638B52E153752056D8AB33D55DCBFF92C67EC6573F19CEB2D112DB5F434D34BF5FACA9F71BE139E29EAF7E5DDD998708</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 3C 40 0E 00 2A C5 96 66
0010 | 40 01 00 00 BE E4 12 D7 F6 82 BC AE D6 6D 37 DF
0020 | C8 5F 2F 8E 45 5B 24 FA CC 5A 5E 98 8D E8 26 0B
0030 | 1E A7 A5 AE 5E 9B B4 B3 04 4F EC 44 5F 00 00 00
0040 | 04 5E DE 7F F5 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 B5 81 24 71 C9 57 4B C9 BA B4 13 AB
0060 | 97 AC 64 38 A6 72 36 4E 11 91 0B D1 4F 67 0B 1D
0070 | 3A 2A FB 80 81 C6 E4 90 21 E0 E9 3E 1A 6E DA 7B
0080 | 86 14 75 AD D9 BB 5D 39 74 54 3C E2 0D 35 0B 3B
0090 | 3F 61 F1 ED 97 A7 AE 79 34 1D FB E3 CD 94 FA D9
00A0 | 6D 45 02 5C ED EB C7 7E FD 29 FD B5 3F 87 52 7F
00B0 | DD 3D BC 66 6D 37 4B C8 7D 1F 2C BF 87 4B A5 9B
00C0 | F3 D8 6C 10 B0 D1 00 4B 18 BE 25 A6 6D A0 78 04
00D0 | 4A 31 01 12 1C 5A 99 03 88 57 2C 63 0C 2A CC 88
00E0 | 26 5B 0F CF 99 3E C0 F7 27 A6 9D 7A 52 06 05 59
00F0 | ED 23 3E F1 BB 1D 6A 48 F9 E8 57 39 A1 32 0D 6C
0100 | 3D 6B AA F2 66 CC E6 67 97 D3 AF 83 BC D9 BC BF
0110 | C7 AB 72 1D C3 66 F8 31 2A B7 15 FC FA AB 0A 5F
0120 | 02 4C 1F 9C 63 8B 52 E1 53 75 20 56 D8 AB 33 D5
0130 | 5D CB FF 92 C6 7E C6 57 3F 19 CE B2 D1 12 DB 5F
0140 | 43 4D 34 BF 5F AC A9 F7 1B E1 39 E2 9E AF 7E 5D
0150 | DD 99 87 08</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>3C400E002AC59666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044FEC445F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1340884063</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045EDE7FF5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1591640053</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100B5812471C9574BC9BAB413AB</code> <code>97AC6438A672364E11910BD14F670B1D</code> <code>3A2AFB8081C6E49021E0E93E1A6EDA7B</code> <code>861475ADD9BB5D3974543CE20D350B3B</code> <code>3F61F1ED97A7AE79341DFBE3CD94FAD9</code> <code>6D45025CEDEBC77EFD29FDB53F87527F</code> <code>DD3DBC666D374BC87D1F2CBF874BA59B</code> <code>F3D86C10B0D1004B18BE25A66DA07804</code> <code>4A3101121C5A990388572C630C2ACC88</code> <code>265B0FCF993EC0F727A69D7A52060559</code> <code>ED233EF1BB1D6A48F9E85739A1320D6C</code> <code>3D6BAAF266CCE66797D3AF83BCD9BCBF</code> <code>C7AB721DC366F8312AB715FCFAAB0A5F</code> <code>024C1F9C638B52E153752056D8AB33D5</code> <code>5DCBFF92C67EC6573F19CEB2D112DB5F</code> <code>434D34BF5FACA9F71BE139E29EAF7E5D</code><br> <code>DD998708</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 71 EA 2A C5 96 66
0010 | BC 02 00 00 5C 07 E8 D0 F6 82 BC AE D6 6D 37 DF
0020 | C8 5F 2F 8E 45 5B 24 FA CC 5A 5E 98 8D E8 26 0B
0030 | 1E A7 A5 AE 5E 9B B4 B3 FE 50 02 00 EA 91 BA B4
0040 | 2D DB DC B7 F3 8A 54 07 E8 08 9A B7 69 24 96 41
0050 | 66 29 3E 01 78 3A 6A E2 83 DB B9 F6 49 90 23 DB
0060 | 08 0D CC 48 8B 26 2C 15 43 05 BE EF 68 7F 1B C7
0070 | 6F 4F F9 E9 98 F1 00 B8 51 B0 4C E2 84 C8 9B 3A
0080 | C4 21 2E 2C 49 97 44 80 95 0D FD 29 E7 DD 8A E0
0090 | E6 3F EF 77 93 AB 43 AB E6 1F 4F 52 B8 04 08 94
00A0 | 59 79 DB 30 A5 ED CB 1F 1C 6E DC 8C 68 7A 70 AD
00B0 | 6D 64 C9 52 74 F4 DB 8B C6 FA AE 3D A2 FB 56 C4
00C0 | B5 EF AA C7 9E FA DE 6E 15 BF EA 95 55 B3 D0 BD
00D0 | 9F 52 8D 7B 8C C3 06 7D FB AE 52 06 FE B9 60 17
00E0 | E1 D7 15 F5 86 D4 87 F7 0D 11 4A 49 C2 0A 9F E4
00F0 | 02 BA 86 D6 72 00 D1 4B E9 D4 EA BB 96 91 66 DF
0100 | 71 9F 50 4D 69 F6 65 F8 F7 09 60 35 ED 02 94 7B
0110 | DC C0 B1 EC C9 BC EE A4 C5 67 A0 DC DB 69 AE E3
0120 | FC EB 51 64 75 F3 3D 1E AE 91 99 C7 81 01 4F DA
0130 | E6 85 6E FE B2 60 6D 88 BA 04 FA CA 8E 61 73 6A
0140 | 20 FA B6 A8 2C F8 48 18 6F 0C 4D FB CB BE 34 15
0150 | E8 71 B8 F1 64 4E E3 F6 DA A8 C5 FE 8B 73 B5 E9
0160 | C0 13 3D 92 8C 77 92 96 26 0E 14 2C BE 19 0A AC
0170 | 0C 7E F1 40 57 31 A6 EE CB C7 3C 80 9F 14 5C 19
0180 | DE 4A C0 E7 D8 40 3E C3 CE 4B CE 61 CF 2D D6 42
0190 | E5 F9 4E FA 29 2B 34 A9 39 22 82 8A 01 F9 97 7A
01A0 | EE 87 02 12 0A 44 55 9C E9 F5 2C 9A 10 16 97 0F
01B0 | F6 BF 81 83 15 43 84 55 07 EC 6F 3C DE E4 BA 9B
01C0 | 9F 0F 06 E9 D8 F7 53 3E 73 4B 65 1C 45 7D EE 79
01D0 | 82 B7 A7 9C 2F 12 9D 9E FC C1 75 7F CA 1D 68 27
01E0 | B1 6E 57 CE 95 BE DA 98 20 07 AE B5 60 A4 EC AA
01F0 | 42 FC B0 5F E7 7B 6E 0A B2 59 56 50 C2 87 59 F2
0200 | A3 AE 04 8F 42 13 8B DF D9 D2 45 33 D3 01 55 1E
0210 | 14 FF CB B1 C3 D5 E9 00 C0 53 21 81 0C 07 F1 AD
0220 | C8 92 72 FF 53 F1 E1 F7 70 EE 5E EC F7 AC 32 C2
0230 | 67 A4 C2 37 20 D9 64 FD 37 5B 25 31 BF 58 FD 22
0240 | DD 2E 8D 81 A6 29 91 E8 AF 83 15 71 71 04 EC 68
0250 | 8F AD 52 9D C7 FF A0 3C 8C C5 72 B9 BE 48 1A 90
0260 | FA 7B C0 0D F7 09 2E E7 E3 59 4E A6 3F 9A B7 97
0270 | 97 8D 09 03 5F 00 92 A1 0F EC B2 DF 97 13 C2 39
0280 | 2E 02 0D BA 6E 66 89 37 BC 66 40 FF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C471EA2AC59666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC020000</code> (700 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200EA91BAB42DDBDCB7F38A5407</code> <code>E8089AB76924964166293E01783A6AE2</code> <code>83DBB9F6499023DB080DCC488B262C15</code> <code>4305BEEF687F1BC76F4FF9E998F100B8</code> <code>51B04CE284C89B3AC4212E2C49974480</code> <code>950DFD29E7DD8AE0E63FEF7793AB43AB</code> <code>E61F4F52B80408945979DB30A5EDCB1F</code> <code>1C6EDC8C687A70AD6D64C95274F4DB8B</code> <code>C6FAAE3DA2FB56C4B5EFAAC79EFADE6E</code> <code>15BFEA9555B3D0BD9F528D7B8CC3067D</code> <code>FBAE5206FEB96017E1D715F586D487F7</code> <code>0D114A49C20A9FE402BA86D67200D14B</code> <code>E9D4EABB969166DF719F504D69F665F8</code> <code>F7096035ED02947BDCC0B1ECC9BCEEA4</code> <code>C567A0DCDB69AEE3FCEB516475F33D1E</code> <code>AE9199C781014FDAE6856EFEB2606D88</code> <code>BA04FACA8E61736A20FAB6A82CF84818</code> <code>6F0C4DFBCBBE3415E871B8F1644EE3F6</code> <code>DAA8C5FE8B73B5E9C0133D928C779296</code> <code>260E142CBE190AAC0C7EF1405731A6EE</code> <code>CBC73C809F145C19DE4AC0E7D8403EC3</code> <code>CE4BCE61CF2DD642E5F94EFA292B34A9</code> <code>3922828A01F9977AEE8702120A44559C</code> <code>E9F52C9A1016970FF6BF818315438455</code> <code>07EC6F3CDEE4BA9B9F0F06E9D8F7533E</code> <code>734B651C457DEE7982B7A79C2F129D9E</code> <code>FCC1757FCA1D6827B16E57CE95BEDA98</code> <code>2007AEB560A4ECAA42FCB05FE77B6E0A</code> <code>B2595650C28759F2A3AE048F42138BDF</code> <code>D9D24533D301551E14FFCBB1C3D5E900</code> <code>C05321810C07F1ADC89272FF53F1E1F7</code> <code>70EE5EECF7AC32C267A4C23720D964FD</code> <code>375B2531BF58FD22DD2E8D81A62991E8</code> <code>AF8315717104EC688FAD529DC7FFA03C</code> <code>8CC572B9BE481A90FA7BC00DF7092EE7</code> <code>E3594EA63F9AB797978D09035F0092A1</code> <code>0FECB2DF9713C2392E020DBA6E668937</code><br> <code>BC6640FF</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = EA91BAB42DDBDCB7F38A5407E8089AB76924964166293E01783A6AE283DBB9F6499023DB080DCC488B262C154305BEEF687F1BC76F4FF9E998F100B851B04CE284C89B3AC4212E2C49974480950DFD29E7DD8AE0E63FEF7793AB43ABE61F4F52B80408945979DB30A5EDCB1F1C6EDC8C687A70AD6D64C95274F4DB8BC6FAAE3DA2FB56C4B5EFAAC79EFADE6E15BFEA9555B3D0BD9F528D7B8CC3067DFBAE5206FEB96017E1D715F586D487F70D114A49C20A9FE402BA86D67200D14BE9D4EABB969166DF719F504D69F665F8F7096035ED02947BDCC0B1ECC9BCEEA4C567A0DCDB69AEE3FCEB516475F33D1EAE9199C781014FDAE6856EFEB2606D88BA04FACA8E61736A20FAB6A82CF848186F0C4DFBCBBE3415E871B8F1644EE3F6DAA8C5FE8B73B5E9C0133D928C779296260E142CBE190AAC0C7EF1405731A6EECBC73C809F145C19DE4AC0E7D8403EC3CE4BCE61CF2DD642E5F94EFA292B34A93922828A01F9977AEE8702120A44559CE9F52C9A1016970FF6BF81831543845507EC6F3CDEE4BA9B9F0F06E9D8F7533E734B651C457DEE7982B7A79C2F129D9EFCC1757FCA1D6827B16E57CE95BEDA982007AEB560A4ECAA42FCB05FE77B6E0AB2595650C28759F2A3AE048F42138BDFD9D24533D301551E14FFCBB1C3D5E900C05321810C07F1ADC89272FF53F1E1F770EE5EECF7AC32C267A4C23720D964FD375B2531BF58FD22DD2E8D81A62991E8AF8315717104EC688FAD529DC7FFA03C8CC572B9BE481A90FA7BC00DF7092EE7E3594EA63F9AB797978D09035F0092A10FECB2DF9713C2392E020DBA6E668937BC6640FF
tmp_aes_key = 192D215E748F95FD73801788B85F590E7C148D32D273A665210540C00EEA2526
tmp_aes_iv = A16A3B38A557F03F6FD1E8EB5B40800EA012A1678A005E1D32D2C74D99168C34</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 670189FD50F3D59A5EC941A4EAD342811AC6A09ABA0D89B5F682BCAED66D37DFC85F2F8E455B24FACC5A5E988DE8260B1EA7A5AE5E9BB4B303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007DEDF675D8B9D3A24D8100C528996BCE6CD61277BBAFC15F45C1A82E386AC197316701B9659F1E4097EDFB571A5D8FEEEEFFE26F63C68B5B00CD6F7522C6AA54BF96EAA9E6A7B4C190C81E058120C18547A8FA939DE594A50F3A1C4A24BD324607878FBB41C756AF0FB5F725236B9E2497662C94D9EABE63F92B28877CFAAB1636581B61344E2B979A4427FF809BE3DE60A7A0CB49A8AB5BD9B9319F4EC55557F7A58F0197D51B921F88842C873E786745AD16AC44B0FF7C34887E5A662BA8442AE988F111F5DFE79183182A92050151D9FE39523BA8C84EF98E26B0B6B4EB1553CD85C4112A29AFD0471D13F13434D2A1E7752B6E4BFE3E36EC9FDB78D36F162AC596669F9468246618AB15
answer = BA0D89B5F682BCAED66D37DFC85F2F8E455B24FACC5A5E988DE8260B1EA7A5AE5E9BB4B303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007DEDF675D8B9D3A24D8100C528996BCE6CD61277BBAFC15F45C1A82E386AC197316701B9659F1E4097EDFB571A5D8FEEEEFFE26F63C68B5B00CD6F7522C6AA54BF96EAA9E6A7B4C190C81E058120C18547A8FA939DE594A50F3A1C4A24BD324607878FBB41C756AF0FB5F725236B9E2497662C94D9EABE63F92B28877CFAAB1636581B61344E2B979A4427FF809BE3DE60A7A0CB49A8AB5BD9B9319F4EC55557F7A58F0197D51B921F88842C873E786745AD16AC44B0FF7C34887E5A662BA8442AE988F111F5DFE79183182A92050151D9FE39523BA8C84EF98E26B0B6B4EB1553CD85C4112A29AFD0471D13F13434D2A1E7752B6E4BFE3E36EC9FDB78D36F162AC596669F9468246618AB15</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 F6 82 BC AE D6 6D 37 DF C8 5F 2F 8E
0010 | 45 5B 24 FA CC 5A 5E 98 8D E8 26 0B 1E A7 A5 AE
0020 | 5E 9B B4 B3 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 7D ED F6 75 D8 B9 D3 A2 4D 81 00 C5 28 99 6B CE
0140 | 6C D6 12 77 BB AF C1 5F 45 C1 A8 2E 38 6A C1 97
0150 | 31 67 01 B9 65 9F 1E 40 97 ED FB 57 1A 5D 8F EE
0160 | EE FF E2 6F 63 C6 8B 5B 00 CD 6F 75 22 C6 AA 54
0170 | BF 96 EA A9 E6 A7 B4 C1 90 C8 1E 05 81 20 C1 85
0180 | 47 A8 FA 93 9D E5 94 A5 0F 3A 1C 4A 24 BD 32 46
0190 | 07 87 8F BB 41 C7 56 AF 0F B5 F7 25 23 6B 9E 24
01A0 | 97 66 2C 94 D9 EA BE 63 F9 2B 28 87 7C FA AB 16
01B0 | 36 58 1B 61 34 4E 2B 97 9A 44 27 FF 80 9B E3 DE
01C0 | 60 A7 A0 CB 49 A8 AB 5B D9 B9 31 9F 4E C5 55 57
01D0 | F7 A5 8F 01 97 D5 1B 92 1F 88 84 2C 87 3E 78 67
01E0 | 45 AD 16 AC 44 B0 FF 7C 34 88 7E 5A 66 2B A8 44
01F0 | 2A E9 88 F1 11 F5 DF E7 91 83 18 2A 92 05 01 51
0200 | D9 FE 39 52 3B A8 C8 4E F9 8E 26 B0 B6 B4 EB 15
0210 | 53 CD 85 C4 11 2A 29 AF D0 47 1D 13 F1 34 34 D2
0220 | A1 E7 75 2B 6E 4B FE 3E 36 EC 9F DB 78 D3 6F 16
0230 | 2A C5 96 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007DEDF675D8B9D3A24D8100C5</code> <code>28996BCE6CD61277BBAFC15F45C1A82E</code> <code>386AC197316701B9659F1E4097EDFB57</code> <code>1A5D8FEEEEFFE26F63C68B5B00CD6F75</code> <code>22C6AA54BF96EAA9E6A7B4C190C81E05</code> <code>8120C18547A8FA939DE594A50F3A1C4A</code> <code>24BD324607878FBB41C756AF0FB5F725</code> <code>236B9E2497662C94D9EABE63F92B2887</code> <code>7CFAAB1636581B61344E2B979A4427FF</code> <code>809BE3DE60A7A0CB49A8AB5BD9B9319F</code> <code>4EC55557F7A58F0197D51B921F88842C</code> <code>873E786745AD16AC44B0FF7C34887E5A</code> <code>662BA8442AE988F111F5DFE79183182A</code> <code>92050151D9FE39523BA8C84EF98E26B0</code> <code>B6B4EB1553CD85C4112A29AFD0471D13</code> <code>F13434D2A1E7752B6E4BFE3E36EC9FDB</code><br> <code>78D36F16</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>2AC59666</code> (1721156906 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = A699E4796CABCA0136345536E4E469B4AE59E93F597F5CEC135DD20BD7D6CDF6324547EDFA7A2AE5C457C3D642FD153B31E62E5FE155997AA1586EF679D4E8EA9C7A67BDE5BBF6B750FDC1EAE43769439D55A1C8C5F4E681FDCAEFD4A0A4B1A2191E717D12390BB566AFAAC4E3A1F176E6AE5836E17401DB6CF0F54AB3D4ADE508C8F883C59C9AF7D70079A075758973424C89511A776C00120B02AC602813AAA2E6DF4D02B7E504386877471A847FB19A173F71DF81AE1BD259388A0BC4786DFBE78B7BA8A196A7D8FBB3A89322569E531393A2C302FF8CC2AF33EBF39D5D0886826A6B08C118AD9029EF2C8711DE320DD0FA487330AA6CA7E50AF0601B50E1</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 7194579669F36B05764F00E733B5A802D7069AF48CE5EE603AA49011F354CAA1CD5F2DAACB18AB53C7D664CC07C21CF5741D6C5EAD61F25F56CE3A754BB2FB0CB98E3A41488C0638DF185B13C08DE52F592E7A1C8BFB51CA84FA6929E4A895226B5F7A9EA09BF721C9F917E90AD534092393F88E6950705B9B9C46C362C1D43D0D4729C39D9FA41F43DEFF8AA2AEFF0E1C15AAEF585F5473D82079387A35E078850AE07BB97606B4718DF49CC9BB5415B13D2C3153BE82E09C09949876E2E55F9756037A8191D61915F128B167168C13E083CCEFA96F15859DAB21AD836D2A18EC2464F4BFDB886682C6FED6A852B217ACC454686EACCC2DF3D43D2AF30F94DB</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 F6 82 BC AE D6 6D 37 DF C8 5F 2F 8E
0010 | 45 5B 24 FA CC 5A 5E 98 8D E8 26 0B 1E A7 A5 AE
0020 | 5E 9B B4 B3 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 71 94 57 96 69 F3 6B 05 76 4F 00 E7 33 B5 A8 02
0040 | D7 06 9A F4 8C E5 EE 60 3A A4 90 11 F3 54 CA A1
0050 | CD 5F 2D AA CB 18 AB 53 C7 D6 64 CC 07 C2 1C F5
0060 | 74 1D 6C 5E AD 61 F2 5F 56 CE 3A 75 4B B2 FB 0C
0070 | B9 8E 3A 41 48 8C 06 38 DF 18 5B 13 C0 8D E5 2F
0080 | 59 2E 7A 1C 8B FB 51 CA 84 FA 69 29 E4 A8 95 22
0090 | 6B 5F 7A 9E A0 9B F7 21 C9 F9 17 E9 0A D5 34 09
00A0 | 23 93 F8 8E 69 50 70 5B 9B 9C 46 C3 62 C1 D4 3D
00B0 | 0D 47 29 C3 9D 9F A4 1F 43 DE FF 8A A2 AE FF 0E
00C0 | 1C 15 AA EF 58 5F 54 73 D8 20 79 38 7A 35 E0 78
00D0 | 85 0A E0 7B B9 76 06 B4 71 8D F4 9C C9 BB 54 15
00E0 | B1 3D 2C 31 53 BE 82 E0 9C 09 94 98 76 E2 E5 5F
00F0 | 97 56 03 7A 81 91 D6 19 15 F1 28 B1 67 16 8C 13
0100 | E0 83 CC EF A9 6F 15 85 9D AB 21 AD 83 6D 2A 18
0110 | EC 24 64 F4 BF DB 88 66 82 C6 FE D6 A8 52 B2 17
0120 | AC C4 54 68 6E AC CC 2D F3 D4 3D 2A F3 0F 94 DB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001007194579669F36B05764F00E7</code> <code>33B5A802D7069AF48CE5EE603AA49011</code> <code>F354CAA1CD5F2DAACB18AB53C7D664CC</code> <code>07C21CF5741D6C5EAD61F25F56CE3A75</code> <code>4BB2FB0CB98E3A41488C0638DF185B13</code> <code>C08DE52F592E7A1C8BFB51CA84FA6929</code> <code>E4A895226B5F7A9EA09BF721C9F917E9</code> <code>0AD534092393F88E6950705B9B9C46C3</code> <code>62C1D43D0D4729C39D9FA41F43DEFF8A</code> <code>A2AEFF0E1C15AAEF585F5473D8207938</code> <code>7A35E078850AE07BB97606B4718DF49C</code> <code>C9BB5415B13D2C3153BE82E09C099498</code> <code>76E2E55F9756037A8191D61915F128B1</code> <code>67168C13E083CCEFA96F15859DAB21AD</code> <code>836D2A18EC2464F4BFDB886682C6FED6</code> <code>A852B217ACC454686EACCC2DF3D43D2A</code><br> <code>F30F94DB</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366F682BCAED66D37DFC85F2F8E455B24FACC5A5E988DE8260B1EA7A5AE5E9BB4B30000000000000000FE0001007194579669F36B05764F00E733B5A802D7069AF48CE5EE603AA49011F354CAA1CD5F2DAACB18AB53C7D664CC07C21CF5741D6C5EAD61F25F56CE3A754BB2FB0CB98E3A41488C0638DF185B13C08DE52F592E7A1C8BFB51CA84FA6929E4A895226B5F7A9EA09BF721C9F917E90AD534092393F88E6950705B9B9C46C362C1D43D0D4729C39D9FA41F43DEFF8AA2AEFF0E1C15AAEF585F5473D82079387A35E078850AE07BB97606B4718DF49CC9BB5415B13D2C3153BE82E09C09949876E2E55F9756037A8191D61915F128B167168C13E083CCEFA96F15859DAB21AD836D2A18EC2464F4BFDB886682C6FED6A852B217ACC454686EACCC2DF3D43D2AF30F94DB
padding = 06DC26A83AEC6CB1B0C526E5
tmp_aes_key = 192D215E748F95FD73801788B85F590E7C148D32D273A665210540C00EEA2526
tmp_aes_iv = A16A3B38A557F03F6FD1E8EB5B40800EA012A1678A005E1D32D2C74D99168C34</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = A15623196EA32948FCC535C935A3EAFF396A1E7032891F2A55E24BC62C166D443F31189AF3E1A19CB51B43C44D52C0F28BC399E0FCD77BCACF2376366F1DCDC51A29FFD17E72B8D72AEC1C1F8E994905CA1011398D88F4BCAAB193F55EA8961BEDE4BB7247A5CE2C0015A22A1DFCC05C0806F9EFC168A50B7E4FB3E5716435042DED395CCF09EB80AB65DD008BAE71862018C2EE422F144CDAC177A6240560C403B6A441F4F5DADA0DFE7A422F958CD13FF75086162467984EC243A7613C86AF7FF1149F94F6195D10A05AB14A3982E1DAB6D5B19F9D082DEC84B2D7FD53C167223E61CA65FC196FF72E9BBB812E764C531BE83569A258604E211B471EA8FCF4675C29E2025D9027B8DFFC71264DA1D0F91DA1B61DA14B348FC1DEB88728145D1616AAFB461DBF26A7F046578A6240340CA4C7B7975DD2C85360766399515C87A4B3DD0102E3DA44ED1B505750369805</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 40 40 0E 00 2A C5 96 66
0010 | 78 01 00 00 1F 5F 04 F5 F6 82 BC AE D6 6D 37 DF
0020 | C8 5F 2F 8E 45 5B 24 FA CC 5A 5E 98 8D E8 26 0B
0030 | 1E A7 A5 AE 5E 9B B4 B3 FE 50 01 00 A1 56 23 19
0040 | 6E A3 29 48 FC C5 35 C9 35 A3 EA FF 39 6A 1E 70
0050 | 32 89 1F 2A 55 E2 4B C6 2C 16 6D 44 3F 31 18 9A
0060 | F3 E1 A1 9C B5 1B 43 C4 4D 52 C0 F2 8B C3 99 E0
0070 | FC D7 7B CA CF 23 76 36 6F 1D CD C5 1A 29 FF D1
0080 | 7E 72 B8 D7 2A EC 1C 1F 8E 99 49 05 CA 10 11 39
0090 | 8D 88 F4 BC AA B1 93 F5 5E A8 96 1B ED E4 BB 72
00A0 | 47 A5 CE 2C 00 15 A2 2A 1D FC C0 5C 08 06 F9 EF
00B0 | C1 68 A5 0B 7E 4F B3 E5 71 64 35 04 2D ED 39 5C
00C0 | CF 09 EB 80 AB 65 DD 00 8B AE 71 86 20 18 C2 EE
00D0 | 42 2F 14 4C DA C1 77 A6 24 05 60 C4 03 B6 A4 41
00E0 | F4 F5 DA DA 0D FE 7A 42 2F 95 8C D1 3F F7 50 86
00F0 | 16 24 67 98 4E C2 43 A7 61 3C 86 AF 7F F1 14 9F
0100 | 94 F6 19 5D 10 A0 5A B1 4A 39 82 E1 DA B6 D5 B1
0110 | 9F 9D 08 2D EC 84 B2 D7 FD 53 C1 67 22 3E 61 CA
0120 | 65 FC 19 6F F7 2E 9B BB 81 2E 76 4C 53 1B E8 35
0130 | 69 A2 58 60 4E 21 1B 47 1E A8 FC F4 67 5C 29 E2
0140 | 02 5D 90 27 B8 DF FC 71 26 4D A1 D0 F9 1D A1 B6
0150 | 1D A1 4B 34 8F C1 DE B8 87 28 14 5D 16 16 AA FB
0160 | 46 1D BF 26 A7 F0 46 57 8A 62 40 34 0C A4 C7 B7
0170 | 97 5D D2 C8 53 60 76 63 99 51 5C 87 A4 B3 DD 01
0180 | 02 E3 DA 44 ED 1B 50 57 50 36 98 05</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>40400E002AC59666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100A15623196EA32948FCC535C9</code> <code>35A3EAFF396A1E7032891F2A55E24BC6</code> <code>2C166D443F31189AF3E1A19CB51B43C4</code> <code>4D52C0F28BC399E0FCD77BCACF237636</code> <code>6F1DCDC51A29FFD17E72B8D72AEC1C1F</code> <code>8E994905CA1011398D88F4BCAAB193F5</code> <code>5EA8961BEDE4BB7247A5CE2C0015A22A</code> <code>1DFCC05C0806F9EFC168A50B7E4FB3E5</code> <code>716435042DED395CCF09EB80AB65DD00</code> <code>8BAE71862018C2EE422F144CDAC177A6</code> <code>240560C403B6A441F4F5DADA0DFE7A42</code> <code>2F958CD13FF75086162467984EC243A7</code> <code>613C86AF7FF1149F94F6195D10A05AB1</code> <code>4A3982E1DAB6D5B19F9D082DEC84B2D7</code> <code>FD53C167223E61CA65FC196FF72E9BBB</code> <code>812E764C531BE83569A258604E211B47</code> <code>1EA8FCF4675C29E2025D9027B8DFFC71</code> <code>264DA1D0F91DA1B61DA14B348FC1DEB8</code> <code>8728145D1616AAFB461DBF26A7F04657</code> <code>8A6240340CA4C7B7975DD2C853607663</code> <code>99515C87A4B3DD0102E3DA44ED1B5057</code><br> <code>50369805</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7A8DBBE072B65871B43946FBC9CDBDB5DAADA78C3935765EE381E72F692AF465FC193021CDC1455FEBA06F1C9BEADFBF57D1E2D947D0066BE4A81A60DF4FCEA4318572DEBF852865C4F838A2F1107C07578FCA780385FF1444F0D58BB9B8E98213F753FC1D4034E00EBE58D2784ADF85DB1C50E8992A0B4E34DA980983930E4C71303FB3596D105FF7CF58240E1EFA7F77BDF122B99FF0F20092879DAD8CC0E96478D62BD5B1BD3DA95D27BB59595B9653B16460DF98F9801972954FF6F7741CF8D7A43B54A129E2EAB47257D684231340AEB6628AF3177D1763E367050B85BA9A684D134B8080E5CAA2133106CF2C8A08F34E3224772E155382B296E96C2CF3</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 D0 FA CF 2B C5 96 66
0010 | 38 00 00 00 34 F7 CB 3B F6 82 BC AE D6 6D 37 DF
0020 | C8 5F 2F 8E 45 5B 24 FA CC 5A 5E 98 8D E8 26 0B
0030 | 1E A7 A5 AE 5E 9B B4 B3 67 E4 27 DE DB F3 A7 8B
0040 | 25 5E FB 96 7B 0D 55 38</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01D0FACF2BC59666</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>38000000</code> (56 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>F682BCAED66D37DFC85F2F8E455B24FA</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>CC5A5E988DE8260B1EA7A5AE5E9BB4B3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>67E427DEDBF3A78B255EFB967B0D5538</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

