<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 DC AE 0B 00 17 BA BA 68
0010 | 14 00 00 00 F1 8E 7E BE C7 D2 AE E4 84 B4 46 8F
0020 | A2 72 1C 15 B6 4D 35 EC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>DCAE0B0017BABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 44 95 69 17 BA BA 68
0010 | 50 00 00 00 63 24 16 05 C7 D2 AE E4 84 B4 46 8F
0020 | A2 72 1C 15 B6 4D 35 EC 1E D4 52 22 A6 E9 B6 18
0030 | D3 A7 34 F9 5B C0 03 6D 08 2E 68 E1 FC 09 D6 ED
0040 | EB 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0144956917BABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>082E68E1FC09D6EDEB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3344171195935682027</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 3344171195935682027</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>3344171195935682027 = 1745295679 * 1916105813</code></p>
<pre><code>p = 1745295679
q = 1916105813</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 2E 68 E1 FC 09 D6 ED EB 00 00 00
0010 | 04 68 07 19 3F 00 00 00 04 72 35 74 55 00 00 00
0020 | C7 D2 AE E4 84 B4 46 8F A2 72 1C 15 B6 4D 35 EC
0030 | 1E D4 52 22 A6 E9 B6 18 D3 A7 34 F9 5B C0 03 6D
0040 | 01 C0 FA 0C C0 78 B7 F6 CA 8C D2 FD 53 31 CB 6D
0050 | ED 16 89 55 DA 22 F1 BF 20 6E 55 B1 0E 07 A1 2E
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>082E68E1FC09D6EDEB000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 3344171195935682027</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>046807193F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1745295679</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0472357455000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1916105813</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>01C0FA0CC078B7F6CA8CD2FD5331CB6D</code> <code>ED168955DA22F1BF206E55B10E07A12E</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9082E68E1FC09D6EDEB000000046807193F0000000472357455000000C7D2AEE484B4468FA2721C15B64D35EC1ED45222A6E9B618D3A734F95BC0036D01C0FA0CC078B7F6CA8CD2FD5331CB6DED168955DA22F1BF206E55B10E07A12E02000000
random_padding_bytes = 4BEA2387A0E06665AFCF222EAA7894217DE82D2227D81C214AEF327BB488168B15D938D526ED813C4EB9CA50B77854BD23DD30B4E4D7AB1A821298709ACFB2029CC3B149654DD4B07CA78A73D50C46769D127248D286FB392AAE4953</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = CFED93F181AB6B40725F12D7B6A6E0E70BE09B348C68F428DE03D995276828B48AB2FF0D360739CE45D4A1A74FA838C029C6FDE2AEC24076D4AE4DB992636B0379965FA3CA85044238263EA0514066045CABCAEC49E332776A3D8D9FD1FEFA007379E19E97A75DCC71F3D9D7A1DCAA04C7DEA9EC1CA6AD36F85A446096A90F750B4432ADD6B70AE3C943E56CB98D4BF6A65FE5BE8D7AB471697DD3E19F2724393730162ACC31F23D2C312E2FC4D58530D165C5C815643D39333ADDF91E477A66F227ED54680E6FBF80755E0FDF4E4D81E17B5B43D2AB4398F43E8A4BD2712F215D84074128CEBFB49819F39905C8560FACB1AB876413EDB856EB865F76F35411</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 E0 AE 0B 00 17 BA BA 68
0010 | 40 01 00 00 BE E4 12 D7 C7 D2 AE E4 84 B4 46 8F
0020 | A2 72 1C 15 B6 4D 35 EC 1E D4 52 22 A6 E9 B6 18
0030 | D3 A7 34 F9 5B C0 03 6D 04 68 07 19 3F 00 00 00
0040 | 04 72 35 74 55 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 CF ED 93 F1 81 AB 6B 40 72 5F 12 D7
0060 | B6 A6 E0 E7 0B E0 9B 34 8C 68 F4 28 DE 03 D9 95
0070 | 27 68 28 B4 8A B2 FF 0D 36 07 39 CE 45 D4 A1 A7
0080 | 4F A8 38 C0 29 C6 FD E2 AE C2 40 76 D4 AE 4D B9
0090 | 92 63 6B 03 79 96 5F A3 CA 85 04 42 38 26 3E A0
00A0 | 51 40 66 04 5C AB CA EC 49 E3 32 77 6A 3D 8D 9F
00B0 | D1 FE FA 00 73 79 E1 9E 97 A7 5D CC 71 F3 D9 D7
00C0 | A1 DC AA 04 C7 DE A9 EC 1C A6 AD 36 F8 5A 44 60
00D0 | 96 A9 0F 75 0B 44 32 AD D6 B7 0A E3 C9 43 E5 6C
00E0 | B9 8D 4B F6 A6 5F E5 BE 8D 7A B4 71 69 7D D3 E1
00F0 | 9F 27 24 39 37 30 16 2A CC 31 F2 3D 2C 31 2E 2F
0100 | C4 D5 85 30 D1 65 C5 C8 15 64 3D 39 33 3A DD F9
0110 | 1E 47 7A 66 F2 27 ED 54 68 0E 6F BF 80 75 5E 0F
0120 | DF 4E 4D 81 E1 7B 5B 43 D2 AB 43 98 F4 3E 8A 4B
0130 | D2 71 2F 21 5D 84 07 41 28 CE BF B4 98 19 F3 99
0140 | 05 C8 56 0F AC B1 AB 87 64 13 ED B8 56 EB 86 5F
0150 | 76 F3 54 11</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>E0AE0B0017BABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>046807193F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1745295679</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0472357455000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1916105813</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100CFED93F181AB6B40725F12D7</code> <code>B6A6E0E70BE09B348C68F428DE03D995</code> <code>276828B48AB2FF0D360739CE45D4A1A7</code> <code>4FA838C029C6FDE2AEC24076D4AE4DB9</code> <code>92636B0379965FA3CA85044238263EA0</code> <code>514066045CABCAEC49E332776A3D8D9F</code> <code>D1FEFA007379E19E97A75DCC71F3D9D7</code> <code>A1DCAA04C7DEA9EC1CA6AD36F85A4460</code> <code>96A90F750B4432ADD6B70AE3C943E56C</code> <code>B98D4BF6A65FE5BE8D7AB471697DD3E1</code> <code>9F2724393730162ACC31F23D2C312E2F</code> <code>C4D58530D165C5C815643D39333ADDF9</code> <code>1E477A66F227ED54680E6FBF80755E0F</code> <code>DF4E4D81E17B5B43D2AB4398F43E8A4B</code> <code>D2712F215D84074128CEBFB49819F399</code> <code>05C8560FACB1AB876413EDB856EB865F</code><br> <code>76F35411</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F8 C1 8B 17 BA BA 68
0010 | 78 02 00 00 5C 07 E8 D0 C7 D2 AE E4 84 B4 46 8F
0020 | A2 72 1C 15 B6 4D 35 EC 1E D4 52 22 A6 E9 B6 18
0030 | D3 A7 34 F9 5B C0 03 6D FE 50 02 00 19 B5 07 BD
0040 | 63 5B 50 BB 2B DB FE 9F 93 B2 60 28 28 EC 05 0F
0050 | 4F EC 95 DE C1 EE CB BA 01 7D 2E AE FE BB E3 72
0060 | 43 63 FA 80 4E 29 B0 03 96 0E 16 6F 5F AF D2 FA
0070 | 1B 6F 17 7C 0C BD 44 36 82 83 F3 4D E1 0D 6D DB
0080 | 3D F1 AC F8 62 30 05 23 71 8F 5B 04 46 DA 74 55
0090 | 15 FE 3D E7 07 3D 27 EA AA CA B9 EF 4E E1 8B 84
00A0 | 1C 1E 7D 63 B2 36 BE DC B7 FF 34 B1 1B 64 CB 58
00B0 | 14 D9 B2 30 4D 38 29 34 40 14 90 45 AD E0 EF 60
00C0 | DD 5B FC 1E 00 87 12 30 12 82 E2 55 D6 2A 3B 27
00D0 | EB 22 6D 55 C6 35 EF A8 00 FB 26 DA 34 57 27 D7
00E0 | B7 8D 28 07 4B 1C 8E F9 DB 08 95 0A 15 4E 84 AF
00F0 | 49 36 92 81 F2 28 67 06 7F F6 A2 5A AC 86 71 CA
0100 | 42 27 A7 5D 64 47 87 0F 2F C7 9C 2C 02 9F 65 57
0110 | F4 BC 4D 66 AF 08 71 E5 55 DC D5 6B 44 DC 69 BB
0120 | 01 54 E4 7F AA 0C 26 A0 DC 9C 8D 4A DB 41 E8 90
0130 | D8 54 8A 75 02 E0 0F 63 9D 77 AC 8F 7A 27 25 E2
0140 | DC B3 90 91 E2 19 01 E4 53 78 8D DC 7E 61 B8 D0
0150 | 77 7D 14 72 A5 93 9A 2E 0B F4 DB F3 E3 19 98 9C
0160 | 58 B7 EA B5 74 77 A5 25 18 47 23 83 CC E4 C2 38
0170 | C5 6A C9 B3 85 99 6C BC EB 43 D6 D6 2D 6D 03 82
0180 | 28 00 90 30 3F A6 9C 0B A8 2D F9 80 CA A2 A5 18
0190 | 15 F8 C5 72 06 34 56 0B DC 89 6B 83 3A EC C6 07
01A0 | 9E EF EC 7A 4B 15 67 AF 86 E0 DA 59 F6 2E A7 52
01B0 | 5F 33 93 E9 F3 C2 AA 41 FD 76 1B 1C 3A 94 4C 22
01C0 | 94 3B D3 C6 81 31 68 E3 7A FE D9 AE AB CC 34 50
01D0 | 9D E5 04 8C F7 38 47 D4 45 A3 37 F8 AF A9 00 D3
01E0 | 72 B0 4A 02 27 45 5E 61 D7 96 F4 EE 7E B2 81 63
01F0 | D9 C1 AB D4 BC DC DA C8 A2 AC B0 8D C4 EA 80 67
0200 | 09 1E 32 E2 1C 21 A1 E2 DA 99 21 89 E3 C5 A0 30
0210 | 92 EA 96 FC C0 42 5C C2 1D C8 81 6A AE 2E C2 93
0220 | BA B6 F7 EB 25 C7 CB 44 84 9D 9F 9C 0C D4 BB 58
0230 | DB 53 2B A3 94 8E 67 2D A5 C2 F4 8C 9C 1E DF 72
0240 | 57 F2 79 76 1A B8 C5 09 35 93 C5 14 F6 53 CA 7A
0250 | E4 4B EB 5B 1A 4A FB 53 43 2E 72 25 CC 3F 5B A5
0260 | 9C 44 C3 BE 12 52 DE C0 73 E3 27 78 8A A1 D5 4E
0270 | C4 83 C3 1E F0 B4 3F 9B 46 14 57 D5 E7 56 42 04
0280 | EF DF D5 49 B7 2B 4D 4B 76 94 3F B8</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F8C18B17BABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020019B507BD635B50BB2BDBFE9F</code> <code>93B2602828EC050F4FEC95DEC1EECBBA</code> <code>017D2EAEFEBBE3724363FA804E29B003</code> <code>960E166F5FAFD2FA1B6F177C0CBD4436</code> <code>8283F34DE10D6DDB3DF1ACF862300523</code> <code>718F5B0446DA745515FE3DE7073D27EA</code> <code>AACAB9EF4EE18B841C1E7D63B236BEDC</code> <code>B7FF34B11B64CB5814D9B2304D382934</code> <code>40149045ADE0EF60DD5BFC1E00871230</code> <code>1282E255D62A3B27EB226D55C635EFA8</code> <code>00FB26DA345727D7B78D28074B1C8EF9</code> <code>DB08950A154E84AF49369281F2286706</code> <code>7FF6A25AAC8671CA4227A75D6447870F</code> <code>2FC79C2C029F6557F4BC4D66AF0871E5</code> <code>55DCD56B44DC69BB0154E47FAA0C26A0</code> <code>DC9C8D4ADB41E890D8548A7502E00F63</code> <code>9D77AC8F7A2725E2DCB39091E21901E4</code> <code>53788DDC7E61B8D0777D1472A5939A2E</code> <code>0BF4DBF3E319989C58B7EAB57477A525</code> <code>18472383CCE4C238C56AC9B385996CBC</code> <code>EB43D6D62D6D0382280090303FA69C0B</code> <code>A82DF980CAA2A51815F8C5720634560B</code> <code>DC896B833AECC6079EEFEC7A4B1567AF</code> <code>86E0DA59F62EA7525F3393E9F3C2AA41</code> <code>FD761B1C3A944C22943BD3C6813168E3</code> <code>7AFED9AEABCC34509DE5048CF73847D4</code> <code>45A337F8AFA900D372B04A0227455E61</code> <code>D796F4EE7EB28163D9C1ABD4BCDCDAC8</code> <code>A2ACB08DC4EA8067091E32E21C21A1E2</code> <code>DA992189E3C5A03092EA96FCC0425CC2</code> <code>1DC8816AAE2EC293BAB6F7EB25C7CB44</code> <code>849D9F9C0CD4BB58DB532BA3948E672D</code> <code>A5C2F48C9C1EDF7257F279761AB8C509</code> <code>3593C514F653CA7AE44BEB5B1A4AFB53</code> <code>432E7225CC3F5BA59C44C3BE1252DEC0</code> <code>73E327788AA1D54EC483C31EF0B43F9B</code> <code>461457D5E7564204EFDFD549B72B4D4B</code><br> <code>76943FB8</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 19B507BD635B50BB2BDBFE9F93B2602828EC050F4FEC95DEC1EECBBA017D2EAEFEBBE3724363FA804E29B003960E166F5FAFD2FA1B6F177C0CBD44368283F34DE10D6DDB3DF1ACF862300523718F5B0446DA745515FE3DE7073D27EAAACAB9EF4EE18B841C1E7D63B236BEDCB7FF34B11B64CB5814D9B2304D38293440149045ADE0EF60DD5BFC1E008712301282E255D62A3B27EB226D55C635EFA800FB26DA345727D7B78D28074B1C8EF9DB08950A154E84AF49369281F22867067FF6A25AAC8671CA4227A75D6447870F2FC79C2C029F6557F4BC4D66AF0871E555DCD56B44DC69BB0154E47FAA0C26A0DC9C8D4ADB41E890D8548A7502E00F639D77AC8F7A2725E2DCB39091E21901E453788DDC7E61B8D0777D1472A5939A2E0BF4DBF3E319989C58B7EAB57477A52518472383CCE4C238C56AC9B385996CBCEB43D6D62D6D0382280090303FA69C0BA82DF980CAA2A51815F8C5720634560BDC896B833AECC6079EEFEC7A4B1567AF86E0DA59F62EA7525F3393E9F3C2AA41FD761B1C3A944C22943BD3C6813168E37AFED9AEABCC34509DE5048CF73847D445A337F8AFA900D372B04A0227455E61D796F4EE7EB28163D9C1ABD4BCDCDAC8A2ACB08DC4EA8067091E32E21C21A1E2DA992189E3C5A03092EA96FCC0425CC21DC8816AAE2EC293BAB6F7EB25C7CB44849D9F9C0CD4BB58DB532BA3948E672DA5C2F48C9C1EDF7257F279761AB8C5093593C514F653CA7AE44BEB5B1A4AFB53432E7225CC3F5BA59C44C3BE1252DEC073E327788AA1D54EC483C31EF0B43F9B461457D5E7564204EFDFD549B72B4D4B76943FB8
tmp_aes_key = 310471DBCD2ECFF4EC8A92CC7E689E1FC5D10F8068C462A497B4013C85D94BD6
tmp_aes_iv = 2269D8A25B2574C0ADBEA945EF46F32AEA1C02D41EBD5D6F80F3884E01C0FA0C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 19232BAD277BEACD0776445D617678592E00ED55BA0D89B5C7D2AEE484B4468FA2721C15B64D35EC1ED45222A6E9B618D3A734F95BC0036D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BF80853806903AA502BB390AE4839042B495A5A5814A1A3B027FA1D531C2D3384D835262D2DF9F113B2FE71B06A3258734869EFDDAB20BEF343C431B1FBDB734CAB47A643A12600446A0CC440899172C42786C8CE305B04D68D94504FC2E6FCEF2F7EECC5A340D14B6650F3F9471326689D3350B6686A18C0571C57D38467CD59110DED863096F76B4E4883F14705E0D4BCD53E1F1949C3B5B3310CE67BE99322DCC8B02186A0AB4848A0C85BF3DC1F8E9D78E3226B072F801E18AB6F1EAE3E645CD4949CD10525FCC59718F065C921066E02CB20BCD0DD1E239A6A3BED2193BA9D1DE73E8C2BE395EA9BC59E1D2E82C710CCE5A94545C63A50C758044F6FADE17BABA68781F3AA29F4ADA2D
answer = BA0D89B5C7D2AEE484B4468FA2721C15B64D35EC1ED45222A6E9B618D3A734F95BC0036D03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100BF80853806903AA502BB390AE4839042B495A5A5814A1A3B027FA1D531C2D3384D835262D2DF9F113B2FE71B06A3258734869EFDDAB20BEF343C431B1FBDB734CAB47A643A12600446A0CC440899172C42786C8CE305B04D68D94504FC2E6FCEF2F7EECC5A340D14B6650F3F9471326689D3350B6686A18C0571C57D38467CD59110DED863096F76B4E4883F14705E0D4BCD53E1F1949C3B5B3310CE67BE99322DCC8B02186A0AB4848A0C85BF3DC1F8E9D78E3226B072F801E18AB6F1EAE3E645CD4949CD10525FCC59718F065C921066E02CB20BCD0DD1E239A6A3BED2193BA9D1DE73E8C2BE395EA9BC59E1D2E82C710CCE5A94545C63A50C758044F6FADE17BABA68781F3AA29F4ADA2D</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 C7 D2 AE E4 84 B4 46 8F A2 72 1C 15
0010 | B6 4D 35 EC 1E D4 52 22 A6 E9 B6 18 D3 A7 34 F9
0020 | 5B C0 03 6D 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | BF 80 85 38 06 90 3A A5 02 BB 39 0A E4 83 90 42
0140 | B4 95 A5 A5 81 4A 1A 3B 02 7F A1 D5 31 C2 D3 38
0150 | 4D 83 52 62 D2 DF 9F 11 3B 2F E7 1B 06 A3 25 87
0160 | 34 86 9E FD DA B2 0B EF 34 3C 43 1B 1F BD B7 34
0170 | CA B4 7A 64 3A 12 60 04 46 A0 CC 44 08 99 17 2C
0180 | 42 78 6C 8C E3 05 B0 4D 68 D9 45 04 FC 2E 6F CE
0190 | F2 F7 EE CC 5A 34 0D 14 B6 65 0F 3F 94 71 32 66
01A0 | 89 D3 35 0B 66 86 A1 8C 05 71 C5 7D 38 46 7C D5
01B0 | 91 10 DE D8 63 09 6F 76 B4 E4 88 3F 14 70 5E 0D
01C0 | 4B CD 53 E1 F1 94 9C 3B 5B 33 10 CE 67 BE 99 32
01D0 | 2D CC 8B 02 18 6A 0A B4 84 8A 0C 85 BF 3D C1 F8
01E0 | E9 D7 8E 32 26 B0 72 F8 01 E1 8A B6 F1 EA E3 E6
01F0 | 45 CD 49 49 CD 10 52 5F CC 59 71 8F 06 5C 92 10
0200 | 66 E0 2C B2 0B CD 0D D1 E2 39 A6 A3 BE D2 19 3B
0210 | A9 D1 DE 73 E8 C2 BE 39 5E A9 BC 59 E1 D2 E8 2C
0220 | 71 0C CE 5A 94 54 5C 63 A5 0C 75 80 44 F6 FA DE
0230 | 17 BA BA 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100BF80853806903AA502BB390A</code> <code>E4839042B495A5A5814A1A3B027FA1D5</code> <code>31C2D3384D835262D2DF9F113B2FE71B</code> <code>06A3258734869EFDDAB20BEF343C431B</code> <code>1FBDB734CAB47A643A12600446A0CC44</code> <code>0899172C42786C8CE305B04D68D94504</code> <code>FC2E6FCEF2F7EECC5A340D14B6650F3F</code> <code>9471326689D3350B6686A18C0571C57D</code> <code>38467CD59110DED863096F76B4E4883F</code> <code>14705E0D4BCD53E1F1949C3B5B3310CE</code> <code>67BE99322DCC8B02186A0AB4848A0C85</code> <code>BF3DC1F8E9D78E3226B072F801E18AB6</code> <code>F1EAE3E645CD4949CD10525FCC59718F</code> <code>065C921066E02CB20BCD0DD1E239A6A3</code> <code>BED2193BA9D1DE73E8C2BE395EA9BC59</code> <code>E1D2E82C710CCE5A94545C63A50C7580</code><br> <code>44F6FADE</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>17BABA68</code> (1757067799 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 09A58E9188815D8F96D372AF1EF3E0F21B1BC308C9B03CCEBA37D8B668CF6A0E14A14AAFE21D558E45C0B6A3738D5C1E53D3A7BCC749FBC6BE4805BC058FC3F64ED34754DD4A0136A4E4B20575CAFBE0D4BF72B5B62A503A4148C0B00A4347ADB61BD5E573324C2BB6B22C525D04A4897D7CAE5B5E0373A848D32D0B9BC4E7F59A6415A2A99AC7326776E2E777745F889059D3567FED9B2C7A9F316D5197ADD64A59C78F29C33A124546861E9FC5A70A6852F03B59AEE87C7A6F250D05FF77130D38432D32EA8074A7E0F3E263CFA8E2784B711A9F67D7A391C0A4FA4A8436393494C3E4754E0EEC34912A8FBDBC5BDCE17CD16CC52111F370A492BDF67081B7</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 65F2E707A9EE4305F164BCD9EFB17AF0C959BAD8049C548A10E2C795ADA32C543FA7734A5222A4A584B1014EED6C1D152ACE5D1D03C6EFEDCF096A23D0E360B7A1D2AD39348D583280E29024C781F70DA266583B246D3DB9CCB3C10E36D050E5318A0E9DB62FA12167BDC8BC9D06E90B4B2B770924768511ED2112B3AC1085865F0AA289473E61FC1260D66E90364A2E8D0992CB541211203696D7C247BB878AB62BCF237F03CC19B1AEC8C2B30C3AA9D86B0F97148F37D3A4351C9512A924390E01F1B491D9E7399D15CBDD1A0833F2889DC5544FABE60AD53715CC1F2659AD794D8AFEF9AB9F19691A3EC9EB6AF3B7CD52AD90ECF95346704BBC162DCA8D3B</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 C7 D2 AE E4 84 B4 46 8F A2 72 1C 15
0010 | B6 4D 35 EC 1E D4 52 22 A6 E9 B6 18 D3 A7 34 F9
0020 | 5B C0 03 6D 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 65 F2 E7 07 A9 EE 43 05 F1 64 BC D9 EF B1 7A F0
0040 | C9 59 BA D8 04 9C 54 8A 10 E2 C7 95 AD A3 2C 54
0050 | 3F A7 73 4A 52 22 A4 A5 84 B1 01 4E ED 6C 1D 15
0060 | 2A CE 5D 1D 03 C6 EF ED CF 09 6A 23 D0 E3 60 B7
0070 | A1 D2 AD 39 34 8D 58 32 80 E2 90 24 C7 81 F7 0D
0080 | A2 66 58 3B 24 6D 3D B9 CC B3 C1 0E 36 D0 50 E5
0090 | 31 8A 0E 9D B6 2F A1 21 67 BD C8 BC 9D 06 E9 0B
00A0 | 4B 2B 77 09 24 76 85 11 ED 21 12 B3 AC 10 85 86
00B0 | 5F 0A A2 89 47 3E 61 FC 12 60 D6 6E 90 36 4A 2E
00C0 | 8D 09 92 CB 54 12 11 20 36 96 D7 C2 47 BB 87 8A
00D0 | B6 2B CF 23 7F 03 CC 19 B1 AE C8 C2 B3 0C 3A A9
00E0 | D8 6B 0F 97 14 8F 37 D3 A4 35 1C 95 12 A9 24 39
00F0 | 0E 01 F1 B4 91 D9 E7 39 9D 15 CB DD 1A 08 33 F2
0100 | 88 9D C5 54 4F AB E6 0A D5 37 15 CC 1F 26 59 AD
0110 | 79 4D 8A FE F9 AB 9F 19 69 1A 3E C9 EB 6A F3 B7
0120 | CD 52 AD 90 EC F9 53 46 70 4B BC 16 2D CA 8D 3B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010065F2E707A9EE4305F164BCD9</code> <code>EFB17AF0C959BAD8049C548A10E2C795</code> <code>ADA32C543FA7734A5222A4A584B1014E</code> <code>ED6C1D152ACE5D1D03C6EFEDCF096A23</code> <code>D0E360B7A1D2AD39348D583280E29024</code> <code>C781F70DA266583B246D3DB9CCB3C10E</code> <code>36D050E5318A0E9DB62FA12167BDC8BC</code> <code>9D06E90B4B2B770924768511ED2112B3</code> <code>AC1085865F0AA289473E61FC1260D66E</code> <code>90364A2E8D0992CB541211203696D7C2</code> <code>47BB878AB62BCF237F03CC19B1AEC8C2</code> <code>B30C3AA9D86B0F97148F37D3A4351C95</code> <code>12A924390E01F1B491D9E7399D15CBDD</code> <code>1A0833F2889DC5544FABE60AD53715CC</code> <code>1F2659AD794D8AFEF9AB9F19691A3EC9</code> <code>EB6AF3B7CD52AD90ECF95346704BBC16</code><br> <code>2DCA8D3B</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366C7D2AEE484B4468FA2721C15B64D35EC1ED45222A6E9B618D3A734F95BC0036D0000000000000000FE00010065F2E707A9EE4305F164BCD9EFB17AF0C959BAD8049C548A10E2C795ADA32C543FA7734A5222A4A584B1014EED6C1D152ACE5D1D03C6EFEDCF096A23D0E360B7A1D2AD39348D583280E29024C781F70DA266583B246D3DB9CCB3C10E36D050E5318A0E9DB62FA12167BDC8BC9D06E90B4B2B770924768511ED2112B3AC1085865F0AA289473E61FC1260D66E90364A2E8D0992CB541211203696D7C247BB878AB62BCF237F03CC19B1AEC8C2B30C3AA9D86B0F97148F37D3A4351C9512A924390E01F1B491D9E7399D15CBDD1A0833F2889DC5544FABE60AD53715CC1F2659AD794D8AFEF9AB9F19691A3EC9EB6AF3B7CD52AD90ECF95346704BBC162DCA8D3B
padding = 9ECF9D4C75AB98DB31D9A24E
tmp_aes_key = 310471DBCD2ECFF4EC8A92CC7E689E1FC5D10F8068C462A497B4013C85D94BD6
tmp_aes_iv = 2269D8A25B2574C0ADBEA945EF46F32AEA1C02D41EBD5D6F80F3884E01C0FA0C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 0739D2D1755FDD987C21FD31DCFAB596AF7CB6793466950E5C7C63787EEDDD81ADCCE37F5AD2369538DD319DD72D1B76C34F4585531CB6A976B66F1C61C8DA6FE2B1DD66FD9A8BCE0816475CCAC9BA4C89908F6DA1CED1CC4B1B55B3A5B5A644D0A7E6EDDD93D113482F5C08A76FCC0230212FF51A56094AB08FC9494944F1F73560138BB7D407527B1895CCC8DBEB29BD65C402225A9ED393C63B88DB3CE41540A00485A4A871B2638BF4BEE13F59526F27075E4B58D90143C320A9A6EEBF38B4079F260B9D87982B56BCD5B7BB6DC2635BB5371CD3BE4556BF40957257A81BC39432EC2E09C3EAF73C55AFC99B75DEFE304FA77A6AA1CC8D93CA3AF11F5C85E01FB9FBAB6F3A73E8535F101BFE5C74C264CB053366BB7B975C817DECFDF844A6BF07D26167A45DEFC4DF886B1E1954A3A66D5000B6FA5E54996D463F49CE2A5E2731432CA0258FDDB00DD5D7829E4C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 40 96 0D 00 17 BA BA 68
0010 | 78 01 00 00 1F 5F 04 F5 C7 D2 AE E4 84 B4 46 8F
0020 | A2 72 1C 15 B6 4D 35 EC 1E D4 52 22 A6 E9 B6 18
0030 | D3 A7 34 F9 5B C0 03 6D FE 50 01 00 07 39 D2 D1
0040 | 75 5F DD 98 7C 21 FD 31 DC FA B5 96 AF 7C B6 79
0050 | 34 66 95 0E 5C 7C 63 78 7E ED DD 81 AD CC E3 7F
0060 | 5A D2 36 95 38 DD 31 9D D7 2D 1B 76 C3 4F 45 85
0070 | 53 1C B6 A9 76 B6 6F 1C 61 C8 DA 6F E2 B1 DD 66
0080 | FD 9A 8B CE 08 16 47 5C CA C9 BA 4C 89 90 8F 6D
0090 | A1 CE D1 CC 4B 1B 55 B3 A5 B5 A6 44 D0 A7 E6 ED
00A0 | DD 93 D1 13 48 2F 5C 08 A7 6F CC 02 30 21 2F F5
00B0 | 1A 56 09 4A B0 8F C9 49 49 44 F1 F7 35 60 13 8B
00C0 | B7 D4 07 52 7B 18 95 CC C8 DB EB 29 BD 65 C4 02
00D0 | 22 5A 9E D3 93 C6 3B 88 DB 3C E4 15 40 A0 04 85
00E0 | A4 A8 71 B2 63 8B F4 BE E1 3F 59 52 6F 27 07 5E
00F0 | 4B 58 D9 01 43 C3 20 A9 A6 EE BF 38 B4 07 9F 26
0100 | 0B 9D 87 98 2B 56 BC D5 B7 BB 6D C2 63 5B B5 37
0110 | 1C D3 BE 45 56 BF 40 95 72 57 A8 1B C3 94 32 EC
0120 | 2E 09 C3 EA F7 3C 55 AF C9 9B 75 DE FE 30 4F A7
0130 | 7A 6A A1 CC 8D 93 CA 3A F1 1F 5C 85 E0 1F B9 FB
0140 | AB 6F 3A 73 E8 53 5F 10 1B FE 5C 74 C2 64 CB 05
0150 | 33 66 BB 7B 97 5C 81 7D EC FD F8 44 A6 BF 07 D2
0160 | 61 67 A4 5D EF C4 DF 88 6B 1E 19 54 A3 A6 6D 50
0170 | 00 B6 FA 5E 54 99 6D 46 3F 49 CE 2A 5E 27 31 43
0180 | 2C A0 25 8F DD B0 0D D5 D7 82 9E 4C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>40960D0017BABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001000739D2D1755FDD987C21FD31</code> <code>DCFAB596AF7CB6793466950E5C7C6378</code> <code>7EEDDD81ADCCE37F5AD2369538DD319D</code> <code>D72D1B76C34F4585531CB6A976B66F1C</code> <code>61C8DA6FE2B1DD66FD9A8BCE0816475C</code> <code>CAC9BA4C89908F6DA1CED1CC4B1B55B3</code> <code>A5B5A644D0A7E6EDDD93D113482F5C08</code> <code>A76FCC0230212FF51A56094AB08FC949</code> <code>4944F1F73560138BB7D407527B1895CC</code> <code>C8DBEB29BD65C402225A9ED393C63B88</code> <code>DB3CE41540A00485A4A871B2638BF4BE</code> <code>E13F59526F27075E4B58D90143C320A9</code> <code>A6EEBF38B4079F260B9D87982B56BCD5</code> <code>B7BB6DC2635BB5371CD3BE4556BF4095</code> <code>7257A81BC39432EC2E09C3EAF73C55AF</code> <code>C99B75DEFE304FA77A6AA1CC8D93CA3A</code> <code>F11F5C85E01FB9FBAB6F3A73E8535F10</code> <code>1BFE5C74C264CB053366BB7B975C817D</code> <code>ECFDF844A6BF07D26167A45DEFC4DF88</code> <code>6B1E1954A3A66D5000B6FA5E54996D46</code> <code>3F49CE2A5E2731432CA0258FDDB00DD5</code><br> <code>D7829E4C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 2B86A18ECDC619EF7F3928452E6AD35AEAB3547A313EBF4A44FEB855618AD88A04EAC2D23806A761CFD2ECC4C4ED80CFB0E0786E2306D7053C660C46BB3DDFF56F059EC214ACBF9360582D053F0B8942890249E075B7150B5709CC8D9BDB9F6346D3A06C4F4FFE89E83625EE199012DA00DFEC17956D3A7CF6731EE9BF2718FFBD2EDAAAF1D48659D4B21F411D00DBD14E89D6004981293B54853CCF22DB55A7F1DCCCFFC07134D72FA5162BF70250EB37E1A543C2AA3CC3E8E44C51F48D569555D967CF136CC241E5444A5BA7085545C576DDE2DCDF204119E1064EBB44714BAF6ED76DAF62213312E89EE348C05A607CDBE78009AEC9841E0277F9FAEC14BF</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 78 A7 2C 19 BA BA 68
0010 | 34 00 00 00 34 F7 CB 3B C7 D2 AE E4 84 B4 46 8F
0020 | A2 72 1C 15 B6 4D 35 EC 1E D4 52 22 A6 E9 B6 18
0030 | D3 A7 34 F9 5B C0 03 6D 2B F8 E2 D5 9D 05 B0 F3
0040 | 67 7B E6 20 E3 0E 48 A6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0178A72C19BABA68</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>C7D2AEE484B4468FA2721C15B64D35EC</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>1ED45222A6E9B618D3A734F95BC0036D</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>2BF8E2D59D05B0F3677BE620E30E48A6</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

