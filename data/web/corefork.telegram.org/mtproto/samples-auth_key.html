<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?241" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 21 0A 00 14 F2 38 67
0010 | 14 00 00 00 F1 8E 7E BE 0D 1E B7 61 57 B6 4B 8F
0020 | 20 91 88 B1 83 EC 04 59</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A8210A0014F23867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B8 A4 ED 14 F2 38 67
0010 | 50 00 00 00 63 24 16 05 0D 1E B7 61 57 B6 4B 8F
0020 | 20 91 88 B1 83 EC 04 59 DF 52 E6 6A DD D8 4F 0E
0030 | 58 80 62 48 74 AB D2 BC 08 13 F8 B0 B1 D2 08 A5
0040 | FD 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B8A4ED14F23867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0813F8B0B1D208A5FD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1439094358724355581</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1439094358724355581</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1439094358724355581 = 1050997513 * 1369265237</code></p>
<pre><code>p = 1050997513
q = 1369265237</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 13 F8 B0 B1 D2 08 A5 FD 00 00 00
0010 | 04 3E A4 F3 09 00 00 00 04 51 9D 54 55 00 00 00
0020 | 0D 1E B7 61 57 B6 4B 8F 20 91 88 B1 83 EC 04 59
0030 | DF 52 E6 6A DD D8 4F 0E 58 80 62 48 74 AB D2 BC
0040 | DB 8C 4D 4C 17 5A 9C CA 09 B2 12 C4 F2 95 72 F4
0050 | EA 4D 78 CA 8C ED 3E E9 23 E4 68 2C B2 2F D8 BB
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0813F8B0B1D208A5FD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1439094358724355581</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043EA4F309000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1050997513</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04519D5455000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1369265237</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>DB8C4D4C175A9CCA09B212C4F29572F4</code> <code>EA4D78CA8CED3EE923E4682CB22FD8BB</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90813F8B0B1D208A5FD000000043EA4F30900000004519D54550000000D1EB76157B64B8F209188B183EC0459DF52E66ADDD84F0E5880624874ABD2BCDB8C4D4C175A9CCA09B212C4F29572F4EA4D78CA8CED3EE923E4682CB22FD8BB02000000
random_padding_bytes = D70968F51FBA9C879DC15B15FE24CC32F2C062AB3C7E78CB7F62836B4B23AB345BC2BFB7BEC9B7EF22DC48BA2B95E0DF50DB5318363B21937B1DB7C8638DF580F7566EA8EADE583E3526A940D8222E311C21536DA369B6E57A2DB4F0</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = A0145CF8D19B24699CEB3B08C2344540E0516960E34089DBEC80F9ED5E51D4D14E098DACF61539ABEF4DA71005694E751A0462E7089FEA68AE89F0AD17DAE674F98726EC215CC84DAF3A03288ABDBD3927E082D6FEAC3C74C87D579671A5F1ACD43B90992C04E384C2BF068296C9E4948171003739E590DE88CCADE0DED650059EAE2C39A5EB806D39E1FA0029759E739682C97249734501032FFDAEDF1620745F94ED30A113717F9E116BFCA812234E1E4AE764ADB3345EDFB8409196C7E57B33E8F8AF561B933BB15506F745E378D06FDC3A040E593C39FB88C5EDB861591767BA0CABE0B8772A3597EB50EF522859C17BDB92D95F76CB1214F8E95AD0A368</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 AC 21 0A 00 14 F2 38 67
0010 | 40 01 00 00 BE E4 12 D7 0D 1E B7 61 57 B6 4B 8F
0020 | 20 91 88 B1 83 EC 04 59 DF 52 E6 6A DD D8 4F 0E
0030 | 58 80 62 48 74 AB D2 BC 04 3E A4 F3 09 00 00 00
0040 | 04 51 9D 54 55 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 A0 14 5C F8 D1 9B 24 69 9C EB 3B 08
0060 | C2 34 45 40 E0 51 69 60 E3 40 89 DB EC 80 F9 ED
0070 | 5E 51 D4 D1 4E 09 8D AC F6 15 39 AB EF 4D A7 10
0080 | 05 69 4E 75 1A 04 62 E7 08 9F EA 68 AE 89 F0 AD
0090 | 17 DA E6 74 F9 87 26 EC 21 5C C8 4D AF 3A 03 28
00A0 | 8A BD BD 39 27 E0 82 D6 FE AC 3C 74 C8 7D 57 96
00B0 | 71 A5 F1 AC D4 3B 90 99 2C 04 E3 84 C2 BF 06 82
00C0 | 96 C9 E4 94 81 71 00 37 39 E5 90 DE 88 CC AD E0
00D0 | DE D6 50 05 9E AE 2C 39 A5 EB 80 6D 39 E1 FA 00
00E0 | 29 75 9E 73 96 82 C9 72 49 73 45 01 03 2F FD AE
00F0 | DF 16 20 74 5F 94 ED 30 A1 13 71 7F 9E 11 6B FC
0100 | A8 12 23 4E 1E 4A E7 64 AD B3 34 5E DF B8 40 91
0110 | 96 C7 E5 7B 33 E8 F8 AF 56 1B 93 3B B1 55 06 F7
0120 | 45 E3 78 D0 6F DC 3A 04 0E 59 3C 39 FB 88 C5 ED
0130 | B8 61 59 17 67 BA 0C AB E0 B8 77 2A 35 97 EB 50
0140 | EF 52 28 59 C1 7B DB 92 D9 5F 76 CB 12 14 F8 E9
0150 | 5A D0 A3 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>AC210A0014F23867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043EA4F309000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1050997513</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04519D5455000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1369265237</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100A0145CF8D19B24699CEB3B08</code> <code>C2344540E0516960E34089DBEC80F9ED</code> <code>5E51D4D14E098DACF61539ABEF4DA710</code> <code>05694E751A0462E7089FEA68AE89F0AD</code> <code>17DAE674F98726EC215CC84DAF3A0328</code> <code>8ABDBD3927E082D6FEAC3C74C87D5796</code> <code>71A5F1ACD43B90992C04E384C2BF0682</code> <code>96C9E4948171003739E590DE88CCADE0</code> <code>DED650059EAE2C39A5EB806D39E1FA00</code> <code>29759E739682C97249734501032FFDAE</code> <code>DF1620745F94ED30A113717F9E116BFC</code> <code>A812234E1E4AE764ADB3345EDFB84091</code> <code>96C7E57B33E8F8AF561B933BB15506F7</code> <code>45E378D06FDC3A040E593C39FB88C5ED</code> <code>B861591767BA0CABE0B8772A3597EB50</code> <code>EF522859C17BDB92D95F76CB1214F8E9</code><br> <code>5AD0A368</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 19 0A 15 F2 38 67
0010 | 78 02 00 00 5C 07 E8 D0 0D 1E B7 61 57 B6 4B 8F
0020 | 20 91 88 B1 83 EC 04 59 DF 52 E6 6A DD D8 4F 0E
0030 | 58 80 62 48 74 AB D2 BC FE 50 02 00 B3 0B B9 E5
0040 | 43 36 0F D1 A1 76 54 A4 82 D9 9C 76 8C E6 2B D4
0050 | 54 5B 51 1D 60 CA 69 A2 67 0F B9 96 40 20 BB 18
0060 | 2F 33 1B E7 06 55 2D 4F F1 88 C4 AA 3C CF ED BC
0070 | C8 74 E8 90 B9 BA 63 74 03 16 03 AB FA AF FB 7B
0080 | CA 73 F4 E0 A0 D2 E3 82 1C A1 1C E3 97 EA 7A 07
0090 | 73 05 A8 F4 51 4B 26 26 74 89 CB 05 31 50 95 D4
00A0 | 34 FE BB 84 59 C5 72 88 E7 62 05 AA 57 2F 84 E0
00B0 | 9B DA EB B9 A2 02 A9 A0 85 9C 6F A6 42 3F 5F EA
00C0 | C4 34 5E D0 70 C2 17 1B 22 F0 59 9D 55 F8 58 86
00D0 | DE 6B 1D 49 BB EB 78 3E 72 7A 38 5C 7C 08 C9 35
00E0 | 5A 4F 99 31 C1 D0 ED 1E CA A3 FB AC 27 9A 3B 5A
00F0 | 9E 5C D9 43 46 31 41 75 66 D9 6C 36 F4 EC 3D 2E
0100 | E1 03 30 25 36 44 C2 DF 48 3D AA AE A4 05 75 BD
0110 | ED 76 71 17 72 CC C0 B3 D2 78 C8 13 BE 63 76 5C
0120 | 7D E7 08 95 5F 3D 47 0B 62 1B 78 D2 47 9C 19 9F
0130 | C1 A1 0B 05 21 FC 14 3A EE 08 80 8D BB 30 86 79
0140 | 92 6D 80 65 8E 02 FA D9 D9 4D 28 B8 4C 1E 30 57
0150 | D9 B6 35 F3 63 3F C1 86 13 40 7D 7D 3A 58 7D FE
0160 | C5 FF 15 F8 64 8F 3B 32 25 85 81 B6 B0 BB 65 9D
0170 | E3 0F 63 2B 72 22 A8 A8 34 E8 4A EA A9 58 C1 E0
0180 | DD C3 98 FD 24 47 E8 56 AC 1C 85 B3 93 B9 8E 9F
0190 | 6C E7 D6 8E 34 1F 26 35 76 04 0A E2 63 44 26 63
01A0 | D6 9A A0 9B 9D 0C AC C5 0E 20 25 30 97 DB 34 2A
01B0 | DE A7 09 86 87 0C A0 38 95 98 9D 6A B7 97 88 C1
01C0 | EB DF 1C B7 0A 1B A0 3E 6E 9C F3 79 13 96 A7 B2
01D0 | 8D AE 7F 2A 70 DA 26 7B 68 D5 E9 3A 3D FC 25 BB
01E0 | B5 50 0E 3C 14 F0 B9 AE 9F 08 5B 73 25 5D A4 49
01F0 | DD 59 3E 15 9B 0D 14 29 4B 0D B1 93 56 70 63 84
0200 | 0A 47 67 66 B3 52 32 6E 12 75 9D 54 94 81 A3 DF
0210 | FE A6 A9 DB D0 56 B3 25 23 6E 30 00 BF C8 1E 8C
0220 | 17 91 34 14 2A C5 46 92 BB DC 7C 3C A0 09 A9 E4
0230 | 97 0B 7A C5 FC F9 71 8E 6D 0A 5B B5 D1 7C 79 93
0240 | 1E C0 35 6F 77 74 B4 F9 CD 67 27 63 3E A2 94 A5
0250 | 8D F8 B8 CE 59 1B FE 47 79 F0 90 BC 8F D8 37 54
0260 | 15 6C 9E 97 9D 0A CB 67 E9 C3 6C F5 39 A4 04 47
0270 | 80 C0 9C 09 6D 93 89 E0 C9 41 09 23 9B 4B A6 CF
0280 | 20 66 5F 70 17 7E FB FD F7 19 0C FC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0160190A15F23867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200B30BB9E543360FD1A17654A4</code> <code>82D99C768CE62BD4545B511D60CA69A2</code> <code>670FB9964020BB182F331BE706552D4F</code> <code>F188C4AA3CCFEDBCC874E890B9BA6374</code> <code>031603ABFAAFFB7BCA73F4E0A0D2E382</code> <code>1CA11CE397EA7A077305A8F4514B2626</code> <code>7489CB05315095D434FEBB8459C57288</code> <code>E76205AA572F84E09BDAEBB9A202A9A0</code> <code>859C6FA6423F5FEAC4345ED070C2171B</code> <code>22F0599D55F85886DE6B1D49BBEB783E</code> <code>727A385C7C08C9355A4F9931C1D0ED1E</code> <code>CAA3FBAC279A3B5A9E5CD94346314175</code> <code>66D96C36F4EC3D2EE10330253644C2DF</code> <code>483DAAAEA40575BDED76711772CCC0B3</code> <code>D278C813BE63765C7DE708955F3D470B</code> <code>621B78D2479C199FC1A10B0521FC143A</code> <code>EE08808DBB308679926D80658E02FAD9</code> <code>D94D28B84C1E3057D9B635F3633FC186</code> <code>13407D7D3A587DFEC5FF15F8648F3B32</code> <code>258581B6B0BB659DE30F632B7222A8A8</code> <code>34E84AEAA958C1E0DDC398FD2447E856</code> <code>AC1C85B393B98E9F6CE7D68E341F2635</code> <code>76040AE263442663D69AA09B9D0CACC5</code> <code>0E20253097DB342ADEA70986870CA038</code> <code>95989D6AB79788C1EBDF1CB70A1BA03E</code> <code>6E9CF3791396A7B28DAE7F2A70DA267B</code> <code>68D5E93A3DFC25BBB5500E3C14F0B9AE</code> <code>9F085B73255DA449DD593E159B0D1429</code> <code>4B0DB193567063840A476766B352326E</code> <code>12759D549481A3DFFEA6A9DBD056B325</code> <code>236E3000BFC81E8C179134142AC54692</code> <code>BBDC7C3CA009A9E4970B7AC5FCF9718E</code> <code>6D0A5BB5D17C79931EC0356F7774B4F9</code> <code>CD6727633EA294A58DF8B8CE591BFE47</code> <code>79F090BC8FD83754156C9E979D0ACB67</code> <code>E9C36CF539A4044780C09C096D9389E0</code> <code>C94109239B4BA6CF20665F70177EFBFD</code><br> <code>F7190CFC</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = B30BB9E543360FD1A17654A482D99C768CE62BD4545B511D60CA69A2670FB9964020BB182F331BE706552D4FF188C4AA3CCFEDBCC874E890B9BA6374031603ABFAAFFB7BCA73F4E0A0D2E3821CA11CE397EA7A077305A8F4514B26267489CB05315095D434FEBB8459C57288E76205AA572F84E09BDAEBB9A202A9A0859C6FA6423F5FEAC4345ED070C2171B22F0599D55F85886DE6B1D49BBEB783E727A385C7C08C9355A4F9931C1D0ED1ECAA3FBAC279A3B5A9E5CD9434631417566D96C36F4EC3D2EE10330253644C2DF483DAAAEA40575BDED76711772CCC0B3D278C813BE63765C7DE708955F3D470B621B78D2479C199FC1A10B0521FC143AEE08808DBB308679926D80658E02FAD9D94D28B84C1E3057D9B635F3633FC18613407D7D3A587DFEC5FF15F8648F3B32258581B6B0BB659DE30F632B7222A8A834E84AEAA958C1E0DDC398FD2447E856AC1C85B393B98E9F6CE7D68E341F263576040AE263442663D69AA09B9D0CACC50E20253097DB342ADEA70986870CA03895989D6AB79788C1EBDF1CB70A1BA03E6E9CF3791396A7B28DAE7F2A70DA267B68D5E93A3DFC25BBB5500E3C14F0B9AE9F085B73255DA449DD593E159B0D14294B0DB193567063840A476766B352326E12759D549481A3DFFEA6A9DBD056B325236E3000BFC81E8C179134142AC54692BBDC7C3CA009A9E4970B7AC5FCF9718E6D0A5BB5D17C79931EC0356F7774B4F9CD6727633EA294A58DF8B8CE591BFE4779F090BC8FD83754156C9E979D0ACB67E9C36CF539A4044780C09C096D9389E0C94109239B4BA6CF20665F70177EFBFDF7190CFC
tmp_aes_key = 62A187C9FFC541D7A74B5C53694F4E9874B21B6219457CDF49A820BE358F425A
tmp_aes_iv = 10150B1431EE0B5129A8EB02139396AFA26A0D38C923D6D68D18D49EDB8C4D4C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 12629B876268588EB374481F16EA7F09FB6D7AB4BA0D89B50D1EB76157B64B8F209188B183EC0459DF52E66ADDD84F0E5880624874ABD2BC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100226EBFC8EE4580A0278465CAA4D135A34E9157401C31197CCD4593BABA6E553E8FABD40C8D02B79D6BFB5BE8F0AC4A0B0A83B34B067C048A486FC5D45092EDD12789E8D86FFB026A448618872AB3A372031D1D7E74AAE8681EF1C251D1551817FF59F75066557002A5AA94AF2FB3CE7A76D56463244105B50F3A2BFF0F1C897CD3F254DA4A848CEAF688D5B7901896595A45D5901921538E4BF254EC6B07E9A5D1934A765830CB2A3DB009B5D39E1D7BDDE4CE13051E5A4EDB9762E795DF98A85BF7B1D96B1429EBB74A39FCCD2C6A4AD08D44C09538C64FE29215776BA43F1A3C0F6E38D68CD8A25610A4D0AC3CE0061521782F4A3CFB054C363807D3507EAE15F23867D0D536BD780B3BBA
answer = BA0D89B50D1EB76157B64B8F209188B183EC0459DF52E66ADDD84F0E5880624874ABD2BC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100226EBFC8EE4580A0278465CAA4D135A34E9157401C31197CCD4593BABA6E553E8FABD40C8D02B79D6BFB5BE8F0AC4A0B0A83B34B067C048A486FC5D45092EDD12789E8D86FFB026A448618872AB3A372031D1D7E74AAE8681EF1C251D1551817FF59F75066557002A5AA94AF2FB3CE7A76D56463244105B50F3A2BFF0F1C897CD3F254DA4A848CEAF688D5B7901896595A45D5901921538E4BF254EC6B07E9A5D1934A765830CB2A3DB009B5D39E1D7BDDE4CE13051E5A4EDB9762E795DF98A85BF7B1D96B1429EBB74A39FCCD2C6A4AD08D44C09538C64FE29215776BA43F1A3C0F6E38D68CD8A25610A4D0AC3CE0061521782F4A3CFB054C363807D3507EAE15F23867D0D536BD780B3BBA</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 0D 1E B7 61 57 B6 4B 8F 20 91 88 B1
0010 | 83 EC 04 59 DF 52 E6 6A DD D8 4F 0E 58 80 62 48
0020 | 74 AB D2 BC 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 22 6E BF C8 EE 45 80 A0 27 84 65 CA A4 D1 35 A3
0140 | 4E 91 57 40 1C 31 19 7C CD 45 93 BA BA 6E 55 3E
0150 | 8F AB D4 0C 8D 02 B7 9D 6B FB 5B E8 F0 AC 4A 0B
0160 | 0A 83 B3 4B 06 7C 04 8A 48 6F C5 D4 50 92 ED D1
0170 | 27 89 E8 D8 6F FB 02 6A 44 86 18 87 2A B3 A3 72
0180 | 03 1D 1D 7E 74 AA E8 68 1E F1 C2 51 D1 55 18 17
0190 | FF 59 F7 50 66 55 70 02 A5 AA 94 AF 2F B3 CE 7A
01A0 | 76 D5 64 63 24 41 05 B5 0F 3A 2B FF 0F 1C 89 7C
01B0 | D3 F2 54 DA 4A 84 8C EA F6 88 D5 B7 90 18 96 59
01C0 | 5A 45 D5 90 19 21 53 8E 4B F2 54 EC 6B 07 E9 A5
01D0 | D1 93 4A 76 58 30 CB 2A 3D B0 09 B5 D3 9E 1D 7B
01E0 | DD E4 CE 13 05 1E 5A 4E DB 97 62 E7 95 DF 98 A8
01F0 | 5B F7 B1 D9 6B 14 29 EB B7 4A 39 FC CD 2C 6A 4A
0200 | D0 8D 44 C0 95 38 C6 4F E2 92 15 77 6B A4 3F 1A
0210 | 3C 0F 6E 38 D6 8C D8 A2 56 10 A4 D0 AC 3C E0 06
0220 | 15 21 78 2F 4A 3C FB 05 4C 36 38 07 D3 50 7E AE
0230 | 15 F2 38 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100226EBFC8EE4580A0278465CA</code> <code>A4D135A34E9157401C31197CCD4593BA</code> <code>BA6E553E8FABD40C8D02B79D6BFB5BE8</code> <code>F0AC4A0B0A83B34B067C048A486FC5D4</code> <code>5092EDD12789E8D86FFB026A44861887</code> <code>2AB3A372031D1D7E74AAE8681EF1C251</code> <code>D1551817FF59F75066557002A5AA94AF</code> <code>2FB3CE7A76D56463244105B50F3A2BFF</code> <code>0F1C897CD3F254DA4A848CEAF688D5B7</code> <code>901896595A45D5901921538E4BF254EC</code> <code>6B07E9A5D1934A765830CB2A3DB009B5</code> <code>D39E1D7BDDE4CE13051E5A4EDB9762E7</code> <code>95DF98A85BF7B1D96B1429EBB74A39FC</code> <code>CD2C6A4AD08D44C09538C64FE2921577</code> <code>6BA43F1A3C0F6E38D68CD8A25610A4D0</code> <code>AC3CE0061521782F4A3CFB054C363807</code><br> <code>D3507EAE</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>15F23867</code> (1731785237 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 36FDC4E322EC2463EDB7FB70713E9B48E2444C783F52FEE44769153C19B0323DD798D1D26DA1742FED011ED22D9C11628485D57307969CF8DD9C58DC488FFB0716E394C9F08C30D9610F9EC9AAA05D1668AE6CF4B126A36001551BB52430C5D3557E1FF41335ADBF6FD4E8D039B6A0AA36AB787FB2A1F1EFED9C7097647C9522D4F782C2AE15AA328287E097C5FA9F015EA81EDCD4F7487565DC6B457D0CE6EDDA44FA0DAB9978E6C3461313319CE8E485DE894BC902E9A9418DDE0F462BD0A45C56225F3DBAE3B95989A15BBE337AE22796536EEF4A4E4E858C094B435C6FDAB762091BD5F263B2269DFBC4EEA53FC7A39543DD10A7B11690270BF80FF37A84</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 2C339BD293B50278F3C6BBE8DF97C38A56694D8AE2BC5D08CDA73FD37BAA60E01E7B8BA094BC798E6E7212A9F07338CC10532C244BDC128AFB2BE1E6670D2BBB0673EA2C40DE1843A2A639241CF8F81C499A9B05B6FC05102881413AB7035A74B03F40C33CB8A4CC2861A41BBD9B19FD9724BFAE938BF8672806CC4BA035ACA90034C3A2173C3044DB6322DE357F861719B3BC07CA6FB185DF58C98E9C848B33E55421205A989E3FFBF9CDF3D995A09666C1AE39CEFFC573AC13EF31F721D48D9F562EEE804146D2F2AC5CFD677DA0754B0E14E088201E83449375D09A33134AC3E6940E130D4D1B417B546CF3D74FB0FE6575DDD4D8915202BB1BC3CDE7C232</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 0D 1E B7 61 57 B6 4B 8F 20 91 88 B1
0010 | 83 EC 04 59 DF 52 E6 6A DD D8 4F 0E 58 80 62 48
0020 | 74 AB D2 BC 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 2C 33 9B D2 93 B5 02 78 F3 C6 BB E8 DF 97 C3 8A
0040 | 56 69 4D 8A E2 BC 5D 08 CD A7 3F D3 7B AA 60 E0
0050 | 1E 7B 8B A0 94 BC 79 8E 6E 72 12 A9 F0 73 38 CC
0060 | 10 53 2C 24 4B DC 12 8A FB 2B E1 E6 67 0D 2B BB
0070 | 06 73 EA 2C 40 DE 18 43 A2 A6 39 24 1C F8 F8 1C
0080 | 49 9A 9B 05 B6 FC 05 10 28 81 41 3A B7 03 5A 74
0090 | B0 3F 40 C3 3C B8 A4 CC 28 61 A4 1B BD 9B 19 FD
00A0 | 97 24 BF AE 93 8B F8 67 28 06 CC 4B A0 35 AC A9
00B0 | 00 34 C3 A2 17 3C 30 44 DB 63 22 DE 35 7F 86 17
00C0 | 19 B3 BC 07 CA 6F B1 85 DF 58 C9 8E 9C 84 8B 33
00D0 | E5 54 21 20 5A 98 9E 3F FB F9 CD F3 D9 95 A0 96
00E0 | 66 C1 AE 39 CE FF C5 73 AC 13 EF 31 F7 21 D4 8D
00F0 | 9F 56 2E EE 80 41 46 D2 F2 AC 5C FD 67 7D A0 75
0100 | 4B 0E 14 E0 88 20 1E 83 44 93 75 D0 9A 33 13 4A
0110 | C3 E6 94 0E 13 0D 4D 1B 41 7B 54 6C F3 D7 4F B0
0120 | FE 65 75 DD D4 D8 91 52 02 BB 1B C3 CD E7 C2 32</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001002C339BD293B50278F3C6BBE8</code> <code>DF97C38A56694D8AE2BC5D08CDA73FD3</code> <code>7BAA60E01E7B8BA094BC798E6E7212A9</code> <code>F07338CC10532C244BDC128AFB2BE1E6</code> <code>670D2BBB0673EA2C40DE1843A2A63924</code> <code>1CF8F81C499A9B05B6FC05102881413A</code> <code>B7035A74B03F40C33CB8A4CC2861A41B</code> <code>BD9B19FD9724BFAE938BF8672806CC4B</code> <code>A035ACA90034C3A2173C3044DB6322DE</code> <code>357F861719B3BC07CA6FB185DF58C98E</code> <code>9C848B33E55421205A989E3FFBF9CDF3</code> <code>D995A09666C1AE39CEFFC573AC13EF31</code> <code>F721D48D9F562EEE804146D2F2AC5CFD</code> <code>677DA0754B0E14E088201E83449375D0</code> <code>9A33134AC3E6940E130D4D1B417B546C</code> <code>F3D74FB0FE6575DDD4D8915202BB1BC3</code><br> <code>CDE7C232</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643660D1EB76157B64B8F209188B183EC0459DF52E66ADDD84F0E5880624874ABD2BC0000000000000000FE0001002C339BD293B50278F3C6BBE8DF97C38A56694D8AE2BC5D08CDA73FD37BAA60E01E7B8BA094BC798E6E7212A9F07338CC10532C244BDC128AFB2BE1E6670D2BBB0673EA2C40DE1843A2A639241CF8F81C499A9B05B6FC05102881413AB7035A74B03F40C33CB8A4CC2861A41BBD9B19FD9724BFAE938BF8672806CC4BA035ACA90034C3A2173C3044DB6322DE357F861719B3BC07CA6FB185DF58C98E9C848B33E55421205A989E3FFBF9CDF3D995A09666C1AE39CEFFC573AC13EF31F721D48D9F562EEE804146D2F2AC5CFD677DA0754B0E14E088201E83449375D09A33134AC3E6940E130D4D1B417B546CF3D74FB0FE6575DDD4D8915202BB1BC3CDE7C232
padding = B500C668473B7879525E2EF4
tmp_aes_key = 62A187C9FFC541D7A74B5C53694F4E9874B21B6219457CDF49A820BE358F425A
tmp_aes_iv = 10150B1431EE0B5129A8EB02139396AFA26A0D38C923D6D68D18D49EDB8C4D4C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 0C0F4C2CEB439C3B7C5B2C9D7254204C483099EE3AB9DB9BF1EEB7D88DAC91B9B90F81F8F18C53193EE5811B7E67A413193D7F417FAA59901E6D8CA66557CD435063D5D2B13919D50830384A03D10D641C132CF42AE773AFB4FE02E59F3CAF3DDB1E158BCBA3265C0F64A4290ED97E83D63168A2D0D3E9EFBC9FB5616F83F099194F764F75650E25559E7A35041DB7C7312CF49DC1D70DC441B7DF0A0B711B736D1C8EBF08360E92A7FC50B0931F62F0B52CCF4B36C276DAC2C815C5EDA8F45C233000A332399FBA3F6FBA540EBCE40AF9D7F259FB320FD973EA3046C8B0932EE3BAF8926B9DCD71F6B5D4B0B1AFF9B3463776C1C9D6004DB4ED4FAC8751096D5270E6E9340C40D109BAD823AE336F594F633702DC5B040208059E91FFBFE8E836F724D4B563BF83BAE0AC683E52488A073E5D8C4AFD4F316831873575A27A28D8DCF28534DCD95C2AB64BE655644D23</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 DC 4B 0C 00 15 F2 38 67
0010 | 78 01 00 00 1F 5F 04 F5 0D 1E B7 61 57 B6 4B 8F
0020 | 20 91 88 B1 83 EC 04 59 DF 52 E6 6A DD D8 4F 0E
0030 | 58 80 62 48 74 AB D2 BC FE 50 01 00 0C 0F 4C 2C
0040 | EB 43 9C 3B 7C 5B 2C 9D 72 54 20 4C 48 30 99 EE
0050 | 3A B9 DB 9B F1 EE B7 D8 8D AC 91 B9 B9 0F 81 F8
0060 | F1 8C 53 19 3E E5 81 1B 7E 67 A4 13 19 3D 7F 41
0070 | 7F AA 59 90 1E 6D 8C A6 65 57 CD 43 50 63 D5 D2
0080 | B1 39 19 D5 08 30 38 4A 03 D1 0D 64 1C 13 2C F4
0090 | 2A E7 73 AF B4 FE 02 E5 9F 3C AF 3D DB 1E 15 8B
00A0 | CB A3 26 5C 0F 64 A4 29 0E D9 7E 83 D6 31 68 A2
00B0 | D0 D3 E9 EF BC 9F B5 61 6F 83 F0 99 19 4F 76 4F
00C0 | 75 65 0E 25 55 9E 7A 35 04 1D B7 C7 31 2C F4 9D
00D0 | C1 D7 0D C4 41 B7 DF 0A 0B 71 1B 73 6D 1C 8E BF
00E0 | 08 36 0E 92 A7 FC 50 B0 93 1F 62 F0 B5 2C CF 4B
00F0 | 36 C2 76 DA C2 C8 15 C5 ED A8 F4 5C 23 30 00 A3
0100 | 32 39 9F BA 3F 6F BA 54 0E BC E4 0A F9 D7 F2 59
0110 | FB 32 0F D9 73 EA 30 46 C8 B0 93 2E E3 BA F8 92
0120 | 6B 9D CD 71 F6 B5 D4 B0 B1 AF F9 B3 46 37 76 C1
0130 | C9 D6 00 4D B4 ED 4F AC 87 51 09 6D 52 70 E6 E9
0140 | 34 0C 40 D1 09 BA D8 23 AE 33 6F 59 4F 63 37 02
0150 | DC 5B 04 02 08 05 9E 91 FF BF E8 E8 36 F7 24 D4
0160 | B5 63 BF 83 BA E0 AC 68 3E 52 48 8A 07 3E 5D 8C
0170 | 4A FD 4F 31 68 31 87 35 75 A2 7A 28 D8 DC F2 85
0180 | 34 DC D9 5C 2A B6 4B E6 55 64 4D 23</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>DC4B0C0015F23867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001000C0F4C2CEB439C3B7C5B2C9D</code> <code>7254204C483099EE3AB9DB9BF1EEB7D8</code> <code>8DAC91B9B90F81F8F18C53193EE5811B</code> <code>7E67A413193D7F417FAA59901E6D8CA6</code> <code>6557CD435063D5D2B13919D50830384A</code> <code>03D10D641C132CF42AE773AFB4FE02E5</code> <code>9F3CAF3DDB1E158BCBA3265C0F64A429</code> <code>0ED97E83D63168A2D0D3E9EFBC9FB561</code> <code>6F83F099194F764F75650E25559E7A35</code> <code>041DB7C7312CF49DC1D70DC441B7DF0A</code> <code>0B711B736D1C8EBF08360E92A7FC50B0</code> <code>931F62F0B52CCF4B36C276DAC2C815C5</code> <code>EDA8F45C233000A332399FBA3F6FBA54</code> <code>0EBCE40AF9D7F259FB320FD973EA3046</code> <code>C8B0932EE3BAF8926B9DCD71F6B5D4B0</code> <code>B1AFF9B3463776C1C9D6004DB4ED4FAC</code> <code>8751096D5270E6E9340C40D109BAD823</code> <code>AE336F594F633702DC5B040208059E91</code> <code>FFBFE8E836F724D4B563BF83BAE0AC68</code> <code>3E52488A073E5D8C4AFD4F3168318735</code> <code>75A27A28D8DCF28534DCD95C2AB64BE6</code><br> <code>55644D23</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7F89ACBB0E75DD81A400F1A6DF440010E85C704BF195E9999895DB727707D5526600B633735847979CCD021D0DB62F0BE74EC6F605AF4C579FF9B5A6B07BBF33B41839AD1257794C49C5A61E064DBC2E2649552DBCAC9CC443FE4628D5B6F3FC91D85F569AFED530E8F5E7E70B2913027D90A9EBB0A8992AF82B0AED6D4C33A075D3F371D899C33981BD138B87E5D47EA7ECD4FB39C01EA163107CC8BFCF82B9905A0DF3C67A30DE013D215C7FCD0DCC89A9E51340ABA579783F52109E69214A8C2A936FE19109172DC96DA1F02D7220012901D289254815B744F97700BCD8C322A0E794BEA04B0E2580A8B4963883C2D56F1788CDA992BF8189063407C6CA1E</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 EC 78 08 17 F2 38 67
0010 | 34 00 00 00 34 F7 CB 3B 0D 1E B7 61 57 B6 4B 8F
0020 | 20 91 88 B1 83 EC 04 59 DF 52 E6 6A DD D8 4F 0E
0030 | 58 80 62 48 74 AB D2 BC 7D 9F 24 8F BB 82 E3 68
0040 | 3A 23 93 7B A7 47 FB 0D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01EC780817F23867</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>0D1EB76157B64B8F209188B183EC0459</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>DF52E66ADDD84F0E5880624874ABD2BC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>7D9F248FBB82E3683A23937BA747FB0D</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

