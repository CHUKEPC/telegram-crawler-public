<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?245" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 3E 01 00 5B 5E 82 68
0010 | 14 00 00 00 F1 8E 7E BE AD CE 25 09 1B 90 0F AB
0020 | FE 3C 18 C0 94 5A 21 71</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>783E01005B5E8268</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 98 55 7F 5B 5E 82 68
0010 | 50 00 00 00 63 24 16 05 AD CE 25 09 1B 90 0F AB
0020 | FE 3C 18 C0 94 5A 21 71 9A F4 F1 53 19 5F E5 91
0030 | 78 6C 3D 80 DF 45 9C 50 08 20 47 53 ED 64 C0 5F
0040 | 49 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0198557F5B5E8268</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>08204753ED64C05F49000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2325920011622833993</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2325920011622833993</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2325920011622833993 = 1423548209 * 1633889177</code></p>
<pre><code>p = 1423548209
q = 1633889177</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 47 53 ED 64 C0 5F 49 00 00 00
0010 | 04 54 D9 9F 31 00 00 00 04 61 63 2B 99 00 00 00
0020 | AD CE 25 09 1B 90 0F AB FE 3C 18 C0 94 5A 21 71
0030 | 9A F4 F1 53 19 5F E5 91 78 6C 3D 80 DF 45 9C 50
0040 | 39 31 FA 2C 7D 0D EF 75 7A 95 18 27 D1 37 79 B0
0050 | 11 A1 53 A4 DA 48 60 7D D2 07 D4 39 01 85 69 4A
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>08204753ED64C05F49000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2325920011622833993</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0454D99F31000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1423548209</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0461632B99000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1633889177</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>3931FA2C7D0DEF757A951827D13779B0</code> <code>11A153A4DA48607DD207D4390185694A</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A908204753ED64C05F490000000454D99F310000000461632B99000000ADCE25091B900FABFE3C18C0945A21719AF4F153195FE591786C3D80DF459C503931FA2C7D0DEF757A951827D13779B011A153A4DA48607DD207D4390185694A02000000
random_padding_bytes = 9FAC4A5D655D209788366B83CD909B5773A040BA1CC5BC5477EBD7DC02EECECCB33EF571B91BDB38CBC6CDEF6CD588C01FB7D6D481CC82DCF5F7F9CA09F553B8C284F4B7E7B66AE01B8F8941ADCC3BC674A316A18E0EB7F1634981AA</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D1C7874AE5581FB5A44553BD4F5B18C05C92E63FE8F98314D986E6CFB1D5C5F07BD8EBB21D0B5DC342EF67C1403F6191935151700F47C0BC82F919FF1314961867E1FE72D5A5505914CC9CF82C6778A14DC47F94A2E68D4E92BC234534B7D4A963C86E64790104FDD59349143285166E884489A037965E8569BBBF1AFC61840FCC914FC4EC5A86234F9850F099D5B464DF474472BC82607F1530E4628F7CF64B0A19A6D581FB2B60EC1F6B0919B7ED54FD26AE1BCE3C42E17A7C0A1A52FBC2A82D883B30C0A8AE1EC3AC7398BEAAB80AC3E8E41EBB04301DCB9F7B02D35A37C6D3445E714C72D93EB9E6415D2B6D9E2D5F6A27C01544AF9FB79A7BA7E9563595</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 3C DF 07 00 5B 5E 82 68
0010 | 40 01 00 00 BE E4 12 D7 AD CE 25 09 1B 90 0F AB
0020 | FE 3C 18 C0 94 5A 21 71 9A F4 F1 53 19 5F E5 91
0030 | 78 6C 3D 80 DF 45 9C 50 04 54 D9 9F 31 00 00 00
0040 | 04 61 63 2B 99 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D1 C7 87 4A E5 58 1F B5 A4 45 53 BD
0060 | 4F 5B 18 C0 5C 92 E6 3F E8 F9 83 14 D9 86 E6 CF
0070 | B1 D5 C5 F0 7B D8 EB B2 1D 0B 5D C3 42 EF 67 C1
0080 | 40 3F 61 91 93 51 51 70 0F 47 C0 BC 82 F9 19 FF
0090 | 13 14 96 18 67 E1 FE 72 D5 A5 50 59 14 CC 9C F8
00A0 | 2C 67 78 A1 4D C4 7F 94 A2 E6 8D 4E 92 BC 23 45
00B0 | 34 B7 D4 A9 63 C8 6E 64 79 01 04 FD D5 93 49 14
00C0 | 32 85 16 6E 88 44 89 A0 37 96 5E 85 69 BB BF 1A
00D0 | FC 61 84 0F CC 91 4F C4 EC 5A 86 23 4F 98 50 F0
00E0 | 99 D5 B4 64 DF 47 44 72 BC 82 60 7F 15 30 E4 62
00F0 | 8F 7C F6 4B 0A 19 A6 D5 81 FB 2B 60 EC 1F 6B 09
0100 | 19 B7 ED 54 FD 26 AE 1B CE 3C 42 E1 7A 7C 0A 1A
0110 | 52 FB C2 A8 2D 88 3B 30 C0 A8 AE 1E C3 AC 73 98
0120 | BE AA B8 0A C3 E8 E4 1E BB 04 30 1D CB 9F 7B 02
0130 | D3 5A 37 C6 D3 44 5E 71 4C 72 D9 3E B9 E6 41 5D
0140 | 2B 6D 9E 2D 5F 6A 27 C0 15 44 AF 9F B7 9A 7B A7
0150 | E9 56 35 95</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>3CDF07005B5E8268</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0454D99F31000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1423548209</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0461632B99000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1633889177</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D1C7874AE5581FB5A44553BD</code> <code>4F5B18C05C92E63FE8F98314D986E6CF</code> <code>B1D5C5F07BD8EBB21D0B5DC342EF67C1</code> <code>403F6191935151700F47C0BC82F919FF</code> <code>1314961867E1FE72D5A5505914CC9CF8</code> <code>2C6778A14DC47F94A2E68D4E92BC2345</code> <code>34B7D4A963C86E64790104FDD5934914</code> <code>3285166E884489A037965E8569BBBF1A</code> <code>FC61840FCC914FC4EC5A86234F9850F0</code> <code>99D5B464DF474472BC82607F1530E462</code> <code>8F7CF64B0A19A6D581FB2B60EC1F6B09</code> <code>19B7ED54FD26AE1BCE3C42E17A7C0A1A</code> <code>52FBC2A82D883B30C0A8AE1EC3AC7398</code> <code>BEAAB80AC3E8E41EBB04301DCB9F7B02</code> <code>D35A37C6D3445E714C72D93EB9E6415D</code> <code>2B6D9E2D5F6A27C01544AF9FB79A7BA7</code><br> <code>E9563595</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 7C D3 A9 5B 5E 82 68
0010 | 78 02 00 00 5C 07 E8 D0 AD CE 25 09 1B 90 0F AB
0020 | FE 3C 18 C0 94 5A 21 71 9A F4 F1 53 19 5F E5 91
0030 | 78 6C 3D 80 DF 45 9C 50 FE 50 02 00 94 57 39 52
0040 | 92 1F D0 87 94 DA 37 D0 10 C7 37 4D 04 0A 7C C6
0050 | 64 5B 60 71 D4 80 FF 7C B9 08 93 CE 30 C1 6C BD
0060 | 34 54 DF 9A 00 4B CF 6B C4 8D 80 6D D3 AE A0 5E
0070 | F1 74 8B 2F 31 AE 40 8F 54 C9 86 2C 39 84 A7 D8
0080 | 0E F2 B1 71 42 6F 2B 4F C9 39 AE 37 6D 23 11 8B
0090 | 1F 64 7D 60 62 2B 0F 00 B1 BE 5A BA E5 6C AF 46
00A0 | 2F E3 48 97 21 41 1D 71 02 84 ED 00 98 8A 63 43
00B0 | 85 B0 6C F0 1B 54 44 5F 72 C1 C9 85 2D 3A 1F DC
00C0 | A8 58 42 41 DD C5 02 58 60 71 0B F0 29 20 EE F9
00D0 | 60 09 7D 8B BB 42 48 5F EF 41 8D B0 07 63 04 5A
00E0 | AB 47 1D 17 CB 5D 23 B4 0F 59 B5 CA C6 0A 39 88
00F0 | 02 C9 C2 D0 81 95 F1 2A EA 56 0E 33 1A 5D 77 9D
0100 | 1D 91 E7 8F 42 6D 6D 06 F2 84 57 FB E7 4D 93 0C
0110 | 60 7B 0F 4B 4A B3 66 5B FD 0B 22 58 88 42 C7 C9
0120 | D3 6F 60 EA 8E 71 AC 03 E9 33 C6 15 72 A3 64 76
0130 | 2F FF 3A 44 37 9A D5 A6 72 E3 DE 82 6E 61 A5 C2
0140 | 55 36 C3 13 43 4F FB B7 82 28 A4 36 EA 2B 1B D3
0150 | AA F2 46 E7 72 C9 26 52 50 42 05 5E 5B D8 60 44
0160 | E1 AD 1A EA 66 86 3C 45 7C 29 80 14 09 F7 4B 7D
0170 | 62 7A 78 E7 40 FA 27 3B 3A 48 AB 57 70 06 D7 96
0180 | AF EA F2 A2 09 07 2C 37 E2 56 08 83 3B 43 71 A8
0190 | EB 11 9F AA 43 37 56 9B ED 79 2F 1E 26 4A 69 57
01A0 | 88 12 09 9F 71 F0 25 21 DD 7C 13 6D F4 FE 30 05
01B0 | 2B B9 14 11 11 C0 B8 4F B4 D4 C5 B4 E3 E9 28 12
01C0 | A1 78 91 1D 59 0C 9C 35 07 4D 4F 00 A1 84 25 14
01D0 | 44 2E B6 FB 2D 91 D5 51 36 EE C1 60 ED B7 A1 43
01E0 | 80 BD 05 D8 7F CA 97 CF F3 B1 BB BE BE 1E B0 8F
01F0 | F3 67 7E 63 6B 6E 6C 70 B4 94 21 B4 BA 44 80 E2
0200 | DE F6 C5 FE 58 4F 34 D2 9D C6 4B F1 F2 49 0E 82
0210 | 4A C7 59 23 BE 36 5A 94 D0 34 14 6D B4 BF 5A 90
0220 | 5F A3 59 FC CA 32 C0 5E D7 55 A7 E2 77 82 B7 68
0230 | 19 FC 03 43 18 B5 40 3A F8 90 7E A7 F9 31 D6 73
0240 | A4 C4 C8 81 E5 2B 27 A3 D9 4A 2D C1 A0 0D 11 60
0250 | FA 81 1D 87 A3 F0 8B 09 D6 2A FD 1B 60 1A 9E FD
0260 | E9 BF 0B 33 45 9C 3A A8 67 84 4C A9 BD 5F 26 35
0270 | 3A 1E 8F F0 95 C6 19 2C AC D7 A6 C8 26 6C 70 3A
0280 | 98 B5 48 57 C8 A7 C9 EE 7D 18 6E 34</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>017CD3A95B5E8268</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020094573952921FD08794DA37D0</code> <code>10C7374D040A7CC6645B6071D480FF7C</code> <code>B90893CE30C16CBD3454DF9A004BCF6B</code> <code>C48D806DD3AEA05EF1748B2F31AE408F</code> <code>54C9862C3984A7D80EF2B171426F2B4F</code> <code>C939AE376D23118B1F647D60622B0F00</code> <code>B1BE5ABAE56CAF462FE3489721411D71</code> <code>0284ED00988A634385B06CF01B54445F</code> <code>72C1C9852D3A1FDCA8584241DDC50258</code> <code>60710BF02920EEF960097D8BBB42485F</code> <code>EF418DB00763045AAB471D17CB5D23B4</code> <code>0F59B5CAC60A398802C9C2D08195F12A</code> <code>EA560E331A5D779D1D91E78F426D6D06</code> <code>F28457FBE74D930C607B0F4B4AB3665B</code> <code>FD0B22588842C7C9D36F60EA8E71AC03</code> <code>E933C61572A364762FFF3A44379AD5A6</code> <code>72E3DE826E61A5C25536C313434FFBB7</code> <code>8228A436EA2B1BD3AAF246E772C92652</code> <code>5042055E5BD86044E1AD1AEA66863C45</code> <code>7C29801409F74B7D627A78E740FA273B</code> <code>3A48AB577006D796AFEAF2A209072C37</code> <code>E25608833B4371A8EB119FAA4337569B</code> <code>ED792F1E264A69578812099F71F02521</code> <code>DD7C136DF4FE30052BB9141111C0B84F</code> <code>B4D4C5B4E3E92812A178911D590C9C35</code> <code>074D4F00A1842514442EB6FB2D91D551</code> <code>36EEC160EDB7A14380BD05D87FCA97CF</code> <code>F3B1BBBEBE1EB08FF3677E636B6E6C70</code> <code>B49421B4BA4480E2DEF6C5FE584F34D2</code> <code>9DC64BF1F2490E824AC75923BE365A94</code> <code>D034146DB4BF5A905FA359FCCA32C05E</code> <code>D755A7E27782B76819FC034318B5403A</code> <code>F8907EA7F931D673A4C4C881E52B27A3</code> <code>D94A2DC1A00D1160FA811D87A3F08B09</code> <code>D62AFD1B601A9EFDE9BF0B33459C3AA8</code> <code>67844CA9BD5F26353A1E8FF095C6192C</code> <code>ACD7A6C8266C703A98B54857C8A7C9EE</code><br> <code>7D186E34</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 94573952921FD08794DA37D010C7374D040A7CC6645B6071D480FF7CB90893CE30C16CBD3454DF9A004BCF6BC48D806DD3AEA05EF1748B2F31AE408F54C9862C3984A7D80EF2B171426F2B4FC939AE376D23118B1F647D60622B0F00B1BE5ABAE56CAF462FE3489721411D710284ED00988A634385B06CF01B54445F72C1C9852D3A1FDCA8584241DDC5025860710BF02920EEF960097D8BBB42485FEF418DB00763045AAB471D17CB5D23B40F59B5CAC60A398802C9C2D08195F12AEA560E331A5D779D1D91E78F426D6D06F28457FBE74D930C607B0F4B4AB3665BFD0B22588842C7C9D36F60EA8E71AC03E933C61572A364762FFF3A44379AD5A672E3DE826E61A5C25536C313434FFBB78228A436EA2B1BD3AAF246E772C926525042055E5BD86044E1AD1AEA66863C457C29801409F74B7D627A78E740FA273B3A48AB577006D796AFEAF2A209072C37E25608833B4371A8EB119FAA4337569BED792F1E264A69578812099F71F02521DD7C136DF4FE30052BB9141111C0B84FB4D4C5B4E3E92812A178911D590C9C35074D4F00A1842514442EB6FB2D91D55136EEC160EDB7A14380BD05D87FCA97CFF3B1BBBEBE1EB08FF3677E636B6E6C70B49421B4BA4480E2DEF6C5FE584F34D29DC64BF1F2490E824AC75923BE365A94D034146DB4BF5A905FA359FCCA32C05ED755A7E27782B76819FC034318B5403AF8907EA7F931D673A4C4C881E52B27A3D94A2DC1A00D1160FA811D87A3F08B09D62AFD1B601A9EFDE9BF0B33459C3AA867844CA9BD5F26353A1E8FF095C6192CACD7A6C8266C703A98B54857C8A7C9EE7D186E34
tmp_aes_key = 46D03BFEBA98A196CD0FB50BB57E3B5CD659067DC0B6B303DA4713457F7EF1F9
tmp_aes_iv = 72FE6C8B5AFEC22AB768C04A7D0605F404D1666DAB9EFCBE63A1BA973931FA2C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 9C4295FE3C8D9EA9FFC8F7C65AD9F8EB69454AF2BA0D89B5ADCE25091B900FABFE3C18C0945A21719AF4F153195FE591786C3D80DF459C5003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001CBD9D18F9A074A47A5E6A19249B06A205E7EFE7AEAF1D2121C78249B9203D613BD1EC7C259AE7B73D63B82CA2CCB0A18EE2A05D14473A72E75D9F09FA3DC5E5680280394165C7B9729C9B8552AA70667CCF38FF97E81A4EC8896BF742FA03AF1313BF7CCA0782F218040859F8CF685F24420C8468DD5061BB3BD4A4F9FB2AE048E405E96C3AF73CB78764C7C7951EBB3C5721C9BEACAC60CA7263ADC94C8B3511AEB641ABA58A143C96C6CD145FB54F17C7DCDE960B0CA9FABCDCA68615647A04B1440ADF28738F324EE5D83414949B7394A8D802015BBECB1FDF3A175E1730AA743FDCD7A34876ABF76325B6AAF386283BAE7D7A591EA1879333B86B254D5D5B5E826804905D3F10A814A1
answer = BA0D89B5ADCE25091B900FABFE3C18C0945A21719AF4F153195FE591786C3D80DF459C5003000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001001CBD9D18F9A074A47A5E6A19249B06A205E7EFE7AEAF1D2121C78249B9203D613BD1EC7C259AE7B73D63B82CA2CCB0A18EE2A05D14473A72E75D9F09FA3DC5E5680280394165C7B9729C9B8552AA70667CCF38FF97E81A4EC8896BF742FA03AF1313BF7CCA0782F218040859F8CF685F24420C8468DD5061BB3BD4A4F9FB2AE048E405E96C3AF73CB78764C7C7951EBB3C5721C9BEACAC60CA7263ADC94C8B3511AEB641ABA58A143C96C6CD145FB54F17C7DCDE960B0CA9FABCDCA68615647A04B1440ADF28738F324EE5D83414949B7394A8D802015BBECB1FDF3A175E1730AA743FDCD7A34876ABF76325B6AAF386283BAE7D7A591EA1879333B86B254D5D5B5E826804905D3F10A814A1</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 AD CE 25 09 1B 90 0F AB FE 3C 18 C0
0010 | 94 5A 21 71 9A F4 F1 53 19 5F E5 91 78 6C 3D 80
0020 | DF 45 9C 50 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 1C BD 9D 18 F9 A0 74 A4 7A 5E 6A 19 24 9B 06 A2
0140 | 05 E7 EF E7 AE AF 1D 21 21 C7 82 49 B9 20 3D 61
0150 | 3B D1 EC 7C 25 9A E7 B7 3D 63 B8 2C A2 CC B0 A1
0160 | 8E E2 A0 5D 14 47 3A 72 E7 5D 9F 09 FA 3D C5 E5
0170 | 68 02 80 39 41 65 C7 B9 72 9C 9B 85 52 AA 70 66
0180 | 7C CF 38 FF 97 E8 1A 4E C8 89 6B F7 42 FA 03 AF
0190 | 13 13 BF 7C CA 07 82 F2 18 04 08 59 F8 CF 68 5F
01A0 | 24 42 0C 84 68 DD 50 61 BB 3B D4 A4 F9 FB 2A E0
01B0 | 48 E4 05 E9 6C 3A F7 3C B7 87 64 C7 C7 95 1E BB
01C0 | 3C 57 21 C9 BE AC AC 60 CA 72 63 AD C9 4C 8B 35
01D0 | 11 AE B6 41 AB A5 8A 14 3C 96 C6 CD 14 5F B5 4F
01E0 | 17 C7 DC DE 96 0B 0C A9 FA BC DC A6 86 15 64 7A
01F0 | 04 B1 44 0A DF 28 73 8F 32 4E E5 D8 34 14 94 9B
0200 | 73 94 A8 D8 02 01 5B BE CB 1F DF 3A 17 5E 17 30
0210 | AA 74 3F DC D7 A3 48 76 AB F7 63 25 B6 AA F3 86
0220 | 28 3B AE 7D 7A 59 1E A1 87 93 33 B8 6B 25 4D 5D
0230 | 5B 5E 82 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001001CBD9D18F9A074A47A5E6A19</code> <code>249B06A205E7EFE7AEAF1D2121C78249</code> <code>B9203D613BD1EC7C259AE7B73D63B82C</code> <code>A2CCB0A18EE2A05D14473A72E75D9F09</code> <code>FA3DC5E5680280394165C7B9729C9B85</code> <code>52AA70667CCF38FF97E81A4EC8896BF7</code> <code>42FA03AF1313BF7CCA0782F218040859</code> <code>F8CF685F24420C8468DD5061BB3BD4A4</code> <code>F9FB2AE048E405E96C3AF73CB78764C7</code> <code>C7951EBB3C5721C9BEACAC60CA7263AD</code> <code>C94C8B3511AEB641ABA58A143C96C6CD</code> <code>145FB54F17C7DCDE960B0CA9FABCDCA6</code> <code>8615647A04B1440ADF28738F324EE5D8</code> <code>3414949B7394A8D802015BBECB1FDF3A</code> <code>175E1730AA743FDCD7A34876ABF76325</code> <code>B6AAF386283BAE7D7A591EA1879333B8</code><br> <code>6B254D5D</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>5B5E8268</code> (1753374299 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 84CD315709AA307A9E0DD537F980CEDE41E2664448D4CBC36ADAD09CE7A78D3A50198B75C042B8116C68E53A020736C61A8AFDF451E65FC25E866E5385D6A46BA8FEEAACC6DBE81E353CDE6C65A57DAB5350D24E206F5CDF468C66FF969AEB2D1E6802674152C9F6ECBC89A5130B4946193188EA2E751D878451956E9102585FCBA5BF892E1D5BC247F7CBA42E8F03173F44951BA0B36A0ECAC754A061B05819B5EC20A7E56FD612F0BD14F0B131005E2D3A2C7D0EFE997AD453E4A7DFDA0B64191F34E3D57130848225D44988A73DE20A904215889D7786CC1A8D40A04EDF9EF5225EF3AC29C6300E5848073ED754D1F208CED29EE18F7D49866C417EA5EAB7</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 234FCFE0401DCEFC4C31BE59C8A09EC3E8A4880194AF8AE01D46D12C0127D2923DFBAB9EC9327320CDCDD6543EB2F08A834482968931D5042BE0CC07C7BB3DE9F68E585D3315168195D675081DF5525F12DBFCB63F43AFA4D21E0E6EA970C7EED9845C0C870F4122185C1DD6924C9C844EEFE29ECB843FA20DA1A7C84D3646699FAFB650AB4813763CC5A80BC2C02C76AED7579C54958D75646FF21450F2157639A2383BD4E5424747A91E999B06BD7A6660944F11C3526466C699FDE04F120277B73E44796483F817372E98FD1D923366EA09339D245CDB5AEB453F4A667E488CF46E6350157214065A1CB89E5BABFBA22948BCE56F21A49F38BE7B9E40C93D</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 AD CE 25 09 1B 90 0F AB FE 3C 18 C0
0010 | 94 5A 21 71 9A F4 F1 53 19 5F E5 91 78 6C 3D 80
0020 | DF 45 9C 50 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 23 4F CF E0 40 1D CE FC 4C 31 BE 59 C8 A0 9E C3
0040 | E8 A4 88 01 94 AF 8A E0 1D 46 D1 2C 01 27 D2 92
0050 | 3D FB AB 9E C9 32 73 20 CD CD D6 54 3E B2 F0 8A
0060 | 83 44 82 96 89 31 D5 04 2B E0 CC 07 C7 BB 3D E9
0070 | F6 8E 58 5D 33 15 16 81 95 D6 75 08 1D F5 52 5F
0080 | 12 DB FC B6 3F 43 AF A4 D2 1E 0E 6E A9 70 C7 EE
0090 | D9 84 5C 0C 87 0F 41 22 18 5C 1D D6 92 4C 9C 84
00A0 | 4E EF E2 9E CB 84 3F A2 0D A1 A7 C8 4D 36 46 69
00B0 | 9F AF B6 50 AB 48 13 76 3C C5 A8 0B C2 C0 2C 76
00C0 | AE D7 57 9C 54 95 8D 75 64 6F F2 14 50 F2 15 76
00D0 | 39 A2 38 3B D4 E5 42 47 47 A9 1E 99 9B 06 BD 7A
00E0 | 66 60 94 4F 11 C3 52 64 66 C6 99 FD E0 4F 12 02
00F0 | 77 B7 3E 44 79 64 83 F8 17 37 2E 98 FD 1D 92 33
0100 | 66 EA 09 33 9D 24 5C DB 5A EB 45 3F 4A 66 7E 48
0110 | 8C F4 6E 63 50 15 72 14 06 5A 1C B8 9E 5B AB FB
0120 | A2 29 48 BC E5 6F 21 A4 9F 38 BE 7B 9E 40 C9 3D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100234FCFE0401DCEFC4C31BE59</code> <code>C8A09EC3E8A4880194AF8AE01D46D12C</code> <code>0127D2923DFBAB9EC9327320CDCDD654</code> <code>3EB2F08A834482968931D5042BE0CC07</code> <code>C7BB3DE9F68E585D3315168195D67508</code> <code>1DF5525F12DBFCB63F43AFA4D21E0E6E</code> <code>A970C7EED9845C0C870F4122185C1DD6</code> <code>924C9C844EEFE29ECB843FA20DA1A7C8</code> <code>4D3646699FAFB650AB4813763CC5A80B</code> <code>C2C02C76AED7579C54958D75646FF214</code> <code>50F2157639A2383BD4E5424747A91E99</code> <code>9B06BD7A6660944F11C3526466C699FD</code> <code>E04F120277B73E44796483F817372E98</code> <code>FD1D923366EA09339D245CDB5AEB453F</code> <code>4A667E488CF46E6350157214065A1CB8</code> <code>9E5BABFBA22948BCE56F21A49F38BE7B</code><br> <code>9E40C93D</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366ADCE25091B900FABFE3C18C0945A21719AF4F153195FE591786C3D80DF459C500000000000000000FE000100234FCFE0401DCEFC4C31BE59C8A09EC3E8A4880194AF8AE01D46D12C0127D2923DFBAB9EC9327320CDCDD6543EB2F08A834482968931D5042BE0CC07C7BB3DE9F68E585D3315168195D675081DF5525F12DBFCB63F43AFA4D21E0E6EA970C7EED9845C0C870F4122185C1DD6924C9C844EEFE29ECB843FA20DA1A7C84D3646699FAFB650AB4813763CC5A80BC2C02C76AED7579C54958D75646FF21450F2157639A2383BD4E5424747A91E999B06BD7A6660944F11C3526466C699FDE04F120277B73E44796483F817372E98FD1D923366EA09339D245CDB5AEB453F4A667E488CF46E6350157214065A1CB89E5BABFBA22948BCE56F21A49F38BE7B9E40C93D
padding = 4491BC4BB575BF273A18AAD3
tmp_aes_key = 46D03BFEBA98A196CD0FB50BB57E3B5CD659067DC0B6B303DA4713457F7EF1F9
tmp_aes_iv = 72FE6C8B5AFEC22AB768C04A7D0605F404D1666DAB9EFCBE63A1BA973931FA2C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = C91D635CB5DF3FA0E10EAD6DA6F8CDE692201936A0C5D90E9B8DA0ECE2DAF6329DAE2B137EF2C6AAE1EB4C4A2B69C505244647CBB75A5A70FD52AE500C3DA52A96DA2CECF5F5B22C43A644E6A008B30F0699E89F18C7D84400F80CB90A2448693CAABA399BC204609941C3AD15FC2F5E498B9DF4A71B12260F1251136A76F9EFA33A8A56D17F159F0D5A39E3209D1DDBD1EED0EE7BD913E0C0189A9C8D5C3F7BE19C5E7D2DCFFF50EC988AEEE793A7D3ADACAE49096F7A87F304E64041D887E342F0D958EFCD6E04F43B31868FA4C597F28C796509ED79D3DC956A6AC4F46B67A1B43B62E8AA5E793A8F2292306CE5F931C02F3893D5C443A1A16A80C56DF6113A080AE1F31A69E067B3E402ABF34F574FDEA2A922EA354BFCEFFDF5F892BEA459556CEE16FDE955FF1A85FF9AF3093B26F54CE907C5EA8170DCE9C68056600471B8E27523358A2F453749A13F39DDB6</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D0 76 0E 00 5B 5E 82 68
0010 | 78 01 00 00 1F 5F 04 F5 AD CE 25 09 1B 90 0F AB
0020 | FE 3C 18 C0 94 5A 21 71 9A F4 F1 53 19 5F E5 91
0030 | 78 6C 3D 80 DF 45 9C 50 FE 50 01 00 C9 1D 63 5C
0040 | B5 DF 3F A0 E1 0E AD 6D A6 F8 CD E6 92 20 19 36
0050 | A0 C5 D9 0E 9B 8D A0 EC E2 DA F6 32 9D AE 2B 13
0060 | 7E F2 C6 AA E1 EB 4C 4A 2B 69 C5 05 24 46 47 CB
0070 | B7 5A 5A 70 FD 52 AE 50 0C 3D A5 2A 96 DA 2C EC
0080 | F5 F5 B2 2C 43 A6 44 E6 A0 08 B3 0F 06 99 E8 9F
0090 | 18 C7 D8 44 00 F8 0C B9 0A 24 48 69 3C AA BA 39
00A0 | 9B C2 04 60 99 41 C3 AD 15 FC 2F 5E 49 8B 9D F4
00B0 | A7 1B 12 26 0F 12 51 13 6A 76 F9 EF A3 3A 8A 56
00C0 | D1 7F 15 9F 0D 5A 39 E3 20 9D 1D DB D1 EE D0 EE
00D0 | 7B D9 13 E0 C0 18 9A 9C 8D 5C 3F 7B E1 9C 5E 7D
00E0 | 2D CF FF 50 EC 98 8A EE E7 93 A7 D3 AD AC AE 49
00F0 | 09 6F 7A 87 F3 04 E6 40 41 D8 87 E3 42 F0 D9 58
0100 | EF CD 6E 04 F4 3B 31 86 8F A4 C5 97 F2 8C 79 65
0110 | 09 ED 79 D3 DC 95 6A 6A C4 F4 6B 67 A1 B4 3B 62
0120 | E8 AA 5E 79 3A 8F 22 92 30 6C E5 F9 31 C0 2F 38
0130 | 93 D5 C4 43 A1 A1 6A 80 C5 6D F6 11 3A 08 0A E1
0140 | F3 1A 69 E0 67 B3 E4 02 AB F3 4F 57 4F DE A2 A9
0150 | 22 EA 35 4B FC EF FD F5 F8 92 BE A4 59 55 6C EE
0160 | 16 FD E9 55 FF 1A 85 FF 9A F3 09 3B 26 F5 4C E9
0170 | 07 C5 EA 81 70 DC E9 C6 80 56 60 04 71 B8 E2 75
0180 | 23 35 8A 2F 45 37 49 A1 3F 39 DD B6</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D0760E005B5E8268</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100C91D635CB5DF3FA0E10EAD6D</code> <code>A6F8CDE692201936A0C5D90E9B8DA0EC</code> <code>E2DAF6329DAE2B137EF2C6AAE1EB4C4A</code> <code>2B69C505244647CBB75A5A70FD52AE50</code> <code>0C3DA52A96DA2CECF5F5B22C43A644E6</code> <code>A008B30F0699E89F18C7D84400F80CB9</code> <code>0A2448693CAABA399BC204609941C3AD</code> <code>15FC2F5E498B9DF4A71B12260F125113</code> <code>6A76F9EFA33A8A56D17F159F0D5A39E3</code> <code>209D1DDBD1EED0EE7BD913E0C0189A9C</code> <code>8D5C3F7BE19C5E7D2DCFFF50EC988AEE</code> <code>E793A7D3ADACAE49096F7A87F304E640</code> <code>41D887E342F0D958EFCD6E04F43B3186</code> <code>8FA4C597F28C796509ED79D3DC956A6A</code> <code>C4F46B67A1B43B62E8AA5E793A8F2292</code> <code>306CE5F931C02F3893D5C443A1A16A80</code> <code>C56DF6113A080AE1F31A69E067B3E402</code> <code>ABF34F574FDEA2A922EA354BFCEFFDF5</code> <code>F892BEA459556CEE16FDE955FF1A85FF</code> <code>9AF3093B26F54CE907C5EA8170DCE9C6</code> <code>8056600471B8E27523358A2F453749A1</code><br> <code>3F39DDB6</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 666740BE28B2433196B0B5A8D6C8230927ABBAE77FD40B8E8C4B203D6440813A85814F8E726FD7E7B874095C401CA4FAF4374955E13EF92530749DB4251E3B31537DDC6DF62662335953D1388F0546E574B92443ADD3B40ED71EA1E3A8B369C3E1C0892EB6E7327053F7BD28FE5B861DC1F0F73F235F0AFC977DFFC608DD4AA8356FA75E13FD0D2B47B9307586038B54379828209B2A4852341F2455693C35BB8A9771086FECF37B908D8077AEEB6CFE678C1750AE6B4AEC2B1F7889D42D19411C0D750E588D371274B4B6D09766E0ED6FBF1590585AC00B4E57B1D59401D333D3DD2891BF489C3A8FFEBB7316F1E94DF27B6A3DB1C00A58163097F0D7C8005F</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E4 2A 97 5D 5E 82 68
0010 | 34 00 00 00 34 F7 CB 3B AD CE 25 09 1B 90 0F AB
0020 | FE 3C 18 C0 94 5A 21 71 9A F4 F1 53 19 5F E5 91
0030 | 78 6C 3D 80 DF 45 9C 50 63 4F 28 1B 97 8C AA CC
0040 | AC F2 ED 58 51 90 EF 63</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E42A975D5E8268</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>ADCE25091B900FABFE3C18C0945A2171</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9AF4F153195FE591786C3D80DF459C50</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>634F281B978CAACCACF2ED585190EF63</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

