<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 1C DF 07 00 6D 4C A1 66
0010 | 14 00 00 00 F1 8E 7E BE 63 87 AF ED 66 02 EE C4
0020 | BE 34 FF AB CB 78 31 46</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>1CDF07006D4CA166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 54 82 F4 6D 4C A1 66
0010 | BC 00 00 00 63 24 16 05 63 87 AF ED 66 02 EE C4
0020 | BE 34 FF AB CB 78 31 46 91 81 A5 0F 01 24 0C A8
0030 | 58 79 08 6C 85 0C 6C 58 08 1F 93 90 C2 6C D9 D8
0040 | E5 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>015482F46D4CA166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>BC000000</code> (188 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081F9390C26CD9D8E5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2275321401476503781</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2275321401476503781</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2275321401476503781 = 1239149183 * 1836196507</code></p>
<pre><code>p = 1239149183
q = 1836196507</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1F 93 90 C2 6C D9 D8 E5 00 00 00
0010 | 04 49 DB EA 7F 00 00 00 04 6D 72 22 9B 00 00 00
0020 | 63 87 AF ED 66 02 EE C4 BE 34 FF AB CB 78 31 46
0030 | 91 81 A5 0F 01 24 0C A8 58 79 08 6C 85 0C 6C 58
0040 | 5E 49 3C EC F0 53 CD 5D B9 A4 CF CF 43 9E 30 1B
0050 | 7D D6 65 88 10 55 C1 AB 0D 63 D0 A9 7E 76 57 63
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081F9390C26CD9D8E5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2275321401476503781</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0449DBEA7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1239149183</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046D72229B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1836196507</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>5E493CECF053CD5DB9A4CFCF439E301B</code> <code>7DD665881055C1AB0D63D0A97E765763</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081F9390C26CD9D8E50000000449DBEA7F000000046D72229B0000006387AFED6602EEC4BE34FFABCB7831469181A50F01240CA85879086C850C6C585E493CECF053CD5DB9A4CFCF439E301B7DD665881055C1AB0D63D0A97E76576302000000
random_padding_bytes = 0698269139B02028B47DE71A40CD62C1A289DADF0EAD34F3C433FD23A0620195304EB11ACC6A85FAFC827A9E91280C61523CDF0FF3AC654E2F06FD60D2FFEB4D921ABF6131D3B8C652ABAAEFDF1F3FCEC5FA060C99B13498891F0F89</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 8731291CDD5513220A82626E9BE5FFBE1F760F72AA6D277BE83F2132B0734E46B518AADF0AC8E2348E1CCC3474C7F6F72C4874B2313DCF8F5E40C978B3317DB30872B428DE70FA6317DA068B31C428414AD03B8ACE80D222A48EA4AEA93D1AAB7B98B36820D68723F2110BEBEFA56EEEE1989226A902E2D0A7116D1F90E1CDBBE735C85948FD12AA010E94A6B8CA76B641EDA7D81571260D9B68D1C8DD23D3875255DFEC41C90B7FD00D08FDF4C1FF4EB91063D51790FE3F3B96E6FE9476D076A1ECB55E7ED1B9221353B9EADDBDB1E71CBDE9E08B1211355CBEFD12D6350361515CBCF4991A280A40AD95A5F6F73DC24658580FFD89F29B65D5FDC0677F333E</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 28 0E 00 6E 4C A1 66
0010 | 40 01 00 00 BE E4 12 D7 63 87 AF ED 66 02 EE C4
0020 | BE 34 FF AB CB 78 31 46 91 81 A5 0F 01 24 0C A8
0030 | 58 79 08 6C 85 0C 6C 58 04 49 DB EA 7F 00 00 00
0040 | 04 6D 72 22 9B 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 87 31 29 1C DD 55 13 22 0A 82 62 6E
0060 | 9B E5 FF BE 1F 76 0F 72 AA 6D 27 7B E8 3F 21 32
0070 | B0 73 4E 46 B5 18 AA DF 0A C8 E2 34 8E 1C CC 34
0080 | 74 C7 F6 F7 2C 48 74 B2 31 3D CF 8F 5E 40 C9 78
0090 | B3 31 7D B3 08 72 B4 28 DE 70 FA 63 17 DA 06 8B
00A0 | 31 C4 28 41 4A D0 3B 8A CE 80 D2 22 A4 8E A4 AE
00B0 | A9 3D 1A AB 7B 98 B3 68 20 D6 87 23 F2 11 0B EB
00C0 | EF A5 6E EE E1 98 92 26 A9 02 E2 D0 A7 11 6D 1F
00D0 | 90 E1 CD BB E7 35 C8 59 48 FD 12 AA 01 0E 94 A6
00E0 | B8 CA 76 B6 41 ED A7 D8 15 71 26 0D 9B 68 D1 C8
00F0 | DD 23 D3 87 52 55 DF EC 41 C9 0B 7F D0 0D 08 FD
0100 | F4 C1 FF 4E B9 10 63 D5 17 90 FE 3F 3B 96 E6 FE
0110 | 94 76 D0 76 A1 EC B5 5E 7E D1 B9 22 13 53 B9 EA
0120 | DD BD B1 E7 1C BD E9 E0 8B 12 11 35 5C BE FD 12
0130 | D6 35 03 61 51 5C BC F4 99 1A 28 0A 40 AD 95 A5
0140 | F6 F7 3D C2 46 58 58 0F FD 89 F2 9B 65 D5 FD C0
0150 | 67 7F 33 3E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0280E006E4CA166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0449DBEA7F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1239149183</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046D72229B000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1836196507</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001008731291CDD5513220A82626E</code> <code>9BE5FFBE1F760F72AA6D277BE83F2132</code> <code>B0734E46B518AADF0AC8E2348E1CCC34</code> <code>74C7F6F72C4874B2313DCF8F5E40C978</code> <code>B3317DB30872B428DE70FA6317DA068B</code> <code>31C428414AD03B8ACE80D222A48EA4AE</code> <code>A93D1AAB7B98B36820D68723F2110BEB</code> <code>EFA56EEEE1989226A902E2D0A7116D1F</code> <code>90E1CDBBE735C85948FD12AA010E94A6</code> <code>B8CA76B641EDA7D81571260D9B68D1C8</code> <code>DD23D3875255DFEC41C90B7FD00D08FD</code> <code>F4C1FF4EB91063D51790FE3F3B96E6FE</code> <code>9476D076A1ECB55E7ED1B9221353B9EA</code> <code>DDBDB1E71CBDE9E08B1211355CBEFD12</code> <code>D6350361515CBCF4991A280A40AD95A5</code> <code>F6F73DC24658580FFD89F29B65D5FDC0</code><br> <code>677F333E</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 34 21 96 6E 4C A1 66
0010 | 78 02 00 00 5C 07 E8 D0 63 87 AF ED 66 02 EE C4
0020 | BE 34 FF AB CB 78 31 46 91 81 A5 0F 01 24 0C A8
0030 | 58 79 08 6C 85 0C 6C 58 FE 50 02 00 24 D0 29 7F
0040 | B1 57 8E B5 7D 1B B0 90 DE 7D DB B0 84 CE B3 3A
0050 | 48 CA 1A 7C D1 BD 38 AD B0 E7 CE 35 DE 20 7C 03
0060 | 85 51 82 7B B7 A3 8A F8 53 88 AA A9 B6 4C 8A 7F
0070 | 28 E6 A0 B7 4A FE BD EB 11 91 1A 19 C7 7F 68 55
0080 | 1F B0 BB 18 C2 B6 04 2E A0 44 3D 17 C7 59 A0 0F
0090 | 88 E1 B9 19 D5 F6 13 61 72 75 C4 F7 14 B7 E3 E4
00A0 | 2C 13 46 CF 37 CF B7 E4 05 DC 83 52 21 DC 3B 8D
00B0 | B4 FE CE 96 06 3C 5E B4 95 ED 1B 1D A2 A4 80 F4
00C0 | A1 F2 7C 28 5E 81 76 C4 18 8A 28 3A 0F 0B EE F9
00D0 | 09 3A 05 8F 3F 69 09 1C 39 E6 66 F0 97 BD 0B B2
00E0 | AE 47 BC 46 CC EB 1B 95 6C 51 00 18 F6 27 D6 2C
00F0 | 70 D2 B7 2B AC 7B 0B DC CE 18 7C 32 6D 66 45 8E
0100 | E2 2E 63 15 9B E2 C1 A2 F7 75 63 D7 C3 F2 0F E8
0110 | 88 FA FB B6 7B CB 18 BB AD 5B 49 18 48 D5 3B A9
0120 | D8 4C D4 B8 31 F6 7F 44 7B DC 68 6C 9E B7 EE 7B
0130 | 17 C9 C0 0D 42 6F C4 FB 12 7C D1 4D B4 2B F7 EA
0140 | 05 2E D1 5D 9D 5E DF 2F C0 6A F1 75 B3 28 E6 A5
0150 | 3A A6 B5 32 07 80 74 6C 7C 81 1A 50 23 5D E7 E3
0160 | 5D 08 E4 4D 52 2C 4A 17 63 B6 84 89 BD A3 6F B7
0170 | F6 0B FE 17 43 02 DC 72 50 DC 0F 0C 9A 8A 2A A9
0180 | 65 2B DE 11 56 92 08 B8 24 53 9A 95 4C 12 EE 41
0190 | C0 89 2D 80 E4 43 E2 0B E2 4A B3 65 76 F6 8C 67
01A0 | CC 90 36 0E 85 FC C1 92 55 2D C4 23 F6 BA 11 65
01B0 | F2 23 78 F8 B3 92 91 5F 89 1E DC 57 C1 5B 64 AC
01C0 | 0B EF 3F 4E 07 5F 9C 4B EE FB 9A 4E F3 0E EB 4A
01D0 | 82 03 EE 60 51 10 9D 97 DE F1 47 B7 6C 42 AA B3
01E0 | C7 27 46 C4 D7 0E 26 48 AC 79 35 B7 21 AD 64 00
01F0 | 9E C5 A5 19 DF 85 BA ED 49 0E EB CA C0 69 82 1D
0200 | 71 0F D1 65 7D D7 29 FC 5B 77 69 B8 7D 3E 90 17
0210 | C9 0F 34 EF C1 39 3C A1 B1 E4 AC 2E FE 2D 53 E1
0220 | 58 E7 7A 8F ED 95 2B 66 27 81 B3 19 2F 44 47 EB
0230 | 44 C4 A8 C8 CA EC DA 02 63 FF 74 59 61 2D 53 0D
0240 | 4B F5 33 22 B4 4E 92 E0 2E A5 E8 4C C2 2B D7 C0
0250 | 16 C8 1D F2 FA 98 DE BE B7 3D 5D 8A C8 D3 6D 03
0260 | 42 60 78 52 76 C2 61 69 A2 19 7A 74 07 C4 D3 53
0270 | 27 EF 77 67 C5 C8 56 02 A2 09 34 12 15 D1 6D 00
0280 | 78 6C E8 30 66 CF E3 B6 21 52 6E EF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>013421966E4CA166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020024D0297FB1578EB57D1BB090</code> <code>DE7DDBB084CEB33A48CA1A7CD1BD38AD</code> <code>B0E7CE35DE207C038551827BB7A38AF8</code> <code>5388AAA9B64C8A7F28E6A0B74AFEBDEB</code> <code>11911A19C77F68551FB0BB18C2B6042E</code> <code>A0443D17C759A00F88E1B919D5F61361</code> <code>7275C4F714B7E3E42C1346CF37CFB7E4</code> <code>05DC835221DC3B8DB4FECE96063C5EB4</code> <code>95ED1B1DA2A480F4A1F27C285E8176C4</code> <code>188A283A0F0BEEF9093A058F3F69091C</code> <code>39E666F097BD0BB2AE47BC46CCEB1B95</code> <code>6C510018F627D62C70D2B72BAC7B0BDC</code> <code>CE187C326D66458EE22E63159BE2C1A2</code> <code>F77563D7C3F20FE888FAFBB67BCB18BB</code> <code>AD5B491848D53BA9D84CD4B831F67F44</code> <code>7BDC686C9EB7EE7B17C9C00D426FC4FB</code> <code>127CD14DB42BF7EA052ED15D9D5EDF2F</code> <code>C06AF175B328E6A53AA6B5320780746C</code> <code>7C811A50235DE7E35D08E44D522C4A17</code> <code>63B68489BDA36FB7F60BFE174302DC72</code> <code>50DC0F0C9A8A2AA9652BDE11569208B8</code> <code>24539A954C12EE41C0892D80E443E20B</code> <code>E24AB36576F68C67CC90360E85FCC192</code> <code>552DC423F6BA1165F22378F8B392915F</code> <code>891EDC57C15B64AC0BEF3F4E075F9C4B</code> <code>EEFB9A4EF30EEB4A8203EE6051109D97</code> <code>DEF147B76C42AAB3C72746C4D70E2648</code> <code>AC7935B721AD64009EC5A519DF85BAED</code> <code>490EEBCAC069821D710FD1657DD729FC</code> <code>5B7769B87D3E9017C90F34EFC1393CA1</code> <code>B1E4AC2EFE2D53E158E77A8FED952B66</code> <code>2781B3192F4447EB44C4A8C8CAECDA02</code> <code>63FF7459612D530D4BF53322B44E92E0</code> <code>2EA5E84CC22BD7C016C81DF2FA98DEBE</code> <code>B73D5D8AC8D36D034260785276C26169</code> <code>A2197A7407C4D35327EF7767C5C85602</code> <code>A209341215D16D00786CE83066CFE3B6</code><br> <code>21526EEF</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 24D0297FB1578EB57D1BB090DE7DDBB084CEB33A48CA1A7CD1BD38ADB0E7CE35DE207C038551827BB7A38AF85388AAA9B64C8A7F28E6A0B74AFEBDEB11911A19C77F68551FB0BB18C2B6042EA0443D17C759A00F88E1B919D5F613617275C4F714B7E3E42C1346CF37CFB7E405DC835221DC3B8DB4FECE96063C5EB495ED1B1DA2A480F4A1F27C285E8176C4188A283A0F0BEEF9093A058F3F69091C39E666F097BD0BB2AE47BC46CCEB1B956C510018F627D62C70D2B72BAC7B0BDCCE187C326D66458EE22E63159BE2C1A2F77563D7C3F20FE888FAFBB67BCB18BBAD5B491848D53BA9D84CD4B831F67F447BDC686C9EB7EE7B17C9C00D426FC4FB127CD14DB42BF7EA052ED15D9D5EDF2FC06AF175B328E6A53AA6B5320780746C7C811A50235DE7E35D08E44D522C4A1763B68489BDA36FB7F60BFE174302DC7250DC0F0C9A8A2AA9652BDE11569208B824539A954C12EE41C0892D80E443E20BE24AB36576F68C67CC90360E85FCC192552DC423F6BA1165F22378F8B392915F891EDC57C15B64AC0BEF3F4E075F9C4BEEFB9A4EF30EEB4A8203EE6051109D97DEF147B76C42AAB3C72746C4D70E2648AC7935B721AD64009EC5A519DF85BAED490EEBCAC069821D710FD1657DD729FC5B7769B87D3E9017C90F34EFC1393CA1B1E4AC2EFE2D53E158E77A8FED952B662781B3192F4447EB44C4A8C8CAECDA0263FF7459612D530D4BF53322B44E92E02EA5E84CC22BD7C016C81DF2FA98DEBEB73D5D8AC8D36D034260785276C26169A2197A7407C4D35327EF7767C5C85602A209341215D16D00786CE83066CFE3B621526EEF
tmp_aes_key = 87A16D7D6F2AED65D4FDB26C6F77466043B2F2DB09F5CB131C091193BA7493A5
tmp_aes_iv = 2EF58137AFB5123EADA871026C9DEB69207A69AD90ADC7FACA1570495E493CEC</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = AC0276C7739EEDE2111877BDA636E63A646074A1BA0D89B56387AFED6602EEC4BE34FFABCB7831469181A50F01240CA85879086C850C6C5803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010061A54F355453D62BA850E1DEB2B9577E0ADFA00EF2B6A78426054AA8860885A2169064A4596EBF4CC332B564EC7594E841A8658355698A403EEF98C3D777919475A8311E62ECA435DBEC740F8BB8677C6A7650542872F24967352E83EEB889A44588DE6C8B380F7F69617EEE1C11344E3CB123DD27550D752E87567DED6E1CFE21ED4D517855E71E08BE0FC5144837BADB8CD899CA09E16C778CC9BDD7FC548D316F56EC204601F70E7C0103978014067D4BA5271C1D261CCCFA79CF5F6D6B47D768AABD844BB343A25341AD29BD9E705B1BB8EEDFEAE6AC6C775DB2B3324C4E02A84EFC1080DDB22B568C58FF05E633DD7D868EADC5DE69E44184964E260E146E4CA166B99604E76897DCB2
answer = BA0D89B56387AFED6602EEC4BE34FFABCB7831469181A50F01240CA85879086C850C6C5803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010061A54F355453D62BA850E1DEB2B9577E0ADFA00EF2B6A78426054AA8860885A2169064A4596EBF4CC332B564EC7594E841A8658355698A403EEF98C3D777919475A8311E62ECA435DBEC740F8BB8677C6A7650542872F24967352E83EEB889A44588DE6C8B380F7F69617EEE1C11344E3CB123DD27550D752E87567DED6E1CFE21ED4D517855E71E08BE0FC5144837BADB8CD899CA09E16C778CC9BDD7FC548D316F56EC204601F70E7C0103978014067D4BA5271C1D261CCCFA79CF5F6D6B47D768AABD844BB343A25341AD29BD9E705B1BB8EEDFEAE6AC6C775DB2B3324C4E02A84EFC1080DDB22B568C58FF05E633DD7D868EADC5DE69E44184964E260E146E4CA166B99604E76897DCB2</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 63 87 AF ED 66 02 EE C4 BE 34 FF AB
0010 | CB 78 31 46 91 81 A5 0F 01 24 0C A8 58 79 08 6C
0020 | 85 0C 6C 58 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 61 A5 4F 35 54 53 D6 2B A8 50 E1 DE B2 B9 57 7E
0140 | 0A DF A0 0E F2 B6 A7 84 26 05 4A A8 86 08 85 A2
0150 | 16 90 64 A4 59 6E BF 4C C3 32 B5 64 EC 75 94 E8
0160 | 41 A8 65 83 55 69 8A 40 3E EF 98 C3 D7 77 91 94
0170 | 75 A8 31 1E 62 EC A4 35 DB EC 74 0F 8B B8 67 7C
0180 | 6A 76 50 54 28 72 F2 49 67 35 2E 83 EE B8 89 A4
0190 | 45 88 DE 6C 8B 38 0F 7F 69 61 7E EE 1C 11 34 4E
01A0 | 3C B1 23 DD 27 55 0D 75 2E 87 56 7D ED 6E 1C FE
01B0 | 21 ED 4D 51 78 55 E7 1E 08 BE 0F C5 14 48 37 BA
01C0 | DB 8C D8 99 CA 09 E1 6C 77 8C C9 BD D7 FC 54 8D
01D0 | 31 6F 56 EC 20 46 01 F7 0E 7C 01 03 97 80 14 06
01E0 | 7D 4B A5 27 1C 1D 26 1C CC FA 79 CF 5F 6D 6B 47
01F0 | D7 68 AA BD 84 4B B3 43 A2 53 41 AD 29 BD 9E 70
0200 | 5B 1B B8 EE DF EA E6 AC 6C 77 5D B2 B3 32 4C 4E
0210 | 02 A8 4E FC 10 80 DD B2 2B 56 8C 58 FF 05 E6 33
0220 | DD 7D 86 8E AD C5 DE 69 E4 41 84 96 4E 26 0E 14
0230 | 6E 4C A1 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010061A54F355453D62BA850E1DE</code> <code>B2B9577E0ADFA00EF2B6A78426054AA8</code> <code>860885A2169064A4596EBF4CC332B564</code> <code>EC7594E841A8658355698A403EEF98C3</code> <code>D777919475A8311E62ECA435DBEC740F</code> <code>8BB8677C6A7650542872F24967352E83</code> <code>EEB889A44588DE6C8B380F7F69617EEE</code> <code>1C11344E3CB123DD27550D752E87567D</code> <code>ED6E1CFE21ED4D517855E71E08BE0FC5</code> <code>144837BADB8CD899CA09E16C778CC9BD</code> <code>D7FC548D316F56EC204601F70E7C0103</code> <code>978014067D4BA5271C1D261CCCFA79CF</code> <code>5F6D6B47D768AABD844BB343A25341AD</code> <code>29BD9E705B1BB8EEDFEAE6AC6C775DB2</code> <code>B3324C4E02A84EFC1080DDB22B568C58</code> <code>FF05E633DD7D868EADC5DE69E4418496</code><br> <code>4E260E14</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>6E4CA166</code> (1721846894 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = AF7377821F4A9AD25A2BA317730937A3852EC889E1EE846D52D8847A731DD1EB1625F623DDA1EAF34E96B6B5734D036A4A635EA7DCCC5A413DEE6DF0FE00BF555215612BC3092F68859788BE46C9672AD4EEF080B297AEBA45FED1C6821A0764CFCEDF2FBB8CFD21C0F2A7A9DF24586610CAA82763FDD6E236601C4080B3E44671DEB8486CEFDD53CA18A3008466ACF7B746CB5AB67026B2E791CA535A7A1ED8E87E762400360E1DECE1AA9F117CCAF9492354661B2F8A869F3D5D182CC8538366167512F8FCA58A54E9179D88E415DC57826D7BE026AB623106298EA0D9B01DE8D1A36DECB903B006787E7899E72DD7D4FEF2EAE08684039CF2F6381D5ED5F2</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 1CA04FBD754009365B8FF282703B55FA9F7D69CB6A2CE521C355F750865FB2A2F75B2788FDB3B19ACA8F7C25334D042E8D9363181E01844D6B573B45A53172E29025E53BA90749951B1CE528DCDBC30BADF95340BAB141050864D02529D81136CCE69F88DCEDEA0AD9251E5D8F57C2B1EFC873C2993B635484C2E83807D7833A4DF6AEE22D614651452DB36F4A0ABE5A5C679CCD88CA874290672DC71644B5FC6D374BA3F4C9976860D6F5CCC50E66E3F30DDBA74AF340FC3629E99863E40903C42BFFDEAC80F2524543DD0887D0FFFBFACE0775B7EC64F4F5452C800DAFE4A2A342229EA3234A0838910A3E52D6CF8CA0C83D7612863174688F341E5E9169DA</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 63 87 AF ED 66 02 EE C4 BE 34 FF AB
0010 | CB 78 31 46 91 81 A5 0F 01 24 0C A8 58 79 08 6C
0020 | 85 0C 6C 58 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 1C A0 4F BD 75 40 09 36 5B 8F F2 82 70 3B 55 FA
0040 | 9F 7D 69 CB 6A 2C E5 21 C3 55 F7 50 86 5F B2 A2
0050 | F7 5B 27 88 FD B3 B1 9A CA 8F 7C 25 33 4D 04 2E
0060 | 8D 93 63 18 1E 01 84 4D 6B 57 3B 45 A5 31 72 E2
0070 | 90 25 E5 3B A9 07 49 95 1B 1C E5 28 DC DB C3 0B
0080 | AD F9 53 40 BA B1 41 05 08 64 D0 25 29 D8 11 36
0090 | CC E6 9F 88 DC ED EA 0A D9 25 1E 5D 8F 57 C2 B1
00A0 | EF C8 73 C2 99 3B 63 54 84 C2 E8 38 07 D7 83 3A
00B0 | 4D F6 AE E2 2D 61 46 51 45 2D B3 6F 4A 0A BE 5A
00C0 | 5C 67 9C CD 88 CA 87 42 90 67 2D C7 16 44 B5 FC
00D0 | 6D 37 4B A3 F4 C9 97 68 60 D6 F5 CC C5 0E 66 E3
00E0 | F3 0D DB A7 4A F3 40 FC 36 29 E9 98 63 E4 09 03
00F0 | C4 2B FF DE AC 80 F2 52 45 43 DD 08 87 D0 FF FB
0100 | FA CE 07 75 B7 EC 64 F4 F5 45 2C 80 0D AF E4 A2
0110 | A3 42 22 9E A3 23 4A 08 38 91 0A 3E 52 D6 CF 8C
0120 | A0 C8 3D 76 12 86 31 74 68 8F 34 1E 5E 91 69 DA</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001001CA04FBD754009365B8FF282</code> <code>703B55FA9F7D69CB6A2CE521C355F750</code> <code>865FB2A2F75B2788FDB3B19ACA8F7C25</code> <code>334D042E8D9363181E01844D6B573B45</code> <code>A53172E29025E53BA90749951B1CE528</code> <code>DCDBC30BADF95340BAB141050864D025</code> <code>29D81136CCE69F88DCEDEA0AD9251E5D</code> <code>8F57C2B1EFC873C2993B635484C2E838</code> <code>07D7833A4DF6AEE22D614651452DB36F</code> <code>4A0ABE5A5C679CCD88CA874290672DC7</code> <code>1644B5FC6D374BA3F4C9976860D6F5CC</code> <code>C50E66E3F30DDBA74AF340FC3629E998</code> <code>63E40903C42BFFDEAC80F2524543DD08</code> <code>87D0FFFBFACE0775B7EC64F4F5452C80</code> <code>0DAFE4A2A342229EA3234A0838910A3E</code> <code>52D6CF8CA0C83D7612863174688F341E</code><br> <code>5E9169DA</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643666387AFED6602EEC4BE34FFABCB7831469181A50F01240CA85879086C850C6C580000000000000000FE0001001CA04FBD754009365B8FF282703B55FA9F7D69CB6A2CE521C355F750865FB2A2F75B2788FDB3B19ACA8F7C25334D042E8D9363181E01844D6B573B45A53172E29025E53BA90749951B1CE528DCDBC30BADF95340BAB141050864D02529D81136CCE69F88DCEDEA0AD9251E5D8F57C2B1EFC873C2993B635484C2E83807D7833A4DF6AEE22D614651452DB36F4A0ABE5A5C679CCD88CA874290672DC71644B5FC6D374BA3F4C9976860D6F5CCC50E66E3F30DDBA74AF340FC3629E99863E40903C42BFFDEAC80F2524543DD0887D0FFFBFACE0775B7EC64F4F5452C800DAFE4A2A342229EA3234A0838910A3E52D6CF8CA0C83D7612863174688F341E5E9169DA
padding = 7D41867F9FBED9344D62FB68
tmp_aes_key = 87A16D7D6F2AED65D4FDB26C6F77466043B2F2DB09F5CB131C091193BA7493A5
tmp_aes_iv = 2EF58137AFB5123EADA871026C9DEB69207A69AD90ADC7FACA1570495E493CEC</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 128050427D220458D6D465483BD6792A75C2B14E84C610B3F6DD61C61D726D602F62BD7271C61C6D535A72AF63DFA8CCC375D246D9E64D985DCEA9C2A42CF76C2BEC2A275B578EFD27B054ABF7C088FEDBEA46C3DA5AD096B09C6B1E4256A08D37ECE8F6EE7B47B142AE7DA9816D41587471D443197ECCF0683AB25EAD6A2FDD696D6D752EAF2A12865AA504CBA16B7F39A18B9BAAE6103F539B56FA7D49D16E944041DDA3468F895FAA157164A7269A22D1EFD825F6BB01F0C784FA78E52182146AF568D6825818359C70EAA655C59019B534DC7F96B4D8A75589859B41BBD93624095D1A3D1BB4DBAAB42949F0E76627F4BB838BAC71AADA4A545496490C5DCBB4AE9397D89B837B00A01A2BD7961CF50E7F8A6FD804475E28F76E5006462F69C8989C2B0D1665D0542DE9BD04C70F165885F4DA49997199866990492C7B652FE2729BA002F4967CB4980844249F82</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F4 28 0E 00 6E 4C A1 66
0010 | 78 01 00 00 1F 5F 04 F5 63 87 AF ED 66 02 EE C4
0020 | BE 34 FF AB CB 78 31 46 91 81 A5 0F 01 24 0C A8
0030 | 58 79 08 6C 85 0C 6C 58 FE 50 01 00 12 80 50 42
0040 | 7D 22 04 58 D6 D4 65 48 3B D6 79 2A 75 C2 B1 4E
0050 | 84 C6 10 B3 F6 DD 61 C6 1D 72 6D 60 2F 62 BD 72
0060 | 71 C6 1C 6D 53 5A 72 AF 63 DF A8 CC C3 75 D2 46
0070 | D9 E6 4D 98 5D CE A9 C2 A4 2C F7 6C 2B EC 2A 27
0080 | 5B 57 8E FD 27 B0 54 AB F7 C0 88 FE DB EA 46 C3
0090 | DA 5A D0 96 B0 9C 6B 1E 42 56 A0 8D 37 EC E8 F6
00A0 | EE 7B 47 B1 42 AE 7D A9 81 6D 41 58 74 71 D4 43
00B0 | 19 7E CC F0 68 3A B2 5E AD 6A 2F DD 69 6D 6D 75
00C0 | 2E AF 2A 12 86 5A A5 04 CB A1 6B 7F 39 A1 8B 9B
00D0 | AA E6 10 3F 53 9B 56 FA 7D 49 D1 6E 94 40 41 DD
00E0 | A3 46 8F 89 5F AA 15 71 64 A7 26 9A 22 D1 EF D8
00F0 | 25 F6 BB 01 F0 C7 84 FA 78 E5 21 82 14 6A F5 68
0100 | D6 82 58 18 35 9C 70 EA A6 55 C5 90 19 B5 34 DC
0110 | 7F 96 B4 D8 A7 55 89 85 9B 41 BB D9 36 24 09 5D
0120 | 1A 3D 1B B4 DB AA B4 29 49 F0 E7 66 27 F4 BB 83
0130 | 8B AC 71 AA DA 4A 54 54 96 49 0C 5D CB B4 AE 93
0140 | 97 D8 9B 83 7B 00 A0 1A 2B D7 96 1C F5 0E 7F 8A
0150 | 6F D8 04 47 5E 28 F7 6E 50 06 46 2F 69 C8 98 9C
0160 | 2B 0D 16 65 D0 54 2D E9 BD 04 C7 0F 16 58 85 F4
0170 | DA 49 99 71 99 86 69 90 49 2C 7B 65 2F E2 72 9B
0180 | A0 02 F4 96 7C B4 98 08 44 24 9F 82</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F4280E006E4CA166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100128050427D220458D6D46548</code> <code>3BD6792A75C2B14E84C610B3F6DD61C6</code> <code>1D726D602F62BD7271C61C6D535A72AF</code> <code>63DFA8CCC375D246D9E64D985DCEA9C2</code> <code>A42CF76C2BEC2A275B578EFD27B054AB</code> <code>F7C088FEDBEA46C3DA5AD096B09C6B1E</code> <code>4256A08D37ECE8F6EE7B47B142AE7DA9</code> <code>816D41587471D443197ECCF0683AB25E</code> <code>AD6A2FDD696D6D752EAF2A12865AA504</code> <code>CBA16B7F39A18B9BAAE6103F539B56FA</code> <code>7D49D16E944041DDA3468F895FAA1571</code> <code>64A7269A22D1EFD825F6BB01F0C784FA</code> <code>78E52182146AF568D6825818359C70EA</code> <code>A655C59019B534DC7F96B4D8A7558985</code> <code>9B41BBD93624095D1A3D1BB4DBAAB429</code> <code>49F0E76627F4BB838BAC71AADA4A5454</code> <code>96490C5DCBB4AE9397D89B837B00A01A</code> <code>2BD7961CF50E7F8A6FD804475E28F76E</code> <code>5006462F69C8989C2B0D1665D0542DE9</code> <code>BD04C70F165885F4DA49997199866990</code> <code>492C7B652FE2729BA002F4967CB49808</code><br> <code>44249F82</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 41BF02FB10F92AC40FC93D22820D05D943FAAFDC3D5B03F814409357751ABDCE81334CCD6BBDF5EBF0BCB127ED1989FA40D52C45C93C0CA4120A299E23BEEDA657ABDD4495CED827F3E87AA7DC13804EE1C80DE61DDAE5B28357450AA42D2D00600A5A354BC1936A55A337103342E9A4809839EE69CF01B36DCEAAC03815AA2C681261581ECE75E2F4AC5C32733966A5F25F0822A6233B8EC464F4415F9862F04A51D6D42662DDFBB2CE40735A80DEA7023325216DE430FC470B8EFD55803B1EA98053F1A926D322FD90EF2F21B8319F655459CABAA827DB379B7B7D59A1866D78AE919E23E21399432891C857BF4DF5946E8070107586EC4DBDC1190564293B</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B0 01 1E 6F 4C A1 66
0010 | 90 00 00 00 34 F7 CB 3B 63 87 AF ED 66 02 EE C4
0020 | BE 34 FF AB CB 78 31 46 91 81 A5 0F 01 24 0C A8
0030 | 58 79 08 6C 85 0C 6C 58 7F 1F 84 10 80 7A 10 EB
0040 | 7C 48 40 9D A8 D9 F1 03</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B0011E6F4CA166</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>90000000</code> (144 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>6387AFED6602EEC4BE34FFABCB783146</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9181A50F01240CA85879086C850C6C58</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>7F1F8410807A10EB7C48409DA8D9F103</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

