<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 04 1D 0D 00 56 98 C1 68
0010 | 14 00 00 00 F1 8E 7E BE 69 F8 10 3B 88 E6 69 ED
0020 | 89 BA 1B 8D 47 BF 86 75</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>041D0D005698C168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 F8 36 86 56 98 C1 68
0010 | 50 00 00 00 63 24 16 05 69 F8 10 3B 88 E6 69 ED
0020 | 89 BA 1B 8D 47 BF 86 75 0C D2 C6 49 62 76 E5 81
0030 | D2 CA F0 25 A5 E7 75 94 08 21 DB 7B A4 60 7D AD
0040 | D3 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01F836865698C168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0821DB7BA4607DADD3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2439679569074957779</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2439679569074957779</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2439679569074957779 = 1338936563 * 1822102433</code></p>
<pre><code>p = 1338936563
q = 1822102433</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 21 DB 7B A4 60 7D AD D3 00 00 00
0010 | 04 4F CE 8C F3 00 00 00 04 6C 9B 13 A1 00 00 00
0020 | 69 F8 10 3B 88 E6 69 ED 89 BA 1B 8D 47 BF 86 75
0030 | 0C D2 C6 49 62 76 E5 81 D2 CA F0 25 A5 E7 75 94
0040 | F5 B6 A7 16 4A 8B 92 D9 D9 90 68 09 47 25 7A 46
0050 | 03 F4 6C BA 3B 76 86 99 39 52 8C E8 FE FF 7C CB
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0821DB7BA4607DADD3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2439679569074957779</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>044FCE8CF3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1338936563</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046C9B13A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1822102433</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>F5B6A7164A8B92D9D990680947257A46</code> <code>03F46CBA3B76869939528CE8FEFF7CCB</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90821DB7BA4607DADD3000000044FCE8CF3000000046C9B13A100000069F8103B88E669ED89BA1B8D47BF86750CD2C6496276E581D2CAF025A5E77594F5B6A7164A8B92D9D990680947257A4603F46CBA3B76869939528CE8FEFF7CCB02000000
random_padding_bytes = 2C41D23EBEFB0714A0887C5590D397E2FB389230646BD05AB6F42CEEB1C356AF5680CCC12D3382B64D8C99A5D39A7C850A825A580DBB741F3F2E518F35459087A29A6FF27AAA134CB67992963B460BE4F581A63CD4CD8E5E11C4228F</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 8B02F74CA1AADFDAF49650A1E0A3F09834D75BE61E95309A2533AE584CECE298AA45B3F8CA2A517957E11D9C4351CEB77B39E01C6F7AE4F20E849B8C6A51EE1815026B40497E72193762DEA1370E0B259B3A421631DE9C97F4F11FB59B8D62DD21F49F6645237503A90AE09CB1E568CE0543E1A7D8261C49984C5D9FD86689E9C661BDDF8328DB10F8D82C339022055FD3C7F2413CF67BEC82CAA2406932654931CE9EF38A5DF146F3F667DF01B3AF0664A1ED48637526D57BD3AEC3014FE0750E5AD84BA62C9FED9A64D19DD1A5EDEE6C2736F1648A88E6D3CD383683A50BACD32B36C268280767905357E6729DD64C5B085D0C4A3E281F828061BCED938C88</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 08 1D 0D 00 56 98 C1 68
0010 | 40 01 00 00 BE E4 12 D7 69 F8 10 3B 88 E6 69 ED
0020 | 89 BA 1B 8D 47 BF 86 75 0C D2 C6 49 62 76 E5 81
0030 | D2 CA F0 25 A5 E7 75 94 04 4F CE 8C F3 00 00 00
0040 | 04 6C 9B 13 A1 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 8B 02 F7 4C A1 AA DF DA F4 96 50 A1
0060 | E0 A3 F0 98 34 D7 5B E6 1E 95 30 9A 25 33 AE 58
0070 | 4C EC E2 98 AA 45 B3 F8 CA 2A 51 79 57 E1 1D 9C
0080 | 43 51 CE B7 7B 39 E0 1C 6F 7A E4 F2 0E 84 9B 8C
0090 | 6A 51 EE 18 15 02 6B 40 49 7E 72 19 37 62 DE A1
00A0 | 37 0E 0B 25 9B 3A 42 16 31 DE 9C 97 F4 F1 1F B5
00B0 | 9B 8D 62 DD 21 F4 9F 66 45 23 75 03 A9 0A E0 9C
00C0 | B1 E5 68 CE 05 43 E1 A7 D8 26 1C 49 98 4C 5D 9F
00D0 | D8 66 89 E9 C6 61 BD DF 83 28 DB 10 F8 D8 2C 33
00E0 | 90 22 05 5F D3 C7 F2 41 3C F6 7B EC 82 CA A2 40
00F0 | 69 32 65 49 31 CE 9E F3 8A 5D F1 46 F3 F6 67 DF
0100 | 01 B3 AF 06 64 A1 ED 48 63 75 26 D5 7B D3 AE C3
0110 | 01 4F E0 75 0E 5A D8 4B A6 2C 9F ED 9A 64 D1 9D
0120 | D1 A5 ED EE 6C 27 36 F1 64 8A 88 E6 D3 CD 38 36
0130 | 83 A5 0B AC D3 2B 36 C2 68 28 07 67 90 53 57 E6
0140 | 72 9D D6 4C 5B 08 5D 0C 4A 3E 28 1F 82 80 61 BC
0150 | ED 93 8C 88</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>081D0D005698C168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>044FCE8CF3000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1338936563</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046C9B13A1000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1822102433</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE0001008B02F74CA1AADFDAF49650A1</code> <code>E0A3F09834D75BE61E95309A2533AE58</code> <code>4CECE298AA45B3F8CA2A517957E11D9C</code> <code>4351CEB77B39E01C6F7AE4F20E849B8C</code> <code>6A51EE1815026B40497E72193762DEA1</code> <code>370E0B259B3A421631DE9C97F4F11FB5</code> <code>9B8D62DD21F49F6645237503A90AE09C</code> <code>B1E568CE0543E1A7D8261C49984C5D9F</code> <code>D86689E9C661BDDF8328DB10F8D82C33</code> <code>9022055FD3C7F2413CF67BEC82CAA240</code> <code>6932654931CE9EF38A5DF146F3F667DF</code> <code>01B3AF0664A1ED48637526D57BD3AEC3</code> <code>014FE0750E5AD84BA62C9FED9A64D19D</code> <code>D1A5EDEE6C2736F1648A88E6D3CD3836</code> <code>83A50BACD32B36C268280767905357E6</code> <code>729DD64C5B085D0C4A3E281F828061BC</code><br> <code>ED938C88</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 92 BD 56 98 C1 68
0010 | 78 02 00 00 5C 07 E8 D0 69 F8 10 3B 88 E6 69 ED
0020 | 89 BA 1B 8D 47 BF 86 75 0C D2 C6 49 62 76 E5 81
0030 | D2 CA F0 25 A5 E7 75 94 FE 50 02 00 BF FA 45 A6
0040 | B8 E4 19 5A 8F 0B 70 72 02 E1 38 32 5F 14 AA 74
0050 | 56 E5 5A 28 4C 13 AD 84 B4 89 76 7A 83 78 F3 E0
0060 | 60 1D 3F 92 3D 7E 0E FE BC F1 33 62 47 88 59 63
0070 | 9F DA 6B 96 62 1C BE FF 50 82 46 A2 C5 30 97 F8
0080 | 13 4F 1F 96 CC 26 74 AC 75 2C 2D 36 78 D7 25 E9
0090 | 30 6B 60 07 77 F8 39 A1 29 8A 60 B4 E2 B9 70 78
00A0 | 16 8B AB 4B 2D D8 6E AA ED D4 55 91 26 EF 63 06
00B0 | 6F CF 60 F2 7B 2D FA 28 44 90 02 2D 29 AC DD 5D
00C0 | FE FC 74 0F 6E 4E B0 1F 2B F2 78 E7 98 23 BC 3A
00D0 | 9C 58 D7 0C 44 B9 23 B8 75 E1 49 27 83 A7 3B 1B
00E0 | D6 ED 2C A3 95 41 04 2A 6B 29 E0 17 34 83 0B 16
00F0 | BF C1 52 A5 26 16 DB 66 88 09 2D F8 CB E1 67 8D
0100 | 47 BD C5 28 E1 B7 67 0B 28 37 24 52 A1 8C AE F0
0110 | 08 A0 C8 AB 9E 10 43 C4 F1 52 3A 08 30 91 E3 5F
0120 | C3 27 41 3F 3F 2E AB 7F 70 BC 89 17 61 83 C1 5D
0130 | 5F BD 2E 84 27 63 73 3D BE AB 96 43 97 EC 35 25
0140 | AD 53 67 AC D4 8E 0A A6 6D B7 C7 3E 12 FF FC 3B
0150 | 92 AC 0D D9 3E D8 30 FC D7 4D 2E CB 66 CA 29 67
0160 | A6 F6 43 5F 7F B7 FE F4 2D 72 C2 48 C6 5C EB 95
0170 | 9F 93 12 5A 83 5C 9A 6D AB 58 EE 1E 6D 7C C1 3D
0180 | 1B F8 F5 97 2F A0 2B 17 04 86 97 07 92 65 AD 16
0190 | 55 95 FA CF 31 E6 25 B0 0A BC C3 33 5E 14 D9 4C
01A0 | A2 E1 0B 0D 03 A7 40 11 C3 17 59 DE 4B F0 24 E9
01B0 | 6F EB 2A 2B 7E DB E7 B5 2B 0D C5 80 71 CB 49 69
01C0 | 43 61 86 57 A8 AD E1 3A 90 7E 3D E1 64 E0 9C 7D
01D0 | CF B4 49 D4 E4 BB 3A B2 9E C5 8D 64 72 7A 23 97
01E0 | 62 8D B3 03 F2 EA 9E 57 9A DA B9 67 2B 30 9A 56
01F0 | C7 A4 59 47 8E 9D DB 68 9A 51 C7 C5 A5 5E FB 81
0200 | D6 95 EE 7C 59 AF B1 44 73 54 8C 19 C8 11 57 A4
0210 | 4E 90 BA 31 93 69 C2 95 DE 11 4D 9F 35 FA 82 4A
0220 | A7 31 37 8F 7C 3F A2 F3 A1 64 B1 11 13 D5 F2 E5
0230 | 52 56 F8 5C 0D E7 72 85 7A 33 88 5C 9E 6A 08 93
0240 | 50 53 E9 8E 49 52 67 A9 C2 37 67 0D 6E 80 0B 04
0250 | EC 71 C5 CD F7 2B 6A C2 42 2B 0C A2 39 B4 E7 25
0260 | 0B 1F 16 8C 91 4F BF 13 DB 1C 0C 8F 44 F7 F3 AF
0270 | 1D D9 B9 A0 D6 20 48 DB 4D A4 1D BA DE DB 14 9A
0280 | C8 A0 5B FB 2A E5 B9 D1 25 76 5F 7F</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C492BD5698C168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200BFFA45A6B8E4195A8F0B7072</code> <code>02E138325F14AA7456E55A284C13AD84</code> <code>B489767A8378F3E0601D3F923D7E0EFE</code> <code>BCF13362478859639FDA6B96621CBEFF</code> <code>508246A2C53097F8134F1F96CC2674AC</code> <code>752C2D3678D725E9306B600777F839A1</code> <code>298A60B4E2B97078168BAB4B2DD86EAA</code> <code>EDD4559126EF63066FCF60F27B2DFA28</code> <code>4490022D29ACDD5DFEFC740F6E4EB01F</code> <code>2BF278E79823BC3A9C58D70C44B923B8</code> <code>75E1492783A73B1BD6ED2CA39541042A</code> <code>6B29E01734830B16BFC152A52616DB66</code> <code>88092DF8CBE1678D47BDC528E1B7670B</code> <code>28372452A18CAEF008A0C8AB9E1043C4</code> <code>F1523A083091E35FC327413F3F2EAB7F</code> <code>70BC89176183C15D5FBD2E842763733D</code> <code>BEAB964397EC3525AD5367ACD48E0AA6</code> <code>6DB7C73E12FFFC3B92AC0DD93ED830FC</code> <code>D74D2ECB66CA2967A6F6435F7FB7FEF4</code> <code>2D72C248C65CEB959F93125A835C9A6D</code> <code>AB58EE1E6D7CC13D1BF8F5972FA02B17</code> <code>048697079265AD165595FACF31E625B0</code> <code>0ABCC3335E14D94CA2E10B0D03A74011</code> <code>C31759DE4BF024E96FEB2A2B7EDBE7B5</code> <code>2B0DC58071CB496943618657A8ADE13A</code> <code>907E3DE164E09C7DCFB449D4E4BB3AB2</code> <code>9EC58D64727A2397628DB303F2EA9E57</code> <code>9ADAB9672B309A56C7A459478E9DDB68</code> <code>9A51C7C5A55EFB81D695EE7C59AFB144</code> <code>73548C19C81157A44E90BA319369C295</code> <code>DE114D9F35FA824AA731378F7C3FA2F3</code> <code>A164B11113D5F2E55256F85C0DE77285</code> <code>7A33885C9E6A08935053E98E495267A9</code> <code>C237670D6E800B04EC71C5CDF72B6AC2</code> <code>422B0CA239B4E7250B1F168C914FBF13</code> <code>DB1C0C8F44F7F3AF1DD9B9A0D62048DB</code> <code>4DA41DBADEDB149AC8A05BFB2AE5B9D1</code><br> <code>25765F7F</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = BFFA45A6B8E4195A8F0B707202E138325F14AA7456E55A284C13AD84B489767A8378F3E0601D3F923D7E0EFEBCF13362478859639FDA6B96621CBEFF508246A2C53097F8134F1F96CC2674AC752C2D3678D725E9306B600777F839A1298A60B4E2B97078168BAB4B2DD86EAAEDD4559126EF63066FCF60F27B2DFA284490022D29ACDD5DFEFC740F6E4EB01F2BF278E79823BC3A9C58D70C44B923B875E1492783A73B1BD6ED2CA39541042A6B29E01734830B16BFC152A52616DB6688092DF8CBE1678D47BDC528E1B7670B28372452A18CAEF008A0C8AB9E1043C4F1523A083091E35FC327413F3F2EAB7F70BC89176183C15D5FBD2E842763733DBEAB964397EC3525AD5367ACD48E0AA66DB7C73E12FFFC3B92AC0DD93ED830FCD74D2ECB66CA2967A6F6435F7FB7FEF42D72C248C65CEB959F93125A835C9A6DAB58EE1E6D7CC13D1BF8F5972FA02B17048697079265AD165595FACF31E625B00ABCC3335E14D94CA2E10B0D03A74011C31759DE4BF024E96FEB2A2B7EDBE7B52B0DC58071CB496943618657A8ADE13A907E3DE164E09C7DCFB449D4E4BB3AB29EC58D64727A2397628DB303F2EA9E579ADAB9672B309A56C7A459478E9DDB689A51C7C5A55EFB81D695EE7C59AFB14473548C19C81157A44E90BA319369C295DE114D9F35FA824AA731378F7C3FA2F3A164B11113D5F2E55256F85C0DE772857A33885C9E6A08935053E98E495267A9C237670D6E800B04EC71C5CDF72B6AC2422B0CA239B4E7250B1F168C914FBF13DB1C0C8F44F7F3AF1DD9B9A0D62048DB4DA41DBADEDB149AC8A05BFB2AE5B9D125765F7F
tmp_aes_key = F1219430A9E96AB47AD1C24E0324F40B03474DD6A4FF6ADF8FECB1F237079E22
tmp_aes_iv = E713318AA58F244271572A2A3106EFED5F2AE2D3C44AA13EF5C2B023F5B6A716</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 61F78C778558087BE91619F280B5B6DF35D200EABA0D89B569F8103B88E669ED89BA1B8D47BF86750CD2C6496276E581D2CAF025A5E7759403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010016B50A4E6860FC10BB3D21BA61A54D573F09F2497EDD386464338E721A111FB9E97F1D642E07BFCDE19D609F1014062ADF09313B7B04726AAF141859AC77B7630005768A7E6FCD7AC31FDD18528D98AA7FE53797A4988D75AE562DF0C84DBD6F7BBEBD556A0922C2EC1D72966BFCBB57E8A7C67AF6A6AC0863A7E6D53C1108FB420C86F4698FE0EE98763E111992C608E623AED0E2CC2D41E13378DF2A416D4A70F25D1453CEB61C90F67B3BBF2E5FF49744C518DA4A1C4E83FB660C34E7E204048F9EBF3E75D76054A5FBC54B0CA79A41ECFC38965F83D1B823148E8765DE89975468BB5E448A392D14355BEB5D266C7E43191F06081173B764F417AF4C5DF95698C168DB4FA9A8E5652168
answer = BA0D89B569F8103B88E669ED89BA1B8D47BF86750CD2C6496276E581D2CAF025A5E7759403000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE00010016B50A4E6860FC10BB3D21BA61A54D573F09F2497EDD386464338E721A111FB9E97F1D642E07BFCDE19D609F1014062ADF09313B7B04726AAF141859AC77B7630005768A7E6FCD7AC31FDD18528D98AA7FE53797A4988D75AE562DF0C84DBD6F7BBEBD556A0922C2EC1D72966BFCBB57E8A7C67AF6A6AC0863A7E6D53C1108FB420C86F4698FE0EE98763E111992C608E623AED0E2CC2D41E13378DF2A416D4A70F25D1453CEB61C90F67B3BBF2E5FF49744C518DA4A1C4E83FB660C34E7E204048F9EBF3E75D76054A5FBC54B0CA79A41ECFC38965F83D1B823148E8765DE89975468BB5E448A392D14355BEB5D266C7E43191F06081173B764F417AF4C5DF95698C168DB4FA9A8E5652168</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 69 F8 10 3B 88 E6 69 ED 89 BA 1B 8D
0010 | 47 BF 86 75 0C D2 C6 49 62 76 E5 81 D2 CA F0 25
0020 | A5 E7 75 94 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 16 B5 0A 4E 68 60 FC 10 BB 3D 21 BA 61 A5 4D 57
0140 | 3F 09 F2 49 7E DD 38 64 64 33 8E 72 1A 11 1F B9
0150 | E9 7F 1D 64 2E 07 BF CD E1 9D 60 9F 10 14 06 2A
0160 | DF 09 31 3B 7B 04 72 6A AF 14 18 59 AC 77 B7 63
0170 | 00 05 76 8A 7E 6F CD 7A C3 1F DD 18 52 8D 98 AA
0180 | 7F E5 37 97 A4 98 8D 75 AE 56 2D F0 C8 4D BD 6F
0190 | 7B BE BD 55 6A 09 22 C2 EC 1D 72 96 6B FC BB 57
01A0 | E8 A7 C6 7A F6 A6 AC 08 63 A7 E6 D5 3C 11 08 FB
01B0 | 42 0C 86 F4 69 8F E0 EE 98 76 3E 11 19 92 C6 08
01C0 | E6 23 AE D0 E2 CC 2D 41 E1 33 78 DF 2A 41 6D 4A
01D0 | 70 F2 5D 14 53 CE B6 1C 90 F6 7B 3B BF 2E 5F F4
01E0 | 97 44 C5 18 DA 4A 1C 4E 83 FB 66 0C 34 E7 E2 04
01F0 | 04 8F 9E BF 3E 75 D7 60 54 A5 FB C5 4B 0C A7 9A
0200 | 41 EC FC 38 96 5F 83 D1 B8 23 14 8E 87 65 DE 89
0210 | 97 54 68 BB 5E 44 8A 39 2D 14 35 5B EB 5D 26 6C
0220 | 7E 43 19 1F 06 08 11 73 B7 64 F4 17 AF 4C 5D F9
0230 | 56 98 C1 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE00010016B50A4E6860FC10BB3D21BA</code> <code>61A54D573F09F2497EDD386464338E72</code> <code>1A111FB9E97F1D642E07BFCDE19D609F</code> <code>1014062ADF09313B7B04726AAF141859</code> <code>AC77B7630005768A7E6FCD7AC31FDD18</code> <code>528D98AA7FE53797A4988D75AE562DF0</code> <code>C84DBD6F7BBEBD556A0922C2EC1D7296</code> <code>6BFCBB57E8A7C67AF6A6AC0863A7E6D5</code> <code>3C1108FB420C86F4698FE0EE98763E11</code> <code>1992C608E623AED0E2CC2D41E13378DF</code> <code>2A416D4A70F25D1453CEB61C90F67B3B</code> <code>BF2E5FF49744C518DA4A1C4E83FB660C</code> <code>34E7E204048F9EBF3E75D76054A5FBC5</code> <code>4B0CA79A41ECFC38965F83D1B823148E</code> <code>8765DE89975468BB5E448A392D14355B</code> <code>EB5D266C7E43191F06081173B764F417</code><br> <code>AF4C5DF9</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>5698C168</code> (1757517910 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = F3E452CDE80A5AC1F50109B51B7F1AB87A2EEEC5D4843500E51D29D5069070A76233BA324CA0DFBA6CD088AA69AF588D36FDCECEFFE3396E53FEA37F4D082B46FBC2267C4EBC658D3E42623D41E9F6420BDB608A33AC4835FBBDAEE6A58C439C8E39AB8E13AD8A84AF698BB91F1805EA720C3E0456A362B9878BF254EF91A91760CF7675203A317033BF1AE9FE262AFC0EAF3AB5E88AF75DEDDEEC355FFCE140A55BA38758D39A9D30176F87FE4EA3FAA989544C7DE092710960AB20EE2ABC5F8A68292225FC37A096E2FCEB06D5C70DDE099214D084B41F2921D43538002A1F8D43F437767697D090C574C999CAAB84F87D87D0A4EC04DA7787BE15C9D13CD0</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 3BEA71B7248828EABD4A53D159C6A6A1CAD84BBB6AEAD527460599D398B65484145F564B5B46CAE01F7C802544207C02BA704C5B574B095FBCB240A77EF882FB70AE38441F4F4414DD491F27F254F302F349440B7765AFA0192C4D3CC7A9C8AD5A631DD761A7553D1079C65DADDDFD02B65E55F8EBBC18A4A58227721534858EF38F0070045E4AAF6FAC291974E06E302DB8435323A8D8E4233B0F68E1FD9A6102DBB7D0696FE5062506AC7EE1DE3671FB4849F9C5AA7A8906C22B7B908693F378AA8F61583752A75FC59D20044571E85D7840B44FBC8384549917B61157AEAE63D9FB5FC45C191E64D9EAEE73BDD2CFD3DF73D2102D2F753BC86F68B00EEB03</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 69 F8 10 3B 88 E6 69 ED 89 BA 1B 8D
0010 | 47 BF 86 75 0C D2 C6 49 62 76 E5 81 D2 CA F0 25
0020 | A5 E7 75 94 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 3B EA 71 B7 24 88 28 EA BD 4A 53 D1 59 C6 A6 A1
0040 | CA D8 4B BB 6A EA D5 27 46 05 99 D3 98 B6 54 84
0050 | 14 5F 56 4B 5B 46 CA E0 1F 7C 80 25 44 20 7C 02
0060 | BA 70 4C 5B 57 4B 09 5F BC B2 40 A7 7E F8 82 FB
0070 | 70 AE 38 44 1F 4F 44 14 DD 49 1F 27 F2 54 F3 02
0080 | F3 49 44 0B 77 65 AF A0 19 2C 4D 3C C7 A9 C8 AD
0090 | 5A 63 1D D7 61 A7 55 3D 10 79 C6 5D AD DD FD 02
00A0 | B6 5E 55 F8 EB BC 18 A4 A5 82 27 72 15 34 85 8E
00B0 | F3 8F 00 70 04 5E 4A AF 6F AC 29 19 74 E0 6E 30
00C0 | 2D B8 43 53 23 A8 D8 E4 23 3B 0F 68 E1 FD 9A 61
00D0 | 02 DB B7 D0 69 6F E5 06 25 06 AC 7E E1 DE 36 71
00E0 | FB 48 49 F9 C5 AA 7A 89 06 C2 2B 7B 90 86 93 F3
00F0 | 78 AA 8F 61 58 37 52 A7 5F C5 9D 20 04 45 71 E8
0100 | 5D 78 40 B4 4F BC 83 84 54 99 17 B6 11 57 AE AE
0110 | 63 D9 FB 5F C4 5C 19 1E 64 D9 EA EE 73 BD D2 CF
0120 | D3 DF 73 D2 10 2D 2F 75 3B C8 6F 68 B0 0E EB 03</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001003BEA71B7248828EABD4A53D1</code> <code>59C6A6A1CAD84BBB6AEAD527460599D3</code> <code>98B65484145F564B5B46CAE01F7C8025</code> <code>44207C02BA704C5B574B095FBCB240A7</code> <code>7EF882FB70AE38441F4F4414DD491F27</code> <code>F254F302F349440B7765AFA0192C4D3C</code> <code>C7A9C8AD5A631DD761A7553D1079C65D</code> <code>ADDDFD02B65E55F8EBBC18A4A5822772</code> <code>1534858EF38F0070045E4AAF6FAC2919</code> <code>74E06E302DB8435323A8D8E4233B0F68</code> <code>E1FD9A6102DBB7D0696FE5062506AC7E</code> <code>E1DE3671FB4849F9C5AA7A8906C22B7B</code> <code>908693F378AA8F61583752A75FC59D20</code> <code>044571E85D7840B44FBC8384549917B6</code> <code>1157AEAE63D9FB5FC45C191E64D9EAEE</code> <code>73BDD2CFD3DF73D2102D2F753BC86F68</code><br> <code>B00EEB03</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B6436669F8103B88E669ED89BA1B8D47BF86750CD2C6496276E581D2CAF025A5E775940000000000000000FE0001003BEA71B7248828EABD4A53D159C6A6A1CAD84BBB6AEAD527460599D398B65484145F564B5B46CAE01F7C802544207C02BA704C5B574B095FBCB240A77EF882FB70AE38441F4F4414DD491F27F254F302F349440B7765AFA0192C4D3CC7A9C8AD5A631DD761A7553D1079C65DADDDFD02B65E55F8EBBC18A4A58227721534858EF38F0070045E4AAF6FAC291974E06E302DB8435323A8D8E4233B0F68E1FD9A6102DBB7D0696FE5062506AC7EE1DE3671FB4849F9C5AA7A8906C22B7B908693F378AA8F61583752A75FC59D20044571E85D7840B44FBC8384549917B61157AEAE63D9FB5FC45C191E64D9EAEE73BDD2CFD3DF73D2102D2F753BC86F68B00EEB03
padding = C8B882D710D77CDAE12F359A
tmp_aes_key = F1219430A9E96AB47AD1C24E0324F40B03474DD6A4FF6ADF8FECB1F237079E22
tmp_aes_iv = E713318AA58F244271572A2A3106EFED5F2AE2D3C44AA13EF5C2B023F5B6A716</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 2ABA928FFD8671EF793E35C82DD1872A77A3A205E60612EECA7BE68D5556CCC347993F9520993E0C64FED2BCE153B6A56C90ECA7191A3A8B70F237724FFF9DA983E5B304DA418B06863933B796DE0601F9ED709170A46EC544E2E3AF6569E675860BCAAADD6F0B6F8DEA2121D8B6737DCF1C2AD0A543F92F664065B4E34835BDED792BF2A0B120B6D9A5471B85F3CC09C9E9A86F207283CCBC9A9B52CC91E00606EA7CB893DB9BE61E09E47252FE1F9CEFDC82F3461E685EB9B4D7B3EEC85D6C07D8FC203C72BC85A55D13490C500F22BCAECE68D7BFA05589885A0BB2CCA4C7FA25A5583406D8418EC00541F84442341647DC1146EF70346D518B9CBCD585A8906335EAFD53071DB5A9BE8EEA1D1FCE5AE6B536E9C7565E53C39DE85FC995840EC9B8A4347D337EEC4164C24CE21FE1D4C9F62C18E7B062ADD34C11294CEBF15FBF1A2BF5E78571BE0330A0409FBE7E</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 DC E9 0E 00 56 98 C1 68
0010 | 78 01 00 00 1F 5F 04 F5 69 F8 10 3B 88 E6 69 ED
0020 | 89 BA 1B 8D 47 BF 86 75 0C D2 C6 49 62 76 E5 81
0030 | D2 CA F0 25 A5 E7 75 94 FE 50 01 00 2A BA 92 8F
0040 | FD 86 71 EF 79 3E 35 C8 2D D1 87 2A 77 A3 A2 05
0050 | E6 06 12 EE CA 7B E6 8D 55 56 CC C3 47 99 3F 95
0060 | 20 99 3E 0C 64 FE D2 BC E1 53 B6 A5 6C 90 EC A7
0070 | 19 1A 3A 8B 70 F2 37 72 4F FF 9D A9 83 E5 B3 04
0080 | DA 41 8B 06 86 39 33 B7 96 DE 06 01 F9 ED 70 91
0090 | 70 A4 6E C5 44 E2 E3 AF 65 69 E6 75 86 0B CA AA
00A0 | DD 6F 0B 6F 8D EA 21 21 D8 B6 73 7D CF 1C 2A D0
00B0 | A5 43 F9 2F 66 40 65 B4 E3 48 35 BD ED 79 2B F2
00C0 | A0 B1 20 B6 D9 A5 47 1B 85 F3 CC 09 C9 E9 A8 6F
00D0 | 20 72 83 CC BC 9A 9B 52 CC 91 E0 06 06 EA 7C B8
00E0 | 93 DB 9B E6 1E 09 E4 72 52 FE 1F 9C EF DC 82 F3
00F0 | 46 1E 68 5E B9 B4 D7 B3 EE C8 5D 6C 07 D8 FC 20
0100 | 3C 72 BC 85 A5 5D 13 49 0C 50 0F 22 BC AE CE 68
0110 | D7 BF A0 55 89 88 5A 0B B2 CC A4 C7 FA 25 A5 58
0120 | 34 06 D8 41 8E C0 05 41 F8 44 42 34 16 47 DC 11
0130 | 46 EF 70 34 6D 51 8B 9C BC D5 85 A8 90 63 35 EA
0140 | FD 53 07 1D B5 A9 BE 8E EA 1D 1F CE 5A E6 B5 36
0150 | E9 C7 56 5E 53 C3 9D E8 5F C9 95 84 0E C9 B8 A4
0160 | 34 7D 33 7E EC 41 64 C2 4C E2 1F E1 D4 C9 F6 2C
0170 | 18 E7 B0 62 AD D3 4C 11 29 4C EB F1 5F BF 1A 2B
0180 | F5 E7 85 71 BE 03 30 A0 40 9F BE 7E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>DCE90E005698C168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001002ABA928FFD8671EF793E35C8</code> <code>2DD1872A77A3A205E60612EECA7BE68D</code> <code>5556CCC347993F9520993E0C64FED2BC</code> <code>E153B6A56C90ECA7191A3A8B70F23772</code> <code>4FFF9DA983E5B304DA418B06863933B7</code> <code>96DE0601F9ED709170A46EC544E2E3AF</code> <code>6569E675860BCAAADD6F0B6F8DEA2121</code> <code>D8B6737DCF1C2AD0A543F92F664065B4</code> <code>E34835BDED792BF2A0B120B6D9A5471B</code> <code>85F3CC09C9E9A86F207283CCBC9A9B52</code> <code>CC91E00606EA7CB893DB9BE61E09E472</code> <code>52FE1F9CEFDC82F3461E685EB9B4D7B3</code> <code>EEC85D6C07D8FC203C72BC85A55D1349</code> <code>0C500F22BCAECE68D7BFA05589885A0B</code> <code>B2CCA4C7FA25A5583406D8418EC00541</code> <code>F84442341647DC1146EF70346D518B9C</code> <code>BCD585A8906335EAFD53071DB5A9BE8E</code> <code>EA1D1FCE5AE6B536E9C7565E53C39DE8</code> <code>5FC995840EC9B8A4347D337EEC4164C2</code> <code>4CE21FE1D4C9F62C18E7B062ADD34C11</code> <code>294CEBF15FBF1A2BF5E78571BE0330A0</code><br> <code>409FBE7E</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 96F138353E66C5D975E8609B09222EAB856E130D51385D6D4625178E1DA39ED02683E59FCDFEE0AA2A51DC45416ADBC37E1222CAE06199B0FC4D214555F18EB3D4B6985C1B9376A42D13C8ACDA35CE82B45ABCB2BFB4F0676DED72DBC14E3E547F0CB8F9B026DD7FAD3A9ABB572DE106F2370E6575BEEC2739E9A960B4F50EC2C2D8EB82A2D2FF80A9EF1B159F055E35641C406962861B3F3D8559EAD3EC9DD6658DC0C07C413F529DD11F9EBA1BBDBEF08C0504F1D03D2FA83D5283F0AE4EF5C3A490D6C69412DD53AD3C449B97C266523D09F62BB13AA5E40F97B78BED2222E17BD9DF204F97B5667DF2C4D88F9A8130C66342366802AFCA5DFB80B8527E52</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 24 8E 14 58 98 C1 68
0010 | 34 00 00 00 34 F7 CB 3B 69 F8 10 3B 88 E6 69 ED
0020 | 89 BA 1B 8D 47 BF 86 75 0C D2 C6 49 62 76 E5 81
0030 | D2 CA F0 25 A5 E7 75 94 56 26 83 49 BD DD 44 94
0040 | 8F 04 D8 49 B9 DB C9 29</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01248E145898C168</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>69F8103B88E669ED89BA1B8D47BF8675</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>0CD2C6496276E581D2CAF025A5E77594</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>56268349BDDD44948F04D849B9DBC929</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

