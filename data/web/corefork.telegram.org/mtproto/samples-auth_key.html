<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?239" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 A8 CF 05 00 9C 5A 99 66
0010 | 14 00 00 00 F1 8E 7E BE 50 78 49 F0 BB 9C 45 7D
0020 | BC E9 A3 22 DE EC 98 B7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>A8CF05009C5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 C4 B9 5E 9C 5A 99 66
0010 | 58 00 00 00 63 24 16 05 50 78 49 F0 BB 9C 45 7D
0020 | BC E9 A3 22 DE EC 98 B7 4C A9 67 F1 E6 C7 3D 67
0030 | 7B 05 7D BF 78 DF F1 D3 08 15 80 49 4E 74 1B AD
0040 | 5D 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01C4B95E9C5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081580494E741BAD5D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1549318873119698269</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1549318873119698269</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1549318873119698269 = 1070932559 * 1446700691</code></p>
<pre><code>p = 1070932559
q = 1446700691</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 15 80 49 4E 74 1B AD 5D 00 00 00
0010 | 04 3F D5 22 4F 00 00 00 04 56 3A E6 93 00 00 00
0020 | 50 78 49 F0 BB 9C 45 7D BC E9 A3 22 DE EC 98 B7
0030 | 4C A9 67 F1 E6 C7 3D 67 7B 05 7D BF 78 DF F1 D3
0040 | 4C E5 4E 26 62 A1 A6 0A BC 08 A2 9E 87 60 12 43
0050 | 40 51 A0 F7 BE 6B 2A CB A0 2B E1 71 F0 97 5A 9C
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081580494E741BAD5D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1549318873119698269</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>043FD5224F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1070932559</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04563AE693000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1446700691</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>4CE54E2662A1A60ABC08A29E87601243</code> <code>4051A0F7BE6B2ACBA02BE171F0975A9C</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081580494E741BAD5D000000043FD5224F00000004563AE693000000507849F0BB9C457DBCE9A322DEEC98B74CA967F1E6C73D677B057DBF78DFF1D34CE54E2662A1A60ABC08A29E876012434051A0F7BE6B2ACBA02BE171F0975A9C02000000
random_padding_bytes = E0E6960D4222BCEF97D292D36F8622288608D30E7A1D4B06D957A886C04FE74F2759D57CA75B699AB792ABE14574536B3ECEABC3688443716844D56933365C11811B9D7B374BB75C17A4682198EA2DA4E15C108CA12EE0BC312F7631</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = CBD04170B7D52A56D5A87939331B3C87B14EBF66602DB5D6F418B453BD58A2426D9FAF245BE3AE9B66292A7ED4574370994BE43BEBC2792A7C00D02D5A9DF226C6A1493A0CA4C994A80937E5D0B8E641FAB53DF19F79F1E3752F47A3CC6A4092FF924A5A402523C8B9C38273450CF0E52AD19BFA8B9F78697B1A34FAB84816E7191845C032A2600C41B456072CDEEC639BB3126F77FF6D5C99739D8EF36FC9A809D1776A22889BBF06467E818E5276914957EF367EC86422ADC37077D7C756C29F527F672550ACD9836C27202763EFF095645FB7EED4380F9B8CAC50D966D790064876C545FC0BFDC54BDF9044B6DB01A305BA19005D3306FBBEB2646E8D4864</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 38 7A 0D 00 9C 5A 99 66
0010 | 40 01 00 00 BE E4 12 D7 50 78 49 F0 BB 9C 45 7D
0020 | BC E9 A3 22 DE EC 98 B7 4C A9 67 F1 E6 C7 3D 67
0030 | 7B 05 7D BF 78 DF F1 D3 04 3F D5 22 4F 00 00 00
0040 | 04 56 3A E6 93 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 CB D0 41 70 B7 D5 2A 56 D5 A8 79 39
0060 | 33 1B 3C 87 B1 4E BF 66 60 2D B5 D6 F4 18 B4 53
0070 | BD 58 A2 42 6D 9F AF 24 5B E3 AE 9B 66 29 2A 7E
0080 | D4 57 43 70 99 4B E4 3B EB C2 79 2A 7C 00 D0 2D
0090 | 5A 9D F2 26 C6 A1 49 3A 0C A4 C9 94 A8 09 37 E5
00A0 | D0 B8 E6 41 FA B5 3D F1 9F 79 F1 E3 75 2F 47 A3
00B0 | CC 6A 40 92 FF 92 4A 5A 40 25 23 C8 B9 C3 82 73
00C0 | 45 0C F0 E5 2A D1 9B FA 8B 9F 78 69 7B 1A 34 FA
00D0 | B8 48 16 E7 19 18 45 C0 32 A2 60 0C 41 B4 56 07
00E0 | 2C DE EC 63 9B B3 12 6F 77 FF 6D 5C 99 73 9D 8E
00F0 | F3 6F C9 A8 09 D1 77 6A 22 88 9B BF 06 46 7E 81
0100 | 8E 52 76 91 49 57 EF 36 7E C8 64 22 AD C3 70 77
0110 | D7 C7 56 C2 9F 52 7F 67 25 50 AC D9 83 6C 27 20
0120 | 27 63 EF F0 95 64 5F B7 EE D4 38 0F 9B 8C AC 50
0130 | D9 66 D7 90 06 48 76 C5 45 FC 0B FD C5 4B DF 90
0140 | 44 B6 DB 01 A3 05 BA 19 00 5D 33 06 FB BE B2 64
0150 | 6E 8D 48 64</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>387A0D009C5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>043FD5224F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1070932559</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04563AE693000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1446700691</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100CBD04170B7D52A56D5A87939</code> <code>331B3C87B14EBF66602DB5D6F418B453</code> <code>BD58A2426D9FAF245BE3AE9B66292A7E</code> <code>D4574370994BE43BEBC2792A7C00D02D</code> <code>5A9DF226C6A1493A0CA4C994A80937E5</code> <code>D0B8E641FAB53DF19F79F1E3752F47A3</code> <code>CC6A4092FF924A5A402523C8B9C38273</code> <code>450CF0E52AD19BFA8B9F78697B1A34FA</code> <code>B84816E7191845C032A2600C41B45607</code> <code>2CDEEC639BB3126F77FF6D5C99739D8E</code> <code>F36FC9A809D1776A22889BBF06467E81</code> <code>8E5276914957EF367EC86422ADC37077</code> <code>D7C756C29F527F672550ACD9836C2720</code> <code>2763EFF095645FB7EED4380F9B8CAC50</code> <code>D966D790064876C545FC0BFDC54BDF90</code> <code>44B6DB01A305BA19005D3306FBBEB264</code><br> <code>6E8D4864</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 DF 16 9D 5A 99 66
0010 | 78 02 00 00 5C 07 E8 D0 50 78 49 F0 BB 9C 45 7D
0020 | BC E9 A3 22 DE EC 98 B7 4C A9 67 F1 E6 C7 3D 67
0030 | 7B 05 7D BF 78 DF F1 D3 FE 50 02 00 7B 41 FC 63
0040 | C4 53 22 E6 F7 9E 95 DD F1 5D 5A 51 8D 10 C5 9E
0050 | 4A E3 9C EE 98 19 D8 A6 FC E6 12 6B 3C 85 0D 21
0060 | 3F F2 49 1E 21 3E EC D9 FC C2 2A 29 A8 13 C4 83
0070 | 61 E2 68 CE 88 7B E4 D9 71 81 12 B9 F2 E9 40 39
0080 | 6E 24 4D 55 9A 47 71 13 14 8B 81 A4 26 D4 48 AF
0090 | 0C 83 7A 56 F4 40 7F 37 57 3F 69 25 B5 3D 30 F2
00A0 | BE 53 C6 59 F0 05 74 B1 5C E0 76 36 B9 9E 2F 39
00B0 | 9F B6 52 6A 87 37 50 D6 E3 B7 10 EB F0 F5 EA F5
00C0 | 37 E9 40 21 EB E2 04 A0 F7 D3 CD F6 B3 3C 0D C5
00D0 | 62 5D 61 81 94 5B 42 9A B4 DD 45 F7 6D 98 30 38
00E0 | 2D 45 97 C0 4A 18 77 07 66 32 52 DC F9 08 5A 28
00F0 | 73 9E C3 67 79 35 AD 98 A3 07 3E A3 C6 60 CE FF
0100 | 86 79 B8 09 10 64 71 0C 8D 7D AF 74 3B 3D BD FF
0110 | 76 F4 A8 CE E2 AE 11 7C FF 8F 55 CA D2 2C E9 AD
0120 | 53 71 05 B0 5A CA 45 49 36 CD 42 F9 40 05 6C AA
0130 | 21 37 E0 21 3F A5 4C 5C B6 E4 17 1F 43 8D 0C CF
0140 | 00 F8 3E 43 F4 01 BC 9A 14 E2 CE 33 9E E9 40 4F
0150 | BA 31 B6 D9 AA A9 48 65 25 B3 DE ED 66 FA 39 D1
0160 | EE 0B 20 9C 75 5A E6 84 5C 70 F0 E3 62 DE BA CC
0170 | 28 3E F3 30 50 AA D3 EA 9C 07 3B 68 7E 99 7B 56
0180 | 51 D5 78 51 43 51 67 5C B4 BE 5B DC 00 42 72 F0
0190 | A9 3C 79 C0 71 4C 1D DE 08 96 F4 C7 3E A1 C0 6E
01A0 | 3E B3 60 56 87 68 B5 71 5A E0 CB B0 01 14 E3 15
01B0 | 22 98 37 C9 7B 4E 4C 05 E5 18 8F D1 60 D6 68 60
01C0 | 8B F8 E8 0F B2 E4 28 5B ED 78 3C 2C C7 B9 B0 6F
01D0 | 97 FF 5F CA F8 35 C1 9E A7 DE 22 70 B8 50 7A E8
01E0 | B6 7C 08 82 F8 D7 F2 25 AE D8 FB 26 BD 8A 2F 84
01F0 | 87 CC 30 94 48 44 A2 33 A8 62 BF AD 75 69 D7 06
0200 | 2E 10 6A 2C 16 E4 6D D1 AE 00 A4 AD B9 F9 5D 08
0210 | 05 9D 4A 36 FF 72 E0 0B 9F 14 35 66 67 02 34 19
0220 | CC 94 EF 62 FE F6 7A 62 DB 63 28 70 A2 F7 DB DB
0230 | 94 DA 7E DB 7B 50 49 73 09 B6 4F 8C 45 C8 29 BE
0240 | D3 89 DC 15 75 1C 5B 74 F5 74 4A F4 03 7E 2C 86
0250 | 45 74 92 7A C2 E8 26 C2 20 10 5F A5 4B B5 3B 8E
0260 | 09 8D 27 00 65 7F 87 E4 AE AD 2D 28 E1 02 7E 2C
0270 | 55 BA 96 D5 8C 99 08 E4 7E F8 C6 CF 88 07 AF B9
0280 | 48 A4 A9 3E EC 83 D6 2B D5 A6 4C E5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130DF169D5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002007B41FC63C45322E6F79E95DD</code> <code>F15D5A518D10C59E4AE39CEE9819D8A6</code> <code>FCE6126B3C850D213FF2491E213EECD9</code> <code>FCC22A29A813C48361E268CE887BE4D9</code> <code>718112B9F2E940396E244D559A477113</code> <code>148B81A426D448AF0C837A56F4407F37</code> <code>573F6925B53D30F2BE53C659F00574B1</code> <code>5CE07636B99E2F399FB6526A873750D6</code> <code>E3B710EBF0F5EAF537E94021EBE204A0</code> <code>F7D3CDF6B33C0DC5625D6181945B429A</code> <code>B4DD45F76D9830382D4597C04A187707</code> <code>663252DCF9085A28739EC3677935AD98</code> <code>A3073EA3C660CEFF8679B8091064710C</code> <code>8D7DAF743B3DBDFF76F4A8CEE2AE117C</code> <code>FF8F55CAD22CE9AD537105B05ACA4549</code> <code>36CD42F940056CAA2137E0213FA54C5C</code> <code>B6E4171F438D0CCF00F83E43F401BC9A</code> <code>14E2CE339EE9404FBA31B6D9AAA94865</code> <code>25B3DEED66FA39D1EE0B209C755AE684</code> <code>5C70F0E362DEBACC283EF33050AAD3EA</code> <code>9C073B687E997B5651D578514351675C</code> <code>B4BE5BDC004272F0A93C79C0714C1DDE</code> <code>0896F4C73EA1C06E3EB360568768B571</code> <code>5AE0CBB00114E315229837C97B4E4C05</code> <code>E5188FD160D668608BF8E80FB2E4285B</code> <code>ED783C2CC7B9B06F97FF5FCAF835C19E</code> <code>A7DE2270B8507AE8B67C0882F8D7F225</code> <code>AED8FB26BD8A2F8487CC30944844A233</code> <code>A862BFAD7569D7062E106A2C16E46DD1</code> <code>AE00A4ADB9F95D08059D4A36FF72E00B</code> <code>9F14356667023419CC94EF62FEF67A62</code> <code>DB632870A2F7DBDB94DA7EDB7B504973</code> <code>09B64F8C45C829BED389DC15751C5B74</code> <code>F5744AF4037E2C864574927AC2E826C2</code> <code>20105FA54BB53B8E098D2700657F87E4</code> <code>AEAD2D28E1027E2C55BA96D58C9908E4</code> <code>7EF8C6CF8807AFB948A4A93EEC83D62B</code><br> <code>D5A64CE5</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 7B41FC63C45322E6F79E95DDF15D5A518D10C59E4AE39CEE9819D8A6FCE6126B3C850D213FF2491E213EECD9FCC22A29A813C48361E268CE887BE4D9718112B9F2E940396E244D559A477113148B81A426D448AF0C837A56F4407F37573F6925B53D30F2BE53C659F00574B15CE07636B99E2F399FB6526A873750D6E3B710EBF0F5EAF537E94021EBE204A0F7D3CDF6B33C0DC5625D6181945B429AB4DD45F76D9830382D4597C04A187707663252DCF9085A28739EC3677935AD98A3073EA3C660CEFF8679B8091064710C8D7DAF743B3DBDFF76F4A8CEE2AE117CFF8F55CAD22CE9AD537105B05ACA454936CD42F940056CAA2137E0213FA54C5CB6E4171F438D0CCF00F83E43F401BC9A14E2CE339EE9404FBA31B6D9AAA9486525B3DEED66FA39D1EE0B209C755AE6845C70F0E362DEBACC283EF33050AAD3EA9C073B687E997B5651D578514351675CB4BE5BDC004272F0A93C79C0714C1DDE0896F4C73EA1C06E3EB360568768B5715AE0CBB00114E315229837C97B4E4C05E5188FD160D668608BF8E80FB2E4285BED783C2CC7B9B06F97FF5FCAF835C19EA7DE2270B8507AE8B67C0882F8D7F225AED8FB26BD8A2F8487CC30944844A233A862BFAD7569D7062E106A2C16E46DD1AE00A4ADB9F95D08059D4A36FF72E00B9F14356667023419CC94EF62FEF67A62DB632870A2F7DBDB94DA7EDB7B50497309B64F8C45C829BED389DC15751C5B74F5744AF4037E2C864574927AC2E826C220105FA54BB53B8E098D2700657F87E4AEAD2D28E1027E2C55BA96D58C9908E47EF8C6CF8807AFB948A4A93EEC83D62BD5A64CE5
tmp_aes_key = 34C318401DAA7296D030099E9F57F7F8B03B16925E13FB160FCDC365745A8D19
tmp_aes_iv = 1501B913132C168D87A718F7BF4CF8BE1316F8A7D29B327F2A677C8B4CE54E26</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 5988D46C5741CE243FDF9797FCC92D0812929AD6BA0D89B5507849F0BB9C457DBCE9A322DEEC98B74CA967F1E6C73D677B057DBF78DFF1D303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100740EB2D446DB0C8B918F656DFA9088CD79537C4805011180956C8E56046939A3343169511F5D96DEF10124A2C60AD1841B1A967702F0EF82CC9F03182E473F7E0FEE85441F9E9EEDA84FAF189F70ADDBF543E56FDFB8A42ED6662570B47EECB35E68BD88FAF0AFF1EC8A882B67CA7EE2C2DCE5D6E1AD3AEC2C6D6A7E48C05F93920675C8D155F73F0DC938BDA535B83B67284862991F8F383E797D15C3E69FBA83A25400994C44B28057E93745B4A6E333553D34C3D2268EDBD5F767D13F7E9830292213B7CD83AF7184476E7571CD4C48B1CF81C7114EE4604AA031941F72D6D428280FBC8C235D0E548C82110ADB6E605461809E94ACA098A42ED1F4E9E6079D5A99667510C2D577FE81E7
answer = BA0D89B5507849F0BB9C457DBCE9A322DEEC98B74CA967F1E6C73D677B057DBF78DFF1D303000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100740EB2D446DB0C8B918F656DFA9088CD79537C4805011180956C8E56046939A3343169511F5D96DEF10124A2C60AD1841B1A967702F0EF82CC9F03182E473F7E0FEE85441F9E9EEDA84FAF189F70ADDBF543E56FDFB8A42ED6662570B47EECB35E68BD88FAF0AFF1EC8A882B67CA7EE2C2DCE5D6E1AD3AEC2C6D6A7E48C05F93920675C8D155F73F0DC938BDA535B83B67284862991F8F383E797D15C3E69FBA83A25400994C44B28057E93745B4A6E333553D34C3D2268EDBD5F767D13F7E9830292213B7CD83AF7184476E7571CD4C48B1CF81C7114EE4604AA031941F72D6D428280FBC8C235D0E548C82110ADB6E605461809E94ACA098A42ED1F4E9E6079D5A99667510C2D577FE81E7</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 50 78 49 F0 BB 9C 45 7D BC E9 A3 22
0010 | DE EC 98 B7 4C A9 67 F1 E6 C7 3D 67 7B 05 7D BF
0020 | 78 DF F1 D3 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 74 0E B2 D4 46 DB 0C 8B 91 8F 65 6D FA 90 88 CD
0140 | 79 53 7C 48 05 01 11 80 95 6C 8E 56 04 69 39 A3
0150 | 34 31 69 51 1F 5D 96 DE F1 01 24 A2 C6 0A D1 84
0160 | 1B 1A 96 77 02 F0 EF 82 CC 9F 03 18 2E 47 3F 7E
0170 | 0F EE 85 44 1F 9E 9E ED A8 4F AF 18 9F 70 AD DB
0180 | F5 43 E5 6F DF B8 A4 2E D6 66 25 70 B4 7E EC B3
0190 | 5E 68 BD 88 FA F0 AF F1 EC 8A 88 2B 67 CA 7E E2
01A0 | C2 DC E5 D6 E1 AD 3A EC 2C 6D 6A 7E 48 C0 5F 93
01B0 | 92 06 75 C8 D1 55 F7 3F 0D C9 38 BD A5 35 B8 3B
01C0 | 67 28 48 62 99 1F 8F 38 3E 79 7D 15 C3 E6 9F BA
01D0 | 83 A2 54 00 99 4C 44 B2 80 57 E9 37 45 B4 A6 E3
01E0 | 33 55 3D 34 C3 D2 26 8E DB D5 F7 67 D1 3F 7E 98
01F0 | 30 29 22 13 B7 CD 83 AF 71 84 47 6E 75 71 CD 4C
0200 | 48 B1 CF 81 C7 11 4E E4 60 4A A0 31 94 1F 72 D6
0210 | D4 28 28 0F BC 8C 23 5D 0E 54 8C 82 11 0A DB 6E
0220 | 60 54 61 80 9E 94 AC A0 98 A4 2E D1 F4 E9 E6 07
0230 | 9D 5A 99 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100740EB2D446DB0C8B918F656D</code> <code>FA9088CD79537C4805011180956C8E56</code> <code>046939A3343169511F5D96DEF10124A2</code> <code>C60AD1841B1A967702F0EF82CC9F0318</code> <code>2E473F7E0FEE85441F9E9EEDA84FAF18</code> <code>9F70ADDBF543E56FDFB8A42ED6662570</code> <code>B47EECB35E68BD88FAF0AFF1EC8A882B</code> <code>67CA7EE2C2DCE5D6E1AD3AEC2C6D6A7E</code> <code>48C05F93920675C8D155F73F0DC938BD</code> <code>A535B83B67284862991F8F383E797D15</code> <code>C3E69FBA83A25400994C44B28057E937</code> <code>45B4A6E333553D34C3D2268EDBD5F767</code> <code>D13F7E9830292213B7CD83AF7184476E</code> <code>7571CD4C48B1CF81C7114EE4604AA031</code> <code>941F72D6D428280FBC8C235D0E548C82</code> <code>110ADB6E605461809E94ACA098A42ED1</code><br> <code>F4E9E607</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>9D5A9966</code> (1721326237 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 85A6515BC71C9F21D4D92EFACBF3187555F69890CFFB924A8EC9FE9EB43A6BAE52A5F0D44ADA55935222DEE1B69FFA07806EF6789A6200211E2BF147FDB4FED89F1C6DDADD9ED9388E9881445EFEE7739C7B5577BB058AB556179AAF9795B06995BB25AC8A82D14A7752B82D33F609878CDFB85677C449E5809EB2F494C9157E941AC4CE165DBCC64E89EBC24F8D4CDB28A7E0A901F0448682CC067E54C0273AC5643005C99FCCD1BC9F32777150C3E749373A7C7832DF3E5C767C8B147AF7C46AC99C2F1667443C7F4327E00A0C94925F1BB6626878DD8BBFA4DE613FD8A16D910DFA2F99A3A6A086F238CFB862B22843BFE8AB973602F66728CC554BB631A0</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = A218EDB5E0B4A672DA510DB70D51543BFB4336937F7F3A93E4A33DF7D9F83CAF1AA60FB951B4CD007D6A1AF83E29373EE6BE98A783624047847B22E59EBC320E9EBFDEF2348EE6EE2819231381AA1E2A3E6C513CFB26629AE5B6E36ED9865CC4F1D5210F2D84E1958DFD16CF08778C503BBA7D4429F092C2F56DAFDF6F49D5A3DEE7E0B1112E793E0BD24EB9CFFD50238000161F56765C24A4D3CB9ECD3A1D1094949020EC96043F42E1053B94796F2DD09C6A228D626433E5CC8771A04328D10B43A4BA6FB8EFE0C5736440A31E2ED56DB8FEF7237F444E04D4DDA8BD50392B9E7F42E57C01D9923AB57E10BE2BBB85F43597AC41D6D6C235DC1F92193EAD62</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 50 78 49 F0 BB 9C 45 7D BC E9 A3 22
0010 | DE EC 98 B7 4C A9 67 F1 E6 C7 3D 67 7B 05 7D BF
0020 | 78 DF F1 D3 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | A2 18 ED B5 E0 B4 A6 72 DA 51 0D B7 0D 51 54 3B
0040 | FB 43 36 93 7F 7F 3A 93 E4 A3 3D F7 D9 F8 3C AF
0050 | 1A A6 0F B9 51 B4 CD 00 7D 6A 1A F8 3E 29 37 3E
0060 | E6 BE 98 A7 83 62 40 47 84 7B 22 E5 9E BC 32 0E
0070 | 9E BF DE F2 34 8E E6 EE 28 19 23 13 81 AA 1E 2A
0080 | 3E 6C 51 3C FB 26 62 9A E5 B6 E3 6E D9 86 5C C4
0090 | F1 D5 21 0F 2D 84 E1 95 8D FD 16 CF 08 77 8C 50
00A0 | 3B BA 7D 44 29 F0 92 C2 F5 6D AF DF 6F 49 D5 A3
00B0 | DE E7 E0 B1 11 2E 79 3E 0B D2 4E B9 CF FD 50 23
00C0 | 80 00 16 1F 56 76 5C 24 A4 D3 CB 9E CD 3A 1D 10
00D0 | 94 94 90 20 EC 96 04 3F 42 E1 05 3B 94 79 6F 2D
00E0 | D0 9C 6A 22 8D 62 64 33 E5 CC 87 71 A0 43 28 D1
00F0 | 0B 43 A4 BA 6F B8 EF E0 C5 73 64 40 A3 1E 2E D5
0100 | 6D B8 FE F7 23 7F 44 4E 04 D4 DD A8 BD 50 39 2B
0110 | 9E 7F 42 E5 7C 01 D9 92 3A B5 7E 10 BE 2B BB 85
0120 | F4 35 97 AC 41 D6 D6 C2 35 DC 1F 92 19 3E AD 62</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE000100A218EDB5E0B4A672DA510DB7</code> <code>0D51543BFB4336937F7F3A93E4A33DF7</code> <code>D9F83CAF1AA60FB951B4CD007D6A1AF8</code> <code>3E29373EE6BE98A783624047847B22E5</code> <code>9EBC320E9EBFDEF2348EE6EE28192313</code> <code>81AA1E2A3E6C513CFB26629AE5B6E36E</code> <code>D9865CC4F1D5210F2D84E1958DFD16CF</code> <code>08778C503BBA7D4429F092C2F56DAFDF</code> <code>6F49D5A3DEE7E0B1112E793E0BD24EB9</code> <code>CFFD50238000161F56765C24A4D3CB9E</code> <code>CD3A1D1094949020EC96043F42E1053B</code> <code>94796F2DD09C6A228D626433E5CC8771</code> <code>A04328D10B43A4BA6FB8EFE0C5736440</code> <code>A31E2ED56DB8FEF7237F444E04D4DDA8</code> <code>BD50392B9E7F42E57C01D9923AB57E10</code> <code>BE2BBB85F43597AC41D6D6C235DC1F92</code><br> <code>193EAD62</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366507849F0BB9C457DBCE9A322DEEC98B74CA967F1E6C73D677B057DBF78DFF1D30000000000000000FE000100A218EDB5E0B4A672DA510DB70D51543BFB4336937F7F3A93E4A33DF7D9F83CAF1AA60FB951B4CD007D6A1AF83E29373EE6BE98A783624047847B22E59EBC320E9EBFDEF2348EE6EE2819231381AA1E2A3E6C513CFB26629AE5B6E36ED9865CC4F1D5210F2D84E1958DFD16CF08778C503BBA7D4429F092C2F56DAFDF6F49D5A3DEE7E0B1112E793E0BD24EB9CFFD50238000161F56765C24A4D3CB9ECD3A1D1094949020EC96043F42E1053B94796F2DD09C6A228D626433E5CC8771A04328D10B43A4BA6FB8EFE0C5736440A31E2ED56DB8FEF7237F444E04D4DDA8BD50392B9E7F42E57C01D9923AB57E10BE2BBB85F43597AC41D6D6C235DC1F92193EAD62
padding = 1F29A22D47380EE8EC009236
tmp_aes_key = 34C318401DAA7296D030099E9F57F7F8B03B16925E13FB160FCDC365745A8D19
tmp_aes_iv = 1501B913132C168D87A718F7BF4CF8BE1316F8A7D29B327F2A677C8B4CE54E26</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 1A2DA766289FE5F8AAA5FC92F3363EB80499B19D5A3F6908C780B6E066484BCC1E822A4C43E0E73A2EE134E10BE74F3217B5C9AA2A52BCA1D4C4629CE88298BCC274575D3C1F4A79D020509BEE26AC3C26CDB95AA96F863C4DF65C5C50C20676CE1AB6294220AEB2B267F824B3CE7B1092BCB21047B2C4DF6ACB47CAE363362E25707FF5D1755ACEE08FE4035414BA8B82948AB7FB34CDB9AEABD7C229A004B9B3ACB624C5F1224B7B357127E9C982554B3408558A30D207BA91A7C80230EF9BE4272935B264F9BC72877CA3A06EDD46807AE0D72B4D129AF13352EC925D7ACAF9126AA12C8AD65A1BAE16AE6D79A899E8E5D6E3FB9A09A8E3AEEE2D180531EDB7082CC3451333F00012611C1330418E1B41EC83822E766886F3CE667E51B697BD15FFF64338F33B9738FB58C0CE553E4BE0FA87505B380D3FBBC1337EECAD6F3C89065E86F659DE8560A6F1436A765C</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 D4 99 0A 00 9D 5A 99 66
0010 | 78 01 00 00 1F 5F 04 F5 50 78 49 F0 BB 9C 45 7D
0020 | BC E9 A3 22 DE EC 98 B7 4C A9 67 F1 E6 C7 3D 67
0030 | 7B 05 7D BF 78 DF F1 D3 FE 50 01 00 1A 2D A7 66
0040 | 28 9F E5 F8 AA A5 FC 92 F3 36 3E B8 04 99 B1 9D
0050 | 5A 3F 69 08 C7 80 B6 E0 66 48 4B CC 1E 82 2A 4C
0060 | 43 E0 E7 3A 2E E1 34 E1 0B E7 4F 32 17 B5 C9 AA
0070 | 2A 52 BC A1 D4 C4 62 9C E8 82 98 BC C2 74 57 5D
0080 | 3C 1F 4A 79 D0 20 50 9B EE 26 AC 3C 26 CD B9 5A
0090 | A9 6F 86 3C 4D F6 5C 5C 50 C2 06 76 CE 1A B6 29
00A0 | 42 20 AE B2 B2 67 F8 24 B3 CE 7B 10 92 BC B2 10
00B0 | 47 B2 C4 DF 6A CB 47 CA E3 63 36 2E 25 70 7F F5
00C0 | D1 75 5A CE E0 8F E4 03 54 14 BA 8B 82 94 8A B7
00D0 | FB 34 CD B9 AE AB D7 C2 29 A0 04 B9 B3 AC B6 24
00E0 | C5 F1 22 4B 7B 35 71 27 E9 C9 82 55 4B 34 08 55
00F0 | 8A 30 D2 07 BA 91 A7 C8 02 30 EF 9B E4 27 29 35
0100 | B2 64 F9 BC 72 87 7C A3 A0 6E DD 46 80 7A E0 D7
0110 | 2B 4D 12 9A F1 33 52 EC 92 5D 7A CA F9 12 6A A1
0120 | 2C 8A D6 5A 1B AE 16 AE 6D 79 A8 99 E8 E5 D6 E3
0130 | FB 9A 09 A8 E3 AE EE 2D 18 05 31 ED B7 08 2C C3
0140 | 45 13 33 F0 00 12 61 1C 13 30 41 8E 1B 41 EC 83
0150 | 82 2E 76 68 86 F3 CE 66 7E 51 B6 97 BD 15 FF F6
0160 | 43 38 F3 3B 97 38 FB 58 C0 CE 55 3E 4B E0 FA 87
0170 | 50 5B 38 0D 3F BB C1 33 7E EC AD 6F 3C 89 06 5E
0180 | 86 F6 59 DE 85 60 A6 F1 43 6A 76 5C</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>D4990A009D5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE5001001A2DA766289FE5F8AAA5FC92</code> <code>F3363EB80499B19D5A3F6908C780B6E0</code> <code>66484BCC1E822A4C43E0E73A2EE134E1</code> <code>0BE74F3217B5C9AA2A52BCA1D4C4629C</code> <code>E88298BCC274575D3C1F4A79D020509B</code> <code>EE26AC3C26CDB95AA96F863C4DF65C5C</code> <code>50C20676CE1AB6294220AEB2B267F824</code> <code>B3CE7B1092BCB21047B2C4DF6ACB47CA</code> <code>E363362E25707FF5D1755ACEE08FE403</code> <code>5414BA8B82948AB7FB34CDB9AEABD7C2</code> <code>29A004B9B3ACB624C5F1224B7B357127</code> <code>E9C982554B3408558A30D207BA91A7C8</code> <code>0230EF9BE4272935B264F9BC72877CA3</code> <code>A06EDD46807AE0D72B4D129AF13352EC</code> <code>925D7ACAF9126AA12C8AD65A1BAE16AE</code> <code>6D79A899E8E5D6E3FB9A09A8E3AEEE2D</code> <code>180531EDB7082CC3451333F00012611C</code> <code>1330418E1B41EC83822E766886F3CE66</code> <code>7E51B697BD15FFF64338F33B9738FB58</code> <code>C0CE553E4BE0FA87505B380D3FBBC133</code> <code>7EECAD6F3C89065E86F659DE8560A6F1</code><br> <code>436A765C</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 1FDBFD18F386874AE516F8452FF188E0578C2CCDF0133E7975ABD36590BEFD075CB8BA5D0BA3EEEC16A7A5AE2D15D6132C3C02BD44A40CCF37987CC3C0354F732928308CD72DE80F0ED083ED20E52407B9F5E9FC12A264596F7B2F2B7129CED1430693D378D8E565ADA42B76E69ECEF6AF07573AE1F752871F8D27FF4AEFB45040C3CDF4BFCCF1EAF79265947B8EE3C51881E009BCA3BC36F5F998E0F6E47D5023157A1AA60E007273AF61E985CE3AA3BD069B4EE7128FA2858245A0053035F4B61AC3B8E1F3D8181013D741A6968017EF713300B6AD37591D975F26439593467782D79AC82ACA565549BF721FCB023FACF3EDB651E3BC53434C069EF865CD29</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 88 89 9A 9D 5A 99 66
0010 | 40 00 00 00 34 F7 CB 3B 50 78 49 F0 BB 9C 45 7D
0020 | BC E9 A3 22 DE EC 98 B7 4C A9 67 F1 E6 C7 3D 67
0030 | 7B 05 7D BF 78 DF F1 D3 A2 A7 ED 4E 1F 95 13 1C
0040 | 14 B8 EF 83 85 D6 3D EE</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0188899A9D5A9966</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40000000</code> (64 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>507849F0BB9C457DBCE9A322DEEC98B7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>4CA967F1E6C73D677B057DBF78DFF1D3</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>A2A7ED4E1F95131C14B8EF8385D63DEE</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

