<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?247" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 54 00 00 0A 68 C8 68
0010 | 14 00 00 00 F1 8E 7E BE 52 6A 55 BB DA 60 5B 5C
0020 | D1 47 1E 6B 54 F2 70 F7</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C05400000A68C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 5C 53 0A 68 C8 68
0010 | 50 00 00 00 63 24 16 05 52 6A 55 BB DA 60 5B 5C
0020 | D1 47 1E 6B 54 F2 70 F7 6D 2F B3 A4 CA 48 18 F7
0030 | DB 47 D8 67 32 61 A7 FC 08 19 76 47 55 F5 FB 10
0040 | B5 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01585C530A68C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0819764755F5FB10B5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1834732332724719797</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1834732332724719797</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1834732332724719797 = 1119563717 * 1638792241</code></p>
<pre><code>p = 1119563717
q = 1638792241</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 19 76 47 55 F5 FB 10 B5 00 00 00
0010 | 04 42 BB 2F C5 00 00 00 04 61 AD FC 31 00 00 00
0020 | 52 6A 55 BB DA 60 5B 5C D1 47 1E 6B 54 F2 70 F7
0030 | 6D 2F B3 A4 CA 48 18 F7 DB 47 D8 67 32 61 A7 FC
0040 | 8F 46 AC 8C 1A 20 56 14 21 D9 1E 1B 22 23 43 9E
0050 | 61 9A 5E 9C 1F 88 B1 3A D4 98 44 D4 64 F7 D3 FD
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0819764755F5FB10B5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1834732332724719797</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0442BB2FC5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1119563717</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>0461ADFC31000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1638792241</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>8F46AC8C1A20561421D91E1B2223439E</code> <code>619A5E9C1F88B13AD49844D464F7D3FD</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90819764755F5FB10B50000000442BB2FC50000000461ADFC31000000526A55BBDA605B5CD1471E6B54F270F76D2FB3A4CA4818F7DB47D8673261A7FC8F46AC8C1A20561421D91E1B2223439E619A5E9C1F88B13AD49844D464F7D3FD02000000
random_padding_bytes = 765805C299FAAF87A0B1D3727D10D538676D12BF3EA606455157ED5321D658D41AD09CAF68E402241E79B1F97B48393DEF4B202773E24F362EC2BA7094F8924AF30D3E7E176FEB9A9998A193452CF3138AAC175F88EEFED9953A5A74</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = 74E5E1B41E54FFBD01C5D01970ADD19F19DF3531DEF333BDE683135BD4EF020EAE2FCD0485A2EA3A18C85C970F602B6BB9AB56E325268E2F660E45E0D5EBA84D337750A4BF26ACD90FFDCA5B837009B4C69843AD8A17EF36C32E2C556FD5E0604228B0C93B416DB73067AFEC1A448D206570BF8AD061AACB50E8D1D76798D81BEBEE494332812696DE24049149E3043854A750F92DD0E0524B92C8BE390222E453776ABE00E9DBA0AD097ADF93AD85A4CAA1B42145A096DFF650E915BCCEE93608D926D0356AE0496964322C20A008B6FA9B8C3876481E38EF18CC6D9D4FED13FA15FA75F003D1B1AF353AB94A92567A75F0986A728714C56DB229D810E4DD1B</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 50 6F 0B 00 0A 68 C8 68
0010 | 40 01 00 00 BE E4 12 D7 52 6A 55 BB DA 60 5B 5C
0020 | D1 47 1E 6B 54 F2 70 F7 6D 2F B3 A4 CA 48 18 F7
0030 | DB 47 D8 67 32 61 A7 FC 04 42 BB 2F C5 00 00 00
0040 | 04 61 AD FC 31 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 74 E5 E1 B4 1E 54 FF BD 01 C5 D0 19
0060 | 70 AD D1 9F 19 DF 35 31 DE F3 33 BD E6 83 13 5B
0070 | D4 EF 02 0E AE 2F CD 04 85 A2 EA 3A 18 C8 5C 97
0080 | 0F 60 2B 6B B9 AB 56 E3 25 26 8E 2F 66 0E 45 E0
0090 | D5 EB A8 4D 33 77 50 A4 BF 26 AC D9 0F FD CA 5B
00A0 | 83 70 09 B4 C6 98 43 AD 8A 17 EF 36 C3 2E 2C 55
00B0 | 6F D5 E0 60 42 28 B0 C9 3B 41 6D B7 30 67 AF EC
00C0 | 1A 44 8D 20 65 70 BF 8A D0 61 AA CB 50 E8 D1 D7
00D0 | 67 98 D8 1B EB EE 49 43 32 81 26 96 DE 24 04 91
00E0 | 49 E3 04 38 54 A7 50 F9 2D D0 E0 52 4B 92 C8 BE
00F0 | 39 02 22 E4 53 77 6A BE 00 E9 DB A0 AD 09 7A DF
0100 | 93 AD 85 A4 CA A1 B4 21 45 A0 96 DF F6 50 E9 15
0110 | BC CE E9 36 08 D9 26 D0 35 6A E0 49 69 64 32 2C
0120 | 20 A0 08 B6 FA 9B 8C 38 76 48 1E 38 EF 18 CC 6D
0130 | 9D 4F ED 13 FA 15 FA 75 F0 03 D1 B1 AF 35 3A B9
0140 | 4A 92 56 7A 75 F0 98 6A 72 87 14 C5 6D B2 29 D8
0150 | 10 E4 DD 1B</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>506F0B000A68C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0442BB2FC5000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1119563717</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>0461ADFC31000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1638792241</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE00010074E5E1B41E54FFBD01C5D019</code> <code>70ADD19F19DF3531DEF333BDE683135B</code> <code>D4EF020EAE2FCD0485A2EA3A18C85C97</code> <code>0F602B6BB9AB56E325268E2F660E45E0</code> <code>D5EBA84D337750A4BF26ACD90FFDCA5B</code> <code>837009B4C69843AD8A17EF36C32E2C55</code> <code>6FD5E0604228B0C93B416DB73067AFEC</code> <code>1A448D206570BF8AD061AACB50E8D1D7</code> <code>6798D81BEBEE494332812696DE240491</code> <code>49E3043854A750F92DD0E0524B92C8BE</code> <code>390222E453776ABE00E9DBA0AD097ADF</code> <code>93AD85A4CAA1B42145A096DFF650E915</code> <code>BCCEE93608D926D0356AE0496964322C</code> <code>20A008B6FA9B8C3876481E38EF18CC6D</code> <code>9D4FED13FA15FA75F003D1B1AF353AB9</code> <code>4A92567A75F0986A728714C56DB229D8</code><br> <code>10E4DD1B</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 B4 D0 7F 0A 68 C8 68
0010 | 78 02 00 00 5C 07 E8 D0 52 6A 55 BB DA 60 5B 5C
0020 | D1 47 1E 6B 54 F2 70 F7 6D 2F B3 A4 CA 48 18 F7
0030 | DB 47 D8 67 32 61 A7 FC FE 50 02 00 5B 8D B0 82
0040 | 9D 9E 5D 0F 8E C6 DD 92 92 FE 29 04 D2 75 2C DF
0050 | 19 68 E3 4F DE 42 64 33 DC C1 76 7D 60 E9 8C 08
0060 | 60 F5 C7 4F DE 01 57 BC DC B1 AF 33 D8 7A B6 B2
0070 | 98 70 DF FE 53 6C ED 0D DD E0 09 91 12 7F 57 15
0080 | 25 13 D2 4B 5F B2 FE 8A 14 32 85 D1 EA 4C 90 7E
0090 | 86 60 1B 68 C2 18 9B 12 F8 F5 5D 6C 93 19 35 6F
00A0 | 24 B9 C0 58 FF E3 E9 C3 84 10 E3 AB A6 6E 90 27
00B0 | DB F3 EB 8C 96 FA CF 65 C9 4D B7 E9 77 17 8C 7B
00C0 | 88 C0 82 05 6D CF DE 3A 26 51 4B 8B 3C A2 18 D5
00D0 | B3 0D AB E3 C7 92 BE A0 E8 81 09 BB 19 5B 38 80
00E0 | 3F 8B F1 E8 AB E9 67 87 EA 41 2D 36 98 C4 86 5E
00F0 | 03 9F BE 89 1E D0 83 33 51 8C 56 88 0D 0C 1A 22
0100 | 82 E9 33 1A 16 75 FA 57 03 E0 29 0D F5 4D 35 B3
0110 | 48 E3 55 86 32 B5 45 19 E8 28 49 93 5E EB A3 6A
0120 | B9 DE AA 8B 4A A9 49 9B C3 34 86 54 8A 9D 4E 34
0130 | 9B 06 22 61 C0 88 E9 75 AF AB C4 51 3C DC 0F 77
0140 | 1B 0B E6 A8 BE 91 B4 62 9D D7 A6 29 40 F9 90 E6
0150 | A0 79 2A 1F 6F 36 CE B5 AD 75 7E 3A 37 78 0D E5
0160 | 38 49 B5 6C 34 BE 24 0B 80 7F B6 2D C5 E5 BA F3
0170 | E9 E2 98 E2 1A 5D 2F CE B2 BE 29 24 85 FB C3 84
0180 | 9F 33 50 40 2E 79 67 5F 35 91 61 F0 CE A8 3A D7
0190 | 1F B1 EA 16 FA 31 E2 4F F2 ED 9C 19 7C BA 7E 81
01A0 | 08 9F 22 DF 18 50 68 B1 3E D8 E4 89 83 85 FC F3
01B0 | 6F CF EB 9B 22 A1 65 5B CD 6A C7 E5 80 A3 E0 2A
01C0 | 26 B1 7D 34 9C 84 EC 9F 68 18 98 ED 64 4D 9D 3C
01D0 | CD 08 42 36 44 7F 5B 05 A2 D9 0C 5A 5A 2B AE 66
01E0 | 0D 3A 63 09 A8 66 39 68 85 EB D3 F4 8D 9A 53 20
01F0 | DB 41 CA B4 B5 F3 7D 39 88 76 9D 4C 9F 91 53 7F
0200 | 3A 87 07 AC 9F 19 AB FC 41 90 A9 17 A0 88 00 B6
0210 | 7D 7B 26 9E 9C 44 11 74 9C 6D B1 01 A5 04 7F C6
0220 | 8C A3 D2 8D 9C 2A B0 07 B8 73 0D 51 EE 7E 63 F1
0230 | 70 06 4E 53 0C 7B C0 C6 48 CE 54 57 B6 C6 68 23
0240 | 36 34 7F DF 98 D8 51 FB 80 6D 9D 09 58 19 2F ED
0250 | D5 98 7B A9 7F BD 9D 59 6D 21 6E 79 E9 62 7A 8A
0260 | 38 7E E6 45 CA 2D 3C 98 38 8A 2D C4 D9 4D B3 BB
0270 | B7 E5 B4 E7 0F 4F D6 6C 10 C9 8D FC 20 94 6E 01
0280 | 69 FD 71 E8 F8 C1 BE 60 78 07 15 2D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01B4D07F0A68C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE5002005B8DB0829D9E5D0F8EC6DD92</code> <code>92FE2904D2752CDF1968E34FDE426433</code> <code>DCC1767D60E98C0860F5C74FDE0157BC</code> <code>DCB1AF33D87AB6B29870DFFE536CED0D</code> <code>DDE00991127F57152513D24B5FB2FE8A</code> <code>143285D1EA4C907E86601B68C2189B12</code> <code>F8F55D6C9319356F24B9C058FFE3E9C3</code> <code>8410E3ABA66E9027DBF3EB8C96FACF65</code> <code>C94DB7E977178C7B88C082056DCFDE3A</code> <code>26514B8B3CA218D5B30DABE3C792BEA0</code> <code>E88109BB195B38803F8BF1E8ABE96787</code> <code>EA412D3698C4865E039FBE891ED08333</code> <code>518C56880D0C1A2282E9331A1675FA57</code> <code>03E0290DF54D35B348E3558632B54519</code> <code>E82849935EEBA36AB9DEAA8B4AA9499B</code> <code>C33486548A9D4E349B062261C088E975</code> <code>AFABC4513CDC0F771B0BE6A8BE91B462</code> <code>9DD7A62940F990E6A0792A1F6F36CEB5</code> <code>AD757E3A37780DE53849B56C34BE240B</code> <code>807FB62DC5E5BAF3E9E298E21A5D2FCE</code> <code>B2BE292485FBC3849F3350402E79675F</code> <code>359161F0CEA83AD71FB1EA16FA31E24F</code> <code>F2ED9C197CBA7E81089F22DF185068B1</code> <code>3ED8E4898385FCF36FCFEB9B22A1655B</code> <code>CD6AC7E580A3E02A26B17D349C84EC9F</code> <code>681898ED644D9D3CCD084236447F5B05</code> <code>A2D90C5A5A2BAE660D3A6309A8663968</code> <code>85EBD3F48D9A5320DB41CAB4B5F37D39</code> <code>88769D4C9F91537F3A8707AC9F19ABFC</code> <code>4190A917A08800B67D7B269E9C441174</code> <code>9C6DB101A5047FC68CA3D28D9C2AB007</code> <code>B8730D51EE7E63F170064E530C7BC0C6</code> <code>48CE5457B6C6682336347FDF98D851FB</code> <code>806D9D0958192FEDD5987BA97FBD9D59</code> <code>6D216E79E9627A8A387EE645CA2D3C98</code> <code>388A2DC4D94DB3BBB7E5B4E70F4FD66C</code> <code>10C98DFC20946E0169FD71E8F8C1BE60</code><br> <code>7807152D</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 5B8DB0829D9E5D0F8EC6DD9292FE2904D2752CDF1968E34FDE426433DCC1767D60E98C0860F5C74FDE0157BCDCB1AF33D87AB6B29870DFFE536CED0DDDE00991127F57152513D24B5FB2FE8A143285D1EA4C907E86601B68C2189B12F8F55D6C9319356F24B9C058FFE3E9C38410E3ABA66E9027DBF3EB8C96FACF65C94DB7E977178C7B88C082056DCFDE3A26514B8B3CA218D5B30DABE3C792BEA0E88109BB195B38803F8BF1E8ABE96787EA412D3698C4865E039FBE891ED08333518C56880D0C1A2282E9331A1675FA5703E0290DF54D35B348E3558632B54519E82849935EEBA36AB9DEAA8B4AA9499BC33486548A9D4E349B062261C088E975AFABC4513CDC0F771B0BE6A8BE91B4629DD7A62940F990E6A0792A1F6F36CEB5AD757E3A37780DE53849B56C34BE240B807FB62DC5E5BAF3E9E298E21A5D2FCEB2BE292485FBC3849F3350402E79675F359161F0CEA83AD71FB1EA16FA31E24FF2ED9C197CBA7E81089F22DF185068B13ED8E4898385FCF36FCFEB9B22A1655BCD6AC7E580A3E02A26B17D349C84EC9F681898ED644D9D3CCD084236447F5B05A2D90C5A5A2BAE660D3A6309A866396885EBD3F48D9A5320DB41CAB4B5F37D3988769D4C9F91537F3A8707AC9F19ABFC4190A917A08800B67D7B269E9C4411749C6DB101A5047FC68CA3D28D9C2AB007B8730D51EE7E63F170064E530C7BC0C648CE5457B6C6682336347FDF98D851FB806D9D0958192FEDD5987BA97FBD9D596D216E79E9627A8A387EE645CA2D3C98388A2DC4D94DB3BBB7E5B4E70F4FD66C10C98DFC20946E0169FD71E8F8C1BE607807152D
tmp_aes_key = 322F44D342EA85EF2C5E4968055BE17F764F6881A1876681CD17AAD686F1708A
tmp_aes_iv = 475F370E08D84DD0C14483616A94849F16CA0A929BF874D43487BB2B8F46AC8C</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = F936C6894D8DABAE5DC596FC1EF8537AFBDA52F9BA0D89B5526A55BBDA605B5CD1471E6B54F270F76D2FB3A4CA4818F7DB47D8673261A7FC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001008EB642BCAA343D9D9996E5DCDC5115E63A8B64436564FF8744FFF72DDEE30CBCDE3C3EF4C7F3908989D18354095759DAA01A1142C35B9E166B4B2E8A0590D0FE0184EB3D71BFDAF5D0322218D5E323CEE2F1B0A96377DD5D81BA94CAECFBBA1C3C42814E2A896A50146213F9039970241F69DF34FE7D06A825872710A58E4C2C349DAA70A2085150D7DC6C0C7FB29E6CE8D7049C6AC9B3976A08962B1FC979381171294096B83B64FF5C1088E810BA41D522C4A12A3C0649DE850A4D727A70C7F6ECFD63C7187113FAA784B074F8E397F2FBCF4331236B01AD9FEFDC80BA763FC7A1C029BC6B974DEAB6DD1B08D738C52B78C87A3AD14A7CC81A029C973F46F40A68C8681882725AFCDB3B07
answer = BA0D89B5526A55BBDA605B5CD1471E6B54F270F76D2FB3A4CA4818F7DB47D8673261A7FC03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001008EB642BCAA343D9D9996E5DCDC5115E63A8B64436564FF8744FFF72DDEE30CBCDE3C3EF4C7F3908989D18354095759DAA01A1142C35B9E166B4B2E8A0590D0FE0184EB3D71BFDAF5D0322218D5E323CEE2F1B0A96377DD5D81BA94CAECFBBA1C3C42814E2A896A50146213F9039970241F69DF34FE7D06A825872710A58E4C2C349DAA70A2085150D7DC6C0C7FB29E6CE8D7049C6AC9B3976A08962B1FC979381171294096B83B64FF5C1088E810BA41D522C4A12A3C0649DE850A4D727A70C7F6ECFD63C7187113FAA784B074F8E397F2FBCF4331236B01AD9FEFDC80BA763FC7A1C029BC6B974DEAB6DD1B08D738C52B78C87A3AD14A7CC81A029C973F46F40A68C8681882725AFCDB3B07</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 52 6A 55 BB DA 60 5B 5C D1 47 1E 6B
0010 | 54 F2 70 F7 6D 2F B3 A4 CA 48 18 F7 DB 47 D8 67
0020 | 32 61 A7 FC 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 8E B6 42 BC AA 34 3D 9D 99 96 E5 DC DC 51 15 E6
0140 | 3A 8B 64 43 65 64 FF 87 44 FF F7 2D DE E3 0C BC
0150 | DE 3C 3E F4 C7 F3 90 89 89 D1 83 54 09 57 59 DA
0160 | A0 1A 11 42 C3 5B 9E 16 6B 4B 2E 8A 05 90 D0 FE
0170 | 01 84 EB 3D 71 BF DA F5 D0 32 22 18 D5 E3 23 CE
0180 | E2 F1 B0 A9 63 77 DD 5D 81 BA 94 CA EC FB BA 1C
0190 | 3C 42 81 4E 2A 89 6A 50 14 62 13 F9 03 99 70 24
01A0 | 1F 69 DF 34 FE 7D 06 A8 25 87 27 10 A5 8E 4C 2C
01B0 | 34 9D AA 70 A2 08 51 50 D7 DC 6C 0C 7F B2 9E 6C
01C0 | E8 D7 04 9C 6A C9 B3 97 6A 08 96 2B 1F C9 79 38
01D0 | 11 71 29 40 96 B8 3B 64 FF 5C 10 88 E8 10 BA 41
01E0 | D5 22 C4 A1 2A 3C 06 49 DE 85 0A 4D 72 7A 70 C7
01F0 | F6 EC FD 63 C7 18 71 13 FA A7 84 B0 74 F8 E3 97
0200 | F2 FB CF 43 31 23 6B 01 AD 9F EF DC 80 BA 76 3F
0210 | C7 A1 C0 29 BC 6B 97 4D EA B6 DD 1B 08 D7 38 C5
0220 | 2B 78 C8 7A 3A D1 4A 7C C8 1A 02 9C 97 3F 46 F4
0230 | 0A 68 C8 68</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001008EB642BCAA343D9D9996E5DC</code> <code>DC5115E63A8B64436564FF8744FFF72D</code> <code>DEE30CBCDE3C3EF4C7F3908989D18354</code> <code>095759DAA01A1142C35B9E166B4B2E8A</code> <code>0590D0FE0184EB3D71BFDAF5D0322218</code> <code>D5E323CEE2F1B0A96377DD5D81BA94CA</code> <code>ECFBBA1C3C42814E2A896A50146213F9</code> <code>039970241F69DF34FE7D06A825872710</code> <code>A58E4C2C349DAA70A2085150D7DC6C0C</code> <code>7FB29E6CE8D7049C6AC9B3976A08962B</code> <code>1FC979381171294096B83B64FF5C1088</code> <code>E810BA41D522C4A12A3C0649DE850A4D</code> <code>727A70C7F6ECFD63C7187113FAA784B0</code> <code>74F8E397F2FBCF4331236B01AD9FEFDC</code> <code>80BA763FC7A1C029BC6B974DEAB6DD1B</code> <code>08D738C52B78C87A3AD14A7CC81A029C</code><br> <code>973F46F4</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>0A68C868</code> (1757964298 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = B3D9AEE7EB164BF9F73265F92E75CC96F1D32DCD0CDB845C9776761D8E3C505EE52D173BF7F458086D2A941FBB1EF0E73174CAC053D73962858DB02A292226AECCA31D30C65E590B06A6318C5F50E153C07D6DF46D60C4A9B8998AEED8C3A6664B810E89534D21F9C9C05AE249BD41FFB03D13C2964F4B334516B9B0BB6A3CC2E49152E847491164954488494A473CBB5848BB6FD52F645F739808D56243FC300B412452BEBA9178E1F198AAAB70D48DDD5E57A0B3590F91B180E5D4181369691A1DD773CD320A5811D079B871FEFBBF6E1F544AAB0D2DEDD883EF38DDCFE1EC007C08870421A4048A98672F11D33D3949B833D0BB6A4453F65CD6BDB95B99DD</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 4D0E7EFE3BB05A2D1C296D538CE8E1F6C8E122605A960047736C8A2A5E9662AECDC28DA5013394225A9BB8B90A130149FD66A9D3F9C9A966BA8389A7C0822E806A5A9C7A1802BF517C344801FD289DAEB7F4807792E70806404241EEDCC179C1E800F5DBAE3ADE390B5DF320B2D3DE2B78BBCF2028CB0C1B4E1A6827609B3E75622EAE4FA3EFE92C3960F8F9C3EC3FD719DF748DBF32497A5986AF8E7CE0EB7F79CC531867A0691C6BE169A65A1E31B34D9CA648E06519B0B156E6EB3889F6A33BB7D858128D1C374A985DDD6CD083E5362F458225D2583605434A26A2F778EF4CBAA01F5CA4147ECAD98C32C62A6B80F228D6BB4246AA5A5E214C243303F4A4</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 52 6A 55 BB DA 60 5B 5C D1 47 1E 6B
0010 | 54 F2 70 F7 6D 2F B3 A4 CA 48 18 F7 DB 47 D8 67
0020 | 32 61 A7 FC 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 4D 0E 7E FE 3B B0 5A 2D 1C 29 6D 53 8C E8 E1 F6
0040 | C8 E1 22 60 5A 96 00 47 73 6C 8A 2A 5E 96 62 AE
0050 | CD C2 8D A5 01 33 94 22 5A 9B B8 B9 0A 13 01 49
0060 | FD 66 A9 D3 F9 C9 A9 66 BA 83 89 A7 C0 82 2E 80
0070 | 6A 5A 9C 7A 18 02 BF 51 7C 34 48 01 FD 28 9D AE
0080 | B7 F4 80 77 92 E7 08 06 40 42 41 EE DC C1 79 C1
0090 | E8 00 F5 DB AE 3A DE 39 0B 5D F3 20 B2 D3 DE 2B
00A0 | 78 BB CF 20 28 CB 0C 1B 4E 1A 68 27 60 9B 3E 75
00B0 | 62 2E AE 4F A3 EF E9 2C 39 60 F8 F9 C3 EC 3F D7
00C0 | 19 DF 74 8D BF 32 49 7A 59 86 AF 8E 7C E0 EB 7F
00D0 | 79 CC 53 18 67 A0 69 1C 6B E1 69 A6 5A 1E 31 B3
00E0 | 4D 9C A6 48 E0 65 19 B0 B1 56 E6 EB 38 89 F6 A3
00F0 | 3B B7 D8 58 12 8D 1C 37 4A 98 5D DD 6C D0 83 E5
0100 | 36 2F 45 82 25 D2 58 36 05 43 4A 26 A2 F7 78 EF
0110 | 4C BA A0 1F 5C A4 14 7E CA D9 8C 32 C6 2A 6B 80
0120 | F2 28 D6 BB 42 46 AA 5A 5E 21 4C 24 33 03 F4 A4</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001004D0E7EFE3BB05A2D1C296D53</code> <code>8CE8E1F6C8E122605A960047736C8A2A</code> <code>5E9662AECDC28DA5013394225A9BB8B9</code> <code>0A130149FD66A9D3F9C9A966BA8389A7</code> <code>C0822E806A5A9C7A1802BF517C344801</code> <code>FD289DAEB7F4807792E70806404241EE</code> <code>DCC179C1E800F5DBAE3ADE390B5DF320</code> <code>B2D3DE2B78BBCF2028CB0C1B4E1A6827</code> <code>609B3E75622EAE4FA3EFE92C3960F8F9</code> <code>C3EC3FD719DF748DBF32497A5986AF8E</code> <code>7CE0EB7F79CC531867A0691C6BE169A6</code> <code>5A1E31B34D9CA648E06519B0B156E6EB</code> <code>3889F6A33BB7D858128D1C374A985DDD</code> <code>6CD083E5362F458225D2583605434A26</code> <code>A2F778EF4CBAA01F5CA4147ECAD98C32</code> <code>C62A6B80F228D6BB4246AA5A5E214C24</code><br> <code>3303F4A4</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366526A55BBDA605B5CD1471E6B54F270F76D2FB3A4CA4818F7DB47D8673261A7FC0000000000000000FE0001004D0E7EFE3BB05A2D1C296D538CE8E1F6C8E122605A960047736C8A2A5E9662AECDC28DA5013394225A9BB8B90A130149FD66A9D3F9C9A966BA8389A7C0822E806A5A9C7A1802BF517C344801FD289DAEB7F4807792E70806404241EEDCC179C1E800F5DBAE3ADE390B5DF320B2D3DE2B78BBCF2028CB0C1B4E1A6827609B3E75622EAE4FA3EFE92C3960F8F9C3EC3FD719DF748DBF32497A5986AF8E7CE0EB7F79CC531867A0691C6BE169A65A1E31B34D9CA648E06519B0B156E6EB3889F6A33BB7D858128D1C374A985DDD6CD083E5362F458225D2583605434A26A2F778EF4CBAA01F5CA4147ECAD98C32C62A6B80F228D6BB4246AA5A5E214C243303F4A4
padding = 7E72CE6EE4E01EBF94C03AF2
tmp_aes_key = 322F44D342EA85EF2C5E4968055BE17F764F6881A1876681CD17AAD686F1708A
tmp_aes_iv = 475F370E08D84DD0C14483616A94849F16CA0A929BF874D43487BB2B8F46AC8C</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = FF13E8878D26388F8A6BBF4F33BBD5C630FC2285DC92E322BC2254D06653EF267C7A542BE92F47055F68A1A90BD4C478F5C2372D64833335FDFF0DC4B4003F252988EC05541451CC8139AAB4F32CA308B42FE5F2FE3373D016AFA3A9F6EB5C975AA6A38F906D51ACF787525324F83C942C5F009B17644E3BB2175E7EC3125043C0DBF29898603A86CB5D4833F0550530DAC722F7EDFE965B0C4905D704FE9DE9872DB05939D2FEAF68933529B9742FFFD81F93212C4264C1B93C0010DC38362752564CADFD1713B505CC6DAAA2E463D75D217B1FB4294558E546336D667F6FB90E602C2B8DA5689B8E1C0D1DDE7F1374855C32A2016538DB10E3CB2ED200D81E3B77AD9EE07C706AF64418002B40C07CC20FEFCBB278A749CF8CEC80F2F0C9819CF1AEE3B87FE591AAAC016E740D1B822951069C50ED69363F0C5E91A1AC4BFD9E0AD68FB9C9FB9CBE992B2A91A6B27A</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 54 6F 0B 00 0A 68 C8 68
0010 | 78 01 00 00 1F 5F 04 F5 52 6A 55 BB DA 60 5B 5C
0020 | D1 47 1E 6B 54 F2 70 F7 6D 2F B3 A4 CA 48 18 F7
0030 | DB 47 D8 67 32 61 A7 FC FE 50 01 00 FF 13 E8 87
0040 | 8D 26 38 8F 8A 6B BF 4F 33 BB D5 C6 30 FC 22 85
0050 | DC 92 E3 22 BC 22 54 D0 66 53 EF 26 7C 7A 54 2B
0060 | E9 2F 47 05 5F 68 A1 A9 0B D4 C4 78 F5 C2 37 2D
0070 | 64 83 33 35 FD FF 0D C4 B4 00 3F 25 29 88 EC 05
0080 | 54 14 51 CC 81 39 AA B4 F3 2C A3 08 B4 2F E5 F2
0090 | FE 33 73 D0 16 AF A3 A9 F6 EB 5C 97 5A A6 A3 8F
00A0 | 90 6D 51 AC F7 87 52 53 24 F8 3C 94 2C 5F 00 9B
00B0 | 17 64 4E 3B B2 17 5E 7E C3 12 50 43 C0 DB F2 98
00C0 | 98 60 3A 86 CB 5D 48 33 F0 55 05 30 DA C7 22 F7
00D0 | ED FE 96 5B 0C 49 05 D7 04 FE 9D E9 87 2D B0 59
00E0 | 39 D2 FE AF 68 93 35 29 B9 74 2F FF D8 1F 93 21
00F0 | 2C 42 64 C1 B9 3C 00 10 DC 38 36 27 52 56 4C AD
0100 | FD 17 13 B5 05 CC 6D AA A2 E4 63 D7 5D 21 7B 1F
0110 | B4 29 45 58 E5 46 33 6D 66 7F 6F B9 0E 60 2C 2B
0120 | 8D A5 68 9B 8E 1C 0D 1D DE 7F 13 74 85 5C 32 A2
0130 | 01 65 38 DB 10 E3 CB 2E D2 00 D8 1E 3B 77 AD 9E
0140 | E0 7C 70 6A F6 44 18 00 2B 40 C0 7C C2 0F EF CB
0150 | B2 78 A7 49 CF 8C EC 80 F2 F0 C9 81 9C F1 AE E3
0160 | B8 7F E5 91 AA AC 01 6E 74 0D 1B 82 29 51 06 9C
0170 | 50 ED 69 36 3F 0C 5E 91 A1 AC 4B FD 9E 0A D6 8F
0180 | B9 C9 FB 9C BE 99 2B 2A 91 A6 B2 7A</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>546F0B000A68C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100FF13E8878D26388F8A6BBF4F</code> <code>33BBD5C630FC2285DC92E322BC2254D0</code> <code>6653EF267C7A542BE92F47055F68A1A9</code> <code>0BD4C478F5C2372D64833335FDFF0DC4</code> <code>B4003F252988EC05541451CC8139AAB4</code> <code>F32CA308B42FE5F2FE3373D016AFA3A9</code> <code>F6EB5C975AA6A38F906D51ACF7875253</code> <code>24F83C942C5F009B17644E3BB2175E7E</code> <code>C3125043C0DBF29898603A86CB5D4833</code> <code>F0550530DAC722F7EDFE965B0C4905D7</code> <code>04FE9DE9872DB05939D2FEAF68933529</code> <code>B9742FFFD81F93212C4264C1B93C0010</code> <code>DC38362752564CADFD1713B505CC6DAA</code> <code>A2E463D75D217B1FB4294558E546336D</code> <code>667F6FB90E602C2B8DA5689B8E1C0D1D</code> <code>DE7F1374855C32A2016538DB10E3CB2E</code> <code>D200D81E3B77AD9EE07C706AF6441800</code> <code>2B40C07CC20FEFCBB278A749CF8CEC80</code> <code>F2F0C9819CF1AEE3B87FE591AAAC016E</code> <code>740D1B822951069C50ED69363F0C5E91</code> <code>A1AC4BFD9E0AD68FB9C9FB9CBE992B2A</code><br> <code>91A6B27A</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 54C068DE164F92712DCE75AA7B407E34219441A01FAC994382D647BAF06F02806CB82FC5134300CA451F3C4C075909991FE5BD47316EB317F43345D02267D23EB0211E023720B47DDB504A0BEF8B7E9123797F16383245FCC7812C998C32E67BE7A11F300003556C1B88550E70F9871A36980F69197C01FEA9779C81829E64FCC0858BF9DCE150B2C25CACEBC1171394F18C0D204D4F1188C3B5630EE803E833F8A2CB47BCB902D19AE57AE201085F613F41C281F371DA25CE61B0674BF1733C5C78524A4AB3800BFEEC3CC1E1F8841413027A2FBD536912B46DEAF0746FA4250825726C7A8508D79AAAA17C1924A2191FF789FD45B9E835A9D0E37ED8F4143A</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 30 64 9F 0C 68 C8 68
0010 | 34 00 00 00 34 F7 CB 3B 52 6A 55 BB DA 60 5B 5C
0020 | D1 47 1E 6B 54 F2 70 F7 6D 2F B3 A4 CA 48 18 F7
0030 | DB 47 D8 67 32 61 A7 FC AD 43 FB E9 1C 78 F4 00
0040 | 79 44 01 09 90 5A 4B 94</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0130649F0C68C868</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>526A55BBDA605B5CD1471E6B54F270F7</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>6D2FB3A4CA4818F7DB47D8673261A7FC</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>AD43FBE91C78F40079440109905A4B94</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

