<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 BC 2F 09 00 AF 05 63 67
0010 | 14 00 00 00 F1 8E 7E BE 18 09 C2 D5 A7 BA C3 09
0020 | 7A 79 F3 DF 96 C0 77 BD</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>BC2F0900AF056367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 20 FF 53 AF 05 63 67
0010 | 58 00 00 00 63 24 16 05 18 09 C2 D5 A7 BA C3 09
0020 | 7A 79 F3 DF 96 C0 77 BD 90 5F 0E A2 7F 23 7C D8
0030 | AF C8 25 7F A4 82 A3 C8 08 20 DC 7B B9 36 14 5D
0040 | 19 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0120FF53AF056367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>58000000</code> (88 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>0820DC7BB936145D19000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2367903539496508697</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 2367903539496508697</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>2367903539496508697 = 1417773391 * 1670156567</code></p>
<pre><code>p = 1417773391
q = 1670156567</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 20 DC 7B B9 36 14 5D 19 00 00 00
0010 | 04 54 81 81 4F 00 00 00 04 63 8C 91 17 00 00 00
0020 | 18 09 C2 D5 A7 BA C3 09 7A 79 F3 DF 96 C0 77 BD
0030 | 90 5F 0E A2 7F 23 7C D8 AF C8 25 7F A4 82 A3 C8
0040 | 19 60 45 B2 2D C7 E7 1D 3E 15 17 57 CA 65 E5 44
0050 | A9 61 AF FA 03 84 5B 90 E8 E8 AF 62 F0 4A B7 A0
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>0820DC7BB936145D19000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 2367903539496508697</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>045481814F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1417773391</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>04638C9117000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1670156567</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>196045B22DC7E71D3E151757CA65E544</code> <code>A961AFFA03845B90E8E8AF62F04AB7A0</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A90820DC7BB936145D19000000045481814F00000004638C91170000001809C2D5A7BAC3097A79F3DF96C077BD905F0EA27F237CD8AFC8257FA482A3C8196045B22DC7E71D3E151757CA65E544A961AFFA03845B90E8E8AF62F04AB7A002000000
random_padding_bytes = 6AAAE66FA1FDA24D92E19B152784480FD479C918F48B069B84D42EC250C197F8562934D812649EC0E69D9D30A6AA15FD9390718BCFACCE68FA37B7D4BBD906A7B54187E38808572DDBA99324463B4BA085B9F280A22E579F13D913B2</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = C1EE13FD36A8D055C3FE726D077B4DDEE3A2D2D8C0647A930B33E03EA40F4FE319470470730738B30F936396AB225AD220298E3E6DB78737B300C86AFD1A9E782B2EA4C350F8031153E7D5AADE7324403F3E5A66791AD15F3844A3AE4BA4C1D3C69F83428BB7FA48B09FED2DE933593254EDD896F471F16F41FFABD77A3AE1A064E6C589A1EFD13575A0CC5CCAB26A909E5A653EDB3F8C6109D4894932925BBDEA97D498E50B898843F63C1F8DF1F90615C9BD8CF2932BD10158567E971448F8A43111C5D0379892FA40170FAFE645434550762BF9106DAF2F5F0C12A0D554796F253FAA0BC3E2616ECF899FD0A82504991D7681F9091C6E1398092763EF6EEF</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 C0 2F 09 00 AF 05 63 67
0010 | 40 01 00 00 BE E4 12 D7 18 09 C2 D5 A7 BA C3 09
0020 | 7A 79 F3 DF 96 C0 77 BD 90 5F 0E A2 7F 23 7C D8
0030 | AF C8 25 7F A4 82 A3 C8 04 54 81 81 4F 00 00 00
0040 | 04 63 8C 91 17 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 C1 EE 13 FD 36 A8 D0 55 C3 FE 72 6D
0060 | 07 7B 4D DE E3 A2 D2 D8 C0 64 7A 93 0B 33 E0 3E
0070 | A4 0F 4F E3 19 47 04 70 73 07 38 B3 0F 93 63 96
0080 | AB 22 5A D2 20 29 8E 3E 6D B7 87 37 B3 00 C8 6A
0090 | FD 1A 9E 78 2B 2E A4 C3 50 F8 03 11 53 E7 D5 AA
00A0 | DE 73 24 40 3F 3E 5A 66 79 1A D1 5F 38 44 A3 AE
00B0 | 4B A4 C1 D3 C6 9F 83 42 8B B7 FA 48 B0 9F ED 2D
00C0 | E9 33 59 32 54 ED D8 96 F4 71 F1 6F 41 FF AB D7
00D0 | 7A 3A E1 A0 64 E6 C5 89 A1 EF D1 35 75 A0 CC 5C
00E0 | CA B2 6A 90 9E 5A 65 3E DB 3F 8C 61 09 D4 89 49
00F0 | 32 92 5B BD EA 97 D4 98 E5 0B 89 88 43 F6 3C 1F
0100 | 8D F1 F9 06 15 C9 BD 8C F2 93 2B D1 01 58 56 7E
0110 | 97 14 48 F8 A4 31 11 C5 D0 37 98 92 FA 40 17 0F
0120 | AF E6 45 43 45 50 76 2B F9 10 6D AF 2F 5F 0C 12
0130 | A0 D5 54 79 6F 25 3F AA 0B C3 E2 61 6E CF 89 9F
0140 | D0 A8 25 04 99 1D 76 81 F9 09 1C 6E 13 98 09 27
0150 | 63 EF 6E EF</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>C02F0900AF056367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>045481814F000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1417773391</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>04638C9117000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1670156567</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100C1EE13FD36A8D055C3FE726D</code> <code>077B4DDEE3A2D2D8C0647A930B33E03E</code> <code>A40F4FE319470470730738B30F936396</code> <code>AB225AD220298E3E6DB78737B300C86A</code> <code>FD1A9E782B2EA4C350F8031153E7D5AA</code> <code>DE7324403F3E5A66791AD15F3844A3AE</code> <code>4BA4C1D3C69F83428BB7FA48B09FED2D</code> <code>E933593254EDD896F471F16F41FFABD7</code> <code>7A3AE1A064E6C589A1EFD13575A0CC5C</code> <code>CAB26A909E5A653EDB3F8C6109D48949</code> <code>32925BBDEA97D498E50B898843F63C1F</code> <code>8DF1F90615C9BD8CF2932BD10158567E</code> <code>971448F8A43111C5D0379892FA40170F</code> <code>AFE645434550762BF9106DAF2F5F0C12</code> <code>A0D554796F253FAA0BC3E2616ECF899F</code> <code>D0A82504991D7681F9091C6E13980927</code><br> <code>63EF6EEF</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 8C 2A E1 AF 05 63 67
0010 | A4 02 00 00 5C 07 E8 D0 18 09 C2 D5 A7 BA C3 09
0020 | 7A 79 F3 DF 96 C0 77 BD 90 5F 0E A2 7F 23 7C D8
0030 | AF C8 25 7F A4 82 A3 C8 FE 50 02 00 36 56 3F F7
0040 | 64 EA EB 79 55 92 AD 24 CD 24 9C 64 94 62 0B 83
0050 | 88 24 DD 96 4C A2 FE 61 26 E2 65 45 C4 DC 18 D6
0060 | 18 A9 75 00 2C 15 44 A8 CD 53 45 0B 66 BE 61 68
0070 | E9 46 9D 29 21 B9 92 3A 6D 8D A3 13 46 7B 91 C4
0080 | AE 10 58 80 74 09 F8 2B EC 6D D3 BE D7 D1 AB 72
0090 | FB 4D FC 26 6C D2 75 09 AF 20 13 C8 2E 26 E8 9C
00A0 | EC 0C 92 94 81 BE 31 84 50 8D 71 65 B0 6F CE 99
00B0 | 9E 0C DB 4B 0D 43 C7 8A D7 66 B7 97 D7 4A 80 11
00C0 | A6 C2 4E E7 C7 AD 71 E3 A3 5B 2D 94 F6 AF 95 F7
00D0 | 5C C1 B9 B8 EB B8 A0 A5 7B FA 6C FB 6E B1 46 66
00E0 | 0E 83 1E 34 FC B0 08 D6 E0 D7 9D A6 CB 32 FE DD
00F0 | D0 71 4F 5A 01 22 22 5C EC E1 7A 69 19 90 B7 55
0100 | FD D9 26 BE 02 4E 7A DB 96 87 20 F5 D0 42 AF B5
0110 | 06 51 7C 1A 2C 23 21 F9 49 1E 37 FE 93 8C 3F 99
0120 | DF 9D 0C 20 35 05 2D 32 5C D6 12 C9 8D EE 01 03
0130 | 5E B5 E7 19 E7 C6 A2 60 1F 01 83 1B F8 32 A1 92
0140 | A1 66 98 F5 D5 1B E2 DF AC 36 33 54 C2 D6 26 F0
0150 | F8 52 89 11 17 F3 3C 3E CF 28 0A AD 8E E8 23 F7
0160 | 49 A4 DE 52 D6 E0 AE D3 E4 90 61 41 7B 57 80 9A
0170 | 72 EE 06 96 66 2D 7A B8 2E B6 2B 42 B3 AA A3 11
0180 | E0 AF B0 59 4E 2A AE 5F FF C3 5F 81 E4 5D F8 1A
0190 | 29 9B 68 27 29 06 88 55 D3 7E 5D C4 29 A3 77 ED
01A0 | 17 45 81 18 EB 66 B3 DF 73 3B E0 CD 0E F6 AF 51
01B0 | CF 6C 2C 5A F6 E5 E2 7F 3B AE 79 12 1C 9A A1 1A
01C0 | 11 80 F1 91 0A D0 DA 90 D6 42 86 83 F5 E3 DC D8
01D0 | 33 15 A6 E7 62 D9 FF F3 8F FF 4B 86 4F BA E7 BB
01E0 | 1D 14 96 90 21 5A A8 F1 9F AB 2E 99 E1 7A AF D3
01F0 | B5 52 26 54 3A E3 70 47 A7 F4 65 FF 71 E1 3C BF
0200 | CA E2 2C 5C 17 B9 77 2D CB 7B 7A C9 87 00 C1 66
0210 | FB 6F E7 87 E8 77 D6 4F 3D 35 C1 72 FF 70 11 5A
0220 | EE 3F 43 01 9E 80 EA C9 3D 7A A6 26 81 D5 4C FC
0230 | 24 79 68 FA FF 23 09 1A 91 46 AB 4E 64 C6 12 5F
0240 | 73 F0 A7 B2 8C FE 1D 48 5D A4 86 14 6F 4B 01 92
0250 | 69 15 E7 1A DE D2 0A 62 0E 3B 80 26 0B 47 E8 69
0260 | 04 28 98 16 B5 1C 30 C1 1C 2C E0 4E 74 51 8F 44
0270 | 19 90 47 BD 75 E9 83 56 A7 F6 57 CF BD 92 CC 80
0280 | 3B 23 E8 1D 84 12 1D 2B 8C 3D 95 92</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>018C2AE1AF056367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>A4020000</code> (676 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE50020036563FF764EAEB795592AD24</code> <code>CD249C6494620B838824DD964CA2FE61</code> <code>26E26545C4DC18D618A975002C1544A8</code> <code>CD53450B66BE6168E9469D2921B9923A</code> <code>6D8DA313467B91C4AE1058807409F82B</code> <code>EC6DD3BED7D1AB72FB4DFC266CD27509</code> <code>AF2013C82E26E89CEC0C929481BE3184</code> <code>508D7165B06FCE999E0CDB4B0D43C78A</code> <code>D766B797D74A8011A6C24EE7C7AD71E3</code> <code>A35B2D94F6AF95F75CC1B9B8EBB8A0A5</code> <code>7BFA6CFB6EB146660E831E34FCB008D6</code> <code>E0D79DA6CB32FEDDD0714F5A0122225C</code> <code>ECE17A691990B755FDD926BE024E7ADB</code> <code>968720F5D042AFB506517C1A2C2321F9</code> <code>491E37FE938C3F99DF9D0C2035052D32</code> <code>5CD612C98DEE01035EB5E719E7C6A260</code> <code>1F01831BF832A192A16698F5D51BE2DF</code> <code>AC363354C2D626F0F852891117F33C3E</code> <code>CF280AAD8EE823F749A4DE52D6E0AED3</code> <code>E49061417B57809A72EE0696662D7AB8</code> <code>2EB62B42B3AAA311E0AFB0594E2AAE5F</code> <code>FFC35F81E45DF81A299B682729068855</code> <code>D37E5DC429A377ED17458118EB66B3DF</code> <code>733BE0CD0EF6AF51CF6C2C5AF6E5E27F</code> <code>3BAE79121C9AA11A1180F1910AD0DA90</code> <code>D6428683F5E3DCD83315A6E762D9FFF3</code> <code>8FFF4B864FBAE7BB1D149690215AA8F1</code> <code>9FAB2E99E17AAFD3B55226543AE37047</code> <code>A7F465FF71E13CBFCAE22C5C17B9772D</code> <code>CB7B7AC98700C166FB6FE787E877D64F</code> <code>3D35C172FF70115AEE3F43019E80EAC9</code> <code>3D7AA62681D54CFC247968FAFF23091A</code> <code>9146AB4E64C6125F73F0A7B28CFE1D48</code> <code>5DA486146F4B01926915E71ADED20A62</code> <code>0E3B80260B47E86904289816B51C30C1</code> <code>1C2CE04E74518F44199047BD75E98356</code> <code>A7F657CFBD92CC803B23E81D84121D2B</code><br> <code>8C3D9592</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = 36563FF764EAEB795592AD24CD249C6494620B838824DD964CA2FE6126E26545C4DC18D618A975002C1544A8CD53450B66BE6168E9469D2921B9923A6D8DA313467B91C4AE1058807409F82BEC6DD3BED7D1AB72FB4DFC266CD27509AF2013C82E26E89CEC0C929481BE3184508D7165B06FCE999E0CDB4B0D43C78AD766B797D74A8011A6C24EE7C7AD71E3A35B2D94F6AF95F75CC1B9B8EBB8A0A57BFA6CFB6EB146660E831E34FCB008D6E0D79DA6CB32FEDDD0714F5A0122225CECE17A691990B755FDD926BE024E7ADB968720F5D042AFB506517C1A2C2321F9491E37FE938C3F99DF9D0C2035052D325CD612C98DEE01035EB5E719E7C6A2601F01831BF832A192A16698F5D51BE2DFAC363354C2D626F0F852891117F33C3ECF280AAD8EE823F749A4DE52D6E0AED3E49061417B57809A72EE0696662D7AB82EB62B42B3AAA311E0AFB0594E2AAE5FFFC35F81E45DF81A299B682729068855D37E5DC429A377ED17458118EB66B3DF733BE0CD0EF6AF51CF6C2C5AF6E5E27F3BAE79121C9AA11A1180F1910AD0DA90D6428683F5E3DCD83315A6E762D9FFF38FFF4B864FBAE7BB1D149690215AA8F19FAB2E99E17AAFD3B55226543AE37047A7F465FF71E13CBFCAE22C5C17B9772DCB7B7AC98700C166FB6FE787E877D64F3D35C172FF70115AEE3F43019E80EAC93D7AA62681D54CFC247968FAFF23091A9146AB4E64C6125F73F0A7B28CFE1D485DA486146F4B01926915E71ADED20A620E3B80260B47E86904289816B51C30C11C2CE04E74518F44199047BD75E98356A7F657CFBD92CC803B23E81D84121D2B8C3D9592
tmp_aes_key = 53564D7AD097F21371636AA553DDCE6DB1FA3342ACB834C5A8E9EC5CD4CB9A06
tmp_aes_iv = F4BEE4A373470E7144367AA8842B331493957AB3605A0613B8D4D81A196045B2</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = 14E5572620F777614A26DAAA9F3389EB66BD8800BA0D89B51809C2D5A7BAC3097A79F3DF96C077BD905F0EA27F237CD8AFC8257FA482A3C803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007C5EA157510B6274B743DF20CB11414445B5631210CE1C85C86566B9E1F5854B27840A1F46B22B8B48588B4F40C576D11AE9AD25AE65DDB6D2F696B5AA11767AF69900DE96C667854D9EADAFADE3B2008C384673C50D988028F06A487CE1FA318EA1856FF63D6E22736595AB81D93E6A3FC9663FECF49C4F40B290530012DB7FE3318AA80B6DB3BC8C31568014BC705FF6F54AFA15AB68AAF804D205FEA10ACAD9EA91AA728EA757A10F5A7CA41C5EB2DCABD0D687ED040CC6E22DEC8FF02DAAA3386C7AA19CFF6C49CD609AE7683EC13A4082D1F2D9B70E61EBBAB7F3DCAFF090D25CABFFB3ED1CADA827A1376A6B7774125D9C934A5C2D7C16126E5171C307AF056367B9CD4DB27A6BD8F5
answer = BA0D89B51809C2D5A7BAC3097A79F3DF96C077BD905F0EA27F237CD8AFC8257FA482A3C803000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001007C5EA157510B6274B743DF20CB11414445B5631210CE1C85C86566B9E1F5854B27840A1F46B22B8B48588B4F40C576D11AE9AD25AE65DDB6D2F696B5AA11767AF69900DE96C667854D9EADAFADE3B2008C384673C50D988028F06A487CE1FA318EA1856FF63D6E22736595AB81D93E6A3FC9663FECF49C4F40B290530012DB7FE3318AA80B6DB3BC8C31568014BC705FF6F54AFA15AB68AAF804D205FEA10ACAD9EA91AA728EA757A10F5A7CA41C5EB2DCABD0D687ED040CC6E22DEC8FF02DAAA3386C7AA19CFF6C49CD609AE7683EC13A4082D1F2D9B70E61EBBAB7F3DCAFF090D25CABFFB3ED1CADA827A1376A6B7774125D9C934A5C2D7C16126E5171C307AF056367B9CD4DB27A6BD8F5</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 18 09 C2 D5 A7 BA C3 09 7A 79 F3 DF
0010 | 96 C0 77 BD 90 5F 0E A2 7F 23 7C D8 AF C8 25 7F
0020 | A4 82 A3 C8 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 7C 5E A1 57 51 0B 62 74 B7 43 DF 20 CB 11 41 44
0140 | 45 B5 63 12 10 CE 1C 85 C8 65 66 B9 E1 F5 85 4B
0150 | 27 84 0A 1F 46 B2 2B 8B 48 58 8B 4F 40 C5 76 D1
0160 | 1A E9 AD 25 AE 65 DD B6 D2 F6 96 B5 AA 11 76 7A
0170 | F6 99 00 DE 96 C6 67 85 4D 9E AD AF AD E3 B2 00
0180 | 8C 38 46 73 C5 0D 98 80 28 F0 6A 48 7C E1 FA 31
0190 | 8E A1 85 6F F6 3D 6E 22 73 65 95 AB 81 D9 3E 6A
01A0 | 3F C9 66 3F EC F4 9C 4F 40 B2 90 53 00 12 DB 7F
01B0 | E3 31 8A A8 0B 6D B3 BC 8C 31 56 80 14 BC 70 5F
01C0 | F6 F5 4A FA 15 AB 68 AA F8 04 D2 05 FE A1 0A CA
01D0 | D9 EA 91 AA 72 8E A7 57 A1 0F 5A 7C A4 1C 5E B2
01E0 | DC AB D0 D6 87 ED 04 0C C6 E2 2D EC 8F F0 2D AA
01F0 | A3 38 6C 7A A1 9C FF 6C 49 CD 60 9A E7 68 3E C1
0200 | 3A 40 82 D1 F2 D9 B7 0E 61 EB BA B7 F3 DC AF F0
0210 | 90 D2 5C AB FF B3 ED 1C AD A8 27 A1 37 6A 6B 77
0220 | 74 12 5D 9C 93 4A 5C 2D 7C 16 12 6E 51 71 C3 07
0230 | AF 05 63 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001007C5EA157510B6274B743DF20</code> <code>CB11414445B5631210CE1C85C86566B9</code> <code>E1F5854B27840A1F46B22B8B48588B4F</code> <code>40C576D11AE9AD25AE65DDB6D2F696B5</code> <code>AA11767AF69900DE96C667854D9EADAF</code> <code>ADE3B2008C384673C50D988028F06A48</code> <code>7CE1FA318EA1856FF63D6E22736595AB</code> <code>81D93E6A3FC9663FECF49C4F40B29053</code> <code>0012DB7FE3318AA80B6DB3BC8C315680</code> <code>14BC705FF6F54AFA15AB68AAF804D205</code> <code>FEA10ACAD9EA91AA728EA757A10F5A7C</code> <code>A41C5EB2DCABD0D687ED040CC6E22DEC</code> <code>8FF02DAAA3386C7AA19CFF6C49CD609A</code> <code>E7683EC13A4082D1F2D9B70E61EBBAB7</code> <code>F3DCAFF090D25CABFFB3ED1CADA827A1</code> <code>376A6B7774125D9C934A5C2D7C16126E</code><br> <code>5171C307</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>AF056367</code> (1734542767 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 5AB1646BF77C50CC0D8B79E9869D109F398B302977CB3FF41F2A42B849FA8DDC7B0743D3A8B26265671408EFBC157A0628D8A37B76E28C8B22F62F6AB7363838DF14337370C122EEEC970A2C165066FC869F9BFB50DDC6F71762591BD867B462494090C2FC48B1B207B569980EABCC76219856DE5EE943EB2EB3F4A91C7021B26E7850D30EE8A36C673E2F87FC899AC085D226655C52113B387C3C9D2F367002E33AB5E3BC5112039E9B75582103241C2639D39407F7E9AA19C06B2B5151C222A3DA05FD6DD2B25A16097343A1BB3450085CE2E2CED0E227B155E9E0E6069046B32B71D1309E9913AC15F80028E09B62B2D92003AB1A4067B2C1AD9041EA22AB</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 16351B918D4FE5AAAC605CCF85E3B3127BED8803117ACBB0D8B3A3827FA4FA57017D362A5708F761921A46C129663B158E747E5920F63E65140B31C750872EC0AA95E8EA2A85F4BBDE7797468A2D974C2B3DF55A5B3B936288533BD994AE0D2CB4A4E1C1AF2D8F97112E6B89233AB851B17B14C609EE9648586133994EC1E76E18A61AE8B6954A7E696F159A7BDC3EE42D804BD4C671D2E7C8A7204AE54E2F7F9FEF2F23EB2B825FD33EAD7022FD4FFB84F6697075BD94AECFBFCF597B4F7D5EB12BC7AAF6B885376C40D53E8A75226CC6C50DE83DA7BFEAA2D90148949F0F277BAAB08D2DD2635967D36F6497F8DBA277C6430B0EB7AD2E5796EF5DF0A77FC0</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 18 09 C2 D5 A7 BA C3 09 7A 79 F3 DF
0010 | 96 C0 77 BD 90 5F 0E A2 7F 23 7C D8 AF C8 25 7F
0020 | A4 82 A3 C8 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 16 35 1B 91 8D 4F E5 AA AC 60 5C CF 85 E3 B3 12
0040 | 7B ED 88 03 11 7A CB B0 D8 B3 A3 82 7F A4 FA 57
0050 | 01 7D 36 2A 57 08 F7 61 92 1A 46 C1 29 66 3B 15
0060 | 8E 74 7E 59 20 F6 3E 65 14 0B 31 C7 50 87 2E C0
0070 | AA 95 E8 EA 2A 85 F4 BB DE 77 97 46 8A 2D 97 4C
0080 | 2B 3D F5 5A 5B 3B 93 62 88 53 3B D9 94 AE 0D 2C
0090 | B4 A4 E1 C1 AF 2D 8F 97 11 2E 6B 89 23 3A B8 51
00A0 | B1 7B 14 C6 09 EE 96 48 58 61 33 99 4E C1 E7 6E
00B0 | 18 A6 1A E8 B6 95 4A 7E 69 6F 15 9A 7B DC 3E E4
00C0 | 2D 80 4B D4 C6 71 D2 E7 C8 A7 20 4A E5 4E 2F 7F
00D0 | 9F EF 2F 23 EB 2B 82 5F D3 3E AD 70 22 FD 4F FB
00E0 | 84 F6 69 70 75 BD 94 AE CF BF CF 59 7B 4F 7D 5E
00F0 | B1 2B C7 AA F6 B8 85 37 6C 40 D5 3E 8A 75 22 6C
0100 | C6 C5 0D E8 3D A7 BF EA A2 D9 01 48 94 9F 0F 27
0110 | 7B AA B0 8D 2D D2 63 59 67 D3 6F 64 97 F8 DB A2
0120 | 77 C6 43 0B 0E B7 AD 2E 57 96 EF 5D F0 A7 7F C0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE00010016351B918D4FE5AAAC605CCF</code> <code>85E3B3127BED8803117ACBB0D8B3A382</code> <code>7FA4FA57017D362A5708F761921A46C1</code> <code>29663B158E747E5920F63E65140B31C7</code> <code>50872EC0AA95E8EA2A85F4BBDE779746</code> <code>8A2D974C2B3DF55A5B3B936288533BD9</code> <code>94AE0D2CB4A4E1C1AF2D8F97112E6B89</code> <code>233AB851B17B14C609EE964858613399</code> <code>4EC1E76E18A61AE8B6954A7E696F159A</code> <code>7BDC3EE42D804BD4C671D2E7C8A7204A</code> <code>E54E2F7F9FEF2F23EB2B825FD33EAD70</code> <code>22FD4FFB84F6697075BD94AECFBFCF59</code> <code>7B4F7D5EB12BC7AAF6B885376C40D53E</code> <code>8A75226CC6C50DE83DA7BFEAA2D90148</code> <code>949F0F277BAAB08D2DD2635967D36F64</code> <code>97F8DBA277C6430B0EB7AD2E5796EF5D</code><br> <code>F0A77FC0</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643661809C2D5A7BAC3097A79F3DF96C077BD905F0EA27F237CD8AFC8257FA482A3C80000000000000000FE00010016351B918D4FE5AAAC605CCF85E3B3127BED8803117ACBB0D8B3A3827FA4FA57017D362A5708F761921A46C129663B158E747E5920F63E65140B31C750872EC0AA95E8EA2A85F4BBDE7797468A2D974C2B3DF55A5B3B936288533BD994AE0D2CB4A4E1C1AF2D8F97112E6B89233AB851B17B14C609EE9648586133994EC1E76E18A61AE8B6954A7E696F159A7BDC3EE42D804BD4C671D2E7C8A7204AE54E2F7F9FEF2F23EB2B825FD33EAD7022FD4FFB84F6697075BD94AECFBFCF597B4F7D5EB12BC7AAF6B885376C40D53E8A75226CC6C50DE83DA7BFEAA2D90148949F0F277BAAB08D2DD2635967D36F6497F8DBA277C6430B0EB7AD2E5796EF5DF0A77FC0
padding = 0DC45306E4D97605412A288F
tmp_aes_key = 53564D7AD097F21371636AA553DDCE6DB1FA3342ACB834C5A8E9EC5CD4CB9A06
tmp_aes_iv = F4BEE4A373470E7144367AA8842B331493957AB3605A0613B8D4D81A196045B2</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 83EC193782BCAC6CD67419179A995576F7C25F282345CF141C7C054678E3BCD0CC6B5CACE1F0085073139C2D62800DC11A3F53CF86A74C60BE09BC6A5B1058DBA0D6BB1EB5F2B2CCA4297CC6B0F0A55718959E495C89CD71817CF109FB1EF92B80304C42EC99791AA30061C921FCC7B1899232B85CCDE70A31310CE6A40E18D4D833FCBA1CD83FE42E3984CFBEF8DC440D4E98A11AC4D5508379F43D20E96CDA89D66601D67623F40E8FAB1C59F4B999F5D70256D07D40F42580FD2626D018DB077770C4F24520DD4AD606F1B71C51D1DA3420ADCEEDEB818E26A0C24BBDAFBD222A35E1580801271CD139E97251C1B1801BEA510AFBAB9285BDD119E270B45116E5B9899801F39322E797807E18123BB111A0E878A977541F389AE093F9E91A101426B7E6E309791DFC793FB9D01362679F2FE7E5780A63A8A00601FE52548C184DCC854F8F99143CEC86F92F8AC137</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 34 74 0E 00 AF 05 63 67
0010 | 78 01 00 00 1F 5F 04 F5 18 09 C2 D5 A7 BA C3 09
0020 | 7A 79 F3 DF 96 C0 77 BD 90 5F 0E A2 7F 23 7C D8
0030 | AF C8 25 7F A4 82 A3 C8 FE 50 01 00 83 EC 19 37
0040 | 82 BC AC 6C D6 74 19 17 9A 99 55 76 F7 C2 5F 28
0050 | 23 45 CF 14 1C 7C 05 46 78 E3 BC D0 CC 6B 5C AC
0060 | E1 F0 08 50 73 13 9C 2D 62 80 0D C1 1A 3F 53 CF
0070 | 86 A7 4C 60 BE 09 BC 6A 5B 10 58 DB A0 D6 BB 1E
0080 | B5 F2 B2 CC A4 29 7C C6 B0 F0 A5 57 18 95 9E 49
0090 | 5C 89 CD 71 81 7C F1 09 FB 1E F9 2B 80 30 4C 42
00A0 | EC 99 79 1A A3 00 61 C9 21 FC C7 B1 89 92 32 B8
00B0 | 5C CD E7 0A 31 31 0C E6 A4 0E 18 D4 D8 33 FC BA
00C0 | 1C D8 3F E4 2E 39 84 CF BE F8 DC 44 0D 4E 98 A1
00D0 | 1A C4 D5 50 83 79 F4 3D 20 E9 6C DA 89 D6 66 01
00E0 | D6 76 23 F4 0E 8F AB 1C 59 F4 B9 99 F5 D7 02 56
00F0 | D0 7D 40 F4 25 80 FD 26 26 D0 18 DB 07 77 70 C4
0100 | F2 45 20 DD 4A D6 06 F1 B7 1C 51 D1 DA 34 20 AD
0110 | CE ED EB 81 8E 26 A0 C2 4B BD AF BD 22 2A 35 E1
0120 | 58 08 01 27 1C D1 39 E9 72 51 C1 B1 80 1B EA 51
0130 | 0A FB AB 92 85 BD D1 19 E2 70 B4 51 16 E5 B9 89
0140 | 98 01 F3 93 22 E7 97 80 7E 18 12 3B B1 11 A0 E8
0150 | 78 A9 77 54 1F 38 9A E0 93 F9 E9 1A 10 14 26 B7
0160 | E6 E3 09 79 1D FC 79 3F B9 D0 13 62 67 9F 2F E7
0170 | E5 78 0A 63 A8 A0 06 01 FE 52 54 8C 18 4D CC 85
0180 | 4F 8F 99 14 3C EC 86 F9 2F 8A C1 37</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>34740E00AF056367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE50010083EC193782BCAC6CD6741917</code> <code>9A995576F7C25F282345CF141C7C0546</code> <code>78E3BCD0CC6B5CACE1F0085073139C2D</code> <code>62800DC11A3F53CF86A74C60BE09BC6A</code> <code>5B1058DBA0D6BB1EB5F2B2CCA4297CC6</code> <code>B0F0A55718959E495C89CD71817CF109</code> <code>FB1EF92B80304C42EC99791AA30061C9</code> <code>21FCC7B1899232B85CCDE70A31310CE6</code> <code>A40E18D4D833FCBA1CD83FE42E3984CF</code> <code>BEF8DC440D4E98A11AC4D5508379F43D</code> <code>20E96CDA89D66601D67623F40E8FAB1C</code> <code>59F4B999F5D70256D07D40F42580FD26</code> <code>26D018DB077770C4F24520DD4AD606F1</code> <code>B71C51D1DA3420ADCEEDEB818E26A0C2</code> <code>4BBDAFBD222A35E1580801271CD139E9</code> <code>7251C1B1801BEA510AFBAB9285BDD119</code> <code>E270B45116E5B9899801F39322E79780</code> <code>7E18123BB111A0E878A977541F389AE0</code> <code>93F9E91A101426B7E6E309791DFC793F</code> <code>B9D01362679F2FE7E5780A63A8A00601</code> <code>FE52548C184DCC854F8F99143CEC86F9</code><br> <code>2F8AC137</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7C5198C6679A7E43E684BDB10F9E558E36F54F18F3D007E0E6F9BA629FC2B65E6C2240DDCB79D8573255D4A3CD77B2F170C39832334D80D991BDCBFD6DFDBA3242AC95D8F472DD72D6994AAF07B105D3EFB40B6F1A609D0383815D51B21E27B133D1CDAC5FDA0DE137C3FD317702EF24E140671F3B36A0129E803F26E1E34588E3C6E2CEEB4256848A52760288AEDA71EB56CF62164CA328AFD3B6D5313E973058BC49D29B7AF76F1F856F0FFD45D0DE633242C8B03B08E9C67EBBC1CDFB52399DB09EE35732CDF9B374B0649CD382A584827B0110ABCC4D26C2D1DA2683260DAFA868DF4CFA00A83DBEEDAED5928C6A6C9487858EBE710E8ACDE5E9308CF63B</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 58 CC 3C B0 05 63 67
0010 | AC 00 00 00 34 F7 CB 3B 18 09 C2 D5 A7 BA C3 09
0020 | 7A 79 F3 DF 96 C0 77 BD 90 5F 0E A2 7F 23 7C D8
0030 | AF C8 25 7F A4 82 A3 C8 9C 8E EC C6 DB 05 6D 45
0040 | B5 E0 C1 3C 62 E2 11 85</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0158CC3CB0056367</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>AC000000</code> (172 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>1809C2D5A7BAC3097A79F3DF96C077BD</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>905F0EA27F237CD8AFC8257FA482A3C8</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>9C8EECC6DB056D45B5E0C13C62E21185</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

