<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?242" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 84 60 01 00 0F F1 6E 67
0010 | 14 00 00 00 F1 8E 7E BE 43 85 36 A4 46 11 6D 9A
0020 | BE 31 4A E6 09 B5 9B 87</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>846001000FF16E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 82 DB 0F F1 6E 67
0010 | 50 00 00 00 63 24 16 05 43 85 36 A4 46 11 6D 9A
0020 | BE 31 4A E6 09 B5 9B 87 9C 8D E1 99 E1 0D 61 49
0030 | CD 27 6D 4D 32 8B 07 15 08 1A 56 09 DC BC 49 89
0040 | C7 00 00 00 15 C4 B5 1C 03 00 00 00 85 FD 64 DE
0050 | 85 1D 9D D0 A5 B7 F7 09 35 5F C3 0B 21 6B E8 6C
0060 | 02 2B B4 C3</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E882DB0FF16E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>50000000</code> (80 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081A5609DCBC4989C7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1897715136639633863</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1897715136639633863</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1897715136639633863 = 1232089927 * 1540240769</code></p>
<pre><code>p = 1232089927
q = 1540240769</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1A 56 09 DC BC 49 89 C7 00 00 00
0010 | 04 49 70 33 47 00 00 00 04 5B CE 35 81 00 00 00
0020 | 43 85 36 A4 46 11 6D 9A BE 31 4A E6 09 B5 9B 87
0030 | 9C 8D E1 99 E1 0D 61 49 CD 27 6D 4D 32 8B 07 15
0040 | 52 4E 97 5F DA E8 5A BC C1 8E 17 7E 4B 32 37 DA
0050 | B6 13 03 C0 F2 7B F6 5D 9E 6A FA 1A FE 86 70 1A
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081A5609DCBC4989C7000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1897715136639633863</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>0449703347000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1232089927</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>045BCE3581000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1540240769</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>524E975FDAE85ABCC18E177E4B3237DA</code> <code>B61303C0F27BF65D9E6AFA1AFE86701A</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081A5609DCBC4989C70000000449703347000000045BCE3581000000438536A446116D9ABE314AE609B59B879C8DE199E10D6149CD276D4D328B0715524E975FDAE85ABCC18E177E4B3237DAB61303C0F27BF65D9E6AFA1AFE86701A02000000
random_padding_bytes = 18D9DA60A394E05205986804B081CDB4F5E411C48B087BCB925009F376424FB132DA80F93D5E73DAFBF3E86ABF4E54FD88330FE9CB13F728A79133DFF6A1AC0E77FC0BA61989B5403E31BBB322267778DFB124D7BE8B4E7FD3C90CE9</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = CC8B770DC340ED467647643610C6CC07BAA6104497242C7F873DCDFE96ECBDE73939BE08C54530AEE527942043AAB53A2638BC85BF5FB28EA6724EDE4839AABFE5098CA624AE5903199E6E45FAE524A5C6B22B42D0857540EEA87864F118E0BCE24CAE424A61625419E04EBA0AAE1267D0000B5FD1C98CF675CBF00F7289A16FEA72F36F3DC2C43A3403C9902C982756EB82472A49569D5896205625A7B48F0C075C828F6CD7AB44FAB8113A74132CACDFF054B7CA2F0D4C2F1CB19D5C87779B005A17B8B6AC9677A50A58F62F02B78FDB4648C708F564E76C4F9BBC1F66EC16DD0783DBB5893AB8E7639FB2ED66602A75412C406C02AE277EBFF101789D8F74</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 EC DE 06 00 0F F1 6E 67
0010 | 40 01 00 00 BE E4 12 D7 43 85 36 A4 46 11 6D 9A
0020 | BE 31 4A E6 09 B5 9B 87 9C 8D E1 99 E1 0D 61 49
0030 | CD 27 6D 4D 32 8B 07 15 04 49 70 33 47 00 00 00
0040 | 04 5B CE 35 81 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 CC 8B 77 0D C3 40 ED 46 76 47 64 36
0060 | 10 C6 CC 07 BA A6 10 44 97 24 2C 7F 87 3D CD FE
0070 | 96 EC BD E7 39 39 BE 08 C5 45 30 AE E5 27 94 20
0080 | 43 AA B5 3A 26 38 BC 85 BF 5F B2 8E A6 72 4E DE
0090 | 48 39 AA BF E5 09 8C A6 24 AE 59 03 19 9E 6E 45
00A0 | FA E5 24 A5 C6 B2 2B 42 D0 85 75 40 EE A8 78 64
00B0 | F1 18 E0 BC E2 4C AE 42 4A 61 62 54 19 E0 4E BA
00C0 | 0A AE 12 67 D0 00 0B 5F D1 C9 8C F6 75 CB F0 0F
00D0 | 72 89 A1 6F EA 72 F3 6F 3D C2 C4 3A 34 03 C9 90
00E0 | 2C 98 27 56 EB 82 47 2A 49 56 9D 58 96 20 56 25
00F0 | A7 B4 8F 0C 07 5C 82 8F 6C D7 AB 44 FA B8 11 3A
0100 | 74 13 2C AC DF F0 54 B7 CA 2F 0D 4C 2F 1C B1 9D
0110 | 5C 87 77 9B 00 5A 17 B8 B6 AC 96 77 A5 0A 58 F6
0120 | 2F 02 B7 8F DB 46 48 C7 08 F5 64 E7 6C 4F 9B BC
0130 | 1F 66 EC 16 DD 07 83 DB B5 89 3A B8 E7 63 9F B2
0140 | ED 66 60 2A 75 41 2C 40 6C 02 AE 27 7E BF F1 01
0150 | 78 9D 8F 74</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>ECDE06000FF16E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>0449703347000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1232089927</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>045BCE3581000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1540240769</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100CC8B770DC340ED4676476436</code> <code>10C6CC07BAA6104497242C7F873DCDFE</code> <code>96ECBDE73939BE08C54530AEE5279420</code> <code>43AAB53A2638BC85BF5FB28EA6724EDE</code> <code>4839AABFE5098CA624AE5903199E6E45</code> <code>FAE524A5C6B22B42D0857540EEA87864</code> <code>F118E0BCE24CAE424A61625419E04EBA</code> <code>0AAE1267D0000B5FD1C98CF675CBF00F</code> <code>7289A16FEA72F36F3DC2C43A3403C990</code> <code>2C982756EB82472A49569D5896205625</code> <code>A7B48F0C075C828F6CD7AB44FAB8113A</code> <code>74132CACDFF054B7CA2F0D4C2F1CB19D</code> <code>5C87779B005A17B8B6AC9677A50A58F6</code> <code>2F02B78FDB4648C708F564E76C4F9BBC</code> <code>1F66EC16DD0783DBB5893AB8E7639FB2</code> <code>ED66602A75412C406C02AE277EBFF101</code><br> <code>789D8F74</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 60 08 F9 0F F1 6E 67
0010 | 78 02 00 00 5C 07 E8 D0 43 85 36 A4 46 11 6D 9A
0020 | BE 31 4A E6 09 B5 9B 87 9C 8D E1 99 E1 0D 61 49
0030 | CD 27 6D 4D 32 8B 07 15 FE 50 02 00 F4 F4 0B 6F
0040 | 27 2D AF 3F B1 9D AE D5 44 EA BB F2 91 B5 2C C7
0050 | 45 90 D5 27 B8 3A 31 B7 D3 E3 BC 5C 3B 21 BC 29
0060 | 7F 6C 04 28 C7 1E 51 19 0F 0D 45 BC 4D 21 EE 3E
0070 | A6 DE 20 FF BC C5 4F 8E 3D A4 99 C4 FC C6 58 33
0080 | 23 32 4C 7B A3 7B 9E 10 F1 92 76 AA F6 F3 27 A2
0090 | 29 57 82 0C 49 19 8A FB 39 E4 04 81 B9 7D EA 85
00A0 | C5 55 00 C1 73 5D D5 60 D9 A0 6A 6B DB 6A 5E D4
00B0 | DC D1 B4 B1 08 46 A9 5A 7C 89 43 80 A5 FA A1 B5
00C0 | EA 42 84 56 71 1E E5 0A 82 26 16 68 DD 2E B8 C4
00D0 | 39 9C ED B7 C5 EF D1 33 07 9A AA 8D 6F 1B 54 3B
00E0 | A4 1F 62 E8 46 38 C7 F7 64 71 8D 66 37 22 0F E5
00F0 | 86 FD 9B 10 30 E2 3F 02 51 E8 50 E8 F6 95 33 AE
0100 | 2F 08 0F A0 BB FB EC FE 20 12 D5 CA 04 A3 42 68
0110 | 74 45 0B 1A 7F 37 1F A9 BD EC 5F CC 59 9E 0F 5A
0120 | 38 F0 E1 5C 43 B8 65 23 D2 1B 65 89 BE AB C7 B1
0130 | 7F E0 84 8A 9C CC 38 F5 22 4B 16 6B 43 1E 14 21
0140 | 65 0B 50 FE D2 4C 0A 21 75 F5 04 D8 9B E3 73 54
0150 | 8F 0B 2A E7 65 6B 69 10 C7 32 C4 AA BA 13 6C 70
0160 | 7B CC C3 C8 B9 C1 5C D5 7D C9 13 F5 64 D2 56 67
0170 | E6 20 09 88 F3 4B 5B A3 6D 8C 9E 95 38 4B A5 1E
0180 | 55 CA 92 7A 60 B8 2C F5 A9 8C E1 D5 45 AF B6 B6
0190 | 0A CC 51 71 8A 4D DA 2A E6 5D 0E A0 DC E4 C6 58
01A0 | 1C F0 2B 9E 4B 11 58 1D 6F C6 5B 8B 62 BB C4 FB
01B0 | C9 23 04 62 DF 13 1B F8 D0 86 7B A4 78 E5 7C 23
01C0 | 5E 3F 6C F5 54 AA CC 2C 57 11 A7 E2 9D 95 C5 30
01D0 | 80 98 7A 5A 5E 9D DB 1D 2B F7 EE 5D 0A CF B1 BD
01E0 | D3 6D 1B 89 61 6C F7 7C D3 A1 5E 73 A5 F4 4B 97
01F0 | 62 CC AF 77 FE D0 51 45 9C 94 84 09 2D 97 9D 04
0200 | 6D 92 50 EA 64 B1 F2 B4 F7 A0 E8 0C E4 36 40 A7
0210 | 8A C7 37 B3 EC 5C F5 35 98 9B 6B 79 77 86 90 73
0220 | 91 9E B0 3F 65 94 73 91 80 E0 E4 6B 68 7C 78 32
0230 | F7 6C 4A D8 03 B4 55 CD DC CA A9 23 C3 06 9D 5D
0240 | 38 18 27 BA 7D 04 EE 48 08 37 DB 7A D0 0F 78 BF
0250 | BE 29 6A E1 5F 1E F2 7A B6 A7 A5 47 6C B1 8F A8
0260 | CC 1B 5A B1 C3 07 55 96 65 0C 6B 91 D2 47 A0 D2
0270 | A1 AC 7A B1 99 67 8B F1 FA 75 E1 7C 14 00 75 00
0280 | 3C DB 27 4E 3E 2A EE AF A0 A0 A9 64</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>016008F90FF16E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78020000</code> (632 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200F4F40B6F272DAF3FB19DAED5</code> <code>44EABBF291B52CC74590D527B83A31B7</code> <code>D3E3BC5C3B21BC297F6C0428C71E5119</code> <code>0F0D45BC4D21EE3EA6DE20FFBCC54F8E</code> <code>3DA499C4FCC6583323324C7BA37B9E10</code> <code>F19276AAF6F327A22957820C49198AFB</code> <code>39E40481B97DEA85C55500C1735DD560</code> <code>D9A06A6BDB6A5ED4DCD1B4B10846A95A</code> <code>7C894380A5FAA1B5EA428456711EE50A</code> <code>82261668DD2EB8C4399CEDB7C5EFD133</code> <code>079AAA8D6F1B543BA41F62E84638C7F7</code> <code>64718D6637220FE586FD9B1030E23F02</code> <code>51E850E8F69533AE2F080FA0BBFBECFE</code> <code>2012D5CA04A3426874450B1A7F371FA9</code> <code>BDEC5FCC599E0F5A38F0E15C43B86523</code> <code>D21B6589BEABC7B17FE0848A9CCC38F5</code> <code>224B166B431E1421650B50FED24C0A21</code> <code>75F504D89BE373548F0B2AE7656B6910</code> <code>C732C4AABA136C707BCCC3C8B9C15CD5</code> <code>7DC913F564D25667E6200988F34B5BA3</code> <code>6D8C9E95384BA51E55CA927A60B82CF5</code> <code>A98CE1D545AFB6B60ACC51718A4DDA2A</code> <code>E65D0EA0DCE4C6581CF02B9E4B11581D</code> <code>6FC65B8B62BBC4FBC9230462DF131BF8</code> <code>D0867BA478E57C235E3F6CF554AACC2C</code> <code>5711A7E29D95C53080987A5A5E9DDB1D</code> <code>2BF7EE5D0ACFB1BDD36D1B89616CF77C</code> <code>D3A15E73A5F44B9762CCAF77FED05145</code> <code>9C9484092D979D046D9250EA64B1F2B4</code> <code>F7A0E80CE43640A78AC737B3EC5CF535</code> <code>989B6B7977869073919EB03F65947391</code> <code>80E0E46B687C7832F76C4AD803B455CD</code> <code>DCCAA923C3069D5D381827BA7D04EE48</code> <code>0837DB7AD00F78BFBE296AE15F1EF27A</code> <code>B6A7A5476CB18FA8CC1B5AB1C3075596</code> <code>650C6B91D247A0D2A1AC7AB199678BF1</code> <code>FA75E17C140075003CDB274E3E2AEEAF</code><br> <code>A0A0A964</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = F4F40B6F272DAF3FB19DAED544EABBF291B52CC74590D527B83A31B7D3E3BC5C3B21BC297F6C0428C71E51190F0D45BC4D21EE3EA6DE20FFBCC54F8E3DA499C4FCC6583323324C7BA37B9E10F19276AAF6F327A22957820C49198AFB39E40481B97DEA85C55500C1735DD560D9A06A6BDB6A5ED4DCD1B4B10846A95A7C894380A5FAA1B5EA428456711EE50A82261668DD2EB8C4399CEDB7C5EFD133079AAA8D6F1B543BA41F62E84638C7F764718D6637220FE586FD9B1030E23F0251E850E8F69533AE2F080FA0BBFBECFE2012D5CA04A3426874450B1A7F371FA9BDEC5FCC599E0F5A38F0E15C43B86523D21B6589BEABC7B17FE0848A9CCC38F5224B166B431E1421650B50FED24C0A2175F504D89BE373548F0B2AE7656B6910C732C4AABA136C707BCCC3C8B9C15CD57DC913F564D25667E6200988F34B5BA36D8C9E95384BA51E55CA927A60B82CF5A98CE1D545AFB6B60ACC51718A4DDA2AE65D0EA0DCE4C6581CF02B9E4B11581D6FC65B8B62BBC4FBC9230462DF131BF8D0867BA478E57C235E3F6CF554AACC2C5711A7E29D95C53080987A5A5E9DDB1D2BF7EE5D0ACFB1BDD36D1B89616CF77CD3A15E73A5F44B9762CCAF77FED051459C9484092D979D046D9250EA64B1F2B4F7A0E80CE43640A78AC737B3EC5CF535989B6B7977869073919EB03F6594739180E0E46B687C7832F76C4AD803B455CDDCCAA923C3069D5D381827BA7D04EE480837DB7AD00F78BFBE296AE15F1EF27AB6A7A5476CB18FA8CC1B5AB1C3075596650C6B91D247A0D2A1AC7AB199678BF1FA75E17C140075003CDB274E3E2AEEAFA0A0A964
tmp_aes_key = 2D64337A8E0900A131CB670AC2AA2B502D060BE90AA3B2747FB9C5DF1DD1CA8F
tmp_aes_iv = 643568DC0D9CDD0AC5FCB5BC3B5280855761845FA737EB98098C055B524E975F</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = A0A75F47FFD1134FFE5B1DD28C414A7CB53F420ABA0D89B5438536A446116D9ABE314AE609B59B879C8DE199E10D6149CD276D4D328B071503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003BB6E4D8A6875F3F95344D929F2E3ACF116B60DFAAA7B35BF95C8ED40B517D941C14B9AD1274384D91C00950E5301C89793B39B59FD56C54C83B6D5F7DD053B68E519FE870F8B7544754BB1F5D4A964B345613471B9142AE5A7D4F9A758A484307EC1E9CA2E5521E657B75A8596F2FF000B896EC770FE5317748BCC1243BC14CBB799A184903A0D4CFDDF92F549518E9583E8CD3401FEC16DFB2FF0FCFD9A66DBD4B59D0AEA1C98DB7EECF347E2FC67AB443029F1EEF51F835E18F0A4CDF1EBF6A3AF2BDA2ED0E89C67E373EFCC8BA3953FD681BF5B80CC7B54DA9D6D4C6C47A4F5A6C8AFFF5F6D074FB625157F4FA902C4CD339F8651C015E16C171ED11E34C0FF16E679906D89F7267DE9B
answer = BA0D89B5438536A446116D9ABE314AE609B59B879C8DE199E10D6149CD276D4D328B071503000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE0001003BB6E4D8A6875F3F95344D929F2E3ACF116B60DFAAA7B35BF95C8ED40B517D941C14B9AD1274384D91C00950E5301C89793B39B59FD56C54C83B6D5F7DD053B68E519FE870F8B7544754BB1F5D4A964B345613471B9142AE5A7D4F9A758A484307EC1E9CA2E5521E657B75A8596F2FF000B896EC770FE5317748BCC1243BC14CBB799A184903A0D4CFDDF92F549518E9583E8CD3401FEC16DFB2FF0FCFD9A66DBD4B59D0AEA1C98DB7EECF347E2FC67AB443029F1EEF51F835E18F0A4CDF1EBF6A3AF2BDA2ED0E89C67E373EFCC8BA3953FD681BF5B80CC7B54DA9D6D4C6C47A4F5A6C8AFFF5F6D074FB625157F4FA902C4CD339F8651C015E16C171ED11E34C0FF16E679906D89F7267DE9B</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 43 85 36 A4 46 11 6D 9A BE 31 4A E6
0010 | 09 B5 9B 87 9C 8D E1 99 E1 0D 61 49 CD 27 6D 4D
0020 | 32 8B 07 15 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | 3B B6 E4 D8 A6 87 5F 3F 95 34 4D 92 9F 2E 3A CF
0140 | 11 6B 60 DF AA A7 B3 5B F9 5C 8E D4 0B 51 7D 94
0150 | 1C 14 B9 AD 12 74 38 4D 91 C0 09 50 E5 30 1C 89
0160 | 79 3B 39 B5 9F D5 6C 54 C8 3B 6D 5F 7D D0 53 B6
0170 | 8E 51 9F E8 70 F8 B7 54 47 54 BB 1F 5D 4A 96 4B
0180 | 34 56 13 47 1B 91 42 AE 5A 7D 4F 9A 75 8A 48 43
0190 | 07 EC 1E 9C A2 E5 52 1E 65 7B 75 A8 59 6F 2F F0
01A0 | 00 B8 96 EC 77 0F E5 31 77 48 BC C1 24 3B C1 4C
01B0 | BB 79 9A 18 49 03 A0 D4 CF DD F9 2F 54 95 18 E9
01C0 | 58 3E 8C D3 40 1F EC 16 DF B2 FF 0F CF D9 A6 6D
01D0 | BD 4B 59 D0 AE A1 C9 8D B7 EE CF 34 7E 2F C6 7A
01E0 | B4 43 02 9F 1E EF 51 F8 35 E1 8F 0A 4C DF 1E BF
01F0 | 6A 3A F2 BD A2 ED 0E 89 C6 7E 37 3E FC C8 BA 39
0200 | 53 FD 68 1B F5 B8 0C C7 B5 4D A9 D6 D4 C6 C4 7A
0210 | 4F 5A 6C 8A FF F5 F6 D0 74 FB 62 51 57 F4 FA 90
0220 | 2C 4C D3 39 F8 65 1C 01 5E 16 C1 71 ED 11 E3 4C
0230 | 0F F1 6E 67</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE0001003BB6E4D8A6875F3F95344D92</code> <code>9F2E3ACF116B60DFAAA7B35BF95C8ED4</code> <code>0B517D941C14B9AD1274384D91C00950</code> <code>E5301C89793B39B59FD56C54C83B6D5F</code> <code>7DD053B68E519FE870F8B7544754BB1F</code> <code>5D4A964B345613471B9142AE5A7D4F9A</code> <code>758A484307EC1E9CA2E5521E657B75A8</code> <code>596F2FF000B896EC770FE5317748BCC1</code> <code>243BC14CBB799A184903A0D4CFDDF92F</code> <code>549518E9583E8CD3401FEC16DFB2FF0F</code> <code>CFD9A66DBD4B59D0AEA1C98DB7EECF34</code> <code>7E2FC67AB443029F1EEF51F835E18F0A</code> <code>4CDF1EBF6A3AF2BDA2ED0E89C67E373E</code> <code>FCC8BA3953FD681BF5B80CC7B54DA9D6</code> <code>D4C6C47A4F5A6C8AFFF5F6D074FB6251</code> <code>57F4FA902C4CD339F8651C015E16C171</code><br> <code>ED11E34C</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>0FF16E67</code> (1735323919 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 696D4E6B197E0AF845A7210E05C36C8145A500CA6E3C5681186FBF857C67A9507EE2F85D43D18AB508FE3ED1E219F95DB26E19A5C749DB4E63D721B966E34CE0A2D1B5DF820343F880AC386DE92D984E4152E8AE749D267F740D91E5EF05B38A9036B3CC51F6C055C5448848A6ABBC6BF8B3444A71FE8A2CEAE93CCD7313893675195BB5BF3441B78A342832E2CF56685F03072D23D24728B2A1A4A8ABA1B197CE7A7596B57A5B439024025CE93D141E60BA22D2C5778837505F3AB034B9048F264E05B491BF2B3175E56B03DBB74ED548C61084D23B08FFB209D00EC669D03025B9980A367869C57790C10ED82FE771C68D3D1C47DB9B82F9EBF42D6084441D</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 7B11812FD3A62C9F816A9BF01A5D04DFFA64AC635ECC357EC0993FCE5A3245C36021B370374AA413EC60148891E0F4951235ECBB2BA0945205337DE23F158C3EDD6AFA36CC40820E008D1BD72AC4780C38E4452DA8CED4336D0082BF55622FCACD71B28213CB3B28FCE6116180EE3D09812B3987D02749068DB0704D7D0F02048B039431C3107D18A0F5E22C26F4808B75787110745B0597B601330AFA9F854C31F5DB1FA6C85A182039CD250E8277207F18816011DA78ED0843ABDEF7295EA3C536C1C7AA6DAB99534C3C0BC31BA42EAAE6FF66ED39224A085089F94AF84F94337645E2A4E428BF70952960DB8B2BFF49336B8E462670516AF5B123B8263020</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 43 85 36 A4 46 11 6D 9A BE 31 4A E6
0010 | 09 B5 9B 87 9C 8D E1 99 E1 0D 61 49 CD 27 6D 4D
0020 | 32 8B 07 15 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 7B 11 81 2F D3 A6 2C 9F 81 6A 9B F0 1A 5D 04 DF
0040 | FA 64 AC 63 5E CC 35 7E C0 99 3F CE 5A 32 45 C3
0050 | 60 21 B3 70 37 4A A4 13 EC 60 14 88 91 E0 F4 95
0060 | 12 35 EC BB 2B A0 94 52 05 33 7D E2 3F 15 8C 3E
0070 | DD 6A FA 36 CC 40 82 0E 00 8D 1B D7 2A C4 78 0C
0080 | 38 E4 45 2D A8 CE D4 33 6D 00 82 BF 55 62 2F CA
0090 | CD 71 B2 82 13 CB 3B 28 FC E6 11 61 80 EE 3D 09
00A0 | 81 2B 39 87 D0 27 49 06 8D B0 70 4D 7D 0F 02 04
00B0 | 8B 03 94 31 C3 10 7D 18 A0 F5 E2 2C 26 F4 80 8B
00C0 | 75 78 71 10 74 5B 05 97 B6 01 33 0A FA 9F 85 4C
00D0 | 31 F5 DB 1F A6 C8 5A 18 20 39 CD 25 0E 82 77 20
00E0 | 7F 18 81 60 11 DA 78 ED 08 43 AB DE F7 29 5E A3
00F0 | C5 36 C1 C7 AA 6D AB 99 53 4C 3C 0B C3 1B A4 2E
0100 | AA E6 FF 66 ED 39 22 4A 08 50 89 F9 4A F8 4F 94
0110 | 33 76 45 E2 A4 E4 28 BF 70 95 29 60 DB 8B 2B FF
0120 | 49 33 6B 8E 46 26 70 51 6A F5 B1 23 B8 26 30 20</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001007B11812FD3A62C9F816A9BF0</code> <code>1A5D04DFFA64AC635ECC357EC0993FCE</code> <code>5A3245C36021B370374AA413EC601488</code> <code>91E0F4951235ECBB2BA0945205337DE2</code> <code>3F158C3EDD6AFA36CC40820E008D1BD7</code> <code>2AC4780C38E4452DA8CED4336D0082BF</code> <code>55622FCACD71B28213CB3B28FCE61161</code> <code>80EE3D09812B3987D02749068DB0704D</code> <code>7D0F02048B039431C3107D18A0F5E22C</code> <code>26F4808B75787110745B0597B601330A</code> <code>FA9F854C31F5DB1FA6C85A182039CD25</code> <code>0E8277207F18816011DA78ED0843ABDE</code> <code>F7295EA3C536C1C7AA6DAB99534C3C0B</code> <code>C31BA42EAAE6FF66ED39224A085089F9</code> <code>4AF84F94337645E2A4E428BF70952960</code> <code>DB8B2BFF49336B8E462670516AF5B123</code><br> <code>B8263020</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B64366438536A446116D9ABE314AE609B59B879C8DE199E10D6149CD276D4D328B07150000000000000000FE0001007B11812FD3A62C9F816A9BF01A5D04DFFA64AC635ECC357EC0993FCE5A3245C36021B370374AA413EC60148891E0F4951235ECBB2BA0945205337DE23F158C3EDD6AFA36CC40820E008D1BD72AC4780C38E4452DA8CED4336D0082BF55622FCACD71B28213CB3B28FCE6116180EE3D09812B3987D02749068DB0704D7D0F02048B039431C3107D18A0F5E22C26F4808B75787110745B0597B601330AFA9F854C31F5DB1FA6C85A182039CD250E8277207F18816011DA78ED0843ABDEF7295EA3C536C1C7AA6DAB99534C3C0BC31BA42EAAE6FF66ED39224A085089F94AF84F94337645E2A4E428BF70952960DB8B2BFF49336B8E462670516AF5B123B8263020
padding = E47FEEE4007C2BA27D0F4C4B
tmp_aes_key = 2D64337A8E0900A131CB670AC2AA2B502D060BE90AA3B2747FB9C5DF1DD1CA8F
tmp_aes_iv = 643568DC0D9CDD0AC5FCB5BC3B5280855761845FA737EB98098C055B524E975F</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = EE1B8B87C1A0660A514C1BC1633D72853FD0A23894FFDD5897DD81C0A9AD74CA45FB07F3DD7315F680EB92604497E314FAEC0394892B34A24394673A4B5E0739CD0E6AD610A7C24AE34C799683ACBB651AB6CB467B98EFD7679405DDBA9AC9D4A0FC9C9E437632A7A24276937A46524DE0FB1DAF38EDE268F0F833F63AF783653B9CE6E2C7BE893F3B4623AB4C9DA81C16CD6842980C63F2BBAA38FEA5938F1EA214EB61112C5438C15E497B55F5561355A5242827400FE7F056AFB088159B0BCA3676B3AD2E581319D9B6135B9DDD3C206C0AAC90E71B3FB13360B09621D7E4B155E0AAFFF19E5F89A54B195A199E5E5ACC777FD9BFEB43F31C3105F533E1D2DB40F991D4D225C290208894BCFE62B39608C115A0D2DB04311A949529DAF561357D4583597E24616F20871CF05F0B0F6327ED162E0709E531EE45CD5A1449BE375A28D9D8AF6901A783C8A3B74AE197</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 F0 DE 06 00 0F F1 6E 67
0010 | 78 01 00 00 1F 5F 04 F5 43 85 36 A4 46 11 6D 9A
0020 | BE 31 4A E6 09 B5 9B 87 9C 8D E1 99 E1 0D 61 49
0030 | CD 27 6D 4D 32 8B 07 15 FE 50 01 00 EE 1B 8B 87
0040 | C1 A0 66 0A 51 4C 1B C1 63 3D 72 85 3F D0 A2 38
0050 | 94 FF DD 58 97 DD 81 C0 A9 AD 74 CA 45 FB 07 F3
0060 | DD 73 15 F6 80 EB 92 60 44 97 E3 14 FA EC 03 94
0070 | 89 2B 34 A2 43 94 67 3A 4B 5E 07 39 CD 0E 6A D6
0080 | 10 A7 C2 4A E3 4C 79 96 83 AC BB 65 1A B6 CB 46
0090 | 7B 98 EF D7 67 94 05 DD BA 9A C9 D4 A0 FC 9C 9E
00A0 | 43 76 32 A7 A2 42 76 93 7A 46 52 4D E0 FB 1D AF
00B0 | 38 ED E2 68 F0 F8 33 F6 3A F7 83 65 3B 9C E6 E2
00C0 | C7 BE 89 3F 3B 46 23 AB 4C 9D A8 1C 16 CD 68 42
00D0 | 98 0C 63 F2 BB AA 38 FE A5 93 8F 1E A2 14 EB 61
00E0 | 11 2C 54 38 C1 5E 49 7B 55 F5 56 13 55 A5 24 28
00F0 | 27 40 0F E7 F0 56 AF B0 88 15 9B 0B CA 36 76 B3
0100 | AD 2E 58 13 19 D9 B6 13 5B 9D DD 3C 20 6C 0A AC
0110 | 90 E7 1B 3F B1 33 60 B0 96 21 D7 E4 B1 55 E0 AA
0120 | FF F1 9E 5F 89 A5 4B 19 5A 19 9E 5E 5A CC 77 7F
0130 | D9 BF EB 43 F3 1C 31 05 F5 33 E1 D2 DB 40 F9 91
0140 | D4 D2 25 C2 90 20 88 94 BC FE 62 B3 96 08 C1 15
0150 | A0 D2 DB 04 31 1A 94 95 29 DA F5 61 35 7D 45 83
0160 | 59 7E 24 61 6F 20 87 1C F0 5F 0B 0F 63 27 ED 16
0170 | 2E 07 09 E5 31 EE 45 CD 5A 14 49 BE 37 5A 28 D9
0180 | D8 AF 69 01 A7 83 C8 A3 B7 4A E1 97</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>F0DE06000FF16E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100EE1B8B87C1A0660A514C1BC1</code> <code>633D72853FD0A23894FFDD5897DD81C0</code> <code>A9AD74CA45FB07F3DD7315F680EB9260</code> <code>4497E314FAEC0394892B34A24394673A</code> <code>4B5E0739CD0E6AD610A7C24AE34C7996</code> <code>83ACBB651AB6CB467B98EFD7679405DD</code> <code>BA9AC9D4A0FC9C9E437632A7A2427693</code> <code>7A46524DE0FB1DAF38EDE268F0F833F6</code> <code>3AF783653B9CE6E2C7BE893F3B4623AB</code> <code>4C9DA81C16CD6842980C63F2BBAA38FE</code> <code>A5938F1EA214EB61112C5438C15E497B</code> <code>55F5561355A5242827400FE7F056AFB0</code> <code>88159B0BCA3676B3AD2E581319D9B613</code> <code>5B9DDD3C206C0AAC90E71B3FB13360B0</code> <code>9621D7E4B155E0AAFFF19E5F89A54B19</code> <code>5A199E5E5ACC777FD9BFEB43F31C3105</code> <code>F533E1D2DB40F991D4D225C290208894</code> <code>BCFE62B39608C115A0D2DB04311A9495</code> <code>29DAF561357D4583597E24616F20871C</code> <code>F05F0B0F6327ED162E0709E531EE45CD</code> <code>5A1449BE375A28D9D8AF6901A783C8A3</code><br> <code>B74AE197</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 8A233EEE8E5F990EA623B5B8A6F7FB16FEBD493BEA294F696CA2B1F77E776DCD0E4320DEEC4A4CC2FFF6EDAE7400C82AB3A37903281B6BA29D23A9E11252C2F62E2261B42614170527D5F0223F6C73F5CD0CEF251849E4C1A584C791377F4B1590938A1FD26F2ED3F6843CCB9A46BF08B92E375B44E37BC7532D366BFB27F8891851D007E2568B75685113437AE84DA36996BCC8A7D50FBA7F805CD41E3FCFB81140010DFA575A2E9789B82FF83D2409C69D0C3B41CB5744DFE28672205E48BA42B3B83420E22CE7BC1AF8212D44AFB0BC9241850DDFB297036EDF30C3271D8A606A31610E9D4A54CF0ADF0711183DDC22711837C1FAD6DDA575CA9F0C4BFF26</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 64 6B E7 10 F1 6E 67
0010 | 34 00 00 00 34 F7 CB 3B 43 85 36 A4 46 11 6D 9A
0020 | BE 31 4A E6 09 B5 9B 87 9C 8D E1 99 E1 0D 61 49
0030 | CD 27 6D 4D 32 8B 07 15 4E 58 DA 8D 78 2D FA 61
0040 | 67 D8 9B 96 02 C0 59 CB</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01646BE710F16E67</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>34000000</code> (52 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>438536A446116D9ABE314AE609B59B87</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>9C8DE199E10D6149CD276D4D328B0715</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>4E58DA8D782DFA6167D89B9602C059CB</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/moderation">Moderation</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

