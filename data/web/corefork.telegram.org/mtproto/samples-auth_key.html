<!DOCTYPE html>
<html class="">
  <head>
    <meta charset="utf-8">
    <title>Auth key generation example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="description" content="A full auth key generation example">
    <meta property="og:title" content="Auth key generation example">
    <meta property="og:image" content="71a15765997de28d38">
    <meta property="og:description" content="A full auth key generation example">
    <link rel="icon" type="image/svg+xml" href="/img/website_icon.svg?4">
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="alternate icon" href="/img/favicon.ico" type="image/x-icon" />
    <link href="/css/bootstrap.min.css?3" rel="stylesheet">
    
    <link href="/css/telegram.css?240" rel="stylesheet" media="screen">
    <style>
    </style>
  </head>
  <body class="preload">
    <div class="dev_page_wrap">
      <div class="dev_page_head navbar navbar-static-top navbar-tg">
        <div class="navbar-inner">
          <div class="container clearfix">
            <ul class="nav navbar-nav navbar-right hidden-xs"><li class="navbar-twitter"><a href="https://twitter.com/telegram" target="_blank" data-track="Follow/Twitter" onclick="trackDlClick(this, event)"><i class="icon icon-twitter"></i><span> Twitter</span></a></li></ul>
            <ul class="nav navbar-nav">
              <li><a href="//telegram.org/">Home</a></li>
<li class="hidden-xs"><a href="//telegram.org/faq">FAQ</a></li>
<li class="hidden-xs"><a href="//telegram.org/apps">Apps</a></li>
<li class=""><a href="/api">API</a></li>
<li class="active"><a href="/mtproto">Protocol</a></li>
<li class=""><a href="/schema">Schema</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container clearfix">
        <div class="dev_page">
          <div id="dev_page_content_wrap" class=" ">
  <div class="dev_page_bread_crumbs"><ul class="breadcrumb clearfix"><li><a  href="/mtproto" >Mobile Protocol</a></li><i class="icon icon-breadcrumb-divider"></i><li><a  href="/mtproto/samples-auth_key" >Auth key generation example</a></li></ul></div>
  <h1 id="dev_page_title">Auth key generation example</h1>
  
  <div id="dev_page_content"><!-- scroll_nav -->

<p>In the examples below, the <a href="/mtproto#transport">transport</a> headers are omitted:</p>
<blockquote>
<p>For example, for the <a href="/mtproto/mtproto-transports#abridged">abridged version of the transport »</a>, the client sends <code>0xef</code> as the first byte (<strong>important:</strong> only prior to the very first data packet), then the packet length is encoded with a single byte (<code>0x01-0x7e</code> = data length divided by 4; or <code>0x7f</code> followed by 3 bytes (little endian) divided by 4) followed by the data itself. In this case, server responses have the same structure (although the server does not send <code>0xef</code>as the first byte).</p>
</blockquote>
<p>Detailed documentation on creating authorization keys is available <a href="/mtproto/auth_key">here »</a>.</p>
<h4><a class="anchor" href="#dh-exchange-initiation" id="dh-exchange-initiation" name="dh-exchange-initiation"><i class="anchor-icon"></i></a>DH exchange initiation</h4>
<h5><a class="anchor" href="#1-client-sends-query-to-server" id="1-client-sends-query-to-server" name="1-client-sends-query-to-server"><i class="anchor-icon"></i></a>1) Client sends query to server</h5>
<!-- start req_pq_multi -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 44 6B 0C 00 FF 41 AE 66
0010 | 14 00 00 00 F1 8E 7E BE 7B F4 DA A0 1D 3E D2 26
0020 | DE F7 1A 76 39 5F D6 6D</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_pq_multi#be7e8ef1 nonce:int128 = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>446B0C00FF41AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>14000000</code> (20 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_pq_multi)</td>
<td>20, 4</td>
<td><code>f18e7ebe</code></td>
<td><em>req_pq_multi</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Random number</td>
</tr>
</tbody>
</table>
<!-- end req_pq_multi -->
<h5><a class="anchor" href="#2-server-sends-response-of-the-form" id="2-server-sends-response-of-the-form" name="2-server-sends-response-of-the-form"><i class="anchor-icon"></i></a>2) Server sends response of the form</h5>
<!-- start resPQ -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 68 B3 8E FF 41 AE 66
0010 | 68 00 00 00 63 24 16 05 7B F4 DA A0 1D 3E D2 26
0020 | DE F7 1A 76 39 5F D6 6D EA E3 5E 07 58 C0 E4 8B
0030 | B2 BF EF CE 74 A6 78 EB 08 1A 36 A4 50 4C 89 83
0040 | 7D 00 00 00 15 C4 B5 1C 03 00 00 00 A5 B7 F7 09
0050 | 35 5F C3 0B 21 6B E8 6C 02 2B B4 C3 85 FD 64 DE
0060 | 85 1D 9D D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>resPQ#05162463 nonce:int128 server_nonce:int128 pq:string server_public_key_fingerprints:Vector&lt;strlong&gt; = ResPQ;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>0168B38EFF41AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>68000000</code> (104 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(resPQ)</td>
<td>20, 4</td>
<td><code>63241605</code></td>
<td><em>resPQ</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Server-generated random number</td>
</tr>
<tr>
<td>pq</td>
<td>56, 12</td>
<td><code>081A36A4504C89837D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1888877758516921213</td>
<td>Single-byte prefix denoting length, an 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>%(Vector strlong)</td>
<td>68, 4</td>
<td><code>15c4b51c</code></td>
<td><em>Vector t</em> constructor number from TL schema</td>
</tr>
<tr>
<td>count</td>
<td>72, 4</td>
<td><code>03000000</code></td>
<td>Number of elements in server_public_key_fingerprints</td>
</tr>
<tr>
<td>server_public_key_fingerprints[0]</td>
<td>76, 8</td>
<td><code>A5B7F709355FC30B</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[1]</td>
<td>84, 8</td>
<td><code>216BE86C022BB4C3</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
<tr>
<td>server_public_key_fingerprints[2]</td>
<td>92, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td>64 lower-order bits of <code>SHA1(server_public_key)</code></td>
</tr>
</tbody>
</table>
<!-- end resPQ -->
<p>In our case, the client only has the following public keys, with the following fingerprints:</p>
<!-- start fingerprints -->
<ul>
<li><code>85FD64DE851D9DD0</code></li>
</ul>
<p>Let's choose the only matching key, the one with fingerprint equal to <code>85FD64DE851D9DD0</code>.</p>
<!-- end fingerprints -->
<h4><a class="anchor" href="#proof-of-work" id="proof-of-work" name="proof-of-work"><i class="anchor-icon"></i></a>Proof of work</h4>
<h5><a class="anchor" href="#3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" id="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q" name="3-client-decomposes-pq-into-prime-factors-such-that-p-lt-q"><i class="anchor-icon"></i></a>3) Client decomposes pq into prime factors such that p &lt; q.</h5>
<!-- start pq -->
<pre><code>pq = 1888877758516921213</code></pre>
<p>Decompose into 2 prime cofactors <code>p &lt; q</code>: <code>1888877758516921213 = 1165801213 * 1620240001</code></p>
<pre><code>p = 1165801213
q = 1620240001</code></pre>
<!-- end pq -->
<h4><a class="anchor" href="#presenting-proof-of-work-server-authentication" id="presenting-proof-of-work-server-authentication" name="presenting-proof-of-work-server-authentication"><i class="anchor-icon"></i></a>Presenting proof of work; Server authentication</h4>
<h5><a class="anchor" href="#4-encrypted-data-payload-generation" id="4-encrypted-data-payload-generation" name="4-encrypted-data-payload-generation"><i class="anchor-icon"></i></a>4) <code>encrypted_data</code> payload generation</h5>
<p>First of all, generate an <code>encrypted_data</code> payload as follows:</p>
<!-- start p_q_inner_data_dc -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 95 5F F5 A9 08 1A 36 A4 50 4C 89 83 7D 00 00 00
0010 | 04 45 7C B6 FD 00 00 00 04 60 92 E6 81 00 00 00
0020 | 7B F4 DA A0 1D 3E D2 26 DE F7 1A 76 39 5F D6 6D
0030 | EA E3 5E 07 58 C0 E4 8B B2 BF EF CE 74 A6 78 EB
0040 | 46 29 AA 8D 04 78 07 B2 7C 76 56 50 63 22 3F A8
0050 | 14 50 FC 55 96 00 B6 65 41 19 24 37 6F 86 EB 37
0060 | 02 00 00 00</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>p_q_inner_data_dc#a9f55f95 pq:string p:string q:string nonce:int128 server_nonce:int128 new_nonce:int256 dc:int = P_Q_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(p_q_inner_data_dc)</td>
<td>0, 4</td>
<td><code>955ff5a9</code></td>
<td><em>p_q_inner_data_dc</em> constructor number from TL schema</td>
</tr>
<tr>
<td>pq</td>
<td>4, 12</td>
<td><code>081A36A4504C89837D000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1888877758516921213</td>
<td>Single-byte prefix denoting length, 8-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>p</td>
<td>16, 8</td>
<td><code>04457CB6FD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1165801213</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>24, 8</td>
<td><code>046092E681000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1620240001</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>nonce</td>
<td>32, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>48, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce</td>
<td>64, 32</td>
<td><code>4629AA8D047807B27C76565063223FA8</code> <code>1450FC559600B665411924376F86EB37</code></td>
<td>Client-generated random number</td>
</tr>
<tr>
<td>dc</td>
<td>96, 4</td>
<td><code>02000000</code> (2 in decimal)</td>
<td>DC ID: <code>10000</code> (decimal) has to be added to the DC ID to connect to the test servers; it has to be made negative if the DC we're connecting to is a media (not CDN) DC.</td>
</tr>
</tbody>
</table>
<!-- end p_q_inner_data_dc -->
<p>The serialization of <em>P_Q_inner_data</em> produces <strong>data</strong>, which is used to generate <strong>encrypted_data</strong> as specified in <a href="/mtproto/auth_key">step 4.1</a>.<br>
These are the inputs to the algorithm specified in <a href="/mtproto/auth_key">step 4.1</a>:</p>
<!-- start p_q_inner_data_input -->
<pre><code>data = 955FF5A9081A36A4504C89837D00000004457CB6FD000000046092E6810000007BF4DAA01D3ED226DEF71A76395FD66DEAE35E0758C0E48BB2BFEFCE74A678EB4629AA8D047807B27C76565063223FA81450FC559600B665411924376F86EB3702000000
random_padding_bytes = 205B6E525EE93A7E9C311A9D868F778C32B40AA8E64095A7F0B54830A6035F763EE809F35D392E335A6B4BC58687C54904343D3DD331E55F5B6C3EF456C6D56CD34DE215ED190D154C826D0E104932AAF3E8F0A0B486922A2004CC1F</code></pre>
<!-- end p_q_inner_data_input -->
<p>And this is the output:</p>
<!-- start p_q_inner_data_output -->
<pre><code>encrypted_data = D95C66C9C9E3CB75836867AD85D761D8E0DA2F3A87E3675EA5F9B407F8EC484894A3E994151A2B07B6AA7568CC4587F99612764A6C3138228595A98D565657844EF00891FA9E59E3DB8319A146D29D1482DB0A8F22B49A3748AB7C8B35CD50010AF69DFAE28B8BE36395A32267C2A68C4D6F54D701CCA14149B102F7D226692E35B187BCD45987B0AC0A2B3784B223E5B122A9810BE0EFEFB483E5FD098EC8E7D4C0555D4D36742F0670CD2FD7B2E4D7C6CCAA3348EFC80BC5BF9B79B4B3482A8D664ECEDEC606F9BC67C36EEBD045F5E8E4A8AED657D48D6FD33021A5E91CD7CF22811AFD040959873B2EE4F29E9F8123729F6C9B694C47DA1F2EB581B112D5</code></pre>
<!-- end p_q_inner_data_output -->
<p>The length of the final string is 256 bytes.</p>
<h5><a class="anchor" href="#5-send-req-dh-params-query-with-generated-encrypted-data" id="5-send-req-dh-params-query-with-generated-encrypted-data" name="5-send-req-dh-params-query-with-generated-encrypted-data"><i class="anchor-icon"></i></a>5) Send req_DH_params query with generated <code>encrypted_data</code></h5>
<!-- start req_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 48 6B 0C 00 FF 41 AE 66
0010 | 40 01 00 00 BE E4 12 D7 7B F4 DA A0 1D 3E D2 26
0020 | DE F7 1A 76 39 5F D6 6D EA E3 5E 07 58 C0 E4 8B
0030 | B2 BF EF CE 74 A6 78 EB 04 45 7C B6 FD 00 00 00
0040 | 04 60 92 E6 81 00 00 00 85 FD 64 DE 85 1D 9D D0
0050 | FE 00 01 00 D9 5C 66 C9 C9 E3 CB 75 83 68 67 AD
0060 | 85 D7 61 D8 E0 DA 2F 3A 87 E3 67 5E A5 F9 B4 07
0070 | F8 EC 48 48 94 A3 E9 94 15 1A 2B 07 B6 AA 75 68
0080 | CC 45 87 F9 96 12 76 4A 6C 31 38 22 85 95 A9 8D
0090 | 56 56 57 84 4E F0 08 91 FA 9E 59 E3 DB 83 19 A1
00A0 | 46 D2 9D 14 82 DB 0A 8F 22 B4 9A 37 48 AB 7C 8B
00B0 | 35 CD 50 01 0A F6 9D FA E2 8B 8B E3 63 95 A3 22
00C0 | 67 C2 A6 8C 4D 6F 54 D7 01 CC A1 41 49 B1 02 F7
00D0 | D2 26 69 2E 35 B1 87 BC D4 59 87 B0 AC 0A 2B 37
00E0 | 84 B2 23 E5 B1 22 A9 81 0B E0 EF EF B4 83 E5 FD
00F0 | 09 8E C8 E7 D4 C0 55 5D 4D 36 74 2F 06 70 CD 2F
0100 | D7 B2 E4 D7 C6 CC AA 33 48 EF C8 0B C5 BF 9B 79
0110 | B4 B3 48 2A 8D 66 4E CE DE C6 06 F9 BC 67 C3 6E
0120 | EB D0 45 F5 E8 E4 A8 AE D6 57 D4 8D 6F D3 30 21
0130 | A5 E9 1C D7 CF 22 81 1A FD 04 09 59 87 3B 2E E4
0140 | F2 9E 9F 81 23 72 9F 6C 9B 69 4C 47 DA 1F 2E B5
0150 | 81 B1 12 D5</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>req_DH_params#d712e4be nonce:int128 server_nonce:int128 p:string q:string public_key_fingerprint:long encrypted_data:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>486B0C00FF41AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>40010000</code> (320 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(req_DH_params)</td>
<td>20, 4</td>
<td><code>bee412d7</code></td>
<td><em>req_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>p</td>
<td>56, 8</td>
<td><code>04457CB6FD000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1165801213</td>
<td>First prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>q</td>
<td>64, 8</td>
<td><code>046092E681000000</code><br>TL byte deserialization <br>=&gt; bigendian conversion to decimal<br>=&gt; 1620240001</td>
<td>Second prime cofactor: single-byte prefix denoting length, 4-byte string, and three bytes of padding</td>
</tr>
<tr>
<td>public_key_fingerprint</td>
<td>72, 8</td>
<td><code>85FD64DE851D9DD0</code></td>
<td><code>fingerprint</code> of public key used</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>80, 260</td>
<td><code>FE000100D95C66C9C9E3CB75836867AD</code> <code>85D761D8E0DA2F3A87E3675EA5F9B407</code> <code>F8EC484894A3E994151A2B07B6AA7568</code> <code>CC4587F99612764A6C3138228595A98D</code> <code>565657844EF00891FA9E59E3DB8319A1</code> <code>46D29D1482DB0A8F22B49A3748AB7C8B</code> <code>35CD50010AF69DFAE28B8BE36395A322</code> <code>67C2A68C4D6F54D701CCA14149B102F7</code> <code>D226692E35B187BCD45987B0AC0A2B37</code> <code>84B223E5B122A9810BE0EFEFB483E5FD</code> <code>098EC8E7D4C0555D4D36742F0670CD2F</code> <code>D7B2E4D7C6CCAA3348EFC80BC5BF9B79</code> <code>B4B3482A8D664ECEDEC606F9BC67C36E</code> <code>EBD045F5E8E4A8AED657D48D6FD33021</code> <code>A5E91CD7CF22811AFD040959873B2EE4</code> <code>F29E9F8123729F6C9B694C47DA1F2EB5</code><br> <code>81B112D5</code></td>
<td>Value generated above</td>
</tr>
</tbody>
</table>
<!-- end req_DH_params -->
<h5><a class="anchor" href="#6-server-responds-with" id="6-server-responds-with" name="6-server-responds-with"><i class="anchor-icon"></i></a>6) Server responds with:</h5>
<!-- start server_DH_params_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 0C EB 37 00 42 AE 66
0010 | F0 02 00 00 5C 07 E8 D0 7B F4 DA A0 1D 3E D2 26
0020 | DE F7 1A 76 39 5F D6 6D EA E3 5E 07 58 C0 E4 8B
0030 | B2 BF EF CE 74 A6 78 EB FE 50 02 00 C4 9D 66 B7
0040 | 8E 6C D0 36 80 F1 64 C8 F0 F4 50 EE 75 12 7A 70
0050 | 94 98 DE E8 3C 3A B5 61 A9 8B 89 15 BF 2A F0 48
0060 | 83 6A 84 E3 6B 8A BD 20 E0 9A 52 FC E6 4F 14 38
0070 | D3 01 6E F3 53 A9 61 E9 B6 58 70 E0 EC DF 99 BC
0080 | DB D5 45 F2 5A A2 19 60 20 B9 C6 56 77 AC 09 F3
0090 | 86 35 68 F4 A2 1B C5 FD CB 7A 77 34 46 1E 78 E6
00A0 | 8F B3 63 67 25 D5 27 DC 58 54 F9 77 E7 51 12 6B
00B0 | EE 81 45 39 C1 EA BB A8 E8 0B F4 6C A6 70 CF 9F
00C0 | 79 4C D2 3B 14 A0 07 FD F4 2D 9E 68 8F 10 30 B5
00D0 | 2D E2 23 ED 0F 86 80 4F 20 57 41 F6 EA AD 88 8E
00E0 | 2A 10 90 67 1E 57 A6 C3 68 FE 9B 54 A5 D8 0B 2B
00F0 | 01 2B 0E 7A 78 EF CA 9D 6A D7 B8 61 59 26 20 FC
0100 | 33 CB 8D B4 B4 78 1A 62 42 EB E5 0A C2 C6 FB 54
0110 | 8D F8 D6 1E 00 AF A3 11 22 67 FB FF E2 E4 DC 64
0120 | E6 06 1D 34 45 53 B3 E9 FC 62 D5 6D BF 31 63 E0
0130 | B3 84 3E 91 65 E8 73 C6 AC 90 44 B9 B9 CD D3 6D
0140 | 7B 7C 8F 18 F7 E6 05 06 9B ED 87 2F FE CC 02 3C
0150 | FD 56 E3 E9 BA DC AE 0E 49 10 41 BA 81 3D 94 62
0160 | 16 94 1C 0C F0 8A DC 73 EA F6 85 49 21 4F D1 74
0170 | 92 89 B2 A0 71 53 22 8F C4 D7 DC 79 1B 57 F6 E3
0180 | 44 77 51 13 83 82 37 50 D9 F8 99 0E 0C 12 41 D7
0190 | 61 E1 21 AA 64 F3 0A 61 BE 89 35 6E B6 17 A7 FC
01A0 | 1F 4D 0B 89 51 12 3A 69 C3 3E 17 DA 63 9A 04 F6
01B0 | 63 DF 32 AB AE EE 5A 45 89 30 11 99 F8 5F 18 B7
01C0 | D7 76 76 9A 56 0F 84 90 F8 9A 63 8F FE 4C 36 08
01D0 | 44 8D 80 0B 54 6E E7 12 B5 AE 41 40 DE E2 85 EB
01E0 | 62 24 CA 6D D9 2F 23 27 77 04 EE E7 5F A7 99 6A
01F0 | 02 BB EF AA F6 A9 D6 36 14 AB 94 08 66 65 B2 09
0200 | D1 81 9A E1 55 B4 14 66 C5 11 E0 54 1D D8 8B B7
0210 | 7F 11 73 A9 F7 CA 3B 09 17 41 12 3F 7D C3 9F D3
0220 | D1 53 66 54 78 27 82 3A B3 87 32 A1 3F 66 A5 11
0230 | C8 02 FC 1F 83 9D AA 56 72 AB 74 4C C5 0D 78 D1
0240 | 54 11 7D 95 19 C1 2E 0C 73 BF 80 03 0D 25 32 9E
0250 | 3C 82 66 C6 0D 7D 80 EF 31 03 0E 25 A4 B2 60 46
0260 | E3 A9 25 7C 69 97 27 5D 8C C4 9D 97 2B 96 67 1D
0270 | F7 00 B1 02 07 97 B5 F4 A4 53 CF 80 43 9C B3 A0
0280 | 7E 10 BB B4 18 50 A2 A6 D4 0A F8 D0</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_params_ok#d0e8075c nonce:int128 server_nonce:int128 encrypted_answer:string = Server_DH_Params;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>010CEB370042AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>F0020000</code> (752 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(server_DH_params_ok)</td>
<td>20, 4</td>
<td><code>5c07e8d0</code></td>
<td><em>server_DH_params_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_answer</td>
<td>56, 596</td>
<td><code>FE500200C49D66B78E6CD03680F164C8</code> <code>F0F450EE75127A709498DEE83C3AB561</code> <code>A98B8915BF2AF048836A84E36B8ABD20</code> <code>E09A52FCE64F1438D3016EF353A961E9</code> <code>B65870E0ECDF99BCDBD545F25AA21960</code> <code>20B9C65677AC09F3863568F4A21BC5FD</code> <code>CB7A7734461E78E68FB3636725D527DC</code> <code>5854F977E751126BEE814539C1EABBA8</code> <code>E80BF46CA670CF9F794CD23B14A007FD</code> <code>F42D9E688F1030B52DE223ED0F86804F</code> <code>205741F6EAAD888E2A1090671E57A6C3</code> <code>68FE9B54A5D80B2B012B0E7A78EFCA9D</code> <code>6AD7B861592620FC33CB8DB4B4781A62</code> <code>42EBE50AC2C6FB548DF8D61E00AFA311</code> <code>2267FBFFE2E4DC64E6061D344553B3E9</code> <code>FC62D56DBF3163E0B3843E9165E873C6</code> <code>AC9044B9B9CDD36D7B7C8F18F7E60506</code> <code>9BED872FFECC023CFD56E3E9BADCAE0E</code> <code>491041BA813D946216941C0CF08ADC73</code> <code>EAF68549214FD1749289B2A07153228F</code> <code>C4D7DC791B57F6E34477511383823750</code> <code>D9F8990E0C1241D761E121AA64F30A61</code> <code>BE89356EB617A7FC1F4D0B8951123A69</code> <code>C33E17DA639A04F663DF32ABAEEE5A45</code> <code>89301199F85F18B7D776769A560F8490</code> <code>F89A638FFE4C3608448D800B546EE712</code> <code>B5AE4140DEE285EB6224CA6DD92F2327</code> <code>7704EEE75FA7996A02BBEFAAF6A9D636</code> <code>14AB94086665B209D1819AE155B41466</code> <code>C511E0541DD88BB77F1173A9F7CA3B09</code> <code>1741123F7DC39FD3D15366547827823A</code> <code>B38732A13F66A511C802FC1F839DAA56</code> <code>72AB744CC50D78D154117D9519C12E0C</code> <code>73BF80030D25329E3C8266C60D7D80EF</code> <code>31030E25A4B26046E3A9257C6997275D</code> <code>8CC49D972B96671DF700B1020797B5F4</code> <code>A453CF80439CB3A07E10BBB41850A2A6</code><br> <code>D40AF8D0</code></td>
<td>See below</td>
</tr>
</tbody>
</table>
<!-- end server_DH_params_ok -->
<p>Decrypt <code>encrypted_answer</code> using the reverse of the process specified in <a href="/mtproto/auth_key#6-server-responds-with">step 6</a>:</p>
<!-- start server_DH_inner_data_input -->
<pre><code>encrypted_answer = C49D66B78E6CD03680F164C8F0F450EE75127A709498DEE83C3AB561A98B8915BF2AF048836A84E36B8ABD20E09A52FCE64F1438D3016EF353A961E9B65870E0ECDF99BCDBD545F25AA2196020B9C65677AC09F3863568F4A21BC5FDCB7A7734461E78E68FB3636725D527DC5854F977E751126BEE814539C1EABBA8E80BF46CA670CF9F794CD23B14A007FDF42D9E688F1030B52DE223ED0F86804F205741F6EAAD888E2A1090671E57A6C368FE9B54A5D80B2B012B0E7A78EFCA9D6AD7B861592620FC33CB8DB4B4781A6242EBE50AC2C6FB548DF8D61E00AFA3112267FBFFE2E4DC64E6061D344553B3E9FC62D56DBF3163E0B3843E9165E873C6AC9044B9B9CDD36D7B7C8F18F7E605069BED872FFECC023CFD56E3E9BADCAE0E491041BA813D946216941C0CF08ADC73EAF68549214FD1749289B2A07153228FC4D7DC791B57F6E34477511383823750D9F8990E0C1241D761E121AA64F30A61BE89356EB617A7FC1F4D0B8951123A69C33E17DA639A04F663DF32ABAEEE5A4589301199F85F18B7D776769A560F8490F89A638FFE4C3608448D800B546EE712B5AE4140DEE285EB6224CA6DD92F23277704EEE75FA7996A02BBEFAAF6A9D63614AB94086665B209D1819AE155B41466C511E0541DD88BB77F1173A9F7CA3B091741123F7DC39FD3D15366547827823AB38732A13F66A511C802FC1F839DAA5672AB744CC50D78D154117D9519C12E0C73BF80030D25329E3C8266C60D7D80EF31030E25A4B26046E3A9257C6997275D8CC49D972B96671DF700B1020797B5F4A453CF80439CB3A07E10BBB41850A2A6D40AF8D0
tmp_aes_key = 2A09CB2316555F817D3FB3A5670510B3E4A9836E4B383F9EB99E86EC09C2ABA2
tmp_aes_iv = 9350FDD9B8A18BB179E4E761F363B5AE463DE2ED9FABF58AEF904FBB4629AA8D</code></pre>
<!-- end server_DH_inner_data_input -->
<p>Yielding:</p>
<!-- start server_DH_inner_data_output -->
<pre><code>answer_with_hash = FF10119CF1C6819637678D151572A62AF3217C95BA0D89B57BF4DAA01D3ED226DEF71A76395FD66DEAE35E0758C0E48BB2BFEFCE74A678EB03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100C3466BC328ADC5FA71BEF3CF70AFD9B49EE524B6D4215386345BB32244AC679AA6679DC8177DDC1B2ACFBAD82CC2EE855A90225F56C23B927E0AFDCC306038C6072B39296E53E5EA4B8A6279DF49CAD9C1F7F4BE0F0EA65F388422D7663B1F0D05738C829ACA9B59C9E5A8052C025BD734285C37E6935EFEE4391A4FABE8523C244FE04D6CDAA9FC7A70CCC025E1DE20FB9C1AEEECC93F5A89C0F68B5D38B9A020DC154280B7A03A5EEEB12757C4CE9E2058EF67DCD743F8CC45167F235831C48C1E97A05A0C8EBC624A00724681930455B6D53BB90976C562EDA9E3249260576517DF9BBF22FC1CEB07975CD263A21129FB49675DBC20B710DDB588EAC739E50042AE6694CB4F708F7E7738
answer = BA0D89B57BF4DAA01D3ED226DEF71A76395FD66DEAE35E0758C0E48BB2BFEFCE74A678EB03000000FE000100C71CAEB9C6B1C9048E6C522F70F13F73980D40238E3E21C14934D037563D930F48198A0AA7C14058229493D22530F4DBFA336F6E0AC925139543AED44CCE7C3720FD51F69458705AC68CD4FE6B6B13ABDC9746512969328454F18FAF8C595F642477FE96BB2A941D5BCD1D4AC8CC49880708FA9B378E3C4F3A9060BEE67CF9A4A4A695811051907E162753B56B0F6B410DBA74D8A84B2A14B3144E0EF1284754FD17ED950D5965B4B9DD46582DB1178D169C6BC465B0D6FF9CA3928FEF5B9AE4E418FC15E83EBEA0F87FA9FF5EED70050DED2849F47BF959D956850CE929851F0D8115F635B105EE2E4E15D04B2454BF6F4FADF034B10403119CD8E3B92FCC5BFE000100C3466BC328ADC5FA71BEF3CF70AFD9B49EE524B6D4215386345BB32244AC679AA6679DC8177DDC1B2ACFBAD82CC2EE855A90225F56C23B927E0AFDCC306038C6072B39296E53E5EA4B8A6279DF49CAD9C1F7F4BE0F0EA65F388422D7663B1F0D05738C829ACA9B59C9E5A8052C025BD734285C37E6935EFEE4391A4FABE8523C244FE04D6CDAA9FC7A70CCC025E1DE20FB9C1AEEECC93F5A89C0F68B5D38B9A020DC154280B7A03A5EEEB12757C4CE9E2058EF67DCD743F8CC45167F235831C48C1E97A05A0C8EBC624A00724681930455B6D53BB90976C562EDA9E3249260576517DF9BBF22FC1CEB07975CD263A21129FB49675DBC20B710DDB588EAC739E50042AE6694CB4F708F7E7738</code></pre>
<!-- end server_DH_inner_data_output -->
<!-- start server_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | BA 0D 89 B5 7B F4 DA A0 1D 3E D2 26 DE F7 1A 76
0010 | 39 5F D6 6D EA E3 5E 07 58 C0 E4 8B B2 BF EF CE
0020 | 74 A6 78 EB 03 00 00 00 FE 00 01 00 C7 1C AE B9
0030 | C6 B1 C9 04 8E 6C 52 2F 70 F1 3F 73 98 0D 40 23
0040 | 8E 3E 21 C1 49 34 D0 37 56 3D 93 0F 48 19 8A 0A
0050 | A7 C1 40 58 22 94 93 D2 25 30 F4 DB FA 33 6F 6E
0060 | 0A C9 25 13 95 43 AE D4 4C CE 7C 37 20 FD 51 F6
0070 | 94 58 70 5A C6 8C D4 FE 6B 6B 13 AB DC 97 46 51
0080 | 29 69 32 84 54 F1 8F AF 8C 59 5F 64 24 77 FE 96
0090 | BB 2A 94 1D 5B CD 1D 4A C8 CC 49 88 07 08 FA 9B
00A0 | 37 8E 3C 4F 3A 90 60 BE E6 7C F9 A4 A4 A6 95 81
00B0 | 10 51 90 7E 16 27 53 B5 6B 0F 6B 41 0D BA 74 D8
00C0 | A8 4B 2A 14 B3 14 4E 0E F1 28 47 54 FD 17 ED 95
00D0 | 0D 59 65 B4 B9 DD 46 58 2D B1 17 8D 16 9C 6B C4
00E0 | 65 B0 D6 FF 9C A3 92 8F EF 5B 9A E4 E4 18 FC 15
00F0 | E8 3E BE A0 F8 7F A9 FF 5E ED 70 05 0D ED 28 49
0100 | F4 7B F9 59 D9 56 85 0C E9 29 85 1F 0D 81 15 F6
0110 | 35 B1 05 EE 2E 4E 15 D0 4B 24 54 BF 6F 4F AD F0
0120 | 34 B1 04 03 11 9C D8 E3 B9 2F CC 5B FE 00 01 00
0130 | C3 46 6B C3 28 AD C5 FA 71 BE F3 CF 70 AF D9 B4
0140 | 9E E5 24 B6 D4 21 53 86 34 5B B3 22 44 AC 67 9A
0150 | A6 67 9D C8 17 7D DC 1B 2A CF BA D8 2C C2 EE 85
0160 | 5A 90 22 5F 56 C2 3B 92 7E 0A FD CC 30 60 38 C6
0170 | 07 2B 39 29 6E 53 E5 EA 4B 8A 62 79 DF 49 CA D9
0180 | C1 F7 F4 BE 0F 0E A6 5F 38 84 22 D7 66 3B 1F 0D
0190 | 05 73 8C 82 9A CA 9B 59 C9 E5 A8 05 2C 02 5B D7
01A0 | 34 28 5C 37 E6 93 5E FE E4 39 1A 4F AB E8 52 3C
01B0 | 24 4F E0 4D 6C DA A9 FC 7A 70 CC C0 25 E1 DE 20
01C0 | FB 9C 1A EE EC C9 3F 5A 89 C0 F6 8B 5D 38 B9 A0
01D0 | 20 DC 15 42 80 B7 A0 3A 5E EE B1 27 57 C4 CE 9E
01E0 | 20 58 EF 67 DC D7 43 F8 CC 45 16 7F 23 58 31 C4
01F0 | 8C 1E 97 A0 5A 0C 8E BC 62 4A 00 72 46 81 93 04
0200 | 55 B6 D5 3B B9 09 76 C5 62 ED A9 E3 24 92 60 57
0210 | 65 17 DF 9B BF 22 FC 1C EB 07 97 5C D2 63 A2 11
0220 | 29 FB 49 67 5D BC 20 B7 10 DD B5 88 EA C7 39 E5
0230 | 00 42 AE 66</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>server_DH_inner_data#b5890dba nonce:int128 server_nonce:int128 g:int dh_prime:string g_a:string server_time:int = Server_DH_inner_data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(server_DH_inner_data)</td>
<td>0, 4</td>
<td><code>ba0d89b5</code></td>
<td><em>server_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g</td>
<td>36, 4</td>
<td><code>03000000</code> (3 in decimal)</td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>dh_prime</td>
<td>40, 260</td>
<td><code>FE000100C71CAEB9C6B1C9048E6C522F</code> <code>70F13F73980D40238E3E21C14934D037</code> <code>563D930F48198A0AA7C14058229493D2</code> <code>2530F4DBFA336F6E0AC925139543AED4</code> <code>4CCE7C3720FD51F69458705AC68CD4FE</code> <code>6B6B13ABDC9746512969328454F18FAF</code> <code>8C595F642477FE96BB2A941D5BCD1D4A</code> <code>C8CC49880708FA9B378E3C4F3A9060BE</code> <code>E67CF9A4A4A695811051907E162753B5</code> <code>6B0F6B410DBA74D8A84B2A14B3144E0E</code> <code>F1284754FD17ED950D5965B4B9DD4658</code> <code>2DB1178D169C6BC465B0D6FF9CA3928F</code> <code>EF5B9AE4E418FC15E83EBEA0F87FA9FF</code> <code>5EED70050DED2849F47BF959D956850C</code> <code>E929851F0D8115F635B105EE2E4E15D0</code> <code>4B2454BF6F4FADF034B10403119CD8E3</code><br> <code>B92FCC5B</code></td>
<td>2048-bit prime, in big-endian byte order, to be checked as specified in the auth key docs</td>
</tr>
<tr>
<td>g_a</td>
<td>300, 260</td>
<td><code>FE000100C3466BC328ADC5FA71BEF3CF</code> <code>70AFD9B49EE524B6D4215386345BB322</code> <code>44AC679AA6679DC8177DDC1B2ACFBAD8</code> <code>2CC2EE855A90225F56C23B927E0AFDCC</code> <code>306038C6072B39296E53E5EA4B8A6279</code> <code>DF49CAD9C1F7F4BE0F0EA65F388422D7</code> <code>663B1F0D05738C829ACA9B59C9E5A805</code> <code>2C025BD734285C37E6935EFEE4391A4F</code> <code>ABE8523C244FE04D6CDAA9FC7A70CCC0</code> <code>25E1DE20FB9C1AEEECC93F5A89C0F68B</code> <code>5D38B9A020DC154280B7A03A5EEEB127</code> <code>57C4CE9E2058EF67DCD743F8CC45167F</code> <code>235831C48C1E97A05A0C8EBC624A0072</code> <code>4681930455B6D53BB90976C562EDA9E3</code> <code>249260576517DF9BBF22FC1CEB07975C</code> <code>D263A21129FB49675DBC20B710DDB588</code><br> <code>EAC739E5</code></td>
<td><code>g_a</code> diffie-hellman parameter</td>
</tr>
<tr>
<td>server_time</td>
<td>560, 4</td>
<td><code>0042AE66</code> (1722696192 in decimal)</td>
<td>Server time</td>
</tr>
</tbody>
</table>
<!-- end server_DH_inner_data -->
<h5><a class="anchor" href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" id="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message" name="7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message"><i class="anchor-icon"></i></a>7) Client computes random 2048-bit number <em>b</em> (using a sufficient amount of entropy) and sends the server a message</h5>
<p>First, generate a secure random 2048-bit number b:</p>
<!-- start b -->
<pre><code>b = 90F9FD5DCD676D3946745CB375CB929A9F15EC7ADAB1AEFF7B039C3FEB7DB7793D1F564DF22ADD2CF9EA46FF5F8CE0200B27CC5E1C778C65BACEF726BC57799F0FEFA969FC901B24051AB2D0890A5B9A6179C184BCE2E58D4F052A588E0E461A84528D0EB127B7CB473CDD47AF769BE4AF53F795578438730FC36D5B2B3F4AEDC9B391C6D645B269713C2AA7327B3883F704D1FF08AB3E231A6CED25316FE08ACC44F2F3771E7B3EFF120282C90B6997BAB9CD5DCF86FE29D04AC874193E4A517D9436A32D91B3A9FC1B963D1001094AFEE9761608A9704482AA425A96990FE9E689EA72472804B24ADA10EE01C2561D46EDFAD255A8EAE8405D6A2BB7F97DCB</code></pre>
<!-- end b -->
<p>Then compute <code>g_b = pow(g, b) mod dh_prime</code></p>
<!-- start g_b -->
<pre><code>g_b = 2FE913F17BFE9EF86F114857877E97500B407D4861575A019CE1D3E3F3803DF1B1662D546669DBE8BD67562B42654E191B5E6F712075B419DEA6C2CCB5698F3BBA636551B97360EA49F3C6B13892E6BE925313A7FAC9F7AB8B5DF9E589F3FA6E79AA1B899D63068252CEECDEBAC49DA553AD23B62B68ABE965975D9CF4464A623DC35C02868FE93BEEA370DCAECC5A1E6F9F4433F6CB46F4317FF2D69AD3B633295790F889791301E72E22252321038467DA3F843B446A9635105775512A351EEB54BDA02E22877F223562E21368D0107F626F9A9299395D9FF7274FE6B7716E28978ABC28AB0C3DCFEC2D30AEC5371AA11A1347056A19497F74BCA663390CAC</code></pre>
<!-- end g_b -->
<h6>7.1) generation of encrypted_data</h6>
<!-- start client_DH_inner_data -->
<p>Generated payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 54 B6 43 66 7B F4 DA A0 1D 3E D2 26 DE F7 1A 76
0010 | 39 5F D6 6D EA E3 5E 07 58 C0 E4 8B B2 BF EF CE
0020 | 74 A6 78 EB 00 00 00 00 00 00 00 00 FE 00 01 00
0030 | 2F E9 13 F1 7B FE 9E F8 6F 11 48 57 87 7E 97 50
0040 | 0B 40 7D 48 61 57 5A 01 9C E1 D3 E3 F3 80 3D F1
0050 | B1 66 2D 54 66 69 DB E8 BD 67 56 2B 42 65 4E 19
0060 | 1B 5E 6F 71 20 75 B4 19 DE A6 C2 CC B5 69 8F 3B
0070 | BA 63 65 51 B9 73 60 EA 49 F3 C6 B1 38 92 E6 BE
0080 | 92 53 13 A7 FA C9 F7 AB 8B 5D F9 E5 89 F3 FA 6E
0090 | 79 AA 1B 89 9D 63 06 82 52 CE EC DE BA C4 9D A5
00A0 | 53 AD 23 B6 2B 68 AB E9 65 97 5D 9C F4 46 4A 62
00B0 | 3D C3 5C 02 86 8F E9 3B EE A3 70 DC AE CC 5A 1E
00C0 | 6F 9F 44 33 F6 CB 46 F4 31 7F F2 D6 9A D3 B6 33
00D0 | 29 57 90 F8 89 79 13 01 E7 2E 22 25 23 21 03 84
00E0 | 67 DA 3F 84 3B 44 6A 96 35 10 57 75 51 2A 35 1E
00F0 | EB 54 BD A0 2E 22 87 7F 22 35 62 E2 13 68 D0 10
0100 | 7F 62 6F 9A 92 99 39 5D 9F F7 27 4F E6 B7 71 6E
0110 | 28 97 8A BC 28 AB 0C 3D CF EC 2D 30 AE C5 37 1A
0120 | A1 1A 13 47 05 6A 19 49 7F 74 BC A6 63 39 0C AC</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>client_DH_inner_data#6643b654 nonce:int128 server_nonce:int128 retry_id:long g_b:string = Client_DH_Inner_Data;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>%(client_DH_inner_data)</td>
<td>0, 4</td>
<td><code>54b64366</code></td>
<td><em>client_DH_inner_data</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>4, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>20, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>g_b</td>
<td>36, 260</td>
<td><code>FE0001002FE913F17BFE9EF86F114857</code> <code>877E97500B407D4861575A019CE1D3E3</code> <code>F3803DF1B1662D546669DBE8BD67562B</code> <code>42654E191B5E6F712075B419DEA6C2CC</code> <code>B5698F3BBA636551B97360EA49F3C6B1</code> <code>3892E6BE925313A7FAC9F7AB8B5DF9E5</code> <code>89F3FA6E79AA1B899D63068252CEECDE</code> <code>BAC49DA553AD23B62B68ABE965975D9C</code> <code>F4464A623DC35C02868FE93BEEA370DC</code> <code>AECC5A1E6F9F4433F6CB46F4317FF2D6</code> <code>9AD3B633295790F889791301E72E2225</code> <code>2321038467DA3F843B446A9635105775</code> <code>512A351EEB54BDA02E22877F223562E2</code> <code>1368D0107F626F9A9299395D9FF7274F</code> <code>E6B7716E28978ABC28AB0C3DCFEC2D30</code> <code>AEC5371AA11A1347056A19497F74BCA6</code><br> <code>63390CAC</code></td>
<td>Single-byte prefix denoting length, a 256-byte (2048-bit) string, and zero bytes of padding</td>
</tr>
<tr>
<td>retry_id</td>
<td>296, 8</td>
<td><code>0000000000000000</code></td>
<td>Equal to zero at the time of the first attempt; otherwise, it is equal to <code>auth_key_aux_hash</code> from the previous failed attempt (see Item 7).</td>
</tr>
</tbody>
</table>
<!-- end client_DH_inner_data -->
<p>The serialization of <em>Client_DH_Inner_Data</em> produces a string <strong>data</strong>. This is used to generate <strong>encrypted_data</strong> as specified in <a href="#7-client-computes-random-2048-bit-number-b-using-a-sufficient-amount-of-entropy-and-sends-the-server-a-message">step 6</a>, using the following inputs:</p>
<!-- start client_DH_inner_data_input -->
<pre><code>data = 54B643667BF4DAA01D3ED226DEF71A76395FD66DEAE35E0758C0E48BB2BFEFCE74A678EB0000000000000000FE0001002FE913F17BFE9EF86F114857877E97500B407D4861575A019CE1D3E3F3803DF1B1662D546669DBE8BD67562B42654E191B5E6F712075B419DEA6C2CCB5698F3BBA636551B97360EA49F3C6B13892E6BE925313A7FAC9F7AB8B5DF9E589F3FA6E79AA1B899D63068252CEECDEBAC49DA553AD23B62B68ABE965975D9CF4464A623DC35C02868FE93BEEA370DCAECC5A1E6F9F4433F6CB46F4317FF2D69AD3B633295790F889791301E72E22252321038467DA3F843B446A9635105775512A351EEB54BDA02E22877F223562E21368D0107F626F9A9299395D9FF7274FE6B7716E28978ABC28AB0C3DCFEC2D30AEC5371AA11A1347056A19497F74BCA663390CAC
padding = D8226BD895F4DA71838A4E15
tmp_aes_key = 2A09CB2316555F817D3FB3A5670510B3E4A9836E4B383F9EB99E86EC09C2ABA2
tmp_aes_iv = 9350FDD9B8A18BB179E4E761F363B5AE463DE2ED9FABF58AEF904FBB4629AA8D</code></pre>
<!-- end client_DH_inner_data_input -->
<p>Process:</p>
<pre><code>data_with_hash := SHA1(data) + data + padding (0-15 random bytes such that total length is divisible by 16)
encrypted_data := AES256_ige_encrypt (data_with_hash, tmp_aes_key, tmp_aes_iv);</code></pre>
<p>Output:</p>
<!-- start client_DH_inner_data_output -->
<pre><code>encrypted_data = 373EB48F6603F510965AD884570C2C617B9EE37DA7F83CC9A9B8E954213D2CAF26FDB91B3EC626CCDC4935EF3249518C730845866A49DD87DA14CCE2E277232EB62E4C137E2CE85512C5044A4055AF993FCB77303F47D47E0B7D837BF82A2CDA34BEDE1C7C442F7DB5E9E3BCDD57F676840841C4B69B835BC8F9D56D780F81C457C18F5897359117294074874A7AB47C55986ED005477EE29B88FFA1DE64C160D4C90EACDAB9AB8D9960C67ADEF76B0FFEFB8C361FCEC9602BCE69FE482434809F846A95180DB3F383DE8AE845FDFB7C97AC290D35760CBF52D88149D75B649E28EACF938AF6F705AE3BDE6FF074F90DCC909058CD01A450A571C8BB38AF8DF20CE6B96AE218EFA7D2F9812075C413D4BC66606140C2CF6BC24FB8394D08A848B48E1ECF2440238292E1F2537E82CD7FADBFD666E181BCA1D0194FD79B168D08CD589D982A9A16B45B2ACBC14BCF94C9</code></pre>
<!-- end client_DH_inner_data_output -->
<p>The length of the final string is 336 bytes.</p>
<h6>7.2) set_client_DH_params query</h6>
<!-- start set_client_DH_params -->
<p>Sent payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 78 0C 04 00 00 42 AE 66
0010 | 78 01 00 00 1F 5F 04 F5 7B F4 DA A0 1D 3E D2 26
0020 | DE F7 1A 76 39 5F D6 6D EA E3 5E 07 58 C0 E4 8B
0030 | B2 BF EF CE 74 A6 78 EB FE 50 01 00 37 3E B4 8F
0040 | 66 03 F5 10 96 5A D8 84 57 0C 2C 61 7B 9E E3 7D
0050 | A7 F8 3C C9 A9 B8 E9 54 21 3D 2C AF 26 FD B9 1B
0060 | 3E C6 26 CC DC 49 35 EF 32 49 51 8C 73 08 45 86
0070 | 6A 49 DD 87 DA 14 CC E2 E2 77 23 2E B6 2E 4C 13
0080 | 7E 2C E8 55 12 C5 04 4A 40 55 AF 99 3F CB 77 30
0090 | 3F 47 D4 7E 0B 7D 83 7B F8 2A 2C DA 34 BE DE 1C
00A0 | 7C 44 2F 7D B5 E9 E3 BC DD 57 F6 76 84 08 41 C4
00B0 | B6 9B 83 5B C8 F9 D5 6D 78 0F 81 C4 57 C1 8F 58
00C0 | 97 35 91 17 29 40 74 87 4A 7A B4 7C 55 98 6E D0
00D0 | 05 47 7E E2 9B 88 FF A1 DE 64 C1 60 D4 C9 0E AC
00E0 | DA B9 AB 8D 99 60 C6 7A DE F7 6B 0F FE FB 8C 36
00F0 | 1F CE C9 60 2B CE 69 FE 48 24 34 80 9F 84 6A 95
0100 | 18 0D B3 F3 83 DE 8A E8 45 FD FB 7C 97 AC 29 0D
0110 | 35 76 0C BF 52 D8 81 49 D7 5B 64 9E 28 EA CF 93
0120 | 8A F6 F7 05 AE 3B DE 6F F0 74 F9 0D CC 90 90 58
0130 | CD 01 A4 50 A5 71 C8 BB 38 AF 8D F2 0C E6 B9 6A
0140 | E2 18 EF A7 D2 F9 81 20 75 C4 13 D4 BC 66 60 61
0150 | 40 C2 CF 6B C2 4F B8 39 4D 08 A8 48 B4 8E 1E CF
0160 | 24 40 23 82 92 E1 F2 53 7E 82 CD 7F AD BF D6 66
0170 | E1 81 BC A1 D0 19 4F D7 9B 16 8D 08 CD 58 9D 98
0180 | 2A 9A 16 B4 5B 2A CB C1 4B CF 94 C9</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>set_client_DH_params#f5045f1f nonce:int128 server_nonce:int128 encrypted_data:string = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>780C04000042AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>78010000</code> (376 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(set_client_DH_params)</td>
<td>20, 4</td>
<td><code>1f5f04f5</code></td>
<td><em>set_client_DH_params</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>encrypted_data</td>
<td>56, 340</td>
<td><code>FE500100373EB48F6603F510965AD884</code> <code>570C2C617B9EE37DA7F83CC9A9B8E954</code> <code>213D2CAF26FDB91B3EC626CCDC4935EF</code> <code>3249518C730845866A49DD87DA14CCE2</code> <code>E277232EB62E4C137E2CE85512C5044A</code> <code>4055AF993FCB77303F47D47E0B7D837B</code> <code>F82A2CDA34BEDE1C7C442F7DB5E9E3BC</code> <code>DD57F676840841C4B69B835BC8F9D56D</code> <code>780F81C457C18F589735911729407487</code> <code>4A7AB47C55986ED005477EE29B88FFA1</code> <code>DE64C160D4C90EACDAB9AB8D9960C67A</code> <code>DEF76B0FFEFB8C361FCEC9602BCE69FE</code> <code>482434809F846A95180DB3F383DE8AE8</code> <code>45FDFB7C97AC290D35760CBF52D88149</code> <code>D75B649E28EACF938AF6F705AE3BDE6F</code> <code>F074F90DCC909058CD01A450A571C8BB</code> <code>38AF8DF20CE6B96AE218EFA7D2F98120</code> <code>75C413D4BC66606140C2CF6BC24FB839</code> <code>4D08A848B48E1ECF2440238292E1F253</code> <code>7E82CD7FADBFD666E181BCA1D0194FD7</code> <code>9B168D08CD589D982A9A16B45B2ACBC1</code><br> <code>4BCF94C9</code></td>
<td>Encrypted client_DH_inner_data generated previously, serialized as a TL byte string</td>
</tr>
</tbody>
</table>
<!-- end set_client_DH_params -->
<h5><a class="anchor" href="#8-auth-key-generation" id="8-auth-key-generation" name="8-auth-key-generation"><i class="anchor-icon"></i></a>8) Auth key generation</h5>
<p>The client computes the auth_key using formula <code>g_a^b mod dh_prime</code>:</p>
<!-- start auth_key -->
<pre><code>auth_key = 7ED025CC629ABBB40C4B812FF856EDC8B6950F73C275C3C99F6E9DB52709EE9B2475B0A0A0491D1FAA27D58B036339BFA089EC8E70A53125EB15B46B294A0906A62C5613AB1A2C70209A91CE3A850BC29329127433F776F591DC11A3D85305FB82B6D14B90D219F207A4E28541180C2957BB61B39F65671FC3F1A328FE3F1A3E64476749FE4B6256AD35C4077C7A52C913D2D036E6089166AA1D905AD6E2D9578F59EC4380248B8AE288E29C76CE2F7F9348E7F305C5DD6F6B7D1779428DB259D14F6C0DC16D06CE642521C562FAB4AB26E742E3681E2FAD060A60F68480174A3EA4B81E8BE9F6DCDA0208443E7FECCD4D323EE6BF6F1DE95D7DE2B79623A81C</code></pre>
<!-- end auth_key -->
<h5><a class="anchor" href="#9-final-server-reply" id="9-final-server-reply" name="9-final-server-reply"><i class="anchor-icon"></i></a>9) Final server reply</h5>
<p>The server verifies and confirms that auth_key_hash is unique: since it's unique, it replies with the following:</p>
<!-- start dh_gen_ok -->
<p>Received payload (excluding transport headers/trailers):</p>
<pre><code>0000 | 00 00 00 00 00 00 00 00 01 E8 BF C7 00 42 AE 66
0010 | 4C 00 00 00 34 F7 CB 3B 7B F4 DA A0 1D 3E D2 26
0020 | DE F7 1A 76 39 5F D6 6D EA E3 5E 07 58 C0 E4 8B
0030 | B2 BF EF CE 74 A6 78 EB 5E 1F 60 95 FA AC 51 75
0040 | 54 78 03 60 D3 71 8F 6E</code></pre>
<p>Payload (de)serialization:</p>
<pre><code>dh_gen_ok#3bcbf734 nonce:int128 server_nonce:int128 new_nonce_hash1:int128 = Set_client_DH_params_answer;</code></pre>
<table class="table">
<thead>
<tr>
<th>Parameter</th>
<th>Offset, Length in bytes</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth_key_id</td>
<td>0, 8</td>
<td><code>0000000000000000</code></td>
<td>0 since the message is in plain text</td>
</tr>
<tr>
<td>message_id</td>
<td>8, 8</td>
<td><code>01E8BFC70042AE66</code></td>
<td>Message ID generated as specified <a href="/mtproto/description#message-identifier-msg-id">here »</a> (unixtime() &lt;&lt; 32) + (N*4)</td>
</tr>
<tr>
<td>message_length</td>
<td>16, 4</td>
<td><code>4C000000</code> (76 in decimal)</td>
<td>Message body length</td>
</tr>
<tr>
<td>%(dh_gen_ok)</td>
<td>20, 4</td>
<td><code>34f7cb3b</code></td>
<td><em>dh_gen_ok</em> constructor number from TL schema</td>
</tr>
<tr>
<td>nonce</td>
<td>24, 16</td>
<td><code>7BF4DAA01D3ED226DEF71A76395FD66D</code></td>
<td>Value generated by client in Step 1</td>
</tr>
<tr>
<td>server_nonce</td>
<td>40, 16</td>
<td><code>EAE35E0758C0E48BB2BFEFCE74A678EB</code></td>
<td>Value received from server in Step 2</td>
</tr>
<tr>
<td>new_nonce_hash1</td>
<td>56, 16</td>
<td><code>5E1F6095FAAC517554780360D3718F6E</code></td>
<td>The 128 lower-order bits of SHA1 of the byte string derived from the <code>new_nonce</code> string by adding a single byte with the value of 1, 2, or 3, and followed by another 8 bytes with <code>auth_key_aux_hash</code>. Different values are required to prevent an intruder from changing server response dh_gen_ok into dh_gen_retry.</td>
</tr>
</tbody>
</table>
<!-- end dh_gen_ok --></div>
  
</div>
          
        </div>
      </div>
      <div class="footer_wrap">
  <div class="footer_columns_wrap footer_desktop">
    <div class="footer_column footer_column_telegram">
      <h5>Telegram</h5>
      <div class="footer_telegram_description"></div>
      Telegram is a cloud-based mobile and desktop messaging app with a focus on security and speed.
    </div>

    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
      <ul>
        <li><a href="//telegram.org/faq">FAQ</a></li>
        <li><a href="//telegram.org/privacy">Privacy</a></li>
        <li><a href="//telegram.org/press">Press</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#mobile-apps">Mobile Apps</a></h5>
      <ul>
        <li><a href="//telegram.org/dl/ios">iPhone/iPad</a></li>
        <li><a href="//telegram.org/android">Android</a></li>
        <li><a href="//telegram.org/dl/web">Mobile Web</a></li>
      </ul>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps#desktop-apps">Desktop Apps</a></h5>
      <ul>
        <li><a href="//desktop.telegram.org/">PC/Mac/Linux</a></li>
        <li><a href="//macos.telegram.org/">macOS</a></li>
        <li><a href="//telegram.org/dl/web">Web-browser</a></li>
      </ul>
    </div>
    <div class="footer_column footer_column_platform">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
      <ul>
        <li><a href="//core.telegram.org/api">API</a></li>
        <li><a href="//translations.telegram.org/">Translations</a></li>
        <li><a href="//instantview.telegram.org/">Instant View</a></li>
      </ul>
    </div>
  </div>
  <div class="footer_columns_wrap footer_mobile">
    <div class="footer_column">
      <h5><a href="//telegram.org/faq">About</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/blog">Blog</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/apps">Apps</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//core.telegram.org/">Platform</a></h5>
    </div>
    <div class="footer_column">
      <h5><a href="//telegram.org/press">Press</a></h5>
    </div>
  </div>
</div>
    </div>
    <script src="/js/main.js?47"></script>
    <script src="/js/jquery.min.js?1"></script>
<script src="/js/bootstrap.min.js?1"></script>

    <script>window.initDevPageNav&&initDevPageNav();
backToTopInit("Go up");
removePreloadInit();
</script>
  </body>
</html>

